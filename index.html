<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Explor'Orientation</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            text-align: justify;
        }
        .step-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #mainApp { display: none; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0891b2; 
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .chatbot-loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #0891b2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chatbot styles */
        #chatbot-toggle {
            transition: transform 0.2s ease-in-out;
        }
        #chatbot-toggle:hover {
            transform: scale(1.1);
        }
        #chatbot-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .chat-message-container {
            scroll-behavior: smooth;
        }
        .badge {
            filter: grayscale(1);
            opacity: 0.5;
        }
        .badge.earned {
            filter: grayscale(0);
            opacity: 1;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
        .simulation-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .simulation-message-container {
            scroll-behavior: smooth;
        }

        .portfolio-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }

        /* Pour centrer tous les titres, partout */
        h1, h2, h3, h4 {
            text-align: center;
        }

    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="authContainer" class="max-w-md mx-auto p-4 md:p-8 mt-10">
        <!-- L'interface d'authentification sera inject√©e ici -->
    </div>
    
    <div id="mainApp" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Le contenu principal de l'application sera inject√© ici -->
    </div>

    <footer class="text-center text-sm text-slate-500 py-6">
        <p>Application cr√©√©e par Thomas Cavil, enseignant au Lyc√©e Benjamin Franklin.</p>
    </footer>

    <!-- Chatbot Floating Icon -->
    <div id="chatbot-toggle" class="fixed bottom-6 right-6 bg-cyan-600 text-white w-16 h-16 rounded-full flex items-center justify-center cursor-pointer shadow-lg z-40">
        <span class="text-3xl">ü§ñ</span>
    </div>

    <!-- Chatbot Window -->
   <div id="chatbot-container" class="hidden fixed bottom-4 right-4 sm:bottom-24 sm:right-6 w-[calc(100%-2rem)] max-w-sm h-[70vh] sm:h-[60vh] bg-white rounded-2xl shadow-xl border border-slate-200 z-50 flex flex-col">           <div class="flex items-center justify-between p-4 border-b bg-slate-50 rounded-t-2xl">
            <h3 class="font-bold text-slate-800">ü§ñ Ton Coach Orientation</h3>
            <button id="chatbot-close" class="text-slate-500 hover:text-slate-800">&times;</button>
        </div>
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto chat-message-container">
            <!-- Messages will be appended here -->
             <div class="flex mb-4">
                <div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs">
                    <p>Bonjour ! Pose-moi une question sur l'orientation, une formation ou un m√©tier.</p>
                </div>
            </div>
        </div>
        <form id="chatbot-form" class="p-4 border-t flex items-center gap-2">
            <input type="text" id="chatbot-input" placeholder="Quelle est ta question ?" class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
            <button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
        </form>
    </div>


    <!-- SDKs Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";
        

        // IMPORTANT : Remplacez par la configuration de votre propre projet Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCT6U-7Az53oYCPZWHo3Dvxs20XiR0y3EU",
            authDomain: "monapp0rientation.firebaseapp.com",
            projectId: "monapp0rientation",
            storageBucket: "monapp0rientation.firebasestorage.app",
            messagingSenderId: "369432089475",
            appId: "1:369432089475:web:689a194b6880001c249cb6"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const functions = getFunctions(firebaseApp, "europe-west1"); 
        let currentUserId = null;
        let userGradeLevel = null;
        let currentUserInfo = { firstName: '', lastName: '', schoolName: '' };

        let cameFromLogin = false;
        
        const linkify = (text) => {
    const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    let newText = text.replace(urlRegex, function(url) {
        let hyperLink = url;
        if (!hyperLink.match('^https?:\/\/')) {
            hyperLink = 'http://' + hyperLink;
        }
        return `<a href="${hyperLink}" target="_blank" class="text-cyan-600 hover:underline">${url}</a>`;
    });
    // This makes sure line breaks are preserved
    return newText.replace(/\n/g, '<br>');
};
        const { jsPDF } = window.jspdf;

        const authContainer = document.getElementById('authContainer');
        const mainApp = document.getElementById('mainApp');

        let journalData = {};
        
       // D√©tecter si l'URL est un lien de partage
const urlParams = new URLSearchParams(window.location.search);
const shareId = urlParams.get('share_id');
const shareToken = urlParams.get('token');

if (shareId && shareToken) {
    // C'EST UN LIEN DE PARTAGE
    // On cache l'authentification et on affiche directement la vue publique
    authContainer.style.display = 'none';
    mainApp.style.display = 'block';
    document.querySelector('footer').style.display = 'none';
    document.querySelector('#chatbot-toggle').style.display = 'none';
    createPublicShareView(shareId, shareToken);
} else {
    // CE N'EST PAS UN LIEN DE PARTAGE : COMPORTEMENT NORMAL DE L'APP
    
    // On rend les fonctions de navigation globale accessibles
    window.showGuideFromLogin = function() {
        cameFromLogin = true;
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.querySelector('footer').style.display = 'none'; 
        showView('guide');
    }

    window.showLoginViewFromGuide = function() {
        cameFromLogin = false;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        showLoginView();
    }
    
    // La logique de connexion/d√©connexion est maintenant ICI, √† l'int√©rieur du "else"
    onAuthStateChanged(auth, user => {
        const chatbotToggle = document.getElementById('chatbot-toggle');

        if (user) {
            // Un utilisateur est connect√©
            chatbotToggle.style.display = 'flex';
            currentUserId = user.uid;
            authContainer.style.display = 'none';
            mainApp.style.display = 'block';
            loadData();
        } else {
            // Personne n'est connect√©
            chatbotToggle.style.display = 'none';
            currentUserId = null;
            userGradeLevel = null;
            currentUserInfo = { firstName: '', lastName: '', schoolName: '' };
            journalData = {}; 
            authContainer.style.display = 'block';
            mainApp.style.display = 'none';
            showLoginView();
        }
    });
}
            

        
        // üîπ Fonction utilitaire
function capitalizeWords(str) {
    return str.replace(/\b\w/g, c => c.toUpperCase());
}

function showLoginView() {
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">
            
            <img src="logo.png" alt="Logo Mon Explor'Orientation" class="mx-auto h-48 w-auto mb-6">

            <p class="text-center text-sm text-slate-500 mb-6">
                Besoin d'aide pour commencer ? 
                <button id="showGuideButton" class="font-semibold text-cyan-600 hover:underline">Consultez le guide d'utilisation.</button>
            </p>

            <div class="p-4 bg-slate-50 rounded-lg text-center text-slate-700 mb-6">
                <p>Bienvenue sur ton compagnon d'orientation personnel. Explore des m√©tiers, simule tes choix et construis ton projet d'avenir gr√¢ce √† des outils interactifs et une IA bienveillante. Ton exploration commence ici.</p>
            </div>

            <form id="loginForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Se connecter</button>
            </form>
            <div class="flex justify-between items-center text-sm text-left">
                <p class="text-slate-500">Pas encore de compte ? 
                    <button id="showSignupButton" class="font-semibold text-cyan-600 hover:underline">Inscrivez-vous</button>
                </p>
                <button id="forgotPasswordButton" class="text-sm text-slate-500 hover:underline">Mot de passe oubli√© ?</button>
            </div>
            
            <p id="authError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    authContainer.querySelector('#loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
        } catch (error) {
            authContainer.querySelector('#authError').textContent = "Erreur de connexion. V√©rifiez vos identifiants.";
        }
    });

    authContainer.querySelector('#showSignupButton').addEventListener('click', showSignupView);
    authContainer.querySelector('#forgotPasswordButton').addEventListener('click', showForgotPasswordView);
    authContainer.querySelector('#showGuideButton').addEventListener('click', window.showGuideFromLogin);
}

function showForgotPasswordView() {
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">
            <img src="logo.png" alt="Logo Mon Explor'Orientation" class="mx-auto h-48 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-2">Mot de passe oubli√© ?</h2>
            <p class="text-center text-slate-500 mb-6">Pas de panique ! Entrez votre e-mail pour recevoir un lien de r√©initialisation.</p>
            <form id="forgotPasswordForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail du compte" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Envoyer le lien</button>
            </form>
            <p class="text-center text-sm text-slate-500">
                <button id="backToLoginButton" class="font-semibold text-cyan-600 hover:underline">Retour √† la connexion</button>
            </p>
            <p id="authMessage" class="text-green-600 text-center mt-4"></p>
        </div>
    `;

    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const authMessage = document.getElementById('authMessage');

    forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        try {
            await sendPasswordResetEmail(auth, email);
            authMessage.textContent = "Si un compte existe pour cet e-mail, un lien de r√©initialisation vient d'√™tre envoy√©.";
            authMessage.className = 'text-green-600 text-center mt-4';
        } catch (error) {
            authMessage.textContent = "Une erreur est survenue. Veuillez r√©essayer.";
            authMessage.className = 'text-red-500 text-center mt-4';
        }
    });

    document.getElementById('backToLoginButton').addEventListener('click', showLoginView);
}

// üîπ Vue d'inscription
function showSignupView() {
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">

            <img src="logo.png" alt="Logo Mon Explor'Orientation" class="mx-auto h-32 w-auto mb-6">

            <p class="text-center text-slate-500 mb-6 text-lg">Rejoignez l'aventure de l'orientation !</p>
            <form id="signupForm" class="mb-4">
                <input id="firstName" type="text" placeholder="Pr√©nom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="lastName" type="text" placeholder="Nom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="schoolName" type="text" placeholder="Nom du lyc√©e" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="email" type="email" placeholder="Adresse e-mail" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe (6 caract√®res min.)" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700">Cr√©er mon compte</button>
            </form>
            <p class="text-center text-sm text-slate-500">D√©j√† un compte ? 
                <button id="showLoginButton" class="font-semibold text-cyan-600 hover:underline">Connectez-vous</button>
            </p>
            <p id="authError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    const signupForm = document.getElementById('signupForm');
    const showLoginButton = document.getElementById('showLoginButton');
    const authError = document.getElementById('authError');

    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const firstName = capitalizeWords(document.getElementById('firstName').value);
        const lastName = capitalizeWords(document.getElementById('lastName').value);
        const schoolName = capitalizeWords(document.getElementById('schoolName').value);
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            currentUserId = user.uid; 
            currentUserInfo = { firstName, lastName, schoolName };
            await saveData(true); 
        } catch (error) {
            authError.textContent = "Erreur lors de la cr√©ation du compte. Le mot de passe doit faire 6 caract√®res minimum.";
        }
    });
    showLoginButton.addEventListener('click', showLoginView);
}

// üîπ Rendre la fonction showView accessible globalement
window.showView = showView;


        async function saveData(isInitialSave = false) {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            
            const dataToSave = {
                firstName: currentUserInfo.firstName,
                lastName: currentUserInfo.lastName,
                schoolName: currentUserInfo.schoolName,
                gradeLevel: userGradeLevel,
                journal: journalData
            };
            
            try {
                if(isInitialSave) {
                    await setDoc(userDocRef, dataToSave);
                } else {
                    await setDoc(userDocRef, dataToSave, { merge: true });
                }
            } catch (error) {
                console.error("Error saving document: ", error);
            }
        }

        async function loadData() {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            const docSnap = await getDoc(userDocRef);
            
            const defaultData = {
                step0: { q1: '', q2: '', q3: '', q4: '', q5: '', q6: '', q7: '', q8: '', q9: '', q10: '', q11: '', q12: '', q13: '', q14: '', q15: '', q16: '', q17: '', q18: '', q19: '', q20: '', q21: '', q22: '', q23: '', q24: '', q25: '', analysis: '' },
                step1: { metier1: '', notes1: '', metier2: '', notes2: '', metier3: '', notes3: '' },
                step2: { combo1: '', notes1: '', skills1: '', combo2: '', notes2: '', skills2: '', combo3: '', notes3: '', skills3: '' },
                step3: { formation1: '', attendus1: '', mots_cles1: '', analyse_mots_cles1: '', formation2: '', attendus2: '', mots_cles2: '', analyse_mots_cles2: '', suggestions: '' },
                step4: { theme1: '', question1: '', suggestions1: '', theme2: '', question2: '', suggestions2: '' },
                step5: { article1: '', apprentissage1: '', test1: '', resultat1: '', analyse_test: '' },
                step6: { formation: '', motivations: '', structure: '' },
                step7: { domaine: '', reflexions: '' },
                step8: { pro_reseau_personnel: '', pro_metier: '', pro_departement: '', pro_contacts: '', pro_strategie: '', pro_media_query: '', pro_media_content: '', jpo_ecole: '', jpo_questions: '' },
                step9: { formation_reve: '', plan_b: '', reussite_type: '', reussite_conseils: '' },
                step10: { experience1: '', analyse1: '', experience2: '', analyse2: '' },
                step11: { location: '', events: '', structures: ''},
                retroplanning: '',
                fil_rouge: '',
                discussion_points: '',
                radar_history: [],
                earned_badges: []
            };

            if (docSnap.exists()) {
                const data = docSnap.data();
                userGradeLevel = data.gradeLevel || null;
                currentUserInfo = {
                    firstName: data.firstName || '',
                    lastName: data.lastName || '',
                    schoolName: data.schoolName || ''
                };
                const loadedJournal = data.journal || {};
                
                journalData = {};
                for (const key in defaultData) {
                    if (loadedJournal[key] && typeof defaultData[key] === 'object' && defaultData[key] !== null) {
                        journalData[key] = { ...defaultData[key], ...loadedJournal[key] };
                    } else {
                         journalData[key] = loadedJournal[key] || defaultData[key];
                    }
                }
            } else {
                userGradeLevel = null;
                journalData = defaultData;
            }
            
            if (!Array.isArray(journalData.earned_badges)) {
                journalData.earned_badges = [];
            }
            
            checkBadges();

            if (!userGradeLevel) {
                showGradeSelectionView();
            } else {
                showView('menu');
            }
        }
        
        function showGradeSelectionView() {
            mainApp.innerHTML = `
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in text-center">
                    <h1 class="text-2xl font-bold text-slate-800 mb-4">Bienvenue, ${currentUserInfo.firstName} !</h1>
                    <p class="text-slate-600 mb-6">Pour personnaliser ton parcours, s√©lectionne ta classe :</p>
                    <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                        <button data-grade="seconde" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700">Seconde</button>
                        <button data-grade="premiere" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700">Premi√®re</button>
                        <button data-grade="terminale" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700">Terminale</button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.grade-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    userGradeLevel = e.target.dataset.grade;
                    await saveData();
                    showView('menu');
                });
            });
        }

       // REMPLACEZ VOTRE FONCTION callGeminiAPI ACTUELLE PAR CELLE-CI :

async function callGeminiAPI(prompt, useGrounding = false, isJson = false) {
    
    // Fonction de nettoyage interne pour √©viter la r√©p√©tition
    const cleanResponse = (text) => {
        if (!isJson && text && typeof text === 'string') {
            return text.replace(/[#*]/g, '');
        }
        return text;
    };

    const functionUrl = "https://us-central1-monapp0rientation.cloudfunctions.net/generateContent"; 

    try {
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt,
                useGrounding: useGrounding,
                isJson: isJson
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Erreur du serveur: ${errorData.error || response.statusText}`);
        }

        const data = await response.json();
        // On nettoie la r√©ponse en cas de succ√®s
        return cleanResponse(data.result);

    } catch (error) {
        console.error("Error calling Cloud Function:", error);
        const errorMessage = `Impossible de contacter le service d'IA. (${error.message})`;
        // On nettoie aussi le message d'erreur au cas o√π
        return cleanResponse(errorMessage);
    }
}
        
        async function showView(viewName) {
    mainApp.innerHTML = '';
    let newView;
    switch(viewName) {
        case 'home': newView = createHomeView(); break;
        case 'menu': newView = createMenuView(); break;
        case 'step0': newView = createStep0View(); break;
        case 'step1': newView = createStep1View(); break;
        case 'step2': newView = createStep2View(); break;
        case 'step3': newView = createStep3View(); break;
        case 'step4': newView = createStep4View(); break;
        case 'step5': newView = createStep5View(); break;
        case 'step6': newView = createStep6View(); break;
        case 'step7': newView = createStep7View(); break;
        case 'step8': newView = createStep8View(); break;
        case 'step9': newView = createStep9View(); break;
        case 'step10': newView = createStep10View(); break;
        case 'step11': newView = createStep11View(); break;
        case 'step12': newView = createStep12View(); break;
        case 'guide': newView = createGuideView(); break;
        case 'retroplanning': newView = createRetroplanningView(); break;
        
        // MODIFICATION ICI : On attend le r√©sultat de la fonction asynchrone
        case 'journal': newView = await createJournalView(); break; 
        
        default: newView = createHomeView();
    }
    if (newView) mainApp.appendChild(newView);
    window.scrollTo(0, 0);
}

        function createHomeView() {
            return createMenuView();
        }
        

function createMenuView() {
    // On s'assure que le chatbot est bien visible sur le menu principal
    document.getElementById('chatbot-toggle').style.display = 'flex';
    
    const div = document.createElement('div');
    div.className = 'fade-in';

    let earnedBadgesHTML = '';
    const earnedBadges = journalData.earned_badges || [];
    if (earnedBadges.length > 0) {
        const badgesIcons = earnedBadges.map(key => {
            const badge = badgesConfig[key];
            if (badge) {
                return `<span title="${badge.title}" class="text-3xl cursor-default">${badge.icon}</span>`;
            }
            return '';
        }).join(' ');

        earnedBadgesHTML = `<div class="flex justify-center items-center gap-3 mt-3 mb-1">${badgesIcons}</div>`;
    }

    const menuTitle = `
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-slate-800">Bienvenue, ${currentUserInfo.firstName} !</h1>
            ${earnedBadgesHTML}
            <p class="text-slate-500 mt-2">√âl√®ve de <span class="font-semibold text-cyan-600">${userGradeLevel.charAt(0).toUpperCase() + userGradeLevel.slice(1)}</span> √† <span class="font-semibold text-cyan-600">${capitalizeWords(currentUserInfo.schoolName)}</span></p>
            <button id="logoutButton" class="mt-2 text-sm text-cyan-600 hover:underline">Se d√©connecter</button>
        </div>
    `;
    
    const allSteps = [
        { id: 'retroplanning', icon: 'üóìÔ∏è', title: 'Mon R√©troplanning', site: 'Outil', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step0', icon: 'üë§', title: 'Mieux se conna√Ætre', site: 'Point de d√©part', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step10', icon: 'üíº', title: 'Mon Portfolio de Comp√©tences', site: 'Valorisation', levels: ['premiere', 'terminale'] },
        { id: 'step5', icon: 'üì∞', title: 'L\'Actu & Tests', site: 'L\'√âtudiant & Co', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step1', icon: 'üìö', title: 'Les Fondations', site: 'Onisep', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step3', icon: 'üéì', title: 'Le Catalogue', site: 'Parcoursup', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step7', icon: 'üëª', title: 'Quiz : Chasse aux Mythes', site: 'Jeu interactif', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step2', icon: 'üß≠', title: 'Le simulateur de sp√©cialit√©s', site: 'Horizons21', levels: ['seconde', 'premiere'] },
        { id: 'step4', icon: 'üí¨', title: 'L\'Exp√©rience', site: 'Inspire', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step8', icon: 'üöÄ', title: 'Passer √† l\'action', site: 'Monde r√©el', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step11', icon: 'üåç', title: 'Rencontres sur mon Territoire', site: 'Ressources locales', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step6', icon: '‚úçÔ∏è', title: 'Pr√©parer sa candidature', site: 'Projet motiv√©', levels: ['terminale'] },
        { id: 'step9', icon: 'üîÆ', title: 'Anticiper la suite', site: 'Plan B & R√©ussite', levels: ['terminale'] },
        { id: 'step12', icon: 'üí∂', title: 'Simulateur Vie √âtudiante', site: 'Budget & Aides', levels: ['premiere', 'terminale'] },
        { id: 'journal', icon: 'üìì', title: 'Mon Journal de Bord', site: 'Consulte tes notes', levels: ['seconde', 'premiere', 'terminale'] }
    ];

    const allStepsForLevel = allSteps.filter(step => step.levels.includes(userGradeLevel));
    const completedStepsCount = allStepsForLevel.filter(step => {
        if (['journal', 'retroplanning', 'step12'].includes(step.id)) return false; 
        return isStepComplete(step.id);
    }).length;

    const totalTrackableSteps = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id)).length;
    const progressPercentage = totalTrackableSteps > 0 ? (completedStepsCount / totalTrackableSteps) * 100 : 0;

    const progressBarHTML = `
        <div class="max-w-md mx-auto mb-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-cyan-700">Progression</span>
                <span class="text-sm font-medium text-cyan-700">${Math.round(progressPercentage)}%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
            </div>
        </div>
    `;

    const guideCardHTML = `
        <div onclick="window.showView('guide')" class="step-card bg-white p-4 rounded-xl shadow-md border border-slate-200 cursor-pointer flex flex-col items-center space-y-2 mb-6 max-w-md mx-auto">
            <div class="text-3xl">‚ùì</div>
            <div class="text-center">
                <h2 class="text-lg font-semibold text-slate-800">Guide d'Utilisation</h2>
                <p class="text-sm text-slate-500">Besoin d'aide pour commencer ?</p>
            </div>
        </div>
    `;
    
    let steps = allStepsForLevel;
    let gridContainerClasses = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8";
    let gridItemClasses = "";

    // MODIFICATION 1 : On applique la mise en page flexible aux Terminales √©galement
    if (userGradeLevel === 'seconde' || userGradeLevel === 'terminale') {
        gridContainerClasses = "flex flex-wrap justify-center gap-6 mt-8";
        gridItemClasses = "w-full md:w-[48%] lg:w-[31%]";
    }

    let gridHTML = steps.map((step, index) => {
        let statusSymbol = '';
         if (!['journal', 'retroplanning', 'step12'].includes(step.id) && journalData[step.id]) {
             if(isStepComplete(step.id)){
                 statusSymbol = '<span class="ml-2 text-green-500 font-bold">‚úî</span>';
             } else {
                const stepData = journalData[step.id];
                const values = Object.values(stepData);
                const filledCount = values.filter(v => v && v.toString().trim() !== '').length;
                if(filledCount > 0) {
                    statusSymbol = '<span class="ml-2 text-orange-400 font-bold">‚úî</span>';
                }
             }
        }
        
        // MODIFICATION 2 : On limite l'ancien centrage (sur grille) uniquement √† la classe de Premi√®re
        const isLastItemCentered = (steps.length % 3 === 1 && userGradeLevel === 'premiere');
        const lastItemIndex = steps.length - 1;
        const centeredClass = (isLastItemCentered && index === lastItemIndex) ? 'lg:col-start-2' : '';

         return `
        <div onclick="window.showView('${step.id}')" class="step-card bg-white p-6 rounded-xl shadow-md border border-slate-200 cursor-pointer flex flex-col items-center space-y-2 text-center ${centeredClass} ${gridItemClasses}">
            <div class="text-3xl">${step.icon}</div>
            <div>
                <div class="flex justify-center items-center">
                     <h2 class="text-lg font-semibold text-slate-800">${step.title}</h2>
                     ${statusSymbol}
                </div>
                <p class="text-slate-500">${step.site}</p>
            </div>
        </div>
        `;
    }).join('');

    const radarHTML = `
       <div class="mt-12 text-center fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üì° Le Radar √† Opportunit√©s</h2>
            <p class="text-slate-600 max-w-2xl mx-auto mb-6">Tu as l'impression de tourner en rond ? Clique ici pour que l'IA analyse ton parcours et te propose une piste inattendue mais pertinente, bas√©e sur tes propres notes.</p>
            <button id="radarBtn" class="bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Me surprendre !</button>
            <div id="radarLoader" class="hidden"><div class="loader"></div></div>
            <div id="radarResult" class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-slate-700 whitespace-pre-wrap text-left"></div>
        </div>
    `;

    div.innerHTML = menuTitle + progressBarHTML + guideCardHTML + `<div class="${gridContainerClasses}">${gridHTML}</div>` + radarHTML;
    
    div.querySelector('#logoutButton').addEventListener('click', () => signOut(auth));
    
    div.querySelector('#radarBtn').addEventListener('click', async () => {
        const loader = div.querySelector('#radarLoader');
        const resultDiv = div.querySelector('#radarResult');
        loader.style.display = 'block'; resultDiv.textContent = '';
        
        let historyPrompt = "";
        if (journalData.radar_history && journalData.radar_history.length > 0) {
            historyPrompt = `Important : tu m'as d√©j√† propos√© les pistes suivantes : "${journalData.radar_history.join('", "')}". Propose une id√©e compl√®tement nouvelle et diff√©rente de celles-ci.`;
        }

        const prompt = `Agis comme un coach d'orientation bienveillant et perspicace. Tu t'adresses directement √† un lyc√©en. Voici son journal de bord : ${JSON.stringify(journalData)}.

        ${historyPrompt}

        Ta mission est de lui r√©v√©ler une "Piste Inattendue", un m√©tier ou un secteur surprenant mais qui correspond parfaitement √† ce que tu as per√ßu de lui.

        R√©dige ta r√©ponse en t'adressant directement √† lui (utilise "tu" et "toi"). Ta r√©ponse doit √™tre structur√©e et d√©taill√©e en 3 parties claires :

        1.  Ta Piste Inattendue : Propose-lui un nom de m√©tier ou de secteur pr√©cis.

        2.  Pourquoi je pense que c'est fait pour toi : Justifie ton choix de mani√®re d√©taill√©e en te basant sur les √©l√©ments de son journal. Fais des liens explicites et personnels.

        3.  Ta premi√®re mission d'exploration : Sugg√®re-lui une action simple et concr√®te pour qu'il puisse commencer √† explorer cette piste.`;
        
        const result = await callGeminiAPI(prompt);

        const trackNameMatch = result.match(/Ta Piste Inattendue : (.*?)\n/);
        if (trackNameMatch && trackNameMatch[1]) {
            const trackName = trackNameMatch[1].trim();
            if (!journalData.radar_history) {
                journalData.radar_history = [];
            }
            journalData.radar_history.push(trackName);
            if (journalData.radar_history.length > 3) {
                journalData.radar_history.shift();
            }
            saveData();
        }

        loader.style.display = 'none';
        resultDiv.textContent = result;
    });
    return div;
}
        
        function createStepView(config) {
            const div = document.createElement('div');
            div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';
            
            let formFields = '';
            if (config.fields) {
                formFields = config.fields.map(field => {
                    const value = (journalData[config.stepKey] && journalData[config.stepKey][field.id]) || '';
                    const isReadonly = field.isReadonly ? 'readonly' : '';
                    const bgColor = isReadonly ? 'bg-slate-50' : 'bg-white';
                    return `
                    <div class="mb-6">
                        <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                        ${field.type === 'textarea' ? `<textarea id="${field.id}" name="${field.id}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" ${isReadonly}>${value}</textarea>` : `<input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" value="${value}" ${isReadonly}>`}
                    </div>
                `}).join('');
            }

            let description = config.description;
            if(typeof description === 'object') {
                description = description[userGradeLevel] || description['default'] || '';
            }

            let action = config.action;
            if(typeof action === 'object') {
                action = action[userGradeLevel] || action['default'] || '';
            }

            let linksHTML = '';
    if (config.urls) {
        linksHTML = config.urls.map(link => 
            `<a href="${link.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition mr-2 mb-2">Visiter ${link.site} ‚Üó</a>`
        ).join('');
    } else if (config.url) {
        linksHTML = `<a href="${config.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter ${config.site} ‚Üó</a>`;
    }

    div.innerHTML = `
        <div class="flex items-center mb-6"><button onclick="window.showView('menu')" class="text-cyan-600 hover:text-cyan-800 font-bold mr-4">‚Üê Retour</button><h1 class="text-2xl font-bold">${config.icon} ${config.title}</h1></div>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${action}</div></div>
        <div class="mb-8">${linksHTML}</div>
        <form id="stepForm">
            ${formFields}
            <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
        </form>
    `;
            
            div.querySelector('#stepForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const stepKey = config.stepKey;
                if (!journalData[stepKey]) journalData[stepKey] = {};

                for (const [key, newValue] of formData.entries()) {
                     journalData[stepKey][key] = newValue; 
                }
                
                checkBadges();
                await saveData();
                showView('menu');
            });

            return div;
        }
        



function createProfileInfographic(step0Data) {
    if (!step0Data || !step0Data.analysis) {
        return document.createElement('div'); // Retourne un √©l√©ment vide si pas de donn√©es
    }

    const profiles = [
        { title: 'Source d\'√©nergie', q: 'q20', left: { key: 'seul', label: 'Introverti' }, right: { key: 'amis', label: 'Extraverti' } },
        { title: 'Prise de d√©cision', q: 'q11', left: { key: 'analyse', label: 'Analyse' }, right: { key: 'intuition', label: 'Intuition' } },
        { title: 'Mode de travail', q: 'q1', left: { key: 'seul', label: 'Individuel' }, right: { key: 'equipe', label: 'Collaboratif' } },
        { title: 'Approche des probl√®mes', q: 'q3', left: { key: 'logique', label: 'M√©thodique' }, right: { key: 'creatif', label: 'Cr√©atif' } },
        { title: 'Zone de confort', q: 'q19', left: { key: 'claires', label: 'Cadre clair' }, right: { key: 'generales', label: 'Autonomie' } },
        { title: 'Moteur principal', q: 'q25', left: { key: 'competence', label: 'Ma√Ætrise' }, right: { key: 'sens', label: 'Qu√™te de sens' } }
    ];

    let infographicHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">';
    profiles.forEach(p => {
        const answer = step0Data[p.q];
        let leftColor = 'bg-slate-200';
        let rightColor = 'bg-slate-200';
        if (answer === p.left.key) leftColor = 'bg-cyan-600';
        if (answer === p.right.key) rightColor = 'bg-cyan-600';
        infographicHTML += `
            <div>
                <h3 class="font-semibold text-slate-700 mb-1">${p.title}</h3>
                <div class="flex items-center justify-between text-sm text-slate-600 mb-1">
                    <span class="font-medium ${answer === p.left.key ? 'text-cyan-700' : ''}">${p.left.label}</span>
                    <span class="font-medium ${answer === p.right.key ? 'text-cyan-700' : ''}">${p.right.label}</span>
                </div>
                <div class="w-full flex h-2 rounded-full overflow-hidden">
                    <div class="w-1/2 ${leftColor}"></div>
                    <div class="w-1/2 ${rightColor}"></div>
                </div>
            </div>`;
    });
    infographicHTML += '</div>';

    const container = document.createElement('div');
    container.className = 'mb-8';
    container.innerHTML = `
        <h2 class="text-xl font-bold border-b pb-2 mb-4 text-cyan-700">üë§ Synth√®se de ton Profil</h2>
        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 mt-4">
           ${infographicHTML}
        </div>
    `;
    return container;
}

const stepsConfig = {
    step0: { 
        stepKey: 'step0', title: 'Mieux se conna√Ætre', icon: 'üë§',
        description: `Toute bonne orientation commence par une bonne connaissance de soi. R√©ponds honn√™tement √† ces quelques questions pour d√©gager tes grandes tendances et obtenir une premi√®re analyse de ton profil.`,
        action: "<b>Ta mission :</b> R√©ponds aux questions ci-dessous (survole les options pour plus de d√©tails), puis clique sur 'Analyser mon profil' pour que l'IA te donne un premier retour sur tes forces."
    },
    step1: {
        stepKey: 'step1', title: "Les Fondations avec l'Onisep", icon: 'üìö',
        description: `L'Onisep est le service public de l'√âducation Nationale. C'est LA r√©f√©rence pour une information objective et compl√®te. <b>Ce que tu y trouves :</b> des fiches m√©tiers d√©taill√©es, des interviews, et le service <b>MonOrientationEnLigne.fr</b> pour poser tes questions directement √† des conseillers.`,
        action: "<b>Ta mission :</b> Explore 3 m√©tiers sur Onisep.fr. Pour chacun, notes les informations que tu as trouv√©es les plus int√©ressantes et utilise ‚ú® pour voir les d√©bouch√©s, üìÖ pour simuler une journ√©e. Si une question persiste, pense √† la poser sur MonOrientationEnLigne.",
        urls: [
            { site: "Onisep.fr", url: 'https://www.onisep.fr' },
            { site: "MonOrientationEnLigne.fr", url: 'https://www.monorientationenligne.fr/' }
        ],
        fields: [
            {id: 'metier1', label: 'M√©tier / Domaine #1', placeholder: 'Ex: D√©veloppeur web'},
            {id: 'notes1', label: 'Notes (√©tudes, comp√©tences, surprises...)', placeholder: 'Ce qui a retenu mon attention...', type: 'textarea'},
            {id: 'metier2', label: 'M√©tier / Domaine #2', placeholder: 'Ex: Journaliste scientifique'},
            {id: 'notes2', label: 'Notes...', placeholder: 'Ce qui a retenu mon attention...', type: 'textarea'},
            {id: 'metier3', label: 'M√©tier / Domaine #3', placeholder: 'Ex: Kin√©sith√©rapeute'},
            {id: 'notes3', label: 'Notes...', placeholder: 'Ce qui a retenu mon attention...', type: 'textarea'}
        ]
    },
    step2: { 
        stepKey: 'step2', title: "Le simulateur de sp√©cialit√©s Horizons21", icon: 'üß≠',
        description: `Cet outil a √©t√© cr√©√© pour t'aider √† faire le lien entre les sp√©cialit√©s du lyc√©e et les √©tudes sup√©rieures. <b>Int√©r√™t principal :</b> Comprendre l'impact de tes choix de mati√®res sur ton avenir et pr√©parer tes choix pour l'ann√©e suivante.`,
        action: {
            seconde: "<b>Ta mission :</b> Teste 3 combinaisons de sp√©cialit√©s pour la classe de premi√®re. Note les horizons ouverts, puis clique sur ‚ú® pour d√©couvrir les comp√©tences √† d√©velopper.",
            premiere: "<b>Ta mission :</b> Teste 3 combinaisons de sp√©cialit√©s pour la classe de terminale (en gardant 2 de tes sp√©cialit√©s actuelles). Cela t'aidera √† affiner ton projet pour Parcoursup."
        },
        url: 'https://www.horizons21.fr', site: 'Horizons21.fr',
        fields: [
            {id: 'combo1', label: 'Combinaison de sp√©cialit√©s #1', placeholder: 'Ex: Maths, Physique-Chimie, NSI'},
            {id: 'notes1', label: 'Horizons ouverts et r√©flexions', placeholder: 'Ouvre les portes de l\'ing√©nierie, du num√©rique...', type: 'textarea'},
            {id: 'skills1', label: 'Comp√©tences cl√©s analys√©es par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'combo2', label: 'Combinaison de sp√©cialit√©s #2', placeholder: 'Ex: HGGSP, SES, LLCE Anglais'},
            {id: 'notes2', label: 'Horizons ouverts et r√©flexions', placeholder: 'Id√©al pour les sciences politiques, le commerce international...', type: 'textarea'},
            {id: 'skills2', label: 'Comp√©tences cl√©s analys√©es par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'combo3', label: 'Combinaison de sp√©cialit√©s #3', placeholder: 'Ex: SVT, Physique-Chimie, Maths'},
            {id: 'notes3', label: 'Horizons ouverts et r√©flexions', placeholder: 'Parfait pour les √©tudes de sant√©, la recherche...', type: 'textarea'},
            {id: 'skills3', label: 'Comp√©tences cl√©s analys√©es par l\'IA', type: 'textarea', isReadonly: true }
        ]
    },
    step3: { 
        stepKey: 'step3', title: 'Le Catalogue Parcoursup', icon: 'üéì',
        description: `Bien plus qu'un site d'inscription, c'est le moteur de recherche le plus exhaustif sur les formations post-bac. <b>Ce qu'il faut absolument regarder :</b> les "attendus", la carte interactive, et les chiffres cl√©s (taux d'acc√®s, etc.).`,
        action: "<b>Ta mission :</b> Trouve 3 formations qui t'int√©ressent. Note leur nom et les 'attendus'. Ensuite, rel√®ve le d√©fi : identifie les 3 mots-cl√©s qui, selon toi, r√©sument le mieux la formation et v√©rifie ta r√©ponse avec l'IA !",
        url: 'https://www.parcoursup.fr', site: 'Parcoursup.fr',
        fields: [
            {id: 'formation1', label: 'Formation #1', placeholder: 'Ex: BUT Informatique - Villetaneuse'},
            {id: 'attendus1', label: 'Attendus et crit√®res importants', placeholder: 'Bon niveau en maths, projet motiv√©...', type: 'textarea'},
            {id: 'mots_cles1', label: 'D√©fi : Tes 3 mots-cl√©s pour cette formation', placeholder: 'Ex: Logique, programmation, travail d\'√©quipe'},
            {id: 'analyse_mots_cles1', label: 'Analyse de tes mots-cl√©s par l\'IA', type: 'textarea', isReadonly: true},
            {id: 'formation2', label: 'Formation #2', placeholder: 'Ex: Licence de Droit - Assas'},
            {id: 'attendus2', label: 'Attendus et crit√®res importants', placeholder: 'Qualit√©s r√©dactionnelles, logique...', type: 'textarea'},
            {id: 'mots_cles2', label: 'D√©fi : Tes 3 mots-cl√©s pour cette formation', placeholder: 'Ex: Rigueur, r√©daction, argumentation'},
            {id: 'analyse_mots_cles2', label: 'Analyse de tes mots-cl√©s par l\'IA', type: 'textarea', isReadonly: true},
            {id: 'formation3', label: 'Formation #3', placeholder: 'Ex: Licence LLCER Anglais - Sorbonne'},
            {id: 'attendus3', label: 'Attendus et crit√®res importants', placeholder: 'Bon niveau en langues, curiosit√©...', type: 'textarea'},
            {id: 'mots_cles3', label: 'D√©fi : Tes 3 mots-cl√©s pour cette formation', placeholder: 'Ex: Litt√©rature, culture, analyse'},
            {id: 'analyse_mots_cles3', label: 'Analyse de tes mots-cl√©s par l\'IA', type: 'textarea', isReadonly: true},
            {id: 'suggestions', label: 'Pistes de r√©flexion sugg√©r√©es par l\'IA', type: 'textarea', isReadonly: true}
        ]
    },
    step4: {
        stepKey: 'step4', title: "L'Exp√©rience avec Inspire", icon: 'üí¨',
        description: `Cette plateforme te permet de discuter avec des √©tudiants "√©claireurs". <b>Int√©r√™t principal :</b> Obtenir un retour d'exp√©rience authentique et humain, au-del√† des plaquettes officielles (ambiance, charge de travail, vie √©tudiante...).`,
        action: "<b>Ta mission :</b> Cherche 2 domaines d'√©tudes. Pr√©pare une question pr√©cise, puis clique sur ‚ú® pour obtenir des suggestions de questions plus pouss√©es √† poser √† un √©tudiant.",
        url: 'https://www.inspire-orientation.org', site: 'Inspire-orientation.org',
        fields: [
            {id: 'theme1', label: 'Formation ou domaine #1', placeholder: 'Ex: √âcoles d\'ing√©nieurs'},
            {id: 'question1', label: 'Ma question principale', placeholder: 'Quelle est la plus grande diff√©rence avec le lyc√©e ?', type: 'textarea'},
            {id: 'suggestions1', label: 'Suggestions de questions par l\'IA', type: 'textarea', isReadonly: true},
            {id: 'theme2', label: 'Formation ou domaine #2', placeholder: 'Ex: √âtudes de sant√© (PASS/LAS)'},
            {id: 'question2', label: 'Ma question principale', placeholder: 'Comment g√©rer la charge de travail ?', type: 'textarea'},
            {id: 'suggestions2', label: 'Suggestions de questions par l\'IA', type: 'textarea', isReadonly: true}
        ]
    },
    step5: {
        stepKey: 'step5', title: "L'Actu & Tests", icon: 'üì∞',
        description: `Des m√©dias comme L'√âtudiant.fr ou Studyrama.com apportent un autre regard. <b>Ce que tu peux y trouver :</b> des classements, des articles sur des secteurs qui recrutent, et des tests d'orientation vari√©s.`,
        action: "<b>Ta mission :</b> Cherche une info ou un classement qui t'int√©resse pour pr√©ciser ce que tu as appris. Ensuite, fais un test d'orientation sur l'un des sites. Note le r√©sultat brut, puis clique sur ‚ú® pour obtenir une analyse personnalis√©e qui croise ce r√©sultat avec ton profil √©tabli dans l'√©tape mieux se connaitre.",
        urls: [
            { site: "L'√âtudiant.fr", url: 'https://www.letudiant.fr' },
            { site: "Studyrama.com", url: 'https://www.studyrama.com/tests' }
        ],
        fields: [
            {id: 'article1', label: 'Info ou classement trouv√© (optionnel)', placeholder: 'Ex: Le classement des √©coles de commerce 2025'},
            {id: 'apprentissage1', label: 'Ce que j\'ai appris', placeholder: 'Certaines √©coles sont sp√©cialis√©es dans le luxe...', type: 'textarea'},
            {id: 'test1', label: 'Test d\'orientation effectu√©', placeholder: 'Ex: Test RIASEC sur Studyrama'},
            {id: 'resultat1', label: 'R√©sultats bruts du test', placeholder: 'Profil "Social/Cr√©atif/Investigateur"', type: 'textarea'}
        ]
    },
    step6: { 
        stepKey: 'step6', title: 'Pr√©parer sa candidature', icon: '‚úçÔ∏è',
        description: `La r√©daction du "projet de formation motiv√©" sur Parcoursup est une √©tape cruciale. Cet outil ne va pas √©crire la lettre √† ta place, mais t'aider √† la structurer de mani√®re claire et percutante.`,
        action: `<b>Ta mission :</b> Choisis une formation que tu as explor√©e √† l'√©tape 3. Liste tes motivations et comp√©tences en quelques points. Clique ensuite sur "G√©n√©rer une structure" pour obtenir un plan personnalis√© pour ta lettre.`,
        fields: [
            {id: 'formation', label: 'Formation vis√©e (nom exact de Parcoursup)', placeholder: 'Ex: BUT Informatique - IUT de Villetaneuse'},
            {id: 'motivations', label: 'Mes motivations, comp√©tences, exp√©riences (en vrac)', placeholder: 'Ex: J\'aime r√©soudre des probl√®mes logiques, j\'ai suivi la sp√© NSI, j\'ai cr√©√© un petit site web, je suis rigoureux...', type: 'textarea'},
            {id: 'structure', label: 'Proposition de structure pour ton projet motiv√©', placeholder: 'La structure g√©n√©r√©e par l\'IA appara√Ætra ici...', type: 'textarea', isReadonly: true}
        ]
     },
    step7: {
        stepKey: 'step7', title: 'Quiz : Chasse aux Mythes', icon: 'üëª',
        description: `Teste tes connaissances ! Certains m√©tiers ou fili√®res sont entour√©s d'id√©es re√ßues. Choisis un domaine et r√©ponds √† une s√©rie de "vrai ou faux" pour d√©m√™ler le vrai du faux.`,
        action: `<b>Ta mission :</b> Entre un domaine d'√©tude ou un m√©tier sur lequel tu veux te tester. L'IA va g√©n√©rer un quiz. Tente d'obtenir le meilleur score !`,
        fields: []
    },
    step8: { 
        stepKey: 'step8', title: 'Passer √† l\'action', icon: 'üöÄ',
        description: `La recherche en ligne est une chose, la r√©alit√© du terrain en est une autre. L'avis d'un professionnel ou le t√©moignage d'un √©tudiant peut tout changer ! Cette √©tape t'aide √† pr√©parer ces rencontres et √† trouver des contenus inspirants.`,
        action: `<b>Ta mission :</b> Suis les √©tapes ci-dessous. D'abord, active ton r√©seau personnel. Ensuite, si besoin, utilise l'IA pour trouver d'autres contacts, des t√©moignages et pr√©parer tes entretiens.`,
        fields: [
            {id: 'pro_reseau_personnel', label: 'Personnes de mon entourage √† contacter (famille, amis des parents, voisins...)', placeholder: 'Ex: Le p√®re de mon ami, qui est ing√©nieur...\nMa voisine, qui travaille dans le marketing...', type: 'textarea'},
            {id: 'pro_metier', label: 'M√©tier pour lequel tu cherches des contacts externes', placeholder: 'Ex: Architecte'},
            {id: 'pro_departement', label: 'Ton d√©partement (ex: 75, Morbihan, ...)', placeholder: 'Ex: Morbihan'},
            {id: 'pro_contacts', label: 'Contacts externes trouv√©s par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'pro_strategie', label: 'Strat√©gie et mod√®le de mail g√©n√©r√©s par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'jpo_ecole', label: '√âcole ou formation pour une Journ√©e Portes Ouvertes', placeholder: 'Ex: INSA Lyon'},
            {id: 'jpo_questions', label: 'Questions cl√©s √† poser (g√©n√©r√©es par l\'IA)', type: 'textarea', isReadonly: true }
        ]
    },
    step9: { 
        stepKey: 'step9', title: 'Anticiper la suite', icon: 'üîÆ',
        description: `L'orientation ne s'arr√™te pas √† Parcoursup. Cette √©tape t'aide √† te pr√©parer pour la suite : que faire si ton v≈ìu n¬∞1 est refus√© ? Et comment bien d√©marrer ta premi√®re ann√©e dans le sup√©rieur ?`,
        action: "<b>Ta mission :</b> Utilise les deux outils ci-dessous. Le premier t'aide √† construire un plan B solide. Le second te donne des conseils pour r√©ussir ta future premi√®re ann√©e.",
        fields: [
            {id: 'formation_reve', label: 'Ma formation "r√™v√©e" (V≈ìu n¬∞1)', placeholder: 'Ex: Classe pr√©pa MPSI au Lyc√©e Louis-le-Grand'},
            {id: 'plan_b', label: 'Suggestions de "Plan B" par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'reussite_type', label: 'Type de formation pour lequel tu veux des conseils', placeholder: 'Ex: Licence de Droit, BUT, Classe Pr√©pa...'},
            {id: 'reussite_conseils', label: 'Conseils de r√©ussite par l\'IA', type: 'textarea', isReadonly: true }
        ]
    },
   step10: { 
        stepKey: 'step10', title: 'Mon Portfolio de Comp√©tences', icon: 'üíº',
        description: `Cette √©tape te propose deux ateliers compl√©mentaires pour cr√©er un portfolio qui te ressemble vraiment. Le premier t'aide √† transformer tes exp√©riences concr√®tes (stage, projet, passion, job...) en comp√©tences valorisables pour tes candidatures. Le second est un 'd√©tecteur' rapide qui te permet de r√©v√©ler tes grandes comp√©tences transversales (ta mani√®re de travailler, de r√©fl√©chir...). L'ensemble te donnera une vision claire et unique de tes atouts.`,
        action: `<b>Ta mission est double :</b><br>
        1. <b>Raconter tes exp√©riences :</b> Clique sur le bouton "+ Ajouter une exp√©rience" et laisse-toi guider. Raconte ce que tu as fait, et l'IA t'aidera √† en extraire les comp√©tences cl√©s pour Parcoursup.<br>
        2. <b>R√©v√©ler ton profil :</b> Lance le "d√©tecteur de comp√©tences" et r√©ponds aux quelques questions. Tu obtiendras une analyse de tes savoir-√™tre dominants (Rigueur, Cr√©ativit√©, Leadership...).`,
        fields: []
    },
    step11: { 
        stepKey: 'step11', title: 'Rencontres sur mon Territoire', icon: 'üåç',
        description: `L'orientation se nourrit aussi de rencontres r√©elles. Utilise cet outil pour trouver des √©v√©nements et des structures d'aide pr√®s de chez toi.`,
        action: "<b>Ta mission :</b> Indique ta ville ou ton d√©partement, puis lance les recherches pour trouver les prochaines opportunit√©s de rencontres et les lieux d'information locaux.",
        fields: [
            {id: 'location', label: 'Ta ville ou ton d√©partement', placeholder: 'Ex: Land√©vant ou Morbihan'}
        ]
    },
    step12: { 
        stepKey: 'step12', title: 'Simulateur Vie √âtudiante', icon: 'üí∂',
        description: `Choisir ses √©tudes, c'est aussi choisir un cadre de vie et un budget. Utilise cet outil pour estimer le co√ªt de la vie dans la ville de ton choix et pour d√©couvrir les principales aides financi√®res auxquelles tu pourrais pr√©tendre.`,
        action: `<b>Ta mission :</b> Renseigne une ville, puis lance les simulateurs pour obtenir une estimation de budget et des pistes pour les bourses.`,
        fields: []
    },
};
const badgesConfig = {
    explorateur: {
        icon: 'üèÖ',
        title: "Badge de l'Explorateur",
        description: "D√©cern√© pour avoir compl√©t√© les premi√®res √©tapes fondamentales de ton exploration.",
        criteria: (level) => {
            const step0Complete = isStepComplete('step0');
            const step1Complete = isStepComplete('step1');
            const step2or3Complete = level === 'seconde' ? isStepComplete('step2') : isStepComplete('step3');
            return step0Complete && step1Complete && step2or3Complete;
        }
    },
    stratege: {
        icon: 'üß†',
        title: "Badge du Strat√®ge",
        description: "D√©cern√© pour avoir planifi√© ton ann√©e et anticip√© l'avenir avec un plan B.",
        criteria: () => {
            const retroplanningComplete = journalData.retroplanning && journalData.retroplanning.rawText && journalData.retroplanning.rawText.trim() !== '';
            const step9Complete = isStepComplete('step9');
            return retroplanningComplete && step9Complete;
        }
    },
    connecteur: {
        icon: 'ü§ù',
        title: "Badge du Connecteur",
        description: "D√©cern√© pour avoir pris contact avec le monde r√©el en contactant un professionnel.",
        criteria: () => {
            return (journalData.step8.pro_reseau_personnel && journalData.step8.pro_reseau_personnel.trim() !== '') || (journalData.step8.pro_contacts && journalData.step8.pro_contacts.trim() !== '');
        }
    }
};
        function createQuestionHTML(id, label, options, selectedValue) {
            let optionsHTML = '<option value="">Choisir...</option>';
            for (const [value, data] of Object.entries(options)) {
                optionsHTML += `<option value="${value}" ${selectedValue === value ? 'selected' : ''} title="${data.description}">${data.text}</option>`;
            }
            return `
                <div class="mb-4">
                    <label class="block text-md font-medium text-slate-700 mb-2">${id}. ${label}</label>
                    <select name="q${id}" class="w-full p-3 border border-slate-300 rounded-lg">
                        ${optionsHTML}
                    </select>
                </div>
            `;
        }

        function createStep0View() {
    const config = stepsConfig.step0;
    const div = createStepView({ ...config, fields: [] });
    
    const form = div.querySelector('#stepForm');
    
    const questions = [
        { id: 1, label: 'Pour un projet, tu pr√©f√®res instinctivement :', options: { equipe: { text: 'Travailler en √©quipe', description: 'Vous aimez confronter vos id√©es et construire √† plusieurs.' }, seul: { text: 'Avancer seul(e)', description: 'Vous pr√©f√©rez ma√Ætriser votre sujet de A √† Z √† votre rythme.' } } },
        { id: 2, label: 'Ce qui t\'attire le plus, c\'est :', options: { concret: { text: 'Le concret, l\'exp√©rimentation', description: 'Vous avez besoin de manipuler et de voir des r√©sultats tangibles.' }, abstrait: { text: 'La th√©orie, les concepts', description: 'Vous aimez jongler avec les id√©es et explorer des concepts complexes.' } } },
        { id: 3, label: 'Face √† un probl√®me, tu vas plut√¥t :', options: { logique: { text: 'Analyser les faits logiquement', description: 'Votre approche est m√©thodique et structur√©e.' }, creatif: { text: 'Imaginer des solutions originales', description: 'Vous pensez "en dehors de la bo√Æte" et faites des liens inattendus.' } } },
        { id: 4, label: 'Ta plus grande motivation serait de :', options: { aider: { text: 'Aider les autres, √™tre utile', description: 'Votre moteur est le sentiment de contribuer √† une cause.' }, performance: { text: 'Atteindre des objectifs, te d√©passer', description: 'Vous √™tes stimul√©(e) par le d√©fi et l\'envie de vous am√©liorer.' } } },
        { id: 5, label: 'Quand tu apprends quelque chose, tu pr√©f√®res :', options: { visuel: { text: 'Voir des sch√©mas, des vid√©os', description: 'Vous retenez mieux en voyant des graphiques ou des d√©monstrations.' }, auditif: { text: '√âcouter des explications', description: 'Vous m√©morisez mieux en √©coutant un professeur ou en discutant.' }, pratique: { text: 'Essayer par toi-m√™me', description: 'Vous avez besoin de faire et de tester pour que √ßa ait du sens.' } } },
        { id: 6, label: 'Dans un groupe, tu aimes plut√¥t :', options: { leader: { text: 'Organiser, diriger', description: 'Vous prenez naturellement les choses en main et motivez les troupes.' }, contributeur: { text: 'Apporter ton expertise', description: 'Vous pr√©f√©rez vous concentrer sur votre domaine pour √™tre efficace.' }, mediateur: { text: 'Assurer la bonne ambiance', description: 'Vous √™tes sensible √† la dynamique du groupe et √† l\'entente.' } } },
        { id: 7, label: 'Ton environnement de travail id√©al serait :', options: { bureau: { text: 'Structur√©, avec des horaires fixes', description: 'Vous aimez les cadres clairs et un planning pr√©visible.' }, terrain: { text: 'Actif, en d√©placement', description: 'Vous avez besoin de bouger et de changer r√©guli√®rement de lieu.' }, flexible: { text: 'Flexible, avec de l\'autonomie', description: 'Vous appr√©ciez de pouvoir g√©rer votre temps et vos t√¢ches.' } } },
        { id: 8, label: 'Tu es plus √† l\'aise avec :', options: { chiffres: { text: 'Les chiffres et les donn√©es', description: 'Vous √™tes √† l\'aise avec les calculs et les raisonnements math√©matiques.' }, mots: { text: 'Les mots et la r√©daction', description: 'Vous aimez lire, √©crire et argumenter.' }, formes: { text: 'Le design et l\'esth√©tique', description: 'Vous √™tes sensible au visuel, aux couleurs et √† l\'harmonie.' } } },
        { id: 9, label: 'Une journ√©e r√©ussie, c\'est quand :', options: { fini: { text: 'Tu as coch√© toutes les cases de ta liste', description: 'La satisfaction vient du travail accompli et de l\'efficacit√©.' }, appris: { text: 'Tu as appris quelque chose de nouveau', description: 'Le plaisir vient de la d√©couverte et de l\'√©largissement des connaissances.' }, cree: { text: 'Tu as cr√©√© quelque chose', description: 'Vous vous sentez √©panoui(e) lorsque vous avez produit du neuf.' } } },
        { id: 10, label: 'Ce qui te stresse le plus, c\'est :', options: { routine: { text: 'La routine et l\'ennui', description: 'Le manque de nouveaut√© et de stimulation vous p√®se.' }, imprevu: { text: 'L\'impr√©vu et le d√©sordre', description: 'Le manque de contr√¥le et les changements vous d√©stabilisent.' }, echec: { text: 'La peur de ne pas √™tre √† la hauteur', description: 'La pression de la performance est votre principale source d\'anxi√©t√©.' } } },
        { id: 11, label: 'Pour prendre une d√©cision, tu te fies √† :', options: { analyse: { text: 'Une analyse factuelle', description: 'Vous pesez le pour et le contre de mani√®re rationnelle.' }, intuition: { text: 'Ton intuition', description: 'Vous vous fiez beaucoup √† votre ressenti int√©rieur.' }, avis: { text: 'L\'avis de personnes de confiance', description: 'Vous avez besoin de discuter et de recueillir des conseils.' } } },
        { id: 12, label: 'Tu te vois plut√¥t comme un :', options: { sprinteur: { text: 'Sprinteur (intense sur de courtes p√©riodes)', description: 'Vous travaillez tr√®s efficacement sous pression, juste avant une √©ch√©ance.' }, marathonien: { text: 'Marathonien (r√©gulier sur le long terme)', description: 'Vous pr√©f√©rez un effort constant et planifi√© sur la dur√©e.' } } },
        { id: 13, label: 'La mati√®re qui t\'int√©resse le plus :', options: { scientifique: { text: 'Les sciences (Maths, SVT, PC...)', description: 'Attrait pour la logique et la compr√©hension du monde naturel.' }, litteraire: { text: 'Les lettres et SHS (Histoire, Philo, SES...)', description: 'Int√©r√™t pour la pens√©e humaine, la soci√©t√© et l\'expression.' }, artistique: { text: 'Les arts ou le sport', description: 'Besoin d\'expression corporelle, cr√©ative ou manuelle.' } } },
        { id: 14, label: 'Tu pr√©f√®res un m√©tier o√π :', options: { securite: { text: 'La s√©curit√© et un bon salaire sont garantis', description: 'Vous privil√©giez la stabilit√© de l\'emploi et un revenu r√©gulier.' }, passion: { text: 'Tu peux vivre de ta passion', description: 'Vous √™tes pr√™t(e) √† des compromis pour faire un travail qui vous anime.' } } },
        { id: 15, label: 'Lequel de ces verbes te parle le plus ?', options: { organiser: { text: 'Organiser', description: 'Le plaisir de structurer, planifier et mettre de l\'ordre.' }, inventer: { text: 'Inventer', description: 'Le besoin de concevoir, d\'innover et d\'imaginer du neuf.' }, transmettre: { text: 'Transmettre', description: 'L\'envie de partager, d\'expliquer et d\'aider √† comprendre.' } } },
        { id: 16, label: 'Face √† une grosse charge de travail, tu as tendance √† :', options: { planifier: { text: 'Planifier √† l\'avance', description: 'Vous anticipez et d√©composez les t√¢ches pour √©viter le stress.' }, procrastiner: { text: 'Travailler √† la derni√®re minute', description: 'Vous √™tes plus efficace sous la pression de l\'√©ch√©ance.' } } },
        { id: 17, label: 'Dans une t√¢che, qu\'est-ce qui te motive le plus ?', options: { processus: { text: 'Le processus, la mani√®re de faire', description: 'Le plaisir r√©side dans la recherche de la meilleure m√©thode.' }, resultat: { text: 'Le r√©sultat final, l\'aboutissement', description: 'L\'important est d\'atteindre l\'objectif, peu importe le chemin.' } } },
        { id: 18, label: 'Tu pr√©f√®res...', options: { expert: { text: 'Devenir expert dans un domaine', description: 'Vous aimez approfondir un sujet pour le ma√Ætriser parfaitement.' }, explorateur: { text: 'Explorer plein de sujets diff√©rents', description: 'La curiosit√© vous pousse √† toucher √† tout, sans forc√©ment tout conna√Ætre √† fond.' } } },
        { id: 19, label: 'Pour des instructions, tu as besoin de...', options: { claires: { text: 'Consignes tr√®s claires et d√©taill√©es', description: 'Vous aimez savoir exactement ce qu\'on attend de vous.' }, generales: { text: 'Consignes g√©n√©rales pour avoir de la libert√©', description: 'Vous pr√©f√©rez avoir de l\'autonomie pour trouver vos propres solutions.' } } },
        { id: 20, label: 'Apr√®s une journ√©e charg√©e, tu te recharges...', options: { seul: { text: 'En passant du temps seul(e)', description: 'Le calme vous est n√©cessaire pour retrouver de l\'√©nergie.' }, amis: { text: 'En voyant tes amis', description: 'L\'interaction sociale vous stimule et vous d√©tend.' } } },
        { id: 21, label: 'La comp√©tition a tendance √† te...', options: { stimuler: { text: 'Stimuler, te pousser √† te d√©passer', description: 'Le d√©fi vous motive √† donner le meilleur de vous-m√™me.' }, stresser: { text: 'Stresser, te faire perdre tes moyens', description: 'La comparaison avec les autres vous met mal √† l\'aise.' } } },
        { id: 22, label: 'Tu te projettes plus facilement...', options: { longterme: { text: 'Dans un avenir lointain (5-10 ans)', description: 'Vous avez une vision claire de ce que vous voulez accomplir.' }, courtterme: { text: 'Sur des objectifs proches (prochaine ann√©e)', description: 'Vous pr√©f√©rez avancer √©tape par √©tape, sans trop vous projeter.' } } },
        { id: 23, label: 'Tu aimerais avoir un impact...', options: { local: { text: 'Direct et visible sur des personnes', description: 'Aider concr√®tement quelqu\'un ou une communaut√© proche.' }, global: { text: 'Global, sur un syst√®me ou une id√©e', description: 'Contribuer √† un projet de grande envergure, m√™me si l\'impact est indirect.' } } },
        { id: 24, label: 'Face √† un √©chec, ta r√©action est de...', options: { analyser: { text: 'Analyser ce qui n\'a pas march√©', description: 'Chaque erreur est une occasion d\'apprendre pour ne pas la refaire.' }, avancer: { text: 'Passer rapidement √† autre chose', description: 'Inutile de s\'attarder sur le pass√©, il faut se concentrer sur la suite.' } } },
        { id: 25, label: 'Le plus important pour toi est...', options: { sens: { text: 'De trouver du sens dans ce que tu fais', description: 'Vous avez besoin que vos actions soient align√©es avec vos valeurs.' }, competence: { text: 'De devenir tr√®s comp√©tent(e)', description: 'L\'excellence technique et la ma√Ætrise d\'un savoir-faire sont votre priorit√©.' } } },
        // --- NOUVELLE QUESTION AJOUT√âE CI-DESSOUS ---
        { id: 26, label: 'Face √† un grand changement (d√©m√©nagement, nouveau projet...), tu es plut√¥t :', options: { enthousiaste: { text: 'Enthousiaste, tu y vois une opportunit√©', description: 'Le changement et la nouveaut√© sont des moteurs pour vous.' }, prudent: { text: 'Prudent(e), tu as besoin de temps pour t\'adapter', description: 'Vous pr√©f√©rez la stabilit√© et les environnements pr√©visibles.' } } },
    ];
    
    let questionsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">';
    questions.forEach(q => {
        questionsHTML += createQuestionHTML(q.id, q.label, q.options, journalData.step0[`q${q.id}`]);
    });
    questionsHTML += '</div>';

    const analysisHTML = `
        <div class="text-center mt-6">
            <button type="button" id="analyzeProfileBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser mon profil</button>
        </div>
        <div id="geminiLoader_step0" class="hidden mt-4"><div class="loader"></div></div>
        <div class="mt-6">
            <label class="block text-md font-medium text-slate-700 mb-2">Analyse de ton profil :</label>
            <textarea name="analysis" id="geminiResult_step0" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step0.analysis || ''}</textarea>
        </div>
        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;
    form.innerHTML = questionsHTML + analysisHTML;
    
    div.querySelector('#analyzeProfileBtn').addEventListener('click', async () => {
        const loader = div.querySelector('#geminiLoader_step0');
        const resultDiv = div.querySelector('#geminiResult_step0');
        
        let allAnswered = true;
        let answersText = "";
        const formData = new FormData(form);
        questions.forEach((q, index) => {
            const answerValue = formData.get(`q${q.id}`);
            if (!answerValue) allAnswered = false;
            const answerText = q.options[answerValue]?.text || 'Non r√©pondu';
            answersText += `${index + 1}. ${q.label} -> ${answerText}\n`;
        });

        if (!allAnswered) {
            resultDiv.value = "Veuillez r√©pondre √† toutes les questions pour obtenir une analyse.";
            return;
        }
        
        resultDiv.value = '';
        loader.style.display = 'block';

        const prompt = `Agis en tant que psychologue sp√©cialis√© en orientation. Voici les r√©ponses d'un lyc√©en √† un questionnaire de personnalit√© :\n${answersText}\n\nR√©dige une analyse bienveillante et structur√©e en 3 parties :\n1. Tes 3 forces principales : Identifie 3 traits de caract√®re ou comp√©tences cl√©s qui ressortent.\n2. Ton environnement id√©al : D√©cris le type d'environnement d'√©tudes ou de travail qui semble te correspondre le mieux (ex: collaboratif, structur√©, cr√©atif, etc.).\n3. Pistes √† explorer : Sugg√®re 2 ou 3 grands domaines ou types de m√©tiers qui pourraient matcher avec ce profil, sans donner de m√©tier pr√©cis. Ta r√©ponse doit √™tre naturelle sans formatage de type # et * .`;

        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none';
        resultDiv.value = result;
    });

    return div;
}
        
        function createStep1Field(field) {
            const value = (journalData.step1 && journalData.step1[field.id]) || '';
            return `
                <div class="mb-4">
                    <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${field.placeholder}" value="${value}">
                        <button type="button" id="geminiBtn_${field.id}" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition" title="Explorer les d√©bouch√©s avec l'IA">‚ú®</button>
                        <button type="button" id="daySimBtn_${field.id}" class="bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition" title="Simuler une journ√©e type">üìÖ</button>
                    </div>
                    <div id="geminiLoader_${field.id}" class="hidden mt-4"><div class="loader"></div></div>
                    <div id="geminiResult_${field.id}" class="mt-4 p-4 bg-cyan-50 border border-cyan-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
                </div>
            `;
        }
        

function createStep1View() {
    const config = stepsConfig.step1;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    // Helper function to turn URLs into clickable links
    const linkify = (text) => {
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        let newText = text.replace(urlRegex, function(url) {
            let hyperLink = url;
            if (!hyperLink.match('^https?:\/\/')) {
                hyperLink = 'http://' + hyperLink;
            }
            return '<a href="' + hyperLink + '" target="_blank" class="text-cyan-600 hover:underline">' + url + '</a>';
        });
        // This makes sure line breaks are preserved
        return newText.replace(/\n/g, '<br>');
    };

    const createMetierBlock = (index) => {
        return `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
                <div class="mb-4">
                    <label for="metier${index}" class="block text-md font-medium text-slate-700 mb-2">M√©tier / Domaine #${index}</label>
                    <input type="text" id="metier${index}" name="metier${index}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[0].placeholder}" value="${journalData.step1[`metier${index}`] || ''}">
                </div>
                <div class="mb-4">
                    <label for="notes${index}" class="block text-md font-medium text-slate-700 mb-2">Notes (√©tudes, comp√©tences, surprises...)</label>
                    <textarea id="notes${index}" name="notes${index}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[1].placeholder}">${journalData.step1[`notes${index}`] || ''}</textarea>
                </div>
                <div class="flex flex-wrap gap-2 justify-center mb-4">
                    <button type="button" data-action="debouches" data-index="${index}" class="ai-btn flex-grow bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Explorer les d√©bouch√©s</button>
                    <button type="button" data-action="journee" data-index="${index}" class="ai-btn flex-grow bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 transition">üìÖ Simuler une journ√©e type</button>
                    <button type="button" data-action="temoignages" data-index="${index}" class="ai-btn flex-grow bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">üé¨ Trouver des t√©moignages</button>
                </div>
                <div id="loader-${index}" class="hidden"><div class="loader"></div></div>
                <div id="result-${index}" class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 min-h-[100px]">
                    Cliquez sur un bouton pour que l'IA vous aide √† explorer ce m√©tier.
                </div>
            </div>
        `;
    };

    form.innerHTML = `
        ${createMetierBlock(1)}
        ${createMetierBlock(2)}
        ${createMetierBlock(3)}
        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;

    div.querySelectorAll('.ai-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const index = e.target.dataset.index;
            const metierInput = div.querySelector(`#metier${index}`);
            const loader = div.querySelector(`#loader-${index}`);
            const resultDiv = div.querySelector(`#result-${index}`);

            const metier = metierInput.value.trim();
            if (!metier) {
                resultDiv.innerHTML = 'Veuillez d\'abord entrer un nom de m√©tier.';
                return;
            }

            resultDiv.innerHTML = '';
            loader.style.display = 'block';

            let prompt = '';
            let useGrounding = false;

            switch(action) {
                case 'debouches':
                    prompt = `En tant que conseiller d'orientation expert, d√©cris en 3 points clairs les d√©bouch√©s pour le m√©tier de "${metier}". Pour chaque point, donne des exemples concrets de postes ou de secteurs. Utilise un ton encourageant et accessible pour un lyc√©en.`;
                    break;
                case 'journee':
                    prompt = `Raconte, √† la premi√®re personne ('Je'), une journ√©e type et r√©aliste d'un(e) '${metier}'. Inclus les t√¢ches du matin, les d√©fis de l'apr√®s-midi, les interactions avec les coll√®gues/clients, et un aspect gratifiant de la journ√©e. Le ton doit √™tre immersif et engageant.`;
                    break;
                case 'temoignages':
                    // NOUVELLE INSTRUCTION PLUS ROBUSTE
                    prompt = `Agis comme un documentaliste expert. Un(e) lyc√©en(ne) s'int√©resse au m√©tier de "${metier}". En utilisant la recherche web, trouve 2 contenus pertinents (interview vid√©o, podcast, article de fond...) qui pr√©sentent un t√©moignage sur ce m√©tier.
                    Pour CHAQUE r√©sultat, fournis le Titre, un bref R√©sum√©, et le Lien URL.
                    INSTRUCTION CRUCIALE : Si ta recherche ne te donne pas l'URL compl√®te et directe d'un contenu, NE DIS PAS que le lien n'est pas disponible. √Ä la place, fournis une instruction de recherche claire pour que l'√©l√®ve le trouve lui-m√™me. Par exemple: "Lien URL : Pour retrouver ce contenu, cherche sur YouTube : 'Titre exact de la vid√©o'".`;
                    useGrounding = true;
                    break;
            }

            const result = await callGeminiAPI(prompt, useGrounding);
            loader.style.display = 'none';
            // On utilise toujours linkify() et .innerHTML pour que les liens (quand ils sont trouv√©s) soient cliquables.
            resultDiv.innerHTML = linkify(result);
        });
    });

    return div;
}

        function createStep2View() { 
            const config = stepsConfig.step2;
            const div = createStepView(config);
            const form = div.querySelector('#stepForm');
            form.innerHTML = `
                <div class="mb-6">
                    <label for="combo1" class="block text-md font-medium text-slate-700 mb-2">${config.fields[0].label}</label>
                    <input type="text" id="combo1" name="combo1" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[0].placeholder}" value="${journalData.step2.combo1 || ''}">
                </div>
                <div class="mb-6">
                    <label for="notes1" class="block text-md font-medium text-slate-700 mb-2">${config.fields[1].label}</label>
                    <textarea id="notes1" name="notes1" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[1].placeholder}">${journalData.step2.notes1 || ''}</textarea>
                </div>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_skills1" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser les comp√©tences</button>
                </div>
                <div id="geminiLoader_skills1" class="hidden"><div class="loader"></div></div>
                 <div class="mb-6">
                    <label for="skills1" class="block text-md font-medium text-slate-700 mb-2">${config.fields[2].label}</label>
                    <textarea id="skills1" name="skills1" rows="4" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step2.skills1 || ''}</textarea>
                </div>
                <hr class="my-8">
                <div class="mb-6">
                    <label for="combo2" class="block text-md font-medium text-slate-700 mb-2">${config.fields[3].label}</label>
                    <input type="text" id="combo2" name="combo2" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[3].placeholder}" value="${journalData.step2.combo2 || ''}">
                </div>
                <div class="mb-6">
                    <label for="notes2" class="block text-md font-medium text-slate-700 mb-2">${config.fields[4].label}</label>
                    <textarea id="notes2" name="notes2" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[4].placeholder}">${journalData.step2.notes2 || ''}</textarea>
                </div>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_skills2" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser les comp√©tences</button>
                </div>
                <div id="geminiLoader_skills2" class="hidden"><div class="loader"></div></div>
                 <div class="mb-6">
                    <label for="skills2" class="block text-md font-medium text-slate-700 mb-2">${config.fields[5].label}</label>
                    <textarea id="skills2" name="skills2" rows="4" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step2.skills2 || ''}</textarea>
                </div>
                <hr class="my-8">
                <div class="mb-6">
                    <label for="combo3" class="block text-md font-medium text-slate-700 mb-2">${config.fields[6].label}</label>
                    <input type="text" id="combo3" name="combo3" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[6].placeholder}" value="${journalData.step2.combo3 || ''}">
                </div>
                <div class="mb-6">
                    <label for="notes3" class="block text-md font-medium text-slate-700 mb-2">${config.fields[7].label}</label>
                    <textarea id="notes3" name="notes3" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[7].placeholder}">${journalData.step2.notes3 || ''}</textarea>
                </div>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_skills3" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser les comp√©tences</button>
                </div>
                <div id="geminiLoader_skills3" class="hidden"><div class="loader"></div></div>
                 <div class="mb-6">
                    <label for="skills3" class="block text-md font-medium text-slate-700 mb-2">${config.fields[8].label}</label>
                    <textarea id="skills3" name="skills3" rows="4" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step2.skills3 || ''}</textarea>
                </div>
                <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
            `;

            const setupGeminiButton = (btnId, inputId, loaderId, resultId) => {
                div.querySelector(`#${btnId}`).addEventListener('click', async () => {
                    const combo = div.querySelector(`#${inputId}`).value;
                    const loader = div.querySelector(`#${loaderId}`);
                    const resultDiv = div.querySelector(`#${resultId}`);
                    if (!combo.trim()) {
                        resultDiv.value = "Veuillez d'abord entrer une combinaison de sp√©cialit√©s.";
                        return;
                    }
                    resultDiv.value = '';
                    loader.style.display = 'block';
                    const prompt = `Pour un lyc√©en qui a choisi la combinaison de sp√©cialit√©s "${combo}", identifie en 3 √† 4 points les comp√©tences transversales (ex: esprit d'analyse, rigueur, cr√©ativit√©, etc.) qu'il devrait d√©velopper pour r√©ussir dans les √©tudes sup√©rieures ouvertes par ces choix. Sois concis et encourageant.`;
                    const result = await callGeminiAPI(prompt);
                    loader.style.display = 'none';
                    resultDiv.value = result;
                });
            };

            setupGeminiButton('geminiBtn_skills1', 'combo1', 'geminiLoader_skills1', 'skills1');
            setupGeminiButton('geminiBtn_skills2', 'combo2', 'geminiLoader_skills2', 'skills2');
            setupGeminiButton('geminiBtn_skills3', 'combo3', 'geminiLoader_skills3', 'skills3');

            return div;
        }

        function createStep3View() {
            const config = stepsConfig.step3;
            const div = createStepView(config);
            const form = div.querySelector('#stepForm');
            
            form.innerHTML = `
                <!-- Formation 1 -->
                <div class="mb-6">
                    <label for="formation1" class="block text-md font-medium text-slate-700 mb-2">${config.fields[0].label}</label>
                    <input type="text" id="formation1" name="formation1" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[0].placeholder}" value="${journalData.step3.formation1 || ''}">
                </div>
                <div class="mb-6">
                    <label for="attendus1" class="block text-md font-medium text-slate-700 mb-2">${config.fields[1].label}</label>
                    <textarea id="attendus1" name="attendus1" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[1].placeholder}">${journalData.step3.attendus1 || ''}</textarea>
                </div>
                <div class="mb-6">
                    <label for="mots_cles1" class="block text-md font-medium text-slate-700 mb-2">${config.fields[2].label}</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="mots_cles1" name="mots_cles1" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[2].placeholder}" value="${journalData.step3.mots_cles1 || ''}">
                        <button type="button" id="geminiBtn_mots_cles1" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition" title="V√©rifier mes mots-cl√©s">‚ú®</button>
                    </div>
                </div>
                <div id="geminiLoader_mots_cles1" class="hidden"><div class="loader"></div></div>
                <div class="mb-6">
                    <label for="analyse_mots_cles1" class="block text-md font-medium text-slate-700 mb-2">${config.fields[3].label}</label>
                    <textarea id="analyse_mots_cles1" name="analyse_mots_cles1" rows="4" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step3.analyse_mots_cles1 || ''}</textarea>
                </div>

                <hr class="my-8">

                <!-- Formation 2 -->
                <div class="mb-6">
                    <label for="formation2" class="block text-md font-medium text-slate-700 mb-2">${config.fields[4].label}</label>
                    <input type="text" id="formation2" name="formation2" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[4].placeholder}" value="${journalData.step3.formation2 || ''}">
                </div>
                <div class="mb-6">
                    <label for="attendus2" class="block text-md font-medium text-slate-700 mb-2">${config.fields[5].label}</label>
                    <textarea id="attendus2" name="attendus2" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[5].placeholder}">${journalData.step3.attendus2 || ''}</textarea>
                </div>
                <div class="mb-6">
                    <label for="mots_cles2" class="block text-md font-medium text-slate-700 mb-2">${config.fields[6].label}</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="mots_cles2" name="mots_cles2" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[6].placeholder}" value="${journalData.step3.mots_cles2 || ''}">
                         <button type="button" id="geminiBtn_mots_cles2" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition" title="V√©rifier mes mots-cl√©s">‚ú®</button>
                    </div>
                </div>
                <div id="geminiLoader_mots_cles2" class="hidden"><div class="loader"></div></div>
                <div class="mb-6">
                    <label for="analyse_mots_cles2" class="block text-md font-medium text-slate-700 mb-2">${config.fields[7].label}</label>
                    <textarea id="analyse_mots_cles2" name="analyse_mots_cles2" rows="4" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step3.analyse_mots_cles2 || ''}</textarea>
                </div>

                <hr class="my-8">

                <!-- Suggestions alternatives -->
                <h2 class="text-xl font-semibold mb-4 text-slate-800">üí° Explorer des pistes alternatives</h2>
                <p class="text-slate-600 mb-4">Parfois, les meilleures options sont celles auxquelles on n'avait pas pens√©. Sur la base de ton profil (d√©fini lors de l'√©tape mieux se conna√Ætre), l'IA peut te sugg√©rer des parcours compl√©mentaires ou diff√©rents.</p>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_alternatives" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Sugg√©rer des parcours alternatifs</button>
                </div>
                <div id="geminiLoader_alternatives" class="hidden"><div class="loader"></div></div>
                <div class="mb-6">
                    <label for="suggestions" class="block text-md font-medium text-slate-700 mb-2">${config.fields[8].label}</label>
                    <textarea id="suggestions" name="suggestions" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step3.suggestions || ''}</textarea>
                </div>

                <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
            `;
            
            const setupChallengeButton = (btnId, formationId, keywordsId, loaderId, resultId) => {
                div.querySelector(`#${btnId}`).addEventListener('click', async () => {
                    const formation = div.querySelector(`#${formationId}`).value;
                    const keywords = div.querySelector(`#${keywordsId}`).value;
                    const loader = div.querySelector(`#${loaderId}`);
                    const resultDiv = div.querySelector(`#${resultId}`);

                    if (!formation.trim() || !keywords.trim()) {
                        resultDiv.value = "Veuillez renseigner la formation et vos mots-cl√©s.";
                        return;
                    }
                    resultDiv.value = '';
                    loader.style.display = 'block';

                    const prompt = `Agis comme un examinateur bienveillant. Un lyc√©en s'int√©resse √† la formation : "${formation}". Il pense que les 3 mots-cl√©s qui la d√©crivent le mieux sont : "${keywords}". En te basant sur une recherche web des "attendus" officiels de cette formation sur Parcoursup, √©value sa r√©ponse. Dis-lui si ses mots sont pertinents et pourquoi. Si certains sont moins adapt√©s, propose des alternatives plus pr√©cises en justifiant ton choix.`;
                    const result = await callGeminiAPI(prompt, true);
                    
                    loader.style.display = 'none';
                    resultDiv.value = result;
                });
            };

            setupChallengeButton('geminiBtn_mots_cles1', 'formation1', 'mots_cles1', 'geminiLoader_mots_cles1', 'analyse_mots_cles1');
            setupChallengeButton('geminiBtn_mots_cles2', 'formation2', 'mots_cles2', 'geminiLoader_mots_cles2', 'analyse_mots_cles2');

            div.querySelector('#geminiBtn_alternatives').addEventListener('click', async () => {
                const loader = div.querySelector('#geminiLoader_alternatives');
                const resultDiv = div.querySelector('#suggestions');
                const formation1 = div.querySelector('#formation1').value;
                const formation2 = div.querySelector('#formation2').value;

                if (!journalData.step0.analysis) {
                    resultDiv.value = "Pour obtenir des suggestions personnalis√©es, veuillez d'abord compl√©ter l'√âtape: Mieux se conna√Ætre.";
                    return;
                }

                if (!formation1.trim() && !formation2.trim()) {
                    resultDiv.value = "Veuillez renseigner au moins une formation qui vous int√©resse ci-dessus.";
                    return;
                }

                resultDiv.value = '';
                loader.style.display = 'block';

                const prompt = `Agis comme un conseiller d'orientation expert et cr√©atif. Voici l'analyse du profil d'un lyc√©en : "${journalData.step0.analysis}". 
                Ce lyc√©en s'int√©resse principalement √† ces formations : "${formation1}" et "${formation2}".

                Ta mission est de lui proposer 3 parcours alternatifs ou compl√©mentaires auxquels il n'aurait peut-√™tre pas pens√©, mais qui correspondent bien √† son profil. Pour chaque suggestion :
                1. Donne le nom du type de parcours (ex: BUT, Licence Professionnelle, √âcole sp√©cialis√©e, etc.).
                2. Explique en une ou deux phrases pourquoi ce parcours est pertinent par rapport √† son profil et √† ses int√©r√™ts initiaux.
                Le ton doit √™tre encourageant et ouvrir des perspectives.`;

                const result = await callGeminiAPI(prompt);
                loader.style.display = 'none';
                resultDiv.value = result;
            });

            return div;
        }
function createStep12View() {
    const config = stepsConfig.step12;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    // Interface personnalis√©e pour le simulateur
    form.innerHTML = `
        <div class="mb-8">
            <label for="city-input" class="block text-md font-medium text-slate-700 mb-2">Dans quelle ville imagines-tu tes futures √©tudes ?</label>
            <input type="text" id="city-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Lyon, Rennes, Bordeaux...">
        </div>

        <div class="bg-slate-50 border border-slate-200 p-3 rounded-lg text-sm text-slate-600 mb-4">
            <p><strong class="font-semibold text-slate-800">Comment √ßa marche ?</strong> L'application demande √† l'IA d'effectuer une recherche en temps r√©el pour trouver les co√ªts et les aides les plus r√©cents pour la ville choisie, puis met en forme sa r√©ponse.</p>
        </div>

        <div class="text-center mb-6">
            <button type="button" id="budget-btn" class="w-full sm:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üìä Estimer le Budget Mensuel √âtudiant</button>
        </div>
        <div id="loader-budget" class="hidden"><div class="loader"></div></div>
        <div id="budget-result" class="mb-10"></div>

        <hr class="my-10">

        <h3 class="text-xl font-bold text-center text-slate-800 mb-4">Recherche des Aides Financi√®res</h3>
        <p class="text-center text-slate-600 mb-6">D√©couvrez les principaux dispositifs pour financer votre vie √©tudiante.</p>
        <div class="text-center mb-6">
            <button type="button" id="aides-btn" class="w-full sm:w-auto bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">üí∞ Chercher les Aides Disponibles</button>
        </div>
        <div id="loader-aides" class="hidden"><div class="loader"></div></div>
        <div id="aides-result" class="mb-10"></div>
    `;
    
    const cityInput = div.querySelector('#city-input');

    // Logique pour l'estimation du budget
    div.querySelector('#budget-btn').addEventListener('click', async () => {
        const city = cityInput.value.trim();
        if (!city) {
            alert("Veuillez renseigner une ville.");
            return;
        }
        const loader = div.querySelector('#loader-budget');
        const resultDiv = div.querySelector('#budget-result');
        loader.style.display = 'block';
        resultDiv.innerHTML = '';

        const prompt = `Agis comme un conseiller financier pour futurs √©tudiants. Pour la ville de "${city}", estime le budget mensuel moyen d'un √©tudiant qui s'y installe pour ses √©tudes. Utilise la recherche web pour trouver des donn√©es r√©centes. Ta r√©ponse doit √™tre **uniquement un objet JSON valide**. L'objet doit contenir les cl√©s "loyer_crous", "loyer_prive_studio", "alimentation", "transport", "loisirs", et "resume" avec une phrase de synth√®se.`;

        const result = await callGeminiAPI(prompt, true, true);
        loader.style.display = 'none';

        try {
            const data = JSON.parse(result);
            const totalMin = parseInt(data.loyer_crous) + parseInt(data.alimentation) + parseInt(data.transport) + parseInt(data.loisirs);
            const totalMax = parseInt(data.loyer_prive_studio) + parseInt(data.alimentation) + parseInt(data.transport) + parseInt(data.loisirs);
            
            resultDiv.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Budget Mensuel Estim√© pour un √©tudiant √† ${city}</h3>
                    <div class="text-center mb-4">
                        <p class="text-slate-600">Estimation totale</p>
                        <p class="text-3xl font-bold text-cyan-600">${totalMin}‚Ç¨ - ${totalMax}‚Ç¨ / mois</p>
                    </div>
                    <div class="border-t pt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div><p class="text-lg font-semibold">üè† Loyer</p><p class="text-slate-500">${data.loyer_crous}‚Ç¨ - ${data.loyer_prive_studio}‚Ç¨</p></div>
                        <div><p class="text-lg font-semibold">üõí Alimentation</p><p class="text-slate-500">~${data.alimentation}‚Ç¨</p></div>
                        <div><p class="text-lg font-semibold">üöá Transport</p><p class="text-slate-500">~${data.transport}‚Ç¨</p></div>
                        <div><p class="text-lg font-semibold">üéâ Loisirs</p><p class="text-slate-500">~${data.loisirs}‚Ç¨</p></div>
                    </div>
                </div>
            `;
        } catch (e) {
            resultDiv.innerHTML = `<p class="text-red-500 text-center">L'IA n'a pas pu g√©n√©rer une estimation structur√©e. Veuillez r√©essayer.</p>`;
        }
    });

    // Logique pour la recherche d'aides
    div.querySelector('#aides-btn').addEventListener('click', async () => {
        const loader = div.querySelector('#loader-aides');
        const resultDiv = div.querySelector('#aides-result');
        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        
        // --- PROMPT AM√âLIOR√â AVEC DEMANDE DE LIEN ---
        const prompt = `Agis comme un coach financier sp√©cialis√© dans la vie √©tudiante. Un futur √©tudiant pr√©pare son budget et souhaite conna√Ætre les principales aides financi√®res. Ta mission est de fournir une liste claire et structur√©e. Pour chaque aide, tu dois pr√©ciser : son nom officiel, le public cible, la d√©marche cl√© pour l'obtenir, et **un lien direct vers le site officiel d'information ou de simulation** (ex: etudiant.gouv.fr, service-public.fr, caf.fr). Organise ta r√©ponse en cat√©gories.`;

        const result = await callGeminiAPI(prompt, true);
        loader.style.display = 'none';

        // --- AFFICHAGE AM√âLIOR√â AVEC LIENS CLIQUABLES ---
        let formattedResult = result.replace(/\* (.*?):/g, '<strong class="text-cyan-700">$1:</strong>');
        formattedResult = linkify(formattedResult); // Transforme les URL en liens
        resultDiv.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">${formattedResult}</div>`;
    });

    return div;
}

function createGuideView() {
    // On s'assure que le chatbot est bien cach√© sur cette page
    document.getElementById('chatbot-toggle').style.display = 'none';

    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    const backButtonAction = cameFromLogin ? 'showLoginViewFromGuide()' : 'window.showView("menu")';

    const guideHTML = `
        <style>
            .guide-container { line-height: 1.7; }
            .guide-container h2 { border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; color: #1e293b; margin-top: 60px; font-size: 1.75em; font-weight: 700; }
            .guide-container h3 { color: #334155; font-size: 1.3em; margin-top: 40px; font-weight: 600; }
            .guide-container .centered-subtitle { text-align: center; margin-bottom: 30px; }
            .guide-container h4 { margin-top: 0; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; }
            .guide-container .logo { display: block; margin: 0 auto 20px auto; width: 350px; }
            .guide-container .info-box { padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid; }
            .guide-container .info-box-parents { background-color: #f7fee7; border-color: #84cc16; } /* Vert Citron */
            .guide-container .info-box-parents h4 { color: #4d7c0f; display: block; }
            .guide-container .info-box-parents ul { padding-left: 20px; margin-bottom: 0; color: #65a30d; }
            .guide-container .info-box-teachers { background-color: #fff7ed; border-color: #f97316; } /* Orange */
            .guide-container .info-box-teachers h4 { color: #9a3412; display: block; }
            .guide-container .info-box-teachers ul { padding-left: 20px; margin-bottom: 0; color: #c2410c; }
            .guide-container .conseil-prof { background-color: #ecfeff; border-left: 4px solid #0891b2; padding: 15px; margin-top: 15px; border-radius: 8px; font-style: italic; color: #155e75; } /* Cyan */
            .guide-container .conseil-prof h4 { color: #164e63; }
            .guide-container .etape { margin-bottom: 30px; padding-left: 10px; border-left: 2px solid #e2e8f0; }
            .guide-container ul { padding-left: 25px; margin-top: 10px; }
            .guide-container li { margin-bottom: 8px; }
        </style>
        <div class="guide-container">
            <img src="logo.png" alt="Logo Mon Explor'Orientation" class="logo">
            
            <h2>Introduction : Qu'est-ce que "Mon Explor'Orientation" ?</h2>
            <p>"Mon Explor'Orientation" est un <strong>carnet de bord num√©rique interactif</strong>, con√ßu pour accompagner chaque lyc√©en dans la construction de son projet d'avenir. Son objectif est de rendre l'√©l√®ve acteur de son orientation en lui proposant une m√©thode structur√©e et des outils intelligents pour l'aider √† chaque √©tape de sa r√©flexion.</p>
            <div class="info-box conseil-prof" style="font-style: normal;">
                <h4 style="font-weight: bold; color: #3730A3; display:block;">ü§ñ Le r√¥le de l'Intelligence Artificielle (IA)</h4>
                <p style="margin-top: 10px; font-style: normal;">Dans cette application, l'IA est votre <strong>assistante personnelle bienveillante</strong>. Elle n'est pas l√† pour d√©cider √† votre place, mais pour vous faire gagner du temps et enrichir votre r√©flexion. Concr√®tement, elle va analyser, synth√©tiser, sugg√©rer, rechercher et structurer l'information.</p>
                <p style="margin-top: 15px; font-style: normal;"><strong>L'√©l√®ve reste toujours le pilote :</strong> c'est vous qui explorez, qui choisissez et qui prenez les d√©cisions finales. L'IA est simplement un copilote expert qui vous aide √† naviguer.</p>
            </div>
            
            <h2>Partie 1 : Pour les √âl√®ves</h2>
            <p>Consid√®re cette application comme ton camp de base personnel. C'est ici que tu vas rassembler tes trouvailles, tester tes id√©es et, pas √† pas, dessiner ton chemin. Le but n'est pas de tout finir en un week-end, mais d'avancer √† ton rythme tout au long de l'ann√©e.</p>
            <div class="info-box conseil-prof" style="font-style: normal;">
                <h4 style="font-weight: bold; color: #3730A3; display:block;">Tes grands objectifs :</h4>
                <ul>
                    <li><strong>Mieux te conna√Ætre :</strong> Identifier tes forces, tes centres d'int√©r√™t et ce qui te motive vraiment.</li>
                    <li><strong>Explorer intelligemment :</strong> D√©couvrir des m√©tiers et des formations en t'appuyant sur les sites de r√©f√©rence.</li>
                    <li><strong>Structurer ta pens√©e :</strong> Garder une trace de tes recherches, doutes et d√©couvertes dans ton journal de bord.</li>
                    <li><strong>Agir concr√®tement :</strong> T'aider √† pr√©parer tes candidatures, √† trouver des contacts et √† planifier ton ann√©e.</li>
                </ul>
            </div>

            <h2>Partie 2 : Pour les Parents</h2>
            <p>Votre r√¥le dans l'orientation de votre enfant est essentiel. Cette application est con√ßue pour √™tre un pont entre sa r√©flexion personnelle et vos discussions.</p>
            <div class="info-box info-box-parents">
                <h4>Comment aider efficacement ?</h4>
                <ul>
                    <li><strong>Favorisez le dialogue :</strong> L'application est l'espace personnel de votre enfant. Le but n'est pas de le surveiller, mais de l'inviter √† partager ce qu'il y d√©couvre.</li>
                    <li><strong>Utilisez la fonction "Partage" :</strong> Votre enfant peut g√©n√©rer un lien s√©curis√© vers son "Journal de Bord". C'est une excellente base pour un √©change constructif et bienveillant.</li>
                    <li><strong>Conseil cl√© :</strong> Int√©ressez-vous √† sa d√©marche plus qu'√† ses conclusions. Le cheminement est plus important que le choix final √† un instant T.</li>
                </ul>
            </div>

            <h2>Partie 3 : Pour les Enseignants</h2>
            <p>Cet outil peut devenir un formidable support pour nos missions d'accompagnement √† l'orientation, notamment dans le cadre du <strong>Parcours Avenir</strong>.</p>
            <div class="info-box info-box-teachers">
                <h4>Pistes d'utilisation p√©dagogique</h4>
                <ul>
                    <li><strong>Suivi individualis√© :</strong> Le partage du "Journal de Bord" permet de pr√©parer les entretiens individuels de mani√®re beaucoup plus efficace.</li>
                    <li><strong>Support pour les s√©ances collectives :</strong> De nombreuses √©tapes peuvent servir de base pour des ateliers en classe.</li>
                    <li><strong>Langage commun :</strong> L'utilisation de cet outil cr√©e des rep√®res partag√©s entre les √©l√®ves, les familles et l'√©quipe √©ducative.</li>
                </ul>
                <h4 style="margin-top: 20px;">Exemples d'activit√©s concr√®tes en classe :</h4>
                <ul>
                    <li><strong>Atelier "Autoportrait d'orientation" (1h) :</strong> Les √©l√®ves compl√®tent l'√©tape <strong>"üë§ Mieux se conna√Ætre"</strong>. En petits groupes, ils √©changent sur les forces que l'IA a identifi√©es pour eux.</li>
                    <li><strong>Atelier "Chasseurs de Mythes" (1h) :</strong> En √©quipes, chaque groupe utilise l'√©tape <strong>"üëª Quiz : Chasse aux Mythes"</strong> pour un secteur et pr√©sentent ensuite les id√©es re√ßues qu'ils ont d√©construites.</li>
                    <li><strong>Atelier "Pr√©paration au Grand Oral" (1h - Terminales) :</strong> Les √©l√®ves utilisent l'√©tape <strong>"üíº Mon Portfolio de Comp√©tences"</strong> pour analyser une exp√©rience personnelle et s'entra√Ænent √† la pr√©senter oralement.</li>
                    <li><strong>Atelier "Le D√©fi Budget √âtudiant" (1h) :</strong> Par groupe, les √©l√®ves re√ßoivent un sc√©nario et, avec l'√©tape <strong>"üí∂ Simulateur Vie √âtudiante"</strong>, ils doivent estimer leur budget et trouver les aides.</li>
                </ul>
            </div>
            
            <h2>Partie 4 : Exploration D√©taill√©e des Fonctionnalit√©s</h2>
            <h3 class="centered-subtitle">Les Outils Centraux et Transversaux</h3>
            <div class="etape">
                <h4>üóìÔ∏è Mon R√©troplanning</h4>
                <p><strong>Objectif :</strong> Planifier son ann√©e sans stress en visualisant les grandes √©ch√©ances.</p>
                <p><strong>Fonctionnement :</strong> L'IA g√©n√®re un calendrier d'actions mois par mois adapt√© √† votre classe. Vous pouvez cocher les t√¢ches accomplies.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est l'outil parfait pour ne jamais √™tre pris de court. Une ann√©e bien planifi√©e est une ann√©e plus sereine.</div>
            </div>
            <div class="etape">
                <h4>üìì Mon Journal de Bord</h4>
                <p><strong>Objectif :</strong> Centraliser et synth√©tiser toutes vos r√©flexions au m√™me endroit.</p>
                <p><strong>Fonctionnement :</strong> Retrouvez ici toutes les notes prises √† chaque √©tape. L'IA peut g√©n√©rer un "Fil Rouge" pour r√©sumer votre profil et votre projet. Une fonction d'export PDF et de partage est disponible.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> Ce journal est la base de discussion la plus concr√®te et la plus riche que vous puissiez avoir avec vos parents ou votre professeur principal.</div>
            </div>
            <div class="etape">
                <h4>ü§ñ Ton Coach Orientation (Chatbot)</h4>
                <p><strong>Objectif :</strong> Obtenir des r√©ponses rapides et fiables sur le fonctionnement de Parcoursup.</p>
                <p><strong>Fonctionnement :</strong> Une fen√™tre de discussion est disponible en permanence pour poser des questions sur les "attendus" d'une formation, le calendrier, les types de v≈ìux, etc.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> Utilisez-le pour d√©crypter le jargon de Parcoursup et obtenir des informations pr√©cises sur une formation qui vous int√©resse.</div>
            </div>
            <div class="etape">
                <h4>üì° Le Radar √† Opportunit√©s</h4>
                <p><strong>Objectif :</strong> D√©bloquer sa r√©flexion en d√©couvrant une piste de m√©tier ou de secteur inattendue mais pertinente.</p>
                <p><strong>Fonctionnement :</strong> En un clic, l'IA analyse l'int√©gralit√© de votre journal de bord pour vous proposer une id√©e "hors des sentiers battus" qui correspond √† votre profil profond.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est l'outil id√©al lorsque vous avez l'impression de tourner en rond. Laissez-vous surprendre !</div>
            </div>
            <div class="etape">
                <h4>üèÜ Le Syst√®me de Badges</h4>
                <p><strong>Objectif :</strong> Valoriser et r√©compenser votre progression.</p>
                <p><strong>Fonctionnement :</strong> En compl√©tant des ensembles d'√©tapes cl√©s, vous d√©bloquez des badges qui apparaissent dans votre en-t√™te d'accueil pour symboliser vos accomplissements.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> Les badges sont un excellent moyen de visualiser vos progr√®s et de rester motiv√©.</div>
            </div>

            <h3 class="centered-subtitle">Les √âtapes Cl√©s de l'Exploration</h3>
            <div class="etape">
                <h4>üë§ Mieux se conna√Ætre</h4>
                <p><strong>Objectif :</strong> Dresser un portrait de votre personnalit√© et de vos pr√©f√©rences.</p>
                <p><strong>Fonctionnement :</strong> Vous r√©pondez √† un questionnaire complet de 26 questions. L'IA analyse vos r√©ponses pour dresser un portrait de vos forces.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> R√©pondez honn√™tement ! Il n'y a pas de bonnes ou de mauvaises r√©ponses. Le but est de cr√©er une base solide pour la suite.</div>
            </div>
            <div class="etape">
                <h4>üíº Mon Portfolio de Comp√©tences</h4>
                <p><strong>Objectif :</strong> Cr√©er un portfolio unique de vos atouts, bas√© sur ce que vous faites et ce que vous √™tes.</p>
                <p><strong>Fonctionnement :</strong> Cette √©tape propose deux ateliers. Le premier vous aide √† transformer vos exp√©riences (stage, projet, passion...) en comp√©tences valorisables. Le second est un 'd√©tecteur' rapide pour r√©v√©ler vos comp√©tences transversales (rigueur, cr√©ativit√©...).</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est une √©tape cruciale. Savoir parler de soi et de ses comp√©tences est un atout majeur pour Parcoursup et au-del√†.</div>
            </div>
            <div class="etape">
                <h4>üì∞ L'Actu & Tests</h4>
                <p><strong>Objectif :</strong> S'informer sur les classements et obtenir un autre regard sur soi via des tests d'orientation.</p>
                <p><strong>Fonctionnement :</strong> Explorez des sites comme L'√âtudiant.fr. Faites un test et l'IA pourra analyser vos r√©sultats en les croisant avec votre profil de l'√©tape "Mieux se conna√Ætre".</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> Les tests sont un outil de plus pour la r√©flexion, pas une v√©rit√© absolue. L'analyse crois√©e de l'IA vous aidera √† prendre du recul.</div>
            </div>
            <div class="etape">
                <h4>üìö Les Fondations (avec Onisep)</h4>
                <p><strong>Objectif :</strong> D√©couvrir des m√©tiers sur la base d'informations fiables et officielles.</p>
                <p><strong>Fonctionnement :</strong> Explorez des fiches m√©tiers sur Onisep.fr. L'IA peut simuler une "journ√©e type" ou vous aider √† trouver des t√©moignages.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> L'Onisep est la source la plus neutre et la plus compl√®te. C'est le point de d√©part incontournable.</div>
            </div>
            <div class="etape">
                <h4>üéì Le Catalogue (avec Parcoursup)</h4>
                <p><strong>Objectif :</strong> Apprendre √† utiliser le moteur de recherche des formations post-bac comme un expert.</p>
                <p><strong>Fonctionnement :</strong> Apprenez √† analyser les fiches de formation, √† comprendre les "attendus" et les crit√®res d'√©valuation. L'IA peut vous sugg√©rer des pistes alternatives.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> Utilisez Parcoursup d√®s la Seconde pour explorer, sans la pression des v≈ìux. C'est le meilleur catalogue de formations qui existe.</div>
            </div>
             <div class="etape">
                <h4>üëª Quiz : Chasse aux Mythes</h4>
                <p><strong>Objectif :</strong> Tester ses connaissances et d√©construire les id√©es re√ßues sur certains m√©tiers ou fili√®res.</p>
                <p><strong>Fonctionnement :</strong> Choisissez un domaine, et l'IA g√©n√®re un quiz "vrai ou faux" pour vous mettre au d√©fi.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est une fa√ßon ludique de v√©rifier ses informations et d'ouvrir ses horizons en combattant les pr√©jug√©s.</div>
            </div>
            <div class="etape">
                <h4>üß≠ Le simulateur de sp√©cialit√©s (avec Horizons21)</h4>
                <p><strong>Objectif :</strong> Faire le lien entre les mati√®res choisies au lyc√©e et les fili√®res d'√©tudes sup√©rieures.</p>
                <p><strong>Fonctionnement :</strong> Testez des combinaisons de sp√©cialit√©s et analysez les "horizons" (domaines d'√©tudes) qu'elles vous ouvrent.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est l'outil essentiel pour faire vos choix en fin de Seconde et de Premi√®re de mani√®re √©clair√©e.</div>
            </div>
            <div class="etape">
                <h4>üí¨ L'Exp√©rience (avec Inspire)</h4>
                <p><strong>Objectif :</strong> Obtenir un retour authentique de la part d'√©tudiants.</p>
                <p><strong>Fonctionnement :</strong> L'outil vous aide √† pr√©parer des questions pertinentes √† poser √† des "√©tudiants √©claireurs" et propose un simulateur d'entretien pour vous entra√Æner.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est le meilleur moyen de conna√Ætre la "vraie vie" d'une formation, au-del√† des brochures officielles.</div>
            </div>
            <div class="etape">
                <h4>üöÄ Passer √† l'action</h4>
                <p><strong>Objectif :</strong> Pr√©parer des rencontres avec des professionnels et des visites d'√©tablissements.</p>
                <p><strong>Fonctionnement :</strong> L'application vous aide √† identifier des contacts, √† pr√©parer un mail et √† lister des questions pertinentes pour une Journ√©e Portes Ouvertes (JPO).</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> La recherche en ligne est une chose, la r√©alit√© du terrain en est une autre. Une rencontre peut tout changer !</div>
            </div>
            <div class="etape">
                <h4>üåç Rencontres sur mon Territoire</h4>
                <p><strong>Objectif :</strong> Trouver des √©v√©nements et des structures d'aide pr√®s de chez vous.</p>
                <p><strong>Fonctionnement :</strong> Indiquez votre ville, et l'IA recherche jusqu'√† 6 √©v√©nements et 6 structures locales. Les liens sont g√©n√©r√©s automatiquement pour √™tre toujours fonctionnels.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> L'orientation se fait aussi sur le terrain. Une visite ou une rencontre peut parfois tout changer.</div>
            </div>
            <div class="etape">
                <h4>‚úçÔ∏è Pr√©parer sa candidature (Terminales)</h4>
                <p><strong>Objectif :</strong> R√©diger un "projet de formation motiv√©" clair et percutant pour Parcoursup.</p>
                <p><strong>Fonctionnement :</strong> En fonction de vos motivations, l'IA vous propose une structure et un plan d√©taill√© pour votre lettre, sans jamais l'√©crire √† votre place.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> Une lettre bien structur√©e a plus d'impact qu'un long texte confus. Cet outil vous apprend √† √™tre clair et convaincant.</div>
            </div>
            <div class="etape">
                <h4>üîÆ Anticiper la suite (Terminales)</h4>
                <p><strong>Objectif :</strong> Pr√©parer l'apr√®s-Parcoursup.</p>
                <p><strong>Fonctionnement :</strong> L'IA vous aide √† r√©fl√©chir √† un plan B solide et vous donne des conseils concrets pour r√©ussir votre premi√®re ann√©e dans le sup√©rieur.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> Une bonne orientation, c'est aussi √™tre bien pr√©par√© pour la suite. Ces √©tapes vous donnent les cl√©s pour une transition r√©ussie.</div>
            </div>
            <div class="etape">
                <h4>üí∂ Simulateur Vie √âtudiante</h4>
                <p><strong>Objectif :</strong> Se projeter concr√®tement dans sa future vie d'√©tudiant.</p>
                <p><strong>Fonctionnement :</strong> Estimez le co√ªt de la vie dans votre future ville d'√©tudes et d√©couvrez les principales aides financi√®res, avec des liens directs et fiables vers les sites officiels.</p>
                <div class="conseil-prof"><strong>Conseil du Prof :</strong> L'aspect financier est une partie importante du projet. L'anticiper permet de faire des choix plus sereins.</div>
            </div>

            <h2>Partie 5 : Technologie et Donn√©es Personnelles</h2>
            <div class="etape">
                <h4>Le Mod√®le d'IA Utilis√©</h4>
                <p>
                    L'intelligence artificielle int√©gr√©e √† cette application est propuls√©e par <strong>Gemini 1.5 Flash</strong>, un mod√®le de langage multimodal d√©velopp√© par Google. C'est cet outil qui permet d'analyser vos notes, de g√©n√©rer des suggestions, de synth√©tiser des informations ou de faire des recherches web cibl√©es pour enrichir votre r√©flexion.
                </p>
            </div>
            <div class="etape">
                <h4>Vos Donn√©es Personnelles</h4>
                <div class="conseil-prof" style="font-style: normal;">
                    La protection de vos donn√©es est une priorit√© absolue. Voici en toute transparence comment elles sont g√©r√©es :
                    <ul>
                        <li><strong>Quelles donn√©es sont collect√©es ?</strong> L'application collecte uniquement les informations que vous fournissez : votre nom, pr√©nom, email, nom de votre lyc√©e, ainsi que toutes les notes que vous inscrivez dans votre journal de bord.</li>
                        <li><strong>Qui les collecte et o√π sont-elles h√©berg√©es ?</strong> Vos donn√©es sont collect√©es par le cr√©ateur de l'application, Thomas Cavil, et sont stock√©es de mani√®re s√©curis√©e sur <strong>Firebase</strong>, une plateforme de Google. L'h√©bergement se fait sur des serveurs s√©curis√©s en Europe.</li>
                        <li><strong>Comment sont-elles utilis√©es ?</strong> Vos donn√©es ne sont utilis√©es <strong>que pour le fonctionnement de l'application</strong>. Votre journal de bord est envoy√© √† l'IA Gemini pour g√©n√©rer les r√©ponses contextuelles, mais il n'est pas utilis√© pour entra√Æner le mod√®le global de Google. Vos donn√©es ne sont jamais partag√©es avec des tiers ni utilis√©es √† des fins commerciales.</li>
                        <li><strong>Qui peut y acc√©der ?</strong> Vous seul(e) pouvez acc√©der √† vos donn√©es via votre compte. Si vous utilisez la fonction de partage, la personne d√©tentrice du lien pourra voir une version "lecture seule" de votre journal.</li>
                    </ul>
                </div>
            </div>
        </div>
    `;

    div.innerHTML = `
        <div class="flex items-center mb-6">
        <button id="guideBackBtn" class="text-cyan-600 hover:text-cyan-800 font-bold mr-4">‚Üê Retour</button>
            <h1 class="text-2xl font-bold">‚ùì Guide d'Utilisation</h1>
        </div>
        ${guideHTML}
    `;

    const backBtn = div.querySelector('#guideBackBtn');
    const backAction = cameFromLogin ? window.showLoginViewFromGuide : () => window.showView('menu');
    backBtn.addEventListener('click', backAction);

    return div;
}
function createStep4View() {
    const config = stepsConfig.step4;
    const div = document.createElement('div');
    div.className = 'fade-in';

    // --- HTML de la nouvelle interface (Cartes + Fen√™tre de simulation cach√©e) ---
    div.innerHTML = `
        <div class="flex items-center mb-6">
            <button onclick="window.showView('menu')" class="text-cyan-600 hover:text-cyan-800 font-bold mr-4">‚Üê Retour</button>
            <h1 class="text-2xl font-bold">${config.icon} ${config.title}</h1>
        </div>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-800"><b>Ta mission :</b> Choisis un domaine, pose une question de base, puis utilise l'IA pour obtenir des questions plus pertinentes et t'entra√Æner avec le simulateur.Enfin clique sur le lien du site pour √©changer avec des √©tudiants.</div>
        </div>
        <div class="mb-8">
             <a href="https://www.inspire-orientation.org" target="_blank" class="inline-block bg-cyan-100 text-cyan-700 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter Inspire-orientation.org ‚Üó</a>
        </div>
        <form id="stepForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col space-y-4">
                    <h2 class="text-lg font-bold text-slate-800">Exploration #1</h2>
                    <div>
                        <label for="theme1" class="block text-sm font-medium text-slate-700 mb-1">Formation ou domaine</label>
                        <input type="text" id="theme1" name="theme1" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: √âcoles d'ing√©nieurs" value="${journalData.step4.theme1 || ''}">
                    </div>
                    <div>
                        <label for="question1" class="block text-sm font-medium text-slate-700 mb-1">Ma question principale</label>
                        <textarea id="question1" name="question1" rows="2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Quelle est la plus grande diff√©rence avec le lyc√©e ?">${journalData.step4.question1 || ''}</textarea>
                    </div>
                    <div class="text-center">
                        <button type="button" id="generate-btn-1" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Obtenir mes questions personnalis√©es</button>
                    </div>
                    <div id="loader-1" class="hidden text-center"><div class="loader"></div></div>
                    <div id="suggestions-container-1" class="pt-2 border-t border-slate-200">
                        </div>
                    <textarea id="suggestions1" name="suggestions1" class="hidden">${journalData.step4.suggestions1 || ''}</textarea>
                    <div class="text-center mt-auto pt-4">
                         <button type="button" id="launch-sim-btn-1" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition hidden">üöÄ Lancer une simulation d'entretien</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col space-y-4">
                    <h2 class="text-lg font-bold text-slate-800">Exploration #2</h2>
                    <div>
                        <label for="theme2" class="block text-sm font-medium text-slate-700 mb-1">Formation ou domaine</label>
                        <input type="text" id="theme2" name="theme2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: √âtudes de sant√© (PASS/LAS)" value="${journalData.step4.theme2 || ''}">
                    </div>
                    <div>
                        <label for="question2" class="block text-sm font-medium text-slate-700 mb-1">Ma question principale</label>
                        <textarea id="question2" name="question2" rows="2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Comment g√©rer la charge de travail ?">${journalData.step4.question2 || ''}</textarea>
                    </div>
                    <div class="text-center">
                        <button type="button" id="generate-btn-2" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Obtenir mes questions personnalis√©es</button>
                    </div>
                    <div id="loader-2" class="hidden text-center"><div class="loader"></div></div>
                    <div id="suggestions-container-2" class="pt-2 border-t border-slate-200">
                         </div>
                     <textarea id="suggestions2" name="suggestions2" class="hidden">${journalData.step4.suggestions2 || ''}</textarea>
                    <div class="text-center mt-auto pt-4">
                         <button type="button" id="launch-sim-btn-2" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition hidden">üöÄ Lancer une simulation d'entretien</button>
                    </div>
                </div>
            </div>
            <button type="submit" class="w-full mt-8 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder l'√©tape</button>
        </form>

        <div id="simulation-modal" class="simulation-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col h-[80vh]">
                <div class="flex items-center justify-between p-4 border-b bg-slate-50 rounded-t-2xl">
                    <h3 class="font-bold text-slate-800">ü§ñ Simulation d'entretien</h3>
                    <button id="simulation-close" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                </div>
                <div id="simulation-messages" class="flex-1 p-4 overflow-y-auto simulation-message-container">
                    </div>
                <form id="simulation-form" class="p-4 border-t flex items-center gap-2">
                    <input type="text" id="simulation-input" placeholder="√âcris ta r√©ponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
                </form>
            </div>
        </div>
    `;

    // --- Logique de la nouvelle interface ---

    const simulationModal = div.querySelector('#simulation-modal');
    const simulationMessages = div.querySelector('#simulation-messages');
    const simulationForm = div.querySelector('#simulation-form');
    const simulationInput = div.querySelector('#simulation-input');
    let currentSimTheme = '';
    let conversationHistory = [];

    // Fonction pour ajouter un message dans le simulateur
    const addSimMessage = (text, sender) => {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = 'flex mb-4';
        let messageContent = '';
        if (sender === 'user') {
            messageWrapper.classList.add('justify-end');
            messageContent = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs"><p>${text}</p></div>`;
        } else if (sender === 'ai') {
            messageContent = `<div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs"><p>${text}</p></div>`;
        } else { // loader
            messageContent = `<div class="bg-cyan-100 p-3 rounded-lg"><div class="chatbot-loader"></div></div>`;
        }
        messageWrapper.innerHTML = messageContent;
        simulationMessages.appendChild(messageWrapper);
        simulationMessages.scrollTop = simulationMessages.scrollHeight;
        return messageWrapper;
    };
    
    // Logique pour une carte d'exploration (factoris√©e pour √©viter la r√©p√©tition)
    // REMPLACEZ VOTRE FONCTION setupCard EXISTANTE PAR CELLE-CI :
    
    // Logique pour une carte d'exploration (factoris√©e pour √©viter la r√©p√©tition)
    const setupCard = (index) => {
        const themeInput = div.querySelector(`#theme${index}`);
        const questionInput = div.querySelector(`#question${index}`);
        const generateBtn = div.querySelector(`#generate-btn-${index}`);
        const loader = div.querySelector(`#loader-${index}`);
        const suggestionsContainer = div.querySelector(`#suggestions-container-${index}`);
        const suggestionsTextarea = div.querySelector(`#suggestions${index}`);
        const launchSimBtn = div.querySelector(`#launch-sim-btn-${index}`);

        // Rendu initial des questions si elles existent d√©j√†
        if (suggestionsTextarea.value) {
            const questions = suggestionsTextarea.value.split('\n').filter(q => q.trim() !== '');
            let questionsHTML = '<h3 class="font-semibold text-slate-700 mb-2">Questions personnalis√©es :</h3><ul class="list-disc list-inside space-y-1 text-slate-600">';
            questions.forEach(q => { questionsHTML += `<li>${q}</li>`; });
            questionsHTML += '</ul>';
            suggestionsContainer.innerHTML = questionsHTML;
            launchSimBtn.classList.remove('hidden');
        }

        // Clic sur "Obtenir mes questions"
        generateBtn.addEventListener('click', async () => {
            const theme = themeInput.value.trim();
            const questionBase = questionInput.value.trim();
            const analyseProfil = journalData.step0.analysis;

            if (!theme || !questionBase || !analyseProfil) {
                alert("Veuillez renseigner le domaine, votre question et avoir compl√©t√© l'√©tape 'Mieux se conna√Ætre' pour obtenir des suggestions personnalis√©es.");
                return;
            }

            loader.classList.remove('hidden');
            suggestionsContainer.innerHTML = '';
            launchSimBtn.classList.add('hidden');

            const prompt = `Agis comme un coach d'orientation tr√®s perspicace. Voici le profil psychologique d'un lyc√©en que j'ai analys√© :
            "${analyseProfil}"
            Ce lyc√©en s'int√©resse au domaine suivant : "${theme}".
            Il a d√©j√† une question de base en t√™te : "${questionBase}"
            Ta mission est de lui sugg√©rer 3 questions strat√©giques et personnalis√©es qu'il pourrait poser √† un √©tudiant. Ces questions doivent l'aider √† valider si ce domaine correspond VRAIMENT √† sa personnalit√©.
            Donne uniquement les 3 questions, chacune sur une nouvelle ligne, sans num√©rotation ni introduction.`;

            const result = await callGeminiAPI(prompt);
            loader.classList.add('hidden');

            const questions = result.split('\n').filter(q => q.trim() !== '');
            let questionsHTML = '<h3 class="font-semibold text-slate-700 mb-2">Questions personnalis√©es :</h3><ul class="list-disc list-inside space-y-1 text-slate-600">';
            questions.forEach(q => { questionsHTML += `<li>${q}</li>`; });
            questionsHTML += '</ul>';
            suggestionsContainer.innerHTML = questionsHTML;
            suggestionsTextarea.value = result;
            launchSimBtn.classList.remove('hidden');
        });

        // Clic sur "Lancer une simulation"
        launchSimBtn.addEventListener('click', async () => {
            currentSimTheme = themeInput.value.trim();
            if (!currentSimTheme) return;

            simulationMessages.innerHTML = '';
            conversationHistory = [];
            simulationModal.classList.remove('hidden');
            simulationModal.classList.add('flex');
            
            const loaderMsg = addSimMessage('', 'loader');
            
            const startPrompt = `Tu joues le r√¥le d'un √©tudiant "√©claireur" sympathique et bienveillant. Tu √©tudies dans le domaine de : "${currentSimTheme}". Un lyc√©en (l'utilisateur) vient de prendre contact avec toi. Envoie-lui un unique message de bienvenue chaleureux pour d√©marrer la conversation et l'inviter √† poser sa premi√®re question.`;

            const firstMessage = await callGeminiAPI(startPrompt);
            loaderMsg.remove();
            addSimMessage(firstMessage, 'ai');
            conversationHistory.push({ role: 'model', parts: [{ text: firstMessage }] });
        });
    };

    // Initialisation des deux cartes
    setupCard(1);
    setupCard(2);

    // Logique de la fen√™tre de simulation
    div.querySelector('#simulation-close').addEventListener('click', () => {
        simulationModal.classList.add('hidden');
        simulationModal.classList.remove('flex');
    });

    simulationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = simulationInput.value.trim();
        if (!userInput) return;

        addSimMessage(userInput, 'user');
        simulationInput.value = '';
        conversationHistory.push({ role: 'user', parts: [{ text: userInput }] });

        const loaderMsg = addSimMessage('', 'loader');
        
        const conversationPrompt = `Tu es un √©tudiant √©claireur bienveillant qui √©tudie en "${currentSimTheme}". Continue la conversation de mani√®re naturelle en te basant sur l'historique. R√©ponds √† la derni√®re question de l'utilisateur.
        
        HISTORIQUE : ${JSON.stringify(conversationHistory)}`;
        
        // Note: Gemini g√®re mieux l'historique directement dans le payload,
        // mais pour la simplicit√© de l'exemple, on le passe dans le prompt.
        // Une version avanc√©e enverrait l'historique complet dans `contents`.

        const aiResponse = await callGeminiAPI(conversationPrompt);
        loaderMsg.remove();
        addSimMessage(aiResponse, 'ai');
        conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
    });

    // Logique du formulaire principal pour sauvegarder
    div.querySelector('#stepForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const stepKey = config.stepKey;
        if (!journalData[stepKey]) journalData[stepKey] = {};

        for (const [key, newValue] of formData.entries()) {
            journalData[stepKey][key] = newValue;
        }

        await saveData();
        showView('menu');
    });

    return div;
}

        function createStep5View() {
            const config = stepsConfig.step5;
            const div = createStepView(config);
            const form = div.querySelector('#stepForm');
            const submitButton = form.querySelector('button[type="submit"]');

            const analysisHTML = `
                <hr class="my-8">
                <h2 class="text-xl font-semibold mb-4 text-slate-800">üí° Analyse personnalis√©e de tes r√©sultats</h2>
                <p class="text-slate-600 mb-4">Un r√©sultat de test est une chose, mais que signifie-t-il VRAIMENT pour toi ? L'IA peut t'aider √† y voir plus clair en le reliant √† ton profil.</p>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_test" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser mes r√©sultats</button>
                </div>
                <div id="geminiLoader_test" class="hidden"><div class="loader"></div></div>
            `;
            const resultatField = form.querySelector('textarea[name="resultat1"]');
            resultatField.parentElement.insertAdjacentHTML('afterend', analysisHTML);


            div.querySelector('#geminiBtn_test').addEventListener('click', async () => {
                const loader = div.querySelector('#geminiLoader_test');
                const testResult = div.querySelector('#resultat1').value;
                const existingAnalysis = div.querySelector('#analyse_test');
                if(existingAnalysis) existingAnalysis.parentElement.remove();


                if (!journalData.step0.analysis) {
                    alert("Pour obtenir une analyse personnalis√©e, veuillez d'abord compl√©ter l'√âtape: Mieux se conna√Ætre.");
                    return;
                }

                if (!testResult.trim()) {
                    alert("Veuillez renseigner le r√©sultat du test que vous avez effectu√©.");
                    return;
                }

                loader.style.display = 'block';

                const prompt = `Agis comme un conseiller d'orientation avis√©. Voici l'analyse du profil personnel d'un lyc√©en : "${journalData.step0.analysis}". 
                Ce m√™me lyc√©en vient de passer un test d'orientation et a obtenu le r√©sultat suivant : "${testResult}".

                Ta mission est de :
                1. Expliquer bri√®vement et simplement ce que signifie le r√©sultat du test (ex: "Un profil 'Social' signifie que...").
                2. Mettre en lumi√®re les coh√©rences (ou les apparentes contradictions) entre le r√©sultat du test et le profil personnel de l'√©l√®ve.
                3. Proposer une piste de r√©flexion : "Ce r√©sultat confirme ton int√©r√™t pour... Tu pourrais donc explorer les m√©tiers de..." ou "C'est int√©ressant, car cela montre une facette de toi que tu n'avais pas mentionn√©e...".
                Le ton doit √™tre constructif et aider l'√©l√®ve √† faire des liens.`;

                const result = await callGeminiAPI(prompt);
                loader.style.display = 'none';

                const analysisResultHTML = `
                    <div class="mb-6">
                        <label for="analyse_test" class="block text-md font-medium text-slate-700 mb-2">Analyse personnalis√©e par l'IA</label>
                        <textarea id="analyse_test" name="analyse_test" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${result}</textarea>
                    </div>
                `;
                loader.insertAdjacentHTML('afterend', analysisResultHTML);
            });

            return div;
        }
        
        function createStep6View() {
            const config = stepsConfig.step6;
            const div = createStepView(config);
            const form = div.querySelector('#stepForm');
            
            form.innerHTML = `
                <div class="mb-6">
                    <label for="formation" class="block text-md font-medium text-slate-700 mb-2">${config.fields[0].label}</label>
                    <input type="text" id="formation" name="formation" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[0].placeholder}" value="${journalData.step6.formation || ''}">
                </div>
                 <div class="mb-6">
                    <label for="motivations" class="block text-md font-medium text-slate-700 mb-2">${config.fields[1].label}</label>
                    <textarea id="motivations" name="motivations" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[1].placeholder}">${journalData.step6.motivations || ''}</textarea>
                </div>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_structure" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® G√©n√©rer une structure de lettre</button>
                </div>
                <div id="geminiLoader_structure" class="hidden"><div class="loader"></div></div>
                 <div class="mb-6">
                    <label for="structure" class="block text-md font-medium text-slate-700 mb-2">${config.fields[2].label}</label>
                    <textarea id="structure" name="structure" rows="10" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step6.structure || ''}</textarea>
                </div>
                <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
            `;

            div.querySelector('#geminiBtn_structure').addEventListener('click', async () => {
                const formation = div.querySelector('#formation').value;
                const motivations = div.querySelector('#motivations').value;
                const loader = div.querySelector('#geminiLoader_structure');
                const resultDiv = div.querySelector('#structure');
                
                if (!formation.trim() || !motivations.trim()) {
                    resultDiv.value = "Veuillez renseigner la formation et vos motivations.";
                    return;
                }
                
                resultDiv.value = '';
                loader.style.display = 'block';
                const prompt = `Agis en tant que conseiller d'orientation expert de Parcoursup. Un lyc√©en vise la formation "${formation}" et a list√© ces motivations/comp√©tences : "${motivations}". Propose un plan structur√© et d√©taill√© (en 3 ou 4 paragraphes) pour son projet de formation motiv√©. Pour chaque paragraphe, explique ce qu'il doit y mettre et comment il peut lier ses comp√©tences √† la formation. Ne r√©dige pas la lettre, donne uniquement le plan avec des conseils.`;
                const result = await callGeminiAPI(prompt);
                loader.style.display = 'none';
                resultDiv.value = result;
            });

            return div;
        }

        function createStep7View() {
            const config = stepsConfig.step7;
            const div = createStepView(config);
            const form = div.querySelector('#stepForm');
            let quizData = [];
            let currentQuestionIndex = 0;
            let score = 0;

            const renderInitialView = () => {
                form.innerHTML = `
                    <div class="mb-6">
                        <label for="domaine" class="block text-md font-medium text-slate-700 mb-2">Sur quel domaine ou m√©tier souhaites-tu tester tes connaissances ?</label>
                        <input type="text" id="domaine" name="domaine" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Les √©tudes de m√©decine, le m√©tier d'ing√©nieur..." value="${journalData.step7.domaine || ''}">
                    </div>
                    <div class="text-center">
                        <button type="button" id="generateQuizBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Lancer le Quiz</button>
                    </div>
                    <div id="quizContainer" class="mt-6"></div>
                    <div id="quizLoader" class="hidden"><div class="loader"></div></div>
                `;
                form.querySelector('#generateQuizBtn').addEventListener('click', generateQuiz);
            };
            
            const generateQuiz = async () => {
                const domain = form.querySelector('#domaine').value;
                if (!domain.trim()) {
                    alert("Veuillez entrer un domaine.");
                    return;
                }
                
                journalData.step7.domaine = domain;
                const loader = form.querySelector('#quizLoader');
                loader.style.display = 'block';
                form.querySelector('#quizContainer').innerHTML = '';

                const prompt = `G√©n√®re un quiz de 5 questions "vrai ou faux" sur le domaine suivant : "${domain}". Les affirmations doivent porter sur des mythes ou des id√©es re√ßues courants. Ta r√©ponse DOIT √™tre UNIQUEMENT un tableau JSON valide, sans aucun texte d'introduction ou conclusion. Chaque objet du tableau doit contenir trois cl√©s : "affirmation" (string), "reponse" (boolean), et "explication" (string d√©taill√© et bienveillant de 2-3 phrases).`;
                
                const result = await callGeminiAPI(prompt, false, true);
                
                try {
                    if (result.startsWith("Impossible")) {
                        throw new Error(result);
                    }
                    quizData = JSON.parse(result);
                    currentQuestionIndex = 0;
                    score = 0;
                    renderQuestion(currentQuestionIndex);
                } catch (error) {
                    console.error("Failed to generate or parse quiz JSON:", error);
                    form.querySelector('#quizContainer').innerHTML = `<p class="text-red-500 text-center">D√©sol√©, une erreur est survenue lors de la cr√©ation du quiz. L'IA n'a pas pu g√©n√©rer un format correct. Veuillez r√©essayer avec un domaine diff√©rent.</p>`;
                } finally {
                     loader.style.display = 'none';
                }
            };

            const renderQuestion = (index) => {
                const quizContainer = form.querySelector('#quizContainer');
                const question = quizData[index];
                quizContainer.innerHTML = `
                    <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <p class="text-center font-semibold text-slate-800 text-lg mb-4">Question ${index + 1} / ${quizData.length}</p>
                        <p class="text-center text-slate-600 mb-6">"${question.affirmation}"</p>
                        <div class="flex justify-center gap-4">
                            <button type="button" id="vraiBtn" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Vrai</button>
                            <button type="button" id="fauxBtn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">Faux</button>
                        </div>
                        <div id="explanationContainer" class="mt-6"></div>
                    </div>
                `;
                quizContainer.querySelector('#vraiBtn').addEventListener('click', () => checkAnswer(true, index));
                quizContainer.querySelector('#fauxBtn').addEventListener('click', () => checkAnswer(false, index));
            };

            const checkAnswer = (userAnswer, index) => {
                const question = quizData[index];
                const isCorrect = userAnswer === question.reponse;
                if (isCorrect) score++;

                const explanationContainer = form.querySelector('#explanationContainer');
                const feedbackColor = isCorrect ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
                const feedbackText = isCorrect ? 'Bonne r√©ponse !' : 'Mauvaise r√©ponse !';

                explanationContainer.innerHTML = `
                    <div class="p-4 rounded-lg border-l-4 ${feedbackColor}">
                        <h4 class="font-bold text-slate-800">${feedbackText}</h4>
                        <p class="text-slate-700 mt-2">${question.explication}</p>
                    </div>
                    <div class="text-center mt-4">
                        <button type="button" id="nextQuestionBtn" class="bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-cyan-700 transition">
                            ${(index + 1 === quizData.length) ? 'Voir mon score' : 'Question suivante'}
                        </button>
                    </div>
                `;
                explanationContainer.querySelector('#nextQuestionBtn').addEventListener('click', () => {
                    currentQuestionIndex++;
                    if (currentQuestionIndex < quizData.length) {
                        renderQuestion(currentQuestionIndex);
                    } else {
                        renderFinalScore();
                    }
                });
                form.querySelector('#vraiBtn').disabled = true;
                form.querySelector('#fauxBtn').disabled = true;
            };

            const renderFinalScore = () => {
                 const quizContainer = form.querySelector('#quizContainer');
                 quizContainer.innerHTML = `
                    <div class="text-center bg-slate-50 p-6 rounded-lg border border-slate-200">
                        <h3 class="text-xl font-bold text-slate-800">Quiz termin√© !</h3>
                        <p class="text-3xl font-bold text-cyan-600 my-4">${score} / ${quizData.length}</p>
                        <p class="text-slate-600 mb-6">Tu as d√©construit quelques mythes ! Note ici ce que tu as appris d'important.</p>
                         <textarea id="reflexions" name="reflexions" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ce qui m'a surpris, ce que je retiens...">${journalData.step7.reflexions || ''}</textarea>
                    </div>
                 `;
            };

            renderInitialView();
            return div;
        }
        

function createStep8View() {
    const config = stepsConfig.step8;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    
    form.innerHTML = `
        <h2 class="text-xl font-semibold mb-4 text-slate-800">1. Activer son r√©seau personnel (la premi√®re √©tape !)</h2>
        <p class="text-slate-600 mb-4">Le contact le plus facile √† obtenir est souvent le plus proche. Pense √† ta famille, aux parents de tes amis, √† tes voisins... C'est le moyen le plus simple d'avoir une discussion franche et bienveillante.</p>
        <div class="mb-6">
            <label for="pro_reseau_personnel" class="block text-md font-medium text-slate-700 mb-2">${config.fields[0].label}</label>
            <textarea id="pro_reseau_personnel" name="pro_reseau_personnel" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[0].placeholder}">${journalData.step8.pro_reseau_personnel || ''}</textarea>
        </div>

        <hr class="my-8">

        <h2 class="text-xl font-semibold mb-4 text-slate-800">2. Trouver des contacts externes (si besoin)</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mb-6">
            <label for="pro_metier" class="block text-md font-medium text-slate-700">${config.fields[1].label}</label>
            <label for="pro_departement" class="block text-md font-medium text-slate-700">${config.fields[2].label}</label>
            
            <input type="text" id="pro_metier" name="pro_metier" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[1].placeholder}" value="${journalData.step8.pro_metier || ''}">
            <input type="text" id="pro_departement" name="pro_departement" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[2].placeholder}" value="${journalData.step8.pro_departement || ''}">
        </div>
        <div class="text-center mb-4">
            <button type="button" id="geminiBtn_find_pro" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">üí° Trouver des contacts avec l'IA</button>
        </div>
        <div id="geminiLoader_pro_find" class="hidden"><div class="loader"></div></div>
        <div class="mb-6">
            <label for="pro_contacts" class="block text-md font-medium text-slate-700 mb-2">${config.fields[3].label}</label>
            <textarea id="pro_contacts" name="pro_contacts" rows="6" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step8.pro_contacts || ''}</textarea>
        </div>

        <hr class="my-8">
        
        <h2 class="text-xl font-semibold mb-4 text-slate-800">3. Pr√©parer la prise de contact</h2>
        <p class="text-slate-600 mb-4">Que ce soit un contact personnel ou externe, une bonne pr√©paration est essentielle. Utilise l'outil ci-dessous pour obtenir un mod√®le de mail efficace et des conseils pour ton entretien.</p>
        <div class="text-center mb-4">
            <button type="button" id="geminiBtn_contact_pro" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">‚úâÔ∏è G√©n√©rer une strat√©gie de contact</button>
        </div>
        <div id="geminiLoader_pro_contact" class="hidden"><div class="loader"></div></div>
        <div class="mb-6">
            <label for="pro_strategie" class="block text-md font-medium text-slate-700 mb-2">${config.fields[4].label}</label>
            <textarea id="pro_strategie" name="pro_strategie" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step8.pro_strategie || ''}</textarea>
        </div>

        <hr class="my-8">

        <h2 class="text-xl font-semibold mb-4 text-slate-800">4. Pr√©parer une Journ√©e Portes Ouvertes (JPO)</h2>
        <div class="mb-6">
            <label for="jpo_ecole" class="block text-md font-medium text-slate-700 mb-2">${config.fields[5].label}</label>
            <input type="text" id="jpo_ecole" name="jpo_ecole" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[5].placeholder}" value="${journalData.step8.jpo_ecole || ''}">
        </div>
        <div class="text-center mb-4">
            <button type="button" id="geminiBtn_jpo" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">üí° G√©n√©rer des questions pour la JPO</button>
        </div>
        <div id="geminiLoader_jpo" class="hidden"><div class="loader"></div></div>
        <div class="mb-6">
            <label for="jpo_questions" class="block text-md font-medium text-slate-700 mb-2">${config.fields[6].label}</label>
            <textarea id="jpo_questions" name="jpo_questions" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step8.jpo_questions || ''}</textarea>
        </div>

        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;

    div.querySelector('#geminiBtn_find_pro').addEventListener('click', async () => {
        const metier = div.querySelector('#pro_metier').value;
        const departement = div.querySelector('#pro_departement').value;
        const loader = div.querySelector('#geminiLoader_pro_find');
        const resultDiv = div.querySelector('#pro_contacts');

        if (!metier.trim() || !departement.trim()) { 
            resultDiv.value = "Veuillez renseigner un m√©tier ET un d√©partement."; 
            return; 
        }
        loader.style.display = 'block'; resultDiv.value = '';
        
        const prompt = `Agis comme un conseiller d'orientation tr√®s efficace. Un(e) lyc√©en(ne) cherche √† contacter des professionnels. En utilisant la recherche web, trouve 2 √† 3 contacts concrets pour le m√©tier de "${metier}" dans le d√©partement "${departement}". Pour chaque contact, fournis le nom de la structure ou du professionnel, l'adresse, et si possible un num√©ro de t√©l√©phone ou un email. Varie les types de contacts (entreprise, association, professionnel ind√©pendant...).`;
        const result = await callGeminiAPI(prompt, true);
        loader.style.display = 'none'; 
        resultDiv.value = result;
    });

    div.querySelector('#geminiBtn_contact_pro').addEventListener('click', async () => {
        const metier = div.querySelector('#pro_metier').value;
        const loader = div.querySelector('#geminiLoader_pro_contact');
        const resultDiv = div.querySelector('#pro_strategie');
        if (!metier.trim()) { resultDiv.value = "Veuillez indiquer un m√©tier dans le champ 'm√©tier' ci-dessus pour g√©n√©rer une strat√©gie de contact."; return; }
        loader.style.display = 'block'; resultDiv.value = '';
        const prompt = `Un(e) lyc√©en(ne) souhaite contacter un professionnel exer√ßant le m√©tier de "${metier}". Propose une strat√©gie en 2 points : 1. Comment trouver un contact (ex: LinkedIn, r√©seau familial...). 2. Un mod√®le de mail court, poli et efficace qu'il/elle peut adapter pour demander un bref √©change de 15 minutes.`;
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none'; resultDiv.value = result;
    });

    div.querySelector('#geminiBtn_jpo').addEventListener('click', async () => {
        const ecole = div.querySelector('#jpo_ecole').value;
        const loader = div.querySelector('#geminiLoader_jpo');
        const resultDiv = div.querySelector('#jpo_questions');
        if (!ecole.trim()) { resultDiv.value = "Veuillez entrer une √©cole ou une formation."; return; }
        loader.style.display = 'block'; resultDiv.value = '';
        const prompt = `Un(e) lyc√©en(ne) pr√©pare sa visite √† la journ√©e portes ouvertes de "${ecole}". Sugg√®re une liste de 5 questions intelligentes √† poser (aux √©tudiants et aux professeurs) pour obtenir des informations qu'on ne trouve pas sur le site web. Les questions doivent porter sur la vie √©tudiante, les projets concrets, les d√©bouch√©s r√©els, etc.`;
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none'; resultDiv.value = result;
    });
    
    return div;
}
        function createStep9View() {
            const config = stepsConfig.step9;
            const div = createStepView(config);
            const form = div.querySelector('#stepForm');
            
            form.innerHTML = `
                <h2 class="text-xl font-semibold mb-4 text-slate-800">1. Mon Plan B</h2>
                <div class="mb-6">
                    <label for="formation_reve" class="block text-md font-medium text-slate-700 mb-2">${config.fields[0].label}</label>
                    <input type="text" id="formation_reve" name="formation_reve" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[0].placeholder}" value="${journalData.step9.formation_reve || ''}">
                </div>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_planb" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® G√©n√©rer mon Plan B</button>
                </div>
                <div id="geminiLoader_planb" class="hidden"><div class="loader"></div></div>
                <div class="mb-6">
                    <label for="plan_b" class="block text-md font-medium text-slate-700 mb-2">${config.fields[1].label}</label>
                    <textarea id="plan_b" name="plan_b" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step9.plan_b || ''}</textarea>
                </div>

                <hr class="my-8">

                <h2 class="text-xl font-semibold mb-4 text-slate-800">2. Mon Coach de R√©ussite</h2>
                <div class="mb-6">
                    <label for="reussite_type" class="block text-md font-medium text-slate-700 mb-2">${config.fields[2].label}</label>
                    <input type="text" id="reussite_type" name="reussite_type" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[2].placeholder}" value="${journalData.step9.reussite_type || ''}">
                </div>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_reussite" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Me coacher pour la 1√®re ann√©e</button>
                </div>
                <div id="geminiLoader_reussite" class="hidden"><div class="loader"></div></div>
                <div class="mb-6">
                    <label for="reussite_conseils" class="block text-md font-medium text-slate-700 mb-2">${config.fields[3].label}</label>
                    <textarea id="reussite_conseils" name="reussite_conseils" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step9.reussite_conseils || ''}</textarea>
                </div>

                <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
            `;

            div.querySelector('#geminiBtn_planb').addEventListener('click', async () => {
                const formation = div.querySelector('#formation_reve').value;
                const loader = div.querySelector('#geminiLoader_planb');
                const resultDiv = div.querySelector('#plan_b');
                if (!formation.trim()) { resultDiv.value = "Veuillez entrer une formation."; return; }
                loader.style.display = 'block'; resultDiv.value = '';
                const prompt = `Un √©l√®ve de Terminale vise la formation "${formation}". Propose-lui 3 "Plans B" pertinents et concrets s'il n'obtient pas ce v≈ìu : 1. Une formation similaire mais moins s√©lective. 2. Une voie plus courte et professionnalisante dans le m√™me domaine. 3. Une piste "Joker" dans un domaine connexe.`;
                const result = await callGeminiAPI(prompt);
                loader.style.display = 'none'; resultDiv.value = result;
            });

            div.querySelector('#geminiBtn_reussite').addEventListener('click', async () => {
                const type = div.querySelector('#reussite_type').value;
                const loader = div.querySelector('#geminiLoader_reussite');
                const resultDiv = div.querySelector('#reussite_conseils');
                if (!type.trim()) { resultDiv.value = "Veuillez entrer un type de formation."; return; }
                loader.style.display = 'block'; resultDiv.value = '';
                const prompt = `Donne 3 conseils m√©thodologiques et concrets pour un √©l√®ve qui va entrer en "${type}" en France, pour l'aider √† r√©ussir sa premi√®re ann√©e.`;
                const result = await callGeminiAPI(prompt);
                loader.style.display = 'none'; resultDiv.value = result;
            });
            
            return div;
        }

function createStep10View() {
    const config = stepsConfig.step10;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    
    // NOUVELLE STRUCTURE DE DONN√âES : un objet pour s√©parer exp√©riences et profil
    if (!journalData.step10 || !Array.isArray(journalData.step10.experiences)) {
        const experiences = Array.isArray(journalData.step10) ? journalData.step10 : [];
        journalData.step10 = {
            experiences: experiences,
            soft_skills_profile: ''
        };
    }

    let currentExperience = null;
    
    // Structure HTML principale avec les deux modules
    form.innerHTML = `
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Mes Exp√©riences Significatives</h2>
            <div id="experience-list-container" class="space-y-4 mb-6"></div>
            <button type="button" id="add-experience-btn" class="w-full bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">
                + Ajouter une exp√©rience
            </button>
        </div>

        <hr class="my-12 border-slate-300">

        <div>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Mon Profil de Comp√©tences</h2>
            <div id="detector-container" class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <p class="text-slate-600 mb-4">R√©ponds √† quelques questions rapides pour r√©v√©ler tes comp√©tences transversales dominantes.</p>
                <button type="button" id="start-detector-btn" class="w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">
                    üß† Lancer le d√©tecteur
                </button>
                <div id="quiz-container" class="hidden mt-4"></div>
                <div id="detector-results-container" class="hidden mt-4"></div>
            </div>
        </div>

        <button type="submit" class="w-full mt-8 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder le portfolio</button>

        <div id="portfolio-modal" class="portfolio-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-xl font-bold text-slate-800">Assistant de Portfolio</h2>
                    <button type="button" id="portfolio-modal-close" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div id="wizard-step-1">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">√âtape 1 : D√©cris ton exp√©rience</h3><p class="text-slate-600 mb-4">Raconte un projet, un job, un engagement, une passion...</p><textarea id="experience-input" rows="6" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: J'ai organis√© un tournoi de jeux vid√©o..."></textarea><button type="button" id="wizard-next-1" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valider et identifier les comp√©tences ‚ú®</button>
                    </div>
                    <div id="wizard-step-2" class="hidden">
                         <h3 class="text-lg font-bold text-slate-800 mb-2">√âtape 2 : Valide tes comp√©tences</h3><p class="text-slate-600 mb-4">Clique sur les comp√©tences qui te semblent les plus justes.</p><div id="skill-tags-container" class="flex flex-wrap gap-3 p-4 bg-slate-50 rounded-lg border min-h-[100px]"></div><div id="loader-2" class="hidden"><div class="loader"></div></div><button type="button" id="wizard-next-2" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valoriser ces comp√©tences üöÄ</button>
                    </div>
                    <div id="wizard-step-3" class="hidden">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">√âtape 3 : Voici ton texte valoris√© !</h3><p class="text-slate-600 mb-4">Utilise ce paragraphe dans tes lettres de motivation ou sur ton CV.</p><div id="loader-3" class="hidden"><div class="loader"></div></div><div id="portfolio-result" class="p-4 bg-slate-50 rounded-lg border whitespace-pre-wrap min-h-[150px]"></div><div class="flex gap-4"><button type="button" id="save-experience-btn" class="w-full mt-4 bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Enregistrer l'exp√©rience</button></div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // --- LOGIQUE DU D√âTECTEUR DE COMP√âTENCES ---

    const detectorContainer = div.querySelector('#detector-container');
    const startDetectorBtn = div.querySelector('#start-detector-btn');
    const quizContainer = div.querySelector('#quiz-container');
    const resultsContainer = div.querySelector('#detector-results-container');
    let userSoftSkills = [];
    let currentQuestionIndex = 0;

    const quizQuestions = [
        { question: "Face √† un projet complexe, ta premi√®re r√©action est de :", answers: [ { text: "Faire un plan d√©taill√© avec des √©tapes claires.", skill: "Planification" }, { text: "Commencer tout de suite pour voir ce qui marche.", skill: "Initiative" }, { text: "Imaginer plusieurs solutions originales.", skill: "Cr√©ativit√©" } ] },
        { question: "Dans un travail de groupe, tu as tendance √† :", answers: [ { text: "T'assurer que tout le monde s'entend bien.", skill: "Collaboration" }, { text: "Prendre les devants pour organiser les t√¢ches.", skill: "Leadership" }, { text: "Te concentrer sur la partie qui demande le plus de recherche.", skill: "Analyse" } ] },
        { question: "Quand tu ne comprends pas quelque chose, tu :", answers: [ { text: "Cherches la r√©ponse par toi-m√™me jusqu'√† la trouver.", skill: "Autonomie" }, { text: "Demandes de l'aide √† quelqu'un qui sait.", skill: "Communication" }, { text: "Essaies de voir le probl√®me sous un autre angle.", skill: "Adaptabilit√©" } ] },
        { question: "Un impr√©vu survient dans un projet. Que fais-tu ?", answers: [ { text: "Tu proposes rapidement un plan B.", skill: "Adaptabilit√©" }, { text: "Tu analyses la source du probl√®me pour qu'il ne se r√©p√®te pas.", skill: "Analyse" }, { text: "Tu rassures l'√©quipe et maintiens une bonne ambiance.", skill: "Intelligence √âmotionnelle" } ] },
        { question: "Laquelle de ces phrases te d√©crit le mieux ?", answers: [ { text: "J'aime quand les choses sont bien organis√©es.", skill: "Rigueur" }, { text: "J'aime convaincre les autres de mes id√©es.", skill: "Persuasion" }, { text: "J'aime apprendre de nouvelles choses constamment.", skill: "Curiosit√©" } ] }
    ];

    const displayQuestion = (index) => {
        if (index >= quizQuestions.length) {
            displayDetectorResults();
            return;
        }
        const q = quizQuestions[index];
        quizContainer.innerHTML = `
            <p class="font-semibold text-slate-700 mb-4">${q.question}</p>
            <div class="flex flex-col space-y-2">
                ${q.answers.map((ans, i) => `<button type="button" data-skill="${ans.skill}" class="answer-btn text-left p-3 bg-slate-50 hover:bg-cyan-100 border rounded-lg">${ans.text}</button>`).join('')}
            </div>
        `;
        quizContainer.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                userSoftSkills.push(btn.dataset.skill);
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            });
        });
    };
    
    const displayDetectorResults = async () => {
        quizContainer.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `<div class="loader"></div>`;

        const skillCounts = userSoftSkills.reduce((acc, skill) => {
            acc[skill] = (acc[skill] || 0) + 1;
            return acc;
        }, {});
        const topSkills = Object.entries(skillCounts).sort((a, b) => b[1] - a[1]).map(el => el[0]);

        const prompt = `Un lyc√©en a pass√© un quiz de comp√©tences transversales. Ses comp√©tences les plus marqu√©es sont : ${topSkills.join(', ')}. R√©dige une analyse courte et positive (2-3 phrases) de son profil de comp√©tences, en expliquant ce que cela signifie pour son orientation. Par exemple : "Ton profil sugg√®re que tu es quelqu'un de tr√®s organis√© (Planification, Rigueur) qui aime aussi explorer de nouvelles id√©es (Cr√©ativit√©). Cela t'ouvre des portes vers des m√©tiers qui allient structure et innovation."`;
        
        const result = await callGeminiAPI(prompt);
        journalData.step10.soft_skills_profile = result;

        resultsContainer.innerHTML = `
            <h4 class="font-bold text-slate-800 mb-2">Analyse de ton profil :</h4>
            <div class="p-4 bg-slate-50 rounded-lg border whitespace-pre-wrap">${result}</div>
        `;
    };

    startDetectorBtn.addEventListener('click', () => {
        startDetectorBtn.classList.add('hidden');
        quizContainer.classList.remove('hidden');
        userSoftSkills = [];
        currentQuestionIndex = 0;
        displayQuestion(currentQuestionIndex);
    });

    if (journalData.step10.soft_skills_profile) {
        startDetectorBtn.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `
            <h4 class="font-bold text-slate-800 mb-2">Analyse de ton profil :</h4>
            <div class="p-4 bg-slate-50 rounded-lg border whitespace-pre-wrap">${journalData.step10.soft_skills_profile}</div>
        `;
    }

    // --- LOGIQUE DU GESTIONNAIRE D'EXP√âRIENCES (dans le modal) ---
    // (Cette partie est identique √† la version pr√©c√©dente, mais lit et √©crit dans `journalData.step10.experiences`)

    const modal = div.querySelector('#portfolio-modal');
    const experienceListContainer = div.querySelector('#experience-list-container');

    const renderExperienceCards = () => {
        experienceListContainer.innerHTML = '';
        if (journalData.step10.experiences.length === 0) {
            experienceListContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-slate-50 rounded-lg">Ton portfolio est vide. Clique sur "Ajouter une exp√©rience" pour commencer.</p>`;
        } else {
            journalData.step10.experiences.forEach((exp, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-slate-200';
                card.innerHTML = `<h4 class="font-bold text-cyan-700">Exp√©rience #${index + 1}</h4><p class="text-slate-700 whitespace-pre-wrap mt-2">${exp.analysis}</p><div class="text-right mt-2"><button type="button" data-index="${index}" class="delete-exp-btn text-red-500 hover:text-red-700 text-sm font-semibold">Supprimer</button></div>`;
                experienceListContainer.appendChild(card);
            });
        }
        div.querySelectorAll('.delete-exp-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index, 10);
                if (confirm("Es-tu s√ªr de vouloir supprimer cette exp√©rience ?")) {
                    journalData.step10.experiences.splice(index, 1);
                    renderExperienceCards();
                }
            });
        });
    };
    
    div.querySelector('#add-experience-btn').addEventListener('click', () => {
        currentExperience = { description: '', analysis: '' };
        div.querySelector('#experience-input').value = '';
        showStep(1);
        modal.classList.remove('hidden');
    });
    div.querySelector('#portfolio-modal-close').addEventListener('click', () => modal.classList.add('hidden'));

    const wizardSteps = [div.querySelector('#wizard-step-1'), div.querySelector('#wizard-step-2'), div.querySelector('#wizard-step-3')];
    const showStep = (stepNumber) => {
        wizardSteps.forEach((step, index) => step.classList.toggle('hidden', index + 1 !== stepNumber));
    };

    div.querySelector('#wizard-next-1').addEventListener('click', async () => {
        const description = div.querySelector('#experience-input').value;
        if (description.trim().length < 20) {
            alert("Veuillez d√©crire votre exp√©rience de mani√®re un peu plus d√©taill√©e.");
            return;
        }
        currentExperience.description = description;
        showStep(2);
        div.querySelector('#loader-2').classList.remove('hidden');
        div.querySelector('#skill-tags-container').innerHTML = '';
        const prompt = `Analyse la description de l'exp√©rience suivante fournie par un lyc√©en. Identifie les 5 √† 7 comp√©tences cl√©s (savoir-√™tre ou savoir-faire) les plus importantes qui en ressortent. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un unique tableau de cha√Ænes de caract√®res. Ne fournis aucun texte d'introduction ou de conclusion. Exemple de r√©ponse attendue : ["Gestion de projet", "Communication d'√©quipe", "Cr√©ativit√©", "Autonomie", "R√©solution de probl√®mes"]. Voici l'exp√©rience √† analyser : "${description}"`;
        const result = await callGeminiAPI(prompt, false, true);
        div.querySelector('#loader-2').classList.add('hidden');
        const skillTagsContainer = div.querySelector('#skill-tags-container');
        try {
            const skills = JSON.parse(result);
            skills.forEach(skill => {
                const tag = document.createElement('button');
                tag.type = 'button';
                tag.className = 'bg-white border-cyan-500 border-2 text-cyan-700 font-semibold py-1 px-3 rounded-full cursor-pointer transition hover:bg-cyan-100';
                tag.textContent = skill;
                tag.addEventListener('click', () => tag.classList.toggle('bg-cyan-500') && tag.classList.toggle('text-white'));
                skillTagsContainer.appendChild(tag);
            });
        } catch (e) {
            skillTagsContainer.textContent = "L'IA n'a pas pu extraire de comp√©tences. Veuillez r√©essayer.";
        }
    });

    div.querySelector('#wizard-next-2').addEventListener('click', async () => {
        const selectedSkills = Array.from(div.querySelectorAll('#skill-tags-container .bg-cyan-500')).map(tag => tag.textContent);
        if (selectedSkills.length === 0) {
            alert("Veuillez s√©lectionner au moins une comp√©tence.");
            return;
        }
        showStep(3);
        div.querySelector('#loader-3').classList.remove('hidden');
        div.querySelector('#portfolio-result').textContent = '';
        const prompt = `Agis en tant que coach carri√®re expert aidant un lyc√©en √† valoriser une exp√©rience pour son dossier Parcoursup. En te basant sur la description initiale de l'exp√©rience et sur la liste des comp√©tences cl√©s que l'√©l√®ve a lui-m√™me valid√©es, r√©dige un paragraphe percutant et concis (3-4 phrases). Ce paragraphe doit √™tre structur√© selon la m√©thode STAR (Situation, T√¢che, Action, R√©sultat) et mettre en avant les comp√©tences s√©lectionn√©es. Le ton doit √™tre professionnel et le texte pr√™t √† √™tre copi√© dans une lettre de motivation. **Description de l'exp√©rience :** "${currentExperience.description}" **Comp√©tences cl√©s √† valoriser :** ${JSON.stringify(selectedSkills)}`;
        const result = await callGeminiAPI(prompt);
        div.querySelector('#loader-3').classList.add('hidden');
        div.querySelector('#portfolio-result').textContent = result;
        currentExperience.analysis = result;
    });

    div.querySelector('#save-experience-btn').addEventListener('click', () => {
        if (currentExperience && currentExperience.analysis) {
            journalData.step10.experiences.push(currentExperience);
            renderExperienceCards();
            modal.classList.add('hidden');
        }
    });
    
    renderExperienceCards();

    return div;
}
function createOrientationMapView(data) {
    let mapHTML = '<div class="mb-8"><h2 class="text-xl font-bold text-slate-800 text-center mb-4">üó∫Ô∏è Carte d\'Orientation Personnelle</h2>';
    mapHTML += '<div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">';

    const profileAnalysis = data.step0 ? data.step0.analysis : '';
    if (profileAnalysis) {
        mapHTML += `<div class="lg:col-span-1 bg-cyan-50 p-4 rounded-lg border border-cyan-200">
                        <h3 class="font-bold text-cyan-800 text-center">üë§ Mon Profil</h3>
                        <p class="text-sm text-slate-600 whitespace-pre-wrap mt-2">${profileAnalysis.split('\n')[0]}</p>
                    </div>`;
    } else {
        mapHTML += `<div class="lg:col-span-1 bg-slate-50 p-4 rounded-lg border text-center">
                        <h3 class="font-bold text-slate-500">üë§ Mon Profil</h3>
                        <p class="text-sm text-slate-500 mt-2">Compl√®te l'√©tape "Mieux se conna√Ætre" pour r√©v√©ler ton profil.</p>
                    </div>`;
    }

    mapHTML += '<div class="lg:col-span-2 space-y-4">';
    
    const metiers = [data.step1?.metier1, data.step1?.metier2, data.step1?.metier3].filter(m => m);
    if (metiers.length > 0) {
        mapHTML += `<div class="bg-sky-50 p-3 rounded-lg border border-sky-200">
                        <h4 class="font-semibold text-sky-800">üìö M√©tiers explor√©s</h4>
                        <p class="text-sm text-slate-600">${metiers.join(', ')}</p>
                    </div>`;
    }

    const formations = [data.step3?.formation1, data.step3?.formation2, data.step3?.formation3].filter(f => f);
    if (formations.length > 0) {
        mapHTML += `<div class="bg-lime-50 p-3 rounded-lg border border-lime-200">
                        <h4 class="font-semibold text-lime-800">üéì Formations envisag√©es</h4>
                        <p class="text-sm text-slate-600">${formations.join(', ')}</p>
                    </div>`;
    }

    if (data.step10 && data.step10.experiences && data.step10.experiences.length > 0) {
        mapHTML += `<div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                        <h4 class="font-semibold text-amber-800">üíº Comp√©tences identifi√©es</h4>
                        <p class="text-sm text-slate-600">√Ä travers ${data.step10.experiences.length} exp√©rience(s) valoris√©e(s).</p>
                    </div>`;
    }
    
    mapHTML += '</div></div></div>';
    return mapHTML;
}

function createStep11View() {
    const config = stepsConfig.step11;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    form.innerHTML = `
        <div class="mb-6">
            <label for="location" class="block text-md font-medium text-slate-700 mb-2">${config.fields[0].label}</label>
            <input type="text" id="location" name="location" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${config.fields[0].placeholder}" value="${journalData.step11.location || ''}">
        </div>
        <div class="text-center mb-4">
            <button type="button" id="geminiBtn_local" class="w-full sm:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üåç Lancer la recherche locale</button>
        </div>
        <div id="geminiLoader_local" class="hidden"><div class="loader"></div></div>
        
        <div id="results-container" class="mt-8"></div>

        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;

    const locationInput = div.querySelector('#location');
    const searchBtn = div.querySelector('#geminiBtn_local');
    const loader = div.querySelector('#geminiLoader_local');
    const resultsContainer = div.querySelector('#results-container');

    const renderResults = (data) => {
        let html = '';
        if (data.evenements && Array.isArray(data.evenements) && data.evenements.length > 0) {
            html += '<h2 class="text-2xl font-bold text-slate-800 mb-4">üóìÔ∏è √âv√©nements √† ne pas manquer</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            data.evenements.forEach(event => {
                let eventLink = '';
                if (event.nom) {
                    const searchQuery = `${event.nom} ${event.lieu || ''}`;
                    const eventUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
                    eventLink = `<a href="${eventUrl}" target="_blank" class="text-cyan-600 hover:underline text-sm font-semibold mt-2 inline-block">En savoir plus ‚Üó</a>`;
                }
                html += `<div class="bg-white p-4 rounded-lg shadow border border-slate-200"><h3 class="font-bold text-cyan-700">${event.nom}</h3><p class="text-slate-600 text-sm font-medium">${event.date}</p><p class="text-slate-500 text-sm">${event.lieu}</p>${eventLink}</div>`;
            });
            html += '</div>';
        }
        if (data.structures && Array.isArray(data.structures) && data.structures.length > 0) {
            html += '<h2 class="text-2xl font-bold text-slate-800 mt-8 mb-4">üè¢ Structures pour t\'accompagner</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            // --- CORRECTIF CI-DESSOUS ---
            // Remplacement de "structuresArray" par "data.structures"
            data.structures.forEach(struct => {
                let mapsLink = '';
                if (struct.adresse && struct.nom) {
                    const searchQuery = `${struct.nom}, ${struct.adresse}`;
                    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
                    mapsLink = `<a href="${mapsUrl}" target="_blank" class="text-cyan-600 hover:underline text-sm font-semibold mt-2 inline-block">Voir sur la carte ‚Üó</a>`;
                }
                html += `<div class="bg-white p-4 rounded-lg shadow border border-slate-200"><h3 class="font-bold text-cyan-700">${struct.nom}</h3><p class="text-slate-600 text-sm">${struct.adresse}</p><p class="text-slate-500 text-sm">${struct.telephone || ''}</p>${mapsLink}</div>`;
            });
            html += '</div>';
        }
        resultsContainer.innerHTML = html;
    };

    // Affiche les r√©sultats d√©j√† sauvegard√©s si on revient sur la page
    if (journalData.step11 && (journalData.step11.evenements || journalData.step11.structures)) {
        renderResults(journalData.step11);
    }

    searchBtn.addEventListener('click', async () => {
        const location = locationInput.value.trim();
        if (!location) {
            alert("Veuillez indiquer une ville ou un d√©partement.");
            return;
        }
        loader.style.display = 'block';
        resultsContainer.innerHTML = '';
        
        const prompt = `Agis comme un conseiller d'orientation expert de la r√©gion de l'√©l√®ve. Pour un lyc√©en √† ${location}, trouve les 6 prochains salons/JPO pertinents √† moins de 90km dans les 8 prochains mois, et les 6 structures d'aide les plus proches (CIO, Mission Locale). Tu dois imp√©rativement formater ta r√©ponse en un objet JSON valide, sans aucun texte d'introduction, avec les cl√©s "evenements" (un tableau d'objets: nom, date, lieu) et "structures" (un tableau d'objets: nom, adresse, telephone).`;
        
        const result = await callGeminiAPI(prompt, true, true);
        loader.style.display = 'none';

        try {
            const data = JSON.parse(result);
            // On sauvegarde directement les r√©sultats de l'IA dans le journal
            journalData.step11.evenements = data.evenements || [];
            journalData.step11.structures = data.structures || [];
            renderResults(data); 
        } catch (error) {
            console.error("Erreur d'analyse JSON:", error);
            resultsContainer.innerHTML = `<p class="text-red-500 text-center">D√©sol√©, une erreur est survenue. L'IA n'a pas renvoy√© de format valide.</p><textarea class="w-full h-40 bg-slate-100 p-2 rounded mt-2">${result}</textarea>`;
        }
    });
    
    return div;
}
        
      function createRetroplanningView() {
            const div = document.createElement('div');
            div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';
            
            div.innerHTML = `
                <div class="flex items-center mb-6"><button onclick="window.showView('menu')" class="text-cyan-600 hover:text-cyan-800 font-bold mr-4">‚Üê Retour</button><h1 class="text-2xl font-bold">üóìÔ∏è Mon R√©troplanning</h1></div>
        
        <div class="text-slate-600 mb-4 space-y-2">
            <p>Pour ton orientation, un bon planning est essentiel ! Cet outil part des grandes √©ch√©ances de ton ann√©e et te propose un plan d'action mois par mois pour y arriver sans stress.</p>
        </div>
        
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><p class="font-semibold text-cyan-900"><b>Ta mission :</b> Clique sur le bouton pour que l'IA te cr√©e un r√©troplanning sur-mesure. Coche ensuite les cases au fur et √† mesure de ton avanc√©e !</p></div>
        
        <div class="text-center mb-6">
            <button type="button" id="geminiBtn_retro" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üìÖ G√©n√©rer / Mettre √† jour mon R√©troplanning</button>
        </div>
        <div id="geminiLoader_retro" class="hidden"><div class="loader"></div></div>

        <div id="retroplanning-content">
            </div>

        <form id="retroForm" class="hidden">
            <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Sauvegarder et retourner au menu</button>
        </form>
    `;

            const retroplanningContent = div.querySelector('#retroplanning-content');

            const renderTimeline = () => {
                if (!journalData.retroplanning || !journalData.retroplanning.tasks || journalData.retroplanning.tasks.length === 0) {
                    retroplanningContent.innerHTML = `<p class="text-center text-slate-500">Cliquez sur le bouton ci-dessus pour g√©n√©rer votre planning personnalis√©.</p>`;
                    return;
                }

                let timelineHTML = journalData.retroplanning.tasks.map((monthData, monthIndex) => {
            const tasksHTML = monthData.tasks.map((task, taskIndex) => `
                <li class="flex items-center mb-2">
                    <input type="checkbox" id="task-${monthIndex}-${taskIndex}" data-month-index="${monthIndex}" data-task-index="${taskIndex}" class="h-4 w-4 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500 mr-3" ${task.completed ? 'checked' : ''}>
                    <label for="task-${monthIndex}-${taskIndex}" class="text-slate-700 ${task.completed ? 'line-through text-slate-400' : ''}">${task.text}</label>
                </li>
            `).join('');

                    return `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-cyan-700 border-b pb-2 mb-3">${monthData.month}</h3>
                            <ul class="list-none">
                                ${tasksHTML}
                            </ul>
                        </div>
                    `;
                }).join('');
                
                retroplanningContent.innerHTML = `
                    <div>
                <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Ta Feuille de Route</h2>
                ${timelineHTML}
                <div class="mt-8 bg-slate-50 p-4 rounded-lg">
                    <h3 class="font-bold text-slate-800 mb-2">Le conseil d√©taill√© de ton Coach :</h3>
                    <p class="whitespace-pre-wrap text-slate-600 text-sm">${journalData.retroplanning.rawText || ''}</p>
                </div>
            </div>
        `;
                
                // Add event listeners to checkboxes
                retroplanningContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const monthIndex = e.target.dataset.monthIndex;
                        const taskIndex = e.target.dataset.taskIndex;
                        journalData.retroplanning.tasks[monthIndex].tasks[taskIndex].completed = e.target.checked;
                        saveData(); // Sauvegarde √† chaque changement
                        renderTimeline(); // Re-render pour appliquer le style barr√©
                    });
                });
                
                div.querySelector('#retroForm').classList.remove('hidden');
            };


            div.querySelector('#geminiBtn_retro').addEventListener('click', async () => {
                const loader = div.querySelector('#geminiLoader_retro');
                loader.style.display = 'block';
                retroplanningContent.innerHTML = '';
                
                let prompt = '';
                const date = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

                const commonPromptPart = `
                Ta r√©ponse DOIT √™tre un objet JSON valide. Cet objet doit contenir deux cl√©s :
                1. "conseilDetaille": une cha√Æne de caract√®res contenant ton analyse compl√®te et r√©dig√©e.
                2. "timeline": un tableau d'objets. Chaque objet repr√©sente un mois et doit avoir deux cl√©s :
                   - "month": le nom du mois (ex: "Septembre").
                   - "tasks": un tableau d'objets, o√π chaque objet repr√©sente une t√¢che et a deux cl√©s : "text" (la description de la t√¢che) et "completed" (toujours 'false' initialement).
                `;

                switch(userGradeLevel) {
                    case 'seconde':
                        prompt = `Agis en tant que conseiller d'orientation expert, sp√©cialis√© dans l'accompagnement des lyc√©ens en classe de Seconde g√©n√©rale en France.

Un √©l√®ve de Seconde te demande de lui cr√©er un r√©troplanning d'orientation personnalis√© et actionnable pour son ann√©e scolaire. Nous sommes le 9 septembre 2025.

Ta mission se d√©roule en plusieurs √©tapes :

1.  **Recherche d'informations :** Utilise la recherche web pour trouver le calendrier scolaire fran√ßais typique d'une ann√©e de Seconde. Identifie les moments cl√©s et les √©ch√©ances importantes :
    * Les dates des conseils de classe (fin du 1er et 2√®me trimestre).
    * La p√©riode de saisie des v≈ìux pour les enseignements de sp√©cialit√© de la classe de Premi√®re (g√©n√©ralement autour de mai).
    * La date du stage obligatoire de Seconde en fin d'ann√©e (juin).
    * Les p√©riodes des grands salons d'orientation (Studyrama, l'√âtudiant, etc.).

2.  **Planification mensuelle :** En te basant sur ces informations, cr√©e un planning mois par mois, de septembre 2025 √† juin 2026. Pour chaque mois, propose des actions claires et r√©alistes.

3.  **Int√©gration des √©tapes de l'application :** Pour chaque mois, tu dois recommander √† l'√©l√®ve de r√©aliser une ou plusieurs √©tapes de son application "Mon Explor'Orientation". Il est **imp√©ratif** que tu utilises scrupuleusement les noms exacts des √©tapes list√©es ci-dessous.

    **Liste des √©tapes de l'application √† utiliser :**
    * 'Mieux se conna√Ætre'
    * 'Les Fondations'
    * 'Le simulateur de sp√©cialit√©s'
    * 'Le Catalogue'
    * 'L'Exp√©rience'
    * 'L'Actu & Tests'
    * 'Quiz : Chasse aux Mythes'
    * 'Passer √† l'action'
    * 'Rencontres sur mon Territoire' ${commonPromptPart}`;
                        break;
                    case 'premiere':
                        prompt = ` Agis en tant que conseiller d'orientation expert et coach scolaire rigoureux, sp√©cialis√© dans l'accompagnement des lyc√©ens en classe de Premi√®re g√©n√©rale en France.

Un √©l√®ve de Premi√®re te demande de lui cr√©er un r√©troplanning strat√©gique pour son ann√©e. Nous sommes le 9 septembre 2025. Ta r√©ponse doit √™tre d'une pr√©cision absolue et se baser sur les √©ch√©ances officielles.

Ta mission est la suivante :

1.  **Calendrier Officiel des √âpreuves (non-n√©gociable) :**
    Tu dois construire ton planning autour des dates **fixes et impos√©es** suivantes pour les √©preuves de fin d'ann√©e 2026 :
    * **√âpreuve √©crite de Fran√ßais :** vendredi 12 juin 2026.
    * **√âpreuves orales de Fran√ßais :** entre le lundi 22 juin et le vendredi 3 juillet 2026.
    * **√âpreuve de Math√©matiques (pour tous) :** fin juin 2026. (Utilise la recherche web pour affiner ce jour si une date pr√©cise a √©t√© publi√©e).


2.  **Planification Strat√©gique Mensuelle :**
    √âlabore un planning d√©taill√© de septembre 2025 √† juillet 2026. Chaque mois doit comporter des t√¢ches √©quilibr√©es entre **trois axes majeurs** :
    * **Axe 1 - Int√©gration des connaissances :** Actions pour renforcer les acquis (fran√ßais, maths). Inclure des conseils sur la gestion du temps et les techniques de r√©vision.
    * **Axe 2 - Int√®gre les √©tapes de l'application "Mon Explor'Orientation" que je te demande d'utiliser plus bas.

3.  **Conseils d'Expert (Obligatoire) :**
    Dans la section "conseilDetaille" de ta r√©ponse JSON, tu dois inclure un paragraphe de coaching, suivi de **trois sous-sections de conseils m√©thodologiques distincts et concrets** :
    * **R√©ussir l'√âcrit de Fran√ßais :** Donne 2-3 conseils cl√©s sur la m√©thode (dissertation/commentaire) et la gestion des r√©visions des ≈ìuvres au programme.
    * **Pr√©parer l'Oral de Fran√ßais :** Explique comment construire son descriptif de lecture et comment aborder la pr√©paration de l'explication lin√©aire et de la question de grammaire.
    * **Aborder l'√âpreuve de Math√©matiques :** Donne des conseils sur la mani√®re de r√©viser le programme sp√©cifique de cette √©preuve et l'importance de la pratique r√©guli√®re.
    * Tu dois imp√©rativement √©crire de fa√ßon fluide sans # et sans * dans tes paragraphes.


    **Liste des √©tapes de l'application √† utiliser :**
    * 'Mieux se conna√Ætre'
    * 'Les Fondations'
    * 'Le simulateur de sp√©cialit√©s'
    * 'Le Catalogue'
    * 'L'Exp√©rience'
    * 'L'Actu & Tests'
    * 'Quiz : Chasse aux Mythes'
    * 'Passer √† l'action'
    * 'Mon Portfolio de Comp√©tences'
    * 'Rencontres sur mon Territoire' ${commonPromptPart}`;
                        break;
                    case 'terminale':
                        prompt = `Agis en tant que conseiller d'orientation expert et coach de r√©ussite intransigeant, sp√©cialis√© dans l'accompagnement des lyc√©ens en classe de Terminale en France.

Un √©l√®ve de Terminale te demande de lui cr√©er un r√©troplanning strat√©gique pour son ann√©e. Nous sommes le 9 septembre 2025. Ta r√©ponse doit √™tre d'une pr√©cision absolue et se baser sur le calendrier officiel.

Ta mission est la suivante :

1.  **Calendrier Officiel 2025-2026 (non-n√©gociable) :**
    Tu dois construire ton planning en te basant **exclusivement** sur les √©ch√©ances suivantes.

    **√âpreuves du Baccalaur√©at (dates impos√©es) :**
    * **Philosophie :** lundi 15 juin 2026.
    * **√âpreuves de sp√©cialit√© :** du mardi 16 au jeudi 18 juin 2026.
    * **Grand oral :** du lundi 22 juin au mercredi 1er juillet 2026.

    **Calendrier Parcoursup (√† respecter scrupuleusement) :**
    * **Septembre √† D√©cembre :** Phase d'information.
    * **Fin D√©cembre :** Mise √† jour du catalogue des formations.
    * **Janvier :** D√©but des inscriptions et formulation des v≈ìux.
    * **Mars :** Date limite pour ajouter des v≈ìux.
    * **Avril :** P√©riode pour finaliser les dossiers et confirmer chaque v≈ìu.
    * **Juin :** D√©but de la phase d'admission principale.
    * **Juillet :** Fin de la phase principale.

2.  **Planification Mensuelle D√©taill√©e :**
    √Ä partir de ce calendrier, cr√©e un planning de septembre 2025 √† juillet 2026 avec deux axes clairs pour chaque mois :
    * **Axe 1 - Parcoursup & Orientation :** Actions li√©es au dossier, v≈ìux et admissions. Int√®gre les √©tapes de l'application "Mon Explor'Orientation".
    * **Axe 2 - Pr√©paration au Bac :** R√©visions et pr√©paration sp√©cifique pour chaque grande √©preuve.

3.  **Conseils d'Expert (Obligatoire) :**
    Dans la section "conseilDetaille" de ta r√©ponse JSON, tu dois inclure un paragraphe de coaching, suivi de **trois sous-sections de conseils m√©thodologiques distincts et concrets** :
    * **R√©ussir la Philosophie :** Donne 2-3 conseils cl√©s sur la m√©thode de la dissertation/commentaire et la gestion du temps.
    * **Pr√©parer les √âpreuves de Sp√©cialit√© :** Explique comment organiser ses r√©visions entre les deux mati√®res et l'importance des annales.
    * **Ma√Ætriser le Grand Oral :** Donne des conseils sur le choix du sujet, la structuration de l'expos√© et la gestion du stress.
    * Tu dois imp√©rativement √©crire de fa√ßon fluide sans # et sans * dans tes paragraphes 



**√âtapes cl√©s de l'application √† utiliser :**
* 'Le Catalogue'
* 'Pr√©parer sa candidature'
* 'Anticiper la suite'
* 'Mon Portfolio de Comp√©tences'
* 'Passer √† l'action'
* 'L'Exp√©rience'
* 'Pr√©parer sa candidature'
* 'Anticiper la suite'
* 'simulateur de vie √©tudiante'
 ${commonPromptPart}`;
                        break;
                }

                const result = await callGeminiAPI(prompt, true, true);
                loader.style.display = 'none';

                try {
                    const parsedResult = JSON.parse(result);
                    journalData.retroplanning = {
                        tasks: parsedResult.timeline,
                        rawText: parsedResult.conseilDetaille
                    };
                    await saveData();
                    renderTimeline();
                } catch (e) {
                    console.error("Erreur de parsing du JSON du r√©troplanning:", e);
                    retroplanningContent.innerHTML = `<p class="text-center text-red-500">L'IA n'a pas pu g√©n√©rer un planning au format interactif. Voici la r√©ponse brute :</p><textarea class="w-full h-64 mt-2 bg-slate-100 p-2 rounded">${result}</textarea>`;
                }
            });
            
            div.querySelector('#retroForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveData();
                showView('menu');
            });

            renderTimeline();

            return div;
        }

       async function createJournalView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';
    
    const shareToken = journalData.share_token || null;
    const shareLink = shareToken ? `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${shareToken}` : '';
    const sharePanelHTML = `
        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-8">
            <h2 class="text-xl font-bold text-slate-800 mb-2">ü§ù Espace Partage</h2>
            <p class="text-slate-600 text-sm mb-4">Partage une version "lecture seule" de ton journal avec tes parents ou ton professeur principal pour faciliter la discussion.</p>
            <div id="share-link-container" class="${shareToken ? '' : 'hidden'}">
                <label class="font-semibold text-slate-700">Ton lien de partage unique :</label>
                <div class="flex items-center gap-2 mt-1">
                    <input type="text" id="share-link-input" value="${shareLink}" readonly class="w-full p-2 border border-slate-300 rounded-lg bg-slate-200">
                    <button id="copy-share-link" class="bg-cyan-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-cyan-700">Copier</button>
                </div>
            </div>
            <div class="mt-4">
                <button id="toggle-share-btn" class="text-sm font-semibold ${shareToken ? 'text-red-600 hover:text-red-800' : 'text-green-600 hover:text-green-800'}">
                    ${shareToken ? '‚ùå D√©sactiver le partage' : '‚úÖ Activer le partage'}
                </button>
            </div>
        </div>
    `;

    div.innerHTML = `
        <div class="flex flex-col sm:flex-row items-start justify-between mb-6 gap-4">
            <div class="flex items-center">
                <button onclick="window.showView('menu')" class="text-cyan-600 hover:text-cyan-800 font-bold mr-4 self-start mt-1">‚Üê Retour</button>
                <div>
                    <h1 class="text-2xl font-bold">üìì Mon Journal de Bord</h1>
                    <p class="text-slate-500">Pour ${currentUserInfo.firstName} ${currentUserInfo.lastName}, √©l√®ve de ${userGradeLevel}.</p>
                </div>
            </div>
            <button id="exportPdfBtn" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition">Exporter en PDF</button>
        </div>
        ${sharePanelHTML}
        <div id="orientation-map-wrapper"></div>
        <div id="filRougeContainer" class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-800">‚ú® Mon Fil Rouge</h2>
                <button id="updateFilRougeBtn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition text-sm">Mettre √† jour</button>
            </div>
            <div id="filRougeLoader" class="hidden"><div class="loader"></div></div>
            <p id="filRougeContent" class="text-slate-700 whitespace-pre-wrap">${journalData.fil_rouge || "Cliquez sur 'Mettre √† jour' pour que l'IA analyse votre parcours et cr√©e une synth√®se."}</p>
        </div>
        <div id="badges-wrapper"></div>
        <div id="journalContent" class="mt-8"></div>
    `;

    div.querySelector('#orientation-map-wrapper').innerHTML = createOrientationMapView(journalData);
    div.querySelector('#badges-wrapper').innerHTML = createBadgesDisplay('journal');

    const journalContentDiv = div.querySelector('#journalContent');
    let contentHTML = '';

    if (journalData.step0 && journalData.step0.analysis) {
        contentHTML += createProfileInfographic(journalData.step0).outerHTML;
    }
    
    const stepTitles = {
        step0: 'üë§ Mieux se conna√Ætre (Analyse)',
        step1: 'üìö Les Fondations',
        step2: 'üß≠ Le simulateur de sp√©cialit√©s',
        step3: 'üéì Le Catalogue',
        step5: 'üì∞ L\'Actu & Tests',
        step10: 'üíº Mon Portfolio de Comp√©tences',
        step11: 'üåç Rencontres sur mon Territoire'
    };

    for (const stepKey in stepTitles) {
        const stepData = journalData[stepKey];
        if (!stepData) continue;
        let stepContent = '';
        let hasContent = false;

        if (stepKey === 'step11') {
            if (stepData.location) { hasContent = true; stepContent += `<div class="mb-3"><p class="font-semibold text-slate-700">Lieu de recherche</p><p class="whitespace-pre-wrap text-slate-600 bg-slate-50 p-2 rounded">${stepData.location}</p></div>`; }
            if (stepData.evenements && Array.isArray(stepData.evenements) && stepData.evenements.length > 0) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mt-4 mb-2">√âv√©nements sauvegard√©s :</h4>`; stepData.evenements.forEach(event => { stepContent += `<div class="mb-2 p-3 bg-slate-50 rounded-lg"><p class="font-bold text-cyan-700">${event.nom || ''}</p><p class="text-sm text-slate-600">${event.date || ''} - ${event.lieu || ''}</p></div>`; }); }
            if (stepData.structures && Array.isArray(stepData.structures) && stepData.structures.length > 0) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mt-4 mb-2">Structures sauvegard√©es :</h4>`; stepData.structures.forEach(struct => { stepContent += `<div class="mb-2 p-3 bg-slate-50 rounded-lg"><p class="font-bold text-cyan-700">${struct.nom || ''}</p><p class="text-sm text-slate-600">${struct.adresse || ''}</p></div>`; }); }
        } else if (stepKey === 'step10') {
            if (stepData.experiences && Array.isArray(stepData.experiences) && stepData.experiences.length > 0) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mb-2">Exp√©riences Significatives :</h4>`; stepData.experiences.forEach((exp, index) => { stepContent += `<div class="mb-2 p-3 bg-slate-50 rounded-lg"><p class="font-medium text-slate-800">Exp√©rience #${index + 1}</p><p class="whitespace-pre-wrap text-slate-600">${exp.analysis}</p></div>`; }); }
            if (stepData.soft_skills_profile) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mt-4 mb-2">Profil de Comp√©tences Transversales :</h4>`; stepContent += `<div class="p-3 bg-slate-50 rounded-lg"><p class="whitespace-pre-wrap text-slate-600">${stepData.soft_skills_profile}</p></div>`; }
        } else {
            for (const [key, value] of Object.entries(stepData)) {
                if (value && typeof value === 'string' && value.trim() !== '' && !key.startsWith('q')) {
                    hasContent = true;
                    const config = Object.values(stepsConfig).find(c => c.stepKey === stepKey);
                    let label = key.replace(/([A-Z0-9])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    if (config && config.fields) { const field = config.fields.find(f => f.id === key); if (field) label = field.label; }
                    stepContent += `<div class="mb-3"><p class="font-semibold text-slate-700">${label}</p><p class="whitespace-pre-wrap text-slate-600 bg-slate-50 p-2 rounded">${value}</p></div>`;
                }
            }
        }
        if (hasContent) {
            contentHTML += `<div class="mb-8"><h3 class="text-xl font-bold border-b pb-2 mb-4 text-cyan-700">${stepTitles[stepKey]}</h3>${stepContent}</div>`;
        }
    }

    journalContentDiv.innerHTML = contentHTML || '<p class="text-center text-slate-500">Votre journal est encore vide. Explorez les √©tapes pour le remplir !</p>';

    // --- Logique des boutons ---
    const toggleBtn = div.querySelector('#toggle-share-btn');
    toggleBtn.addEventListener('click', async () => {
        if (journalData.share_token) {
            if (confirm("Es-tu s√ªr de vouloir d√©sactiver le partage ? Le lien ne fonctionnera plus.")) {
                journalData.share_token = null; await saveData(); showView('journal');
            }
        } else {
            journalData.share_token = 'shr_' + Math.random().toString(36).substr(2, 16); await saveData(); showView('journal');
        }
    });

    if (shareToken) {
        div.querySelector('#copy-share-link').addEventListener('click', () => {
            navigator.clipboard.writeText(shareLink).then(() => alert("Lien copi√© !"));
        });
    }

    div.querySelector('#updateFilRougeBtn').addEventListener('click', async () => {
        const loader = div.querySelector('#filRougeLoader');
        const contentP = div.querySelector('#filRougeContent');
        loader.style.display = 'block'; contentP.style.display = 'none';
        const prompt = `En te basant sur l'int√©gralit√© du journal de cet √©l√®ve : ${JSON.stringify(journalData)}, r√©dige une synth√®se de son projet d'orientation en 3 points : 1. Tes Moteurs : Quels sont les grands int√©r√™ts qui ressortent ? 2. Tes Comp√©tences Cl√©s : Quelles sont les aptitudes qui semblent importantes ? 3. Ton Environnement Id√©al : Quel type d'√©tudes semble te correspondre ? Donne un titre √† son projet.`;
        const result = await callGeminiAPI(prompt);
        journalData.fil_rouge = result; await saveData();
        contentP.textContent = result;
        loader.style.display = 'none'; contentP.style.display = 'block';
    });

    div.querySelector('#exportPdfBtn').addEventListener('click', exportPDF);

    return div;
}
async function createPublicShareView(userId, token) {
    const mainApp = document.getElementById('mainApp');
    mainApp.innerHTML = `<div class="loader"></div>`;

    try {
        const userDocRef = doc(db, "users", userId);
        const docSnap = await getDoc(userDocRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            
            if (!data.journal || data.journal.share_token !== token) {
                throw new Error("Lien de partage invalide ou d√©sactiv√©.");
            }

            const publicJournalData = data.journal;
            const userInfo = {
                firstName: data.firstName || 'L\'√©l√®ve',
                lastName: data.lastName || '',
                schoolName: data.schoolName || 'son lyc√©e',
                gradeLevel: data.gradeLevel || 'sa classe'
            };
            
            // On commence √† construire le HTML de la page partag√©e
            let pageHTML = `
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200">
                    <h1 class="text-2xl font-bold text-cyan-700 mb-2">Journal de Bord de ${userInfo.firstName}</h1>
                    <p class="text-slate-500 mb-8">√âl√®ve en ${userInfo.gradeLevel} √† ${userInfo.schoolName}.</p>
                    
                    ${createOrientationMapView(publicJournalData)} 
                    
                    ${publicJournalData.fil_rouge ? `
                        <div class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
                            <h2 class="text-xl font-bold text-cyan-800 mb-4">‚ú® Son Fil Rouge</h2>
                            <p class="text-slate-700 whitespace-pre-wrap">${publicJournalData.fil_rouge}</p>
                        </div>` : ''
                    }
                `;

            // On utilise une astuce pour r√©utiliser createBadgesDisplay avec les bonnes donn√©es
            const tempJournalData = journalData;
            journalData = publicJournalData;
            pageHTML += createBadgesDisplay('journal');
            journalData = tempJournalData; // On restaure les donn√©es de l'utilisateur courant

            // --- Logique compl√®te pour afficher le contenu d√©taill√© du journal ---
            let contentHTML = '';
            if (publicJournalData.step0 && publicJournalData.step0.analysis) {
                contentHTML += createProfileInfographic(publicJournalData.step0).outerHTML;
            }

            const stepTitles = {
                step0: 'üë§ Mieux se conna√Ætre (Analyse)',
                step1: 'üìö Les Fondations',
                step2: 'üß≠ Le simulateur de sp√©cialit√©s',
                step3: 'üéì Le Catalogue',
                step5: 'üì∞ L\'Actu & Tests',
                step10: 'üíº Mon Portfolio de Comp√©tences',
                step11: 'üåç Rencontres sur mon Territoire'
            };
            
            for (const stepKey in stepTitles) {
                const stepData = publicJournalData[stepKey];
                if (!stepData) continue;
                let stepContent = '';
                let hasContent = false;

                if (stepKey === 'step11') {
                    if (stepData.location) { hasContent = true; stepContent += `<div class="mb-3"><p class="font-semibold text-slate-700">Lieu de recherche</p><p class="whitespace-pre-wrap text-slate-600 bg-slate-50 p-2 rounded">${stepData.location}</p></div>`; }
                    if (stepData.evenements && Array.isArray(stepData.evenements) && stepData.evenements.length > 0) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mt-4 mb-2">√âv√©nements sauvegard√©s :</h4>`; stepData.evenements.forEach(event => { stepContent += `<div class="mb-2 p-3 bg-slate-50 rounded-lg"><p class="font-bold text-cyan-700">${event.nom || ''}</p><p class="text-sm text-slate-600">${event.date || ''} - ${event.lieu || ''}</p></div>`; }); }
                    if (stepData.structures && Array.isArray(stepData.structures) && stepData.structures.length > 0) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mt-4 mb-2">Structures sauvegard√©es :</h4>`; stepData.structures.forEach(struct => { stepContent += `<div class="mb-2 p-3 bg-slate-50 rounded-lg"><p class="font-bold text-cyan-700">${struct.nom || ''}</p><p class="text-sm text-slate-600">${struct.adresse || ''}</p></div>`; }); }
                } else if (stepKey === 'step10') {
                    if (stepData.experiences && stepData.experiences.length > 0) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mb-2">Exp√©riences Significatives :</h4>`; stepData.experiences.forEach((exp, index) => { stepContent += `<div class="mb-2 p-3 bg-slate-50 rounded-lg"><p class="font-medium text-slate-800">Exp√©rience #${index + 1}</p><p class="whitespace-pre-wrap text-slate-600">${exp.analysis}</p></div>`; }); }
                    if (stepData.soft_skills_profile) { hasContent = true; stepContent += `<h4 class="font-semibold text-slate-700 mt-4 mb-2">Profil de Comp√©tences Transversales :</h4>`; stepContent += `<div class="p-3 bg-slate-50 rounded-lg"><p class="whitespace-pre-wrap text-slate-600">${stepData.soft_skills_profile}</p></div>`; }
                } else {
                    for (const [key, value] of Object.entries(stepData)) {
                        if (value && typeof value === 'string' && value.trim() !== '' && !key.startsWith('q')) {
                            hasContent = true;
                            const config = Object.values(stepsConfig).find(c => c.stepKey === stepKey);
                            let label = key.replace(/([A-Z0-9])/g, ' $1').replace(/^./, str => str.toUpperCase());
                            if (config && config.fields) { const field = config.fields.find(f => f.id === key); if (field) label = field.label; }
                            stepContent += `<div class="mb-3"><p class="font-semibold text-slate-700">${label}</p><p class="whitespace-pre-wrap text-slate-600 bg-slate-50 p-2 rounded">${value}</p></div>`;
                        }
                    }
                }
                
                if (hasContent) {
                    if (stepKey === 'step0') {
                        contentHTML += `<div class="mb-8"><h3 class="text-xl font-bold border-b pb-2 mb-4 text-cyan-700">${stepTitles[stepKey]}</h3><p class="whitespace-pre-wrap text-slate-600 bg-slate-50 p-3 rounded-lg">${stepData.analysis}</p></div>`;
                    } else {
                        contentHTML += `<div class="mb-8"><h3 class="text-xl font-bold border-b pb-2 mb-4 text-cyan-700">${stepTitles[stepKey]}</h3>${stepContent}</div>`;
                    }
                }
            }
            
            pageHTML += contentHTML;

            // On ajoute le bouton "Pr√©parer une discussion" √† la fin
            pageHTML += `
                <div class="mt-8 border-t pt-6 text-center">
                    <button id="publicShareBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">ü§ù Pr√©parer une discussion</button>
                </div>
                <div id="publicGeminiShareLoader" class="hidden"><div class="loader"></div></div>
                <div id="publicGeminiShareResult" class="mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
            `;
            
            pageHTML += `</div>`; // Fin de la carte principale
            mainApp.innerHTML = pageHTML;

            // On attache l'√©v√©nement au nouveau bouton
            mainApp.querySelector('#publicShareBtn').addEventListener('click', async () => {
                const loader = mainApp.querySelector('#publicGeminiShareLoader');
                const resultDiv = mainApp.querySelector('#publicGeminiShareResult');
                loader.style.display = 'block'; resultDiv.textContent = '';
                const prompt = `Agis en tant que coach d'orientation et m√©diateur familial expert. Analyse le journal de bord de cet √©l√®ve : ${JSON.stringify(publicJournalData)}.
                
                Ta mission est de g√©n√©rer 3 "points de dialogue" pour aider les parents ou professeurs √† avoir une discussion constructive.

                Pour chaque point, tu dois fournir deux √©l√©ments bien distincts :
                1.  **Piste de discussion :** Une question ouverte et bienveillante qui ouvre le dialogue sur un point cl√© du journal (un doute, une force, une contradiction).
                2.  **Action de r√©solution :** Une suggestion d'action simple et concr√®te que l'√©l√®ve pourrait entreprendre pour avancer sur ce point pr√©cis (ex: utiliser une √©tape sp√©cifique de l'application, faire une recherche cibl√©e, contacter quelqu'un).
                
                Utilise un ton encourageant et pr√©sente clairement les deux parties pour chaque point.`;
                                const result = await callGeminiAPI(prompt);
                loader.style.display = 'none';
                resultDiv.textContent = result;
                // Note : On ne sauvegarde pas le r√©sultat, car c'est une page en lecture seule.
            });

        } else {
            throw new Error("Utilisateur non trouv√©.");
        }
    } catch (error) {
        mainApp.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md"><h2 class="text-xl font-bold text-red-600">Erreur</h2><p class="text-slate-600 mt-2">${error.message}</p></div>`;
    }
}
        function getProfileSummaryText(step0Data) {
            if (!step0Data) return "";

            const profiles = [
                { title: 'Source d\'√©nergie', q: 'q20', left: { key: 'seul', label: 'Introverti' }, right: { key: 'amis', label: 'Extraverti' } },
                { title: 'Prise de d√©cision', q: 'q11', left: { key: 'analyse', label: 'Analyse' }, right: { key: 'intuition', label: 'Intuition' } },
                { title: 'Mode de travail', q: 'q1', left: { key: 'seul', label: 'Individuel' }, right: { key: 'equipe', label: 'Collaboratif' } },
                { title: 'Approche', q: 'q3', left: { key: 'logique', label: 'M√©thodique' }, right: { key: 'creatif', label: 'Cr√©atif' } },
                { title: 'Environnement', q: 'q19', left: { key: 'claires', label: 'Cadre clair' }, right: { key: 'generales', label: 'Autonomie' } },
                { title: 'Moteur', q: 'q25', left: { key: 'competence', label: 'Ma√Ætrise' }, right: { key: 'sens', label: 'Qu√™te de sens' } }
            ];
            
            let summary = "Synth√®se du Profil :\n";
            profiles.forEach(p => {
                const answer = step0Data[p.q];
                let trait = "Non d√©fini";
                if (answer === p.left.key) trait = p.left.label;
                if (answer === p.right.key) trait = p.right.label;
                summary += `- ${p.title}: ${trait}\n`;
            });
            return summary;
        }

function createJournalContentHTML(data) {
    let contentHTML = '';
    
    if (data.step0 && data.step0.analysis) {
        const infographicElement = createProfileInfographic(data.step0);
        contentHTML += `<div class="journal-section">
                            <h2>üë§ Mieux se conna√Ætre</h2>
                            ${infographicElement.querySelector('.bg-slate-50').innerHTML}
                            <h3>Analyse de l'IA :</h3>
                            <p>${linkify(data.step0.analysis)}</p>
                         </div>`;
    }

    const stepOrder = ['step1', 'step2', 'step3', 'step5', 'step4', 'step8', 'step11', 'step6', 'step9', 'step12'];
    stepOrder.forEach(stepKey => {
        const stepData = data[stepKey];
        const config = Object.values(stepsConfig).find(s => s.stepKey === stepKey);
        if (!stepData || !config || Object.values(stepData).every(v => !v)) return;

        let stepContent = '';
        config.fields.forEach(field => {
            if (stepData[field.id] && String(stepData[field.id]).trim()) {
                stepContent += `<h3>${field.label}</h3><p>${linkify(String(stepData[field.id]))}</p>`;
            }
        });

        if (stepContent) {
            contentHTML += `<div class="journal-section"><h2>${config.icon} ${config.title}</h2>${stepContent}</div>`;
        }
    });

    return contentHTML;
}


// REMPLACEZ VOTRE FONCTION exportPDF EXISTANTE PAR CETTE VERSION FINALE :

async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
    const FONT_NORMAL = 'Helvetica';

    // --- Constantes et couleurs ---
    const MARGIN = 15;
    const PAGE_WIDTH = doc.internal.pageSize.getWidth();
    const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
    const CONTENT_WIDTH = PAGE_WIDTH - MARGIN * 2;
    let y = MARGIN;

    const COLOR_PRIMARY = '#4f46e5';
    const COLOR_SECONDARY = '#475569';
    const COLOR_TEXT = '#334155';
    
    // --- Fonctions utilitaires ---
    const checkPageBreak = (heightNeeded) => {
        if (y + heightNeeded > PAGE_HEIGHT - MARGIN) {
            doc.addPage();
            y = MARGIN;
        }
    };

    const addSectionTitle = (title) => {
        checkPageBreak(20);
        doc.setFontSize(16);
        doc.setFont(FONT_NORMAL, 'bold');
        doc.setTextColor(COLOR_PRIMARY);
        doc.text(title, MARGIN, y);
        y += 6;
        doc.setDrawColor('#cbd5e1');
        doc.line(MARGIN, y, PAGE_WIDTH - MARGIN, y);
        y += 10;
    };

    const addBodyText = (text, options = {}) => {
        const { indent = 0 } = options;
        doc.setFontSize(11);
        doc.setFont(FONT_NORMAL, 'normal');
        doc.setTextColor(COLOR_TEXT);
        const textLines = doc.splitTextToSize(String(text), CONTENT_WIDTH - indent);
        checkPageBreak(textLines.length * 5);
        doc.text(textLines, MARGIN + indent, y);
        y += textLines.length * 5 + 4;
    };

    const addSubHeader = (text) => {
        checkPageBreak(8);
        doc.setFontSize(12);
        doc.setFont(FONT_NORMAL, 'bold');
        doc.setTextColor(COLOR_SECONDARY);
        doc.text(text, MARGIN, y);
        y += 7;
    };

    // --- 1. PAGE DE GARDE ---
    doc.setFontSize(24);
    doc.setFont(FONT_NORMAL, 'bold');
    doc.setTextColor(COLOR_PRIMARY);
    doc.text("Rapport d'Orientation Personnalis√©", PAGE_WIDTH / 2, 120, { align: 'center' });
    doc.setFontSize(16);
    doc.setFont(FONT_NORMAL, 'normal');
    doc.setTextColor(COLOR_SECONDARY);
    doc.text(`${currentUserInfo.firstName} ${currentUserInfo.lastName}`, PAGE_WIDTH / 2, 135, { align: 'center' });
    doc.setFontSize(12);
    doc.text(`√âl√®ve de ${userGradeLevel}`, PAGE_WIDTH / 2, 145, { align: 'center' });
    doc.text(capitalizeWords(currentUserInfo.schoolName), PAGE_WIDTH / 2, 152, { align: 'center' });
    
    doc.addPage();
    y = MARGIN;

    // --- 2. G√âN√âRATION EXHAUSTIVE DU CONTENU ---
    const reportOrder = ['fil_rouge', 'badges', 'step0', 'step10', 'step1', 'step2', 'step3', 'step5', 'step4', 'step8', 'step11', 'step6', 'step9', 'retroplanning'];
    
    for (const key of reportOrder) {
        const stepData = journalData[key];
        const stepInfo = Object.values(stepsConfig).find(s => s.stepKey === key) || { title: 'R√©troplanning', icon: 'üóìÔ∏è' };
        if (!stepData || Object.values(stepData).every(v => !v || (Array.isArray(v) && v.length === 0))) continue;

        if (key === 'fil_rouge' && stepData.trim()) {
            addSectionTitle("Mon Fil Rouge");
            addBodyText(stepData);
            continue;
        } 
        if (key === 'badges') {
            const earnedBadges = journalData.earned_badges || [];
            if(earnedBadges.length > 0) {
                addSectionTitle("Mes Badges");
                earnedBadges.forEach(badgeKey => {
                    const badge = badgesConfig[badgeKey];
                    if (badge) addBodyText(`- ${badge.title}`);
                });
            }
            continue;
        }

        addSectionTitle(stepInfo.title);

        if (key === 'step0' && stepData.analysis) {
            const infographicContainer = createProfileInfographic(stepData);
            const elementToCapture = infographicContainer.querySelector('.bg-slate-50');

            if (elementToCapture) {
                // CORRECTION : On attache, on capture, on retire
                infographicContainer.style.position = 'fixed';
                infographicContainer.style.left = '-9999px';
                infographicContainer.style.width = '700px';
                document.body.appendChild(infographicContainer);

                try {
                    const canvas = await html2canvas(elementToCapture, { scale: 3, backgroundColor: '#f8fafc' });
                    const imgData = canvas.toDataURL('image/png');
                    const imgHeight = (canvas.height * CONTENT_WIDTH) / canvas.width;
                    checkPageBreak(imgHeight + 5);
                    doc.addImage(imgData, 'PNG', MARGIN, y, CONTENT_WIDTH, imgHeight);
                    y += imgHeight + 8;
                } catch (e) {
                    console.error("html2canvas failed:", e);
                    addBodyText("[Erreur lors de la g√©n√©ration de l'infographie]");
                } finally {
                    document.body.removeChild(infographicContainer);
                }
            }
            addSubHeader("Analyse de l'IA :");
            addBodyText(stepData.analysis);
        } else if (key === 'step10') {
            if (stepData.experiences && stepData.experiences.length > 0) {
                addSubHeader("Exp√©riences Significatives :");
                stepData.experiences.forEach((exp, i) => addBodyText(`Exp√©rience #${i + 1}: ${exp.analysis}`, { indent: 5 }));
            }
            if (stepData.soft_skills_profile) {
                addSubHeader("Profil de Comp√©tences Transversales :");
                addBodyText(stepData.soft_skills_profile, { indent: 5 });
            }
        } else if (key === 'retroplanning' && stepData.tasks) {
            stepData.tasks.forEach(month => {
                checkPageBreak(8);
                addSubHeader(month.month);
                month.tasks.forEach(task => addBodyText((task.completed ? `[x] ` : `[ ] `) + task.text, { indent: 5 }));
            });
        } else if (stepInfo.fields) {
            stepInfo.fields.forEach(field => {
                if (stepData[field.id] && String(stepData[field.id]).trim()) {
                    addSubHeader(field.label + " :");
                    addBodyText(String(stepData[field.id]), { indent: 5 });
                }
            });
        }
    }

    // --- 3. FINALISATION ---
    const pageCount = doc.internal.getNumberOfPages();
    for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.setTextColor(156, 163, 175);
        if (i > 1) doc.text("Rapport d'Orientation | Mon Explor'Orientation", MARGIN, 10);
        doc.text(`Page ${i} sur ${pageCount}`, PAGE_WIDTH / 2, PAGE_HEIGHT - 10, { align: 'center' });
    }

    doc.save(`Rapport_Orientation_${currentUserInfo.firstName}_${currentUserInfo.lastName}.pdf`);
}
function isStepComplete(stepKey) {
    const config = Object.values(stepsConfig).find(s => s.stepKey === stepKey);
    const data = journalData[stepKey];
    if (!config || !data) return false;
    
    // Cas sp√©cial pour l'√©tape "Mieux se conna√Ætre"
    if(stepKey === 'step0') {
         // V√©rifie si toutes les 26 questions ont une r√©ponse
        for(let i=1; i<=26; i++) {
            if(!data[`q${i}`] || data[`q${i}`].trim() === '') return false;
        }
        return true;
    }

    // --- NOUVEAU BLOC DE CODE POUR LE PORTFOLIO ---
    // Cas sp√©cial pour l'√©tape "Portfolio de Comp√©tences"
    if (stepKey === 'step10') {
        const hasExperience = data.experiences && Array.isArray(data.experiences) && data.experiences.length > 0;
        const hasProfile = data.soft_skills_profile && data.soft_skills_profile.trim() !== '';
        // L'√©tape est consid√©r√©e comme compl√®te si l'une des deux parties est remplie
        return hasExperience || hasProfile;
    }
    // --- FIN DU NOUVEAU BLOC ---

    // Logique g√©n√©rale pour les autres √©tapes bas√©es sur des champs de formulaire
    if (!config.fields || config.fields.length === 0) return false;

    const userFields = config.fields.filter(f => !f.isReadonly);
    if (userFields.length === 0) return false;

    return userFields.every(field => data[field.id] && data[field.id].toString().trim() !== '');
}

        function checkBadges() {
            if (!journalData.earned_badges) {
                journalData.earned_badges = [];
            }
            for (const badgeKey in badgesConfig) {
                if (!journalData.earned_badges.includes(badgeKey)) {
                    if (badgesConfig[badgeKey].criteria(userGradeLevel)) {
                        journalData.earned_badges.push(badgeKey);
                    }
                }
            }
        }

        function createBadgesDisplay(context = 'menu') {
    const earnedBadges = journalData.earned_badges || [];
    let badgesHTML = Object.keys(badgesConfig).map(key => {
        const badge = badgesConfig[key];
        const earned = earnedBadges.includes(key);
        return `
            <div class="text-center">
                <div class="badge ${earned ? 'earned' : ''}" title="${badge.description}">
                    <span class="text-3xl">${badge.icon}</span>
                    <p class="text-sm font-semibold mt-1 ${earned ? 'text-slate-800' : 'text-slate-400'}">${badge.title}</p>
                </div>
            </div>
        `;
    }).join('');
    
    // DIMINUTION DES PADDINGS (p-4 au lieu de p-6)
    const wrapperClass = context === 'journal' ? 'mb-8' : 'mb-8 bg-white p-4 rounded-2xl shadow-md border border-slate-200';

    return `
        <div id="badgesContainer" class="${wrapperClass}">
            <h2 class="text-lg font-bold text-slate-800 text-center mb-2">Mes Badges</h2>
            <div class="grid grid-cols-3 gap-2">
                ${badgesHTML}
            </div>
        </div>
    `;
}


        // --- Chatbot Logic ---
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatMessages = document.getElementById('chat-messages');

        chatbotToggle.addEventListener('click', () => {
            chatbotContainer.classList.toggle('hidden');
        });

        chatbotClose.addEventListener('click', () => {
            chatbotContainer.classList.add('hidden');
        });

       chatbotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatbotInput.value.trim();
            if (!userInput) return;

            addMessage(userInput, 'user');
            chatbotInput.value = '';
            
            const loaderDiv = addMessage('', 'loader');

            const prompt = `gis comme un coach d'orientation dont la seule et unique sp√©cialit√© est la plateforme Parcoursup.fr. Tu es un expert absolu de son fonctionnement et de son catalogue de formations.

Ta mission est de r√©pondre aux questions des lyc√©ens en te basant **prioritairement et quasi exclusivement** sur les informations pr√©sentes sur le site officiel Parcoursup.fr.

Lorsque la question d'un lyc√©en porte sur une **formation sp√©cifique** (ex: "BUT Informatique √† Villetaneuse" ou "Licence de Droit √† Assas"), tu dois utiliser la recherche web pour trouver sa fiche officielle sur Parcoursup et synth√©tiser avec une grande pr√©cision les √©l√©ments cl√©s. Ta r√©ponse doit √™tre structur√©e et inclure syst√©matiquement :

* **Attendus :** R√©sume les attendus nationaux et locaux (les comp√©tences et connaissances requises).
* **Crit√®res d'analyse :** Liste les crit√®res que l'√©tablissement utilise pour examiner les candidatures.
* **D√©bouch√©s :** Mentionne les d√©bouch√©s professionnels et les poursuites d'√©tudes possibles apr√®s la formation.
* **Chiffres cl√©s :** Si possible, donne le taux d'acc√®s de l'ann√©e pr√©c√©dente et le nombre de places disponibles.

Si la question est plus **g√©n√©rale** sur le fonctionnement de Parcoursup (ex: "c'est quoi un v≈ìu multiple ?" ou "comment fonctionne la phase compl√©mentaire ?"), ta r√©ponse doit √™tre p√©dagogique, pr√©cise et toujours bas√©e sur les r√®gles officielles de la plateforme.

R√©ponds maintenant √† la question suivante : "${userInput}"`;
            const aiResponse = await callGeminiAPI(prompt, true);
            
            loaderDiv.remove();
            addMessage(aiResponse, 'ai');
        });

        function addMessage(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex mb-4';
            
            let messageContent;
            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageContent = `
                    <div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs">
                        <p>${text}</p>
                    </div>
                `;
            } else if (sender === 'ai') {
                 messageContent = `
                    <div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs">
                        <p>${text}</p>
                    </div>
                `;
            } else if (sender === 'loader') {
                 messageContent = `
                    <div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg">
                        <div class="chatbot-loader"></div>
                    </div>
                `;
            }

            messageWrapper.innerHTML = messageContent;
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageWrapper;
        }

        window.showView = showView;
        window.exportPDF = exportPDF;

        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('SW registered: ', registration);
            }).catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
        });
    }
    </script>
</body>
</html>


