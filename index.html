<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Explor'Orientation</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo_180.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            text-align: justify;
        }
        .step-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #mainApp { display: none; }

        

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0891b2; 
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .chatbot-loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #0891b2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chatbot styles */
        #chatbot-toggle {
            transition: transform 0.2s ease-in-out;
        }
        #chatbot-toggle:hover {
            transform: scale(1.1);
        }
        #chatbot-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .chat-message-container {
            scroll-behavior: smooth;
        }
        .badge {
            filter: grayscale(1);
            opacity: 0.5;
        }
        .badge.earned {
            filter: grayscale(0);
            opacity: 1;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
        .simulation-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .simulation-message-container {
            scroll-behavior: smooth;
        }

        .portfolio-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }

        h1, h2, h3, h4 {
            text-align: center;
        }

       #floatingBackBtn {
    position: fixed;
    bottom: 24px;
    left: 24px;
    width: 56px;
    height: 56px;
    background-color: #0891b2; /* cyan-600 -- COULEUR MODIFI√âE ICI */
    color: white;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    cursor: pointer;
    z-index: 30;
    transition: transform 0.2s ease-in-out, opacity 0.3s ease-in-out;
}

#floatingBackBtn:hover {
    transform: scale(1.1);
}

    </style>
</head>
<body class="bg-slate-50 text-slate-800 text-center">

    <div id="authContainer" class="max-w-md mx-auto p-4 md:p-8 mt-10">
        <!-- L'interface d'authentification sera inject√©e ici -->
    </div>
    
    <div id="mainApp" class="max-w-4xl mx-auto p-4 md:p-8">
    </div>
        
<button id="floatingBackBtn" title="Retour au menu" style="display: none;">‚Üê</button>

<div id="guideRoleModal" style="display: none;" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center fade-in">
        <h2 class="text-2xl font-bold text-slate-800 mb-4">Qui √™tes-vous ?</h2>
        <p class="text-slate-600 mb-8">Nous pouvons adapter la pr√©sentation du guide pour vous.</p>
        <div class="space-y-4">
            <button id="roleEleveBtn" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">üë§ Je suis un √©l√®ve</button>
            <button id="roleParentBtn" class="w-full bg-sky-600 text-white font-semibold py-3 rounded-lg hover:bg-sky-700 transition">üë®üë©üëßüë¶ Je suis un parent</button>
            <button id="roleEnseignantBtn" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition">üßëüè´ Je suis un enseignant</button>
        </div>
        <button id="closeRoleModalBtn" class="mt-8 text-sm text-slate-500 hover:underline">Annuler</button>
    </div>
</div>

    <footer class="text-center text-sm text-slate-500 py-6">
        <p>Application cr√©√©e par Thomas Cavil, enseignant au Lyc√©e Benjamin Franklin.</p>
    </footer>

    <!-- Chatbot Floating Icon -->
    <div id="chatbot-toggle" class="fixed bottom-6 right-6 bg-cyan-600 text-white w-16 h-16 rounded-full flex items-center justify-center cursor-pointer shadow-lg z-40">
        <span class="text-3xl">ü§ñ</span>
    </div>

    <!-- Chatbot Window -->
   <div id="chatbot-container" class="hidden fixed bottom-4 right-4 sm:bottom-24 sm:right-6 w-[calc(100%-2rem)] max-w-sm h-[70vh] sm:h-[60vh] bg-white rounded-2xl shadow-xl border border-slate-200 z-50 flex flex-col">           <div class="flex items-center justify-between p-4 border-b bg-slate-50 rounded-t-2xl">
            <h3 class="font-bold text-slate-800">ü§ñ Ton Coach Orientation</h3>
            <button id="chatbot-close" class="text-slate-500 hover:text-slate-800">&times;</button>
        </div>
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto chat-message-container">
    </div>
        <form id="chatbot-form" class="p-4 border-t flex items-center gap-2">
            <input type="text" id="chatbot-input" placeholder="Quelle est ta question ?" class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
            <button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
        </form>
    </div>


    <!-- SDKs Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

        const levelConfig = {
            1: 0,
            2: 100,
            3: 250,
            4: 500,
            5: 800,
            6: 1200,
            7: 1700,
            8: 2300,
            9: 3000,
            10: 4000
        };

        const rankNames = {
            1: { homme: "Initi√©", femme: "Initi√©e", autre: "Initi√©(e)" },
            2: { homme: "Apprenti", femme: "Apprentie", autre: "Apprenti(e)" },
            3: { homme: "Curieux", femme: "Curieuse", autre: "Curieux/se" },
            4: { homme: "Explorateur", femme: "Exploratrice", autre: "Explorateur/rice" },
            5: { homme: "Strat√®ge", femme: "Strat√®ge", autre: "Strat√®ge" },
            6: { homme: "Analyste", femme: "Analyste", autre: "Analyste" },
            7: { homme: "Sp√©cialiste", femme: "Sp√©cialiste", autre: "Sp√©cialiste" },
            8: { homme: "Expert", femme: "Experte", autre: "Expert(e)" },
            9: { homme: "Mentor", femme: "Mentor", autre: "Mentor" },
            10: { homme: "Ma√Ætre de l'Orientation", femme: "Ma√Ætresse de l'Orientation", autre: "Ma√Ætre de l'Orientation" }
        };

        const creativeAngles = [
            "un m√©tier en lien avec la nature ou l'environnement.",
            "une carri√®re dans le secteur du jeu vid√©o ou du divertissement interactif.",
            "un r√¥le qui implique des voyages ou des relations internationales.",
            "un m√©tier artisanal ou qui demande un savoir-faire manuel de pr√©cision.",
            "une profession dans le domaine social ou humanitaire.",
            "un m√©tier de la communication ou du journalisme.",
            "une carri√®re dans le secteur du luxe ou de la mode.",
            "un r√¥le dans le domaine du sport et du bien-√™tre.",
            "un m√©tier scientifique ou de recherche fondamentale.",
            "une profession li√©e au droit ou √† la justice.",
            "une carri√®re dans le secteur de la finance ou de l'√©conomie.",
            "un m√©tier dans l'√©v√©nementiel ou le tourisme.",
            "un r√¥le dans la tech qui n'est pas purement du code (ex: UX Designer, Chef de Produit).",
            "un m√©tier du secteur public ou de l'administration.",
            "une profession artistique ou culturelle."
        ];

        const allSteps = [
        { id: 'retroplanning', icon: 'üóìÔ∏è', title: 'Mon R√©troplanning', site: 'Outil', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step0', icon: 'üë§', title: 'Mieux se conna√Ætre', site: 'Point de d√©part', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step10', icon: 'üíº', title: 'Mon Portfolio de Comp√©tences', site: 'Valorisation', levels: ['premiere', 'terminale'] },
        { id: 'step1', icon: 'üìö', title: 'Les Fondations', site: 'Onisep', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step3', icon: 'üéì', title: 'Le Catalogue', site: 'Parcoursup', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step5', icon: 'üì∞', title: 'L\'Actu', site: 'L\'√âtudiant & Co', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step7', icon: '‚úÖ', title: 'Fact Checking', site: 'Jeu interactif', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step2', icon: 'üß≠', title: 'Le simulateur de sp√©cialit√©s', site: 'Horizons21', levels: ['seconde', 'premiere'] },
        { id: 'step4', icon: 'üí¨', title: 'L\'Exp√©rience', site: 'Inspire', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step8', icon: 'üöÄ', title: 'Passer √† l\'action', site: 'Monde r√©el', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step11', icon: 'üåç', title: 'Rencontres sur mon Territoire', site: 'Ressources locales', levels: ['seconde', 'premiere', 'terminale'] },
        { id: 'step6', icon: '‚úçÔ∏è', title: 'Pr√©parer sa candidature', site: 'Projet motiv√©', levels: ['terminale'] },
        { id: 'step9', icon: 'üîÆ', title: 'Anticiper la suite', site: 'Plan B & R√©ussite', levels: ['terminale'] },
        { id: 'step12', icon: 'üí∂', title: 'Simulateur Vie √âtudiante', site: 'Budget & Aides', levels: ['premiere', 'terminale'] },
        { id: 'journal', icon: 'üìì', title: 'Mon Journal de Bord', site: 'Consulte tes notes', levels: ['seconde', 'premiere', 'terminale'] }
    ];

        
        const stepsConfig = {
    step0: { 
    stepKey: 'step0', title: 'Mieux se conna√Ætre', icon: 'üë§',
    description: `Toute bonne orientation commence par une bonne connaissance de soi. R√©ponds honn√™tement √† ces quelques questions pour d√©gager tes grandes tendances et obtenir une premi√®re analyse de ton profil.`,
    action: `<b>Ta mission :</b> R√©ponds aux 3 s√©ries de questions pour que l'IA dresse ton portrait psychologique et r√©v√®le ton <b>Arch√©type de personnalit√©</b>. Pour une analyse encore plus fine, tu pourras ensuite, si tu le souhaites, utiliser le module "Pour aller plus loin" en bas de page pour croiser ces r√©sultats avec ceux de tests externes.`
},
    step1: {
    stepKey: 'step1', title: "Les Fondations avec l'Onisep", icon: 'üìö',
    description: `L'Onisep est le service public de l'√âducation Nationale. C'est LA r√©f√©rence pour une information objective et compl√®te. <b>Ce que tu y trouves :</b> des fiches m√©tiers d√©taill√©es, des interviews, et le service <b>MonOrientationEnLigne.fr</b> pour poser tes questions directement √† des conseillers.`,
    action: `<b>Ta mission :</b> Explore jusqu'√† 3 m√©tiers. Pour chaque m√©tier, utilise les boutons d'IA pour d√©couvrir les d√©bouch√©s, simuler une journ√©e type et trouver des t√©moignages. Une fois que tu en as explor√© au moins deux, utilise le "üî¨ Comparateur de M√©tiers" pour g√©n√©rer un tableau de synth√®se qui t'aidera √† y voir plus clair !`,
    urls: [
        { site: "Onisep.fr", url: 'https://www.onisep.fr' },
        { site: "MonOrientationEnLigne.fr", url: 'https://www.monorientationenligne.fr/' }
    ],
    fields: [
            {id: 'metier1', label: 'M√©tier / Domaine #1', placeholder: 'Ex: D√©veloppeur web'},
            {id: 'notes1', label: 'Notes (√©tudes, comp√©tences, surprises...)', placeholder: 'Ce qui a retenu mon attention...', type: 'textarea'},
            {id: 'metier2', label: 'M√©tier / Domaine #2', placeholder: 'Ex: Journaliste scientifique'},
            {id: 'notes2', label: 'Notes...', placeholder: 'Ce qui a retenu mon attention...', type: 'textarea'},
            {id: 'metier3', label: 'M√©tier / Domaine #3', placeholder: 'Ex: Kin√©sith√©rapeute'},
            {id: 'notes3', label: 'Notes...', placeholder: 'Ce qui a retenu mon attention...', type: 'textarea'}
        ]
    },
    step2: { 
    stepKey: 'step2', title: "Le simulateur de sp√©cialit√©s Horizons21", icon: 'üß≠',
    description: `Cet outil a √©t√© cr√©√© pour t'aider √† faire le lien entre les sp√©cialit√©s du lyc√©e et les √©tudes sup√©rieures. <b>Int√©r√™t principal :</b> Comprendre l'impact de tes choix de mati√®res sur ton avenir et pr√©parer tes choix pour l'ann√©e suivante.`,
    action: {
        seconde: "<b>Ta mission :</b> Teste deux combinaisons de 3 sp√©cialit√©s. Pour chacune, lance l'analyse ‚ú® pour voir le lien avec ton profil, puis clique sur üó£Ô∏è pour d√©couvrir un t√©moignage d'√©tudiant. Ensuite, explore Horizons21 pour compl√©ter ta recherche.",
        premiere: "<b>Ta mission :</b> Teste deux combinaisons en gardant 2 de tes sp√©cialit√©s actuelles. Pour chacune, lance l'analyse ‚ú® pour voir le lien avec ton profil, puis clique sur üó£Ô∏è pour d√©couvrir un t√©moignage d'√©tudiant. Ensuite, explore Horizons21 pour compl√©ter ta recherche."
    },
    url: 'https://www.horizons21.fr', site: 'Horizons21.fr',
    fields: [
            {id: 'combo1', label: 'Combinaison de sp√©cialit√©s #1', placeholder: 'Ex: Maths, Physique-Chimie, NSI'},
            {id: 'notes1', label: 'Horizons ouverts et r√©flexions', placeholder: 'Ouvre les portes de l\'ing√©nierie, du num√©rique...', type: 'textarea'},
            {id: 'skills1', label: 'Comp√©tences cl√©s analys√©es par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'combo2', label: 'Combinaison de sp√©cialit√©s #2', placeholder: 'Ex: HGGSP, SES, LLCE Anglais'},
            {id: 'notes2', label: 'Horizons ouverts et r√©flexions', placeholder: 'Id√©al pour les sciences politiques, le commerce international...', type: 'textarea'},
            {id: 'skills2', label: 'Comp√©tences cl√©s analys√©es par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'combo3', label: 'Combinaison de sp√©cialit√©s #3', placeholder: 'Ex: SVT, Physique-Chimie, Maths'},
            {id: 'notes3', label: 'Horizons ouverts et r√©flexions', placeholder: 'Parfait pour les √©tudes de sant√©, la recherche...', type: 'textarea'},
            {id: 'skills3', label: 'Comp√©tences cl√©s analys√©es par l\'IA', type: 'textarea', isReadonly: true }
        ]
    },
    step3: { 
    stepKey: 'step3', title: 'Le Catalogue Parcoursup', icon: 'üéì',
    description: `Bien plus qu'un site d'inscription, c'est le moteur de recherche le plus exhaustif sur les formations post-bac. <b>Ce qu'il faut absolument regarder :</b> les "attendus", la carte interactive, et les chiffres cl√©s (taux d'acc√®s, etc.).`,
    action: `<b>Ta mission :</b> Trouve 2 formations qui t'int√©ressent sur Parcoursup. Pour chacune, copie-colle les "attendus", puis utilise le bouton "üîé Mon profil correspond-il ?" pour obtenir un rapport de compatibilit√© personnalis√© qui croise les donn√©es de tout ton parcours. Trouve ensuite 3 mots cl√©s pour d√©crire cette formation. et clique sur l'‚ú® pour obtenir une analyse plus pouss√©e. Enfin, n'h√©site pas √† sollciiter l'IA pour qu'elle te sugg√®re des parcours alternatifs `,
    url: 'https://www.parcoursup.fr', site: 'Parcoursup.fr',
    fields: [
        {id: 'formation1', label: 'Formation #1', placeholder: 'Ex: BUT Informatique - Villetaneuse'},
        {id: 'attendus1', label: 'Attendus et crit√®res importants', placeholder: 'Bon niveau en maths, projet motiv√©...', type: 'textarea'},
        {id: 'compatibilite1', label: 'Rapport de compatibilit√©', type: 'textarea', isReadonly: true},
        {id: 'mots_cles1', label: 'D√©fi : Tes 3 mots-cl√©s pour cette formation', placeholder: 'Ex: Logique, programmation, travail d\'√©quipe'},
        {id: 'analyse_mots_cles1', label: 'Analyse de tes mots-cl√©s par l\'IA', type: 'textarea', isReadonly: true},
        {id: 'formation2', label: 'Formation #2', placeholder: 'Ex: Licence de Droit - Assas'},
        {id: 'attendus2', label: 'Attendus et crit√®res importants', placeholder: 'Qualit√©s r√©dactionnelles, logique...', type: 'textarea'},
        {id: 'compatibilite2', label: 'Rapport de compatibilit√©', type: 'textarea', isReadonly: true},
        {id: 'mots_cles2', label: 'D√©fi : Tes 3 mots-cl√©s pour cette formation', placeholder: 'Ex: Rigueur, r√©daction, argumentation'},
        {id: 'analyse_mots_cles2', label: 'Analyse de tes mots-cl√©s par l\'IA', type: 'textarea', isReadonly: true},
        {id: 'suggestions', label: 'Pistes de r√©flexion sugg√©r√©es par l\'IA', type: 'textarea', isReadonly: true}
    ]
},
    step4: {
        stepKey: 'step4', title: "L'Exp√©rience avec Inspire", icon: 'üí¨',
        description: `Cette plateforme te permet de discuter avec des √©tudiants "√©claireurs". <b>Int√©r√™t principal :</b> Obtenir un retour d'exp√©rience authentique et humain, au-del√† des plaquettes officielles (ambiance, charge de travail, vie √©tudiante...).`,
        action: "<b>Ta mission :</b> Cherche 2 domaines d'√©tudes. Pr√©pare une question pr√©cise, puis clique sur ‚ú® pour obtenir des suggestions de questions plus pouss√©es √† poser √† un √©tudiant.",
        url: 'https://www.inspire-orientation.org', site: 'Inspire-orientation.org',
        fields: [
            {id: 'theme1', label: 'Formation ou domaine #1', placeholder: 'Ex: √âcoles d\'ing√©nieurs'},
            {id: 'question1', label: 'Ma question principale', placeholder: 'Quelle est la plus grande diff√©rence avec le lyc√©e ?', type: 'textarea'},
            {id: 'suggestions1', label: 'Suggestions de questions par l\'IA', type: 'textarea', isReadonly: true},
            {id: 'theme2', label: 'Formation ou domaine #2', placeholder: 'Ex: √âtudes de sant√© (PASS/LAS)'},
            {id: 'question2', label: 'Ma question principale', placeholder: 'Comment g√©rer la charge de travail ?', type: 'textarea'},
            {id: 'suggestions2', label: 'Suggestions de questions par l\'IA', type: 'textarea', isReadonly: true}
        ]
    },

step5: {
    stepKey: 'step5', title: "L'Actu", icon: 'üì∞',
    description: `Des m√©dias comme L'√âtudiant.fr ou Studyrama.com apportent un autre regard sur le monde des √©tudes et des m√©tiers. <b>Ce que tu peux y trouver :</b> des classements, des articles sur des secteurs qui recrutent, et des dossiers sur des fili√®res.`,
    action: `<b>Ta mission :</b> Explore les sites de L'√âtudiant.fr ou Studyrama.com. Trouve jusqu'√† <b>trois</b> informations pertinentes pour ton projet, puis utilise le bouton ‚ú® pour que l'IA analyse tes trouvailles par rapport √† ton profil.`,
    urls: [
        { site: "L'√âtudiant.fr", url: 'https://www.letudiant.fr' },
        { site: "Studyrama.com", url: 'https://www.studyrama.com' }
    ],
    fields: [
        {id: 'article1', label: 'Info ou classement trouv√© #1', placeholder: 'Ex: Le classement des √©coles de commerce 2025'},
        {id: 'apprentissage1', label: 'Ce que j\'ai appris de cette info', placeholder: 'Certaines √©coles sont sp√©cialis√©es dans le luxe...', type: 'textarea'},
        {id: 'article2', label: 'Info ou classement trouv√© #2', placeholder: 'Ex: Un article sur les m√©tiers du jeu vid√©o'},
        {id: 'apprentissage2', label: 'Ce que j\'ai appris de cette info', placeholder: 'Les salaires sont plus √©lev√©s que ce que je pensais...', type: 'textarea'},
        {id: 'article3', label: 'Info ou classement trouv√© #3', placeholder: 'Ex: Dossier sur les √©tudes en alternance'},
        {id: 'apprentissage3', label: 'Ce que j\'ai appris de cette info', placeholder: 'C\'est une bonne option pour financer ses √©tudes...', type: 'textarea'},
    ]
},

    step6: { 
        stepKey: 'step6', title: 'Pr√©parer sa candidature', icon: '‚úçÔ∏è',
        description: `La r√©daction du "projet de formation motiv√©" sur Parcoursup est une √©tape cruciale. Cet outil ne va pas √©crire la lettre √† ta place, mais t'aider √† la structurer de mani√®re claire et percutante.`,
        action: `<b>Ta mission :</b> Pr√©pare jusqu'√† deux projets de formation motiv√©s. Pour chacun, renseigne la formation et tes motivations, puis clique sur "‚ú® G√©n√©rer une structure". Ensuite, utilise l'atelier "üí° Am√©liorer mon paragraphe" pour transformer ton brouillon en un texte percutant gr√¢ce aux conseils du coach IA.`,
        fields: [
            {id: 'formation', label: 'Formation vis√©e (nom exact de Parcoursup)', placeholder: 'Ex: BUT Informatique - IUT de Villetaneuse'},
            {id: 'motivations', label: 'Mes motivations, comp√©tences, exp√©riences (en vrac)', placeholder: 'Ex: J\'aime r√©soudre des probl√®mes logiques, j\'ai suivi la sp√© NSI, j\'ai cr√©√© un petit site web, je suis rigoureux...', type: 'textarea'},
            {id: 'structure', label: 'Proposition de structure pour ton projet motiv√©', placeholder: 'La structure g√©n√©r√©e par l\'IA appara√Ætra ici...', type: 'textarea', isReadonly: true}
        ]
     },
   step7: {
    stepKey: 'step7', title: 'Fact Checking', icon: '‚úÖ',
    description: `Dans le monde de l'orientation, il est crucial de savoir d√©m√™ler le vrai du faux. Cette √©tape te propose deux ateliers pour aiguiser ton esprit critique.`,
    action: `<b>Ta mission :</b> Choisis l'un des deux ateliers ci-dessous. Le premier te permet de tester tes connaissances g√©n√©rales sur un sujet. Le second te propose un quiz sur mesure, qui te questionne par rapport √† ton propre profil.`,
    fields: []
    },
    step8: { 
        stepKey: 'step8', title: 'Passer √† l\'action', icon: 'üöÄ',
        description: `La recherche en ligne est une chose, la r√©alit√© du terrain en est une autre. L'avis d'un professionnel ou le t√©moignage d'un √©tudiant peut tout changer ! Cette √©tape t'aide √† pr√©parer ces rencontres et √† trouver des contenus inspirants.`,
        action: `<b>Ta mission :</b> Transforme cette √©tape en ton gestionnaire de r√©seau ! Ajoute tes contacts personnels, puis utilise la recherche IA pour trouver au moins 5 contacts professionnels pour 3 m√©tiers diff√©rents. Ensuite, utilise le menu d√©roulant pour suivre l'avancement de tes prises de contact et l'assistant "Strat√©gie de Contact" pour pr√©parer tes √©changes.`,
        fields: [
            {id: 'pro_reseau_personnel', label: 'Personnes de mon entourage √† contacter (famille, amis des parents, voisins...)', placeholder: 'Ex: Le p√®re de mon ami, qui est ing√©nieur...\nMa voisine, qui travaille dans le marketing...', type: 'textarea'},
            {id: 'pro_metier', label: 'M√©tier pour lequel tu cherches des contacts externes', placeholder: 'Ex: Architecte'},
            {id: 'pro_departement', label: 'Ton d√©partement (ex: 75, Morbihan, ...)', placeholder: 'Ex: Morbihan'},
            {id: 'pro_contacts', label: 'Contacts externes trouv√©s par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'pro_strategie', label: 'Strat√©gie et mod√®le de mail g√©n√©r√©s par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'jpo_ecole', label: '√âcole ou formation pour une Journ√©e Portes Ouvertes', placeholder: 'Ex: INSA Lyon'},
            {id: 'jpo_questions', label: 'Questions cl√©s √† poser (g√©n√©r√©es par l\'IA)', type: 'textarea', isReadonly: true }
        ]
    },
    step9: { 
        stepKey: 'step9', title: 'Anticiper la suite', icon: 'üîÆ',
        description: `L'orientation ne s'arr√™te pas √† Parcoursup. Cette √©tape t'aide √† te pr√©parer pour la suite : que faire si ton v≈ìu n¬∞1 est refus√© ? Et comment bien d√©marrer ta premi√®re ann√©e dans le sup√©rieur ?`,
        action: "<b>Ta mission :</b> Utilise les deux outils ci-dessous. Le premier t'aide √† construire un plan B solide. Le second te donne des conseils pour r√©ussir ta future premi√®re ann√©e.",
        fields: [
            {id: 'formation_reve', label: 'Ma formation "r√™v√©e" (V≈ìu n¬∞1)', placeholder: 'Ex: Classe pr√©pa MPSI au Lyc√©e Louis-le-Grand'},
            {id: 'plan_b', label: 'Suggestions de "Plan B" par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'reussite_type', label: 'Type de formation pour lequel tu veux des conseils', placeholder: 'Ex: Licence de Droit, BUT, Classe Pr√©pa...'},
            {id: 'reussite_conseils', label: 'Conseils de r√©ussite par l\'IA', type: 'textarea', isReadonly: true }
        ]
    },
   step10: { 
        stepKey: 'step10', title: 'Mon Portfolio de Comp√©tences', icon: 'üíº',
        description: `Cette √©tape te propose deux ateliers compl√©mentaires pour cr√©er un portfolio qui te ressemble vraiment. Le premier t'aide √† transformer tes exp√©riences concr√®tes (stage, projet, passion, job...) en comp√©tences valorisables pour tes candidatures. Le second est un 'd√©tecteur' rapide qui te permet de r√©v√©ler tes grandes comp√©tences transversales (ta mani√®re de travailler, de r√©fl√©chir...). L'ensemble te donnera une vision claire et unique de tes atouts.`,
        action: `<b>Ta mission est double :</b><br>
        1. <b>Raconter tes exp√©riences :</b> Clique sur le bouton "+ Ajouter une exp√©rience" et laisse-toi guider. Raconte ce que tu as fait, et l'IA t'aidera √† en extraire les comp√©tences cl√©s pour Parcoursup.<br>
        2. <b>R√©v√©ler ton profil :</b> Lance le "d√©tecteur de comp√©tences" et r√©ponds aux quelques questions. Tu obtiendras une analyse de tes savoir-√™tre dominants (Rigueur, Cr√©ativit√©, Leadership...).`,
        fields: []
    },
    step11: { 
        stepKey: 'step11', title: 'Rencontres sur mon Territoire', icon: 'üåç',
        description: `L'orientation se nourrit aussi de rencontres r√©elles. Utilise cet outil pour trouver des √©v√©nements et des structures d'aide pr√®s de chez toi.`,
        action: "<b>Ta mission :</b> Indique ta ville ou ton d√©partement, puis lance les recherches pour trouver les prochaines opportunit√©s de rencontres et les lieux d'information locaux.",
        fields: [
            {id: 'location', label: 'Ta ville ou ton d√©partement', placeholder: 'Ex: Land√©vant ou Morbihan'}
        ]
    },
    step12: { 
        stepKey: 'step12', title: 'Simulateur Vie √âtudiante', icon: 'üí∂',
        description: `Choisir ses √©tudes, c'est aussi choisir un cadre de vie et un budget. Utilise cet outil pour estimer le co√ªt de la vie dans la ville de ton choix et pour d√©couvrir les principales aides financi√®res auxquelles tu pourrais pr√©tendre.`,
        action: `<b>Ta mission :</b> Renseigne une ville, puis lance les simulateurs pour obtenir une estimation de budget et des pistes pour les bourses.`,
        fields: []
    },
};
const badgesConfig = {
    explorateur: {
        icon: 'üèÖ',
        title: "Badge de l'Explorateur",
        description: "D√©cern√© pour avoir compl√©t√© les premi√®res √©tapes fondamentales de ton exploration.",
        criteria: (level) => {
            const step0Complete = isStepComplete('step0');
            const step1Complete = isStepComplete('step1');
            const step2or3Complete = level === 'seconde' ? isStepComplete('step2') : isStepComplete('step3');
            return step0Complete && step1Complete && step2or3Complete;
        }
    },
    stratege: {
        icon: 'üß†',
        title: "Badge du Strat√®ge",
        description: "D√©cern√© pour avoir planifi√© ton ann√©e et anticip√© l'avenir avec un plan B.",
        criteria: () => {
            const retroplanningComplete = journalData.retroplanning && journalData.retroplanning.rawText && journalData.retroplanning.rawText.trim() !== '';
            const step9Complete = isStepComplete('step9');
            return retroplanningComplete && step9Complete;
        }
    },
    connecteur: {
        icon: 'ü§ù',
        title: "Badge du Connecteur",
        description: "D√©cern√© pour avoir pris contact avec le monde r√©el en contactant un professionnel.",
        criteria: () => {
            return (journalData.step8.pro_reseau_personnel && journalData.step8.pro_reseau_personnel.trim() !== '') || (journalData.step8.pro_contacts && journalData.step8.pro_contacts.trim() !== '');
        }
    }
};

function showSurpriseModal(title, contentHTML, duration = null) {
            const modalId = 'surprise-modal';
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-md text-center p-6">
                    <span class="text-4xl">üí°</span>
                    <h3 class="font-bold text-slate-800 text-lg mt-2 mb-4">${title}</h3>
                    <div class="text-slate-600 mb-6">${contentHTML}</div>
                    <button id="surprise-close-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 rounded-lg hover:bg-cyan-700 transition">OK</button>
                </div>
            `;
            
            document.body.appendChild(modal);

            const closeModal = () => {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            };
            
            modal.querySelector('#surprise-close-btn').addEventListener('click', closeModal);

            // Logique d'auto-fermeture
            if (duration) {
                setTimeout(closeModal, duration);
            }
        }

function createSimpleModal(title, contentHTML) {
            const modalId = 'simple-info-modal';
            // Supprime un modal existant s'il y en a un
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col max-h-[80vh]">
                    <div class="flex items-center justify-between p-4 border-b bg-slate-50 rounded-t-2xl">
                        <h3 class="font-bold text-slate-800 text-lg">${title}</h3>
                        <button id="simple-modal-close" class="text-slate-500 hover:text-slate-800 text-2xl">√ó</button>
                    </div>
                    <div class="p-6 overflow-y-auto">
                        ${contentHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            const closeModal = () => modal.remove();
            
            modal.querySelector('#simple-modal-close').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        function showConfirmationModal(question) {
            return new Promise((resolve) => {
                const modalId = 'confirmation-modal';
                // Supprime un modal de confirmation existant pour √©viter les doublons
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm text-center p-6">
                        <h3 class="font-bold text-slate-800 text-lg mb-4">Confirmation requise</h3>
                        <p class="text-slate-600 mb-6">${question}</p>
                        <div class="flex gap-4">
                            <button id="confirm-cancel-btn" class="flex-1 bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Annuler</button>
                            <button id="confirm-ok-btn" class="flex-1 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Confirmer</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const confirmBtn = modal.querySelector('#confirm-ok-btn');
                const cancelBtn = modal.querySelector('#confirm-cancel-btn');

                const closeModal = (result) => {
                    modal.remove();
                    resolve(result); // La promesse est r√©solue avec 'true' ou 'false'
                };

                confirmBtn.addEventListener('click', () => closeModal(true));
                cancelBtn.addEventListener('click', () => closeModal(false));
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(false); // Cliquer en dehors √©quivaut √† annuler
                    }
                });
            });
        }

        // IMPORTANT : Remplacez par la configuration de votre propre projet Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCT6U-7Az53oYCPZWHo3Dvxs20XiR0y3EU",
            authDomain: "monapp0rientation.firebaseapp.com",
            projectId: "monapp0rientation",
            storageBucket: "monapp0rientation.firebasestorage.app",
            messagingSenderId: "369432089475",
            appId: "1:369432089475:web:689a194b6880001c249cb6"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const functions = getFunctions(firebaseApp, "europe-west1"); 
        let currentUserId = null;
        let userGradeLevel = null;
        let currentUserInfo = { firstName: '', lastName: '', schoolName: '' };

        let cameFromLogin = false;
        
        const linkify = (text) => {
    const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    let newText = text.replace(urlRegex, function(url) {
        let hyperLink = url;
        if (!hyperLink.match('^https?:\/\/')) {
            hyperLink = 'http://' + hyperLink;
        }
        return `<a href="${hyperLink}" target="_blank" class="text-cyan-600 hover:underline">${url}</a>`;
    });
    // This makes sure line breaks are preserved
    return newText.replace(/\n/g, '<br>');
};
        const { jsPDF } = window.jspdf;

        const authContainer = document.getElementById('authContainer');
        const mainApp = document.getElementById('mainApp');
        const floatingBackBtn = document.getElementById('floatingBackBtn'); // AJOUTEZ CETTE LIGNE

        floatingBackBtn.addEventListener('click', () => showView('menu')); // AJOUTEZ CETTE LIGNE


        let journalData = {};
        
       // D√©tecter si l'URL est un lien de partage
const urlParams = new URLSearchParams(window.location.search);
const shareId = urlParams.get('share_id');
const shareToken = urlParams.get('token');

if (shareId && shareToken) {
    // C'EST UN LIEN DE PARTAGE
    // On cache l'authentification et on affiche directement la vue publique
    authContainer.style.display = 'none';
    mainApp.style.display = 'block';
    document.querySelector('footer').style.display = 'none';
    document.querySelector('#chatbot-toggle').style.display = 'none';
    createPublicShareView(shareId, shareToken);
} else {
    // CE N'EST PAS UN LIEN DE PARTAGE : COMPORTEMENT NORMAL DE L'APP
    
    // On rend les fonctions de navigation globale accessibles
    window.showGuideFromLogin = function() {
        cameFromLogin = true;
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.querySelector('footer').style.display = 'none'; 
        showView('guide');
    }

    

    window.showLoginViewFromGuide = function() {
        cameFromLogin = false;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        showLoginView();
    }

    
    
// REMPLACEZ VOTRE onAuthStateChanged ACTUELLE PAR CELLE-CI :
onAuthStateChanged(auth, user => {
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const floatingBackBtn = document.getElementById('floatingBackBtn');

    if (user) {
        // --- UTILISATEUR CONNECT√â ---
        if (chatbotToggle) chatbotToggle.style.display = 'flex';
        
        currentUserId = user.uid;
        authContainer.style.display = 'none';
        mainApp.style.display = 'block';
        loadData();

    } else {
        // --- UTILISATEUR D√âCONNECT√â ---
        // On s'assure que TOUS les √©l√©ments flottants sont cach√©s
        if (chatbotToggle) chatbotToggle.style.display = 'none';
        if (floatingBackBtn) floatingBackBtn.style.display = 'none';
        
        currentUserId = null;
        userGradeLevel = null;
        currentUserInfo = { firstName: '', lastName: '', schoolName: '' };
        journalData = {}; 
        authContainer.style.display = 'block';
        mainApp.style.display = 'none';
        showLoginView();
    }
});
}

 function extractJsonFromString(str) {
            if (!str) return null;
            // Trouve la premi√®re accolade '{' et la derni√®re '}'
            const jsonStart = str.indexOf('{');
            const jsonEnd = str.lastIndexOf('}') + 1;

            // Si on ne trouve pas d'objet JSON, on retourne null
            if (jsonStart === -1 || jsonEnd === 0) {
                return null;
            }

            // Extrait la sous-cha√Æne qui ressemble √† du JSON
            const jsonString = str.substring(jsonStart, jsonEnd);
            
            try {
                // Tente de l'analyser
                return JSON.parse(jsonString);
            } catch (error) {
                // Si l'analyse √©choue, c'est que ce n'√©tait pas du JSON valide
                console.error("Impossible d'analyser le JSON extrait:", error);
                return null;
            }
        }

            
        // üîπ Fonction utilitaire
function capitalizeWords(str) {
    return str.replace(/\b\w/g, c => c.toUpperCase());
}

function showLoginView() {
    // On s'assure de toujours cacher le bouton flottant ici
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    if (floatingBackBtn) {
        floatingBackBtn.style.display = 'none';
    }

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">
            <img src="logo.png" alt="Logo Mon Explor'Orientation" class="mx-auto h-70 w-auto mb-0">
            <p class="text-center text-sm text-slate-500 mb-6">
                Besoin d'aide pour commencer ? 
                <button id="showGuideButton" class="font-semibold text-cyan-600 hover:underline">Consultez le guide d'utilisation.</button>
            </p>
            <div class="p-4 bg-slate-50 rounded-lg text-center text-slate-700 mb-6">
                <p>Bienvenue sur ton compagnon d'orientation personnel. Explore des m√©tiers, simule tes choix et construis ton projet d'avenir gr√¢ce √† des outils interactifs et une IA bienveillante. Ton exploration commence ici.</p>
            </div>
            <form id="loginForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Se connecter</button>
            </form>
            <div class="flex justify-between items-center text-sm text-left">
                <p class="text-slate-500">Pas encore de compte ? 
                    <button id="showSignupButton" class="font-semibold text-cyan-600 hover:underline">Inscrivez-vous</button>
                </p>
                <button id="forgotPasswordButton" class="text-sm text-slate-500 hover:underline">Mot de passe oubli√© ?</button>
            </div>
            <p id="authError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    authContainer.querySelector('#loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
        } catch (error) {
            authContainer.querySelector('#authError').textContent = "Erreur de connexion. V√©rifiez vos identifiants.";
        }
    });

    authContainer.querySelector('#showSignupButton').addEventListener('click', showSignupView);
    authContainer.querySelector('#forgotPasswordButton').addEventListener('click', showForgotPasswordView);
    
    // CORRECTION : Le bouton ouvre maintenant la fen√™tre de s√©lection
    authContainer.querySelector('#showGuideButton').addEventListener('click', () => {
        document.getElementById('guideRoleModal').style.display = 'flex';
    });
}

function showForgotPasswordView() {
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">
            <img src="logo.png" alt="Logo Mon Explor'Orientation" class="mx-auto h-48 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-2">Mot de passe oubli√© ?</h2>
            <p class="text-center text-slate-500 mb-6">Pas de panique ! Entrez votre e-mail pour recevoir un lien de r√©initialisation.</p>
            <form id="forgotPasswordForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail du compte" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Envoyer le lien</button>
            </form>
            <p class="text-center text-sm text-slate-500">
                <button id="backToLoginButton" class="font-semibold text-cyan-600 hover:underline">Retour √† la connexion</button>
            </p>
            <p id="authMessage" class="text-green-600 text-center mt-4"></p>
        </div>
    `;

    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const authMessage = document.getElementById('authMessage');

    forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        try {
            await sendPasswordResetEmail(auth, email);
            authMessage.textContent = "Si un compte existe pour cet e-mail, un lien de r√©initialisation vient d'√™tre envoy√©.";
            authMessage.className = 'text-green-600 text-center mt-4';
        } catch (error) {
            authMessage.textContent = "Une erreur est survenue. Veuillez r√©essayer.";
            authMessage.className = 'text-red-500 text-center mt-4';
        }
    });

    document.getElementById('backToLoginButton').addEventListener('click', showLoginView);
}

// üîπ Vue d'inscription
function showSignupView() {
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in">

            <img src="logo.png" alt="Logo Mon Explor'Orientation" class="mx-auto h-32 w-auto mb-6">

            <p class="text-center text-slate-500 mb-6 text-lg">Rejoignez l'aventure de l'orientation !</p>
            <form id="signupForm" class="mb-4">
                <input id="firstName" type="text" placeholder="Pr√©nom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="lastName" type="text" placeholder="Nom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="schoolName" type="text" placeholder="Nom du lyc√©e" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="schoolName" type="text" placeholder="Nom du lyc√©e" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <select id="gender" class="w-full p-3 mb-3 border border-slate-300 rounded-lg bg-white" required>
                    <option value="" disabled selected>Je suis...</option>
                    <option value="homme">Un homme</option>
                    <option value="femme">Une femme</option>
                    <option value="autre">Autre / Pr√©f√®re ne pas pr√©ciser</option>
                    </select>
                <input id="email" type="email" placeholder="Adresse e-mail" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="email" type="email" placeholder="Adresse e-mail" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe (6 caract√®res min.)" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700">Cr√©er mon compte</button>
            </form>
            <p class="text-center text-sm text-slate-500">D√©j√† un compte ? 
                <button id="showLoginButton" class="font-semibold text-cyan-600 hover:underline">Connectez-vous</button>
            </p>
            <p id="authError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    const signupForm = document.getElementById('signupForm');
    const showLoginButton = document.getElementById('showLoginButton');
    const authError = document.getElementById('authError');

    signupForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const firstName = capitalizeWords(document.getElementById('firstName').value);
        const lastName = capitalizeWords(document.getElementById('lastName').value);
        const schoolName = capitalizeWords(document.getElementById('schoolName').value);
        const gender = document.getElementById('gender').value; // <-- AJOUTEZ CETTE LIGNE
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            currentUserId = user.uid; 
            currentUserInfo = { firstName, lastName, schoolName };
            await saveData(true); 
        } catch (error) {
            authError.textContent = "Erreur lors de la cr√©ation du compte. Le mot de passe doit faire 6 caract√®res minimum.";
        }
    });
    showLoginButton.addEventListener('click', showLoginView);
}

// üîπ Rendre la fonction showView accessible globalement
window.showView = showView;

           function getCurrentSchoolYear() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth(); // 0 pour Janvier, 11 pour D√©cembre

    // On consid√®re que la nouvelle ann√©e scolaire commence en ao√ªt (mois 7)
    // Si nous sommes en juillet 2025 (mois 6), l'ann√©e scolaire est 2024.
    // Si nous sommes en ao√ªt 2025 (mois 7), l'ann√©e scolaire est 2025.
    return (month >= 7) ? year : year - 1;
}

        async function saveData(isInitialSave = false) {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            
            const dataToSave = {
                firstName: currentUserInfo.firstName,
                lastName: currentUserInfo.lastName,
                schoolName: currentUserInfo.schoolName,
                gradeLevel: userGradeLevel,
                gender: currentUserInfo.gender, // <-- AJOUTEZ CETTE LIGNE
                journal: journalData
            };
            
            try {
                if(isInitialSave) {
                    await setDoc(userDocRef, dataToSave);
                } else {
                    await setDoc(userDocRef, dataToSave, { merge: true });
                }
            } catch (error) {
                console.error("Error saving document: ", error);
            }

            triggerSurpriseMoment(); // <-- AJOUTEZ CETTE LIGNE

        }

        async function triggerSurpriseMoment() {
            // R√®gle 1: Ne pas afficher de surprise si la derni√®re date de moins de 2 heures
            const now = new Date().getTime();
            const lastSurprise = journalData.last_surprise_timestamp || 0;
            const hoursSinceLastSurprise = (now - lastSurprise) / (1000 * 60 * 60);
            if (hoursSinceLastSurprise < 1) { // 1 heure de d√©lai
                return;
            }

            // R√®gle 2: R√©duire la probabilit√© d'apparition (15% de chance au lieu de 25%)
            if (Math.random() > 0.15) {
                return;
            }
            
            // Pour √©viter les conflits, ne pas lancer si un autre modal est d√©j√† ouvert
            if (document.querySelector('.simulation-modal, .portfolio-modal, #simple-info-modal, #surprise-modal')) return;


            const currentLevel = journalData.level || 1;
            const currentXp = journalData.xp || 0;
            const xpForCurrentLevel = levelConfig[currentLevel];
            const xpForNextLevel = levelConfig[currentLevel + 1];
            const xpInCurrentLevel = currentXp - xpForCurrentLevel;
            // On g√®re le cas o√π l'√©l√®ve est au niveau maximum
            const xpNeededForLevel = xpForNextLevel ? xpForNextLevel - xpForCurrentLevel : Infinity; 

            let surprisesPossibles = [];

            // --- 1. SURPRISES LI√âES AU PROFIL (√âTAPE 0) ---

            // Si l'√©l√®ve a des traits 'Artistes' mais un portfolio vide
            const aDesTraitsArtistes = journalData.step0 && (journalData.step0.q16 === 'artistique' || journalData.step0.q19 === 'artistique' || journalData.step0.q20 === 'artistique');
            const portfolioVide = !journalData.step10.experiences || journalData.step10.experiences.length === 0;
            if (aDesTraitsArtistes && portfolioVide) {
                surprisesPossibles.push({
                    title: "Piste de r√©flexion...",
                    content: "J'ai remarqu√© que tu as des centres d'int√©r√™t artistiques. N'oublie pas que tu peux valoriser tes projets cr√©atifs (dessin, musique, √©criture...) dans ton <strong>Portfolio de Comp√©tences</strong> ! √áa peut faire toute la diff√©rence."
                });
            }
            
            // Si l'√©l√®ve a des traits 'Entreprenants' mais n'a pas explor√© de m√©tiers de management
            const aDesTraitsEntreprenants = journalData.step0 && (journalData.step0.q17 === 'entreprenant' || journalData.step0.q18 === 'entreprenant');
            const aExploreManagement = (journalData.step1.metier1.includes('manage') || journalData.step1.metier2.includes('manage') || journalData.step1.metier3.includes('manage'));
            if (aDesTraitsEntreprenants && !aExploreManagement) {
                surprisesPossibles.push({
                    title: "Ton profil de leader...",
                    content: "Ton profil montre que tu aimes diriger et convaincre. As-tu d√©j√† explor√© des m√©tiers li√©s au <strong>management de projet</strong> ou √† la <strong>cr√©ation d'entreprise</strong> ? Le Radar √† Opportunit√©s pourrait te surprendre !"
                });
            }

            // Si l'√©l√®ve est plut√¥t 'Introverti' et explore des m√©tiers de contact
            const estIntroverti = journalData.step0 && journalData.step0.q10 === 'introversion';
            const aExploreMetierSocial = (journalData.step1.metier1.toLowerCase().includes('social') || journalData.step1.metier1.toLowerCase().includes('enseignant') || journalData.step1.metier1.toLowerCase().includes('infirmier'));
            if (estIntroverti && aExploreMetierSocial) {
                surprisesPossibles.push({
                    title: "Une question pour toi...",
                    content: "C'est super de t'int√©resser aux m√©tiers du contact ! Ton profil sugg√®re que tu recharges tes batteries en √©tant seul(e). Pense √† utiliser le simulateur de <strong>'Journ√©e Type'</strong> pour voir si le rythme te conviendrait."
                });
            }

            // Si l'√©l√®ve est 'Curieux' et n'a pas fait de quiz
            const estCurieux = journalData.step0 && journalData.step0.q14 === 'curieux';
            const aFaitQuiz = journalData.step7.scores && Object.keys(journalData.step7.scores).length > 0;
            if (estCurieux && !aFaitQuiz) {
                surprisesPossibles.push({
                    title: "Pour les esprits curieux...",
                    content: "Ton profil montre une grande curiosit√© ! Pour la nourrir, pourquoi ne pas te lancer un d√©fi avec l'√©tape <strong>'Fact Checking'</strong> ? C'est un excellent moyen de d√©construire les id√©es re√ßues."
                });
            }
            
            // --- 2. SURPRISES LI√âES √Ä L'EXPLORATION (√âTAPES 1 √† 5) ---

            // Si l'√©l√®ve a explor√© au moins 2 m√©tiers mais n'a pas utilis√© le comparateur
            const metiersExplores = [journalData.step1.metier1, journalData.step1.metier2, journalData.step1.metier3].filter(m => m && m.trim() !== '').length;
            const comparateurNonUtilise = !journalData.step1.comparison || journalData.step1.comparison.trim() === '';
            if (metiersExplores >= 2 && comparateurNonUtilise) {
                surprisesPossibles.push({
                    title: "Astuce d'expert !",
                    content: "Super, tu as explor√© plusieurs m√©tiers ! Pour t'aider √† y voir plus clair, pense √† utiliser le <strong>Comparateur de M√©tiers</strong> en bas de l'√©tape 'Les Fondations'. Il te cr√©era un tableau de synth√®se personnalis√©."
                });
            }
            
            // Si l'√©l√®ve a mis des formations dans le catalogue mais pas de m√©tier correspondant
            const aExploreFormations = journalData.step3 && journalData.step3.formation1.trim() !== '';
            if (aExploreFormations && metiersExplores === 0) {
                surprisesPossibles.push({
                    title: "Connecte les points !",
                    content: "Tu as commenc√© √† explorer des formations, c'est g√©nial ! Pour bien comprendre o√π elles m√®nent, n'oublie pas de remplir l'√©tape <strong>'Les Fondations'</strong> pour d√©couvrir les m√©tiers concrets auxquels elles pr√©parent."
                });
            }

            // Si l'√©l√®ve est en Terminale et que la date approche de Parcoursup (Janvier)
            const isTerminale = userGradeLevel === 'terminale';
            const isParcoursupTime = new Date().getMonth() >= 0 && new Date().getMonth() <= 2; // Janvier √† Mars
            const candidatureVide = !journalData.step6.formation || journalData.step6.formation.trim() === '';
            if (isTerminale && isParcoursupTime && candidatureVide) {
                surprisesPossibles.push({
                    title: "Parcoursup approche !",
                    content: "La p√©riode de formulation des v≈ìux est ouverte ! Pense √† utiliser l'√©tape <strong>'Pr√©parer sa candidature'</strong> pour commencer √† r√©diger tes projets de formation motiv√©s. Chaque minute pass√©e dessus est un bon investissement !"
                });
            }
            
            // Si l'√©l√®ve a fait un quiz et a eu un mauvais score
            const aFaitUnQuiz = journalData.step7.domaine && journalData.step7.scores[journalData.step7.domaine];
            if(aFaitUnQuiz) {
                const lastQuiz = journalData.step7.scores[journalData.step7.domaine].slice(-1)[0];
                if(lastQuiz && (lastQuiz.score / lastQuiz.total) < 0.5) {
                    surprisesPossibles.push({
                        title: "L'erreur est une √©tape !",
                        content: `Ne t'inqui√®te pas pour ton dernier score au quiz sur "${journalData.step7.domaine}". Le plus important est ce que tu as appris ! Relis tes notes et n'h√©site pas √† explorer ce domaine dans l'√©tape <strong>'L'Actu'</strong> pour approfondir.`
                    });
                }
            }
            
            // --- 3. SURPRISES LI√âES √Ä L'ACTION (√âTAPES 8 √† 12) ---

            // Si l'√©l√®ve n'a ajout√© aucun contact
            const aAucunContact = !journalData.step8.contacts || journalData.step8.contacts.length === 0;
            if(metiersExplores > 0 && aAucunContact) {
                 surprisesPossibles.push({
                    title: "Passe √† la vitesse sup√©rieure !",
                    content: "La recherche en ligne, c'est bien. Le contact humain, c'est mieux ! Utilise l'√©tape <strong>'Passer √† l'action'</strong> pour trouver des professionnels √† qui poser tes questions."
                });
            }
            
            // Si le r√©troplanning a √©t√© g√©n√©r√© mais aucune t√¢che n'est coch√©e apr√®s un certain temps
            // (Cette logique n√©cessiterait de stocker la date de g√©n√©ration, donc on simplifie)
            
            // Si l'√©l√®ve est en Terminale et n'a pas encore r√©fl√©chi √† un plan B
            const planBVide = !journalData.step9.planb_chat_history || journalData.step9.planb_chat_history.length === 0;
            if(isTerminale && aExploreFormations && planBVide) {
                 surprisesPossibles.push({
                    title: "Et si... ?",
                    content: "C'est super d'avoir des objectifs clairs ! Mais les meilleurs strat√®ges ont toujours un plan B. Prends 5 minutes pour lancer la simulation de <strong>'Plan B'</strong> dans l'√©tape 'Anticiper la suite'. Mieux vaut pr√©venir que gu√©rir !"
                });
            }

            // Si le simulateur de vie √©tudiante n'a pas √©t√© utilis√©
            const aUtiliseSimulateurVieEtu = journalData.step12 && journalData.step12.city;
            if(aExploreFormations && !aUtiliseSimulateurVieEtu) {
                surprisesPossibles.push({
                    title: "Un d√©tail qui compte...",
                    content: "Tu as trouv√© des formations qui t'int√©ressent, bravo ! As-tu pens√© au co√ªt de la vie sur place ? Utilise le <strong>'Simulateur Vie √âtudiante'</strong> pour te faire une id√©e concr√®te."
                });
            }
            
            // --- 4. SURPRISES LI√âES √Ä LA GAMIFICATION (XP, BADGES) ---
            
            // Si l'√©l√®ve est proche de passer un niveau
            const xpToNextLevel = xpNeededForLevel - xpInCurrentLevel;
            if(xpToNextLevel > 0 && xpToNextLevel < 50) {
                 surprisesPossibles.push({
                    title: "Presque ! üí™",
                    content: `Il ne te manque que <strong>${xpToNextLevel} XP</strong> pour atteindre le niveau suivant ! Une petite action comme utiliser le Radar ou faire un quiz pourrait te faire passer au rang de <strong>${rankNames[currentLevel + 1]['autre']}</strong> !`
                });
            }
            
            // Si l'√©l√®ve n'a aucun badge
            if(journalData.earned_badges.length === 0 && metiersExplores > 0) {
                 surprisesPossibles.push({
                    title: "Collectionne-les tous !",
                    content: "Savais-tu que tu pouvais d√©bloquer des badges en compl√©tant certaines √©tapes ? Par exemple, le <strong>Badge de l'Explorateur</strong> r√©compense ceux qui terminent les premi√®res √©tapes cl√©s. Consulte le guide pour en savoir plus !"
                });
            }
            
            // --- 5. SURPRISES G√âN√âRALES ---
            
            // Rappel de mettre √† jour le Fil Rouge
            if(journalData.xp > 500 && (!journalData.fil_rouge || journalData.fil_rouge.length < 20)) {
                 surprisesPossibles.push({
                    title: "Fais le point !",
                    content: "Tu as d√©j√† beaucoup explor√© ! C'est peut-√™tre le bon moment pour mettre √† jour ton <strong>'Fil Rouge'</strong> dans le Journal de Bord. L'IA peut t'aider √† synth√©tiser ton parcours."
                });
            }
            
            // Encouragement √† partager
            const aPartage = journalData.share_token;
            if(journalData.xp > 300 && !aPartage) {
                 surprisesPossibles.push({
                    title: "Et si on en parlait ?",
                    content: "Parler de son orientation, c'est essentiel. Pense √† utiliser la fonction de <strong>partage</strong> de ton Journal de Bord pour √©changer avec tes parents ou ton professeur principal."
                });
            }

            // --- S√©lection et affichage d'une surprise al√©atoire parmi les possibles ---
            if (surprisesPossibles.length > 0) {
                const surpriseFinale = surprisesPossibles[Math.floor(Math.random() * surprisesPossibles.length)];
                showSurpriseModal(surpriseFinale.title, surpriseFinale.content);
            }
        }

    async function loadData() {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            const docSnap = await getDoc(userDocRef);
            
            const defaultData = {
                step0: { 
                q1: '', q2: '', q3: '', q4: '', q5: '', q6: '', q7: '', q8: '', q9: '', q10: '', 
                q11: '', q12: '', q13: '', q14: '', q15: '', q16: '', q17: '', q18: '', q19: '', q20: '', q21: '', 
                analysis: '', 
                archetype: null, 
                test_interets: '',
                test_motivation: '',
                test_personnalite: '',
                analyse_tests_croisee: '' },    
                step1: { metier1: '', notes1: '', metier2: '', notes2: '', metier3: '', notes3: '' },
                step2: { combo1: '', notes1: '', skills1: '', combo2: '', notes2: '', skills2: '', combo3: '', notes3: '', skills3: '' },
                step3: { formation1: '', attendus1: '', mots_cles1: '', analyse_mots_cles1: '', formation2: '', attendus2: '', mots_cles2: '', analyse_mots_cles2: '', suggestions: '' },
                step4: { theme1: '', question1: '', suggestions1: '', theme2: '', question2: '', suggestions2: '' },
                step5: {
                article1: '', apprentissage1: '',
                article2: '', apprentissage2: '',
                article3: '', apprentissage3: '',
                analyse_actu: ''
            },
                step6: { formation: '', motivations: '', structure: '' },
                step7: { 
                domaine: '', 
                reflexions: '',
                scores: {}
            },
                step8: { pro_reseau_personnel: '', pro_metier: '', pro_departement: '', pro_contacts: '', pro_strategie: '', pro_media_query: '', pro_media_content: '', jpo_ecole: '', jpo_questions: '' },
                step9: { 
                formation_reve: '', 
                planb_chat_history: [],
                reussite_type: '', 
                reussite_conseils: '' 
            },
                step10: { experience1: '', analyse1: '', experience2: '', analyse2: '' },
                step11: { 
                location: '', 
                evenements: [], 
                structures: [],
                jpo_ecole: '',
                jpo_questions: '',
                salon_nom: '',
                salon_preparation: ''
            },
                retroplanning: '',
                fil_rouge: '',
                discussion_points: '',
                radar_history: [],
                earned_badges: [],
                xp: 0,
                level: 1,
                chatbot_last_interaction: null,
                chatbot_saves: []
            };
            
            let data = docSnap.exists() ? docSnap.data() : {};
            
            userGradeLevel = data.gradeLevel || null;
            currentUserInfo = {
                firstName: data.firstName || '',
                lastName: data.lastName || '',
                schoolName: data.schoolName || '',
                gender: data.gender || 'autre' // <-- AJOUTEZ CETTE LIGNE (avec une valeur par d√©faut)

            };

        
            const loadedJournal = data.journal || {};
            
            journalData = {};
            for (const key in defaultData) {
        // On ajoute une condition sp√©ciale pour les tableaux (Array)
        if (Array.isArray(defaultData[key])) {
            journalData[key] = loadedJournal[key] || defaultData[key];
        }
        // La logique existante pour les objets
        else if (loadedJournal[key] && typeof defaultData[key] === 'object' && defaultData[key] !== null) {
            journalData[key] = { ...defaultData[key], ...loadedJournal[key] };
        } 
        // La logique par d√©faut pour le reste
        else {
             journalData[key] = loadedJournal[key] || defaultData[key];
        }
    }
    
    // Cette v√©rification suppl√©mentaire est une bonne pratique
    if (!Array.isArray(journalData.radar_history)) {
        journalData.radar_history = [];
    }
    if (!Array.isArray(journalData.earned_badges)) {
        journalData.earned_badges = [];
    }
    
    checkBadges();

    const currentSchoolYear = getCurrentSchoolYear();
    if (data.lastLoginSchoolYear !== currentSchoolYear || !userGradeLevel) {
        showGradeSelectionView();
    } else {
        showView('menu');
    }
    
    await setDoc(userDocRef, { lastLoginSchoolYear: currentSchoolYear }, { merge: true });
}

    function getProfileSummary() {
            let summary = "Voici un r√©sum√© du profil de l'√©l√®ve :\n";

            if (journalData.step0 && journalData.step0.archetype) {
                summary += `- Son arch√©type de personnalit√© : ${journalData.step0.archetype.titre}\n`;
            }
            if (journalData.step0 && journalData.step0.analysis) {
                summary += `- Analyse de son profil : "${journalData.step0.analysis}"\n`;
            }

            const metiers = [journalData.step1.metier1, journalData.step1.metier2, journalData.step1.metier3].filter(m => m && m.trim());
            if (metiers.length > 0) {
                summary += `- M√©tiers d√©j√† explor√©s : ${metiers.join(', ')}\n`;
            }

            const formations = [journalData.step3.formation1, journalData.step3.formation2].filter(f => f && f.trim());
            if (formations.length > 0) {
                summary += `- Formations d√©j√† explor√©es : ${formations.join(', ')}\n`;
            }

            if (journalData.step10 && journalData.step10.soft_skills_profile) {
                summary += `- R√©sum√© de ses comp√©tences : "${journalData.step10.soft_skills_profile}"\n`;
            }
            
            if (summary === "Voici un r√©sum√© du profil de l'√©l√®ve :\n") {
                return "L'√©l√®ve n'a pas encore rempli suffisamment son profil. Base-toi sur le bon sens et l'id√©e qu'il propose.";
            }

            return summary;
        }

        function getCompletionSummary() {
            let completed = [];
            let inProgress = [];

            allSteps.forEach(step => {
                if (['journal', 'retroplanning', 'guide'].includes(step.id)) return;

                if (isStepComplete(step.id)) {
                    completed.push(`'${step.icon} ${step.title}'`);
                } else {
                    const stepData = journalData[step.id];
                    if (stepData) {
                        const values = Object.values(stepData);
                        const filledCount = values.filter(v => {
                            if (Array.isArray(v)) return v.length > 0;
                            return v && v.toString().trim() !== '';
                        }).length;
                        if (filledCount > 0) {
                            inProgress.push(`'${step.icon} ${step.title}'`);
                        }
                    }
                }
            });

            let summary = "Voici un r√©sum√© de sa progression dans l'application :\n";
            if (completed.length > 0) {
                summary += `- √âtapes d√©j√† termin√©es : ${completed.join(', ')}.\n`;
            }
            if (inProgress.length > 0) {
                summary += `- √âtapes actuellement en cours : ${inProgress.join(', ')}.\n`;
            }
            if (completed.length === 0 && inProgress.length === 0) {
                summary += "- L'√©l√®ve n'a pas encore commenc√© √† explorer les √©tapes.\n";
            }
            return summary;
        }

    async function grantXp(points) {
            if (!journalData) return;

            journalData.xp = (journalData.xp || 0) + points;
            let currentLevel = journalData.level || 1;
            let leveledUp = false; // On utilise un indicateur pour savoir si un niveau a √©t√© gagn√©

            // On v√©rifie si l'utilisateur passe un ou plusieurs niveaux
            while (levelConfig[currentLevel + 1] && journalData.xp >= levelConfig[currentLevel + 1]) {
                currentLevel++;
                journalData.level = currentLevel;
                leveledUp = true;
            }
            
            // On sauvegarde les nouvelles donn√©es (XP et niveau)
            await saveData();

            // Si un niveau a √©t√© gagn√©, on affiche la nouvelle fen√™tre personnalis√©e
            if (leveledUp) {
                // CORRECTION DU BUG [object Object] : On s√©lectionne le bon titre
                const userGender = currentUserInfo.gender || 'autre';
                const rankTitle = rankNames[journalData.level][userGender] || rankNames[journalData.level]['autre'];

                const title = `üéâ Mont√©e de Niveau !`;
                const contentHTML = `
                    <p class="text-slate-600">Bravo, tu as atteint le</p>
                    <p class="text-2xl font-bold text-cyan-700 my-2">Niveau ${journalData.level} : ${rankTitle}</p>
                    <p class="text-slate-600">Continue sur cette lanc√©e pour d√©couvrir tout ton potentiel !</p>
                `;
                
                // On r√©utilise la fonction d'affichage des surprises pour un design coh√©rent
                showSurpriseModal(title, contentHTML);
            }

            // On met √† jour l'affichage du menu s'il est actuellement visible
            const menuView = document.querySelector('.fade-in');
            if (menuView && menuView.querySelector('#xp-chart')) {
                showView('menu');
            }
    
        }
        
        function showGradeSelectionView() {
            mainApp.innerHTML = `
                <div class="bg-white p-8 rounded-2xl shadow-lg border border-slate-200 fade-in text-center">
                    <h1 class="text-2xl font-bold text-slate-800 mb-4">Bienvenue, ${currentUserInfo.firstName} !</h1>
                    <p class="text-slate-600 mb-6">Pour personnaliser ton parcours, s√©lectionne ta classe :</p>
                    <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                        <button data-grade="seconde" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700">Seconde</button>
                        <button data-grade="premiere" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700">Premi√®re</button>
                        <button data-grade="terminale" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700">Terminale</button>
                    </div>
                </div>
            `;
            document.querySelectorAll('.grade-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    userGradeLevel = e.target.dataset.grade;
                    await saveData();
                    showView('menu');
                });
            });

        }

       // REMPLACEZ VOTRE FONCTION callGeminiAPI ACTUELLE PAR CELLE-CI :

async function callGeminiAPI(prompt, useGrounding = false, isJson = false) {
    
    // Fonction de nettoyage interne pour √©viter la r√©p√©tition
    const cleanResponse = (text) => {
        if (!isJson && text && typeof text === 'string') {
            return text.replace(/[#*]/g, '');
        }
        return text;
    };

    const functionUrl = "https://us-central1-monapp0rientation.cloudfunctions.net/generateContent"; 

    try {
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt,
                useGrounding: useGrounding,
                isJson: isJson
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Erreur du serveur: ${errorData.error || response.statusText}`);
        }

        const data = await response.json();
        // On nettoie la r√©ponse en cas de succ√®s
        return cleanResponse(data.result);

    } catch (error) {
        console.error("Error calling Cloud Function:", error);
        const errorMessage = `Impossible de contacter le service d'IA. (${error.message})`;
        // On nettoie aussi le message d'erreur au cas o√π
        return cleanResponse(errorMessage);
    }
}
        
    // REMPLACEZ VOTRE showView EXISTANTE PAR CELLE-CI :
async function showView(viewName) {
    mainApp.innerHTML = '';
    
    if (viewName === 'menu') {
        triggerSurpriseMoment();
    }
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const floatingBackBtn = document.getElementById('floatingBackBtn');

    const showChatbotOn = ['menu', 'home', 'step0', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9', 'step10', 'step11', 'step12', 'retroplanning', 'journal'];
    const showBackButtonOn = ['step0', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9', 'step10', 'step11', 'step12', 'retroplanning', 'journal', 'guide'];

    if (chatbotToggle) {
        if (showChatbotOn.includes(viewName)) {
            chatbotToggle.style.display = 'flex';
        } else {
            chatbotToggle.style.display = 'none';
        }
    }
    
    if (floatingBackBtn) {
        // La condition "!(viewName === 'guide' && cameFromLogin)" est cruciale ici
        // Elle cache le bouton sur le guide si on vient de la page de connexion
        if (showBackButtonOn.includes(viewName) && !(viewName === 'guide' && cameFromLogin)) {
            floatingBackBtn.style.display = 'flex';
        } else {
            floatingBackBtn.style.display = 'none';
        }
    }

    let newView;
    switch(viewName) {
        case 'home': newView = createHomeView(); break;
        case 'menu': newView = createMenuView(); break;
        case 'step0': newView = createStep0View(); break;
        case 'step1': newView = createStep1View(); break;
        case 'step2': newView = createStep2View(); break;
        case 'step3': newView = createStep3View(); break;
        case 'step4': newView = createStep4View(); break;
        case 'step5': newView = createStep5View(); break;
        case 'step6': newView = createStep6View(); break;
        case 'step7': newView = createStep7View(); break;
        case 'step8': newView = createStep8View(); break;
        case 'step9': newView = createStep9View(); break;
        case 'step10': newView = createStep10View(); break;
        case 'step11': newView = createStep11View(); break;
        case 'step12': newView = createStep12View(); break;
        case 'guide': newView = createGuideView(); break;
        case 'retroplanning': newView = createRetroplanningView(); break;
        case 'journal': newView = await createJournalView(); break; 
        default: newView = createHomeView();
    }
    if (newView) mainApp.appendChild(newView);
    window.scrollTo(0, 0);
}

        function createHomeView() {
            return createMenuView();
        }
        

function createMenuView() {
    const div = document.createElement('div');
    div.className = 'fade-in';

    // --- Calculs et pr√©paration des donn√©es (inchang√©s) ---
    const currentLevel = journalData.level || 1;
    const currentXp = journalData.xp || 0;
    const xpForCurrentLevel = levelConfig[currentLevel];
    const xpForNextLevel = levelConfig[currentLevel + 1];
    const xpInCurrentLevel = currentXp - xpForCurrentLevel;
    const xpNeededForLevel = xpForNextLevel - xpForCurrentLevel;
    const userGender = currentUserInfo.gender || 'autre';
    const rankTitle = rankNames[currentLevel][userGender] || rankNames[currentLevel]['autre'];
    
    let badgesHTML = '<h3 class="font-bold text-slate-800 text-center text-xs mb-1">Mes Badges</h3>';
    const earnedBadges = journalData.earned_badges || [];
    if (earnedBadges.length > 0) {
        badgesHTML += '<div class="flex justify-center gap-2">';
        badgesHTML += earnedBadges.map(key => {
            const badge = badgesConfig[key];
            return badge ? `<span title="${badge.title}" class="text-3xl cursor-default">${badge.icon}</span>` : '';
        }).join('');
        badgesHTML += '</div>';
    } else {
        badgesHTML += '<p class="text-xs text-slate-500 text-center">Aucun badge d√©bloqu√©.</p>';
    }


    // --- NOUVELLE STRUCTURE HTML AVEC MISE EN PAGE ADAPTATIVE ---
    const levelDisplayHTML = `
        <div class="mb-10 bg-white p-6 rounded-2xl shadow-lg border border-slate-200 grid grid-cols-2 md:grid-cols-3 gap-6 items-center">
            
            <div class="text-center col-span-2 md:col-span-1 md:col-start-2 md:row-start-1">
                <h1 class="text-3xl font-bold text-slate-800">Bienvenue, ${currentUserInfo.firstName} !</h1>
                <p class="text-slate-500 mt-1 text-sm">Classe : <span class="font-semibold text-cyan-600">${userGradeLevel ? userGradeLevel.charAt(0).toUpperCase() + userGradeLevel.slice(1) : ''}</span> √† <span class="font-semibold text-cyan-600">${capitalizeWords(currentUserInfo.schoolName)}</span></p>
                <h2 class="text-xl font-bold text-cyan-700 mt-3">Niveau d'Exploration ${currentLevel} : ${rankTitle}</h2>
                    <div class="flex justify-center items-center gap-2 mt-3 text-sm whitespace-nowrap">
                    <button id="changeGradeButton" class="text-cyan-600 hover:underline">Modifier ma classe</button>
                    <span class="text-slate-400">|</span>
                    <button id="logoutButton" class="text-sm text-cyan-600 hover:underline">Se d√©connecter</button>
                </div>
            </div>

            <div id="xp-gauge-container" class="relative w-32 h-32 mx-auto cursor-pointer md:col-start-1 md:row-start-1">
                <canvas id="xp-chart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                    <span class="font-bold text-2xl text-slate-800">${xpInCurrentLevel}</span>
                    <span class="text-xs text-slate-500">/${xpNeededForLevel} XP</span>
                </div>
            </div>

            <div id="badges-container" class="w-32 h-32 mx-auto bg-slate-50 rounded-full border border-slate-200 flex flex-col items-center justify-center p-2 cursor-pointer">
                ${badgesHTML}
            </div>

        </div>
    `;
    
    // --- 4. Le reste de votre code (barre de progression, grille, etc.) ---
    // (J'inclus le reste du code pour √™tre s√ªr que tout est complet)
    const allStepsForLevel = allSteps.filter(step => step.levels.includes(userGradeLevel));
    const completedStepsCount = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id) && isStepComplete(step.id)).length;
    const totalTrackableSteps = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id)).length;
    const progressPercentage = totalTrackableSteps > 0 ? (completedStepsCount / totalTrackableSteps) * 100 : 0;
    const progressBarHTML = `
        <div class="max-w-xl mx-auto mb-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-cyan-700">Progression des √âtapes</span>
                <span class="text-sm font-medium text-cyan-700">${Math.round(progressPercentage)}%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
            </div>
        </div>`;
    const guideCardHTML = `
        <div onclick="window.showView('guide')" class="step-card bg-white p-4 rounded-xl shadow-md border border-slate-200 cursor-pointer flex flex-col items-center space-y-2 mb-6 max-w-md mx-auto">
            <div class="text-3xl">‚ùì</div>
            <div class="text-center">
                <h2 class="text-lg font-semibold text-slate-800">Guide d'Utilisation</h2>
                <p class="text-sm text-slate-500">Besoin d'aide pour commencer ?</p>
            </div>
        </div>`;
    let steps = allStepsForLevel;
    let gridContainerClasses = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-8";
    let gridItemClasses = "";
    if (userGradeLevel === 'seconde' || userGradeLevel === 'terminale') {
        gridContainerClasses = "flex flex-wrap justify-center gap-6 mt-8";
        gridItemClasses = "w-full md:w-[48%] lg:w-[31%]";
    }
    let gridHTML = steps.map((step, index) => {
        let statusSymbol = '';
         if (!['journal', 'retroplanning', 'step12'].includes(step.id) && journalData[step.id]) {
             if(isStepComplete(step.id)){
                 statusSymbol = '<span class="ml-2 text-green-500 font-bold">‚úî</span>';
             } else {
                const stepData = journalData[step.id];
                const values = Object.values(stepData);
                const filledCount = values.filter(v => v && v.toString().trim() !== '').length;
                if(filledCount > 0) {
                    statusSymbol = '<span class="ml-2 text-orange-400 font-bold">‚úî</span>';
                }
             }
        }
        const isLastItemCentered = (steps.length % 3 === 1 && userGradeLevel === 'premiere');
        const lastItemIndex = steps.length - 1;
        const centeredClass = (isLastItemCentered && index === lastItemIndex) ? 'lg:col-start-2' : '';
         return `
        <div onclick="window.showView('${step.id}')" class="step-card bg-white p-6 rounded-xl shadow-md border border-slate-200 cursor-pointer flex flex-col items-center space-y-2 text-center ${centeredClass} ${gridItemClasses}">
            <div class="text-3xl">${step.icon}</div>
            <div>
                <div class="flex justify-center items-center">
                     <h2 class="text-lg font-semibold text-slate-800">${step.title}</h2>
                     ${statusSymbol}
                </div>
                <p class="text-slate-500">${step.site}</p>
            </div>
        </div>`;
    }).join('');
    const radarHTML = `
        <div class="mt-12 text-center fade-in">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üì° Le Radar √† Opportunit√©s</h2>
            <p class="text-slate-600 max-w-2xl mx-auto mb-6">Teste ici tes propres id√©es de m√©tiers ou laisse l'IA t'en proposer une √† laquelle tu n'aurais jamais pens√© !</p>
            <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="text" id="radarInput" class="w-full md:flex-1 p-3 border border-slate-300 rounded-lg" placeholder="Propose un m√©tier ou un domaine...">
                    <button id="radarAnalyzeBtn" class="w-full md:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Analyser mon id√©e</button>
                </div>
                <div class="my-4 text-slate-500 font-semibold">OU</div>
                <button id="radarSurpriseBtn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Me surprendre !</button>
            </div>
            <div id="radarLoader" class="hidden"><div class="loader"></div></div>
            <div id="radarResult" class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-slate-700 whitespace-pre-wrap text-left hidden"></div>
        </div>
        </div>`;

    div.innerHTML = levelDisplayHTML + progressBarHTML + guideCardHTML + `<div class="${gridContainerClasses}">${gridHTML}</div>` + radarHTML;
    
    setTimeout(() => {
        const ctx = div.querySelector('#xp-chart')?.getContext('2d');
        if (!ctx) return;
        const xpRemaining = Math.max(0, xpNeededForLevel - xpInCurrentLevel);
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [xpInCurrentLevel, xpRemaining],
                    backgroundColor: ['#f59e0b', '#e2e8f0'],
                    borderColor: ['#ffffff', '#ffffff'],
                    borderWidth: 2,
                    circumference: 360,
                }]
            },
            options: {
                responsive: true,
                cutout: '80%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    }, 0);

    const loader = div.querySelector('#radarLoader');
    const resultDiv = div.querySelector('#radarResult');
    const radarInput = div.querySelector('#radarInput');

    div.querySelector('#radarAnalyzeBtn').addEventListener('click', async () => {
        const userInput = radarInput.value.trim();
        if (!userInput) {
            alert("Veuillez entrer un m√©tier ou un domaine √† analyser.");
            return;
        }
        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        resultDiv.classList.add('hidden'); // On cache le r√©sultat pr√©c√©dent

        
        const profileSummary = getProfileSummary();
        const prompt = `Agis comme un conseiller d'orientation bienveillant mais r√©aliste. Un lyc√©en te propose de consid√©rer le m√©tier : "${userInput}". Voici le r√©sum√© de son profil : ${profileSummary}. Donne un retour structur√© en 3 points : 1. Points de Connexion. 2. Points de Vigilance. 3. Premi√®re Mission d'Exploration. sois enthousiaste et bienveillant, comme un coach qui croit en son √©l√®ve et adresse √† lui en utilisant le tutoiement.`;

        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none';
        resultDiv.classList.remove('hidden'); // On affiche le conteneur


        // Affiche la r√©ponse de l'IA AVEC les nouveaux boutons
        resultDiv.innerHTML = `
            <p class="whitespace-pre-wrap">${result}</p>
            <div class="flex gap-4 mt-4 pt-4 border-t">
                <button id="radar-save-btn" class="flex-1 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition">Enregistrer dans le journal</button>
                <button id="radar-close-btn" class="flex-1 bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition">Je vais r√©fl√©chir √† autre chose</button>
            </div>
        `;

        // Ajoute l'√©couteur pour le bouton "Enregistrer"
        resultDiv.querySelector('#radar-save-btn').addEventListener('click', async () => {
            if (!Array.isArray(journalData.radar_history)) { journalData.radar_history = []; }
            journalData.radar_history.push({ type: 'Analyse', sujet: userInput, reponse: result });
            await grantXp(25); // Le rafra√Æchissement se fait ici
        });

        // Ajoute l'√©couteur pour le bouton "Fermer"
        resultDiv.querySelector('#radar-close-btn').addEventListener('click', async () => {
            await grantXp(25); // Le rafra√Æchissement se fait ici
        });
    });

    div.querySelector('#radarSurpriseBtn').addEventListener('click', async () => {
        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        resultDiv.classList.add('hidden');
        
        if (!Array.isArray(journalData.radar_history)) { journalData.radar_history = []; }
        const previousSuggestions = journalData.radar_history.map(h => h.sujet).filter(Boolean).join('", "');
        let historyPrompt = "";
        if (previousSuggestions) {
            historyPrompt = `Important : pour garantir la diversit√©, √©vite de proposer les pistes suivantes qui ont d√©j√† √©t√© sugg√©r√©es : "${previousSuggestions}".`;
        }
        const appStepsList = allSteps.map(s => `'${s.icon} ${s.title}'`).join(', ');

        // --- NOUVELLE LOGIQUE : S√©lection d'un angle al√©atoire ---
        const randomAngle = creativeAngles[Math.floor(Math.random() * creativeAngles.length)];
        const profileSummary = getProfileSummary();
        
        // --- NOUVEAU PROMPT : L'IA doit r√©soudre un "puzzle cr√©atif" ---
        const prompt = `Agis comme un coach d'orientation extr√™mement cr√©atif et perspicace. Tu t'adresses √† un lyc√©en.
        
        Voici le r√©sum√© de son profil :
        ${profileSummary}
        ${historyPrompt}

        Ta mission est de trouver un lien **surprenant et intelligent** entre le profil de l'√©l√®ve et l'angle cr√©atif suivant : **${randomAngle}**. sois enthousiaste et bienveillant. Base toi sur le site onisep.fr pour imaginer un m√©tier ou un secteur d'activit√© qui pourrait correspondre, m√™me de loin, √† cet angle cr√©atif.

        R√©dige ta r√©ponse en 5 parties distinctes et bien visibles :
        1.  **Piste Inattendue :** Commence ta phrase par "Tu pourrais envisager..." puis propose un nom de m√©tier ou de secteur pr√©cis.
        2.  **D√©cris une une dizaine de phrases ce m√©tier ou secteur, en quoi il consiste, les activit√©s principales, le contexte de travail, les qualit√©s requises, les d√©bouch√©s possibles. Utilise un langage simple et √©vocateur.**
        3.  **Les √©tudes :** Pr√©cise les parcours scolaires et les formations n√©cessaires pour acc√©der √† ce m√©tier ou secteur.
        4.  **Pourquoi je pense que c'est fait pour toi :** Justifie ton choix en 5 ou 6 phrases, en te basant sur les √©l√©ments du profil.
        5.  **Pour aller plus loin dans l'appli :** Sugg√®re 1 ou 2 √©tapes sp√©cifiques de l'application "Mon Explor'Orientation" qui l'aideraient √† approfondir cette piste. Tu dois utiliser les noms exacts des √©tapes disponibles, qui sont : ${appStepsList}.

        Sois enthousiaste et bienveillant, comme un coach qui croit en son √©l√®ve et adresse √† lui en utilisant le tutoiement.`;
        
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none';
        resultDiv.classList.remove('hidden');

        resultDiv.innerHTML = `
            <p class="whitespace-pre-wrap">${result}</p>
            <div class="flex gap-4 mt-4 pt-4 border-t">
                <button id="radar-save-btn" class="flex-1 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition">Carr√©ment, super id√©e, je garde</button>
                <button id="radar-close-btn" class="flex-1 bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition">Pas int√©ress√©</button>
            </div>
        `;

        resultDiv.querySelector('#radar-save-btn').addEventListener('click', async () => {
            const trackNameMatch = result.match(/(?:Piste Inattendue|Tu pourrais envisager)\s*:\s*(.*?)\n/);
            const trackName = trackNameMatch && trackNameMatch[1] ? trackNameMatch[1].trim() : "Piste inattendue";
            journalData.radar_history.push({ type: 'Surprise', sujet: trackName, reponse: result });
            if (journalData.radar_history.length > 10) {
                journalData.radar_history.shift();
            }
            await grantXp(25);
        });

        resultDiv.querySelector('#radar-close-btn').addEventListener('click', async () => {
            await grantXp(25);
        });
    });


    div.querySelector('#changeGradeButton').addEventListener('click', () => {
        showGradeSelectionView();
    });

    div.querySelector('#logoutButton').addEventListener('click', async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error("Erreur lors de la d√©connexion :", error);
            alert("Impossible de se d√©connecter, veuillez r√©essayer.");
        }
    });


    div.querySelector('#xp-gauge-container').addEventListener('click', () => {
        const title = "‚≠ê Qu'est-ce que le syst√®me d'XP ?";
        const contentHTML = `
            <div class="space-y-4 text-slate-600">
                <p>Le syst√®me de Points d'Exp√©rience (XP) transforme ton parcours d'orientation en une aventure ! Chaque action importante te rapporte des points pour mat√©rialiser ta progression.</p>
                <div class="p-4 bg-slate-50 rounded-lg border">
                    <h4 class="font-semibold text-slate-800 mb-2">Comment √ßa marche ?</h4>
                    <p>Tes XP remplissent la jauge circulaire. Une fois pleine, tu passes au niveau sup√©rieur et gagnes un nouveau rang, montrant que tu avances dans ta qu√™te !</p>
                </div>
                <div class="p-4 bg-slate-50 rounded-lg border">
                    <h4 class="font-semibold text-slate-800 mb-2">Comment gagner des XP ?</h4>
                    <ul class="list-disc list-inside text-sm">
                        <li>En analysant ton profil ("Mieux se conna√Ætre").</li>
                        <li>En g√©n√©rant ton R√©troplanning.</li>
                        <li>En valorisant une exp√©rience dans ton Portfolio.</li>
                        <li>En obtenant un bon score √† un quiz "Fact Checking".</li>
                        <li>En utilisant le Radar √† Opportunit√©s.</li>
                    </ul>
                </div>
            </div>
        `;
        createSimpleModal(title, contentHTML);
    });

    div.querySelector('#badges-container').addEventListener('click', () => {
        const title = "üèÜ Qu'est-ce que le syst√®me de Badges ?";
        let contentHTML = `
            <div class="space-y-4 text-slate-600">
                <p>Les badges sont des r√©compenses sp√©ciales que tu d√©bloques en accomplissant des ensembles d'√©tapes cl√©s. Ils symbolisent tes grandes r√©ussites dans ton parcours d'orientation !</p>
                <div class="space-y-3">
        `;
        
        for (const key in badgesConfig) {
            const badge = badgesConfig[key];
            const earned = earnedBadges.includes(key);
            contentHTML += `
                <div class="flex items-start gap-4 p-3 rounded-lg ${earned ? 'bg-amber-50 border border-amber-200' : 'bg-slate-50 border border-slate-200'}">
                    <span class="text-4xl ${earned ? '' : 'opacity-40'}">${badge.icon}</span>
                    <div>
                        <h4 class="font-bold ${earned ? 'text-amber-800' : 'text-slate-800'}">${badge.title} ${earned ? '(Obtenu !)' : '(√Ä d√©bloquer)'}</h4>
                        <p class="text-sm">${badge.description}</p>
                    </div>
                </div>
            `;
        }

        contentHTML += `</div></div>`;
        createSimpleModal(title, contentHTML);
    });

    return div;
}
        
        function createStepView(config) {
            const div = document.createElement('div');
            div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';
            
            let formFields = '';
            if (config.fields) {
                formFields = config.fields.map(field => {
                    const value = (journalData[config.stepKey] && journalData[config.stepKey][field.id]) || '';
                    const isReadonly = field.isReadonly ? 'readonly' : '';
                    const bgColor = isReadonly ? 'bg-slate-50' : 'bg-white';
                    return `
                    <div class="mb-6">
                        <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                        ${field.type === 'textarea' ? `<textarea id="${field.id}" name="${field.id}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" ${isReadonly}>${value}</textarea>` : `<input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" value="${value}" ${isReadonly}>`}
                    </div>
                `}).join('');
            }

            let description = config.description;
            if(typeof description === 'object') {
                description = description[userGradeLevel] || description['default'] || '';
            }

            let action = config.action;
            if(typeof action === 'object') {
                action = action[userGradeLevel] || action['default'] || '';
            }

            let linksHTML = '';
    if (config.urls) {
        linksHTML = config.urls.map(link => 
            `<a href="${link.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition mr-2 mb-2">Visiter ${link.site} ‚Üó</a>`
        ).join('');
    } else if (config.url) {
        linksHTML = `<a href="${config.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter ${config.site} ‚Üó</a>`;
    }

    div.innerHTML = `
<h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap mb-6">${config.icon} ${config.title}</h1>
<div class="text-slate-600 mb-4 whitespace-pre-wrap">${description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${action}</div></div>
        <div class="mb-8">${linksHTML}</div>
        <form id="stepForm">
            ${formFields}
            <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
        </form>
    `;
            
            div.querySelector('#stepForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const stepKey = config.stepKey;
                if (!journalData[stepKey]) journalData[stepKey] = {};

                for (const [key, newValue] of formData.entries()) {
                     journalData[stepKey][key] = newValue; 
                }
                
                checkBadges();
                await saveData();
                showView('menu');
            });

            return div;
        }
        



// REMPLACEZ VOTRE FONCTION createProfileInfographic EXISTANTE PAR CELLE-CI :
function createProfileInfographic(step0Data, context = 'user') {
    if (!step0Data || !step0Data.analysis) {
        return document.createElement('div');
    }

    const container = document.createElement('div');
    container.className = 'mb-8';

    const titleText = context === 'user' ? 'Synth√®se visuelle de mon profil' : 'Synth√®se visuelle de son profil';

    container.innerHTML = `
        <h2 class="text-xl font-bold border-b pb-2 mb-4 text-cyan-700">${titleText}</h2>
        <div class="bg-slate-50 p-4 md:p-6 rounded-xl border border-slate-200 mt-4">
            <h3 class="text-lg font-bold text-slate-800 mb-2">Votre Profil d'Int√©r√™ts (RIASEC)</h3>
            <canvas id="profileBarChart"></canvas>
        </div>
        <div id="riasec-legend" class="mt-6 text-sm text-slate-600 space-y-2">
            <p><strong class="font-semibold text-slate-800">R (R√©aliste) :</strong> Aime le travail concret, physique, avec des outils ou en plein air.</p>
            <p><strong class="font-semibold text-slate-800">I (Investigateur) :</strong> Aime analyser, comprendre, r√©soudre des probl√®mes complexes.</p>
            <p><strong class="font-semibold text-slate-800">A (Artistique) :</strong> Aime cr√©er, imaginer, s'exprimer de mani√®re non conventionnelle.</p>
            <p><strong class="font-semibold text-slate-800">S (Social) :</strong> Aime aider, former, soigner, √™tre en contact avec les autres.</p>
            <p><strong class="font-semibold text-slate-800">E (Entreprenant) :</strong> Aime diriger, convaincre, mener des projets, prendre des d√©cisions.</p>
            <p><strong class="font-semibold text-slate-800">C (Conventionnel) :</strong> Aime organiser, g√©rer, respecter les r√®gles, travailler avec des donn√©es.</p>
        </div>
    `;

    // On attend un court instant que le canvas soit bien dans le DOM
    setTimeout(() => {
        const ctx = document.getElementById('profileBarChart')?.getContext('2d');
        if (!ctx) return;

        // Logique pour calculer les scores RIASEC √† partir du nouveau questionnaire
        const riasecScores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
        const riasecMapping = {
            q15: { realiste: 'R', investigatif: 'I' },
            q16: { artistique: 'A', social: 'S' },
            q17: { entreprenant: 'E', conventionnel: 'C' },
            q18: { social: 'S', entreprenant: 'E' },
            q19: { artistique: 'A', conventionnel: 'C' },
            q20: { realiste: 'R', artistique: 'A' },
            q21: { social: 'S', investigatif: 'I', realiste: 'R' }
        };

        for (const [questionId, mapping] of Object.entries(riasecMapping)) {
            const answer = step0Data[questionId];
            if (answer && mapping[answer]) {
                const type = mapping[answer];
                riasecScores[type]++;
            }
        }
        
        const labels = ['R√©aliste', 'Investigateur', 'Artistique', 'Social', 'Entreprenant', 'Conventionnel'];
        const dataPoints = [riasecScores.R, riasecScores.I, riasecScores.A, riasecScores.S, riasecScores.E, riasecScores.C];

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Score d\'int√©r√™t',
                    data: dataPoints,
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.6)',    // R - red
                        'rgba(59, 130, 246, 0.6)',   // I - blue
                        'rgba(251, 191, 36, 0.6)',  // A - amber
                        'rgba(34, 197, 94, 0.6)',   // S - green
                        'rgba(249, 115, 22, 0.6)',  // E - orange
                        'rgba(148, 163, 184, 0.6)'  // C - slate
                    ],
                    borderColor: [
                        'rgb(239, 68, 68)',
                        'rgb(59, 130, 246)',
                        'rgb(251, 191, 36)',
                        'rgb(34, 197, 94)',
                        'rgb(249, 115, 22)',
                        'rgb(148, 163, 184)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }, 0);

    return container;
}


        function createQuestionHTML(id, label, options, selectedValue) {
            let optionsHTML = '<option value="">Choisir...</option>';
            for (const [value, data] of Object.entries(options)) {
                optionsHTML += `<option value="${value}" ${selectedValue === value ? 'selected' : ''} title="${data.description}">${data.text}</option>`;
            }
            return `
                <div class="mb-4">
                    <label class="block text-md font-medium text-slate-700 mb-2">${id}. ${label}</label>
                    <select name="q${id}" class="w-full p-3 border border-slate-300 rounded-lg">
                        ${optionsHTML}
                    </select>
                </div>
            `;
        }

        
// REMPLACEZ VOTRE FONCTION createStep0View EXISTANTE PAR CE CODE COMPLET ET FINAL :
// REMPLACEZ VOTRE FONCTION createStep0View EXISTANTE PAR CE CODE COMPLET ET FINAL :
function createStep0View() {
    const config = stepsConfig.step0;
    const div = createStepView({ ...config, fields: [] });
    
    const form = div.querySelector('#stepForm');
    
    const questions = [
        // === Partie 1: Mes Moteurs (7 questions) ===
        { id: 1, part: "Mes Moteurs (Ce qui me motive profond√©ment)", label: 'Pour toi, un m√©tier id√©al doit avant tout...', options: { sens: { text: 'Avoir un impact positif, √™tre utile aux autres' }, securite: { text: 'Offrir de la stabilit√© et une bonne r√©mun√©ration' }, creativite: { text: 'Permettre d\'exprimer mes id√©es et d\'innover' }, autonomie: { text: 'Me laisser beaucoup de libert√© dans mon organisation' } } },
        { id: 2, part: "Mes Moteurs (Ce qui me motive profond√©ment)", label: 'Ce qui te donne le plus d\'√©nergie, c\'est...', options: { defi: { text: 'R√©soudre un probl√®me complexe qui r√©siste' }, maitrise: { text: 'Devenir un expert reconnu dans un domaine pr√©cis' }, collaboration: { text: 'Construire quelque chose de grand avec une √©quipe' } } },
        { id: 3, part: "Mes Moteurs (Ce qui me motive profond√©ment)", label: 'Tu serais le/la plus fier(e) de...', options: { diriger: { text: 'Diriger une √©quipe et mener un projet √† la r√©ussite' }, creer: { text: 'Cr√©er une ≈ìuvre ou un produit qui n\'existait pas avant' }, comprendre: { text: 'Faire une d√©couverte qui change notre compr√©hension du monde' } } },
        { id: 4, part: "Mes Moteurs (Ce qui me motive profond√©ment)", label: 'Tu pr√©f√®res un quotidien o√π...', options: { variete: { text: 'Chaque jour est diff√©rent et apporte de nouveaux d√©fis' }, stabilite: { text: 'Les t√¢ches sont claires, structur√©es et pr√©visibles' } } },
        { id: 5, part: "Mes Moteurs (Ce qui me motive profond√©ment)", label: 'Ce qui t\'apporterait le plus de satisfaction serait...', options: { influence: { text: 'D\'influencer les d√©cisions strat√©giques d\'une organisation' }, expertise: { text: 'D\'√™tre la personne r√©f√©rente pour une comp√©tence technique pr√©cise' } } },
        { id: 6, part: "Mes Moteurs (Ce qui me motive profond√©ment)", label: 'Tu es pr√™t(e) √† travailler dur si...', options: { passion: { text: 'Le sujet te passionne, m√™me si c\'est moins bien pay√©' }, ambition: { text: 'Cela te permet d\'√©voluer rapidement et de bien gagner ta vie' } } },
        { id: 7, part: "Mes Moteurs (Ce qui me motive profond√©ment)", label: 'Lequel de ces verbes te parle le plus ?', options: { transmettre: { text: 'Transmettre' }, organiser: { text: 'Organiser' }, inventer: { text: 'Inventer' } } },
        
        // === Partie 2: Ma Fa√ßon d'Agir (7 questions) ===
        { id: 8, part: "Ma Fa√ßon d'Agir (Comment je fonctionne)", label: 'Face √† une nouvelle id√©e ou une m√©thode inhabituelle, tu as tendance √†...', options: { ouverture: { text: 'L\'explorer avec curiosit√©, m√™me si c\'est √©trange' }, tradition: { text: 'Pr√©f√©rer les m√©thodes qui ont d√©j√† fait leurs preuves' } } },
        { id: 9, part: "Ma Fa√ßon d'Agir (Comment je fonctionne)", label: 'Quand un travail important t\'est confi√©, ta premi√®re r√©action est de...', options: { consciencieux: { text: 'Planifier m√©ticuleusement toutes les √©tapes avant de commencer' }, flexible: { text: 'Commencer et ajuster ton plan au fur et √† mesure' } } },
        { id: 10, part: "Ma Fa√ßon d'Agir (Comment je fonctionne)", label: 'Apr√®s une semaine de cours intense, tu recharges tes batteries en...', options: { extraversion: { text: 'Passant du temps avec tes amis pour te changer les id√©es' }, introversion: { text: 'Passant du temps seul(e) avec un livre, un film, un jeu...' } } },
        { id: 11, part: "Ma Fa√ßon d'Agir (Comment je fonctionne)", label: 'Dans un d√©bat en groupe, si tu n\'es pas d\'accord, tu vas plut√¥t...', options: { agreable: { text: 'Chercher un compromis pour maintenir une bonne entente' }, assertif: { text: 'D√©fendre ton point de vue avec des arguments' } } },
        { id: 12, part: "Ma Fa√ßon d'Agir (Comment je fonctionne)", label: 'Face √† une situation stressante et impr√©vue, tu...', options: { stable: { text: 'Restes calme et te concentres sur la recherche d\'une solution' }, reactif: { text: 'Ressens une forte mont√©e de stress et d\'inqui√©tude' } } },
        { id: 13, part: "Ma Fa√ßon d'Agir (Comment je fonctionne)", label: 'Quand tu rends un travail...', options: { detail: { text: 'Tu v√©rifies chaque d√©tail plusieurs fois pour t\'assurer qu\'il est parfait' }, synthese: { text: 'Tu te concentres sur l\'id√©e g√©n√©rale, les petits d√©tails sont secondaires' } } },
        { id: 14, part: "Ma Fa√ßon d'Agir (Comment je fonctionne)", label: 'Face √† un sujet que tu ne connais pas...', options: { curieux: { text: 'Tu es imm√©diatement tent√©(e) de faire des recherches pour en savoir plus' }, pratique: { text: 'Tu t\'y int√©resses seulement si c\'est directement utile pour un projet' } } },

        // === Partie 3: Mes Terrains de Jeu (7 questions) ===
        { id: 15, part: "Mes Terrains de Jeu (Les activit√©s que je pr√©f√®re)", label: 'Spontan√©ment, tu pr√©f√®res...', options: { realiste: { text: 'Bricoler, r√©parer un objet, faire du sport' }, investigatif: { text: 'R√©soudre une √©nigme, faire une recherche complexe' } } },
        { id: 16, part: "Mes Terrains de Jeu (Les activit√©s que je pr√©f√®re)", label: 'Si tu devais organiser un √©v√©nement pour ton lyc√©e, ce serait...', options: { artistique: { text: 'Un concours d\'√©loquence ou un festival de musique' }, social: { text: 'Une collecte de fonds pour une association caritative' } } },
        { id: 17, part: "Mes Terrains de Jeu (Les activit√©s que je pr√©f√®re)", label: 'Tu es plus dou√©(e) pour...', options: { entreprenant: { text: 'Convaincre les autres de te suivre dans un projet' }, conventionnel: { text: 'Organiser les dossiers et le planning parfaitement' } } },
        { id: 18, part: "Mes Terrains de Jeu (Les activit√©s que je pr√©f√®re)", label: 'Tu es plus √† l\'aise pour...', options: { social: { text: 'Animer une r√©union pour que tout le monde s\'exprime' }, entreprenant: { text: 'Pr√©senter un projet pour convaincre un jury de le financer' } } },
        { id: 19, part: "Mes Terrains de Jeu (Les activit√©s que je pr√©f√®re)", label: 'Tu pr√©f√®res passer ton temps √†...', options: { artistique: { text: 'Personnaliser l\'apparence de tes notes ou de ton espace' }, conventionnel: { text: 'Classer et organiser tes fichiers pour tout retrouver facilement' } } },
        { id: 20, part: "Mes Terrains de Jeu (Les activit√©s que je pr√©f√®re)", label: 'Lequel de ces projets t\'attire le plus ?', options: { realiste: { text: 'Construire une cabane ou planter un potager' }, artistique: { text: '√âcrire une nouvelle ou r√©aliser un court-m√©trage' } } },
        { id: 21, part: "Mes Terrains de Jeu (Les activit√©s que je pr√©f√®re)", label: 'Si tu devais choisir une seule activit√© pour le week-end :', options: { social: { text: 'Animer un groupe d\'enfants dans un centre a√©r√©' }, investigatif: { text: 'Participer √† un atelier de programmation ou de chimie' }, realiste: { text: 'Faire une longue randonn√©e en nature ou un sport d\'√©quipe' } } }
    ];
    
    let questionsHTML = '';
    let currentPart = '';
    questions.forEach(q => {
        if (q.part !== currentPart) {
            currentPart = q.part;
            questionsHTML += `<h2 class="text-xl font-bold text-slate-800 mt-8 mb-4 border-b pb-2">${currentPart}</h2>`;
        }
        questionsHTML += createQuestionHTML(q.id, q.label, q.options, journalData.step0[`q${q.id}`]);
    });

    const analysisHTML = `
        <div class="text-center mt-6">
            <button type="button" id="analyzeProfileBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser mon profil</button>
        </div>
        <div id="geminiLoader_step0" class="hidden mt-4"><div class="loader"></div></div>
        <div id="results-wrapper" class="mt-8 space-y-8">
            <div id="archetype-container"></div>
            <div id="analysis-container"></div>
            <div id="infographic-container"></div>
        </div>
        <hr class="my-12 border-slate-300">
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Pour aller plus loin : Croise les regards</h2>
<p class="text-slate-600 mb-6">Pour affiner ta r√©flexion, passe les 3 tests propos√©s sur le site <a href="https://test-orientation.studyrama.com/profil/lyceen" target="_blank" class="font-semibold text-cyan-600 hover:underline">Studyrama Orientation</a>. Attention, tu devras fournir ton e-mail √† la fin pour recevoir tes r√©sultats. Copie-colle-les ensuite dans les cases ci-dessous.</p>            <div class="mb-6">
                <label for="test_interets" class="block text-md font-medium text-slate-700 mb-2">1. R√©sultats du Test d'Int√©r√™ts Professionnels</label>
                <textarea id="test_interets" name="test_interets" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes r√©sultats...">${journalData.step0.test_interets || ''}</textarea>
            </div>
            <div class="mb-6">
                <label for="test_motivation" class="block text-md font-medium text-slate-700 mb-2">2. R√©sultats du Test de Motivation</label>
                <textarea id="test_motivation" name="test_motivation" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes r√©sultats...">${journalData.step0.test_motivation || ''}</textarea>
            </div>
            <div class="mb-6">
                <label for="test_personnalite" class="block text-md font-medium text-slate-700 mb-2">3. R√©sultats du Test de Personnalit√©</label>
                <textarea id="test_personnalite" name="test_personnalite" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes r√©sultats...">${journalData.step0.test_personnalite || ''}</textarea>
            </div>
            <div class="text-center mb-4">
                <button type="button" id="geminiBtn_test_croise" class="bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">üí° Lancer l'analyse crois√©e</button>
            </div>
            <div id="geminiLoader_test_croise" class="hidden"><div class="loader"></div></div>
            <div class="mb-6">
                <label for="analyse_tests_croisee" class="block text-md font-medium text-slate-700 mb-2">Analyse crois√©e par l'IA</label>
                <textarea id="analyse_tests_croisee" name="analyse_tests_croisee" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step0.analyse_tests_croisee || ''}</textarea>
            </div>
        </div>
        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;
    form.innerHTML = questionsHTML + analysisHTML;
    
    const renderArchetype = (archetype) => {
        if (!archetype || !archetype.titre) return;
        const container = div.querySelector('#archetype-container');
        container.innerHTML = `
            <div class="bg-cyan-50 border-2 border-dashed border-cyan-300 p-6 rounded-2xl text-center">
                <span class="text-5xl">${archetype.icone}</span>
                <h3 class="text-2xl font-bold text-cyan-800 mt-2">${archetype.titre}</h3>
                <p class="text-slate-600 mt-2">${archetype.description}</p>
            </div>
        `;
    };

    const renderAnalysis = (analysis) => {
        const container = div.querySelector('#analysis-container');
        container.innerHTML = `
            <div>
                <label class="block text-md font-medium text-slate-700 mb-2">Analyse d√©taill√©e :</label>
                <textarea name="analysis" rows="15" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${analysis}</textarea>
            </div>
        `;
    };

    const renderInfographic = (step0Data) => {
        const container = div.querySelector('#infographic-container');
        container.innerHTML = '';
        const infographicElement = createProfileInfographic(step0Data);
        container.appendChild(infographicElement);
    };

    if (journalData.step0 && journalData.step0.analysis) {
        renderAnalysis(journalData.step0.analysis);
        renderInfographic(journalData.step0);
    }
    if (journalData.step0 && journalData.step0.archetype) {
        renderArchetype(journalData.step0.archetype);
    }

    div.querySelector('#analyzeProfileBtn').addEventListener('click', async () => {
        const loader = div.querySelector('#geminiLoader_step0');
        
        div.querySelector('#archetype-container').innerHTML = '';
        div.querySelector('#analysis-container').innerHTML = '';
        div.querySelector('#infographic-container').innerHTML = '';
        
        let allAnswered = true;
        let answersText = "";
        const formData = new FormData(form);
        questions.forEach((q) => {
            const answerValue = formData.get(`q${q.id}`);
            if (!answerValue) allAnswered = false;
            const answerText = q.options[answerValue]?.text || 'Non r√©pondu';
            answersText += `- ${q.label} -> ${answerText}\n`;
        });

        if (!allAnswered) {
            alert("Veuillez r√©pondre √† toutes les questions pour obtenir une analyse.");
            return;
        }
        
        loader.style.display = 'block';

        const analysisPrompt = `Agis en tant que psychologue exp√©riment√©(e), sp√©cialis√©(e) en orientation scolaire et professionnelle. Tu viens de recevoir les r√©ponses d'un(e) lyc√©en(ne) √† un questionnaire de personnalit√© structur√© en 3 parties.\n\nVoici ses r√©ponses :\n${answersText}\n\nINTERPR√âTATION DU QUESTIONNAIRE :\n- La partie "Mes Moteurs" identifie ses valeurs professionnelles cl√©s.\n- La partie "Ma Fa√ßon d'Agir" explore ses traits de personnalit√© (inspir√©s du mod√®le Big Five).\n- La partie "Mes Terrains de Jeu" identifie ses p√¥les d'int√©r√™ts dominants (inspir√©s de la typologie RIASEC de Holland).\n\nTA MISSION :\nR√©dige une analyse compl√®te, bienveillante et actionnable, structur√©e exactement comme suit :\n\n**1. Synth√®se de votre profil :**\nR√©dige un paragraphe de r√©sum√© qui d√©crit le profil de l'√©l√®ve de mani√®re globale et positive.\n\n**2. Vos Atouts et Pistes de R√©flexion :**\nEn te basant sur ses r√©ponses √† la partie "Ma Fa√ßon d'Agir", d√©cris son mode de fonctionnement. Mets en lumi√®re 2 ou 3 de ses plus grandes forces (ex: "Ton approche m√©thodique et planifi√©e est un atout majeur..."). Sugg√®re ensuite une piste de d√©veloppement (ex: "...pense aussi √† laisser de la place √† la spontan√©it√©").\n\n**3. Les Environnements Faits pour Vous :**\nEn te basant principalement sur les parties "Mes Moteurs" et "Mes Terrains de Jeu", d√©cris le type d'environnement d'√©tudes et de travail dans lequel l'√©l√®ve pourrait s'√©panouir. Sugg√®re 2 ou 3 grands domaines ou secteurs d'activit√© (sans donner de m√©tier pr√©cis) qui semblent correspondre √† ses int√©r√™ts profonds.\n\nLe ton doit √™tre chaleureux et encourageant. Adresse-toi directement √† l'√©l√®ve en utilisant "tu".`;
        const profileAnalysis = await callGeminiAPI(analysisPrompt);
        
        journalData.step0.analysis = profileAnalysis;
        renderAnalysis(profileAnalysis);
        
        for (let i = 1; i <= 21; i++) {
            journalData.step0[`q${i}`] = formData.get(`q${i}`);
        }
        renderInfographic(journalData.step0);

        const archetypePrompt = `Agis comme un expert en branding personnel. Bas√© sur l'analyse de personnalit√© suivante : "${profileAnalysis}", choisis l'un des arch√©types suivants qui correspond le mieux : ["L'Architecte Logique", "L'Explorateur Cr√©atif", "Le Connecteur Humain", "Le Strat√®ge Pragmatique", "Le Visionnaire Intuitif", "L'Artisan M√©ticuleux", "Le M√©diateur Empathique", "L'Innovateur Audacieux", "Le Gardien des Savoirs"]. Ta r√©ponse doit √™tre un objet JSON valide avec trois cl√©s : "titre" (le nom de l'arch√©type choisi), "description" (une phrase courte et percutante d√©crivant l'arch√©type), et "icone" (un emoji qui le repr√©sente).`;
        const archetypeResult = await callGeminiAPI(archetypePrompt, false, true);
        
        try {
            const parsedArchetype = JSON.parse(archetypeResult);
            renderArchetype(parsedArchetype);
            journalData.step0.archetype = parsedArchetype;
            await saveData();
            await grantXp(100); 
        } catch(e) { console.error("Erreur de parsing pour l'arch√©type :", e); }

        loader.style.display = 'none';
    });

    div.querySelector('#geminiBtn_test_croise').addEventListener('click', async () => {
        const loader = div.querySelector('#geminiLoader_test_croise');
        const resultatsInterets = div.querySelector('#test_interets').value;
        const resultatsMotivation = div.querySelector('#test_motivation').value;
        const resultatsPersonnalite = div.querySelector('#test_personnalite').value;
        const analysisTextarea = div.querySelector('#analyse_tests_croisee');

        if (!journalData.step0.analysis) {
            alert("Veuillez d'abord g√©n√©rer l'analyse de votre profil pour obtenir une analyse crois√©e.");
            return;
        }
        if (!resultatsInterets.trim() && !resultatsMotivation.trim() && !resultatsPersonnalite.trim()) {
            alert("Veuillez renseigner les r√©sultats d'au moins un test.");
            return;
        }

        loader.style.display = 'block';
        analysisTextarea.value = '';

        const prompt = `Agis en tant que psychologue-conseiller d'orientation. Un √©l√®ve a d√©j√† compl√©t√© un questionnaire de personnalit√© dont l'analyse est la suivante : "${journalData.step0.analysis}".
        Pour affiner sa r√©flexion, il a pass√© 3 tests compl√©mentaires sur Studyrama. Voici ses r√©sultats :
        1.  **Test d'Int√©r√™ts Professionnels :** "${resultatsInterets}"
        2.  **Test de Motivation :** "${resultatsMotivation}"
        3.  **Test de Personnalit√© :** "${resultatsPersonnalite}"

        Ta mission est de r√©diger une **analyse crois√©e bienveillante et constructive**. Ne te contente pas de r√©sumer chaque test. Mets en lumi√®re les **convergences** et les **confirmations**.
        Structure ta r√©ponse en 2 points :
        1.  **Ce que ces tests confirment :** Identifie les 2 ou 3 points cl√©s de son profil initial (ses forces, ses moteurs...) qui sont clairement renforc√©s par les r√©sultats de ces trois tests. Sois pr√©cis en citant des exemples.
        2.  **Une nouvelle piste √† explorer :** En te basant sur un √©l√©ment nouveau ou surprenant apparu dans les tests, propose une nouvelle piste de r√©flexion ou un domaine √† explorer auquel il n'avait peut-√™tre pas pens√©.

        Le ton doit √™tre tr√®s encourageant et valoriser la coh√©rence de sa d√©marche. Adresse-toi directement √† l'√©l√®ve.`;

        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none';
        analysisTextarea.value = result;
    });
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        for (let i = 1; i <= 21; i++) {
            journalData.step0[`q${i}`] = formData.get(`q${i}`);
        }
        journalData.step0.analysis = formData.get('analysis');
        journalData.step0.test_interets = formData.get('test_interets');
        journalData.step0.test_motivation = formData.get('test_motivation');
        journalData.step0.test_personnalite = formData.get('test_personnalite');
        journalData.step0.analyse_tests_croisee = formData.get('analyse_tests_croisee');
        
        checkBadges();
        await saveData();
        showView('menu');
    });

    return div;
}
        
        function createStep1Field(field) {
            const value = (journalData.step1 && journalData.step1[field.id]) || '';
            return `
                <div class="mb-4">
                    <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${field.placeholder}" value="${value}">
                        <button type="button" id="geminiBtn_${field.id}" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition" title="Explorer les d√©bouch√©s avec l'IA">‚ú®</button>
                        <button type="button" id="daySimBtn_${field.id}" class="bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition" title="Simuler une journ√©e type">üìÖ</button>
                    </div>
                    <div id="geminiLoader_${field.id}" class="hidden mt-4"><div class="loader"></div></div>
                    <div id="geminiResult_${field.id}" class="mt-4 p-4 bg-cyan-50 border border-cyan-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
                </div>
            `;
        }
        
// REMPLACEZ VOTRE FONCTION createStep1View EXISTANTE PAR CE CODE COMPLET :
function createStep1View() {
    const config = stepsConfig.step1;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    
    if (!journalData.step1) journalData.step1 = {};

    // MODIFICATION : Nouvelle fonction pour convertir le Markdown en tableau HTML
    const markdownTableToHtml = (markdown) => {
        if (!markdown || typeof markdown !== 'string') return '';
        const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
        if (lines.length < 2) {
            // Si ce n'est pas un tableau valide, on affiche le texte tel quel
            return `<p class="whitespace-pre-wrap">${markdown}</p>`;
        }

        const tableClasses = "w-full text-left border-collapse";
        const thClasses = "p-3 border-b-2 border-slate-300 font-bold text-slate-800 bg-slate-100";
        const tdClasses = "p-3 border-b border-slate-200 align-top text-sm";
        let html = `<table class="${tableClasses}">`;

        // En-t√™te du tableau
        const headerCells = lines[0].split('|').slice(1, -1).map(cell => cell.trim());
        html += '<thead><tr>';
        headerCells.forEach(cell => { html += `<th class="${thClasses}">${cell}</th>`; });
        html += '</tr></thead>';

        // Corps du tableau
        html += '<tbody>';
        for (let i = 2; i < lines.length; i++) { // On saute la ligne de s√©paration ' |---|---| '
            const rowCells = lines[i].split('|').slice(1, -1).map(cell => cell.trim());
            if (rowCells.length === headerCells.length) {
                html += '<tr>';
                rowCells.forEach(cell => { html += `<td class="${tdClasses}">${linkify(cell)}</td>`; });
                html += '</tr>';
            }
        }
        html += '</tbody></table>';
        return html;
    };

    const createMetierBlock = (index) => {
        const metier = journalData.step1[`metier${index}`] || '';
        const notes = journalData.step1[`notes${index}`] || '';
        const analysis = journalData.step1[`analysis${index}`] || '';
        const analysisText = journalData.step1[`analysisText${index}`] || analysis; 
        return `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
                <div class="mb-4">
                    <label for="metier${index}" class="block text-md font-medium text-slate-700 mb-2">M√©tier / Domaine #${index}</label>
                    <input type="text" id="metier${index}" name="metier${index}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: D√©veloppeur web" value="${metier}">
                </div>
                <div class="mb-4">
                    <label for="notes${index}" class="block text-md font-medium text-slate-700 mb-2">Notes (√©tudes, comp√©tences, surprises...)</label>
                    <textarea id="notes${index}" name="notes${index}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ce qui a retenu mon attention...">${notes}</textarea>
                </div>
                <div class="flex flex-wrap gap-2 justify-center mb-4">
                    <button type="button" data-action="debouches" data-index="${index}" class="ai-btn flex-grow bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Explorer les d√©bouch√©s</button>
                    <button type="button" data-action="journee" data-index="${index}" class="ai-btn flex-grow bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 transition">üìÖ Simuler une journ√©e type</button>
                    <button type="button" data-action="temoignages" data-index="${index}" class="ai-btn flex-grow bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">üé¨ Trouver des t√©moignages</button>
                </div>
                <div id="loader-${index}" class="hidden"><div class="loader"></div></div>
                <div id="result-${index}" class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded-lg text-slate-700 min-h-[100px] whitespace-pre-wrap">${analysis}</div>
                <input type="hidden" name="analysisText${index}" id="analysisText${index}" value="${analysisText}">
            </div>
        `;
    };

    const comparisonHTML = `
        <div id="comparison-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üî¨ Comparateur de M√©tiers</h2>
            <p class="text-slate-600 mb-4">Maintenant que tu as explor√© plusieurs pistes, utilise l'IA pour g√©n√©rer un tableau comparatif et t'aider √† y voir plus clair.</p>
            <div class="text-center">
                <button type="button" id="compare-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Comparer mes m√©tiers explor√©s</button>
            </div>
            <div id="loader-comparison" class="hidden"><div class="loader"></div></div>
            <div id="comparison-result" class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-slate-700 text-left"></div>
            <input type="hidden" name="comparison" id="comparison" value="${journalData.step1.comparison || ''}">
        </div>
    `;

    form.innerHTML = `
        ${createMetierBlock(1)}
        ${createMetierBlock(2)}
        ${createMetierBlock(3)}
        ${comparisonHTML}
        <button type="submit" class="w-full mt-8 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;

    const checkComparisonState = () => {
        let exploredCount = 0;
        for (let i = 1; i <= 3; i++) {
            const metier = div.querySelector(`#metier${i}`).value.trim();
            const analysisText = div.querySelector(`#analysisText${i}`).value.trim();
            if (metier && analysisText) {
                exploredCount++;
            }
        }
        if (exploredCount >= 2) {
            div.querySelector('#comparison-section').classList.remove('hidden');
        } else {
            div.querySelector('#comparison-section').classList.add('hidden');
        }
    };
    
    div.querySelectorAll('.ai-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const index = e.target.dataset.index;
            const metierInput = div.querySelector(`#metier${index}`);
            const loader = div.querySelector(`#loader-${index}`);
            const resultDiv = div.querySelector(`#result-${index}`);
            const analysisTextInput = div.querySelector(`#analysisText${index}`);
            const metier = metierInput.value.trim();
            if (!metier) {
                resultDiv.innerHTML = 'Veuillez d\'abord entrer un nom de m√©tier.';
                return;
            }
            resultDiv.innerHTML = '';
            loader.style.display = 'block';
            let prompt = '';
            let useGrounding = false;
            let isJson = false;
            switch(action) {
                case 'debouches':
                    prompt = `D√©cris en 3 points clairs les d√©bouch√©s pour le m√©tier de "${metier}".`;
                    break;
                case 'journee':
                    prompt = `Raconte, √† la premi√®re personne ('Je'), une journ√©e type et r√©aliste d'un(e) '${metier}'.`;
                    break;
                case 'temoignages':
                    prompt = `Agis comme un documentaliste expert. Pour le m√©tier de "${metier}", trouve 2 contenus pertinents (interview vid√©o, podcast, article...). Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau de 2 objets. Chaque objet doit avoir trois cl√©s : "titre" (le titre du contenu), "resume" (un r√©sum√© d'une ou deux phrases), et "lien" (une URL de recherche Google ou YouTube directe et valide pour trouver ce contenu).`;
                    useGrounding = true;
                    isJson = true;
                    break;
            }
            const result = await callGeminiAPI(prompt, useGrounding, isJson);
            loader.style.display = 'none';
            if (action === 'temoignages') {
                try {
                    let parsedResult = JSON.parse(result);
                    const testimonialsList = Array.isArray(parsedResult) ? parsedResult : (parsedResult.contenus || parsedResult.testimonials);
                    if (!Array.isArray(testimonialsList)) {
                        throw new Error("La r√©ponse de l'IA ne contient pas une liste valide.");
                    }
                    let htmlResult = '';
                    let textResult = '';
                    testimonialsList.forEach((item, index) => {
                        htmlResult += `
                            <div class="testimonial-item ${index > 0 ? 'pt-3 mt-3 border-t border-slate-200' : ''}">
                                <div class="flex justify-between items-center mb-1">
                                    <h4 class="text-base font-bold text-slate-800 flex-1">${item.titre}</h4>
                                    <a href="${item.lien}" target="_blank" class="flex-shrink-0 ml-4 inline-block bg-cyan-100 text-cyan-800 font-semibold py-1 px-3 rounded-lg text-xs hover:bg-cyan-200 transition">Voir ‚Üó</a>
                                </div>
                                <p class="text-sm text-slate-600">${item.resume}</p>
                            </div>
                        `;
                        textResult += `Titre: ${item.titre}\nR√©sum√©: ${item.resume}\nLien: ${item.lien}\n\n`;
                    });
                    resultDiv.innerHTML = htmlResult;
                    analysisTextInput.value = textResult.trim();
                } catch (e) {
                    resultDiv.innerHTML = "L'IA n'a pas pu formater les t√©moignages correctement. Voici sa r√©ponse brute : <br><pre class='whitespace-pre-wrap text-xs'>" + result + "</pre>";
                    analysisTextInput.value = result;
                }
            } else {
                const linkedResult = linkify(result);
                resultDiv.innerHTML = linkedResult;
                analysisTextInput.value = result;
            }
            checkComparisonState();
            await grantXp(20);
        });
    });

    // MODIFICATION : Le listener du bouton de comparaison est enti√®rement mis √† jour
    div.querySelector('#compare-btn').addEventListener('click', async () => {
        const loader = div.querySelector('#loader-comparison');
        const resultDiv = div.querySelector('#comparison-result');
        const comparisonInput = div.querySelector('#comparison');
        let exploredMetiers = [];

        for (let i = 1; i <= 3; i++) {
            const metier = div.querySelector(`#metier${i}`).value.trim();
            const analysisText = div.querySelector(`#analysisText${i}`).value.trim();
            if (metier && analysisText) {
                exploredMetiers.push({ nom: metier, notes: div.querySelector(`#notes${i}`).value.trim() });
            }
        }

        if (exploredMetiers.length < 2) return;

        loader.style.display = 'block';
        resultDiv.innerHTML = '';

        const prompt = `Agis comme un conseiller d'orientation. Compare les m√©tiers suivants que l'√©l√®ve a explor√©s : ${JSON.stringify(exploredMetiers)}.
        
        Ta r√©ponse doit √™tre **uniquement un objet JSON valide** avec deux cl√©s :
        1. "tableau": une cha√Æne de caract√®res contenant un tableau de comparaison en format Markdown simple (avec les colonnes "Crit√®re", puis une colonne par m√©tier, et les lignes "Type d'√©tudes / Niveau Requis", "Comp√©tences Cl√©s", "Environnement de Travail").
        2. "remarques": une cha√Æne de caract√®res avec une ou deux phrases de conclusion ou de mise en garde.`;
        
        const result = await callGeminiAPI(prompt, false, true);
        loader.style.display = 'none';

        try {
            const data = JSON.parse(result);
            const tableHTML = markdownTableToHtml(data.tableau);
            const remarksHTML = data.remarques ? `<p class="mt-4 text-sm text-slate-600 italic">${data.remarques}</p>` : '';
            
            resultDiv.innerHTML = tableHTML + remarksHTML;
            comparisonInput.value = result; // On sauvegarde le JSON brut pour la persistance
        } catch (e) {
            resultDiv.innerHTML = `<p class="text-red-500">L'IA n'a pas pu formater la comparaison. Voici sa r√©ponse brute :</p><pre class="whitespace-pre-wrap text-xs">${result}</pre>`;
            comparisonInput.value = result;
        }
    });

    // On v√©rifie l'√©tat initial au chargement, et on affiche le tableau si des donn√©es existent
    if(journalData.step1.comparison) {
        try {
            const data = JSON.parse(journalData.step1.comparison);
            const tableHTML = markdownTableToHtml(data.tableau);
            const remarksHTML = data.remarques ? `<p class="mt-4 text-sm text-slate-600 italic">${data.remarques}</p>` : '';
            div.querySelector('#comparison-result').innerHTML = tableHTML + remarksHTML;
        } catch(e) {
            // Si le JSON sauvegard√© est invalide, on affiche le texte brut
             div.querySelector('#comparison-result').textContent = journalData.step1.comparison;
        }
    }
    checkComparisonState();
    
    return div;
}

// REMPLACEZ VOTRE FONCTION createStep2View EXISTANTE PAR CE CODE COMPLET ET FINAL :
function createStep2View() {
    const config = stepsConfig.step2;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    let description = config.description[userGradeLevel] || config.description['default'] || '';
    let action = config.action[userGradeLevel] || config.action['default'] || '';

    div.innerHTML = `     
        <h1 class="text-2xl font-bold text-center col-span-1 flex justify-center items-center gap-2 md:whitespace-nowrap">${config.icon} ${config.title}</h1>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${action}</div>
        </div>
        <div class="mb-8">
            <a href="${config.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter ${config.site} ‚Üó</a>
        </div>
        <form id="stepForm"></form> 
    `;
    
    const form = div.querySelector('#stepForm');
    
    const createDomaineBlock = (comboIndex, domaineIndex) => {
        const data = (journalData.step2 && journalData.step2[`combo_${comboIndex}`]) || {};
        const domaineKey = `domaine_${domaineIndex}`;
        const diplomesKey = `diplomes_${domaineIndex}`;
        const metiersKey = `metiers_${domaineIndex}`;
        return `
            <div class="p-4 bg-slate-50 rounded-lg border border-slate-200 mb-4">
                <h4 class="font-bold text-slate-700 mb-2">Domaine d'activit√© #${domaineIndex}</h4>
                <div class="mb-4">
<label for="${domaineKey}_${comboIndex}" class="block text-md font-medium text-slate-700 mb-2">Nom du domaine</label>
                    <textarea id="${domaineKey}_${comboIndex}" name="${domaineKey}_${comboIndex}" rows="1" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: Sciences de la sant√©">${data[domaineKey] || ''}</textarea>
                </div>
                <div class="mb-4">
<label for="${diplomesKey}_${comboIndex}" class="block text-md font-medium text-slate-700 mb-2">Dipl√¥mes possibles</label>
                    <textarea id="${diplomesKey}_${comboIndex}" name="${diplomesKey}_${comboIndex}" rows="3" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: PASS, Licence Sciences de la Vie...">${data[diplomesKey] || ''}</textarea>
                </div>
                <div>
<label for="${metiersKey}_${comboIndex}" class="block text-md font-medium text-slate-700 mb-2">M√©tiers possibles</label>
                    <textarea id="${metiersKey}_${comboIndex}" name="${metiersKey}_${comboIndex}" rows="3" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: M√©decin, Pharmacien, Chercheur...">${data[metiersKey] || ''}</textarea>
                </div>
            </div>
        `;
    };

    const createCombinationBlock = (index) => {
        const data = (journalData.step2 && journalData.step2[`combo_${index}`]) || {};
        let domainesHTML = '';
        for (let i = 1; i <= 5; i++) {
            domainesHTML += createDomaineBlock(index, i);
        }
        return `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Combinaison #${index}</h2>
                <div class="mb-6">
                    <label for="combo_${index}" class="block text-md font-medium text-slate-700 mb-2">Nomme ta combinaison de sp√©cialit√©s</label>
                    <textarea id="combo_${index}" name="combo_${index}" rows="2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: Maths, Physique-Chimie, SVT">${data.name || ''}</textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button type="button" id="geminiBtn_analyse_${index}" class="w-full bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser et lier au profil</button>
                    <button type="button" id="testimonial-btn_${index}" class="w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">üó£Ô∏è Voir un t√©moignage</button>
                </div>
                <div id="geminiLoader_analyse_${index}" class="hidden my-4"><div class="loader"></div></div>
                <div id="analyse-container_${index}" class="mt-6">
                     <div class="my-6 p-4 bg-slate-50 border border-slate-200 rounded-lg">
                        <textarea id="geminiResult_analyse_${index}" name="geminiResult_analyse_${index}" rows="8" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50" readonly>${data.analysis || ''}</textarea>
                    </div>
                </div>
                <div id="testimonial-loader_${index}" class="hidden my-4"><div class="loader"></div></div>
                <div id="testimonial-result_${index}" class="mt-4 p-4 bg-teal-50 border border-teal-200 rounded-lg whitespace-pre-wrap text-slate-700 ${data.testimonial ? '' : 'hidden'}">
                    ${data.testimonial || ''}
                </div>

                <hr class="my-8">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Mes trouvailles sur Horizons21</h3>
                ${domainesHTML}
            </div>
        `;
    };

    form.innerHTML = `
        ${createCombinationBlock(1)}
        ${createCombinationBlock(2)}
        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;

    for (let i = 1; i <= 2; i++) {
        if (!journalData.step2) { journalData.step2 = {}; }
        if (!journalData.step2[`combo_${i}`] || typeof journalData.step2[`combo_${i}`] !== 'object') {
            journalData.step2[`combo_${i}`] = { name: '', analysis: '', testimonial: '' };
        }

        div.querySelector(`#geminiBtn_analyse_${i}`).addEventListener('click', async () => {
            const comboInput = div.querySelector(`#combo_${i}`);
            const combo = comboInput.value.trim();
            if (!combo) { alert("Veuillez d'abord nommer la combinaison."); return; }
            if (!journalData.step0.analysis) { alert("Veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'."); return; }
            
            const loader = div.querySelector(`#geminiLoader_analyse_${i}`);
            const resultDiv = div.querySelector(`#geminiResult_analyse_${i}`);
            loader.style.display = 'block';
            resultDiv.value = '';

            const prompt = `Agis comme un conseiller d'orientation. Le profil d'un √©l√®ve est : "${journalData.step0.analysis}". Il envisage la combinaison de sp√©cialit√©s : "${combo}". Fournis une analyse en 3 points : 1. Forces de la combinaison. 2. Lien avec son profil. 3. Une piste inattendue. Adresse-toi directement √† lui.`;
            const result = await callGeminiAPI(prompt);
            
            loader.style.display = 'none';
            resultDiv.value = result;
            journalData.step2[`combo_${i}`].analysis = result;
            await saveData();
        });

        div.querySelector(`#testimonial-btn_${i}`).addEventListener('click', async () => {
            const comboInput = div.querySelector(`#combo_${i}`);
            const combo = comboInput.value.trim();
            if (!combo) {
                alert("Veuillez d'abord nommer la combinaison de sp√©cialit√©s.");
                return;
            }

            const loader = div.querySelector(`#testimonial-loader_${i}`);
            const resultDiv = div.querySelector(`#testimonial-result_${i}`);
            loader.style.display = 'block';
            resultDiv.classList.add('hidden');
            resultDiv.textContent = '';
            
            const prompt = `Agis comme un √©tudiant en fin de parcours d'√©tudes sup√©rieures. R√©dige un court t√©moignage (4-5 phrases) fictif mais r√©aliste. Dans ce t√©moignage, tu expliques ton exp√©rience en tant que lyc√©en ayant choisi la combinaison de sp√©cialit√©s suivante : "${combo}". Parle de ce que tu as aim√©, des d√©fis que tu as rencontr√©s, et de ce que ces sp√©cialit√©s t'ont permis de faire dans tes √©tudes. Le ton doit √™tre authentique et parler √† un lyc√©en.`;

            const result = await callGeminiAPI(prompt);
            loader.style.display = 'none';
            resultDiv.textContent = result;
            resultDiv.classList.remove('hidden');

            journalData.step2[`combo_${i}`].testimonial = result;
            await saveData();
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        if (!journalData.step2) journalData.step2 = {};
        for (let i = 1; i <= 2; i++) {
            if (!journalData.step2[`combo_${i}`]) journalData.step2[`combo_${i}`] = {};
            journalData.step2[`combo_${i}`].name = formData.get(`combo_${i}`);
            journalData.step2[`combo_${i}`].analysis = formData.get(`geminiResult_analyse_${i}`);
            // Le t√©moignage est d√©j√† sauvegard√© en temps r√©el
            for (let j = 1; j <= 5; j++) {
                journalData.step2[`combo_${i}`][`domaine_${j}`] = formData.get(`domaine_${j}_${i}`);
                journalData.step2[`combo_${i}`][`diplomes_${j}`] = formData.get(`diplomes_${j}_${i}`);
                journalData.step2[`combo_${i}`][`metiers_${j}`] = formData.get(`metiers_${j}_${i}`);
            }
        }
        checkBadges();
        await saveData();
        showView('menu');
    });

    return div;
}

// Nouvelle fonction pour un rendu lisible dans le journal de bord
function renderStep2InJournal(data) {
    if (!data) return '';
    
    let finalHTML = '<div class="space-y-3">';
    let hasAnyContent = false;

    for (let i = 1; i <= 2; i++) {
        const combo = data[`combo_${i}`];
        if (combo && combo.name) {
            hasAnyContent = true;
            let comboContentHTML = '';

            // Ajoute l'analyse de l'IA si elle existe
            if (combo.analysis) {
                comboContentHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">Analyse du profil :</p><p class="whitespace-pre-wrap text-slate-600">${combo.analysis}</p></div>`;
            }

            // Ajoute le t√©moignage de l'IA s'il existe
            if (combo.testimonial) {
                comboContentHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">T√©moignage d'√©tudiant :</p><p class="whitespace-pre-wrap text-slate-600">${combo.testimonial}</p></div>`;
            }

            // Ajoute les trouvailles sur Horizons21
            let domainesHTML = '';
            for (let j = 1; j <= 5; j++) {
                if (combo[`domaine_${j}`]) {
                    domainesHTML += `<li class="mb-2">
                                        <p class="font-medium text-slate-700">Domaine : <span class="font-normal text-slate-600">${combo[`domaine_${j}`]}</span></p>
                                        <p class="text-sm ml-4">Dipl√¥mes : <span class="font-normal text-slate-600">${combo[`diplomes_${j}`]}</span></p>
                                        <p class="text-sm ml-4">M√©tiers : <span class="font-normal text-slate-600">${combo[`metiers_${j}`]}</span></p>
                                    </li>`;
                }
            }
            if (domainesHTML) {
                comboContentHTML += `<div class="mt-4"><p class="font-semibold text-slate-700 mb-2">Trouvailles sur Horizons21 :</p><ul class="list-none space-y-2">${domainesHTML}</ul></div>`;
            }
            
            finalHTML += `
                <details class="bg-slate-50 rounded-lg border border-slate-200">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Combinaison #${i} : ${combo.name}</summary>
                    <div class="p-3 border-t border-slate-200">${comboContentHTML}</div>
                </details>
            `;
        }
    }

    finalHTML += '</div>';

    return hasAnyContent ? finalHTML : '';
}

       // REMPLACEZ VOTRE FONCTION createStep3View EXISTANTE PAR CELLE-CI :
function createStep3View() {
    const config = stepsConfig.step3;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    
    // Helper pour cr√©er un bloc de formation complet
    const createFormationBlock = (index) => {
        const data = journalData.step3;
        return `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Formation #${index}</h2>
                <div class="mb-6">
                    <label for="formation${index}" class="block text-md font-medium text-slate-700 mb-2">Nom de la formation</label>
                    <input type="text" id="formation${index}" name="formation${index}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: BUT Informatique - Villetaneuse" value="${data[`formation${index}`] || ''}">
                </div>
                <div class="mb-6">
                    <label for="attendus${index}" class="block text-md font-medium text-slate-700 mb-2">Attendus et crit√®res importants</label>
                    <textarea id="attendus${index}" name="attendus${index}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copiez-collez ici les attendus de Parcoursup...">${data[`attendus${index}`] || ''}</textarea>
                </div>

                <div class="text-center mb-4">
                    <button type="button" id="compatibilite-btn-${index}" class="w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">üîé Mon profil correspond-il ?</button>
                </div>
                <div id="loader-compatibilite-${index}" class="hidden"><div class="loader"></div></div>
                <div class="mb-6">
                    <label for="compatibilite${index}" class="block text-md font-medium text-slate-700 mb-2">Rapport de compatibilit√©</label>
                    <textarea id="compatibilite${index}" name="compatibilite${index}" rows="6" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${data[`compatibilite${index}`] || ''}</textarea>
                </div>

                <hr class="my-6">

                <div class="mb-6">
                    <label for="mots_cles${index}" class="block text-md font-medium text-slate-700 mb-2">D√©fi : Tes 3 mots-cl√©s pour cette formation</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="mots_cles${index}" name="mots_cles${index}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Logique, programmation, travail d'√©quipe" value="${data[`mots_cles${index}`] || ''}">
                        <button type="button" id="geminiBtn_mots_cles${index}" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition" title="V√©rifier mes mots-cl√©s">‚ú®</button>
                    </div>
                </div>
                <div id="geminiLoader_mots_cles${index}" class="hidden"><div class="loader"></div></div>
                <div class="mb-6">
                    <label for="analyse_mots_cles${index}" class="block text-md font-medium text-slate-700 mb-2">Analyse de tes mots-cl√©s par l'IA</label>
                    <textarea id="analyse_mots_cles${index}" name="analyse_mots_cles${index}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${data[`analyse_mots_cles${index}`] || ''}</textarea>
                </div>
            </div>
        `;
    };

    form.innerHTML = `
        ${createFormationBlock(1)}
        ${createFormationBlock(2)}
        
        <hr class="my-8">

        <h2 class="text-xl font-semibold mb-4 text-slate-800">üí° Explorer des pistes alternatives</h2>
        <p class="text-slate-600 mb-4">Parfois, les meilleures options sont celles auxquelles on n'avait pas pens√©. Sur la base de ton profil, l'IA peut te sugg√©rer des parcours compl√©mentaires ou diff√©rents.</p>
        <div class="text-center mb-4">
            <button type="button" id="geminiBtn_alternatives" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Sugg√©rer des parcours alternatifs</button>
        </div>
        <div id="geminiLoader_alternatives" class="hidden"><div class="loader"></div></div>
        <div class="mb-6">
            <label for="suggestions" class="block text-md font-medium text-slate-700 mb-2">Pistes de r√©flexion sugg√©r√©es par l'IA</label>
            <textarea id="suggestions" name="suggestions" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step3.suggestions || ''}</textarea>
        </div>

        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;
    
    // Setup des listeners pour les boutons
    for (let i = 1; i <= 2; i++) {
        // Listener pour le d√©fi mots-cl√©s
        div.querySelector(`#geminiBtn_mots_cles${i}`).addEventListener('click', async () => {
            const formation = div.querySelector(`#formation${i}`).value;
            const keywords = div.querySelector(`#mots_cles${i}`).value;
            const loader = div.querySelector(`#geminiLoader_mots_cles${i}`);
            const resultDiv = div.querySelector(`#analyse_mots_cles${i}`);

            if (!formation.trim() || !keywords.trim()) {
                resultDiv.value = "Veuillez renseigner la formation et vos mots-cl√©s."; return;
            }
            resultDiv.value = ''; loader.style.display = 'block';

            const prompt = `Agis comme un examinateur bienveillant. Un lyc√©en s'int√©resse √† la formation : "${formation}". Il pense que les 3 mots-cl√©s qui la d√©crivent le mieux sont : "${keywords}". √âvalue sa r√©ponse en te basant sur les "attendus" officiels de cette formation. Dis-lui si ses mots sont pertinents et propose des alternatives plus pr√©cises.`;
            const result = await callGeminiAPI(prompt, true);
            
            loader.style.display = 'none'; resultDiv.value = result;
        });

        // Listener pour le rapport de compatibilit√©
        div.querySelector(`#compatibilite-btn-${i}`).addEventListener('click', async () => {
            const formation = div.querySelector(`#formation${i}`).value;
            const attendus = div.querySelector(`#attendus${i}`).value;
            const loader = div.querySelector(`#loader-compatibilite-${i}`);
            const resultDiv = div.querySelector(`#compatibilite${i}`);

            if (!journalData.step0 || !journalData.step0.analysis) {
                resultDiv.value = "Pour obtenir ce rapport, veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'."; return;
            }
            if (!formation.trim() || !attendus.trim()) {
                resultDiv.value = "Veuillez renseigner le nom de la formation et ses attendus."; return;
            }
            
            resultDiv.value = ''; loader.style.display = 'block';

            // --- MODIFICATION : On collecte les nouvelles donn√©es ---
            const analyseTests = (journalData.step5 && journalData.step5.analyse_test)
                ? `Voici l'analyse crois√©e de ses tests d'orientation : "${journalData.step5.analyse_test}".`
                : "";

            let portfolioInfo = "";
            if (journalData.step10) {
                if (journalData.step10.soft_skills_profile) {
                    portfolioInfo += ` Son profil de comp√©tences transversales est : "${journalData.step10.soft_skills_profile}".`;
                }
                if (journalData.step10.experiences && journalData.step10.experiences.length > 0) {
                    const experienceSummaries = journalData.step10.experiences.map(exp => exp.analysis).join(' ');
                    portfolioInfo += ` De plus, il a valoris√© des exp√©riences qui montrent : "${experienceSummaries}".`;
                }
            }
            // --- FIN DE LA MODIFICATION ---
            
            // --- MODIFICATION : Le prompt utilise maintenant le dossier complet ---
            const prompt = `Agis comme un conseiller d'orientation expert. Voici un dossier complet sur un √©l√®ve :
1.  **Son profil de personnalit√© (√âtape "Mieux se conna√Ætre") :** "${journalData.step0.analysis}"
2.  **Son analyse de tests d'orientation (√âtape "Actus & Tests") :** ${analyseTests || "Non renseign√©."}
3.  **Son portfolio de comp√©tences (√âtape "Portfolio") :** ${portfolioInfo || "Non renseign√©."}

Il s'int√©resse √† la formation "${formation}" dont les attendus sont : "${attendus}".

R√©dige un rapport de compatibilit√© structur√© et bienveillant en 2 points :
1.  **Points forts de ta candidature :** Mets en √©vidence les aspects de son dossier complet (personnalit√©, r√©sultats des tests, comp√©tences du portfolio) qui sont en parfaite ad√©quation avec les attendus de la formation. Sois pr√©cis et cite des exemples.
2.  **Pistes d'am√©lioration et de r√©flexion :** Souligne un ou deux aspects o√π il pourrait y avoir un d√©calage ou qui m√©riteraient d'√™tre renforc√©s. Donne un conseil concret pour chaque point.

Le ton doit √™tre constructif et encourageant. Adresse-toi directement √† l'√©l√®ve.`;
            
            const result = await callGeminiAPI(prompt, true);
            loader.style.display = 'none'; resultDiv.value = result;
        });
    }

    // Listener pour les suggestions alternatives
    div.querySelector('#geminiBtn_alternatives').addEventListener('click', async () => {
        const loader = div.querySelector('#geminiLoader_alternatives');
        const resultDiv = div.querySelector('#suggestions');
        const formation1 = div.querySelector('#formation1').value;
        const formation2 = div.querySelector('#formation2').value;

        if (!journalData.step0.analysis) {
            resultDiv.value = "Pour obtenir des suggestions personnalis√©es, veuillez d'abord compl√©ter l'√âtape 'Mieux se conna√Ætre'."; return;
        }
        if (!formation1.trim() && !formation2.trim()) {
            resultDiv.value = "Veuillez renseigner au moins une formation qui vous int√©resse ci-dessus."; return;
        }
        
        resultDiv.value = ''; loader.style.display = 'block';
        
        const prompt = `Agis comme un conseiller d'orientation cr√©atif. Le profil d'un lyc√©en est : "${journalData.step0.analysis}". Ce lyc√©en s'int√©resse √† : "${formation1}" et "${formation2}". Propose-lui 3 parcours alternatifs auxquels il n'aurait pas pens√©, mais qui correspondent bien √† son profil. Pour chaque suggestion, explique bri√®vement la pertinence.`;
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none'; resultDiv.value = result;
    });

    return div;
}

function createStep12View() {
    const config = stepsConfig.step12;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    form.innerHTML = `
        <div class="mb-8">
            <label for="city-input" class="block text-md font-medium text-slate-700 mb-2">Dans quelle ville imagines-tu tes futures √©tudes ?</label>
            <input type="text" id="city-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Lyon, Rennes, Bordeaux...">
        </div>
        <div class="bg-slate-50 border border-slate-200 p-3 rounded-lg text-sm text-slate-600 mb-4">
            <p><strong class="font-semibold text-slate-800">Comment √ßa marche ?</strong> L'application demande √† l'IA d'effectuer une recherche en temps r√©el pour trouver les co√ªts et les aides les plus r√©cents pour la ville choisie, puis met en forme sa r√©ponse.</p>
        </div>
        <div class="text-center mb-6">
            <button type="button" id="budget-btn" class="w-full sm:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üìä Estimer le Budget Mensuel √âtudiant</button>
        </div>
        <div id="loader-budget" class="hidden"><div class="loader"></div></div>
        <div id="budget-result" class="mb-10"></div>
        <hr class="my-10">
        <h3 class="text-xl font-bold text-center text-slate-800 mb-4">Recherche des Aides Financi√®res</h3>
        <p class="text-center text-slate-600 mb-6">D√©couvrez les principaux dispositifs pour financer votre vie √©tudiante.</p>
        <div class="text-center mb-6">
            <button type="button" id="aides-btn" class="w-full sm:w-auto bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">üí∞ Chercher les Aides Disponibles</button>
        </div>
        <div id="loader-aides" class="hidden"><div class="loader"></div></div>
        <div id="aides-result" class="mb-10"></div>
    `;
    
    const cityInput = div.querySelector('#city-input');

    div.querySelector('#budget-btn').addEventListener('click', async () => {
        const city = cityInput.value.trim();
        if (!city) {
            alert("Veuillez renseigner une ville.");
            return;
        }
        const loader = div.querySelector('#loader-budget');
        const resultDiv = div.querySelector('#budget-result');
        loader.style.display = 'block';
        resultDiv.innerHTML = '';

        const prompt = `Agis comme un conseiller financier expert pour √©tudiants. Pour la ville de "${city}", estime le budget mensuel moyen.
        Ta r√©ponse doit √™tre **uniquement un objet JSON valide** avec deux cl√©s : "budget" et "commentaires".
        1. La cl√© "budget" doit contenir un objet avec les estimations : "loyer_crous", "loyer_prive_studio", "alimentation_min", "alimentation_max", "transport_collectif", "loisirs_min", "loisirs_max".
        **R√®gles pour le budget :** Si le loyer CROUS n'est pas trouvable, estime le loyer le plus bas possible (colocation...). Le budget alimentation max doit rester raisonnable.
        2. La cl√© "commentaires" doit √™tre un tableau d'objets. Pour **Loyer, Transport et Alimentation**, tu dois **imp√©rativement** ajouter un commentaire. Chaque objet commentaire doit avoir les cl√©s : "categorie", "texte", "source_nom", et "source_url". Pour le Loyer, inclus des liens de recherche (leboncoin, etc.) dans le texte.`;

        const result = await callGeminiAPI(prompt, true, true);
        loader.style.display = 'none';

        try {
            const data = JSON.parse(result);
            const budget = data.budget;
            
            const loyer_avg = Math.round((parseInt(budget.loyer_crous) + parseInt(budget.loyer_prive_studio)) / 2);
            const alim_avg = Math.round((parseInt(budget.alimentation_min) + parseInt(budget.alimentation_max)) / 2);
            const loisirs_avg = Math.round((parseInt(budget.loisirs_min) + parseInt(budget.loisirs_max)) / 2);

            // MODIFICATION : On recr√©e la section des commentaires
            let commentsHTML = '';
            if (data.commentaires && data.commentaires.length > 0) {
                commentsHTML += '<div class="border-t pt-6 mt-6"><h4 class="text-lg font-bold text-slate-800 mb-3">üí° D√©tails et Sources :</h4><div class="space-y-3">';
                data.commentaires.forEach(comment => {
                    const linkedText = linkify(comment.texte);
                    commentsHTML += `
                        <div class="text-sm p-3 bg-slate-50 rounded-lg border border-slate-200">
                            <p class="font-semibold text-slate-700">${comment.categorie}</p>
                            <div class="text-slate-600">${linkedText}</div>
                            <a href="${comment.source_url}" target="_blank" class="text-cyan-600 hover:underline font-medium">Source : ${comment.source_nom} ‚Üó</a>
                        </div>
                    `;
                });
                commentsHTML += '</div></div>';
            }

            resultDiv.innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Construis ton Budget Personnalis√© √† ${city}</h3>
                    <p class="text-sm text-slate-500 mb-6">Ajuste les curseurs pour voir comment ton budget total √©volue.</p>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center">
                            <label for="loyer-slider" class="font-semibold text-slate-700 text-md">üè† Loyer</label>
                                <span id="loyer-value" class="font-bold text-cyan-600 text-lg">${loyer_avg}‚Ç¨</span>
                            </div>
                            <input id="loyer-slider" type="range" min="${budget.loyer_crous}" max="${budget.loyer_prive_studio}" value="${loyer_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                        <label for="alim-slider" class="font-semibold text-slate-700 text-md">üõí Alimentation & Vie courante</label>
                                <span id="alim-value" class="font-bold text-cyan-600 text-lg">${alim_avg}‚Ç¨</span>
                            </div>
                            <input id="alim-slider" type="range" min="${budget.alimentation_min}" max="${budget.alimentation_max}" value="${alim_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <div class="flex justify-between items-center">
                            <label for="loisirs-slider" class="font-semibold text-slate-700 text-md">üéâ Loisirs & Sorties</label>                               
                            <span id="loisirs-value" class="font-bold text-cyan-600 text-lg">${loisirs_avg}‚Ç¨</span>
                            </div>
                            <input id="loisirs-slider" type="range" min="${budget.loisirs_min}" max="${budget.loisirs_max}" value="${loisirs_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>

                    <div class="mt-8 pt-4 border-t text-center">
                        <p class="text-slate-600">Ton budget mensuel personnalis√© (transport en commun inclus)</p>
                        <p id="total-budget" class="text-4xl font-bold text-cyan-700 mt-1"></p>
                    </div>
                    
                    ${commentsHTML}
                </div>
            `;
            
            const loyerSlider = div.querySelector('#loyer-slider');
            const alimSlider = div.querySelector('#alim-slider');
            const loisirsSlider = div.querySelector('#loisirs-slider');
            const loyerValue = div.querySelector('#loyer-value');
            const alimValue = div.querySelector('#alim-value');
            const loisirsValue = div.querySelector('#loisirs-value');
            const totalBudget = div.querySelector('#total-budget');

            const updateBudgetTotal = () => {
                const loyer = parseInt(loyerSlider.value);
                const alim = parseInt(alimSlider.value);
                const loisirs = parseInt(loisirsSlider.value);
                const transport = parseInt(budget.transport_collectif);
                
                loyerValue.textContent = `${loyer}‚Ç¨`;
                alimValue.textContent = `${alim}‚Ç¨`;
                loisirsValue.textContent = `${loisirs}‚Ç¨`;
                
                totalBudget.textContent = `${loyer + alim + loisirs + transport}‚Ç¨`;
            };

            [loyerSlider, alimSlider, loisirsSlider].forEach(slider => {
                slider.addEventListener('input', updateBudgetTotal);
});
            updateBudgetTotal();
        } catch (e) {
            resultDiv.innerHTML = `<p class="text-red-500 text-center">L'IA n'a pas pu g√©n√©rer une estimation structur√©e. Veuillez r√©essayer.</p><textarea class="w-full h-40 bg-slate-100 p-2 rounded mt-2" readonly>${result}</textarea>`;
        }
    });

    div.querySelector('#aides-btn').addEventListener('click', async () => { /* ... (code inchang√©) ... */ });

    return div;
}


function createGuideView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    // --- 1. D√©finition de tous les blocs de contenu (version compl√®te et originale) ---

    const styleHTML = `
        <style>
            .guide-container { line-height: 1.7; }
            .guide-container h2 { border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; color: #1e293b; margin-top: 60px; font-size: 1.75em; font-weight: 700; text-align: center; }
            .guide-container h3 { color: #334155; font-size: 1.3em; margin-top: 40px; font-weight: 600; text-align: center; }
            .guide-container .centered-subtitle { text-align: center; margin-bottom: 30px; }
.guide-container h4 { 
    margin-top: 0; 
    font-size: 1.1em; 
    font-weight: 600; 
    display: flex; 
    align-items: center; 
    gap: 0.75rem; 
    justify-content: center; /* Ajout√© pour centrer l'ic√¥ne et le texte */
    text-align: center;      /* Ajout√© pour les titres des encarts */
}            .guide-container .logo { display: block; margin: 0 auto 10px auto; width: 350px; }
            .guide-container .info-box { padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid; }
            .guide-container .info-box-parents { background-color: #f7fee7; border-color: #84cc16; }
            .guide-container .info-box-parents h4 { color: #4d7c0f; display: block; }
            .guide-container .info-box-parents ul { padding-left: 20px; margin-bottom: 0; color: #65a30d; }
            .guide-container .info-box-teachers { background-color: #fff7ed; border-color: #f97316; }
            .guide-container .info-box-teachers h4 { color: #9a3412; display: block; }
            .guide-container .info-box-teachers ul { padding-left: 20px; margin-bottom: 0; color: #c2410c; }
            .guide-container .conseil-prof { background-color: #ecfeff; border-left: 4px solid #0891b2; padding: 15px; margin-top: 15px; border-radius: 8px; font-style: italic; color: #155e75; }
            .guide-container .conseil-prof h4 { color: #164e63; }
            .guide-container .etape { margin-bottom: 30px; padding-left: 10px; border-left: 2px solid #e2e8f0; }
            .guide-container ul { padding-left: 25px; margin-top: 10px; }
            .guide-container li { margin-bottom: 8px; }
        </style>
    `;

    const introHTML = `
        <img src="logo.png" alt="Logo Mon Explor'Orientation" class="logo">
        <h2>Introduction : Qu'est-ce que "Mon Explor'Orientation" ?</h2>
        <p>"Mon Explor'Orientation" est un <strong>carnet de bord num√©rique interactif</strong>, con√ßu pour accompagner chaque lyc√©en dans la construction de son projet d'avenir. Son objectif est de rendre l'√©l√®ve acteur de son orientation en lui proposant une m√©thode structur√©e et des outils intelligents pour l'aider √† chaque √©tape de sa r√©flexion.</p>
        <div class="info-box conseil-prof" style="font-style: normal;">
            <h4 style="font-weight: bold; color: #3730A3; display:block;">ü§ñ Le r√¥le de l'Intelligence Artificielle (IA)</h4>
            <p style="margin-top: 10px; font-style: normal;">Dans cette application, l'IA est une <strong>assistante personnelle bienveillante</strong>. Elle n'est pas l√† pour d√©cider √† la place de l'√©l√®ve, mais pour lui faire gagner du temps et enrichir sa r√©flexion. Concr√®tement, elle va analyser, synth√©tiser, sugg√©rer, rechercher et structurer l'information.</p>
            <p style="margin-top: 15px; font-style: normal;"><strong>L'√©l√®ve reste toujours le pilote :</strong> c'est lui qui explore, qui choisit et qui prend les d√©cisions finales. L'IA est simplement un copilote expert qui l'aide √† naviguer.</p>
        </div>
    `;

    const partie1ElevesHTML = `
        <h2>Partie 1 : Pour les √âl√®ves</h2>
        <p>Consid√®re cette application comme ton camp de base personnel. C'est ici que tu vas rassembler tes trouvailles, tester tes id√©es et, pas √† pas, dessiner ton chemin. Le but n'est pas de tout finir en un week-end, mais d'avancer √† ton rythme tout au long de l'ann√©e.</p>
        <div class="info-box conseil-prof" style="font-style: normal;">
            <h4 style="font-weight: bold; color: #3730A3; display:block;">Tes grands objectifs :</h4>
            <ul>
                <li><strong>Mieux te conna√Ætre :</strong> Identifier tes forces, tes centres d'int√©r√™t et ce qui te motive vraiment.</li>
                <li><strong>Explorer intelligemment :</strong> D√©couvrir des m√©tiers et des formations en t'appuyant sur les sites de r√©f√©rence.</li>
                <li><strong>Structurer ta pens√©e :</strong> Garder une trace de tes recherches, doutes et d√©couvertes dans ton journal de bord.</li>
                <li><strong>Agir concr√®tement :</strong> T'aider √† pr√©parer tes candidatures, √† trouver des contacts et √† planifier ton ann√©e.</li>
            </ul>
        </div>
    `;

    const partie2ParentsHTML = `
        <h2>Partie 1 : Pour les Parents</h2>
        <p>Votre r√¥le dans l'orientation de votre enfant est essentiel. Cette application est con√ßue pour √™tre un pont entre sa r√©flexion personnelle et vos discussions.</p>
        <div class="info-box info-box-parents">
            <h4>Comment aider efficacement ?</h4>
            <ul>
                <li><strong>Favorisez le dialogue :</strong> L'application est l'espace personnel de votre enfant. Le but n'est pas de le surveiller, mais de l'inviter √† partager ce qu'il y d√©couvre.</li>
                <li><strong>Utilisez la fonction "Partage" :</strong> Votre enfant peut g√©n√©rer un lien s√©curis√© vers son "Journal de Bord". C'est une excellente base pour un √©change constructif, notamment gr√¢ce au bouton "Pr√©parer une discussion" qui vous donnera des pistes pour un dialogue bienveillant.</li>
                <li><strong>Conseil cl√© :</strong> Int√©ressez-vous √† sa d√©marche plus qu'√† ses conclusions. Le cheminement est plus important que le choix final √† un instant T.</li>
            </ul>
        </div>
    `;

    const partie3EnseignantsHTML = `
        <h2>Partie 1 : Pour les Enseignants</h2>
        <p>Cet outil peut devenir un formidable support pour nos missions d'accompagnement √† l'orientation, notamment dans le cadre du <strong>Parcours Avenir</strong>.</p>
        <div class="info-box info-box-teachers">
            <h4>Pistes d'utilisation p√©dagogique</h4>
            <ul>
                <li><strong>Suivi individualis√© :</strong> Le partage du "Journal de Bord" permet de pr√©parer les entretiens individuels de mani√®re beaucoup plus efficace.</li>
                <li><strong>Support pour les s√©ances collectives :</strong> De nombreuses √©tapes peuvent servir de base pour des ateliers en classe.</li>
                <li><strong>Langage commun :</strong> L'utilisation de cet outil cr√©e des rep√®res partag√©s entre les √©l√®ves, les familles et l'√©quipe √©ducative.</li>
            </ul>
        </div>
    `;
    
    const seancesEnseignantsHTML = `
        <h2>Partie 3 : 10 Id√©es de S√©ances Cl√©s en Main (1h)</h2>
        <div class="etape"><h4>S√©ance 1 : Autoportrait d'Orientation - Qui suis-je pour choisir ?</h4><p><strong>Classe Cible :</strong> Seconde (d√©but d'ann√©e), Premi√®re.<br><strong>Objectif P√©dagogique :</strong> Amener l'√©l√®ve √† prendre conscience de ses traits de personnalit√© et √† acqu√©rir un vocabulaire pour parler de soi.<br><strong>√âtape Utilis√©e :</strong> üë§ Mieux se conna√Ætre.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction sur l'importance de la connaissance de soi (10min). 2. Les √©l√®ves compl√®tent le questionnaire individuellement (25min). 3. Discussion autour de l'<strong>Arch√©type de personnalit√©</strong> et du <strong>graphique RIASEC</strong> g√©n√©r√©s (15min).</div></div>
        <div class="etape"><h4>S√©ance 2 : L'Architecte des Sp√©cialit√©s</h4><p><strong>Classe Cible :</strong> Seconde (2√®me trimestre).<br><strong>Objectif P√©dagogique :</strong> Faire comprendre le lien entre le choix des sp√©cialit√©s et les √©tudes sup√©rieures.<br><strong>√âtape Utilis√©e :</strong> üß≠ Le simulateur de sp√©cialit√©s.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Rappel des enjeux (5min). 2. Les √©l√®ves testent 2-3 combinaisons et utilisent l'IA pour <strong>analyser le lien avec leur profil</strong> et lire un t√©moignage (30min). 3. Partage des combinaisons surprenantes pour ouvrir le champ des possibles (15min).</div></div>
        <div class="etape"><h4>S√©ance 3 : Valoriser son Parcours - Atelier Portfolio</h4><p><strong>Classe Cible :</strong> Premi√®re (fin d'ann√©e), Terminale.<br><strong>Objectif P√©dagogique :</strong> Apprendre √† valoriser ses exp√©riences pour Parcoursup et le Grand Oral.<br><strong>√âtape Utilis√©e :</strong> üíº Mon Portfolio de Comp√©tences.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Expliquer la diff√©rence entre une t√¢che et une comp√©tence (10min). 2. Chaque √©l√®ve utilise l'<strong>Analyseur d'exp√©riences</strong> sur un cas personnel (30min). 3. Partage en bin√¥mes des paragraphes valoris√©s pour un retour constructif (10min).</div></div>
        <div class="etape"><h4>S√©ance 4 : Chasseurs de Mythes - D√©velopper l'Esprit Critique</h4><p><strong>Classe Cible :</strong> Tous niveaux.<br><strong>Objectif P√©dagogique :</strong> D√©construire les id√©es re√ßues sur les m√©tiers et d√©velopper l'esprit critique.<br><strong>√âtape Utilis√©e :</strong> ‚úÖ Fact Checking.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Constitution des √©quipes (5min). 2. Chaque √©quipe choisit un domaine et tente d'obtenir le meilleur score au quiz "Chasse aux Mythes" (30min). 3. Chaque √©quipe pr√©sente √† la classe le mythe le plus surprenant qu'elle a d√©construit (15min).</div></div>
        <div class="etape"><h4>S√©ance 5 : Mon Premier Budget √âtudiant</h4><p><strong>Classe Cible :</strong> Premi√®re (fin d'ann√©e), Terminale.<br><strong>Objectif P√©dagogique :</strong> Ancrer le projet d'√©tudes dans la r√©alit√© financi√®re.<br><strong>√âtape Utilis√©e :</strong> üí∂ Simulateur Vie √âtudiante.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction sur l'importance d'anticiper le budget (5min). 2. Les √©l√®ves choisissent une ville et utilisent le simulateur pour estimer le budget et chercher les aides (30min). 3. Discussion collective sur les estimations et les aides d√©couvertes (15min).</div></div>
        <div class="etape"><h4>S√©ance 6 : Gagner en Confiance - Simulation d'Entretien</h4><p><strong>Classe Cible :</strong> Premi√®re, Terminale.<br><strong>Objectif P√©dagogique :</strong> D√©velopper l'aisance orale et pr√©parer les √©l√®ves √† des interactions r√©elles.<br><strong>√âtape Utilis√©e :</strong> üí¨ L'Exp√©rience.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction sur l'importance de savoir poser les bonnes questions (10min). 2. Les √©l√®ves utilisent individuellement le <strong>simulateur d'entretien</strong> avec l'√©tudiant virtuel (30min). 3. D√©briefing collectif sur ce qu'ils ont appris de l'√©change (10min).</div></div>
        <div class="etape"><h4>S√©ance 7 : Atelier d'√âcriture - Le Projet de Formation Motiv√©</h4><p><strong>Classe Cible :</strong> Terminale.<br><strong>Objectif P√©dagogique :</strong> Comprendre la structure ET am√©liorer la qualit√© de la r√©daction pour Parcoursup.<br><strong>√âtape Utilis√©e :</strong> ‚úçÔ∏è Pr√©parer sa candidature.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Explication du PFM (10min). 2. Les √©l√®ves g√©n√®rent une structure, r√©digent un paragraphe, puis utilisent l'<strong>optimiseur de paragraphe</strong> (35min). 3. Partage des am√©liorations sugg√©r√©es par l'IA (5min).</div></div>
        <div class="etape"><h4>S√©ance 8 : Explorer l'Inattendu - Le Radar √† Opportunit√©s</h4><p><strong>Classe Cible :</strong> Tous niveaux (surtout les ind√©cis).<br><strong>Objectif P√©dagogique :</strong> Ouvrir les horizons et d√©bloquer la r√©flexion.<br><strong>√âtape Utilis√©e :</strong> üì° Le Radar √† Opportunit√©s.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction sur le droit d'√™tre "perdu" (5min). 2. Les √©l√®ves utilisent le bouton "Me surprendre !" pour obtenir une piste de l'IA (20min). 3. En petits groupes, ils discutent de la pertinence de la suggestion (25min).</div></div>
        <div class="etape"><h4>S√©ance 9 : Construire son R√©seau - Premiers Pas</h4><p><strong>Classe Cible :</strong> Premi√®re, Terminale.<br><strong>Objectif P√©dagogique :</strong> Initier une d√©marche de r√©seau concr√®te et d√©mystifier la prise de contact.<br><strong>√âtape Utilis√©e :</strong> üöÄ Passer √† l'action.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Discussion sur l'enqu√™te m√©tier (10min). 2. Les √©l√®ves utilisent le <strong>gestionnaire de contacts</strong> pour trouver des pistes et g√©n√©rer un mod√®le de mail (35min). 3. Relecture crois√©e des mod√®les de mail en bin√¥mes (5min).</div></div>
        <div class="etape"><h4>S√©ance 10 : B√¢tir son Plan B - Anticiper pour Mieux G√©rer</h4><p><strong>Classe Cible :</strong> Terminale.<br><strong>Objectif P√©dagogique :</strong> D√©velopper la r√©silience face √† l'incertitude de Parcoursup.<br><strong>√âtape Utilis√©e :</strong> üîÆ Anticiper la suite.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Discussion sur le stress de Parcoursup (10min). 2. Les √©l√®ves utilisent la <strong>simulation de conversation "Plan B"</strong> pour explorer des alternatives (35min). 3. R√©flexion individuelle √©crite sur les pistes qui ont √©merg√© (5min).</div></div>
    `;

    const partie4FonctionnalitesHTML_base = `
        <h2>Partie 2 : Exploration D√©taill√©e des Fonctionnalit√©s</h2>
        <h3 class="centered-subtitle">Les √âtapes Cl√©s de l'Exploration</h3>
        <div class="etape"><h4>üë§ Mieux se conna√Ætre</h4><p><strong>Objectif :</strong> Dresser un portrait pr√©cis de ta personnalit√©, de tes int√©r√™ts et de ce qui te motive.</p><p><strong>Fonctionnement :</strong> Tu r√©ponds √† un questionnaire de 21 questions. L'IA analyse tes r√©ponses pour r√©v√©ler ton <strong>Arch√©type de personnalit√©</strong> (ex: "L'Architecte Logique"), g√©n√®re une analyse d√©taill√©e et cr√©e une <strong>synth√®se visuelle (graphique RIASEC)</strong> de tes p√¥les d'int√©r√™ts. Tu peux aussi croiser ces r√©sultats avec ceux de tests externes pour une analyse encore plus fine.</p><div class="conseil-prof"><strong>Conseil :</strong> R√©ponds honn√™tement ! Il n'y a pas de bonnes ou de mauvaises r√©ponses. Le but est de cr√©er une base solide pour la suite.</div></div>
        <div class="etape"><h4>üíº Mon Portfolio de Comp√©tences</h4><p><strong>Objectif :</strong> Cr√©er un portfolio unique de tes atouts, bas√© sur ce que tu fais et ce que tu es, pour valoriser tes candidatures (Parcoursup, Grand Oral...).</p><p><strong>Fonctionnement :</strong> Cette √©tape propose deux ateliers puissants : 1. L'<strong>Analyseur d'exp√©riences</strong> transforme tes r√©cits (stage, passion, projet...) en paragraphes r√©dig√©s et percutants. 2. Le <strong>D√©tecteur de comp√©tences</strong> r√©v√®le tes forces transversales (Rigueur, Cr√©ativit√©, Leadership...) via un quiz rapide.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est une √©tape cruciale. Savoir parler de soi et de ses comp√©tences est un atout majeur pour Parcoursup et au-del√†.</div></div>
        <div class="etape"><h4>üì∞ L'Actu</h4><p><strong>Objectif :</strong> Rester inform√©(e) sur le monde des √©tudes et des m√©tiers en consultant des articles ou des classements.</p><p><strong>Fonctionnement :</strong> Explore des sites comme L'√âtudiant.fr ou Studyrama. Pour chaque info que tu trouves, l'IA peut l'analyser pour te dire en quoi elle est pertinente par rapport √† ton propre profil.</p><div class="conseil-prof"><strong>Conseil :</strong> Croiser les sources d'information est essentiel. L'analyse de l'IA t'aidera √† prendre du recul sur ce que tu lis.</div></div>
        <div class="etape"><h4>üìö Les Fondations (avec Onisep)</h4><p><strong>Objectif :</strong> D√©couvrir des m√©tiers sur la base d'informations fiables et officielles.</p><p><strong>Fonctionnement :</strong> Explore des fiches m√©tiers sur Onisep.fr. Pour chaque m√©tier, l'IA peut <strong>simuler une "journ√©e type"</strong>, trouver des <strong>t√©moignages</strong> ou g√©n√©rer un <strong>tableau comparatif</strong> pour t'aider √† choisir entre plusieurs pistes.</p><div class="conseil-prof"><strong>Conseil :</strong> L'Onisep est la source la plus neutre et la plus compl√®te. C'est le point de d√©part incontournable.</div></div>
        <div class="etape"><h4>üéì Le Catalogue (avec Parcoursup)</h4><p><strong>Objectif :</strong> Apprendre √† utiliser le moteur de recherche des formations post-bac comme un expert.</p><p><strong>Fonctionnement :</strong> Copie-colle les "attendus" d'une formation qui t'int√©resse, et l'IA g√©n√®re un <strong>rapport de compatibilit√© personnalis√©</strong> en analysant l'ensemble de ton journal de bord pour voir si ton profil correspond.</p><div class="conseil-prof"><strong>Conseil :</strong> Utilise Parcoursup d√®s la Seconde pour explorer, sans la pression des v≈ìux. C'est le meilleur catalogue de formations qui existe.</div></div>
        <div class="etape"><h4>‚úÖ Fact Checking</h4><p><strong>Objectif :</strong> Tester tes connaissances et d√©construire les id√©es re√ßues sur certains m√©tiers ou fili√®res.</p><p><strong>Fonctionnement :</strong> L'outil te propose deux ateliers : la "Chasse aux Mythes" (quiz g√©n√©rique) et le "D√©fi Personnalis√©" (un quiz sur-mesure qui te questionne par rapport √† ton propre profil).</p><div class="conseil-prof"><strong>Conseil :</strong> C'est une fa√ßon ludique de v√©rifier tes informations et d'ouvrir tes horizons en combattant les pr√©jug√©s.</div></div>
        <div class="etape"><h4>üß≠ Le simulateur de sp√©cialit√©s (avec Horizons21)</h4><p><strong>Objectif :</strong> Faire le lien entre les mati√®res choisies au lyc√©e et les fili√®res d'√©tudes sup√©rieures.</p><p><strong>Fonctionnement :</strong> Teste des combinaisons de sp√©cialit√©s et analyse les "horizons" qu'elles t'ouvrent. L'IA peut aussi te donner un t√©moignage d'√©tudiant pour t'aider √† te projeter.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est l'outil essentiel pour faire tes choix en fin de Seconde et de Premi√®re de mani√®re √©clair√©e.</div></div>
        <div class="etape"><h4>üí¨ L'Exp√©rience (avec Inspire)</h4><p><strong>Objectif :</strong> Obtenir un retour authentique de la part d'√©tudiants.</p><p><strong>Fonctionnement :</strong> L'outil t'aide √† pr√©parer des questions pertinentes, puis te propose un <strong>simulateur d'entretien</strong> pour t'entra√Æner √† discuter avec un "√©tudiant √©claireur" virtuel.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est le meilleur moyen de conna√Ætre la "vraie vie" d'une formation, au-del√† des brochures officielles.</div></div>
        <div class="etape"><h4>üöÄ Passer √† l'action</h4><p><strong>Objectif :</strong> Pr√©parer des rencontres avec des professionnels et des visites d'√©tablissements.</p><p><strong>Fonctionnement :</strong> Utilise le <strong>gestionnaire de contacts</strong> pour ajouter ton r√©seau personnel et trouver des professionnels via l'IA. Tu peux suivre le statut de tes prises de contact et obtenir de l'aide pour r√©diger tes mails.</p><div class="conseil-prof"><strong>Conseil :</strong> La recherche en ligne est une chose, la r√©alit√© du terrain en est une autre. Une rencontre peut tout changer !</div></div>
        <div class="etape"><h4>üåç Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> Trouver des √©v√©nements (salons, JPO) et des structures d'aide pr√®s de chez toi.</p><p><strong>Fonctionnement :</strong> Indique ta ville, et l'IA recherche les √©v√©nements pertinents. Tu peux m√™me ajouter un salon ou une JPO directement √† ton R√©troplanning en un clic.</p><div class="conseil-prof"><strong>Conseil :</strong> L'orientation se fait aussi sur le terrain. Une visite ou une rencontre peut parfois tout changer.</div></div>
        <div class="etape"><h4>‚úçÔ∏è Pr√©parer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> R√©diger un "projet de formation motiv√©" clair et percutant pour Parcoursup.</p><p><strong>Fonctionnement :</strong> L'IA te propose une structure pour ta lettre. Ensuite, l'<strong>Atelier d'√©criture</strong> te permet de soumettre un brouillon de paragraphe et d'obtenir des conseils cibl√©s pour l'am√©liorer, sans jamais l'√©crire √† ta place.</p><div class="conseil-prof"><strong>Conseil :</strong> Une lettre bien structur√©e a plus d'impact qu'un long texte confus. Cet outil t'apprend √† √™tre clair et convaincant.</div></div>
        <div class="etape"><h4>üîÆ Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> Pr√©parer l'apr√®s-Parcoursup, y compris les refus.</p><p><strong>Fonctionnement :</strong> Utilise la <strong>simulation de conversation "Plan B"</strong> pour dialoguer avec l'IA et explorer des alternatives de mani√®re constructive si ton v≈ìu n¬∞1 est refus√©.</p><div class="conseil-prof"><strong>Conseil :</strong> Une bonne orientation, c'est aussi √™tre bien pr√©par√© pour la suite. Ces √©tapes te donnent les cl√©s pour une transition r√©ussie.</div></div>
        <div class="etape"><h4>üí∂ Simulateur Vie √âtudiante</h4><p><strong>Objectif :</strong> Se projeter concr√®tement dans sa future vie d'√©tudiant.</p><p><strong>Fonctionnement :</strong> Estime le co√ªt de la vie dans ta future ville d'√©tudes et d√©couvre les principales aides financi√®res, avec des liens directs et fiables vers les sites officiels.</p><div class="conseil-prof"><strong>Conseil :</strong> L'aspect financier est une partie importante du projet. L'anticiper permet de faire des choix plus sereins.</div></div>
        <h3 class="centered-subtitle">Les Outils Centraux et Transversaux</h3>
        <div class="etape"><h4>üóìÔ∏è Mon R√©troplanning</h4><p><strong>Objectif :</strong> Planifier son ann√©e sans stress en visualisant les grandes √©ch√©ances.</p><p><strong>Fonctionnement :</strong> L'IA g√©n√®re un calendrier d'actions mois par mois adapt√© √† ta classe (Seconde, Premi√®re, Terminale). Tu peux cocher les t√¢ches accomplies.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est l'outil parfait pour ne jamais √™tre pris de court. Une ann√©e bien planifi√©e est une ann√©e plus sereine.</div></div>
        <div class="etape"><h4>üìì Mon Journal de Bord</h4><p><strong>Objectif :</strong> Centraliser et synth√©tiser toutes tes r√©flexions au m√™me endroit.</p><p><strong>Fonctionnement :</strong> Retrouve les synth√®ses de ton travail (organis√©es en sections d√©pliables), ta <strong>Carte d'Orientation</strong> et ton profil visuel. L'IA peut g√©n√©rer un <strong>"Fil Rouge"</strong> pour r√©sumer ton projet. Une fonction de partage est disponible pour √©changer avec tes proches.</p><div class="conseil-prof"><strong>Conseil :</strong> Ce journal est la base de discussion la plus concr√®te et la plus riche que tu puisses avoir avec tes parents ou ton professeur principal.</div></div>
        <div class="etape"><h4>üó∫Ô∏è Ma Carte d'Orientation Personnelle</h4><p><strong>Objectif :</strong> Visualiser ton projet d'orientation en un seul coup d'≈ìil.</p><p><strong>Fonctionnement :</strong> Situ√©e en haut de ton Journal de Bord, cette carte se remplit automatiquement au fur et √† mesure que tu compl√®tes les √©tapes. Elle connecte ton profil, les m√©tiers que tu explores et les comp√©tences que tu identifies.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est la synth√®se la plus visuelle et la plus motivante de ton parcours. Regarde-la se construire !</div></div>
        <div class="etape"><h4>üìä Ma Synth√®se Visuelle (Infographie)</h4><p><strong>Objectif :</strong> Comprendre tes p√¥les d'int√©r√™ts dominants en un clin d'≈ìil.</p><p><strong>Fonctionnement :</strong> Situ√© dans ton Journal de Bord, ce <strong>graphique en barres (RIASEC)</strong> se base sur tes r√©ponses de l'√©tape "Mieux se conna√Ætre". Il te montre tes grands types d'int√©r√™ts (R√©aliste, Investigateur, Artistique, Social, Entreprenant, Conventionnel).</p><div class="conseil-prof"><strong>Conseil :</strong> Ce graphique t'aide √† comprendre dans quel type d'environnement (concret, intellectuel, cr√©atif...) tu pourrais le plus t'√©panouir.</div></div>
        <div class="etape"><h4>ü§ñ Ton Coach Orientation (Chatbot)</h4><p><strong>Objectif :</strong> Obtenir des r√©ponses rapides et fiables sur l'orientation.</p><p><strong>Fonctionnement :</strong> Une fen√™tre de discussion est disponible en permanence pour poser des questions sur une formation, un m√©tier, ou le fonctionnement de Parcoursup. L'IA se base sur des sources officielles pour te r√©pondre.</p><div class="conseil-prof"><strong>Conseil :</strong> Utilise-le pour d√©crypter le jargon de Parcoursup et obtenir des informations pr√©cises sur une formation qui t'int√©resse.</div></div>
        <div class="etape"><h4>üì° Le Radar √† Opportunit√©s</h4><p><strong>Objectif :</strong> D√©bloquer ta r√©flexion en d√©couvrant une piste de m√©tier ou de secteur inattendue mais pertinente.</p><p><strong>Fonctionnement :</strong> En un clic, l'IA analyse l'int√©gralit√© de ton journal de bord pour analyser une de tes id√©es ou pour te proposer une piste "hors des sentiers battus" qui correspond √† ton profil profond.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est l'outil id√©al lorsque tu as l'impression de tourner en rond. Laisse-toi surprendre !</div></div>
        <div class="etape"><h4>üèÜ Le Syst√®me de Badges</h4><p><strong>Objectif :</strong> Valoriser et r√©compenser ta progression.</p><p><strong>Fonctionnement :</strong> En compl√©tant des ensembles d'√©tapes cl√©s, tu d√©bloques des badges qui apparaissent sur ta page d'accueil pour symboliser tes accomplissements.</p><div class="conseil-prof"><strong>Conseil :</strong> Les badges sont un excellent moyen de visualiser tes progr√®s et de rester motiv√©.</div></div>
    `;

    // Ajoutez ces blocs de code apr√®s partie4FonctionnalitesHTML_base
const partie4FonctionnalitesHTML_parents = `
        <h2>Partie 2 : Exploration D√©taill√©e des Fonctionnalit√©s</h2>
        <h3 class="centered-subtitle">Les √âtapes Cl√©s de l'Exploration de votre enfant</h3>
        <div class="etape"><h4>üë§ Mieux se conna√Ætre</h4><p><strong>Objectif :</strong> Aider votre enfant √† dresser un portrait de sa personnalit√© et de ses pr√©f√©rences.</p><p><strong>Fonctionnement :</strong> Il/elle r√©pond √† un questionnaire de 21 questions. L'IA analyse ses r√©ponses pour r√©v√©ler son <strong>Arch√©type de personnalit√©</strong> (ex: "L'Architecte Logique"), g√©n√©rer une analyse d√©taill√©e et cr√©er un <strong>graphique de ses p√¥les d'int√©r√™ts (RIASEC)</strong>.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Invitez-le/la √† r√©pondre honn√™tement. L'objectif est de l'aider √† mieux se conna√Ætre, pas de l'√©valuer. C'est un excellent point de d√©part pour une discussion.</div></div>
        <div class="etape"><h4>üíº Mon Portfolio de Comp√©tences</h4><p><strong>Objectif :</strong> L'aider √† cr√©er un portfolio unique de ses atouts, bas√© sur ce qu'il/elle fait et ce qu'il/elle est.</p><p><strong>Fonctionnement :</strong> Cette √©tape propose deux ateliers. L'un l'aide √† transformer ses exp√©riences (stage, projet, passion...) en paragraphes valorisables pour ses candidatures. L'autre est un 'd√©tecteur' rapide pour r√©v√©ler ses comp√©tences transversales (rigueur, cr√©ativit√©...).</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est une √©tape cruciale pour son dossier Parcoursup et son Grand Oral. Encouragez-le/la √† la compl√©ter en d√©tail.</div></div>
        <div class="etape"><h4>üì∞ L'Actu</h4><p><strong>Objectif :</strong> L'aider √† s'informer sur les classements et l'actualit√© du monde des √©tudes.</p><p><strong>Fonctionnement :</strong> Quand il/elle trouve une information int√©ressante, l'IA peut l'analyser en la croisant avec son profil personnel pour voir en quoi elle est pertinente pour lui/elle.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Discuter de l'actualit√© de l'orientation est un bon moyen de rester connect√©(e) √† sa r√©flexion.</div></div>
        <div class="etape"><h4>üìö Les Fondations (avec Onisep)</h4><p><strong>Objectif :</strong> L'aider √† d√©couvrir des m√©tiers sur la base d'informations fiables et officielles.</p><p><strong>Fonctionnement :</strong> Il/elle peut explorer des fiches m√©tiers, mais aussi utiliser l'IA pour <strong>simuler une "journ√©e type"</strong> d'un professionnel ou g√©n√©rer un <strong>tableau comparatif</strong> entre plusieurs m√©tiers qui l'int√©ressent.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'Onisep est la source la plus neutre et la plus compl√®te. C'est le point de d√©part incontournable pour ses recherches.</div></div>
        <div class="etape"><h4>üéì Le Catalogue (avec Parcoursup)</h4><p><strong>Objectif :</strong> L'aider √† utiliser le moteur de recherche des formations post-bac comme un expert.</p><p><strong>Fonctionnement :</strong> L'outil va au-del√† de la simple recherche. Il peut g√©n√©rer un <strong>rapport de compatibilit√© personnalis√©</strong> entre le profil complet de votre enfant et les "attendus" d'une formation.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Utiliser Parcoursup d√®s la Seconde pour explorer, sans la pression des v≈ìux, est une excellente strat√©gie. C'est le meilleur catalogue de formations qui existe.</div></div>
        <div class="etape"><h4>‚úÖ Fact Checking</h4><p><strong>Objectif :</strong> Tester ses connaissances et d√©construire les id√©es re√ßues sur certains m√©tiers ou fili√®res.</p><p><strong>Fonctionnement :</strong> Il/elle peut lancer un quiz g√©n√©rique ("Chasse aux Mythes") ou un "D√©fi Personnalis√©" qui le questionne par rapport √† son propre profil.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est une fa√ßon ludique de v√©rifier ses informations et d'ouvrir ses horizons en combattant les pr√©jug√©s.</div></div>
        <div class="etape"><h4>üß≠ Le simulateur de sp√©cialit√©s (avec Horizons21)</h4><p><strong>Objectif :</strong> L'aider √† faire le lien entre les mati√®res choisies au lyc√©e et les fili√®res d'√©tudes sup√©rieures.</p><p><strong>Fonctionnement :</strong> Il/elle teste des combinaisons de sp√©cialit√©s et analyse les "horizons" (domaines d'√©tudes) qu'elles lui ouvrent.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est l'outil essentiel pour l'aider √† faire des choix √©clair√©s en fin de Seconde et de Premi√®re.</div></div>
        <div class="etape"><h4>üí¨ L'Exp√©rience (avec Inspire)</h4><p><strong>Objectif :</strong> L'encourager √† obtenir un retour authentique de la part d'√©tudiants.</p><p><strong>Fonctionnement :</strong> L'outil l'aide √† pr√©parer des questions pertinentes et propose un <strong>simulateur d'entretien</strong> pour qu'il/elle s'entra√Æne √† discuter avec un √©tudiant virtuel et gagne en confiance.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est le meilleur moyen de conna√Ætre la "vraie vie" d'une formation, au-del√† des brochures officielles.</div></div>
        <div class="etape"><h4>üöÄ Passer √† l'action</h4><p><strong>Objectif :</strong> L'aider √† pr√©parer des rencontres avec des professionnels et des visites d'√©tablissements.</p><p><strong>Fonctionnement :</strong> L'application propose un <strong>gestionnaire de contacts</strong> o√π il/elle peut lister des personnes √† interroger, suivre l'avancement de ses d√©marches et obtenir de l'aide pour r√©diger un mail de contact.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Une rencontre sur le terrain peut tout changer. Vous pouvez aussi l'aider en mobilisant votre propre r√©seau.</div></div>
        <div class="etape"><h4>üåç Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> L'aider √† trouver des √©v√©nements et des structures d'aide pr√®s de chez lui/elle.</p><p><strong>Fonctionnement :</strong> Il/elle indique sa ville, et l'IA recherche les √©v√©nements pertinents. Il/elle peut ajouter une JPO ou un salon directement √† son <strong>R√©troplanning</strong>.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'orientation se fait aussi sur le terrain. Accompagner votre enfant √† un salon peut √™tre un moment d'√©change privil√©gi√©.</div></div>
        <div class="etape"><h4>‚úçÔ∏è Pr√©parer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> L'aider √† r√©diger un "projet de formation motiv√©" clair et percutant pour Parcoursup.</p><p><strong>Fonctionnement :</strong> En plus de lui proposer une structure, l'outil dispose d'un <strong>Atelier d'√©criture</strong> o√π il/elle peut soumettre un brouillon de paragraphe et recevoir des conseils pour l'am√©liorer.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Une lettre bien structur√©e a plus d'impact qu'un long texte confus. Cet outil lui apprend √† √™tre clair et convaincant.</div></div>
        <div class="etape"><h4>üîÆ Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> L'aider √† pr√©parer l'apr√®s-Parcoursup et √† g√©rer le stress des r√©ponses.</p><p><strong>Fonctionnement :</strong> L'IA propose une <strong>simulation de conversation "Plan B"</strong> pour l'aider √† r√©fl√©chir √† des alternatives de mani√®re positive en cas de refus de son v≈ìu n¬∞1.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Une bonne orientation, c'est aussi √™tre bien pr√©par√© pour la suite. Cet outil peut l'aider √† relativiser et √† envisager d'autres chemins.</div></div>
        <div class="etape"><h4>üí∂ Simulateur Vie √âtudiante</h4><p><strong>Objectif :</strong> L'aider √† se projeter concr√®tement dans sa future vie d'√©tudiant.</p><p><strong>Fonctionnement :</strong> Il/elle peut estimer le co√ªt de la vie dans sa future ville d'√©tudes et d√©couvrir les principales aides financi√®res. C'est un excellent support pour une discussion en famille.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'aspect financier est une partie importante du projet. L'anticiper ensemble permet de faire des choix plus sereins.</div></div>
        <h3 class="centered-subtitle">Les Outils Centraux et Transversaux</h3>
        <div class="etape"><h4>üóìÔ∏è Mon R√©troplanning</h4><p><strong>Objectif :</strong> L'aider √† planifier son ann√©e sans stress en visualisant les grandes √©ch√©ances.</p><p><strong>Fonctionnement :</strong> L'IA g√©n√®re un calendrier d'actions mois par mois adapt√© √† sa classe. Il/elle peut cocher les t√¢ches accomplies.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est l'outil parfait pour ne jamais √™tre pris de court. Une ann√©e bien planifi√©e est une ann√©e plus sereine.</div></div>
        <div class="etape"><h4>üìì Mon Journal de Bord</h4><p><strong>Objectif :</strong> Lui permettre de centraliser et de synth√©tiser toutes ses r√©flexions au m√™me endroit.</p><p><strong>Fonctionnement :</strong> Il/elle y retrouve les synth√®ses de son travail (dans des sections d√©pliables), sa <strong>Carte d'Orientation</strong> et son profil visuel. Une fonction de <strong>partage</strong> est disponible pour vous permettre d'√©changer avec lui/elle.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Ce journal est la base de discussion la plus concr√®te et la plus riche que vous puissiez avoir avec votre enfant. Utilisez le bouton "Pr√©parer une discussion" sur la page partag√©e.</div></div>
        <div class="etape"><h4>üó∫Ô∏è Ma Carte d'Orientation Personnelle</h4><p><strong>Objectif :</strong> Lui permettre de visualiser son projet d'orientation en un seul coup d'≈ìil.</p><p><strong>Fonctionnement :</strong> Situ√©e en haut de son Journal de Bord, cette carte se remplit automatiquement. Elle connecte son profil, les m√©tiers qu'il/elle explore et les comp√©tences qu'il/elle identifie.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est la synth√®se la plus visuelle et la plus motivante de son parcours. Montrez-lui comment elle se construit !</div></div>
        <div class="etape"><h4>üìä Ma Synth√®se Visuelle (Infographie)</h4><p><strong>Objectif :</strong> L'aider √† comprendre ses p√¥les d'int√©r√™ts dominants.</p><p><strong>Fonctionnement :</strong> Situ√© dans son Journal de Bord, ce <strong>graphique en barres (RIASEC)</strong> lui montre ses grands types d'int√©r√™ts (ex: Social, Investigateur, Artistique...).</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Ce graphique est un tr√®s bon support pour l'aider √† comprendre dans quel type d'environnement il/elle pourrait le plus s'√©panouir.</div></div>
        <div class="etape"><h4>ü§ñ Ton Coach Orientation (Chatbot)</h4><p><strong>Objectif :</strong> Obtenir des r√©ponses rapides et fiables sur le fonctionnement de Parcoursup.</p><p><strong>Fonctionnement :</strong> Une fen√™tre de discussion est disponible en permanence pour qu'il/elle puisse poser des questions sur une formation, le calendrier, les types de v≈ìux, etc.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Sugg√©rez-lui de l'utiliser pour d√©crypter le jargon de Parcoursup et obtenir des informations pr√©cises sur une formation qui l'int√©resse.</div></div>
        <div class="etape"><h4>üì° Le Radar √† Opportunit√©s</h4><p><strong>Objectif :</strong> D√©bloquer sa r√©flexion en d√©couvrant une piste de m√©tier ou de secteur inattendue mais pertinente.</p><p><strong>Fonctionnement :</strong> En un clic, l'IA analyse l'int√©gralit√© de son journal de bord pour lui proposer une piste "hors des sentiers battus" qui correspond √† son profil.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est l'outil id√©al lorsqu'il/elle a l'impression de tourner en rond. Invitez-le/la √† se laisser surprendre !</div></div>
        <div class="etape"><h4>üèÜ Le Syst√®me de Badges</h4><p><strong>Objectif :</strong> Valoriser et r√©compenser sa progression.</p><p><strong>Fonctionnement :</strong> En compl√©tant des ensembles d'√©tapes cl√©s, il/elle d√©bloque des badges qui apparaissent sur sa page d'accueil pour symboliser ses accomplissements.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Les badges sont un excellent moyen pour lui/elle de visualiser ses progr√®s et de rester motiv√©(e). F√©licitez-le/la !</div></div>
`;

const partie4FonctionnalitesHTML_enseignants = `
        <h2>Partie 2 : Exploration D√©taill√©e des Fonctionnalit√©s</h2>
        <h3 class="centered-subtitle">Les √âtapes Cl√©s et leurs Applications P√©dagogiques</h3>
        <div class="etape"><h4>üë§ Mieux se conna√Ætre</h4><p><strong>Objectif :</strong> Permettre √† l'√©l√®ve de dresser un portrait de sa personnalit√©, de ses int√©r√™ts et de ses motivations.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve r√©pond √† un questionnaire de 21 questions. L'IA analyse ses r√©ponses pour r√©v√©ler un <strong>Arch√©type de personnalit√©</strong>, g√©n√®re une analyse d√©taill√©e et un <strong>graphique de ses p√¥les d'int√©r√™ts (RIASEC)</strong>.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est une excellente base pour un entretien individuel. L'Arch√©type et le graphique RIASEC fournissent un vocabulaire et un support visuel pour aider l'√©l√®ve √† parler de lui.</div></div>
        <div class="etape"><h4>üíº Mon Portfolio de Comp√©tences</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† identifier et valoriser ses comp√©tences, y compris celles acquises dans des contextes non-formels.</p><p><strong>Fonctionnement :</strong> Cette √©tape propose deux ateliers : un <strong>analyseur d'exp√©riences</strong> pour transformer un r√©cit en paragraphe de candidature (m√©thode STAR), et un <strong>d√©tecteur de comp√©tences</strong> transversales via un quiz.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Outil tr√®s pertinent pour la pr√©paration au Grand Oral et pour l'enseignement de la comp√©tence "Savoir parler de soi".</div></div>
        <div class="etape"><h4>üì∞ L'Actu</h4><p><strong>Objectif :</strong> D√©velopper l'esprit critique de l'√©l√®ve face √† l'information sur l'orientation.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut soumettre une information ou un classement trouv√© en ligne, et l'IA l'analyse en la mettant en perspective avec son propre profil.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Peut servir de support pour des s√©ances d'EMI (√âducation aux M√©dias et √† l'Information) appliqu√©es √† l'orientation.</div></div>
        <div class="etape"><h4>üìö Les Fondations (avec Onisep)</h4><p><strong>Objectif :</strong> Ancrer la recherche de l'√©l√®ve dans des sources fiables et l'aider √† se projeter.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut explorer des m√©tiers et utiliser l'IA pour <strong>simuler une "journ√©e type"</strong> ou g√©n√©rer un <strong>tableau comparatif</strong> entre plusieurs pistes.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Ces outils interactifs favorisent une exploration plus active et approfondie que la simple lecture de fiches.</div></div>
        <div class="etape"><h4>üéì Le Catalogue (avec Parcoursup)</h4><p><strong>Objectif :</strong> Apprendre √† l'√©l√®ve √† d√©crypter une fiche formation et √† s'auto-√©valuer.</p><p><strong>Fonctionnement :</strong> La fonction de <strong>rapport de compatibilit√© personnalis√©</strong> croise l'ensemble des donn√©es du journal de l'√©l√®ve avec les "attendus" d'une formation.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Encouragez les √©l√®ves √† utiliser cet outil pour objectiver leurs choix et pr√©parer leurs arguments pour le projet de formation motiv√©.</div></div>
        <div class="etape"><h4>‚úÖ Fact Checking</h4><p><strong>Objectif :</strong> D√©construire les st√©r√©otypes sur les fili√®res et les m√©tiers de mani√®re ludique.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut lancer un quiz g√©n√©rique ou un "D√©fi Personnalis√©" qui le questionne par rapport √† son propre profil.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Id√©al pour une s√©ance collective dynamique, en √©quipes, pour lancer des d√©bats et ouvrir les horizons.</div></div>
        <div class="etape"><h4>üß≠ Le simulateur de sp√©cialit√©s (avec Horizons21)</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† faire des choix de sp√©cialit√©s √©clair√©s.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve teste des combinaisons de sp√©cialit√©s et analyse les "horizons" qu'elles lui ouvrent.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est l'outil essentiel √† mobiliser lors des s√©ances d'accompagnement au choix en Seconde et en Premi√®re.</div></div>
        <div class="etape"><h4>üí¨ L'Exp√©rience (avec Inspire)</h4><p><strong>Objectif :</strong> Pr√©parer l'√©l√®ve √† des interactions r√©elles et d√©velopper son aisance orale.</p><p><strong>Fonctionnement :</strong> L'outil propose un <strong>simulateur d'entretien</strong> o√π l'√©l√®ve peut s'entra√Æner √† dialoguer avec un √©tudiant virtuel.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Tr√®s utile pour les √©l√®ves les plus timides afin de pr√©parer des JPO ou des entretiens de stage.</div></div>
        <div class="etape"><h4>üöÄ Passer √† l'action</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† structurer sa d√©marche de prise de contact.</p><p><strong>Fonctionnement :</strong> Le <strong>gestionnaire de contacts</strong> permet de suivre l'avancement des d√©marches (contact√©, r√©ponse re√ßue...). L'IA peut aider √† la r√©daction de mails.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Peut servir de support √† un projet o√π les √©l√®ves doivent interviewer des professionnels.</div></div>
        <div class="etape"><h4>üåç Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> Connecter le projet de l'√©l√®ve aux ressources et √©v√©nements locaux.</p><p><strong>Fonctionnement :</strong> L'IA recherche les JPO, salons et structures d'aide locales. Les √©v√©nements peuvent √™tre ajout√©s en un clic au <strong>R√©troplanning</strong> de l'√©l√®ve.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Utile pour communiquer les dates importantes de l'orientation sur le territoire de l'√©tablissement.</div></div>
        <div class="etape"><h4>‚úçÔ∏è Pr√©parer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† am√©liorer la qualit√© r√©dactionnelle de son projet de formation motiv√©.</p><p><strong>Fonctionnement :</strong> L'<strong>Atelier d'√©criture</strong> permet √† l'√©l√®ve de soumettre un brouillon de paragraphe et de recevoir des conseils d'am√©lioration cibl√©s.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Cet outil ne fait pas le travail √† la place de l'√©l√®ve mais lui apprend √† affiner son argumentation, une comp√©tence cl√©.</div></div>
        <div class="etape"><h4>üîÆ Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> D√©velopper la r√©silience et la capacit√© de l'√©l√®ve √† envisager des plans alternatifs.</p><p><strong>Fonctionnement :</strong> La <strong>simulation de conversation "Plan B"</strong> est un dialogue coach√© avec l'IA pour aider l'√©l√®ve √† g√©rer la d√©ception d'un refus et √† rebondir.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Un outil int√©ressant pour travailler les comp√©tences psycho-sociales li√©es √† l'orientation.</div></div>
        <div class="etape"><h4>üí∂ Simulateur Vie √âtudiante</h4><p><strong>Objectif :</strong> Ancrer le projet d'√©tudes dans la r√©alit√© mat√©rielle et financi√®re.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut estimer le co√ªt de la vie dans une ville et d√©couvrir les aides financi√®res.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Parfait pour une s√©ance sur l'autonomie et la pr√©paration √† la vie √©tudiante.</div></div>
        <h3 class="centered-subtitle">Les Outils Centraux et Transversaux</h3>
        <div class="etape"><h4>üóìÔ∏è Mon R√©troplanning</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† planifier son ann√©e et √† visualiser les √©ch√©ances.</p><p><strong>Fonctionnement :</strong> L'IA g√©n√®re un calendrier d'actions mois par mois adapt√© √† chaque niveau de classe.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Un excellent support visuel √† pr√©senter en d√©but d'ann√©e pour fixer le cap du Parcours Avenir.</div></div>
        <div class="etape"><h4>üìì Mon Journal de Bord</h4><p><strong>Objectif :</strong> Centraliser la r√©flexion de l'√©l√®ve pour faciliter le suivi.</p><p><strong>Fonctionnement :</strong> Le journal synth√©tise tout le travail de l'√©l√®ve. La fonction de <strong>partage</strong> est essentielle : elle vous donne acc√®s √† une vue d'ensemble de sa d√©marche avant un entretien.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Ce journal est la base de discussion la plus concr√®te et la plus riche que vous puissiez avoir avec un √©l√®ve lors d'un entretien de suivi. Utilisez le bouton "Pr√©parer une discussion" sur la page partag√©e.</div></div>
        <div class="etape"><h4>üó∫Ô∏è Ma Carte d'Orientation Personnelle</h4><p><strong>Objectif :</strong> Offrir √† l'√©l√®ve une vision synth√©tique et motivante de son projet.</p><p><strong>Fonctionnement :</strong> Situ√©e en haut du Journal de Bord, cette carte se remplit automatiquement et connecte le profil de l'√©l√®ve, ses explorations et ses comp√©tences.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est la synth√®se la plus visuelle du parcours de l'√©l√®ve, tr√®s utile pour commencer un entretien.</div></div>
        <div class="etape"><h4>üìä Ma Synth√®se Visuelle (Infographie)</h4><p><strong>Objectif :</strong> Comprendre rapidement les grands p√¥les d'int√©r√™ts d'un √©l√®ve.</p><p><strong>Fonctionnement :</strong> Le <strong>graphique en barres (RIASEC)</strong> du Journal de Bord offre un aper√ßu imm√©diat du profil de l'√©l√®ve (Social, Investigateur, Artistique...).</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Cet outil visuel permet de cerner rapidement un profil et d'orienter plus efficacement la discussion lors d'un entretien.</div></div>
        <div class="etape"><h4>ü§ñ Ton Coach Orientation (Chatbot)</h4><p><strong>Objectif :</strong> Fournir aux √©l√®ves un acc√®s √† des informations fiables et v√©rifi√©es.</p><p><strong>Fonctionnement :</strong> Le chatbot est programm√© pour baser ses r√©ponses sur des sources officielles (Parcoursup, Onisep, etc.).</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Encouragez son utilisation pour des questions factuelles, afin de lib√©rer du temps en entretien pour des discussions plus approfondies.</div></div>
        <div class="etape"><h4>üì° Le Radar √† Opportunit√©s</h4><p><strong>Objectif :</strong> D√©bloquer un √©l√®ve qui a l'impression de tourner en rond.</p><p><strong>Fonctionnement :</strong> En analysant tout le journal, l'IA peut sugg√©rer une piste de m√©tier "hors des sentiers battus" mais coh√©rente avec le profil profond de l'√©l√®ve.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est un excellent outil de rem√©diation √† proposer √† un √©l√®ve qui manque d'id√©es ou qui est fix√© sur une seule voie.</div></div>
        <div class="etape"><h4>üèÜ Le Syst√®me de Badges</h4><p><strong>Objectif :</strong> Gamifier le parcours d'orientation pour maintenir la motivation.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve d√©bloque des badges en accomplissant des ensembles d'√©tapes significatives.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Les badges peuvent servir de jalons pour suivre la progression d'une cohorte d'√©l√®ves.</div></div>
`;


    const partie5TechHTML_base = `
        <h2>Partie 3 : Technologie et Donn√©es Personnelles</h2>
        <div class="etape">
            <h4>Le Mod√®le d'IA Utilis√©</h4>
            <p>L'intelligence artificielle int√©gr√©e √† cette application est propuls√©e par <strong>Gemini 1.5 Flash</strong>, un mod√®le de langage multimodal d√©velopp√© par Google. C'est cet outil qui permet d'analyser vos notes, de g√©n√©rer des suggestions, de synth√©tiser des informations ou de faire des recherches web cibl√©es pour enrichir votre r√©flexion.</p>
        </div>
        <div class="etape">
            <h4>Vos Donn√©es Personnelles</h4>
            <div class="conseil-prof" style="font-style: normal;">
                La protection de vos donn√©es est une priorit√© absolue. Voici en toute transparence comment elles sont g√©r√©es :
                <ul>
                    <li><strong>Quelles donn√©es sont collect√©es ?</strong> L'application collecte uniquement les informations que vous fournissez : votre nom, pr√©nom, email, nom de votre lyc√©e, ainsi que toutes les notes que vous inscrivez dans votre journal de bord.</li>
                    <li><strong>Qui les collecte et o√π sont-elles h√©berg√©es ?</strong> Vos donn√©es sont collect√©es par les concepteurs de l'application, et sont stock√©es de mani√®re s√©curis√©e sur <strong>Firebase</strong>, une plateforme de Google. L'h√©bergement se fait sur des serveurs s√©curis√©s en Europe.</li>
                    <li><strong>Comment sont-elles utilis√©es ?</strong> Vos donn√©es ne sont utilis√©es <strong>que pour le fonctionnement de l'application</strong>. Votre journal de bord est envoy√© √† l'IA Gemini pour g√©n√©rer les r√©ponses contextuelles, mais il n'est pas utilis√© pour entra√Æner le mod√®le global de Google. Vos donn√©es ne sont jamais partag√©es avec des tiers ni utilis√©es √† des fins commerciales.</li>
                    <li><strong>Qui peut y acc√©der ?</strong> Vous seul(e) pouvez acc√©der √† vos donn√©es via votre compte. Si vous utilisez la fonction de partage, la personne d√©tentrice du lien pourra voir une version "lecture seule" de votre journal.</li>
                </ul>
            </div>
        </div>
    `;

    // --- 2. Assemblage dynamique du guide final ---
    let finalGuideHTML = '';

    
   switch (guideUserRole) {
        case 'parent':
            finalGuideHTML = introHTML +
                             partie2ParentsHTML +
                             partie4FonctionnalitesHTML_parents + // Utilisez la nouvelle constante ici
                             partie5TechHTML_base; // Vous pouvez aussi cr√©er une version parent de ce texte si n√©cessaire
            break;
        case 'enseignant':
            finalGuideHTML = introHTML +
                             partie3EnseignantsHTML +
                             partie4FonctionnalitesHTML_enseignants + // Utilisez la nouvelle constante ici
                             seancesEnseignantsHTML +
                             partie5TechHTML_base;
            break;
        case 'eleve':
        default:
            finalGuideHTML = introHTML +
                             partie1ElevesHTML +
                             partie4FonctionnalitesHTML_base +
                             partie5TechHTML_base;
            break;
    }
    // 3. Injection dans le DOM et gestion du bouton retour
    div.innerHTML = `
      <div class="grid grid-cols-3 items-center mb-6">
    <div class="text-left">
        <button id="guideBackBtn" class="text-cyan-600 hover:text-cyan-800 font-bold">‚Üê Retour</button>
    </div>
    <h1 class="text-2xl font-bold text-center col-span-1 flex justify-center items-center gap-2 md:whitespace-nowrap">‚ùì Guide d'Utilisation</h1>
    <div></div>
</div>
        <div class="guide-container">
            ${styleHTML}
            ${finalGuideHTML}
        </div>
    `;

    const backBtn = div.querySelector('#guideBackBtn');
    const backAction = cameFromLogin ? window.showLoginViewFromGuide : () => window.showView('menu');
    backBtn.addEventListener('click', backAction);

    return div;
}

function createStep4View() {
    const config = stepsConfig.step4;
    const div = document.createElement('div');
    div.className = 'fade-in';

    // --- HTML de la nouvelle interface (Cartes + Fen√™tre de simulation cach√©e) ---
    div.innerHTML = `
        
<h1 class="text-2xl font-bold flex justify-center items-center gap-2 md:whitespace-nowrap mb-6">${config.icon} ${config.title}</h1>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-800"><b>Ta mission :</b> Choisis un domaine, pose une question de base, puis utilise l'IA pour obtenir des questions plus pertinentes et t'entra√Æner avec le simulateur.Enfin clique sur le lien du site pour √©changer avec des √©tudiants.</div>
        </div>
        <div class="mb-8">
             <a href="https://www.inspire-orientation.org" target="_blank" class="inline-block bg-cyan-100 text-cyan-700 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter Inspire-orientation.org ‚Üó</a>
        </div>
        <form id="stepForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col space-y-4">
                    <h2 class="text-lg font-bold text-slate-800">Exploration #1</h2>
                    <div>
<label for="theme1" class="block text-md font-medium text-slate-700 mb-2">Formation ou domaine</label>
                        <input type="text" id="theme1" name="theme1" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: √âcoles d'ing√©nieurs" value="${journalData.step4.theme1 || ''}">
                    </div>
                    <div>
<label for="question1" class="block text-md font-medium text-slate-700 mb-2">Ma question principale</label>
                        <textarea id="question1" name="question1" rows="2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Quelle est la plus grande diff√©rence avec le lyc√©e ?">${journalData.step4.question1 || ''}</textarea>
                    </div>
                    <div class="text-center">
                        <button type="button" id="generate-btn-1" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Obtenir mes questions personnalis√©es</button>
                    </div>
                    <div id="loader-1" class="hidden text-center"><div class="loader"></div></div>
                    <div id="suggestions-container-1" class="pt-2 border-t border-slate-200">
                        </div>
                    <textarea id="suggestions1" name="suggestions1" class="hidden">${journalData.step4.suggestions1 || ''}</textarea>
                    <div class="text-center mt-auto pt-4">
                         <button type="button" id="launch-sim-btn-1" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition hidden">üöÄ Lancer une simulation d'entretien</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 flex flex-col space-y-4">
                    <h2 class="text-lg font-bold text-slate-800">Exploration #2</h2>
                    <div>
                        <label for="theme2" class="block text-sm font-medium text-slate-700 mb-1">Formation ou domaine</label>
                        <input type="text" id="theme2" name="theme2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: √âtudes de sant√© (PASS/LAS)" value="${journalData.step4.theme2 || ''}">
                    </div>
                    <div>
                        <label for="question2" class="block text-sm font-medium text-slate-700 mb-1">Ma question principale</label>
                        <textarea id="question2" name="question2" rows="2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Comment g√©rer la charge de travail ?">${journalData.step4.question2 || ''}</textarea>
                    </div>
                    <div class="text-center">
                        <button type="button" id="generate-btn-2" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Obtenir mes questions personnalis√©es</button>
                    </div>
                    <div id="loader-2" class="hidden text-center"><div class="loader"></div></div>
                    <div id="suggestions-container-2" class="pt-2 border-t border-slate-200">
                         </div>
                     <textarea id="suggestions2" name="suggestions2" class="hidden">${journalData.step4.suggestions2 || ''}</textarea>
                    <div class="text-center mt-auto pt-4">
                         <button type="button" id="launch-sim-btn-2" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition hidden">üöÄ Lancer une simulation d'entretien</button>
                    </div>
                </div>
            </div>
            <button type="submit" class="w-full mt-8 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder l'√©tape</button>
        </form>

        <div id="simulation-modal" class="simulation-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col h-[80vh]">
                <div class="flex items-center justify-between p-4 border-b bg-slate-50 rounded-t-2xl">
                    <h3 class="font-bold text-slate-800">ü§ñ Simulation d'entretien</h3>
                    <button id="simulation-close" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
                </div>
                <div id="simulation-messages" class="flex-1 p-4 overflow-y-auto simulation-message-container">
                    </div>
                <form id="simulation-form" class="p-4 border-t flex items-center gap-2">
                    <input type="text" id="simulation-input" placeholder="√âcris ta r√©ponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
                </form>
            </div>
        </div>
    `;

    // --- Logique de la nouvelle interface ---

    const simulationModal = div.querySelector('#simulation-modal');
    const simulationMessages = div.querySelector('#simulation-messages');
    const simulationForm = div.querySelector('#simulation-form');
    const simulationInput = div.querySelector('#simulation-input');
    let currentSimTheme = '';
    let conversationHistory = [];

    // Fonction pour ajouter un message dans le simulateur
    const addSimMessage = (text, sender) => {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = 'flex mb-4';
        let messageContent = '';
        if (sender === 'user') {
            messageWrapper.classList.add('justify-end');
            messageContent = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs"><p>${text}</p></div>`;
        } else if (sender === 'ai') {
            messageContent = `<div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs"><p>${text}</p></div>`;
        } else { // loader
            messageContent = `<div class="bg-cyan-100 p-3 rounded-lg"><div class="chatbot-loader"></div></div>`;
        }
        messageWrapper.innerHTML = messageContent;
        simulationMessages.appendChild(messageWrapper);
        simulationMessages.scrollTop = simulationMessages.scrollHeight;
        return messageWrapper;
    };
    
    // Logique pour une carte d'exploration (factoris√©e pour √©viter la r√©p√©tition)
    // REMPLACEZ VOTRE FONCTION setupCard EXISTANTE PAR CELLE-CI :
    
    // Logique pour une carte d'exploration (factoris√©e pour √©viter la r√©p√©tition)
    const setupCard = (index) => {
        const themeInput = div.querySelector(`#theme${index}`);
        const questionInput = div.querySelector(`#question${index}`);
        const generateBtn = div.querySelector(`#generate-btn-${index}`);
        const loader = div.querySelector(`#loader-${index}`);
        const suggestionsContainer = div.querySelector(`#suggestions-container-${index}`);
        const suggestionsTextarea = div.querySelector(`#suggestions${index}`);
        const launchSimBtn = div.querySelector(`#launch-sim-btn-${index}`);

        // Rendu initial des questions si elles existent d√©j√†
        if (suggestionsTextarea.value) {
            const questions = suggestionsTextarea.value.split('\n').filter(q => q.trim() !== '');
            let questionsHTML = '<h3 class="font-semibold text-slate-700 mb-2">Questions personnalis√©es :</h3><ul class="list-disc list-inside space-y-1 text-slate-600">';
            questions.forEach(q => { questionsHTML += `<li>${q}</li>`; });
            questionsHTML += '</ul>';
            suggestionsContainer.innerHTML = questionsHTML;
            launchSimBtn.classList.remove('hidden');
        }

        // Clic sur "Obtenir mes questions"
        generateBtn.addEventListener('click', async () => {
            const theme = themeInput.value.trim();
            const questionBase = questionInput.value.trim();
            const analyseProfil = journalData.step0.analysis;

            if (!theme || !questionBase || !analyseProfil) {
                alert("Veuillez renseigner le domaine, votre question et avoir compl√©t√© l'√©tape 'Mieux se conna√Ætre' pour obtenir des suggestions personnalis√©es.");
                return;
            }

            loader.classList.remove('hidden');
            suggestionsContainer.innerHTML = '';
            launchSimBtn.classList.add('hidden');

            const prompt = `Agis comme un coach d'orientation tr√®s perspicace. Voici le profil psychologique d'un lyc√©en que j'ai analys√© :
            "${analyseProfil}"
            Ce lyc√©en s'int√©resse au domaine suivant : "${theme}".
            Il a d√©j√† une question de base en t√™te : "${questionBase}"
            Ta mission est de lui sugg√©rer 3 questions strat√©giques et personnalis√©es qu'il pourrait poser √† un √©tudiant. Ces questions doivent l'aider √† valider si ce domaine correspond VRAIMENT √† sa personnalit√©.
            Donne uniquement les 3 questions, chacune sur une nouvelle ligne, sans num√©rotation ni introduction.`;

            const result = await callGeminiAPI(prompt);
            loader.classList.add('hidden');

            const questions = result.split('\n').filter(q => q.trim() !== '');
            let questionsHTML = '<h3 class="font-semibold text-slate-700 mb-2">Questions personnalis√©es :</h3><ul class="list-disc list-inside space-y-1 text-slate-600">';
            questions.forEach(q => { questionsHTML += `<li>${q}</li>`; });
            questionsHTML += '</ul>';
            suggestionsContainer.innerHTML = questionsHTML;
            suggestionsTextarea.value = result;
            launchSimBtn.classList.remove('hidden');
        });

        // Clic sur "Lancer une simulation"
        launchSimBtn.addEventListener('click', async () => {
            currentSimTheme = themeInput.value.trim();
            if (!currentSimTheme) return;

            simulationMessages.innerHTML = '';
            conversationHistory = [];
            simulationModal.classList.remove('hidden');
            simulationModal.classList.add('flex');
            
            const loaderMsg = addSimMessage('', 'loader');
            
            const startPrompt = `Tu joues le r√¥le d'un √©tudiant "√©claireur" sympathique et bienveillant. Tu √©tudies dans le domaine de : "${currentSimTheme}". Un lyc√©en (l'utilisateur) vient de prendre contact avec toi. Envoie-lui un unique message de bienvenue chaleureux pour d√©marrer la conversation et l'inviter √† poser sa premi√®re question.`;

            const firstMessage = await callGeminiAPI(startPrompt);
            loaderMsg.remove();
            addSimMessage(firstMessage, 'ai');
            conversationHistory.push({ role: 'model', parts: [{ text: firstMessage }] });
        });
    };

    // Initialisation des deux cartes
    setupCard(1);
    setupCard(2);

    // Logique de la fen√™tre de simulation
    div.querySelector('#simulation-close').addEventListener('click', () => {
        simulationModal.classList.add('hidden');
        simulationModal.classList.remove('flex');
    });

    simulationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = simulationInput.value.trim();
        if (!userInput) return;

        addSimMessage(userInput, 'user');
        simulationInput.value = '';
        conversationHistory.push({ role: 'user', parts: [{ text: userInput }] });

        const loaderMsg = addSimMessage('', 'loader');
        
        const conversationPrompt = `Tu es un √©tudiant √©claireur bienveillant qui √©tudie en "${currentSimTheme}". Continue la conversation de mani√®re naturelle en te basant sur l'historique. R√©ponds √† la derni√®re question de l'utilisateur.
        
        HISTORIQUE : ${JSON.stringify(conversationHistory)}`;
        
        // Note: Gemini g√®re mieux l'historique directement dans le payload,
        // mais pour la simplicit√© de l'exemple, on le passe dans le prompt.
        // Une version avanc√©e enverrait l'historique complet dans `contents`.

        const aiResponse = await callGeminiAPI(conversationPrompt);
        loaderMsg.remove();
        addSimMessage(aiResponse, 'ai');
        conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
    });

    // Logique du formulaire principal pour sauvegarder
    div.querySelector('#stepForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const stepKey = config.stepKey;
        if (!journalData[stepKey]) journalData[stepKey] = {};

        for (const [key, newValue] of formData.entries()) {
            journalData[stepKey][key] = newValue;
        }

        await saveData();
        showView('menu');
    });

    return div;
}

function createStep5View() {
    const config = stepsConfig.step5;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    
    // On ajoute manuellement la section d'analyse
    const analysisSectionHTML = `
        <div class="text-center my-6">
            <button type="button" id="geminiBtn_actu" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser mon actualit√©</button>
        </div>
        <div id="geminiLoader_actu" class="hidden"><div class="loader"></div></div>
        <div class="mb-6">
            <textarea id="analyse_actu" name="analyse_actu" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step5.analyse_actu || ''}</textarea>
        </div>
    `;
    
    // On ins√®re cette section avant le bouton "Sauvegarder"
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.insertAdjacentHTML('beforebegin', analysisSectionHTML);
    
    div.querySelector('#geminiBtn_actu').addEventListener('click', async () => {
        const loader = div.querySelector('#geminiLoader_actu');
        const analysisTextarea = div.querySelector('#analyse_actu');
        
        const articles = [
            { article: div.querySelector('#article1').value, apprentissage: div.querySelector('#apprentissage1').value },
            { article: div.querySelector('#article2').value, apprentissage: div.querySelector('#apprentissage2').value },
            { article: div.querySelector('#article3').value, apprentissage: div.querySelector('#apprentissage3').value }
        ].filter(item => item.article.trim() || item.apprentissage.trim());

        if (!journalData.step0.analysis) {
            alert("Pour obtenir une analyse personnalis√©e, veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'.");
            return;
        }
        if (articles.length === 0) {
            alert("Veuillez renseigner au moins une information que vous avez trouv√©e.");
            return;
        }

        loader.style.display = 'block';
        analysisTextarea.value = '';

        const articlesText = articles.map(a => `- Article/Classement: "${a.article}"\n  Ce qu'il a appris: "${a.apprentissage}"`).join('\n');
        const prompt = `Agis comme un conseiller d'orientation expert. Le profil d'un lyc√©en est : "${journalData.step0.analysis}".\nIl a fait une veille d'information et a not√© :\n${articlesText}\n\nTa mission est de mettre en relation l'actualit√© qu'il a trouv√©e avec son profil personnel et de sugg√©rer, en te basant sur une recherche web, 2 autres pistes de recherche (articles, classements...) pr√©cises et pertinentes qui pourraient l'int√©resser. Explique bri√®vement pourquoi.`;
        
        const result = await callGeminiAPI(prompt, true);
        loader.style.display = 'none';
        analysisTextarea.value = result;
        
        // On sauvegarde l'analyse directement
        journalData.step5.analyse_actu = result;
        await saveData();
    });

    return div;
}
        
        // REMPLACEZ VOTRE FONCTION createStep6View EXISTANTE PAR CELLE-CI :
function createStep6View() {
    const config = stepsConfig.step6;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    div.innerHTML = `
<h1 class="text-2xl font-bold flex justify-center items-center gap-2 md:whitespace-nowrap mb-6">${config.icon} ${config.title}</h1>        
<div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${config.action}</div>
        </div>
        <form id="stepForm"></form>
    `;

    const form = div.querySelector('#stepForm');
    
    if (!journalData.step6 || typeof journalData.step6 !== 'object') {
        journalData.step6 = {};
    }

    const createLettreBlock = (index) => {
        const lettreData = journalData.step6[`lettre${index}`] || {};
        return `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Projet de Formation Motiv√© #${index}</h2>
                <div class="mb-6">
                    <label for="formation_${index}" class="block text-md font-medium text-slate-700 mb-2">Formation vis√©e</label>
                    <input type="text" id="formation_${index}" name="formation_${index}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: BUT Informatique - IUT de Villetaneuse" value="${lettreData.formation || ''}">
                </div>
                 <div class="mb-6">
                    <label for="motivations_${index}" class="block text-md font-medium text-slate-700 mb-2">Mes motivations, comp√©tences, exp√©riences (en vrac)</label>
                    <textarea id="motivations_${index}" name="motivations_${index}" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: J'aime r√©soudre des probl√®mes logiques, j'ai suivi la sp√© NSI...">${lettreData.motivations || ''}</textarea>
                </div>
                <div class="text-center mb-4">
                    <button type="button" id="geminiBtn_structure_${index}" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® G√©n√©rer une structure de lettre</button>
                </div>
                <div id="geminiLoader_structure_${index}" class="hidden"><div class="loader"></div></div>
                 <div class="mb-6">
                    <label for="structure_${index}" class="block text-md font-medium text-slate-700 mb-2">Proposition de structure</label>
                    <textarea id="structure_${index}" name="structure_${index}" rows="10" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${lettreData.structure || ''}</textarea>
                </div>

                <div class="mt-8 border-t pt-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Atelier d'√©criture : L'Optimiseur de Paragraphe</h3>
                    <p class="text-sm text-slate-600 mb-4">R√©dige un brouillon de paragraphe en suivant la structure propos√©e, puis demande au coach IA de te donner des pistes pour l'am√©liorer.</p>
                    <div class="mb-4">
                         <label for="brouillon_${index}" class="block text-md font-medium text-slate-700 mb-2">Mon brouillon</label>
                        <textarea id="brouillon_${index}" rows="6" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="√âcris ici le paragraphe que tu souhaites am√©liorer..."></textarea>
                    </div>
                    <div class="text-center">
                        <button type="button" id="optimize-btn_${index}" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">üí° Am√©liorer mon paragraphe</button>
                    </div>
                    <div id="loader-optimize_${index}" class="hidden"><div class="loader"></div></div>
                    <div id="optimization-result_${index}" class="mt-4 p-4 bg-teal-50 border border-teal-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
                </div>
            </div>
        `;
    };

    form.innerHTML = `
        ${createLettreBlock(1)}
        ${createLettreBlock(2)}
        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;

    for (let i = 1; i <= 2; i++) {
        // Listener pour la g√©n√©ration de structure (inchang√©)
        div.querySelector(`#geminiBtn_structure_${i}`).addEventListener('click', async () => {
            const formation = div.querySelector(`#formation_${i}`).value;
            const motivations = div.querySelector(`#motivations_${i}`).value;
            const loader = div.querySelector(`#geminiLoader_structure_${i}`);
            const resultDiv = div.querySelector(`#structure_${i}`);
            if (!formation.trim() || !motivations.trim()) { resultDiv.value = "Veuillez renseigner la formation et vos motivations."; return; }
            resultDiv.value = '';
            loader.style.display = 'block';
            const prompt = `Agis en tant que conseiller d'orientation expert de Parcoursup. Un lyc√©en vise la formation "${formation}" et a list√© ces motivations/comp√©tences : "${motivations}". Propose un plan structur√© et d√©taill√© (en 3 ou 4 paragraphes) pour son projet de formation motiv√©. Pour chaque paragraphe, explique ce qu'il doit y mettre et comment il peut lier ses comp√©tences √† la formation. Ne r√©dige pas la lettre, donne uniquement le plan avec des conseils.`;
            const result = await callGeminiAPI(prompt);
            loader.style.display = 'none';
            resultDiv.value = result;
        });

        // NOUVEAU LISTENER : Pour l'optimiseur de paragraphe
        div.querySelector(`#optimize-btn_${i}`).addEventListener('click', async () => {
            const formation = div.querySelector(`#formation_${i}`).value;
            const motivations = div.querySelector(`#motivations_${i}`).value;
            const brouillon = div.querySelector(`#brouillon_${i}`).value;
            const loader = div.querySelector(`#loader-optimize_${i}`);
            const resultDiv = div.querySelector(`#optimization-result_${i}`);

            if (!brouillon.trim()) {
                resultDiv.innerHTML = "<p>Veuillez d'abord √©crire un brouillon √† am√©liorer.</p>";
                return;
            }
            resultDiv.innerHTML = '';
            loader.style.display = 'block';
            
            const prompt = `Agis comme un coach en √©criture pour un lyc√©en pr√©parant son dossier Parcoursup.
            - Formation vis√©e : "${formation}"
            - Ses motivations brutes : "${motivations}"
            - Son brouillon de paragraphe : "${brouillon}"

            Ta mission n'est PAS de r√©√©crire son paragraphe. Tu dois lui donner 3 √† 4 conseils cibl√©s et constructifs pour qu'il l'am√©liore lui-m√™me. Propose des suggestions comme :
            - "Essaie de remplacer 'j'aime faire' par un verbe d'action plus fort comme 'je ma√Ætrise' ou 'j'ai d√©velopp√©'."
            - "Ce serait encore plus percutant si tu liais cette comp√©tence √† un exemple concret de ton stage ou d'un projet."
            - "Cette phrase est un peu longue, essaie de la scinder en deux pour plus de clart√©."
            
            Le ton doit √™tre celui d'un coach bienveillant. Fournis une liste √† puces de conseils.`;

            const result = await callGeminiAPI(prompt);
            loader.style.display = 'none';
            resultDiv.innerHTML = linkify(result); // On utilise linkify pour bien formater les sauts de ligne
        });
    }

    // Listener pour la sauvegarde (inchang√©)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        journalData.step6 = {};
        for (let i = 1; i <= 2; i++) {
            journalData.step6[`lettre${i}`] = {
                formation: formData.get(`formation_${i}`),
                motivations: formData.get(`motivations_${i}`),
                structure: formData.get(`structure_${i}`)
            };
        }
        checkBadges();
        await saveData();
        showView('menu');
    });

    return div;
}

function createStep7View() {
    const config = stepsConfig.step7;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    let quizData = [];
    let currentQuestionIndex = 0;
    let score = 0;

    if (!journalData.step7.scores) {
        journalData.step7.scores = {};
    }

    const renderChoiceView = () => {
        let choiceHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="start-generic-quiz" class="p-6 bg-white rounded-lg border border-slate-200 cursor-pointer hover:shadow-lg transition text-center">
                    <h3 class="font-bold text-lg text-slate-800">Atelier 1 : La Chasse aux Mythes</h3>
                    <p class="text-sm text-slate-600 mt-2">Teste tes connaissances sur un domaine et d√©construis les id√©es re√ßues les plus courantes.</p>
                </div>
                <div id="start-personalized-quiz" class="p-6 bg-white rounded-lg border border-slate-200 cursor-pointer hover:shadow-lg transition text-center">
                    <h3 class="font-bold text-lg text-slate-800">Atelier 2 : Le D√©fi Personnalis√©</h3>
                    <p class="text-sm text-slate-600 mt-2">Obtiens un quiz sur mesure qui te questionne par rapport √† ton propre profil et tes forces.</p>
                </div>
            </div>
        `;

        let historyHTML = '';
        const scores = journalData.step7.scores;
        if (scores && Object.keys(scores).length > 0 && Object.values(scores).some(h => h.length > 0)) {
            historyHTML += `
                <div class="mt-8 border-t pt-6">
                    <h2 class="text-xl font-bold text-slate-800 text-center mb-4">Mon Historique de Scores</h2>
                    <div class="space-y-4">`;
            
            for (const [domain, scoreHistory] of Object.entries(scores)) {
                if(scoreHistory && scoreHistory.length > 0) {
                    historyHTML += `
                        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <h3 class="font-semibold text-cyan-700">${domain}</h3>
                            <ul class="text-sm text-slate-600 mt-2 space-y-3">`;
                    scoreHistory.forEach(entry => {
                        historyHTML += `<li>
                                            <div class="flex justify-between items-center">
                                                <span>Le ${entry.date}</span>
                                                <strong class="text-base">${entry.score}/${entry.total}</strong>
                                            </div>`;
                        if (entry.notes && entry.notes.trim() !== '') {
                            historyHTML += `<p class="text-xs text-slate-500 italic border-l-2 border-slate-200 pl-2 mt-1">${entry.notes}</p>`;
                        }
                        historyHTML += `</li>`;
                    });
                    historyHTML += `</ul></div>`;
                }
            }
            historyHTML += `</div></div>`;
        }

        form.innerHTML = choiceHTML + historyHTML;
        
        div.querySelector('#start-generic-quiz').addEventListener('click', () => startQuiz('generic'));
        div.querySelector('#start-personalized-quiz').addEventListener('click', () => startQuiz('personalized'));
    };

    const startQuiz = (type) => {
        if (type === 'personalized' && (!journalData.step0 || !journalData.step0.analysis)) {
            alert("Pour lancer le D√©fi Personnalis√©, veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'.");
            return;
        }
        form.innerHTML = `
            <div class="mb-6">
                <label for="domaine" class="block text-md font-medium text-slate-700 mb-2">Sur quel domaine ou m√©tier souhaites-tu lancer le quiz ?</label>
                <input type="text" id="domaine" name="domaine" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Les √©tudes de droit..." value="${journalData.step7.domaine || ''}">
            </div>
            <div class="text-center">
                <button type="button" id="generateQuizBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Lancer le Quiz</button>
            </div>
            <div id="quizContainer" class="mt-6"></div>
            <div id="quizLoader" class="hidden"><div class="loader"></div></div>
        `;
        // On passe le 'type' √† la fonction generateQuiz
        form.querySelector('#generateQuizBtn').addEventListener('click', () => generateQuiz(type));
    };
    
    // === LA CORRECTION CL√â EST ICI ===
    // La fonction `generateQuiz` accepte maintenant un param√®tre 'type'
    const generateQuiz = async (type) => {
        const domain = form.querySelector('#domaine').value.trim();
        if (!domain) { alert("Veuillez entrer un domaine."); return; }
        journalData.step7.domaine = domain;
        if (!journalData.step7.scores[domain]) {
            journalData.step7.scores[domain] = [];
        }

        const loader = form.querySelector('#quizLoader');
        const quizContainer = form.querySelector('#quizContainer');
        loader.style.display = 'block';
        quizContainer.innerHTML = '';
        
        let prompt = '';
        // Elle utilise 'type' pour choisir le bon prompt
        if (type === 'personalized') {
            prompt = `Agis comme un conseiller d'orientation. Le profil d'un √©l√®ve est : "${journalData.step0.analysis}". Il s'int√©resse au domaine : "${domain}". G√©n√®re un quiz "vrai ou faux" de 5 questions sur les mythes de ce domaine, mais **sp√©cifiquement choisis pour interpeller l'√©l√®ve au vu de son profil**. Ta r√©ponse DOIT √™tre UNIQUEMENT un tableau JSON valide (cl√©s: "affirmation", "reponse", "explication").`;
        } else { // type === 'generic'
            prompt = `G√©n√®re un quiz "vrai ou faux" de 5 questions sur les mythes du domaine suivant : "${domain}". Ta r√©ponse DOIT √™tre UNIQUEMENT un tableau JSON valide (cl√©s: "affirmation", "reponse", "explication").`;
        }

        const result = await callGeminiAPI(prompt, false, true);
        try {
            const parsedResult = JSON.parse(result);
            quizData = Array.isArray(parsedResult) ? parsedResult : parsedResult.quiz;
            if (!Array.isArray(quizData) || quizData.length === 0) { throw new Error("R√©ponse de l'IA invalide."); }
            currentQuestionIndex = 0;
            score = 0;
            renderQuestion(currentQuestionIndex);
        } catch (error) {
            quizContainer.innerHTML = `<p class="text-red-500 text-center">D√©sol√©, une erreur est survenue lors de la cr√©ation du quiz. Veuillez r√©essayer.</p>`;
        } finally {
             loader.style.display = 'none';
        }
    };

    const renderQuestion = (index) => {
        const quizContainer = form.querySelector('#quizContainer');
        const question = quizData[index];
        const domain = journalData.step7.domaine;
        const scoreHistory = journalData.step7.scores[domain] || [];
        let bestScoreHTML = '';
        if (scoreHistory.length > 0) {
            const bestScore = Math.max(...scoreHistory.map(s => s.score));
            bestScoreHTML = `<p class="text-sm text-center text-slate-500 mb-4">Ton record pour ce th√®me : <span class="font-bold">${bestScore}/${quizData.length}</span></p>`;
        }
        quizContainer.innerHTML = `
            <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                ${bestScoreHTML}
                <p class="text-center font-semibold text-slate-800 text-lg mb-4">Question ${index + 1} / ${quizData.length}</p>
                <p class="text-center text-slate-600 mb-6">"${question.affirmation}"</p>
                <div class="flex justify-center gap-4">
                    <button type="button" data-answer="true" class="answer-btn bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Vrai</button>
                    <button type="button" data-answer="false" class="answer-btn bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">Faux</button>
                </div>
                <div id="explanationContainer" class="mt-6"></div>
            </div>
        `;
        quizContainer.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', (e) => checkAnswer(e.target.dataset.answer === 'true', index));
        });
    };

    const checkAnswer = (userAnswer, index) => {
        const question = quizData[index];
        const isCorrect = userAnswer === question.reponse;
        if (isCorrect) score++;
        const explanationContainer = form.querySelector('#explanationContainer');
        const feedbackColor = isCorrect ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
        const feedbackText = isCorrect ? 'Bonne r√©ponse !' : 'C\'est un mythe !';
        explanationContainer.innerHTML = `
            <div class="p-4 rounded-lg border-l-4 ${feedbackColor}">
                <h4 class="font-bold text-slate-800">${feedbackText}</h4>
                <p class="text-slate-700 mt-2">${question.explication}</p>
            </div>
            <div class="text-center mt-4">
                <button type="button" id="nextQuestionBtn" class="bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-cyan-700 transition">
                    ${(index + 1 === quizData.length) ? 'Voir mon score' : 'Question suivante'}
                </button>
            </div>
        `;
        explanationContainer.querySelector('#nextQuestionBtn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                renderQuestion(currentQuestionIndex);
            } else {
                renderFinalScore();
            }
        });
        form.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
    };

    const renderFinalScore = () => {
        const quizContainer = form.querySelector('#quizContainer');
        const domain = journalData.step7.domaine;
        const scoreHistory = journalData.step7.scores[domain];
        const oldBestScore = scoreHistory.length > 0 ? Math.max(...scoreHistory.map(s => s.score)) : -1;
        const newScoreEntry = {
            score: score,
            total: quizData.length,
            date: new Date().toISOString().split('T')[0],
            notes: ''
        };
        let recordMessage = score > oldBestScore ? `<p class="text-green-600 font-semibold mt-2">üéâ Nouveau record !</p>` : '';
        quizContainer.innerHTML = `
            <div class="text-center bg-slate-50 p-6 rounded-lg border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800">Quiz termin√© !</h3>
                <p class="text-slate-600 mt-4">Ton score :</p>
                <p class="text-3xl font-bold text-cyan-600 my-1">${score} / ${quizData.length}</p>
                ${recordMessage}
                <hr class="my-6">
                <p class="text-slate-600 mb-2">Note ici ce que tu as appris d'important :</p>
                <textarea id="reflexions" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ce qui m'a surpris, ce que je retiens..."></textarea>
            </div>
            <button type="button" id="save-quiz-results-btn" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Enregistrer et revenir aux ateliers</button>
        `;
        quizContainer.querySelector('#save-quiz-results-btn').addEventListener('click', async () => {
            const notes = quizContainer.querySelector('#reflexions').value.trim();
            newScoreEntry.notes = notes;
            scoreHistory.push(newScoreEntry);
            await saveData();
            const xpGained = score * 5;
            if (xpGained > 0) {
                await grantXp(xpGained);
            }
            renderChoiceView();
        });
    };

    renderChoiceView();
    return div;
}

function createStep8View() {
    const config = stepsConfig.step8;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    const defaults = {
        contacts: [],
        departement: '',
        metier1: '',
        metier2: '',
        metier3: '',
        pro_strategie: '',
    };
    journalData.step8 = { ...defaults, ...journalData.step8 };
    if (!Array.isArray(journalData.step8.contacts)) {
        journalData.step8.contacts = [];
    }

    div.innerHTML = `
        
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap mb-6">${config.icon} ${config.title}</h1>
        
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${config.action}</div>
        </div>
        <div class="bg-slate-50 p-4 rounded-lg border mb-8">
            <h3 class="font-bold text-slate-800 mb-2">Ajouter et trouver des contacts</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                        <label class="block text-md font-medium text-slate-700 mb-2">Contact personnel</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="new-contact-name" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Nom, lien de parent√©...">
                        <button type="button" id="add-contact-btn" class="bg-cyan-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-cyan-700">+</button>
                    </div>
                </div>
                <div>
                    <label for="pro_departement" class="block text-md font-medium text-slate-700 mb-2">D√©partement de recherche</label>
                    <input type="text" id="pro_departement" class="w-full p-2 border border-slate-300 rounded-lg mt-1" placeholder="Ex: 75, Morbihan..." value="${journalData.step8.departement || ''}">
                </div>
            </div>
            <div class="space-y-2 mb-4">
                <label class="block text-md font-medium text-slate-700 mb-2">M√©tiers recherch√©s (jusqu'√† 3)</label>
                <input type="text" id="pro_metier1" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="M√©tier #1 (Ex: Architecte)" value="${journalData.step8.metier1 || ''}">
                <input type="text" id="pro_metier2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="M√©tier #2 (optionnel)" value="${journalData.step8.metier2 || ''}">
                <input type="text" id="pro_metier3" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="M√©tier #3 (optionnel)" value="${journalData.step8.metier3 || ''}">
            </div>
            <button type="button" id="geminiBtn_find_pro" class="w-full bg-cyan-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-cyan-700">üîé Lancer la recherche</button>
            <div id="loader-find-pro" class="hidden"><div class="loader"></div></div>
            <div id="find-pro-error"></div>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mb-4">Ma Liste de Suivi</h2>
        <div id="contact-list-container" class="space-y-3 mb-8"></div>
        <hr class="my-8 border-slate-300">
        <h2 class="text-2xl font-bold text-slate-800 mb-4">Pr√©parer ma prise de contact</h2>
        <div class="max-w-xl mx-auto">
            <div class="bg-slate-50 p-4 rounded-lg border">
                <h3 class="font-bold text-slate-800 mb-2">Strat√©gie de Contact</h3>
                <p class="text-sm text-slate-600 mb-2">Besoin d'aide pour r√©diger un mail ou pr√©parer tes questions ?</p>
                <input type="text" id="pro_metier_aide" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Rappelle le m√©tier concern√©">
                <button type="button" id="geminiBtn_contact_pro" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">‚úâÔ∏è G√©n√©rer une strat√©gie</button>
                <div id="geminiLoader_pro_contact" class="hidden"><div class="loader"></div></div>
                <textarea id="pro_strategie" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly>${journalData.step8.pro_strategie || ''}</textarea>
            </div>
        </div>
    `;

    const contactListContainer = div.querySelector('#contact-list-container');
    const statusOptions = { a_contacter: "√Ä contacter", contacte: "Contact√©", reponse_recue: "R√©ponse re√ßue", entretien_prevu: "Entretien pr√©vu" };
    const statusColors = { a_contacter: "bg-slate-100 border-slate-300", contacte: "bg-blue-100 border-blue-300", reponse_recue: "bg-yellow-100 border-yellow-300", entretien_prevu: "bg-green-100 border-green-300" };

    const renderContactList = () => {
        contactListContainer.innerHTML = '';
        if (!journalData.step8.contacts || journalData.step8.contacts.length === 0) {
            contactListContainer.innerHTML = `<p class="text-center text-slate-500 p-4">Ta liste de contacts est vide.</p>`;
            return;
        }
        journalData.step8.contacts.forEach((contact, index) => {
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg border flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 ${statusColors[contact.statut]}`;
            let optionsHTML = '';
            for (const [value, text] of Object.entries(statusOptions)) {
                optionsHTML += `<option value="${value}" ${contact.statut === value ? 'selected' : ''}>${text}</option>`;
            }
            card.innerHTML = `
                <div class="flex-1">
                    <p class="font-semibold text-slate-800">${contact.nom}</p>
                    ${contact.search_link ? `<a href="${contact.search_link}" target="_blank" class="text-sm text-cyan-600 hover:underline">Rechercher ce contact ‚Üó</a>` : `<p class="text-sm text-slate-600 mt-1">${contact.details || ''}</p>`}
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto self-end sm:self-center">
                    <select data-index="${index}" class="status-select w-full sm:w-auto p-2 border border-slate-300 rounded-lg">
                        ${optionsHTML}
                    </select>
                    <button data-index="${index}" class="delete-btn bg-red-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-red-600">√ó</button>
                </div>
            `;
            contactListContainer.appendChild(card);
        });
        checkBadges();
    };

    div.addEventListener('click', (e) => {
        if (e.target.closest('#add-contact-btn')) {
            const input = div.querySelector('#new-contact-name');
            const name = input.value.trim();
            if (name) {
                const searchLink = `https://www.google.com/search?q=${encodeURIComponent(name)}`;
                journalData.step8.contacts.push({ nom: name, search_link: searchLink, type: 'personnel', statut: 'a_contacter' });
                input.value = '';
                renderContactList();
                saveData();
            }
        }
        if (e.target.closest('.delete-btn')) {
            const index = e.target.closest('.delete-btn').dataset.index;
            if (confirm("Es-tu s√ªr de vouloir supprimer ce contact ?")) {
                journalData.step8.contacts.splice(index, 1);
                renderContactList();
                saveData();
            }
        }
    });

    div.addEventListener('change', (e) => {
        if (e.target.matches('.status-select')) {
            const index = e.target.dataset.index;
            const newStatus = e.target.value;
            journalData.step8.contacts[index].statut = newStatus;
            renderContactList();
            saveData();
        }
    });
    
    div.querySelector('#geminiBtn_find_pro').addEventListener('click', async () => {
        const departement = div.querySelector('#pro_departement').value.trim();
        const metier1 = div.querySelector('#pro_metier1').value.trim();
        const metier2 = div.querySelector('#pro_metier2').value.trim();
        const metier3 = div.querySelector('#pro_metier3').value.trim();
        const loader = div.querySelector('#loader-find-pro');
        const errorDiv = div.querySelector('#find-pro-error');
        const metiersList = [metier1, metier2, metier3].filter(m => m !== '');

        if (!departement || metiersList.length === 0) {
            alert("Veuillez renseigner un d√©partement ET au moins un m√©tier.");
            return;
        }
        
        journalData.step8.departement = departement;
        journalData.step8.metier1 = metier1;
        journalData.step8.metier2 = metier2;
        journalData.step8.metier3 = metier3;

        journalData.step8.contacts = journalData.step8.contacts.filter(c => c.type === 'personnel');

        loader.style.display = 'block';
        errorDiv.innerHTML = '';
        
        const prompt = `Agis comme un conseiller d'orientation cherchant des contacts professionnels, pas des centres d'information g√©n√©raux. Pour un lyc√©en dans le d√©partement "${departement}", trouve au moins 5 contacts de **professionnels, d'entreprises, de cabinets ou d'associations professionnelles** pertinents pour les m√©tiers suivants : "${metiersList.join(', ')}". **√âvite les CIO et les structures d'information g√©n√©ralistes**, sauf si aucune autre option n'est disponible. Diversifie les r√©sultats entre les diff√©rents m√©tiers si possible. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau d'objets. Chaque objet doit avoir deux cl√©s : "nom" (le nom de la structure) et "search_link" (une URL de recherche Google compl√®te et valide pour trouver cette structure, ex: "https://www.google.com/search?q=Ordre+des+Architectes+de+Vannes").`;
        
        const result = await callGeminiAPI(prompt, true, true);
        loader.style.display = 'none';
        
        try {
            let parsedResult = JSON.parse(result);
            const contactsList = Array.isArray(parsedResult) ? parsedResult : parsedResult.contacts;

            if (!Array.isArray(contactsList)) {
                throw new Error("La r√©ponse de l'IA ne contient pas une liste de contacts valide.");
            }

            contactsList.forEach(contact => {
                journalData.step8.contacts.push({ nom: contact.nom, search_link: contact.search_link, type: 'externe', statut: 'a_contacter' });
            });
            renderContactList();
            await saveData();
        } catch (e) {
            errorDiv.innerHTML = `
                <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-800 mt-4 rounded-r-lg">
                    <p class="font-bold">L'IA n'a pas renvoy√© une liste de contacts valide.</p>
                    <p class="text-sm mt-1">Cela peut arriver pour certains sujets sensibles ou si elle ne trouve pas de donn√©es. Voici sa r√©ponse brute :</p>
                    <pre class="whitespace-pre-wrap bg-red-50 p-2 mt-2 rounded text-xs font-mono">${result}</pre>
                </div>
            `;
        }
    });

    div.querySelector('#geminiBtn_contact_pro').addEventListener('click', async () => {
        const metier = div.querySelector('#pro_metier_aide').value.trim();
        const loader = div.querySelector('#geminiLoader_pro_contact');
        const resultDiv = div.querySelector('#pro_strategie');
        if (!metier) { resultDiv.value = "Veuillez indiquer un m√©tier pour g√©n√©rer une strat√©gie."; return; }
        loader.style.display = 'block'; resultDiv.value = '';
        const prompt = `Un(e) lyc√©en(ne) souhaite contacter un professionnel exer√ßant le m√©tier de "${metier}". Propose une strat√©gie en 2 points : 1. Un mod√®le de mail court, poli et efficace qu'il/elle peut adapter pour demander un bref √©change de 15 minutes. 2. Une liste de 3 questions ouvertes et pertinentes √† poser lors de l'√©change.`;
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none'; 
        resultDiv.value = result;
        journalData.step8.pro_strategie = result;
        await saveData();
    });

    renderContactList();
    return div;
}


function createStep9View() {
    const config = stepsConfig.step9;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    const defaults = {
        formation_reve: '',
        planb_chat_history: [],
        reussite_type: '',
        reussite_conseils: ''
    };
    journalData.step9 = { ...defaults, ...journalData.step9 };
    if (!Array.isArray(journalData.step9.planb_chat_history)) {
        journalData.step9.planb_chat_history = [];
    }
    
    div.innerHTML = `
        
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap mb-6">${config.icon} ${config.title}</h1>
       
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${config.action}</div>
        </div>
        <form id="stepForm">
            <h2 class="text-xl font-semibold mb-4 text-slate-800">1. Simulation : Mon Plan B</h2>
            <div class="mb-6">
                <label for="formation_reve" class="block text-md font-medium text-slate-700 mb-2">Ma formation "r√™v√©e" (V≈ìu n¬∞1)</label>
                <div class="flex gap-2">
                    <input type="text" id="formation_reve" name="formation_reve" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Classe pr√©pa MPSI" value="${journalData.step9.formation_reve || ''}">
                    <button type="button" id="startPlanBSimBtn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Lancer</button>
                </div>
            </div>
            <div id="planb-chat-container" class="bg-white p-4 rounded-lg border border-slate-200 min-h-[300px] flex flex-col">
                <div id="planb-chat-messages" class="flex flex-col flex-1 overflow-y-auto space-y-4 p-2"></div>
                <div id="planb-loader" class="hidden"><div class="loader"></div></div>
                <div id="planb-chat-controls" class="mt-4 flex items-center gap-2">
                    <input type="text" id="planb-input" placeholder="Ta r√©ponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <button type="button" id="planb-send-btn" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
                </div>
            </div>
            <hr class="my-8">
            <h2 class="text-xl font-semibold mb-4 text-slate-800">2. Mon Coach de R√©ussite</h2>
            <div class="mb-6">
                <label for="reussite_type" class="block text-md font-medium text-slate-700 mb-2">Type de formation pour lequel tu veux des conseils</label>
                <input type="text" id="reussite_type" name="reussite_type" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Licence de Droit, BUT..." value="${journalData.step9.reussite_type || ''}">
            </div>
            <div class="text-center mb-4">
                <button type="button" id="geminiBtn_reussite" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Me coacher pour la 1√®re ann√©e</button>
            </div>
            <div id="geminiLoader_reussite" class="hidden"><div class="loader"></div></div>
            <div class="mb-6">
                <label for="reussite_conseils" class="block text-md font-medium text-slate-700 mb-2">Conseils de r√©ussite par l'IA</label>
                <textarea id="reussite_conseils" name="reussite_conseils" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step9.reussite_conseils || ''}</textarea>
            </div>
            <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
        </form>
    `;

    const form = div.querySelector('#stepForm');
    const chatMessages = div.querySelector('#planb-chat-messages');
    const chatInput = div.querySelector('#planb-input');
    const chatSendBtn = div.querySelector('#planb-send-btn');
    const chatControls = div.querySelector('#planb-chat-controls');
    const loader = div.querySelector('#planb-loader');

    const addChatMessage = (sender, text) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `p-3 rounded-lg max-w-lg text-left ${sender === 'user' ? 'bg-blue-500 text-white self-end' : 'bg-slate-200 text-slate-800 self-start'}`;
        messageDiv.innerHTML = linkify(text);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const renderChatHistory = () => {
        chatMessages.innerHTML = '';
        if (journalData.step9.planb_chat_history) {
            journalData.step9.planb_chat_history.forEach(msg => addChatMessage(msg.role, msg.text));
        }
    };
    
    renderChatHistory();

    div.querySelector('#startPlanBSimBtn').addEventListener('click', async () => {
        const formation = div.querySelector('#formation_reve').value.trim();
        if (!formation) { alert("Veuillez d'abord renseigner votre formation 'r√™v√©e'."); return; }
        journalData.step9.formation_reve = formation;
        journalData.step9.planb_chat_history = [];
        renderChatHistory();
        loader.style.display = 'block';
        chatControls.style.display = 'none';
        const prompt = `Agis comme un coach d'orientation bienveillant. Un √©l√®ve imagine que son v≈ìu n¬∞1 sur Parcoursup, qui est "${formation}", est refus√©. Pose-lui une premi√®re question ouverte pour l'inviter √† exprimer sa r√©action. Par exemple : "Ok, imaginons cette situation. C'est d√©cevant, c'est s√ªr. Quelle est ta premi√®re r√©action ou ton premier sentiment en imaginant √ßa ?"`;
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none';
        chatControls.style.display = 'flex';
        journalData.step9.planb_chat_history.push({ role: 'ai', text: result });
        addChatMessage('ai', result);
        await saveData();
    });

    const handleChatSubmit = async () => {
        const userInput = chatInput.value.trim();
        if (!userInput) return;
        journalData.step9.planb_chat_history.push({ role: 'user', text: userInput });
        addChatMessage('user', userInput);
        chatInput.value = '';
        loader.style.display = 'block';
        chatControls.style.display = 'none';
        const formation = journalData.step9.formation_reve;
        const prompt = `Agis comme un coach d'orientation bienveillant. Continue cette conversation avec un √©l√®ve qui r√©agit au refus de son v≈ìu n¬∞1 ("${formation}"). Voici l'historique : ${JSON.stringify(journalData.step9.planb_chat_history)}. En te basant sur sa derni√®re r√©ponse, continue de dialoguer. Si tu sens qu'il est pr√™t, commence √† introduire en douceur des pistes de Plan B (formations similaires moins s√©lectives, parcours connexes, etc.). Le but est de l'aider √† accepter la situation et √† voir les alternatives de mani√®re positive.`;
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none';
        chatControls.style.display = 'flex';
        journalData.step9.planb_chat_history.push({ role: 'ai', text: result });
        addChatMessage('ai', result);
        await saveData();
    };

    chatSendBtn.addEventListener('click', handleChatSubmit);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleChatSubmit();
        }
    });

    div.querySelector('#geminiBtn_reussite').addEventListener('click', async () => { /* ... (code inchang√©) ... */ });
    
    form.addEventListener('submit', async(e) => { /* ... (code inchang√©) ... */ });
            
    return div;
}

function createStep10View() {
    const config = stepsConfig.step10;
    
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    div.innerHTML = `
        
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap mb-6">${config.icon} ${config.title}</h1>
    
        <form id="stepForm"></form> 
    `;
    
    const form = div.querySelector('#stepForm');
    
    const description = config.description;
    const action = config.action;
    
    if (!journalData.step10 || typeof journalData.step10 !== 'object') {
        journalData.step10 = { experiences: [], soft_skills_profile: '', skills_synthesis: '' };
    }
    if (!Array.isArray(journalData.step10.experiences)) {
        journalData.step10.experiences = [];
    }

    let currentExperience = null;
    
    form.innerHTML = `
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${description}</div>
        <div class="bg-cyan-50 p-4 rounded-r-lg border-l-4 border-cyan-400 my-6">
            <h3 class="font-bold text-cyan-800">ü§î Profil vs. Comp√©tences : quelle est la diff√©rence ?</h3>
            <p class="text-sm text-slate-700 mt-2">
                √Ä l'√©tape "Mieux se conna√Ætre", tu as fait un autoportrait de ta personnalit√© (introverti ou extraverti, cr√©atif ou logique...). Ici, tu vas construire un portfolio qui montre concr√®tement ce que tu as appris √† faire.
            </p>
            <p class="text-sm text-slate-700 mt-2">
                Ton profil r√©pond √† la question **"Qui es-tu ?"**. Ton portfolio r√©pond √† la question **"Que sais-tu faire ?"**. Les deux sont essentiels pour un projet d'orientation solide et cr√©dible !
            </p>
        </div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${action}</div>
        </div>
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Atelier 1 : Mes Exp√©riences Significatives</h2>
            <div id="experience-list-container" class="space-y-4 mb-6"></div>
            <button type="button" id="add-experience-btn" class="w-full bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">
                + Ajouter une exp√©rience
            </button>
        </div>
        <hr class="my-12 border-slate-300">
        <div>
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Atelier 2 : Mon Profil de Comp√©tences</h2>
            <div id="detector-container" class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                <p class="text-slate-600 mb-4">R√©ponds √† quelques questions rapides pour r√©v√©ler tes comp√©tences transversales dominantes.</p>
                <button type="button" id="start-detector-btn" class="w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">
                    üß† Lancer le d√©tecteur
                </button>
                <div id="quiz-container" class="hidden mt-4"></div>
                <div id="detector-results-container" class="hidden mt-4"></div>
            </div>
        </div>
        
        <div id="connector-section" class="hidden mt-12 border-t-4 border-cyan-500 pt-6">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üîó Le Connecteur de Comp√©tences</h2>
            <p class="text-slate-600 mb-4">Bravo ! Maintenant que tu as analys√© tes exp√©riences ET ton profil, clique sur le bouton pour que l'IA r√©dige une synth√®se qui connecte tes savoir-faire (issus de tes exp√©riences) et tes savoir-√™tre (issus du quiz).</p>
            <div class="text-center">
                <button type="button" id="connect-skills-btn" class="w-full bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-purple-700 transition">Connecter mes comp√©tences</button>
            </div>
            <div id="loader-connector" class="hidden"><div class="loader"></div></div>
            <textarea id="skills-synthesis" name="skills_synthesis" rows="8" class="w-full mt-4 p-3 border border-slate-300 rounded-lg bg-slate-50" readonly>${journalData.step10.skills_synthesis || ''}</textarea>
        </div>
        <button type="submit" class="w-full mt-8 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder le portfolio</button>
        <div id="portfolio-modal" class="portfolio-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-xl font-bold text-slate-800">Assistant de Portfolio</h2>
                    <button type="button" id="portfolio-modal-close" class="text-slate-500 hover:text-slate-800 text-2xl">√ó</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div id="wizard-step-1">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">√âtape 1 : D√©cris ton exp√©rience</h3><p class="text-slate-600 mb-4">Raconte un projet, un job, un engagement, une passion...</p><textarea id="experience-input" rows="6" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: J'ai organis√© un tournoi de jeux vid√©o..."></textarea><button type="button" id="wizard-next-1" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valider et identifier les comp√©tences ‚ú®</button>
                    </div>
                    <div id="wizard-step-2" class="hidden">
                         <h3 class="text-lg font-bold text-slate-800 mb-2">√âtape 2 : Valide tes comp√©tences</h3><p class="text-slate-600 mb-4">Clique sur les comp√©tences qui te semblent les plus justes.</p><div id="skill-tags-container" class="flex flex-wrap gap-3 p-4 bg-slate-50 rounded-lg border min-h-[100px]"></div><div id="loader-2" class="hidden"><div class="loader"></div></div><button type="button" id="wizard-next-2" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valoriser ces comp√©tences üöÄ</button>
                    </div>
                    <div id="wizard-step-3" class="hidden">
                        <h3 class="text-lg font-bold text-slate-800 mb-2">√âtape 3 : Voici ton texte valoris√© !</h3><p class="text-slate-600 mb-4">Utilise ce paragraphe dans tes lettres de motivation ou sur ton CV.</p><div id="loader-3" class="hidden"><div class="loader"></div></div><div id="portfolio-result" class="p-4 bg-slate-50 rounded-lg border whitespace-pre-wrap min-h-[150px]"></div><div class="flex gap-4"><button type="button" id="save-experience-btn" class="w-full mt-4 bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Enregistrer l'exp√©rience</button></div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const detectorContainer = div.querySelector('#detector-container');
    const startDetectorBtn = div.querySelector('#start-detector-btn');
    const quizContainer = div.querySelector('#quiz-container');
    const resultsContainer = div.querySelector('#detector-results-container');
    let userSoftSkills = [];
    let currentQuestionIndex = 0;

    const quizQuestions = [
        { question: "Face √† un projet complexe, ta premi√®re r√©action est de :", answers: [ { text: "Faire un plan d√©taill√© avec des √©tapes claires.", skill: "Planification" }, { text: "Commencer tout de suite pour voir ce qui marche.", skill: "Initiative" }, { text: "Imaginer plusieurs solutions originales.", skill: "Cr√©ativit√©" } ] },
        { question: "Dans un travail de groupe, tu as tendance √† :", answers: [ { text: "T'assurer que tout le monde s'entend bien.", skill: "Collaboration" }, { text: "Prendre les devants pour organiser les t√¢ches.", skill: "Leadership" }, { text: "Te concentrer sur la partie qui demande le plus de recherche.", skill: "Analyse" } ] },
        { question: "Quand tu ne comprends pas quelque chose, tu :", answers: [ { text: "Cherches la r√©ponse par toi-m√™me jusqu'√† la trouver.", skill: "Autonomie" }, { text: "Demandes de l'aide √† quelqu'un qui sait.", skill: "Communication" }, { text: "Essaies de voir le probl√®me sous un autre angle.", skill: "Adaptabilit√©" } ] },
        { question: "Un impr√©vu survient dans un projet. Que fais-tu ?", answers: [ { text: "Tu proposes rapidement un plan B.", skill: "Adaptabilit√©" }, { text: "Tu analyses la source du probl√®me pour qu'il ne se r√©p√®te pas.", skill: "Analyse" }, { text: "Tu rassures l'√©quipe et maintiens une bonne ambiance.", skill: "Intelligence √âmotionnelle" } ] },
        { question: "Laquelle de ces phrases te d√©crit le mieux ?", answers: [ { text: "J'aime quand les choses sont bien organis√©es.", skill: "Rigueur" }, { text: "J'aime convaincre les autres de mes id√©es.", skill: "Persuasion" }, { text: "J'aime apprendre de nouvelles choses constamment.", skill: "Curiosit√©" } ] },
        { question: "Face √† un grand changement (d√©m√©nagement, nouveau projet...), tu es plut√¥t :", answers: [ { text: "Enthousiaste, tu y vois une opportunit√©.", skill: "Adaptabilit√©" }, { text: "Prudent, tu as besoin de temps pour t'adapter.", skill: "R√©flexion" } ] },
        { question: "Quand tu as beaucoup de choses √† faire, tu as tendance √† :", answers: [ { text: "Cr√©er une to-do list et t'y tenir.", skill: "Organisation" }, { text: "Travailler sur la t√¢che qui t'inspire le plus.", skill: "Motivation" } ] },
        { question: "Tu pr√©f√®res un projet o√π :", answers: [ { text: "Le r√©sultat est garanti.", skill: "Prudence" }, { text: "Il y a une part de risque et de d√©couverte.", skill: "Audace" } ] },
        { question: "Face √† une difficult√©, ton premier r√©flexe est de :", answers: [ { text: "Chercher √† comprendre pourquoi √ßa n'a pas march√©.", skill: "Analyse critique" }, { text: "Te relever et r√©essayer.", skill: "R√©silience" } ] },
        { question: "Quand tu ne connais personne √† une soir√©e, tu as tendance √† :", answers: [ { text: "Attendre que quelqu'un vienne te parler.", skill: "Observation" }, { text: "Faire le premier pas et aller vers les autres.", skill: "Proactivit√©" } ] }
    ];

    const displayQuestion = (index) => {
        if (index >= quizQuestions.length) {
            displayDetectorResults();
            return;
        }
        const q = quizQuestions[index];
        quizContainer.innerHTML = `
            <p class="font-semibold text-slate-700 mb-4">${q.question}</p>
            <div class="flex flex-col space-y-2">
                ${q.answers.map((ans, i) => `<button type="button" data-skill="${ans.skill}" class="answer-btn text-left p-3 bg-slate-50 hover:bg-cyan-100 border rounded-lg">${ans.text}</button>`).join('')}
            </div>
        `;
        quizContainer.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                userSoftSkills.push(btn.dataset.skill);
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            });
        });
    };
    
    const displayDetectorResults = async () => {
        quizContainer.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `<div class="loader"></div>`;
        const skillCounts = userSoftSkills.reduce((acc, skill) => { acc[skill] = (acc[skill] || 0) + 1; return acc; }, {});
        const topSkills = Object.entries(skillCounts).sort((a, b) => b[1] - a[1]).map(el => el[0]);
        const prompt = `Un lyc√©en a pass√© un quiz de comp√©tences transversales. Ses comp√©tences les plus marqu√©es sont : ${topSkills.join(', ')}. R√©dige une analyse courte et positive (8-10 phrases) de son profil de comp√©tences, en expliquant ce que cela signifie pour son orientation. Tu dois t'adresser directement √† l'√©l√®ve, en utilisant "tu"`;
        const result = await callGeminiAPI(prompt);
        journalData.step10.soft_skills_profile = result;
        await saveData();
        resultsContainer.innerHTML = `<h4 class="font-bold text-slate-800 mb-2">Analyse de ton profil :</h4><div class="p-4 bg-slate-50 rounded-lg border whitespace-pre-wrap">${result}</div>`;
        checkConnectorState();
    };

    startDetectorBtn.addEventListener('click', () => {
        quizContainer.classList.remove('hidden');
        userSoftSkills = [];
        currentQuestionIndex = 0;
        displayQuestion(currentQuestionIndex);
    });

    if (journalData.step10.soft_skills_profile) {
        startDetectorBtn.classList.remove('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `<h4 class="font-bold text-slate-800 mb-2">Analyse de ton profil :</h4><div class="p-4 bg-slate-50 rounded-lg border whitespace-pre-wrap">${journalData.step10.soft_skills_profile}</div>`;
    }

    const modal = div.querySelector('#portfolio-modal');
    const experienceListContainer = div.querySelector('#experience-list-container');

    const renderExperienceCards = () => {
        experienceListContainer.innerHTML = '';
        if (journalData.step10.experiences.length === 0) {
            experienceListContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-slate-50 rounded-lg">Ton portfolio est vide. Clique sur "Ajouter une exp√©rience" pour commencer.</p>`;
        } else {
            journalData.step10.experiences.forEach((exp, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-slate-200';
                card.innerHTML = `<h4 class="font-bold text-cyan-700">Exp√©rience #${index + 1}</h4><p class="text-slate-700 whitespace-pre-wrap mt-2">${exp.analysis}</p><div class="text-right mt-2"><button type="button" data-index="${index}" class="delete-exp-btn text-red-500 hover:text-red-700 text-sm font-semibold">Supprimer</button></div>`;
                experienceListContainer.appendChild(card);
            });
        }
        div.querySelectorAll('.delete-exp-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index, 10);
                if (confirm("Es-tu s√ªr de vouloir supprimer cette exp√©rience ?")) {
                    journalData.step10.experiences.splice(index, 1);
                    saveData();
                    renderExperienceCards();
                }
            });
        });
        checkConnectorState();
    };
    
    div.querySelector('#add-experience-btn').addEventListener('click', () => {
        currentExperience = { description: '', analysis: '' };
        div.querySelector('#experience-input').value = '';
        showStep(1);
        modal.classList.remove('hidden');
    });
    div.querySelector('#portfolio-modal-close').addEventListener('click', () => modal.classList.add('hidden'));

    const wizardSteps = [div.querySelector('#wizard-step-1'), div.querySelector('#wizard-step-2'), div.querySelector('#wizard-step-3')];
    const showStep = (stepNumber) => {
        wizardSteps.forEach((step, index) => step.classList.toggle('hidden', index + 1 !== stepNumber));
    };

    div.querySelector('#wizard-next-1').addEventListener('click', async () => {
        const description = div.querySelector('#experience-input').value;
        if (description.trim().length < 20) {
            alert("Veuillez d√©crire votre exp√©rience de mani√®re un peu plus d√©taill√©e.");
            return;
        }
        currentExperience.description = description;
        showStep(2);
        div.querySelector('#loader-2').classList.remove('hidden');
        div.querySelector('#skill-tags-container').innerHTML = '';
        const prompt = `Analyse la description de l'exp√©rience suivante fournie par un lyc√©en. Identifie les 5 √† 7 comp√©tences cl√©s (savoir-√™tre ou savoir-faire) les plus importantes qui en ressortent. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un unique tableau de cha√Ænes de caract√®res. Exemple : ["Gestion de projet", "Communication"]. Voici l'exp√©rience : "${description}"`;
        const result = await callGeminiAPI(prompt, false, true);
        div.querySelector('#loader-2').classList.add('hidden');
        const skillTagsContainer = div.querySelector('#skill-tags-container');
        try {
            const skills = JSON.parse(result);
            skills.forEach(skill => {
                const tag = document.createElement('button');
                tag.type = 'button';
                tag.className = 'bg-white border-cyan-500 border-2 text-cyan-700 font-semibold py-1 px-3 rounded-full cursor-pointer transition hover:bg-cyan-100';
                tag.textContent = skill;
                tag.addEventListener('click', () => {
                    tag.classList.toggle('bg-cyan-500');
                    tag.classList.toggle('text-white');
                });
                skillTagsContainer.appendChild(tag);
            });
        } catch (e) {
            skillTagsContainer.textContent = "L'IA n'a pas pu extraire de comp√©tences. Veuillez r√©essayer.";
        }
    });

    div.querySelector('#wizard-next-2').addEventListener('click', async () => {
        const selectedSkills = Array.from(div.querySelectorAll('#skill-tags-container .bg-cyan-500')).map(tag => tag.textContent);
        if (selectedSkills.length === 0) {
            alert("Veuillez s√©lectionner au moins une comp√©tence.");
            return;
        }
        showStep(3);
        div.querySelector('#loader-3').classList.remove('hidden');
        div.querySelector('#portfolio-result').textContent = '';
        const prompt = `Agis en tant que coach carri√®re expert. R√©dige un paragraphe percutant (3-4 phrases) bas√© sur la m√©thode STAR (Situation, T√¢che, Action, R√©sultat) pour valoriser une exp√©rience. **Description de l'exp√©rience :** "${currentExperience.description}" **Comp√©tences cl√©s √† valoriser :** ${JSON.stringify(selectedSkills)}`;
        const result = await callGeminiAPI(prompt);
        div.querySelector('#loader-3').classList.add('hidden');
        div.querySelector('#portfolio-result').textContent = result;
        currentExperience.analysis = result;
    });

    div.querySelector('#save-experience-btn').addEventListener('click', async () => {
        if (currentExperience && currentExperience.analysis) {
            journalData.step10.experiences.push(currentExperience);
            await saveData();
            await grantXp(50);
            renderExperienceCards();
            modal.classList.add('hidden');
        }
    });
    
    const checkConnectorState = () => {
        const connectorSection = div.querySelector('#connector-section');
        const experiencesDone = journalData.step10.experiences && journalData.step10.experiences.length > 0;
        const detectorDone = journalData.step10.soft_skills_profile && journalData.step10.soft_skills_profile.trim() !== '';
        if (experiencesDone && detectorDone) {
            connectorSection.classList.remove('hidden');
        } else {
            connectorSection.classList.add('hidden');
        }
    };

    div.querySelector('#connect-skills-btn').addEventListener('click', async () => {
        const loader = div.querySelector('#loader-connector');
        const resultTextarea = div.querySelector('#skills-synthesis');
        loader.style.display = 'block';
        resultTextarea.value = '';
        const experienceSummaries = journalData.step10.experiences.map(exp => exp.analysis).join('\n- ');
        const profileAnalysis = journalData.step10.soft_skills_profile;
        const prompt = `Agis comme un coach carri√®re expert. Voici le profil et les exp√©riences d'un √©l√®ve :
        **Profil de savoir-√™tre :** ${profileAnalysis}
        **Exp√©riences concr√®tes :** - ${experienceSummaries}
        Ta mission est de r√©diger une synth√®se (2-3 paragraphes) qui connecte ces deux aspects. Montre comment ses savoir-√™tre se manifestent dans ses savoir-faire. Utilise des phrases comme "Ta comp√©tence en [savoir-√™tre] se voit clairement lorsque tu as..." pour cr√©er des ponts. Le but est de l'aider √† formuler un discours coh√©rent sur ses atouts. Adresse-toi directement √† lui.`;
        const result = await callGeminiAPI(prompt);
        loader.style.display = 'none';
        resultTextarea.value = result;
        journalData.step10.skills_synthesis = result;
        await saveData();
        await grantXp(75);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        checkBadges();
        await saveData();
        showView('menu');
    });

    renderExperienceCards();
    checkConnectorState();

    return div;
}


// REMPLACEZ VOTRE FONCTION createOrientationMapView EXISTANTE PAR CELLE-CI :
function createOrientationMapView(data, context = 'user') {
    const profileTitle = context === 'user' ? 'Mon Profil' : 'Son Profil';

    let mapHTML = '<div class="mb-8"><h2 class="text-xl font-bold text-slate-800 text-center mb-4">üó∫Ô∏è Carte d\'Orientation Personnelle</h2>';
    mapHTML += '<div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">';

    // --- MODIFICATION : Affiche l'arch√©type au lieu d'un r√©sum√© ---
    const archetype = data.step0 ? data.step0.archetype : null;

    if (archetype && archetype.titre) {
        mapHTML += `<div class="lg:col-span-1 bg-cyan-50 p-4 rounded-lg border border-cyan-200 text-center">
                        <h3 class="font-bold text-cyan-800">üë§ ${profileTitle}</h3>
                        <div class="mt-2">
                            <span class="text-4xl">${archetype.icone}</span>
                            <p class="font-semibold text-slate-800 mt-1">${archetype.titre}</p>
                            <p class="text-sm text-slate-600">${archetype.description}</p>
                        </div>
                    </div>`;
    } else {
        mapHTML += `<div class="lg:col-span-1 bg-slate-50 p-4 rounded-lg border text-center">
                        <h3 class="font-bold text-slate-500">üë§ ${profileTitle}</h3>
                        <p class="text-sm text-slate-500 mt-2">Compl√®te l'√©tape "Mieux se conna√Ætre" pour r√©v√©ler ton profil.</p>
                    </div>`;
    }
    // --- FIN DE LA MODIFICATION ---

    mapHTML += '<div class="lg:col-span-2 space-y-4">';
    
    const metiers = [data.step1?.metier1, data.step1?.metier2, data.step1?.metier3].filter(m => m && m.trim() !== '');
    if (metiers.length > 0) {
        mapHTML += `<div class="bg-sky-50 p-3 rounded-lg border border-sky-200">
                        <h4 class="font-semibold text-sky-800">üìö M√©tiers explor√©s</h4>
                        <p class="text-sm text-slate-600">${metiers.join(', ')}</p>
                    </div>`;
    }

    const formations = [data.step3?.formation1, data.step3?.formation2].filter(f => f && f.trim() !== '');
    if (formations.length > 0) {
        mapHTML += `<div class="bg-lime-50 p-3 rounded-lg border border-lime-200">
                        <h4 class="font-semibold text-lime-800">üéì Formations envisag√©es</h4>
                        <p class="text-sm text-slate-600">${formations.join(', ')}</p>
                    </div>`;
    }

    if (data.step10 && data.step10.experiences && data.step10.experiences.length > 0) {
        mapHTML += `<div class="bg-amber-50 p-3 rounded-lg border border-amber-200">
                        <h4 class="font-semibold text-amber-800">üíº Comp√©tences identifi√©es</h4>
                        <p class="text-sm text-slate-600">√Ä travers ${data.step10.experiences.length} exp√©rience(s) valoris√©e(s).</p>
                    </div>`;
    }
    
    mapHTML += '</div></div></div>';
    return mapHTML;
}


function createStep11View() {
    const config = stepsConfig.step11;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    form.querySelector('button[type="submit"]').remove();

    form.innerHTML += `
        <div class="text-center mb-4">
            <button type="button" id="geminiBtn_local" class="w-full sm:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üåç Lancer la recherche locale</button>
        </div>
        <div id="geminiLoader_local" class="hidden"><div class="loader"></div></div>
        <div id="results-container" class="mt-8"></div>
        <hr class="my-12 border-slate-300">
        <h2 class="text-2xl font-bold text-slate-800 mb-4">Pr√©parer mes visites</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-slate-50 p-4 rounded-lg border">
                <h3 class="font-bold text-slate-800 mb-2">Pr√©parer une JPO</h3>
                <input type="text" id="jpo_ecole" name="jpo_ecole" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Nom de l'√©cole ou formation" value="${journalData.step11.jpo_ecole || ''}">
                <button type="button" id="geminiBtn_jpo" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">üí° G√©n√©rer des questions</button>
                <div id="geminiLoader_jpo" class="hidden"><div class="loader"></div></div>
                <textarea id="jpo_questions" name="jpo_questions" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly>${journalData.step11.jpo_questions || ''}</textarea>
            </div>
            <div class="bg-slate-50 p-4 rounded-lg border">
                <h3 class="font-bold text-slate-800 mb-2">Pr√©parer une visite de Salon</h3>
                <input type="text" id="salon_nom" name="salon_nom" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Nom du salon (ex: Salon de l'√âtudiant)" value="${journalData.step11.salon_nom || ''}">
                <button type="button" id="geminiBtn_salon" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">üéØ Pr√©parer ma visite</button>
                <div id="geminiLoader_salon" class="hidden"><div class="loader"></div></div>
                <textarea id="salon_preparation" name="salon_preparation" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly>${journalData.step11.salon_preparation || ''}</textarea>
            </div>
        </div>
        <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
    `;

    const locationInput = div.querySelector('#location');
    const searchBtn = div.querySelector('#geminiBtn_local');
    const jpoBtn = div.querySelector('#geminiBtn_jpo');
    const salonBtn = div.querySelector('#geminiBtn_salon');
    const resultsContainer = div.querySelector('#results-container');

    const renderResults = (data) => {
        let html = '';
        if (data.evenements && Array.isArray(data.evenements) && data.evenements.length > 0) {
            html += '<h2 class="text-2xl font-bold text-slate-800 mb-4">üóìÔ∏è √âv√©nements √† ne pas manquer</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            data.evenements.forEach((event, index) => {
                const dateInputId = `event-date-${index}`;
                const retroBtn = `<button type="button" class="add-to-retro-btn text-xs bg-orange-100 text-orange-800 font-semibold py-1 px-2 rounded-lg hover:bg-orange-200 transition whitespace-nowrap" data-nom="${event.nom}" data-input-id="${dateInputId}">+ R√©troplanning</button>`;
                const searchQuery = `${event.nom} ${event.lieu || ''}`;
                const eventUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
                html += `
                    <div class="bg-white p-4 rounded-lg shadow border border-slate-200 flex flex-col h-full">
                        <h3 class="font-bold text-cyan-700">${event.nom}</h3>
                        <label for="${dateInputId}" class="text-slate-600 text-sm font-medium mt-2">Date (modifiable) :</label>
                        <input type="date" id="${dateInputId}" value="${event.date || ''}" class="w-full border-slate-300 border rounded-md p-1 mt-1 text-sm">
                        <p class="text-slate-500 text-sm mt-2">${event.lieu}</p>
                        <div class="mt-auto pt-2 flex flex-col items-center gap-2">
                            <a href="${eventUrl}" target="_blank" class="text-cyan-600 hover:underline text-sm font-semibold">V√©rifier la date ‚Üó</a>
                            ${retroBtn}
                        </div>
                    </div>`;
            });
            html += '</div>';
        }
        if (data.structures && Array.isArray(data.structures) && data.structures.length > 0) {
            html += '<h2 class="text-2xl font-bold text-slate-800 mt-8 mb-4">üè¢ Structures pour t\'accompagner</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            data.structures.forEach(struct => {
                const searchQuery = `${struct.nom}, ${struct.adresse}`;
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
                const mapsLink = `<a href="${mapsUrl}" target="_blank" class="text-cyan-600 hover:underline text-sm font-semibold mt-2 inline-block">Voir sur la carte ‚Üó</a>`;
                html += `<div class="bg-white p-4 rounded-lg shadow border border-slate-200"><h3 class="font-bold text-cyan-700">${struct.nom}</h3><p class="text-slate-600 text-sm">${struct.adresse}</p><p class="text-slate-500 text-sm">${struct.telephone || ''}</p>${mapsLink}</div>`;
            });
            html += '</div>';
        }
        resultsContainer.innerHTML = html;
    };
    
    if (journalData.step11 && (journalData.step11.evenements || journalData.step11.structures)) {
        renderResults(journalData.step11);
    }

    searchBtn.addEventListener('click', async () => {
        const location = locationInput.value.trim();
        if (!location) {
            alert("Veuillez indiquer une ville ou un d√©partement.");
            return;
        }
        const loader = div.querySelector('#geminiLoader_local');
        loader.style.display = 'block';
        resultsContainer.innerHTML = '';
        const today = new Date();
        const currentYear = today.getFullYear();
        const academicYear = today.getMonth() >= 7 ? `${currentYear}-${currentYear + 1}` : `${currentYear - 1}-${currentYear}`;
        
        // === PROMPT FINAL AVEC TOUTES LES EXIGENCES ===
        const prompt = `Agis comme un documentaliste expert en orientation pour un lyc√©en √† "${location}".
        Ta mission est de trouver des informations locales pertinentes pour l'ann√©e scolaire ${academicYear}.

        **Ta r√©ponse doit √™tre UNIQUEMENT un objet JSON valide.**

        Le JSON doit contenir deux cl√©s principales : "evenements" et "structures".

        1.  **Pour la cl√© "evenements"**:
            * Trouve jusqu'√† **6 √©v√©nements** (salons, JPO) pertinents.
            * Les √©v√©nements doivent se situer dans un rayon de **80 km** autour de "${location}". cherche ces √©vennements sur google, affiches ceux qui auront lieu dans les 4 prochains mois √† partir de aujourd'hui.
            * Pour chaque √©v√©nement, fournis "nom", "lieu", et "date" (format AAAA-MM-JJ, m√™me si c'est une estimation bas√©e sur l'ann√©e pr√©c√©dente).

        2.  **Pour la cl√© "structures"**:
            * Trouve les **6 structures d'aide √† l'orientation** (CIO, Mission Locale...) les plus proches.
            * Pour chaque structure, fournis "nom", "adresse", et "telephone".

        Assure-toi que la sortie est un JSON pur, sans texte explicatif avant ou apr√®s.`;

        const result = await callGeminiAPI(prompt, true, true);
        loader.style.display = 'none';

        try {
            const data = extractJsonFromString(result);
            if (!data) {
                 throw new Error("La r√©ponse de l'IA est vide ou invalide.");
            }
            // === ON SAUVEGARDE √Ä NOUVEAU LES DEUX TYPES DE DONN√âES ===
            journalData.step11.evenements = data.evenements || [];
            journalData.step11.structures = data.structures || []; 
            await saveData();
            renderResults(data);
        } catch (error) {
            console.error("Erreur d'analyse ou de traitement de la r√©ponse IA:", error);
            resultsContainer.innerHTML = `<p class="text-red-500 text-center">D√©sol√©, une erreur est survenue. L'IA n'a pas renvoy√© de format exploitable.</p><textarea class="w-full h-40 bg-slate-100 p-2 rounded mt-2" readonly>${result}</textarea>`;
        }
    });
    
    jpoBtn.addEventListener('click', async () => { /* ... (code inchang√©) ... */ });
    salonBtn.addEventListener('click', async () => { /* ... (code inchang√©) ... */ });
    
    div.addEventListener('click', async (e) => {
        if (e.target.matches('.add-to-retro-btn')) {
            const button = e.target;
            const eventName = button.dataset.nom;
            const inputId = button.dataset.inputId;
            const dateInput = document.getElementById(inputId);
            const eventDate = dateInput.value;
            if (!eventDate) {
                alert("Veuillez entrer une date valide avant d'ajouter l'√©v√©nement au r√©troplanning.");
                return;
            }
            if (!journalData.retroplanning || !Array.isArray(journalData.retroplanning.tasks)) {
                alert("Veuillez d'abord g√©n√©rer un R√©troplanning.");
                return;
            }
            const monthNames = ["janvier", "f√©vrier", "mars", "avril", "mai", "juin", "juillet", "ao√ªt", "septembre", "octobre", "novembre", "d√©cembre"];
            let monthIndex = -1;
            const parts = eventDate.split('-');
            const monthNumber = parseInt(parts[1], 10);
            if (monthNumber >= 1 && monthNumber <= 12) {
                monthIndex = monthNumber - 1;
            }
            if (monthIndex === -1) {
                alert("La date entr√©e semble invalide. Veuillez utiliser le format AAAA-MM-JJ.");
                return;
            }
            const monthName = monthNames[monthIndex].charAt(0).toUpperCase() + monthNames[monthIndex].slice(1);
            let monthObject = journalData.retroplanning.tasks.find(m => m.month === monthName);
            if (!monthObject) {
                monthObject = { month: monthName, tasks: [] };
                journalData.retroplanning.tasks.push(monthObject);
                journalData.retroplanning.tasks.sort((a, b) => monthNames.indexOf(a.month.toLowerCase()) - monthNames.indexOf(b.month.toLowerCase()));
            }
            const newTaskText = `Participer √† : ${eventName}`;
            if (!monthObject.tasks.some(task => task.text === newTaskText)) {
                monthObject.tasks.push({ text: newTaskText, completed: false });
                await saveData();
                button.textContent = 'Ajout√© ‚úî';
                button.disabled = true;
                button.classList.remove('bg-orange-100', 'hover:bg-orange-200');
                button.classList.add('bg-green-100', 'text-green-800');
            } else {
                alert("Cet √©v√©nement est d√©j√† dans votre R√©troplanning !");
                button.textContent = 'D√©j√† ajout√©';
                button.disabled = true;
            }
        }
    });

    return div;
}

      function createRetroplanningView() {
            const div = document.createElement('div');
            div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';
            
            div.innerHTML = `
              <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap mb-6">üóìÔ∏è Mon R√©troplanning</h1>
        
        <div class="text-slate-600 mb-4 space-y-2">
            <p>Pour ton orientation, un bon planning est essentiel ! Cet outil part des grandes √©ch√©ances de ton ann√©e et te propose un plan d'action mois par mois pour y arriver sans stress.</p>
        </div>
        
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><p class="font-semibold text-cyan-900"><b>Ta mission :</b> Clique sur le bouton pour que l'IA te cr√©e un r√©troplanning sur-mesure. Coche ensuite les cases au fur et √† mesure de ton avanc√©e !</p></div>
        
        <div class="text-center mb-6">
            <button type="button" id="geminiBtn_retro" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üìÖ G√©n√©rer / Mettre √† jour mon R√©troplanning</button>
        </div>
        <div id="geminiLoader_retro" class="hidden"><div class="loader"></div></div>

        <div id="retroplanning-content">
            </div>

        <form id="retroForm" class="hidden">
            <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Sauvegarder et retourner au menu</button>
        </form>
    `;

            const retroplanningContent = div.querySelector('#retroplanning-content');

            const renderTimeline = () => {
                if (!journalData.retroplanning || !journalData.retroplanning.tasks || journalData.retroplanning.tasks.length === 0) {
                    retroplanningContent.innerHTML = `<p class="text-center text-slate-500">Cliquez sur le bouton ci-dessus pour g√©n√©rer votre planning personnalis√©.</p>`;
                    return;
                }

                let timelineHTML = journalData.retroplanning.tasks.map((monthData, monthIndex) => {
            const tasksHTML = monthData.tasks.map((task, taskIndex) => `
                <li class="flex items-center mb-2">
                    <input type="checkbox" id="task-${monthIndex}-${taskIndex}" data-month-index="${monthIndex}" data-task-index="${taskIndex}" class="h-4 w-4 rounded border-gray-300 text-cyan-600 focus:ring-cyan-500 mr-3" ${task.completed ? 'checked' : ''}>
                    <label for="task-${monthIndex}-${taskIndex}" class="text-slate-700 ${task.completed ? 'line-through text-slate-400' : ''}">${task.text}</label>
                </li>
            `).join('');

                    return `
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-cyan-700 border-b pb-2 mb-3">${monthData.month}</h3>
                            <ul class="list-none">
                                ${tasksHTML}
                            </ul>
                        </div>
                    `;
                }).join('');
                
                retroplanningContent.innerHTML = `
                    <div>
                <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Ta Feuille de Route</h2>
                ${timelineHTML}
                <div class="mt-8 bg-slate-50 p-4 rounded-lg">
                    <h3 class="font-bold text-slate-800 mb-2">Le conseil d√©taill√© de ton Coach :</h3>
                    <p class="whitespace-pre-wrap text-slate-600 text-sm">${journalData.retroplanning.rawText || ''}</p>
                </div>
            </div>
        `;
                
                // Add event listeners to checkboxes
                retroplanningContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const monthIndex = e.target.dataset.monthIndex;
                        const taskIndex = e.target.dataset.taskIndex;
                        journalData.retroplanning.tasks[monthIndex].tasks[taskIndex].completed = e.target.checked;
                        saveData(); // Sauvegarde √† chaque changement
                        renderTimeline(); // Re-render pour appliquer le style barr√©
                    });
                });
                
                div.querySelector('#retroForm').classList.remove('hidden');
            };


            div.querySelector('#geminiBtn_retro').addEventListener('click', async () => {
                const loader = div.querySelector('#geminiLoader_retro');
                loader.style.display = 'block';
                retroplanningContent.innerHTML = '';
                
                let prompt = '';
                const date = new Date().toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });

                const commonPromptPart = `
                Ta r√©ponse DOIT √™tre un objet JSON valide. Cet objet doit contenir deux cl√©s :
                1. "conseilDetaille": une cha√Æne de caract√®res contenant ton analyse compl√®te et r√©dig√©e.
                2. "timeline": un tableau d'objets. Chaque objet repr√©sente un mois et doit avoir deux cl√©s :
                   - "month": le nom du mois (ex: "Septembre").
                   - "tasks": un tableau d'objets, o√π chaque objet repr√©sente une t√¢che et a deux cl√©s : "text" (la description de la t√¢che) et "completed" (toujours 'false' initialement).
                `;

                switch(userGradeLevel) {
                    case 'seconde':
                        prompt = `Agis en tant que conseiller d'orientation expert, sp√©cialis√© dans l'accompagnement des lyc√©ens en classe de Seconde g√©n√©rale en France.

Un √©l√®ve de Seconde te demande de lui cr√©er un r√©troplanning d'orientation personnalis√© et actionnable pour son ann√©e scolaire. Nous sommes le ${date}.

Ta mission se d√©roule en plusieurs √©tapes :

1.  **Recherche d'informations :** Utilise la recherche web pour trouver le calendrier scolaire fran√ßais typique d'une ann√©e de Seconde. Identifie les moments cl√©s et les √©ch√©ances importantes :
    * Les dates des conseils de classe (fin du 1er et 2√®me trimestre).
    * La p√©riode de saisie des v≈ìux pour les enseignements de sp√©cialit√© de la classe de Premi√®re (g√©n√©ralement autour de mai).
    * La date du stage obligatoire de Seconde en fin d'ann√©e (juin).
    * Les p√©riodes des grands salons d'orientation (Studyrama, l'√âtudiant, etc.).

2.  **Planification mensuelle th√©matique :** En te basant sur ces informations, cr√©e un planning mois par mois, du mois actuel jusqu'√† juin de l'ann√©e suivante. Le planning doit suivre une progression logique :
    * **Trimestre 1 : Exploration & D√©couverte.**
    * **Trimestre 2 : Approfondissement & Pr√©paration des choix.**
    * **Trimestre 3 : D√©cision & Concr√©tisation.**
    Pour chaque mois, propose des actions claires et r√©alistes.

3.  **Int√©gration des √©tapes de l'application :** Pour chaque mois, tu dois recommander √† l'√©l√®ve de r√©aliser une ou plusieurs √©tapes de son application "Mon Explor'Orientation". Il est **imp√©ratif** que tu utilises scrupuleusement les noms exacts des √©tapes list√©es ci-dessous.

4.  **Conseils d'Expert (Obligatoire) :**
    Dans la section "conseilDetaille" de ta r√©ponse JSON, tu dois inclure un paragraphe de coaching, suivi de deux sous-sections de conseils concrets :
    * **Bien choisir ses sp√©cialit√©s :** Donne 2-3 conseils cl√©s pour faire des choix √©clair√©s (lien entre les mati√®res, les projets d'√©tudes et les centres d'int√©r√™t).
    * **R√©ussir son stage de Seconde :** Explique comment chercher un stage, se comporter en entreprise et en tirer le meilleur parti pour son orientation.
    * Tu dois imp√©rativement √©crire de fa√ßon fluide sans # et sans * dans tes paragraphes.

    **Liste des √©tapes de l'application √† utiliser :**
    * 'Mieux se conna√Ætre'
    * 'Les Fondations'
    * 'Le simulateur de sp√©cialit√©s'
    * 'Le Catalogue'
    * 'L'Exp√©rience'
    * 'L'Actu & Tests'
    * 'Quiz : Chasse aux Mythes'
    * 'Passer √† l'action'
    * 'Rencontres sur mon Territoire' ${commonPromptPart}`;
                        break;
                    case 'premiere':
                        prompt = ` Agis en tant que conseiller d'orientation expert et coach scolaire rigoureux, sp√©cialis√© dans l'accompagnement des lyc√©ens en classe de Premi√®re g√©n√©rale en France.

Un √©l√®ve de Premi√®re te demande de lui cr√©er un r√©troplanning strat√©gique pour son ann√©e. **Nous sommes le ${date}.** Ta r√©ponse doit √™tre d'une pr√©cision absolue et se baser sur les √©ch√©ances officielles.

Ta mission est la suivante :

1.  **Calendrier de r√©f√©rence (non-n√©gociable) :**
    Tu dois construire ton planning autour des jalons suivants pour l'ann√©e scolaire en cours et √† venir :
    * **√âch√©ances Acad√©miques :** Prends en compte les p√©riodes des **conseils de classe** (vers d√©but d√©cembre et mi-mars) comme des moments de bilan.
    * **P√©riodes de R√©vision :** Utilise les **vacances scolaires** (Toussaint, No√´l, Hiver, P√¢ques) comme des moments cl√©s pour la consolidation et les r√©visions.
    * **√âpreuves Finales :**
        * √âpreuve √©crite de Fran√ßais : mi-juin.
        * √âpreuves orales de Fran√ßais : de fin juin √† d√©but juillet.
        * √âpreuve de Math√©matiques (pour tous) : fin juin.
        (Utilise la recherche web pour trouver les dates exactes pour l'ann√©e scolaire concern√©e).

2.  **Planification Strat√©gique Mensuelle :**
    √âlabore un planning d√©taill√© √† partir du mois actuel jusqu'√† juillet de l'ann√©e suivante, en suivant une progression logique : le premier trimestre pour la d√©couverte et la m√©thode, le deuxi√®me pour l'approfondissement, et le troisi√®me pour la finalisation et la pr√©paration intensive.

    Chaque mois doit comporter des t√¢ches √©quilibr√©es entre **trois axes majeurs** :
    * **Axe 1 - R√©ussite Scolaire :** Actions pour renforcer les acquis (fran√ßais, maths).
    * **Axe 2 - Construction du Projet :** R√©partis de mani√®re logique les √©tapes de l'application "Mon Explor'Orientation".
    * **Axe 3 - √âquilibre & Bien-√™tre :** Propose une action simple pour g√©rer le stress et maintenir la motivation.

3.  **Conseils d'Expert (Obligatoire) :**
    Dans la section "conseilDetaille" de ta r√©ponse JSON, tu dois inclure un paragraphe de coaching, suivi de trois sous-sections de conseils m√©thodologiques distincts et concrets :
    * R√©ussir l'√âcrit de Fran√ßais
    * Pr√©parer l'Oral de Fran√ßais
    * Aborder l'√âpreuve de Math√©matiques
    * Tu dois imp√©rativement √©crire de fa√ßon fluide sans # et sans * dans tes paragraphes.

    **Liste des √©tapes de l'application √† utiliser :**
    * 'Mieux se conna√Ætre'
    * 'Les Fondations'
    * 'Le simulateur de sp√©cialit√©s'
    * 'Le Catalogue'
    * 'L'Exp√©rience'
    * 'L'Actu & Tests'
    * 'Quiz : Chasse aux Mythes'
    * 'Passer √† l'action'
    * 'Mon Portfolio de Comp√©tences'
    * 'Rencontres sur mon Territoire' ${commonPromptPart}`;
                        break;
                    case 'terminale':
                        prompt = `Agis en tant que conseiller d'orientation expert et coach de r√©ussite intransigeant, sp√©cialis√© dans l'accompagnement des lyc√©ens en classe de Terminale en France.

Un √©l√®ve de Terminale te demande de lui cr√©er un r√©troplanning strat√©gique pour son ann√©e. **Nous sommes le ${date}.** Ta r√©ponse doit √™tre d'une pr√©cision absolue et se baser sur le calendrier officiel.

Ta mission est la suivante :

1.  *Calendrier Officiel 2025-2026 (non-n√©gociable) :**
¬† ¬† Tu dois construire ton planning en te basant **exclusivement** sur les √©ch√©ances suivantes.

¬† ¬† **√âpreuves du Baccalaur√©at (dates impos√©es) :**
¬† ¬† * **Philosophie :** lundi 15 juin 2026.
¬† ¬† * **√âpreuves de sp√©cialit√© :** du mardi 16 au jeudi 18 juin 2026.
¬† ¬† * **Grand oral :** du lundi 22 juin au mercredi 1er juillet 2026.

¬† ¬† **Calendrier Parcoursup (√† respecter scrupuleusement) :**
¬† ¬† * **Septembre √† D√©cembre :** Phase d'information.
¬† ¬† * **Fin D√©cembre :** Mise √† jour du catalogue des formations.
¬† ¬† * **Janvier :** D√©but des inscriptions et formulation des v≈ìux.
¬† ¬† * **Mars :** Date limite pour ajouter des v≈ìux.
¬† ¬† * **Avril :** P√©riode pour finaliser les dossiers et confirmer chaque v≈ìu.
¬† ¬† * **Juin :** D√©but de la phase d'admission principale.
¬† ¬† * **Juillet :** Fin de la phase principale.

    * **√âpreuves du Baccalaur√©at :**
        * Philosophie
        * √âpreuves de sp√©cialit√©
        * Grand oral

    * **Calendrier Parcoursup :**
        * Phase d'information et ouverture du site.
        * D√©but des inscriptions et formulation des v≈ìux.
        * **Date limite** pour ajouter des v≈ìux.
        * **Date limite** pour finaliser les dossiers et confirmer chaque v≈ìu.
        * D√©but de la phase d'admission principale.
        * Fin de la phase principale.

2.  **Planification Mensuelle D√©taill√©e :**
    √Ä partir de ce calendrier, cr√©e un planning **du mois actuel jusqu'√† juillet de l'ann√©e suivante** avec **trois axes clairs** pour chaque mois :
    * **Axe 1 - Parcoursup & Orientation :** Actions li√©es au dossier, v≈ìux et admissions. Int√®gre les √©tapes de l'application.
    * **Axe 2 - Pr√©paration au Bac :** R√©visions et pr√©paration sp√©cifique pour chaque grande √©preuve.
    * **Axe 3 - √âquilibre & Gestion du Stress :** Un conseil ou une action pour g√©rer la pression et rester concentr√©.

3.  **Conseils d'Expert (Obligatoire) :**
    Dans la section "conseilDetaille" de ta r√©ponse JSON, tu dois inclure un paragraphe de coaching, suivi de trois sous-sections de conseils m√©thodologiques distincts et concrets :
    * **R√©ussir la Philosophie :** Donne 2-3 conseils cl√©s sur la m√©thode et la gestion du temps.
    * **Pr√©parer les √âpreuves de Sp√©ralit√© :** Explique comment organiser ses r√©visions et l'importance des annales.
    * **Ma√Ætriser le Grand Oral :** Donne des conseils sur le choix du sujet, la structuration et la gestion du stress.
    * Tu dois imp√©rativement √©crire de fa√ßon fluide sans # et sans * dans tes paragraphes.

**√âtapes cl√©s de l'application √† utiliser :**
* 'Le Catalogue'
* 'Mon Portfolio de Comp√©tences'
* 'Passer √† l'action'
* 'L'Exp√©rience'
* 'Pr√©parer sa candidature'
* 'Anticiper la suite'
* 'Simulateur Vie √âtudiante'
 ${commonPromptPart}`;
                        break;
                }

                const result = await callGeminiAPI(prompt, true, true);
                loader.style.display = 'none';

                try {
                    const parsedResult = JSON.parse(result);
                    journalData.retroplanning = {
                        tasks: parsedResult.timeline,
                        rawText: parsedResult.conseilDetaille
                    };
                    await saveData();
                    await grantXp(100);
                    renderTimeline();
                } catch (e) {
                    console.error("Erreur de parsing du JSON du r√©troplanning:", e);
                    retroplanningContent.innerHTML = `<p class="text-center text-red-500">L'IA n'a pas pu g√©n√©rer un planning au format interactif. Voici la r√©ponse brute :</p><textarea class="w-full h-64 mt-2 bg-slate-100 p-2 rounded">${result}</textarea>`;
                }
            });
            
            div.querySelector('#retroForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveData();
                showView('menu');
            });

            renderTimeline();

            return div;
        }

async function createJournalView() {

    // 1. Cr√©ation du conteneur principal de la page
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

    const allStepsForLevel = allSteps.filter(step => step.levels.includes(userGradeLevel));
    const completedStepsCount = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id) && isStepComplete(step.id)).length;
    const totalTrackableSteps = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id)).length;
    const progressPercentageSteps = totalTrackableSteps > 0 ? (completedStepsCount / totalTrackableSteps) * 100 : 0;

    const progressBarHTML = `
        <div class="max-w-xl mx-auto mb-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-cyan-700">Progression des √âtapes</span>
                <span class="text-sm font-medium text-cyan-700">${Math.round(progressPercentageSteps)}%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progressPercentageSteps}%"></div>
            </div>
        </div>
    `;

    const headerEl = document.createElement('div');
    headerEl.innerHTML = `
    <div class="text-center mb-6">
        <h1 class="text-2xl font-bold flex justify-center items-center gap-2 md:whitespace-nowrap">üìì Mon Journal de Bord</h1>
        <p class="text-slate-500">Pour ${currentUserInfo.firstName} ${currentUserInfo.lastName}, √©l√®ve de ${userGradeLevel}.</p>
    </div>
`;

    // -- Panneau de Partage --
    const shareToken = journalData.share_token || null;
    const shareLink = shareToken ? `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${shareToken}` : '';
    const sharePanelEl = document.createElement('div');
    sharePanelEl.innerHTML = `
        <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-8">
            <h2 class="text-xl font-bold text-slate-800 mb-2">ü§ù Espace Partage</h2>
            <p class="text-slate-600 text-sm mb-4">Partage une version "lecture seule" de ton journal avec tes parents ou ton professeur principal pour faciliter la discussion.</p>
            <div id="share-link-container" class="${shareToken ? '' : 'hidden'}">
                <label class="font-semibold text-slate-700">Ton lien de partage unique :</label>
                <div class="flex items-center gap-2 mt-1">
                    <input type="text" id="share-link-input" value="${shareLink}" readonly class="w-full p-2 border border-slate-300 rounded-lg bg-slate-200">
                    <button id="copy-share-link" class="bg-cyan-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-cyan-700">Copier</button>
                </div>
            </div>
            <div class="mt-4 text-center">
                <button id="toggle-share-btn" class="text-sm font-semibold ${shareToken ? 'text-red-600 hover:text-red-800' : 'text-green-600 hover:text-green-800'}">
                    ${shareToken ? '‚ùå D√©sactiver le partage' : '‚úÖ Activer le partage'}
                </button>
            </div>
        </div>
    `;

    // -- Fil Rouge --
    const filRougeEl = document.createElement('div');
    filRougeEl.innerHTML = `
        <div id="filRougeContainer" class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-800">‚ú® Mon Fil Rouge</h2>
                <button id="updateFilRougeBtn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition text-sm">Mettre √† jour</button>
            </div>
            <div id="filRougeLoader" class="hidden"><div class="loader"></div></div>
            <p id="filRougeContent" class="text-slate-700 whitespace-pre-wrap">${journalData.fil_rouge || "Cliquez sur 'Mettre √† jour' pour que l'IA analyse votre parcours et cr√©e une synth√®se."}</p>
        </div>
    `;

    // 3. Assemblage de la page dans le bon ordre
    div.appendChild(headerEl);
    div.innerHTML += progressBarHTML;
    div.appendChild(sharePanelEl);

    const earnedBadges = journalData.earned_badges || [];
    if (earnedBadges.length > 0) {
        const badgesWrapper = document.createElement('div');
        badgesWrapper.innerHTML = createBadgesDisplay('journal');
        div.appendChild(badgesWrapper);
    }

    const mapWrapper = document.createElement('div');
    mapWrapper.innerHTML = createOrientationMapView(journalData, 'user');
    div.appendChild(mapWrapper);

    div.appendChild(filRougeEl);

    // 4. Remplissage du contenu d√©taill√© (infographie + √©tapes)
    const journalContentDiv = document.createElement('div');
    journalContentDiv.id = 'journalContent';
    journalContentDiv.className = 'mt-8 space-y-4'; // Ajout de space-y-4 pour espacer les blocs
    
    let hasAnyContent = false;

    // L'infographie reste toujours visible
    if (journalData.step0 && journalData.step0.analysis) {
        const infographicElement = createProfileInfographic(journalData.step0);
        journalContentDiv.appendChild(infographicElement);
        hasAnyContent = true;
    }

    // On pr√©pare les titres de toutes les sections, y compris le portfolio
    const stepTitles = {
        step10: 'üíº Mon Portfolio de Comp√©tences',
        step2: 'üß≠ Mes simulations de sp√©cialit√©s',
        step1: 'üìö Mes Fondations',
        step3: 'üéì Mon Catalogue',
        step8: 'üöÄ Mes passages √† l\'action',
        radar_history: 'üì° Mon Radar √† Opportunit√©s',
        chatbot_saves: 'üí¨ Mes Discussions avec le Coach',
        step4: 'üí¨ L\'exp√©rience',
        step11: 'üåç Mes rencontres sur le territoire',
        step6: '‚úçÔ∏è Mes pr√©parations de candidatures',
        step9: 'üîÆ Mon anticipation de la suite',
        step12: 'üí∂ Mes simulations de vie √©tudiante',
        step5: 'üì∞ Mon Actu',
        step7: '‚úÖ Mes Scores (Fact Checking)',
    };

    // MODIFICATION : Nouvelle boucle pour cr√©er les blocs pliables
    for (const stepKey in stepTitles) {
        const stepData = journalData[stepKey];
        let sectionHTML = '';
        let hasContentInSection = false;

        if (stepKey === 'chatbot_saves') {
            if (Array.isArray(stepData) && stepData.length > 0) {
                hasContentInSection = true;
                sectionHTML += '<div class="space-y-3">';
                stepData.forEach(item => {
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Question : "${item.question}"</summary>
                            <div class="p-3 border-t border-slate-200">
                                <p class="whitespace-pre-wrap text-slate-600">${linkify(item.reponse)}</p>
                            </div>
                        </details>
                    `;
                });
                sectionHTML += '</div>';
            }
        } 

        let entries = [];
        // On g√®re les √©tapes √† entr√©es multiples
        if (['step1', 'step3', 'step4', 'step5', 'step6', 'step9'].includes(stepKey)) {
            if(stepData) {
                if (stepKey === 'step1') { for (let i = 1; i <= 3; i++) if (stepData[`metier${i}`]) entries.push({ title: stepData[`metier${i}`], fieldsToDelete: [`metier${i}`, `notes${i}`, `analysisText${i}`], content: { 'Notes': stepData[`notes${i}`], 'Analyse IA': stepData[`analysisText${i}`] } }); }
                if (stepKey === 'step3') { for (let i = 1; i <= 2; i++) if (stepData[`formation${i}`]) entries.push({ title: stepData[`formation${i}`], fieldsToDelete: [`formation${i}`, `attendus${i}`, `compatibilite${i}`, `mots_cles${i}`, `analyse_mots_cles${i}`], content: { 'Attendus': stepData[`attendus${i}`], 'Rapport de compatibilit√©': stepData[`compatibilite${i}`], 'Mots-cl√©s': stepData[`mots_cles${i}`], 'Analyse des mots-cl√©s': stepData[`analyse_mots_cles${i}`] } }); }
                if (stepKey === 'step4') { for (let i = 1; i <= 2; i++) if (stepData[`theme${i}`]) entries.push({ title: stepData[`theme${i}`], fieldsToDelete: [`theme${i}`, `question${i}`, `suggestions${i}`], content: { 'Ma question': stepData[`question${i}`], 'Suggestions IA': stepData[`suggestions${i}`] } }); }
                if (stepKey === 'step5') { for (let i = 1; i <= 3; i++) if (stepData[`article${i}`]) entries.push({ title: stepData[`article${i}`], fieldsToDelete: [`article${i}`, `apprentissage${i}`], content: { 'Ce que j\'ai appris': stepData[`apprentissage${i}`] } }); }
                if (stepKey === 'step6') { for (let i = 1; i <= 2; i++) if (stepData[`lettre${i}`]?.formation) entries.push({ title: stepData[`lettre${i}`].formation, fieldsToDelete: [`lettre${i}`], content: { 'Motivations': stepData[`lettre${i}`].motivations, 'Structure propos√©e': stepData[`lettre${i}`].structure } }); }
                if (stepKey === 'step9') {
                    if (stepData.formation_reve) entries.push({ title: 'Simulation : Mon Plan B', fieldsToDelete: ['formation_reve', 'planb_chat_history'], content: { 'Formation "r√™v√©e"': stepData.formation_reve, 'Historique': (stepData.planb_chat_history || []).map(msg => `<strong>${msg.role === 'user' ? 'Moi' : 'Coach'}:</strong> ${msg.text}`).join('<br>') } });
                    if (stepData.reussite_type) entries.push({ title: 'Coach de R√©ussite', fieldsToDelete: ['reussite_type', 'reussite_conseils'], content: { 'Formation': stepData.reussite_type, 'Conseils': stepData.reussite_conseils } });
                }
            }

            
            const validEntries = entries.filter(e => e.title && e.title.trim() !== '');
            if (validEntries.length > 0) {
                hasContentInSection = true;
                sectionHTML += '<div class="space-y-3">';
                validEntries.forEach(entry => {
                    let contentHTML = '';
                    for (const [label, value] of Object.entries(entry.content)) { if (value && value.toString().trim() !== '') { contentHTML += `<div class="mb-2"><p class="font-semibold text-slate-700">${label} :</p><div class="whitespace-pre-wrap text-slate-600">${value}</div></div>`; } }
                    if (contentHTML) {
                        sectionHTML += `
                            <details class="bg-slate-50 rounded-lg border border-slate-200">
                                <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                                    <span>${entry.title}</span>
                                    <button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer cette entr√©e" data-step-key="${stepKey}" data-fields-to-delete='${JSON.stringify(entry.fieldsToDelete)}'>üóëÔ∏è</button>
                                </summary>
                                <div class="p-3 border-t border-slate-200">${contentHTML}</div>
                            </details>`;
                    }
                });
                sectionHTML += '</div>';
            }
        }
        else if (stepKey === 'radar_history') {
            if (stepData && Array.isArray(stepData) && stepData.length > 0) {
                hasContentInSection = true;
                sectionHTML += '<div class="space-y-3">';
                stepData.forEach((item, index) => {
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                                <span>${item.type} : ${item.sujet}</span>
                                <button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer cette entr√©e" data-step-key="radar_history" data-entry-index="${index}">üóëÔ∏è</button>
                            </summary>
                            <div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${item.reponse}</p></div>
                        </details>`;
                });
                sectionHTML += '</div>';
            }
        }
        // --- CAS SP√âCIAUX (Radar, Portfolio, Sp√©cialit√©s) ---
        else if (stepKey === 'radar_history') {
            if (Array.isArray(stepData) && stepData.length > 0) {
                hasContentInSection = true;
                sectionHTML += '<div class="space-y-3">';
                stepData.forEach(item => {
                    sectionHTML += `<details class="bg-slate-50 rounded-lg border border-slate-200"><summary class="p-3 font-semibold text-slate-700 cursor-pointer">${item.type} : ${item.sujet}</summary><div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${item.reponse}</p></div></details>`;
                });
                sectionHTML += '</div>';
            }

            } else if (stepKey === 'step8') { // --- NOUVEAU BLOC POUR L'√âTAPE 8 ---
            if (stepData) {
                sectionHTML += '<div class="space-y-3">';
                let hasSubContent = false;

                // 1. Sous-menu pour la liste des contacts
                if (stepData.contacts && Array.isArray(stepData.contacts) && stepData.contacts.length > 0) {
                    hasSubContent = true;
                    let contactsContent = '<ul class="list-disc list-inside text-slate-600">';
                    stepData.contacts.forEach(contact => {
                        contactsContent += `<li>${contact.nom} ${contact.search_link ? `<a href="${contact.search_link}" target="_blank" class="text-cyan-600 hover:underline text-xs">(voir sur Google ‚Üó)</a>` : ''}</li>`;
                    });
                    contactsContent += '</ul>';
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Ma Liste de Contacts</summary>
                            <div class="p-3 border-t border-slate-200">${contactsContent}</div>
                        </details>`;
                }

                // 2. Sous-menu pour la strat√©gie de contact
                if (stepData.pro_strategie && stepData.pro_strategie.trim() !== '') {
                    hasSubContent = true;
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Ma Pr√©paration de Prise de Contact</summary>
                            <div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${stepData.pro_strategie}</p></div>
                        </details>`;
                }

                sectionHTML += '</div>';
                if (hasSubContent) {
                    hasContentInSection = true;
                }
            }

        } else if (stepKey === 'step10') {
                sectionHTML += '<div class="space-y-3">';
                let hasSubContent = false;

                // 1. Sous-menu pour les Exp√©riences Significatives
                if (stepData.experiences && Array.isArray(stepData.experiences) && stepData.experiences.length > 0) {
                    hasSubContent = true;
                    let experiencesContent = '<div class="space-y-2">';
                    stepData.experiences.forEach((exp, index) => {
                        experiencesContent += `<div class="p-3 bg-white rounded-lg"><p class="font-medium text-slate-800">Exp√©rience #${index + 1}</p><p class="whitespace-pre-wrap text-slate-600">${exp.analysis}</p></div>`;
                    });
                    experiencesContent += '</div>';
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Mes Exp√©riences Significatives</summary>
                            <div class="p-3 border-t border-slate-200">${experiencesContent}</div>
                        </details>`;
                }

                // 2. Sous-menu pour le Profil de Comp√©tences
                if (stepData.soft_skills_profile) {
                    hasSubContent = true;
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Mon Profil de Comp√©tences Transversales</summary>
                            <div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${stepData.soft_skills_profile}</p></div>
                        </details>`;
                }

                // 3. Sous-menu pour le Connecteur de Comp√©tences
                if (stepData.skills_synthesis) {
                    hasSubContent = true;
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Synth√®se du Connecteur de Comp√©tences</summary>
                            <div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${stepData.skills_synthesis}</p></div>
                        </details>`;
                }

                sectionHTML += '</div>';
                if (hasSubContent) {
                    hasContentInSection = true;
                }
            }

             else if (stepKey === 'step2') {
            const renderedContent = renderStep2InJournal(stepData);
            if (renderedContent) {
                hasContentInSection = true;
                sectionHTML = renderedContent;
            }
  }
            else if (stepKey === 'step11') {
            if (stepData) {
                let subContentHTML = '<div class="space-y-3">';
                let hasSubContent = false;

                // Rubrique 1 : "Les structures pour t'accompagner"
                if (stepData.structures && Array.isArray(stepData.structures) && stepData.structures.length > 0) {
                    hasSubContent = true;
                    let structuresContent = '<ul class="list-disc list-inside text-slate-600">';
                    stepData.structures.forEach(struct => {
                        const searchQuery = encodeURIComponent(`${struct.nom}, ${struct.adresse}`);
                        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${searchQuery}`;
                        structuresContent += `<li>${struct.nom} - ${struct.adresse} <a href="${mapsUrl}" target="_blank" class="text-cyan-600 hover:underline text-xs">(voir sur Google Maps ‚Üó)</a></li>`;
                    });
                    structuresContent += '</ul>';

                    subContentHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Les structures pour t'accompagner</summary>
                            <div class="p-3 border-t border-slate-200">${structuresContent}</div>
                        </details>`;
                }

                // Rubrique 2 : "Pr√©paration des visites"
                let preparationContent = '';
                if (stepData.jpo_questions && stepData.jpo_questions.trim() !== '') {
                    preparationContent += `<div class="mb-2"><p class="font-semibold text-slate-700">Pr√©paration JPO pour ${stepData.jpo_ecole || 'une √©cole'}:</p><p class="whitespace-pre-wrap text-slate-600">${stepData.jpo_questions}</p></div>`;
                }
                if (stepData.salon_preparation && stepData.salon_preparation.trim() !== '') {
                    preparationContent += `<div><p class="font-semibold text-slate-700">Pr√©paration pour le salon ${stepData.salon_nom || ''}:</p><p class="whitespace-pre-wrap text-slate-600">${stepData.salon_preparation}</p></div>`;
                }

                if (preparationContent !== '') {
                    hasSubContent = true;
                    subContentHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Ma pr√©paration des JPO et Salons</summary>
                            <div class="p-3 border-t border-slate-200">${preparationContent}</div>
                        </details>`;
                }

                subContentHTML += '</div>';
                if (hasSubContent) {
                    hasContentInSection = true;
                    sectionHTML = subContentHTML;
                }
            }
        }
        // --- LOGIQUE PAR D√âFAUT POUR LES AUTRES √âTAPES ---
        else {
            const config = Object.values(stepsConfig).find(c => c.stepKey === stepKey);
            if (config && config.fields) {
                config.fields.forEach(field => {
                    const value = stepData[field.id];
                    if (value && typeof value === 'string' && value.trim() !== '') {
                        hasContentInSection = true;
                        sectionHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">${field.label}</p><p class="whitespace-pre-wrap text-slate-600 bg-slate-50 p-2 rounded">${value}</p></div>`;
                    }
                });
            }
        }
        
        // --- Logique pour cr√©er le bloc pliable (inchang√©e) ---
        if (hasContentInSection || stepKey === 'radar_history') {
            let finalSectionHTML = sectionHTML;
            if (stepKey === 'radar_history' && !hasContentInSection) {
                finalSectionHTML = '<p class="text-slate-500 italic p-2">Vous n\'avez pas encore enregistr√© de r√©sultat du Radar.</p>';
            }
            const sectionContainer = document.createElement('div');
            sectionContainer.className = 'border border-slate-200 rounded-lg overflow-hidden';
            sectionContainer.innerHTML = `
                <div class="journal-section-header flex justify-between items-center bg-slate-50 p-4 cursor-pointer hover:bg-slate-100 transition">
                    <h3 class="text-lg font-bold text-cyan-700">${stepTitles[stepKey]}</h3>
                    <span class="transform transition-transform duration-200 text-cyan-700">‚ñº</span>
                </div>
                <div class="journal-section-content p-4 border-t border-slate-200 hidden">${finalSectionHTML}</div>
            `;
            journalContentDiv.appendChild(sectionContainer);
        }
    }

    if (!hasAnyContent) {
        journalContentDiv.innerHTML = '<p class="text-center text-slate-500">Votre journal est encore vide. Explorez les √©tapes pour le remplir !</p>';
    }
    
    div.appendChild(journalContentDiv);

    // 5. Ajout des √©couteurs d'√©v√©nements
    
    // MODIFICATION : Ajout de l'√©couteur d'√©v√©nement pour l'accord√©on
    journalContentDiv.addEventListener('click', async (e) => {
        const header = e.target.closest('.journal-section-header');
        const deleteBtn = e.target.closest('.delete-journal-entry');

        // G√®re l'ouverture/fermeture de l'accord√©on
        if (header && !deleteBtn) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('span');
            if (content) content.classList.toggle('hidden');
            if (icon) icon.classList.toggle('rotate-180');
            return;
        }

        // G√®re le clic sur un bouton supprimer
        if (deleteBtn) {
            e.stopPropagation(); // Emp√™che l'accord√©on de s'ouvrir/fermer
            
            const confirmed = await showConfirmationModal('Es-tu s√ªr de vouloir supprimer cette entr√©e ? Cette action est irr√©versible.');
            if (!confirmed) return;

            const stepKey = deleteBtn.dataset.stepKey;
            const entryIndex = deleteBtn.dataset.entryIndex;
            const fieldsToDelete = deleteBtn.dataset.fieldsToDelete ? JSON.parse(deleteBtn.dataset.fieldsToDelete) : null;

            if (stepKey === 'radar_history' && entryIndex !== undefined) {
                journalData.radar_history.splice(entryIndex, 1);
            } 
            else if (fieldsToDelete) {
                if (stepKey === 'step6') { // Cas sp√©cial pour les lettres qui sont des objets
                    journalData[stepKey][fieldsToDelete[0]] = {};
                } else {
                    fieldsToDelete.forEach(field => {
                        journalData[stepKey][field] = '';
                    });
                }
            }

            await saveData();
            showView('journal'); // Rafra√Æchit la vue pour montrer les changements
        }
    });

    div.querySelector('#toggle-share-btn').addEventListener('click', async () => {
        if (journalData.share_token) {
            const userConfirmed = await showConfirmationModal("Es-tu s√ªr de vouloir d√©sactiver le partage ? Le lien ne fonctionnera plus.");
            if (userConfirmed) {
                journalData.share_token = null; 
                await saveData(); 
                showView('journal');
            }
        } else {
            journalData.share_token = 'shr_' + Math.random().toString(36).substr(2, 16); 
            await saveData(); 
            showView('journal');
        }
    });

    if (shareToken) {
        div.querySelector('#copy-share-link').addEventListener('click', () => {
            navigator.clipboard.writeText(shareLink).then(() => {
                showSurpriseModal("C'est fait !", '<p>Le lien de partage a √©t√© copi√© dans votre presse-papiers.</p>', 2000); // Dispara√Æt apr√®s 2 secondes
            });
        });
    }

    div.querySelector('#updateFilRougeBtn').addEventListener('click', async () => {
        const loader = div.querySelector('#filRougeLoader');
        const contentP = div.querySelector('#filRougeContent');
        loader.style.display = 'block'; contentP.style.display = 'none';
        const prompt = `En te basant sur l'int√©gralit√© du journal de cet √©l√®ve : ${JSON.stringify(journalData)}, r√©dige une synth√®se de son projet d'orientation en 3 points : 1. Tes Moteurs : Quels sont les grands int√©r√™ts qui ressortent ? 2. Tes Comp√©tences Cl√©s : Quelles sont les aptitudes qui semblent importantes ? 3. Ton Environnement Id√©al : Quel type d'√©tudes semble te correspondre ? 4. Quels m√©tiers :Quels types de m√©tiers tu peux envisager ? Donne un titre √† son projet. Tu dois t'adresser directement √† l'√©l√®ve, en utilisant "tu"`;
        const result = await callGeminiAPI(prompt);
        journalData.fil_rouge = result; await saveData();
        contentP.textContent = result;
        loader.style.display = 'none'; contentP.style.display = 'block';
    });

    return div;
}

async function createPublicShareView(userId, token) {
    const mainApp = document.getElementById('mainApp');
    mainApp.innerHTML = `<div class="loader"></div>`;

    try {
        const userDocRef = doc(db, "users", userId);
        const docSnap = await getDoc(userDocRef);

        if (!docSnap.exists()) {
            throw new Error("Utilisateur non trouv√©.");
        }

        const data = docSnap.data();
        if (!data.journal || data.journal.share_token !== token) {
            throw new Error("Lien de partage invalide ou d√©sactiv√©.");
        }

        const pageContainer = document.createElement('div');
        pageContainer.className = 'bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200';

        const publicJournalData = data.journal;
        const userInfo = {
            firstName: data.firstName || 'L\'√©l√®ve',
            lastName: data.lastName || '',
            schoolName: data.schoolName || 'son lyc√©e',
            gradeLevel: data.gradeLevel || 'sa classe'
        };

        const tempJournalData = journalData;
        journalData = publicJournalData;
        const allStepsForLevel = allSteps.filter(step => step.levels.includes(userInfo.gradeLevel));
        const completedStepsCount = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id) && isStepComplete(step.id)).length;
        const totalTrackableSteps = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id)).length;
        const progressPercentageSteps = totalTrackableSteps > 0 ? (completedStepsCount / totalTrackableSteps) * 100 : 0;
        const progressBarHTML = `
            <div class="max-w-xl mx-auto my-8">
                <div class="flex justify-between mb-1"><span class="text-base font-medium text-cyan-700">Progression des √âtapes</span><span class="text-sm font-medium text-cyan-700">${Math.round(progressPercentageSteps)}%</span></div>
                <div class="w-full bg-slate-200 rounded-full h-2.5"><div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progressPercentageSteps}%"></div></div>
            </div>`;
        journalData = tempJournalData;

        let finalHTML = `
            <h1 class="text-2xl font-bold text-cyan-700 mb-2">Journal de Bord de ${userInfo.firstName}</h1>
            <p class="text-slate-500 mb-8 text-center">√âl√®ve en ${userInfo.gradeLevel} √† ${userInfo.schoolName}.</p>
            ${progressBarHTML}`;

        if (publicJournalData.earned_badges && publicJournalData.earned_badges.length > 0) {
            const tempJournalData = journalData;
            journalData = publicJournalData;
            finalHTML += createBadgesDisplay('journal');
            journalData = tempJournalData;
        }

        finalHTML += createOrientationMapView(publicJournalData, 'public');

        if (publicJournalData.fil_rouge) {
            finalHTML += `<div class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg"><h2 class="text-xl font-bold text-cyan-800 mb-4">‚ú® Son Fil Rouge</h2><p class="text-slate-700 whitespace-pre-wrap">${publicJournalData.fil_rouge}</p></div>`;
        }
        
        pageContainer.innerHTML = finalHTML;

        const journalContentDiv = document.createElement('div');
        journalContentDiv.id = 'journalContent';
        journalContentDiv.className = 'mt-8 space-y-4';
        
        if (publicJournalData.step0 && publicJournalData.step0.analysis) {
            const infographicElement = createProfileInfographic(publicJournalData.step0, 'public');
            journalContentDiv.appendChild(infographicElement);
        }

        // --- BOUCLE COMPL√àTE ET CORRIG√âE ---
        const stepTitles = {
        step10: 'üíº Mon Portfolio de Comp√©tences',
        step2: 'üß≠ Mes simulations de sp√©cialit√©s',
        step1: 'üìö Mes Fondations',
        step3: 'üéì Mon Catalogue',
        step8: 'üöÄ Mes passages √† l\'action',
        radar_history: 'üì° Mon Radar √† Opportunit√©s',
        chatbot_saves: 'üí¨ Mes Discussions avec le Coach',
        step4: 'üí¨ L\'exp√©rience',
        step11: 'üåç Mes rencontres sur le territoire',
        step6: '‚úçÔ∏è Mes pr√©parations de candidatures',
        step9: 'üîÆ Mon anticipation de la suite',
        step12: 'üí∂ Mes simulations de vie √©tudiante',
        step5: 'üì∞ Mon Actu',
        step7: '‚úÖ Mes Scores (Fact Checking)',
    };

        
        for (const stepKey in stepTitles) {
            const stepData = publicJournalData[stepKey];
            let sectionHTML = '';
            let hasContentInSection = false;

         if (stepKey === 'chatbot_saves') {
            if (Array.isArray(stepData) && stepData.length > 0) {
                hasContentInSection = true;
                sectionHTML += '<div class="space-y-3">';
                stepData.forEach(item => {
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Question : "${item.question}"</summary>
                            <div class="p-3 border-t border-slate-200">
                                <p class="whitespace-pre-wrap text-slate-600">${linkify(item.reponse)}</p>
                            </div>
                        </details>
                    `;
                });
                sectionHTML += '</div>';
            }
        } 
            if (stepKey === 'radar_history') {
                if (stepData && Array.isArray(stepData) && stepData.length > 0) {
                    hasContentInSection = true;
                    sectionHTML += '<div class="space-y-3">';
                    stepData.forEach(item => { sectionHTML += `<details class="bg-slate-50 rounded-lg border border-slate-200"><summary class="p-3 font-semibold text-slate-700 cursor-pointer">${item.type} : ${item.sujet}</summary><div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${item.reponse}</p></div></details>`; });
                    sectionHTML += '</div>';
                }
            } else if (['step1', 'step3', 'step4', 'step5', 'step6', 'step9'].includes(stepKey)) {
                let entries = [];
                if(stepData) {
                    if (stepKey === 'step1') { for (let i = 1; i <= 3; i++) if (stepData[`metier${i}`]) entries.push({ title: stepData[`metier${i}`], content: { 'Notes': stepData[`notes${i}`], 'Analyse IA': stepData[`analysisText${i}`] } }); }
                    if (stepKey === 'step3') { for (let i = 1; i <= 2; i++) if (stepData[`formation${i}`]) entries.push({ title: stepData[`formation${i}`], content: { 'Attendus': stepData[`attendus${i}`], 'Rapport de compatibilit√©': stepData[`compatibilite${i}`], 'Mots-cl√©s': stepData[`mots_cles${i}`], 'Analyse des mots-cl√©s': stepData[`analyse_mots_cles${i}`] } }); }
                    if (stepKey === 'step4') { for (let i = 1; i <= 2; i++) if (stepData[`theme${i}`]) entries.push({ title: stepData[`theme${i}`], content: { 'Ma question': stepData[`question${i}`], 'Suggestions IA': stepData[`suggestions${i}`] } }); }
                    if (stepKey === 'step5') { for (let i = 1; i <= 3; i++) if (stepData[`article${i}`]) entries.push({ title: stepData[`article${i}`], content: { 'Ce que j\'ai appris': stepData[`apprentissage${i}`] } }); }
                    if (stepKey === 'step6') { for (let i = 1; i <= 2; i++) if (stepData[`lettre${i}`]?.formation) entries.push({ title: stepData[`lettre${i}`].formation, content: { 'Motivations': stepData[`lettre${i}`].motivations, 'Structure propos√©e': stepData[`lettre${i}`].structure } }); }
                    if (stepKey === 'step9') {
                        if (stepData.formation_reve) entries.push({ title: 'Simulation : Mon Plan B', content: { 'Formation "r√™v√©e"': stepData.formation_reve, 'Historique de la conversation': (stepData.planb_chat_history || []).map(msg => `<strong>${msg.role === 'user' ? 'L\'√©l√®ve' : 'Coach'} :</strong> ${msg.text}`).join('<br>') } });
                        if (stepData.reussite_type) entries.push({ title: 'Coach de R√©ussite', content: { 'Formation': stepData.reussite_type, 'Conseils': stepData.reussite_conseils } });
                    }
                }
                const validEntries = entries.filter(e => e.title && e.title.trim() !== '');
                if (validEntries.length > 0) {
                    hasContentInSection = true;
                    sectionHTML += '<div class="space-y-3">';
                    validEntries.forEach(entry => {
                        let contentHTML = '';
                        for (const [label, value] of Object.entries(entry.content)) { if (value && value.toString().trim() !== '') { contentHTML += `<div class="mb-2"><p class="font-semibold text-slate-700">${label} :</p><div class="whitespace-pre-wrap text-slate-600">${value}</div></div>`; } }
                        if (contentHTML) { sectionHTML += `<details class="bg-slate-50 rounded-lg border border-slate-200"><summary class="p-3 font-semibold text-slate-700 cursor-pointer">${entry.title}</summary><div class="p-3 border-t border-slate-200">${contentHTML}</div></details>`; }
                    });
                    sectionHTML += '</div>';
                }

                } else if (stepKey === 'step8') { // --- NOUVEAU BLOC POUR L'√âTAPE 8 ---
            if (stepData) {
                sectionHTML += '<div class="space-y-3">';
                let hasSubContent = false;

                // 1. Sous-menu pour la liste des contacts
                if (stepData.contacts && Array.isArray(stepData.contacts) && stepData.contacts.length > 0) {
                    hasSubContent = true;
                    let contactsContent = '<ul class="list-disc list-inside text-slate-600">';
                    stepData.contacts.forEach(contact => {
                        contactsContent += `<li>${contact.nom} ${contact.search_link ? `<a href="${contact.search_link}" target="_blank" class="text-cyan-600 hover:underline text-xs">(voir sur Google ‚Üó)</a>` : ''}</li>`;
                    });
                    contactsContent += '</ul>';
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Ma Liste de Contacts</summary>
                            <div class="p-3 border-t border-slate-200">${contactsContent}</div>
                        </details>`;
                }

                // 2. Sous-menu pour la strat√©gie de contact
                if (stepData.pro_strategie && stepData.pro_strategie.trim() !== '') {
                    hasSubContent = true;
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Ma Pr√©paration de Prise de Contact</summary>
                            <div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${stepData.pro_strategie}</p></div>
                        </details>`;
                }

                sectionHTML += '</div>';
                if (hasSubContent) {
                    hasContentInSection = true;
                }
            }
            
            } else if (stepKey === 'step10') {
                sectionHTML += '<div class="space-y-3">';
                let hasSubContent = false;

                // 1. Sous-menu pour les Exp√©riences Significatives
                if (stepData.experiences && Array.isArray(stepData.experiences) && stepData.experiences.length > 0) {
                    hasSubContent = true;
                    let experiencesContent = '<div class="space-y-2">';
                    stepData.experiences.forEach((exp, index) => {
                        experiencesContent += `<div class="p-3 bg-white rounded-lg"><p class="font-medium text-slate-800">Exp√©rience #${index + 1}</p><p class="whitespace-pre-wrap text-slate-600">${exp.analysis}</p></div>`;
                    });
                    experiencesContent += '</div>';
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Mes Exp√©riences Significatives</summary>
                            <div class="p-3 border-t border-slate-200">${experiencesContent}</div>
                        </details>`;
                }

                // 2. Sous-menu pour le Profil de Comp√©tences
                if (stepData.soft_skills_profile) {
                    hasSubContent = true;
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Mon Profil de Comp√©tences Transversales</summary>
                            <div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${stepData.soft_skills_profile}</p></div>
                        </details>`;
                }

                // 3. Sous-menu pour le Connecteur de Comp√©tences
                if (stepData.skills_synthesis) {
                    hasSubContent = true;
                    sectionHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Synth√®se du Connecteur de Comp√©tences</summary>
                            <div class="p-3 border-t border-slate-200"><p class="whitespace-pre-wrap text-slate-600">${stepData.skills_synthesis}</p></div>
                        </details>`;
                }

                sectionHTML += '</div>';
                if (hasSubContent) {
                    hasContentInSection = true;
                }
                

            } else if (stepKey === 'step2') {
                const renderedContent = renderStep2InJournal(stepData);
                if (renderedContent) { hasContentInSection = true; sectionHTML = renderedContent; }

            } else if (stepKey === 'step11') {
                if (stepData) {
                    let subContentHTML = '<div class="space-y-3">';
                    let hasSubContent = false;

                // Rubrique 1 : "Les structures pour t'accompagner"
                if (stepData.structures && Array.isArray(stepData.structures) && stepData.structures.length > 0) {
                    hasSubContent = true;
                    let structuresContent = '<ul class="list-disc list-inside text-slate-600">';
                    stepData.structures.forEach(struct => {
                        const searchQuery = encodeURIComponent(`${struct.nom}, ${struct.adresse}`);
                        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${searchQuery}`;
                        structuresContent += `<li>${struct.nom} - ${struct.adresse} <a href="${mapsUrl}" target="_blank" class="text-cyan-600 hover:underline text-xs">(voir sur Google Maps ‚Üó)</a></li>`;
                    });
                    structuresContent += '</ul>';

                    subContentHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Les structures pour t'accompagner</summary>
                            <div class="p-3 border-t border-slate-200">${structuresContent}</div>
                        </details>`;
                }

                // Rubrique 2 : "Pr√©paration des visites"
                let preparationContent = '';
                if (stepData.jpo_questions && stepData.jpo_questions.trim() !== '') {
                    preparationContent += `<div class="mb-2"><p class="font-semibold text-slate-700">Pr√©paration JPO pour ${stepData.jpo_ecole || 'une √©cole'}:</p><p class="whitespace-pre-wrap text-slate-600">${stepData.jpo_questions}</p></div>`;
                }
                if (stepData.salon_preparation && stepData.salon_preparation.trim() !== '') {
                    preparationContent += `<div><p class="font-semibold text-slate-700">Pr√©paration pour le salon ${stepData.salon_nom || ''}:</p><p class="whitespace-pre-wrap text-slate-600">${stepData.salon_preparation}</p></div>`;
                }

                if (preparationContent !== '') {
                    hasSubContent = true;
                    subContentHTML += `
                        <details class="bg-slate-50 rounded-lg border border-slate-200">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer">Ma pr√©paration des JPO et Salons</summary>
                            <div class="p-3 border-t border-slate-200">${preparationContent}</div>
                        </details>`;
                }

                subContentHTML += '</div>';
                if (hasSubContent) {
                    hasContentInSection = true;
                    sectionHTML = subContentHTML;
                }
            }
    
            } else {
                if (stepData) {
                    const config = Object.values(stepsConfig).find(c => c.stepKey === stepKey);
                    if (config && config.fields) { config.fields.forEach(field => { const value = stepData[field.id]; if (value && typeof value === 'string' && value.trim() !== '') { hasContentInSection = true; sectionHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">${field.label}</p><p class="whitespace-pre-wrap text-slate-600 bg-slate-50 p-2 rounded">${value}</p></div>`; } }); }
                }
            }
            
            if (hasContentInSection || stepKey === 'radar_history') {
                let finalSectionHTML = sectionHTML;
                if (stepKey === 'radar_history' && !hasContentInSection) { finalSectionHTML = '<p class="text-slate-500 italic p-2">L\'√©l√®ve n\'a pas encore enregistr√© de r√©sultat du Radar.</p>'; }
                const sectionContainer = document.createElement('div');
                sectionContainer.className = 'border border-slate-200 rounded-lg overflow-hidden';
                sectionContainer.innerHTML = `
                    <div class="journal-section-header flex justify-between items-center bg-slate-50 p-4 cursor-pointer hover:bg-slate-100 transition">
                        <h3 class="text-lg font-bold text-cyan-700">${stepTitles[stepKey]}</h3>
                        <span class="transform transition-transform duration-200 text-cyan-700">‚ñº</span>
                    </div>
                    <div class="journal-section-content p-4 border-t border-slate-200 hidden">${finalSectionHTML}</div>`;
                journalContentDiv.appendChild(sectionContainer);
            }
        }
        
        pageContainer.appendChild(journalContentDiv);

        const discussionSection = document.createElement('div');
        discussionSection.innerHTML = `
            <div class="mt-8 border-t pt-6 text-center">
                <button id="publicShareBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">ü§ù Pr√©parer une discussion</button>
            </div>
            <div id="publicGeminiShareLoader" class="hidden"><div class="loader"></div></div>
            <div id="publicGeminiShareResult" class="mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>`;
        pageContainer.appendChild(discussionSection);

        mainApp.innerHTML = '';
        mainApp.appendChild(pageContainer);

        pageContainer.querySelector('#journalContent').addEventListener('click', (e) => {
            const header = e.target.closest('.journal-section-header');
            if (!header) return;
            const content = header.nextElementSibling;
            const icon = header.querySelector('span');
            if (content) content.classList.toggle('hidden');
            if (icon) icon.classList.toggle('rotate-180');
        });
        pageContainer.querySelector('#publicShareBtn').addEventListener('click', async () => {
            const loader = pageContainer.querySelector('#publicGeminiShareLoader');
            const resultDiv = pageContainer.querySelector('#publicGeminiShareResult');
            loader.style.display = 'block'; resultDiv.textContent = '';
            const prompt = `Agis comme un coach d'orientation et m√©diateur familial expert. Analyse le journal de bord de cet √©l√®ve : ${JSON.stringify(publicJournalData)}. Ta mission est de g√©n√©rer 5 "points de dialogue" pour aider les parents ou professeurs √† avoir une discussion constructive. Pour chaque point, fournis : 1. Une question ouverte et bienveillante. 2. Une suggestion d'action concr√®te.`;
            const result = await callGeminiAPI(prompt);
            loader.style.display = 'none';
            resultDiv.textContent = result;
        });

    } catch (error) {
        mainApp.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md"><h2 class="text-xl font-bold text-red-600">Erreur</h2><p class="text-slate-600 mt-2">${error.message}</p></div>`;
    }
}


function isStepComplete(stepKey) {
    const config = Object.values(stepsConfig).find(s => s.stepKey === stepKey);
    const data = journalData[stepKey];
    if (!config || !data) return false;
    
    // Cas sp√©cial pour l'√©tape "Mieux se conna√Ætre"
    if(stepKey === 'step0') {
        const hasMainAnalysis = data.analysis && data.analysis.trim() !== '';
        const hasCrossAnalysis = data.analyse_tests_croisee && data.analyse_tests_croisee.trim() !== '';
        return hasMainAnalysis && hasCrossAnalysis;
    }
    if (stepKey === 'step9') {
        // L'√©tape est compl√®te si une simulation a √©t√© men√©e (au moins 4 √©changes)
        // ET si les conseils de r√©ussite ont √©t√© g√©n√©r√©s.
        const hasPlanB = data.planb_chat_history && data.planb_chat_history.length >= 4;
        const hasReussite = data.reussite_conseils && data.reussite_conseils.trim() !== '';
        return hasPlanB && hasReussite;
    }
    // Cas sp√©cial pour l'√©tape "Portfolio de Comp√©tences"
    if (stepKey === 'step10') {
        const hasExperience = data.experiences && Array.isArray(data.experiences) && data.experiences.length > 0;
        const hasProfile = data.soft_skills_profile && data.soft_skills_profile.trim() !== '';
        // L'√©tape est consid√©r√©e comme compl√®te si l'une des deux parties est remplie
        return hasExperience || hasProfile;
    }
    if(stepKey === 'step11') {
        const hasLocation = data.location && data.location.trim() !== '';
        const hasResults = (data.evenements && data.evenements.length > 0) || (data.structures && data.structures.length > 0);
        // MODIFICATION : On v√©rifie aussi si une pr√©paration a √©t√© faite
        const hasJpoPrep = data.jpo_questions && data.jpo_questions.trim() !== '';
        const hasSalonPrep = data.salon_preparation && data.salon_preparation.trim() !== '';
        return hasLocation && hasResults && (hasJpoPrep || hasSalonPrep);
    }
    // Logique g√©n√©rale pour les autres √©tapes bas√©es sur des champs de formulaire
    if (!config.fields || config.fields.length === 0) return false;

    const userFields = config.fields.filter(f => !f.isReadonly);
    if (userFields.length === 0) return false;

    return userFields.every(field => data[field.id] && data[field.id].toString().trim() !== '');
}

        function checkBadges() {
            if (!journalData.earned_badges) {
                journalData.earned_badges = [];
            }
            for (const badgeKey in badgesConfig) {
                if (!journalData.earned_badges.includes(badgeKey)) {
                    if (badgesConfig[badgeKey].criteria(userGradeLevel)) {
                        journalData.earned_badges.push(badgeKey);
                    }
                }
            }
        }

        function createBadgesDisplay(context = 'menu') {
    const earnedBadges = journalData.earned_badges || [];
    let badgesHTML = Object.keys(badgesConfig).map(key => {
        const badge = badgesConfig[key];
        const earned = earnedBadges.includes(key);
        return `
            <div class="text-center">
                <div class="badge ${earned ? 'earned' : ''}" title="${badge.description}">
                    <span class="text-3xl">${badge.icon}</span>
                    <p class="text-sm font-semibold mt-1 ${earned ? 'text-slate-800' : 'text-slate-400'}">${badge.title}</p>
                </div>
            </div>
        `;
    }).join('');
    
    // DIMINUTION DES PADDINGS (p-4 au lieu de p-6)
    const wrapperClass = context === 'journal' ? 'mb-8' : 'mb-8 bg-white p-4 rounded-2xl shadow-md border border-slate-200';

    return `
        <div id="badgesContainer" class="${wrapperClass}">
            <h2 class="text-lg font-bold text-slate-800 text-center mb-2">Mes Badges</h2>
            <div class="grid grid-cols-3 gap-2">
                ${badgesHTML}
            </div>
        </div>
    `;
}


        // --- Chatbot Logic ---
        // --- Chatbot Logic ---
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatMessages = document.getElementById('chat-messages');
        
        let chatbotHistory = []; // On ajoute une m√©moire pour la conversation

        // 1. Message d'accueil personnalis√©
        chatbotToggle.addEventListener('click', () => {
            chatbotContainer.classList.toggle('hidden');

            const now = new Date().getTime();
            const lastInteraction = journalData.chatbot_last_interaction || 0;
            const minutesSinceLastInteraction = (now - lastInteraction) / (1000 * 60);

            // Si plus de 30 minutes se sont √©coul√©es, on r√©initialise
            if (minutesSinceLastInteraction > 30) {
                chatbotHistory = [];
                chatMessages.innerHTML = ''; // On vide aussi l'affichage
            }

            // On affiche le message d'accueil personnalis√© si la conversation est vide
            if (chatbotContainer.classList.contains('hidden') === false && chatbotHistory.length === 0) {
                const welcomeText = `Salut ${currentUserInfo.firstName} ! Je suis ton coach personnel. Comment puis-je t'aider aujourd'hui ?`;
                addMessage(welcomeText, 'ai');
            }
        });

        chatbotClose.addEventListener('click', () => {
            chatbotContainer.classList.add('hidden');
        });

        // 2. Logique de conversation (qui g√®re l'historique)
        const createChatbotPrompt = (userInput, history) => {
            const userInfo = currentUserInfo;
            const userJournal = journalData;
            const appStepsList = allSteps.map(s => `- '${s.icon} ${s.title}'`).join('\n');
            const today = new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const currentSchoolYearStart = getCurrentSchoolYear();
            const schoolYearString = `${currentSchoolYearStart}-${currentSchoolYearStart + 1}`;

            // --- NOUVEAU : On g√©n√®re le r√©sum√© de la progression ---
            const completionSummary = getCompletionSummary();

            const historyText = history.map(msg => {
                return `${msg.role === 'user' ? '[PR√âNOM]' : 'Toi'}: ${msg.parts[0].text}`;
            }).join('\n');

            return `
# R√¥le et Persona (Ta seule identit√©)
Tu es le "Copilote", l'IA conversationnelle de l'application "Mon Explor'Orientation". Ton unique but est d'aider [PR√âNOM] √† utiliser l'application pour construire son projet. Pense √† toi comme un mentor jeune, dynamique et super sympa.

# Ton Style (TA PRIORIT√â ABSOLUE)
- **Ton :** Parle comme un jeune adulte, pas comme un prof. Utilise "tu", sois direct, chaleureux et encourageant.
- **Emojis :** Utilise beaucoup d'emojis pour rendre tes messages funs et visuels. C'est essentiel ! üëçüöÄüí°üòâü§î
- **Proactivit√© :** Propose TOUJOURS une action suivante, de pr√©f√©rence en sugg√©rant une √©tape pertinente de l'application.
- **Varie tes intros !** Ne commence pas toujours tes r√©ponses par "Hey [PR√âNOM] ! Alors...". Sois plus cr√©atif. Exemples d'intros alternatives : "Bonne question, [PR√âNOM] ! Parlons de √ßa.", "Ah, [le sujet] ! C'est un sujet super int√©ressant. Voyons voir...", "Ok, c'est parti ! Pour [le sujet]..."


# Contexte Essentiel
Tu dois te baser sur TOUT ce contexte pour chaque r√©ponse.

**1. L'√©l√®ve que tu aides :**
- Pr√©nom : [PR√âNOM]
- Genre : [GENRE]
- Classe : [CLASSE]
- Ann√©e Scolaire en cours ("cette ann√©e") : ${schoolYearString}
- Son Journal de Bord (contient ses r√©ponses et son profil) : [JOURNAL_DATA]

**2. L'application que vous utilisez ensemble :**
- Outils disponibles : [LISTE_ETAPES]
- **R√©sum√© de sa progression :** ${completionSummary}

**3. L'historique de votre conversation :**
[HISTORIQUE_CONVERSATION]

# Ta Mission et tes R√®gles
En respectant IMP√âRATIVEMENT ton style, r√©ponds √† la derni√®re question de [PR√âNOM]. Voici comment tu dois raisonner :

1.  **R√®gle de pertinence :** Analyse le r√©sum√© de sa progression. **Ne lui sugg√®re JAMAIS une √©tape qu'il a d√©j√† termin√©e.** S'il a commenc√© une √©tape, encourage-le √† la finir plut√¥t que d'en commencer une nouvelle.
2.  **Priorit√© 1 : Guide dans l'appli.** Si sa question peut √™tre r√©solue avec un outil de l'app, guide-le vers l'outil le plus pertinent (et non termin√© !).
3.  **Priorit√© 2 : Analyse son profil.** Si sa question est personnelle, utilise son Journal de Bord pour donner une r√©ponse personnalis√©e.
4.  **Priorit√© 3 : Expert Externe.** Si, et SEULEMENT si, sa question est tr√®s factuelle et externe, alors tu peux utiliser tes connaissances en priorisant les sites onisep.fr et surtout parcoursup.fr. Cite toujours tes sources.
5.  **R√®gle de conversation :** Si la conversation a d√©j√† commenc√© (si l'historique n'est pas vide), ne dis plus jamais "Salut [PR√âNOM]". R√©ponds directement.

---
Derni√®re question de [PR√âNOM] : "${userInput}"
`
            .replace(/\[PR√âNOM\]/g, userInfo.firstName)
            .replace('[GENRE]', userInfo.gender || 'autre')
            .replace('[CLASSE]', userGradeLevel)
            .replace('[JOURNAL_DATA]', JSON.stringify(userJournal))
            .replace('[LISTE_ETAPES]', appStepsList)
            .replace('[HISTORIQUE_CONVERSATION]', historyText);
        };
        
        chatbotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatbotInput.value.trim();
            if (!userInput) return;

            addMessage(userInput, 'user');
            chatbotInput.value = '';
            
            const loaderDiv = addMessage('', 'loader', false);
            const prompt = createChatbotPrompt(userInput, chatbotHistory);
            const aiResponse = await callGeminiAPI(prompt, true);
            loaderDiv.remove();
            
            // On r√©cup√®re le conteneur du message de l'IA qu'on vient de cr√©er
            const aiMessageWrapper = addMessage(aiResponse, 'ai');
            const saveBtn = aiMessageWrapper.querySelector('.save-chat-btn');

            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    if (!Array.isArray(journalData.chatbot_saves)) {
                        journalData.chatbot_saves = [];
                    }
                    // On sauvegarde la question de l'√©l√®ve ET la r√©ponse de l'IA
                    journalData.chatbot_saves.push({
                        question: userInput,
                        reponse: aiResponse
                    });
                    await saveData();
                    
                    // Feedback visuel
                    saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                    saveBtn.disabled = true;
                    saveBtn.title = "Enregistr√© !";
                });
            }
        });

        function addMessage(text, sender, addToHistory = true) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex mb-4 group'; // On ajoute la classe "group" pour le survol
            
            if (addToHistory) {
                chatbotHistory.push({ role: sender === 'user' ? 'user' : 'model', parts: [{ text }] });
                journalData.chatbot_last_interaction = new Date().getTime(); 
            }

            let messageContent;
            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageContent = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs"><p>${text}</p></div>`;
            } else if (sender === 'ai') {
                 // On ajoute un conteneur flex pour le message et le bouton
                 messageWrapper.classList.add('items-end', 'gap-2');
                 messageContent = `
                    <div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs">
                        <p>${linkify(text)}</p>
                    </div>
                    <button class="save-chat-btn opacity-0 group-hover:opacity-100 transition text-slate-400 hover:text-cyan-600 p-1" title="Enregistrer dans le journal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12l-5-3-5 3V4z" /></svg>
                    </button>
                 `;
            } else if (sender === 'loader') {
                 messageContent = `<div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg"><div class="chatbot-loader"></div></div>`;
            }

            messageWrapper.innerHTML = messageContent;
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageWrapper;
        }

        // Le reste de votre code reste inchang√©...

        window.showView = showView;

        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('SW registered: ', registration);
            }).catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
        });
    }

    // ========================================================
// AJOUTEZ CE BLOC POUR LA NAVIGATION PAR GESTES
// ========================================================
let touchStartX = 0;
let touchStartY = 0;

mainApp.addEventListener('touchstart', (e) => {
    // On enregistre la position de d√©part du doigt
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

mainApp.addEventListener('touchend', (e) => {
    // On ne fait rien si le bouton retour n'est pas visible
    // (cela emp√™che le geste de fonctionner sur le menu principal)
    if (!floatingBackBtn || floatingBackBtn.style.display === 'none') {
        return;
    }

    // On r√©cup√®re la position de fin
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;

    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;

    // On v√©rifie si le geste est un balayage vers la droite
    // et pas un simple d√©filement vertical.
    if (deltaX > 75 && Math.abs(deltaY) < 75) {
        showView('menu');
    }
}, { passive: true });

// ========================================================
// AJOUTEZ CE BLOC POUR LA FEN√äTRE DE S√âLECTION DU GUIDE
// ========================================================
let guideUserRole = 'eleve'; // R√¥le par d√©faut

const guideRoleModal = document.getElementById('guideRoleModal');
const closeRoleModalBtn = document.getElementById('closeRoleModalBtn');
const roleEleveBtn = document.getElementById('roleEleveBtn');
const roleParentBtn = document.getElementById('roleParentBtn');
const roleEnseignantBtn = document.getElementById('roleEnseignantBtn');

// Fonction qui ouvre le guide apr√®s avoir choisi un r√¥le
const openGuide = (role) => {
    guideUserRole = role; // On sauvegarde le r√¥le
    guideRoleModal.style.display = 'none'; // On cache la fen√™tre
    window.showGuideFromLogin(); // On affiche le guide
};

// Attache les √©v√©nements aux boutons
closeRoleModalBtn.addEventListener('click', () => {
    guideRoleModal.style.display = 'none';
});

roleEleveBtn.addEventListener('click', () => openGuide('eleve'));
roleParentBtn.addEventListener('click', () => openGuide('parent'));
roleEnseignantBtn.addEventListener('click', () => openGuide('enseignant'));

    </script>
</body>
</html>
