<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrIAntation</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo_180.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'OrIAntation-darkblue': '#1A3263',
                    'OrIAntation-orange': '#FF8C00',
                    'OrIAntation-lightblue': '#3366CC',
                    'OrIAntation-green': '#66BB6A',
                    'OrIAntation-yellow': '#FFD700',
                    'primary-action': '#2C7A7B', // Votre cyan/turquoise pour les boutons
                    'secondary-accent': '#E05260', // Pour des éléments secondaires si besoin
                    'text-body': '#333333', // Texte général
                    'background-light': '#F8FAFC', // Votre blanc cassé
                    'border-subtle': '#E2E8F0', // Bordures
                },
                fontFamily: {
                    sans: ['Poppins', 'sans-serif'], // Définit Poppins comme police par défaut
                }
            }
        }
    }
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            text-align: justify;
        }
        .step-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #footer-privacy-link {
            display: none; /* Caché par défaut */
        }
        body.logged-in #footer-privacy-link {
            display: block; /* Visible si l'utilisateur est connecté */
        }

        #mainApp { display: none; }

        .fiche-content {
         overflow-wrap: break-word;
         word-wrap: break-word;
         }

         .fiche-colonne-contenu {
    /* Astuce CSS pour corriger les bugs de dépassement dans une grille */
    min-width: 0; 
         }
        

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0891b2; 
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .chatbot-loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #0891b2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse-glow {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(8, 145, 178, 0.7); /* cyan-600 avec opacité */
  }
  50% {
    box-shadow: 0 0 10px 5px rgba(8, 145, 178, 0);
  }
}
.next-mission-highlight {
  animation: pulse-glow 2s infinite;
  border-color: #0891b2; /* cyan-600 */
  border-width: 2px;
}

        /* Chatbot styles */
        #chatbot-toggle {
            transition: transform 0.2s ease-in-out;
      
        }
        #chatbot-toggle.chat-open:hover {
            transform: none; /* Désactive le zoom quand le chat est ouvert */
        }
        #chatbot-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .chat-message-container {
            scroll-behavior: smooth;
        }
        .badge {
            filter: grayscale(1);
            opacity: 0.5;
        }
        .badge.earned {
            filter: grayscale(0);
            opacity: 1;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
        .simulation-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .simulation-message-container {
            scroll-behavior: smooth;
        }

        .portfolio-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }

        h1, h2, h3, h4 {
            text-align: center;
        }

       #floatingBackBtn {
    position: fixed;
    bottom: 24px;
    left: 24px;
    width: 56px;
    height: 56px;
    background-color: #0891b2; /* cyan-600 -- COULEUR MODIFIÉE ICI */
    color: white;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    cursor: pointer;
    z-index: 30;
    transition: transform 0.2s ease-in-out, opacity 0.3s ease-in-out;
}

#floatingBackBtn:hover {
    transform: scale(1.1);
}

/* AJOUTEZ CE BLOC À L'INTÉRIEUR DE VOTRE BALISE <style> */

/* Conteneur pour le tableau de comparaison pour permettre le défilement */
.comparison-table-wrapper {
    overflow-x: auto; /* Permet le défilement horizontal si le contenu dépasse */
    -webkit-overflow-scrolling: touch; /* Améliore le défilement sur les appareils Apple */
    border: 1px solid #e2e8f0; /* border-border-subtle */
    border-radius: 8px; /* Bords arrondis */
    margin-top: 1rem;
}

/* Styles pour le tableau à l'intérieur du conteneur */
.comparison-table-wrapper table {
    min-width: 600px; /* Force une largeur minimale pour éviter que le tableau ne s'écrase */
    width: 100%;
    border-collapse: collapse;
}

.comparison-table-wrapper th,
.comparison-table-wrapper td {
    padding: 12px 15px;
    border-bottom: 1px solid #e2e8f0; /* border-border-subtle */
    text-align: left;
    white-space: normal; /* Permet au texte de revenir à la ligne */
}

.comparison-table-wrapper th {
    background-color: #f8fafc; /* background-light */
    font-weight: 600;
    color: #1A3263; /* OrIAntation-darkblue */
}

#chatbot-container {
    height: calc(100% - 8rem); /* Calcule une hauteur fixe (toute la hauteur moins les marges) */
    max-height: 600px; /* Empêche la fenêtre d'être trop grande sur ordinateur */
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
}


    </style>
</head>

<body class="bg-background-light text-OrIAntation-darkblue text-center">

    <div id="authContainer" class="max-w-md mx-auto p-4 md:p-8 mt-10">
        <!-- L'interface d'authentification sera injectée ici -->
    </div>

    <div id="mainApp" class="max-w-4xl mx-auto p-4 md:p-8">
    </div>
        
<button id="floatingBackBtn" title="Retour au menu" style="display: none;">←</button>

<div id="guideRoleModal" style="display: none;" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center fade-in">
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Qui êtes-vous ?</h2>
        <p class="text-slate-600 mb-8">Nous pouvons adapter la présentation du guide pour vous.</p>
        <div class="space-y-4">

            <button id="roleEleveBtn" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg>
                <span>Je suis un élève</span>
            </button>

            <button id="roleParentBtn" class="w-full bg-sky-600 text-white font-semibold py-3 rounded-lg hover:bg-sky-700 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.962A3.75 3.75 0 0 1 9 10.5V9A4.5 4.5 0 0 1 13.5 4.5v.75m-6 5.25a3.75 3.75 0 0 1-7.5 0v-1.5a3.75 3.75 0 0 1 7.5 0v1.5Zm0 0V9A4.5 4.5 0 0 1 9 4.5v.75m-6 5.25v-1.5a3.75 3.75 0 0 1 7.5 0v1.5m0 0a9.043 9.043 0 0 1-4.125 2.122m-5.38-2.122a9.043 9.043 0 0 0 5.38 2.122m0 0a4.507 4.507 0 0 0 3.232 4.672M9 18.096c-1.07.246-2.193.396-3.375.45" />
                </svg>
                <span>Je suis un parent</span>
            </button>

            <button id="roleEnseignantBtn" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
                </svg>
                <span>Je suis un enseignant</span>
            </button>
        </div>
        <button id="closeRoleModalBtn" class="mt-8 text-sm text-slate-500 hover:underline">Annuler</button>
    </div>
</div>

    <footer class="text-center text-sm text-slate-500 py-6 space-y-2">
    <p>Application créée par Thomas Cavil, enseignant au lycée Benjamin Franklin</p>
    <div id="footer-privacy-link">
        <button onclick="showView('privacy')" class="font-semibold text-primary-action hover:underline">Politique de Confidentialité</button>
    </div>
</footer>

    <!-- Chatbot Floating Icon -->
<div id="chatbot-toggle" class="fixed bottom-6 right-6 bg-cyan-600 text-white w-16 h-16 rounded-full flex items-center justify-center cursor-pointer shadow-lg z-40">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
        <path fill-rule="evenodd" d="M9.315 7.584C12.195 3.883 16.695 1.5 21.75 1.5a.75.75 0 0 1 .75.75c0 5.056-2.383 9.555-6.084 12.436A6.75 6.75 0 0 1 9.75 22.5a.75.75 0 0 1-.75-.75v-4.131A15.838 15.838 0 0 1 6.382 15H2.25a.75.75 0 0 1-.75-.75 6.75 6.75 0 0 1 7.815-6.666ZM15 6.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" clip-rule="evenodd" />
        <path d="M5.26 17.242a.75.75 0 1 0-.897-1.203 5.243 5.243 0 0 0-2.05 5.022.75.75 0 0 0 .625.627 5.243 5.243 0 0 0 5.022-2.051.75.75 0 1 0-1.202-.897 3.744 3.744 0 0 1-3.008 1.51c0-1.23.592-2.323 1.51-3.008Z" />
    </svg>        

    <!-- Chatbot Window -->
<div id="chatbot-container" class="fixed bottom-4 right-4 sm:bottom-24 sm:right-6 w-[calc(100%-2rem)] max-w-sm bg-white rounded-2xl shadow-xl border border-border-subtle z-50 flex flex-col 
    opacity-0 translate-y-4 pointer-events-none 
    transform-gpu transition-opacity transition-transform duration-300 ease-in-out">
    
    <div class="relative flex items-center p-4 border-b bg-background-light rounded-t-2xl">
<h3 class="w-full text-center font-bold text-OrIAntation-darkblue">🤖 OrIA, ton copilote</h3>
        <button id="chatbot-close" class="absolute right-4 text-slate-500 hover:text-OrIAntation-darkblue text-2xl">&times;</button>
    </div>

    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto chat-message-container"></div>

    <form id="chatbot-form" class="p-4 border-t flex items-center gap-2">
        <input type="text" id="chatbot-input" placeholder="Quelle est ta question ?" class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none text-slate-800">
        <button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
    </form>
</div>

    <!-- SDKs Firebase -->
    <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
// MODIFICATION : On ajoute sendEmailVerification et applyActionCode
       import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, deleteUser, sendEmailVerification, applyActionCode, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
       import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, where, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
       import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";

       const firebaseConfig = {
            apiKey: "AIzaSyCT6U-7Az53oYCPZWHo3Dvxs20XiR0y3EU",
            authDomain: "monapp0rientation.firebaseapp.com",
            projectId: "monapp0rientation",
            storageBucket: "monapp0rientation.firebasestorage.app",
            messagingSenderId: "369432089475",
            appId: "1:369432089475:web:689a194b6880001c249cb6"
        };

        const approvedTeacherDomains = [
        'ac-aix-marseille.fr','ac-amiens.fr','ac-besancon.fr','ac-bordeaux.fr','ac-clermont.fr',
        'ac-corse.fr','ac-creteil.fr','ac-dijon.fr','ac-grenoble.fr','ac-lille.fr','ac-limoges.fr',
        'ac-lyon.fr','ac-montpellier.fr','ac-nancy-metz.fr','ac-nantes.fr','ac-nice.fr','ac-normandie.fr',
        'ac-caen.fr','ac-rouen.fr','ac-orleans-tours.fr','ac-paris.fr','ac-poitiers.fr','ac-reims.fr',
        'ac-rennes.fr','ac-strasbourg.fr','ac-toulouse.fr','ac-versailles.fr','ac-guadeloupe.fr',
        'ac-guyane.fr','ac-martinique.fr','ac-mayotte.fr','ac-reunion.fr','education.gouv.fr'
    ];

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const functions = getFunctions(firebaseApp, "europe-west3"); 
        const authContainer = document.getElementById('authContainer');
        const mainApp = document.getElementById('mainApp');

        const IS_DEV_MODE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        let step1DocumentClickListeners = [];
        let isNewUserFlow = false;



        function devLog(...args) {
  if (IS_DEV_MODE) {
    console.log('%c[DEV]', 'color: #7c3aed; font-weight: bold;', ...args);
  }
}


const PERSONA_IA = `
# Rôle et Identité
Tu es "OrIA", le copilote IA de l'application d'orientation "OrIAntation". Tu t'adresses à des lycéens français (15-18 ans) qui cherchent à construire leur projet d'avenir.

# Philosophie de Coaching (Ta Mission Fondamentale)
- **Tu es un guide, pas un oracle.** Ta mission n'est PAS de donner des réponses toutes faites, mais d'aider l'élève à se poser les bonnes questions et à prendre des décisions éclairées.
- **De la connaissance de soi à l'action.** Ton coaching part toujours de l'élève pour l'aider à explorer les possibilités, puis le pousser à se confronter au réel.
- **Tu es un copilote, pas le pilote.** L'élève reste toujours maître de ses décisions.
- **Tu es bienveillant(e) et réaliste.** Tu encourages l'ambition tout en rappelant l'importance de construire un projet solide.

# Règle sur l'Éventail des Possibles (TRÈS IMPORTANT)
- **Constat :** Tu as tendance à te concentrer sur les études courtes et techniques (BTS, BUT) et les secteurs industriels.
- **Ordre :** Tu dois impérativement élargir tes suggestions pour couvrir l'ensemble du champ des possibles. Pour chaque suggestion de domaine ou de métier, tu dois systématiquement envisager et proposer un équilibre entre :
    1.  Les études courtes et professionnalisantes (BTS, BUT...).
    2.  Les parcours universitaires (Licence, Master...).
    3.  Les écoles spécialisées (ingénieurs, commerce, art, etc.).
    4.  Les classes préparatoires aux grandes écoles (CPGE).

# Guide de Style et de Ton (Règles Impératives)
- **Ton :** Pédagogique, encourageant, bienveillant, légèrement décontracté mais toujours crédible et expert. Le tutoiement est systématique.
- **Vocabulaire INTERDIT :** N'utilise JAMAIS de jargon d'entreprise (livrable, deadline, prototype, etc.).
- **Vocabulaire AUTORISÉ :** Parle de "devoirs", "fiches de révision", "plan de travail", "échéances", "brouillon".
- **Contexte :** Ancre tes conseils dans la réalité du lycée français.

# Règle de Diversité (Contre-Biais)
- Contre activement ton biais naturel vers les métiers de la tech. Pense systématiquement à inclure des pistes dans des secteurs variés comme l'artisanat, les arts, le service public, la santé, l'environnement, le droit et les sciences humaines.
`;

function extractJsonFromString(str) {
    if (!str) return null;

    // NOUVELLE ÉTAPE : On nettoie les balises de bloc de code ```json
    let cleanedStr = str.trim();
    if (cleanedStr.startsWith("```json")) {
        cleanedStr = cleanedStr.substring(7); // Enlève "```json"
    }
    if (cleanedStr.endsWith("```")) {
        cleanedStr = cleanedStr.substring(0, cleanedStr.length - 3); // Enlève "```"
    }
    cleanedStr = cleanedStr.trim(); // Re-nettoie les espaces potentiels

    // On cherche le début d'un tableau '[' ou d'un objet '{'
    const jsonStartBracket = cleanedStr.indexOf('[');
    const jsonStartBrace = cleanedStr.indexOf('{');
    
    let jsonStart = -1;
    
    // On détermine quel type de JSON on a (tableau ou objet)
    if (jsonStartBracket > -1 && jsonStartBrace > -1) {
        jsonStart = Math.min(jsonStartBracket, jsonStartBrace);
    } else if (jsonStartBracket > -1) {
        jsonStart = jsonStartBracket;
    } else {
        jsonStart = jsonStartBrace;
    }

    // On détermine la fin correspondante
    const isArray = jsonStart === jsonStartBracket;
    const jsonEnd = cleanedStr.lastIndexOf(isArray ? ']' : '}') + 1;

    if (jsonStart === -1 || jsonEnd === 0) {
        return null;
    }

    const jsonString = cleanedStr.substring(jsonStart, jsonEnd);
    try {
        return JSON.parse(jsonString);
    } catch (error) {
        console.error("Impossible d'analyser le JSON extrait:", error);
        return null;
    }
}

       // REMPLACEZ ce bloc par la nouvelle version
// ✅ REMPLACEZ le premier bloc de démarrage (ligne 1484) par celui-ci

// ▼▼▼ REMPLACE LE BLOC DE DÉMARRAGE (celui qui commence par (async...)) PAR CELUI-CI ▼▼▼

// ▼▼▼ REMPLACE LE BLOC DE DÉMARRAGE PAR CETTE VERSION FINALE ▼▼▼

(async () => {
    const params = new URLSearchParams(window.location.search);
    const mode = params.get('mode');
    const actionCode = params.get('oobCode');
    const shareId = params.get('share_id');
    const shareToken = params.get('token');

    // Priorité 1 : Si c'est un lien de PARTAGE, on l'affiche et on arrête tout.
    if (shareId && shareToken) {
        authContainer.style.display = 'none';
        mainApp.style.display = 'block';
        document.querySelector('footer').style.display = 'none';
        document.querySelector('#chatbot-toggle').style.display = 'none';
        createPublicShareView(shareId, shareToken);
        return; 
    }

    // Priorité 2 : Si c'est un lien de VÉRIFICATION D'EMAIL
    if (mode === 'verifyEmail' && actionCode) {
        try {
            await applyActionCode(auth, actionCode);
            // Succès ! On affiche un message puis on redirige vers l'application.
            document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; text-align: center; padding: 20px; font-family: sans-serif;"><h1 style="font-size: 1.875rem; font-weight: bold; color: #1A3263;">Vérification réussie ! ✅</h1><p style="color: #4A5568; margin-top: 1rem;">Votre compte est maintenant activé. Redirection en cours...</p></div>`;
            // On attend 2.5 secondes pour que l'utilisateur lise, puis on recharge la page à sa racine.
            setTimeout(() => {
                window.location.href = window.location.pathname;
            }, 2500);
        } catch (error) {
            // Erreur ! Le lien est probablement expiré. On affiche un message et on ferme.
            console.error("Erreur de vérification:", error);
            document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; text-align: center; padding: 20px; font-family: sans-serif;"><h1 style="font-size: 1.875rem; font-weight: bold; color: #991B1B;">Erreur</h1><p style="color: #4A5568; margin-top: 1rem;">Ce lien de vérification est invalide ou a déjà été utilisé. Cet onglet va se fermer.</p></div>`;
            setTimeout(() => { window.close(); }, 4000);
        }
        return; // On arrête l'exécution ici pour ne pas lancer le flux normal.
    }

    // Priorité 3 : Si c'est un lien de RÉINITIALISATION DE MOT DE PASSE
    if (mode === 'resetPassword' && actionCode) {
        showResetPasswordView(actionCode);
        return; 
    }

    // Si aucune des conditions spéciales n'est remplie, on lance le FLUX NORMAL de l'application.
    initializeNormalAppFlow();

})();



        const levelConfig = {
            1: 0,
            2: 100,
            3: 250,
            4: 500,
            5: 800,
            6: 1200,
            7: 1700,
            8: 2300,
            9: 3000,
            10: 4000
        };

        const rankNames = {
            1: { homme: "Initié", femme: "Initiée", autre: "Initié(e)" },
            2: { homme: "Apprenti", femme: "Apprentie", autre: "Apprenti(e)" },
            3: { homme: "Curieux", femme: "Curieuse", autre: "Curieux/se" },
            4: { homme: "Explorateur", femme: "Exploratrice", autre: "Explorateur/rice" },
            5: { homme: "Stratège", femme: "Stratège", autre: "Stratège" },
            6: { homme: "Analyste", femme: "Analyste", autre: "Analyste" },
            7: { homme: "Spécialiste", femme: "Spécialiste", autre: "Spécialiste" },
            8: { homme: "Expert", femme: "Experte", autre: "Expert(e)" },
            9: { homme: "Mentor", femme: "Mentor", autre: "Mentor" },
            10: { homme: "Maître de l'Orientation", femme: "Maîtresse de l'Orientation", autre: "Maître de l'Orientation" }
        };

        const creativeAngles = [
            "un métier en lien avec la nature ou l'environnement.",
            "une carrière dans le secteur du jeu vidéo ou du divertissement interactif.",
            "un rôle qui implique des voyages ou des relations internationales.",
            "un métier artisanal ou qui demande un savoir-faire manuel de précision.",
            "une profession dans le domaine social ou humanitaire.",
            "un métier de la communication ou du journalisme.",
            "une carrière dans le secteur du luxe ou de la mode.",
            "un rôle dans le domaine du sport et du bien-être.",
            "un métier scientifique ou de recherche fondamentale.",
            "une profession liée au droit ou à la justice.",
            "une carrière dans le secteur de la finance ou de l'économie.",
            "un métier dans l'événementiel ou le tourisme.",
            "un rôle dans la tech qui n'est pas purement du code (ex: UX Designer, Chef de Produit).",
            "un métier du secteur public ou de l'administration.",
            "une profession artistique ou culturelle."
        ];


const allSteps = [
    // Catégorie : Le Tableau de Bord (Accès Rapide)
    { 
        id: 'journal', category: 'dashboard',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg>`, 
        title: 'Mon Journal de Bord', 
        site: 'Consulte tes notes', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'retroplanning', category: 'dashboard',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg>`, 
        title: 'Mon Rétroplanning', 
        site: 'Outil', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step0', category: 'dashboard',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>`, 
        title: 'Mieux se connaître', 
        site: 'Point de départ', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },

    // Catégorie : Explorer les Possibilités
    { 
        id: 'step2', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>`, 
        title: 'Le simulateur de spécialités', 
        site: 'Horizons21', 
        levels: ['seconde', 'premiere'] 
    },
    { 
        id: 'step1', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg>`, 
        title: 'Les Fondations', 
        site: 'Onisep', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step3', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>`, 
        title: 'Le Catalogue', 
        site: 'Parcoursup', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step5', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg>`, 
        title: 'L\'Actu', 
        site: 'L\'Étudiant & Co', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },

    // Catégorie : Se Connecter au Monde Réel
    { 
        id: 'step4', category: 'connect',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg>`, 
        title: 'L\'Expérience', 
        site: 'Inspire', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step8', category: 'connect',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg>`, 
        title: 'Passer à l\'action', 
        site: 'Monde réel', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step11', category: 'connect',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>`, 
        title: 'Rencontres sur mon Territoire', 
        site: 'Ressources locales', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },

    // Catégorie : Construire sa Candidature
    { 
    id: 'step10', category: 'build',
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg>`, 
    title: 'Mon Portfolio de Compétences', 
    site: 'Valorisation', 
    levels: ['seconde', 'premiere', 'terminale'] 
},
    { 
        id: 'step6', category: 'build',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`, 
        title: 'Préparer sa candidature', 
        site: 'Projet motivé', 
        levels: ['terminale'] 
    },
    { 
        id: 'step7', category: 'build',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`, 
        title: 'Fact Checking', 
        site: 'Jeu interactif', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step12', category: 'build',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`, 
        title: 'Simulateur Vie Étudiante', 
        site: 'Budget & Aides', 
        levels: ['premiere', 'terminale'] 
    },
    { 
        id: 'step9', category: 'build',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg>`, 
        title: 'Anticiper la suite', 
        site: 'Plan B & Réussite', 
        levels: ['terminale'] 
    }
];

        
        const stepsConfig = {
    step0: { 
        stepKey: 'step0', title: 'Mieux se connaître', 
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>`,
        description: `Toute bonne orientation commence par une bonne connaissance de soi. Réponds honnêtement à ces quelques questions pour dégager tes grandes tendances et obtenir une première analyse de ton profil.`,
        action: `<b>Ta mission :</b> Réponds au questionnaire pour que OrIA dresse ton portrait psychologique et révèle ton <b>Archétype de personnalité</b>. Pour une analyse encore plus fine, tu pourras ensuite, si tu le souhaites, utiliser le module "Pour aller plus loin" en bas de page pour croiser ces résultats avec ceux de tests externes.`
    },
    step1: {
    stepKey: 'step1', 
    title: "Les Fondations avec l'Onisep", 
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg>`,
    description: `L'Onisep est le service public de l'Éducation Nationale. C'est LA référence pour une information objective et complète. Cet outil est ton laboratoire pour explorer des pistes de métiers, une par une, et sauvegarder celles qui t'intéressent.`,
    action: `<b>Ta mission :</b> Utilise l'atelier "Exploration en cours" pour rechercher un métier. Sers-toi des boutons d'analyse (✨, 📅, 🎬) pour approfondir ta connaissance. Si la piste te semble intéressante, enregistre-la dans ton journal. Tu pourras ainsi accumuler tes trouvailles au fil du temps et utiliser le comparateur lorsque tu auras sauvegardé au moins deux métiers !`,
    urls: [ { site: "MonOrientationEnLigne.fr", url: 'https://www.monorientationenligne.fr/' } ],
    // Nous n'avons plus besoin de la clé "fields" ici
},
    step2: { 
    stepKey: 'step2', title: "Le simulateur de spécialités Horizons21",
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>`,

    description: `Cet outil a été créé pour t'aider à faire le lien entre les spécialités du lycée et les études supérieures. <b>Intérêt principal :</b> Comprendre l'impact de tes choix de matières sur ton avenir et préparer tes choix pour l'année suivante.`,
    
    // NOUVEAU BLOC
action: `<b>Ta mission :</b> Utilise l'atelier pour explorer des combinaisons de spécialités quue tu souhaites tester. Pour chaque combinaison, note les horizons qu'elle ouvre, puis utilise les boutons d'analyse (✨, 🗣️) pour obtenir des retours personnalisés. Enregistre ensuite tes explorations dans ton journal. Dès que tu auras sauvegardé au moins deux combinaisons, un comparateur apparaîtra !`,

    url: 'https://www.horizons21.fr', site: 'Horizons21.fr',
    },
    step3: {
        stepKey: 'step3', title: 'Le Catalogue Parcoursup',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>`, description: `Bien plus qu'un site d'inscription, c'est le moteur de recherche le plus exhaustif sur les formations post-bac. <b>Ce qu'il faut absolument regarder :</b> les "attendus", la carte interactive, et les chiffres clés (taux d'accès, etc.).`,
// NOUVEAU TEXTE
action: `<b>Ta mission :</b> Utilise l'atelier ci-dessous pour explorer les formations qui t'intéressent, une par une. Pour chaque piste, recherche la formation, copie-colle ses "attendus" puis utilise les boutons d'analyse (🔎, ✨) pour obtenir des retours personnalisés. Lorsque tu es satisfait, enregistre ta trouvaille dans ton journal pour la conserver. Dès que tu auras enregistré au moins deux formations, un comparateur apparaîtra pour t'aider à les mettre en balance !`,        url: 'https://dossier.parcoursup.fr/Candidat/carte', site: 'Parcoursup.fr',
    fields: [
        {id: 'formation1', label: 'Formation #1', placeholder: 'Ex: BUT Informatique - Villetaneuse'},
        {id: 'attendus1', label: 'Attendus et critères importants', placeholder: 'Bon niveau en maths, projet motivé...', type: 'textarea'},
        {id: 'compatibilite1', label: 'Rapport de compatibilité', type: 'textarea', isReadonly: true},
        {id: 'mots_cles1', label: 'Défi : Tes 3 mots-clés pour cette formation', placeholder: 'Ex: Logique, programmation, travail d\'équipe'},
        {id: 'analyse_mots_cles1', label: 'Analyse de tes mots-clés par l\'IA', type: 'textarea', isReadonly: true},
        {id: 'formation2', label: 'Formation #2', placeholder: 'Ex: Licence de Droit - Assas'},
        {id: 'attendus2', label: 'Attendus et critères importants', placeholder: 'Qualités rédactionnelles, logique...', type: 'textarea'},
        {id: 'compatibilite2', label: 'Rapport de compatibilité', type: 'textarea', isReadonly: true},
        {id: 'mots_cles2', label: 'Défi : Tes 3 mots-clés pour cette formation', placeholder: 'Ex: Rigueur, rédaction, argumentation'},
        {id: 'analyse_mots_cles2', label: 'Analyse de tes mots-clés par l\'IA', type: 'textarea', isReadonly: true},
        {id: 'suggestions', label: 'Pistes de réflexion suggérées par l\'IA', type: 'textarea', isReadonly: true}
    ]
},
    step4: {
    stepKey: 'step4', 
    title: "L'Expérience avec Inspire",     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg>`,
    description: `Cette plateforme te permet de discuter avec des étudiants "éclaireurs". <b>Intérêt principal :</b> Obtenir un retour d'expérience authentique et humain, au-delà des plaquettes officielles (ambiance, charge de travail, vie étudiante...).`,
    action: "<b>Ta mission :</b> Utilise l'atelier pour préparer tes échanges. Pour chaque thème, pose une question de base, puis utilise le bouton ✨ pour obtenir des suggestions de questions plus pertinentes. Enregistre tes préparations dans ton journal.",
    url: 'https://www.inspire-orientation.org', 
    site: 'Inspire-orientation.org'
},

step5: {
    stepKey: 'step5', title: "L'Actu",     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg>`,
    description: `Des médias comme L'Étudiant.fr ou Studyrama.com apportent un autre regard sur le monde des études et des métiers. <b>Ce que tu peux y trouver :</b> des classements, des articles sur des secteurs qui recrutent, et des dossiers sur des filières.`,
    action: `<b>Ta mission :</b> Utilise l'atelier pour sauvegarder les articles, classements ou infos que tu trouves. Pour chaque trouvaille, note ce que tu as appris, puis utilise le bouton ✨ pour que OrIA l'analyse par rapport à ton profil.`,
    urls: [
        { site: "L'Étudiant.fr", url: 'https://www.letudiant.fr' },
        { site: "Studyrama.com", url: 'https://www.studyrama.com' }
    ]
},

    step6: { 
    stepKey: 'step6', title: 'Préparer sa candidature',     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`,
    description: `La rédaction du "projet de formation motivé" sur Parcoursup est une étape cruciale. Cet outil ne va pas écrire la lettre à ta place, mais t'aider à la structurer de manière claire et percutante.`,
    action: `<b>Ta mission :</b> Utilise l'<b>Atelier de rédaction</b> pour préparer tes projets de formation motivés, un par un. Pour chaque projet, renseigne la formation et tes motivations, puis génère une structure avec l'aide de l'IA. Tu peux ensuite utiliser l'<b>Optimiseur de Paragraphe</b> pour affiner ton brouillon. Une fois que tu es satisfait, n'oublie pas de cliquer sur <b>"💾 Enregistrer ce projet de candidature"</b> pour l'ajouter à ta liste. Tu peux préparer autant de projets que tu le souhaites !`
    // Note : la propriété "fields" a été supprimée car elle n'est plus utile.
 },
   step7: {
    stepKey: 'step7', 
    title: 'Fact Checking',     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`,
    
    // Description mise à jour
    description: `Dans le monde de l'orientation, il est crucial de savoir démêler le vrai du faux. Cette étape te propose trois ateliers pour aiguiser ton esprit critique.`,
    
    // Mission mise à jour
    action: `<b>Ta mission :</b> Choisis l'un des trois ateliers ci-dessous. Le "Vrai ou Faux" teste tes connaissances, le "Défi Personnalisé" confronte ton profil aux idées reçues, et "Trouvez l'Intrus" met au défi ta capacité à déceler la fausse information.`,
    
    fields: []
},
    step8: { 
    stepKey: 'step8', 
    title: 'Passer à l\'action',     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-azimut-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg>`,
    description: {
        seconde: `Le stage d'observation de fin de Seconde est une occasion en or de découvrir le monde professionnel. Cet outil est là pour t'aider à trouver des pistes et à préparer ta candidature.`,
        default: `La recherche en ligne est une chose, la réalité du terrain en est une autre. L'avis d'un professionnel ou le témoignage d'un étudiant peut tout changer ! Cette étape t'aide à préparer ces rencontres.`
    },
    action: {
        seconde: `<b>Ta mission :</b> Utilise le moteur de recherche pour trouver des idées de lieux de stage dans un secteur qui t'intéresse. Ensuite, utilise l'assistant pour préparer un e-mail de candidature convaincant.`,
        default: `<b>Ta mission :</b> Transforme cette étape en ton gestionnaire de réseau ! Ajoute tes contacts personnels, puis utilise la recherche IA pour trouver des contacts professionnels. Ensuite, prépare tes échanges avec l'assistant "Stratégie de Contact".`
    }
    // La partie "fields" n'est plus nécessaire ici car gérée dynamiquement
},
    step9: { 
        stepKey: 'step9', title: 'Anticiper la suite',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg>`,

        description: `L'orientation ne s'arrête pas à Parcoursup. Cette étape t'aide à te préparer pour la suite : que faire si ton vœu n°1 est refusé ? Et comment bien démarrer ta première année dans le supérieur ?`,
        action: "<b>Ta mission :</b> Utilise les deux outils ci-dessous. Le premier t'aide à construire un plan B solide. Le second te donne des conseils pour réussir ta future première année.",
        fields: [
            {id: 'formation_reve', label: 'Ma formation "rêvée" (Vœu n°1)', placeholder: 'Ex: Classe prépa MPSI au Lycée Louis-le-Grand'},
            {id: 'plan_b', label: 'Suggestions de "Plan B" par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'reussite_type', label: 'Type de formation pour lequel tu veux des conseils', placeholder: 'Ex: Licence de Droit, BUT, Classe Prépa...'},
            {id: 'reussite_conseils', label: 'Conseils de réussite par l\'IA', type: 'textarea', isReadonly: true }
        ]
    },
   step10: { 
        stepKey: 'step10', title: 'Mon Portfolio de Compétences',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg>`,

        description: `Cette étape te propose deux ateliers complémentaires pour créer un portfolio qui te ressemble vraiment. Le premier t'aide à transformer tes expériences concrètes (stage, projet, passion, job...) en compétences valorisables pour tes candidatures. Le second est un 'détecteur' rapide qui te permet de révéler tes grandes compétences transversales (ta manière de travailler, de réfléchir...). L'ensemble te donnera une vision claire et unique de tes atouts.`,
        action: `<b>Ta mission est double :</b><br>
        1. <b>Raconter tes expériences :</b> Clique sur le bouton "+ Ajouter une expérience" et laisse-toi guider. Raconte ce que tu as fait, et OrIA t'aidera à en extraire les compétences clés pour Parcoursup.<br>
        2. <b>Révéler ton profil :</b> Lance le "détecteur de compétences" et réponds aux quelques questions. Tu obtiendras une analyse de tes savoir-être dominants (Rigueur, Créativité, Leadership...).`,
        fields: []
    },
    step11: { 
        stepKey: 'step11', title: 'Rencontres sur mon Territoire',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>`,

        description: `L'orientation se nourrit aussi de rencontres réelles. Utilise cet outil pour trouver des événements et des structures d'aide près de chez toi.`,
        action: "<b>Ta mission :</b> Indique ta ville ou ton département, puis lance les recherches pour trouver les prochaines opportunités de rencontres et les lieux d'information locaux.",
        fields: [
            {id: 'location', label: 'Ta ville ou ton département', placeholder: 'Ex: Landévant ou Morbihan'}
        ]
    },
    step12: { 
        stepKey: 'step12', title: 'Simulateur Vie Étudiante',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`,

        description: `Choisir ses études, c'est aussi choisir un cadre de vie et un budget. Utilise cet outil pour estimer le coût de la vie dans la ville de ton choix et pour découvrir les principales aides financières auxquelles tu pourrais prétendre.`,
        action: `<b>Ta mission :</b> Renseigne une ville, puis lance les simulateurs pour obtenir une estimation de budget et des pistes pour les bourses.`,
        fields: []
    },
};


const badgesConfig = {
    explorateur: {
        icon: '🛰️',
        title: "Pionnier Numérique",
        description: "Décerné pour avoir lancé l'exploration et scanné les données fondamentales de ton profil.",
        criteria: (level) => {
            // RÈGLE CORRIGÉE ET ASSOUPLIE : On vérifie que les étapes sont bien COMMENCÉES.
            const step0Started = journalData.step0 && journalData.step0.analysis && journalData.step0.analysis.trim() !== '';
            const step1Started = isStepStarted('step1');
            const step2or3Started = level === 'seconde' ? isStepStarted('step2') : isStepStarted('step3');
            return step0Started && step1Started && step2or3Started;
        }
    },

     pilote: {
        icon: '🎓',
        title: "Pilote Certifié",
        description: "Félicitations ! Tu as terminé le parcours d'initiation et maîtrises les outils de base pour prendre les commandes de ton orientation.",
        criteria: () => {
            // La règle est simple : le badge est obtenu quand le tutoriel est marqué comme terminé.
            return journalData.tutorial_completed === true;
        }
    },
    
    stratege: {
    icon: '💠',
    title: "Architecte Stratégique",
    description: "Décerné pour avoir traité les informations afin de bâtir un plan d'avenir et des scénarios alternatifs.",
    criteria: () => {
        // On vérifie maintenant si le tableau de tâches existe et n'est pas vide.
        const retroplanningComplete = journalData.retroplanning && Array.isArray(journalData.retroplanning.tasks) && journalData.retroplanning.tasks.length > 0;
        const step9Complete = isStepComplete('step9');
        return retroplanningComplete && step9Complete;
    }
},
    connecteur: {
        icon: '🌐',
        title: "Hub Réseau",
        description: "Décerné pour avoir établi les premiers nœuds de ton réseau professionnel en contactant le monde réel.",
        criteria: () => {
            // RÈGLE CORRIGÉE : On vérifie la nouvelle liste de contacts.
            return journalData.step8 && journalData.step8.contacts && journalData.step8.contacts.length > 0;
        }
    },
    artisan: {
        icon: '🧬',
        title: "Développeur de Profil",
        description: "Décerné pour avoir décodé tes expériences et assemblé l'ADN de tes compétences dans un portfolio.",
        criteria: () => {
            return journalData.step10 && journalData.step10.skills_synthesis && journalData.step10.skills_synthesis.trim() !== '';
        }
    },
    analyste: {
        icon: '📈',
        title: "Analyste de Données",
        description: "Décerné pour avoir croisé les données de Parcoursup avec ton profil pour en extraire des tendances.",
        criteria: () => {
            return journalData.step3 && (
                (journalData.step3.compatibilite1 && journalData.step3.compatibilite1.trim() !== '') || 
                (journalData.step3.compatibilite2 && journalData.step3.compatibilite2.trim() !== '')
            );
        }
    },
    verificateur: {
        icon: '🛡️',
        title: "Débugueur de Mythes",
        description: "Décerné pour avoir sécurisé ton projet en déconstruisant les idées reçues avec l'outil Fact Checking.",
        criteria: () => {
            return journalData.step7 && journalData.step7.scores && Object.keys(journalData.step7.scores).length > 0 && Object.values(journalData.step7.scores).some(history => history.length > 0);
        }
    }
};

function promptShareRole() {
    return new Promise((resolve) => {
        const modalId = 'role-choice-modal';
        const existingModal = document.getElementById(modalId);
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';

        modal.innerHTML = `
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">À qui souhaites-tu partager ?</h2>
                <p class="text-slate-600 mb-8">Le ton du message sera adapté au destinataire.</p>
                <div class="space-y-4">
                    <button id="share-for-parent" class="w-full bg-sky-600 text-white font-semibold py-3 rounded-lg hover:bg-sky-700 transition">Pour un proche (parent, tuteur...)</button>
                    <button id="share-for-teacher" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 transition">Pour un enseignant</button>
                </div>
                <button id="share-cancel" class="mt-8 text-sm text-slate-500 hover:underline">Annuler</button>
            </div>
        `;
        document.body.appendChild(modal);

        const closeModal = () => modal.remove();

        modal.querySelector('#share-for-parent').addEventListener('click', () => {
            closeModal();
            resolve('parent');
        });
        modal.querySelector('#share-for-teacher').addEventListener('click', () => {
            closeModal();
            resolve('enseignant');
        });
        modal.querySelector('#share-cancel').addEventListener('click', () => {
            closeModal();
            resolve(null); // On résout avec null si l'utilisateur annule
        });
    });
}

function showShareMessageModal(shareLink, studentFirstName, role) {
    const title = "Partage ton Journal de Bord !";
    let messageTemplate = '';

    if (role === 'parent') {
        messageTemplate = `Bonjour [Nom du proche],

Comme on en a parlé, j'utilise une application qui s'appelle OrIAntation pour construire mon projet d'orientation. J'aimerais beaucoup avoir ton avis.

J'ai activé le partage de mon 'Journal de Bord'. Ça te donnera une vue d'ensemble de ma réflexion et des pistes que j'explore.

Voici le lien unique et sécurisé pour le consulter :
${shareLink}

On pourra en discuter quand tu auras un moment !

À bientôt,
${studentFirstName}`;
    } else { // role === 'enseignant'
        messageTemplate = `Bonjour Monsieur/Madame [Nom de l'enseignant],

Dans le cadre de mon travail sur mon projet d'orientation avec l'outil OrIAntation, je vous partage l'accès à mon Journal de Bord.

Votre avis et vos conseils sur ma démarche seraient très précieux pour m'aider à avancer.

Voici le lien sécurisé pour le consulter :
${shareLink}

En vous remerciant pour votre aide,
Cordialement,
${studentFirstName}`;
    }

    const contentHTML = `
        <p class="text-slate-600 mb-4">Voici un message pré-rempli. N'oublie pas de remplacer le nom du destinataire !</p>
        <textarea id="share-message-textarea" rows="15" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light text-sm">${messageTemplate}</textarea>
        <button id="copy-share-message-btn" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Copier le message</button>
    `;

    createSimpleModal(title, contentHTML);
    
    // La logique du bouton copier ne change pas...
    const copyBtn = document.getElementById('copy-share-message-btn');
    const textarea = document.getElementById('share-message-textarea');
    if (copyBtn && textarea) {
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(textarea.value).then(() => {
                copyBtn.textContent = 'Copié ! ✔';
                setTimeout(() => { copyBtn.textContent = 'Copier le message'; }, 2000);
            });
        });
    }
}



// AJOUT : Nouvelle fonction pour la page de réinitialisation de mot de passe
// ✅ VERSION FINALE AVEC LOGO ET BOUTONS CORRIGÉS

function showResetPasswordView(actionCode) {
    authContainer.style.display = 'block';
    mainApp.style.display = 'none';

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo_surprises.PNG" alt="Logo OrIAntation" class="mx-auto h-32 w-32 mb-4">

            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mb-4">Réinitialiser votre mot de passe</h2>
            <p class="text-center text-slate-500 mb-6">Veuillez entrer votre nouveau mot de passe.</p>
            <form id="resetPasswordForm">
                <input id="newPassword" type="password" placeholder="Nouveau mot de passe" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="confirmPassword" type="password" placeholder="Confirmer le nouveau mot de passe" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Enregistrer le nouveau mot de passe</button>
            </form>
            <p id="resetError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const resetError = document.getElementById('resetError');

    resetPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword.length < 6) {
            resetError.textContent = "Le mot de passe doit contenir au moins 6 caractères.";
            return;
        }
        if (newPassword !== confirmPassword) {
            resetError.textContent = "Les mots de passe ne correspondent pas.";
            return;
        }

        try {
            await confirmPasswordReset(auth, actionCode, newPassword);
            
            showInfoModal(
                "Mot de passe modifié !",
                "Votre mot de passe a été réinitialisé avec succès. Vous pouvez maintenant vous connecter.",
                window.location.pathname,
                3000
            );

        } catch (error) {
            console.error("Erreur de réinitialisation:", error.code);
            if (error.code === 'auth/invalid-action-code') {
                resetError.textContent = "Le lien a expiré ou est invalide. Veuillez refaire une demande.";
            } else {
                resetError.textContent = "Une erreur est survenue. Veuillez réessayer.";
            }
        }
    });
}


// Remplacez votre fonction showSurpriseModal par cette version

function showSurpriseModal(title, contentHTML, duration = null) {
    // La fonction retourne maintenant une Promise
    return new Promise((resolve) => {
        const modalId = 'surprise-modal';
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';
        
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md text-center p-6">
            <img src="logo_surprises.PNG" alt="Logo OrIAntation" class="mx-auto h-32 w-32 mb-4">
                <h3 class="font-bold text-OrIAntation-darkblue text-lg mt-2 mb-4">${title}</h3>
                <div class="text-slate-600 mb-6">${contentHTML}</div>
                <button id="surprise-close-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 rounded-lg hover:bg-cyan-700 transition">OK</button>
            </div>
        `;
        
        document.body.appendChild(modal);

        const closeModal = () => {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.remove();
                resolve(); // On "résout" la promesse, ce qui débloque le code
            }, 300);
        };
        
        modal.querySelector('#surprise-close-btn').addEventListener('click', closeModal);

        if (duration) {
            setTimeout(closeModal, duration);
        }
    });
}

function createSimpleModal(title, contentHTML) {
            const modalId = 'simple-info-modal';
            // Supprime un modal existant s'il y en a un
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col max-h-[80vh]">
                    <div class="flex items-center justify-between p-4 border-b bg-background-light rounded-t-2xl">
                        <h3 class="font-bold text-OrIAntation-darkblue text-lg">${title}</h3>
                        <button id="simple-modal-close" class="text-slate-500 hover:text-OrIAntation-darkblue text-2xl">×</button>
                    </div>
                    <div class="p-6 overflow-y-auto">
                        ${contentHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            const closeModal = () => modal.remove();
            
            modal.querySelector('#simple-modal-close').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        function showConfirmationModal(question) {
            return new Promise((resolve) => {
                const modalId = 'confirmation-modal';
                // Supprime un modal de confirmation existant pour éviter les doublons
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm text-center p-6">
                        <h3 class="font-bold text-OrIAntation-darkblue text-lg mb-4">Confirmation requise</h3>
                        <p class="text-slate-600 mb-6">${question}</p>
                        <div class="flex gap-4">
                            <button id="confirm-cancel-btn" class="flex-1 bg-slate-200 text-OrIAntation-darkblue font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Annuler</button>
                            <button id="confirm-ok-btn" class="flex-1 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Confirmer</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const confirmBtn = modal.querySelector('#confirm-ok-btn');
                const cancelBtn = modal.querySelector('#confirm-cancel-btn');

                const closeModal = (result) => {
                    modal.remove();
                    resolve(result); // La promesse est résolue avec 'true' ou 'false'
                };

                confirmBtn.addEventListener('click', () => closeModal(true));
                cancelBtn.addEventListener('click', () => closeModal(false));
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(false); // Cliquer en dehors équivaut à annuler
                    }
                });
            });
        }

        // IMPORTANT : Remplacez par la configuration de votre propre projet Firebase
        
        let currentUserId = null;
        let userGradeLevel = null;
        let currentUserInfo = { firstName: '', lastName: '', schoolName: '' };
        let currentViewName = null; // <-- AJOUTEZ CETTE LIGNE
        let verificationTimer = null;



        let cameFromLogin = false;
        let cameFromAuth = false; // 👈 AJOUTEZ CETTE LIGNE
        let authReturnView = ''; 
        let signupFormData = {}; // <-- JUSTE ICI



        window.showAuthViewFromPrivacy = function() {
            cameFromAuth = false;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
            document.querySelector('footer').style.display = 'block';
            showLoginView();
        }

        const linkify = (text) => {
    const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    let newText = text.replace(urlRegex, function(url) {
        let hyperLink = url;
        if (!hyperLink.match('^https?:\/\/')) {
            hyperLink = 'http://' + hyperLink;
        }
        return `<a href="${hyperLink}" target="_blank" class="text-primary-action hover:underline">${url}</a>`;
    });
    // This makes sure line breaks are preserved
    return newText.replace(/\n/g, '<br>');
};
        const { jsPDF } = window.jspdf;
        const floatingBackBtn = document.getElementById('floatingBackBtn'); // AJOUTEZ CETTE LIGNE

floatingBackBtn.addEventListener('click', () => {
    // Si on est sur la page du guide, on applique la logique spéciale
    if (currentViewName === 'guide') {
const backAction = cameFromLogin ? window.showSignupViewFromGuide : () => window.showView('menu');
        backAction();
    } 
    // Cas 2 : On est sur la vue du journal d'un élève (en tant qu'enseignant)
    else if (currentViewName === 'teacherStudentJournal') {
        showView('teacherDashboard'); // On retourne au tableau de bord enseignant
    }
    // Cas 3 : On est sur la politique de confidentialité
    else if (currentViewName === 'privacy') {
        // On s'assure que les bonnes sections de la page sont visibles
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        
        // Si on vient de la page d'inscription (drapeau `cameFromAuth`)
        if (cameFromAuth) {
            cameFromAuth = false;
            showSignupView();
        } else {
            // NOUVELLE LOGIQUE ICI
            // On vérifie le rôle de l'utilisateur connecté
            if (currentUserInfo.role === 'enseignant') {
                showView('teacherDashboard'); // Si c'est un prof, on retourne à son tableau de bord
            } else {
                showView('menu'); // Sinon (si c'est un élève), on retourne au menu
            }
        }
    }
    // Cas par défaut : Pour toutes les autres pages, on retourne au menu principal
    else {
        showView('menu');
    }
});

        let journalData = {};
        
       // Détecter si l'URL est un lien de partage
// REMPLACEZ VOTRE LOGIQUE DE DÉMARRAGE ACTUELLE PAR CELLE-CI

      // REMPLACEZ VOTRE LOGIQUE DE DÉMARRAGE ACTUELLE PAR CELLE-CI

function initializeNormalAppFlow() {
    // Cette fonction est maintenant le point d'entrée pour un démarrage normal.
    // Elle contient toute la logique de connexion/déconnexion qui était dans l'ancien bloc.
    window.showGuideFromLogin = function() {
        cameFromLogin = true;
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.querySelector('footer').style.display = 'none'; 
        showView('guide');
    }
    window.showLoginViewFromGuide = function() {
        cameFromLogin = false;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        showLoginView();
    }
    window.showSignupViewFromGuide = function() {
        cameFromLogin = false;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        showSignupView();
    }


// REMPLACEZ VOTRE FONCTION onAuthStateChanged PAR CETTE VERSION FINALE

onAuthStateChanged(auth, user => {

    if (isNewUserFlow) {
        return;
    }
    
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    
    if (user) {
        if (user.emailVerified || IS_DEV_MODE) {
            if (IS_DEV_MODE) { console.log('%c⚠️ MODE DÉVELOPPEUR ACTIF : Vérification d\'email contournée.', 'color: orange; font-weight: bold;'); }
            
            if (chatbotToggle) chatbotToggle.style.display = 'flex';
            currentUserId = user.uid;
            authContainer.style.display = 'none';
            mainApp.style.display = 'block';
            document.body.classList.add('logged-in');
            
            // On charge les données de l'utilisateur
            loadData().then(async () => {
                // 'loadData' est terminée, on peut maintenant prendre des décisions
                
                if (currentUserInfo.role === 'enseignant') {
                    // CAS 1 : C'est un enseignant
                    showView('teacherDashboard');

                } else { 
                    // CAS 2 : C'est un élève
                    const userDocRef = doc(db, "users", currentUserId);
                    const currentSchoolYear = getCurrentSchoolYear();
                    await setDoc(userDocRef, { lastLoginSchoolYear: currentSchoolYear }, { merge: true });

                    if (!userGradeLevel) {
                        // 2a : C'est un NOUVEL élève (il n'a pas encore de classe)
                        showGradeSelectionView();
                    } else {
                        // 2b : C'est un élève QUI REVIENT
                        showMenuAndWelcomeCheck();
                    }
                }
            });
            
        } else {
            // Logique pour l'e-mail non vérifié
            if (chatbotToggle) chatbotToggle.style.display = 'none';
            if (floatingBackBtn) floatingBackBtn.style.display = 'none';
            document.body.classList.remove('logged-in');
            showVerificationView(user);
        }
    } else {
        // Logique pour l'utilisateur déconnecté
        if (chatbotToggle) chatbotToggle.style.display = 'none';
        if (floatingBackBtn) floatingBackBtn.style.display = 'none';
        currentUserId = null;
        userGradeLevel = null;
        currentUserInfo = { firstName: '', lastName: '', schoolName: '' };
        journalData = {}; 
        authContainer.style.display = 'block';
        mainApp.style.display = 'none';
        document.body.classList.remove('logged-in');
        showLoginView();
    }
});
}

async function handleOnboarding(context = {}) {
    if (!context || !context.from) { return false; }

    // --- MISSION 1 (FIN DE L'ÉTAPE 0) ---
    if (context.from === 'step0_analysis' && !journalData.tutorial_mission_1_shown) {
        journalData.tutorial_mission_1_shown = true;
        journalData.tutorial_next_step = 'retroplanning';
        await saveData({ skipOnboarding: true }); // Sauvegarde des indicateurs

        await showSurpriseModal(
            "Première mission accomplie ! 🚀",
            `<p>Bravo, tu as découvert ton Archétype ! Tu viens de démarrer le coeur du réacteur !!</p>
             <p class="mt-4 font-semibold">Ta prochaine mission : va sur l'étape <strong>"Mon Rétroplanning"</strong> et clique sur le bouton <strong>"📅 Générer / Mettre à jour"</strong> pour obtenir ta feuille de route. Clique enfin sur enregistrer dans le journal pour passer à la suite</p>`
        );
        showView('menu');
        return true;
    }

    // --- MISSION 2 (FIN DE L'ÉTAPE RÉTROPLANNING) ---
    const retroplanningDone = journalData.retroplanning?.tasks?.length > 0;
    if (context.from === 'retroplanning_save' && retroplanningDone && !journalData.tutorial_mission_2_shown) {
        journalData.tutorial_mission_2_shown = true;
        journalData.tutorial_next_step = 'step1';
        await saveData({ skipOnboarding: true });

        await showSurpriseModal(
            "Feuille de route générée ! 🗺️",
            `<p>Parfait ! Tu as une vision claire de ton année.</p>
             <p class="mt-4 font-semibold">Mission suivante : va sur l'étape <strong>"Les Fondations"</strong>, renseigne un métier qui t'intéresse et lance les analyses d'OrIA avec les boutons ✨, 📅, et 🎬. Clique enfin sur terminer et suvegarder pour passer à la suite</p>`
        );
        showView('menu');
        return true;
    }
    
    // --- MISSION 3 (FIN DE L'ÉTAPE 1) ---
    const metiersExplores = [journalData.step1.metier1, journalData.step1.metier2, journalData.step1.metier3].filter(m => m && m.trim() !== '').length;
    if (context.from === 'step1_save' && metiersExplores >= 1 && !journalData.tutorial_mission_3_shown) {
        journalData.tutorial_mission_3_shown = true;
        journalData.tutorial_next_step = 'journal'; // La prochaine étape est le journal
        await saveData({ skipOnboarding: true });
        await showSurpriseModal(
            "Troisième mission accomplie ! 🧭",
            `<p>Excellent ! Tu as exploré ta première piste de métiers.</p><p class="mt-4 font-semibold">Mission finale : va dans ton "Journal de Bord" et génère ton "Fil Rouge" pour obtenir une synthèse complète de ton parcours.</p>`
        );
        showView('menu');
        return true;
    }

    // --- MISSION 4 (FINALE) : GÉNÉRATION DU FIL ROUGE ---
    if (context.from === 'fil_rouge_generated' && !journalData.tutorial_completed) {
        journalData.tutorial_completed = true;
        journalData.tutorial_next_step = ''; // On vide pour enlever la surbrillance
        await saveData({ skipOnboarding: true });
        await showSurpriseModal(
            "Félicitations, Tutoriel Terminé ! 🎉",
            "<p>Tu as maintenant toutes les bases pour chosiir ton cap !! Continue à remplir les étapes à ton rythme. Bonne exploration !</p>"
        );
        return true;
    }
    
    return false;
}

        async function deleteUserAccount() {
    const user = auth.currentUser;
    if (!user) return;

    // Étape 1 : Confirmation
    const confirmed = await showConfirmationModal("Êtes-vous certain de vouloir supprimer votre compte ? Toutes vos données seront définitivement effacées. Cette action est irréversible.");
    
    if (confirmed) {
        try {
            // Étape 2 : Suppression des données
            await deleteDoc(doc(db, "users", user.uid)); // Supprime le document Firestore
            await deleteUser(user); // Supprime l'utilisateur de l'authentification
            
            // Étape 3 : Confirmation et déconnexion
showInfoModal("Suppression réussie", "Votre compte et toutes vos données ont été supprimés avec succès.");
            // onAuthStateChanged se chargera de la redirection
        } catch (error) {
            console.error("Erreur lors de la suppression du compte:", error);
            if (error.code === 'auth/requires-recent-login') {
showInfoModal("Action requise", "Cette opération est sensible et requiert une connexion récente. Veuillez vous déconnecter, vous reconnecter, puis réessayer.");                signOut(auth);
            } else {
showInfoModal("Erreur", "Une erreur est survenue lors de la suppression. Veuillez réessayer.");            }
        }
    }
}

            
        // 🔹 Fonction utilitaire
function capitalizeWords(str) {
    if (!str) return '';
    return str
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

function showLoginView() {
    // On s'assure de toujours cacher le bouton flottant ici
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    if (floatingBackBtn) {
        floatingBackBtn.style.display = 'none';
    }

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-auto w-auto">
            <div class="p-4 bg-white text-OrIAntation-darkblue text-center mb-6">
                <p class="text-sm text-slate-600">
                    Tu te sens perdu ? dans le brouillard ? Noyé dans un océan d'informations ? Pas de panique, tu vas enfin pouvoir prendre les commandes de ton orientation ! Fais confiance à ton copilote OrIA pour te montrer des chemins de traverse que peu connaissent.
                </p>
                <p class="font-semibold text-OrIAntation-darkblue mt-2">Choisis ton cap avec notre boussole 2.0 !!</p>
            </div>
 <p class="text-center text-sm text-slate-500 mb-6">
                Besoin d'aide pour commencer ? 
                <button id="showGuideButton" class="font-semibold text-primary-action hover:underline">Consultez le guide d'utilisation.</button>
            </p>
            <form id="loginForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Se connecter</button>
            </form>
            <div class="flex justify-between items-center text-sm text-left">
                <p class="text-slate-500">Pas encore de compte ? 
                    <button id="showSignupButton" class="font-semibold text-primary-action hover:underline">Inscrivez-vous</button>
                </p>
                <button id="forgotPasswordButton" class="text-sm text-slate-500 hover:underline">Mot de passe oublié ?</button>
            </div>
            <p id="authError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    authContainer.querySelector('#loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
        } catch (error) {
            authContainer.querySelector('#authError').textContent = "Erreur de connexion. Vérifiez vos identifiants.";
        }
    });

    authContainer.querySelector('#showSignupButton').addEventListener('click', showSignupView);
    authContainer.querySelector('#forgotPasswordButton').addEventListener('click', showForgotPasswordView);
    
    // CORRECTION : Le bouton ouvre maintenant la fenêtre de sélection
    authContainer.querySelector('#showGuideButton').addEventListener('click', () => {
        document.getElementById('guideRoleModal').style.display = 'flex';
    });
}

// AJOUT : Nouvelle fonction pour afficher la page de vérification
// ✅ VERSION FINALE AVEC LOGO ET BOUTONS CORRIGÉS

function showVerificationView(user) {
    authContainer.style.display = 'block';
    mainApp.style.display = 'none';

    if (verificationTimer) clearInterval(verificationTimer);

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in text-center">
            <img src="logo_surprises.PNG" alt="Logo OrIAntation" class="mx-auto h-32 w-32 mb-4">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Vérifiez votre adresse e-mail</h2>
            <p class="text-slate-600 mb-6">Un e-mail de vérification a été envoyé à <strong>${user.email}</strong>...</p>
            <p id="resendMessage" class="text-sm text-green-600 mb-4"></p>
            <div class="space-y-4">
                <button id="resendVerificationBtn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Renvoyer l'e-mail</button>
                <button id="logoutFromVerificationBtn" class="w-full bg-slate-200 text-OrIAntation-darkblue font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Se déconnecter</button>
            </div>
        </div>
    `;

    // Le minuteur intelligent, maintenant simplifié
    verificationTimer = setInterval(async () => {
        if (auth.currentUser) {
            await auth.currentUser.reload();
            if (auth.currentUser.emailVerified) {
                // ✅ LA CORRECTION EST ICI :
                // On arrête tout et on recharge simplement la page.
                clearInterval(verificationTimer);
                window.location.reload(); 
            }
        }
    }, 3000);


    // ❗ CORRECTION : Le bouton "Renvoyer" appelle maintenant votre fonction Cloud pour envoyer l'email Brevo.
    authContainer.querySelector('#resendVerificationBtn').addEventListener('click', async () => {
        const resendMessage = authContainer.querySelector('#resendMessage');
        try {
            const functionUrl = 'https://europe-west3-monapp0rientation.cloudfunctions.net/sendTransactionalEmail';
            await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data: {
                        templateId: 1, // ID du template de VÉRIFICATION
                        toEmail: user.email,
                        params: { firstName: user.displayName || ' ' } // On essaie de récupérer le prénom
                    }
                }),
            });
            resendMessage.textContent = "Un nouvel e-mail a été envoyé !";
        } catch (error) {
            console.error("Erreur lors du renvoi de l'email:", error);
            resendMessage.textContent = "Erreur lors de l'envoi. Veuillez réessayer plus tard.";
        }
    });
    
    authContainer.querySelector('#logoutFromVerificationBtn').addEventListener('click', () => {
        // ✅ AJOUT : On arrête aussi le minuteur si l'utilisateur se déconnecte manuellement.
        if (verificationTimer) clearInterval(verificationTimer);
        signOut(auth);
    });
}

// AJOUT : Une fonction pour afficher une jolie modale d'information
function showInfoModal(title, message, redirectUrl = null, duration = 0) {
    const modalId = 'info-modal';
    // Supprime un modal existant pour éviter les doublons
    const existingModal = document.getElementById(modalId);
    if (existingModal) existingModal.remove();

    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';

    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm text-center p-6">
            <h3 class="font-bold text-OrIAntation-darkblue text-lg mb-4">${title}</h3>
            <p class="text-slate-600 mb-6">${message}</p>
            <button id="info-modal-ok-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">OK</button>
        </div>
    `;

    document.body.appendChild(modal);

    const okBtn = modal.querySelector('#info-modal-ok-btn');

    const closeModalAndRedirect = () => {
        modal.remove();
        if (redirectUrl) {
            window.location.href = redirectUrl;
        }
    };

    okBtn.addEventListener('click', closeModalAndRedirect);

    // Si une durée est spécifiée, on ferme et redirige automatiquement
    if (duration > 0) {
        setTimeout(closeModalAndRedirect, duration);
    }
}
function showForgotPasswordView() {
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-48 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mb-2">Mot de passe oublié ?</h2>
            <p class="text-center text-slate-500 mb-6">Pas de panique ! Entrez votre e-mail pour recevoir un lien de réinitialisation.</p>
            <form id="forgotPasswordForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail du compte" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Envoyer le lien</button>
            </form>
            <p class="text-center text-sm text-slate-500">
                <button id="backToLoginButton" class="font-semibold text-primary-action hover:underline">Retour à la connexion</button>
            </p>
            <p id="authMessage" class="text-green-600 text-center mt-4"></p>
        </div>
    `;

    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const authMessage = document.getElementById('authMessage');

    forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const submitButton = forgotPasswordForm.querySelector('button[type="submit"]');
        
        // Amélioration : on désactive le bouton et on informe l'utilisateur
        submitButton.disabled = true;
        authMessage.textContent = "Envoi en cours...";
        authMessage.classList.remove('text-red-500');
        authMessage.classList.add('text-green-600');

        try {
            // On utilise fetch pour la cohérence avec le reste du code
            const functionUrl = 'https://europe-west3-monapp0rientation.cloudfunctions.net/sendTransactionalEmail'; // Assurez-vous que la région est la bonne
            await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data: {
                        templateId: 4, 
                        toEmail: email,
                        params: {}
                    }
                }),
            });
            authMessage.textContent = "Si un compte est associé à cette adresse, un e-mail de réinitialisation vient d'être envoyé.";
        } catch (error) {
            console.error("Erreur lors de l'appel de la fonction d'envoi :", error);
            authMessage.textContent = "Une erreur est survenue. Veuillez réessayer.";
            authMessage.classList.add('text-red-500');
        } finally {
            // On réactive le bouton à la fin
            submitButton.disabled = false;
        }
    });

    document.getElementById('backToLoginButton').addEventListener('click', showLoginView);
}


// ==================== DÉBUT DU BLOC COMPLET À REMPLACER ====================

// Cette fonction affiche le formulaire une fois le rôle choisi. Elle contient une grande partie de votre ancienne logique.
function renderSignupForm(role) {
    const isStudent = role === 'eleve';
    const formTitle = isStudent ? "Inscription Élève" : "Inscription Enseignant";

    const studentFieldsHTML = `
        <div id="student-school-container" class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-3">
            <label class="block text-md font-medium text-slate-700 mb-2">Comment te rattacher à ton lycée ?</label>
            <div class="flex gap-4 mb-2">
                <label class="flex items-center"><input type="radio" name="school_method" value="code" class="h-4 w-4 text-cyan-600" checked> <span class="ml-2 text-sm">Avec un code</span></label>
                <label class="flex items-center"><input type="radio" name="school_method" value="name" class="h-4 w-4 text-cyan-600"> <span class="ml-2 text-sm">Avec le nom</span></label>
            </div>
            <div id="school-code-field">
                <input id="schoolCode" type="text" placeholder="Code fourni par ton professeur" class="w-full p-3 border border-slate-300 rounded-lg">
            </div>
            <div id="school-name-field" class="hidden">
                <input id="schoolNameStudent" type="text" placeholder="Nom complet de ton lycée" class="w-full p-3 border border-slate-300 rounded-lg">
                <input id="schoolCityStudent" type="text" placeholder="Ville de ton lycée (Ex: Orléans)" class="w-full p-3 mt-2 border border-slate-300 rounded-lg">
            </div>
        </div>
    `;

    const teacherFieldsHTML = `
        <div id="teacher-school-container" class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-3 space-y-3">
            <div>
                <label class="block text-md font-medium text-slate-700">Votre établissement</label>
                <input id="schoolNameTeacher" type="text" placeholder="Nom complet de votre établissement" class="w-full p-3 mt-1 border border-slate-300 rounded-lg">
            </div>
            <div>
                <label class="block text-md font-medium text-slate-700">Ville de l'établissement</label>
                <input id="schoolCityTeacher" type="text" placeholder="Ex: Orléans" class="w-full p-3 mt-1 border border-slate-300 rounded-lg">
            </div>
            <div>
                <label class="block text-md font-medium text-slate-700">Nom de votre classe</label>
                <input id="className" type="text" placeholder="Ex: Première Générale 2" class="w-full p-3 mt-1 border border-slate-300 rounded-lg">
            </div>
        </div>
    `;

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mb-6">${formTitle}</h2>
            <form id="signupForm" data-role="${role}">
                <input id="firstName" type="text" placeholder="Prénom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="lastName" type="text" placeholder="Nom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                
                ${isStudent ? studentFieldsHTML : teacherFieldsHTML}

                <select id="gender" class="w-full p-3 mb-3 border border-slate-300 rounded-lg bg-white" required>
                    <option value="" disabled selected>Je suis...</option>
                    <option value="homme">Un homme</option>
                    <option value="femme">Une femme</option>
                    <option value="autre">Autre / Préfère ne pas préciser</option>
                </select>

                <input id="email" type="email" placeholder="Adresse e-mail${isStudent ? '' : ' académique'}" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe (6 caractères min.)" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4">
    <p class="text-sm text-slate-700 mb-2">
        En créant votre compte, vous acceptez la <button type="button" id="showPrivacyPolicyFromSignup" class="font-semibold text-primary-action hover:underline">Politique de Confidentialité</button> de l'application OrIAntation.
        Ceci autorise la collecte et l'utilisation de vos données pour personnaliser votre parcours d'orientation.
    </p>
    <div class="flex items-start">
        <input type="checkbox" id="consentCheckbox" class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 rounded mt-1" required>
        <label for="consentCheckbox" class="ml-2 block text-sm text-slate-700">
            J'ai lu et j'accepte la politique de confidentialité.
        </label>
    </div>
</div>
                
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700">Créer mon compte</button>
            </form>
            <div class="text-center mt-4">
                 <button id="back-to-choice-btn" class="text-sm font-semibold text-primary-action hover:underline">Retour au choix du profil</button>
            </div>
            <p id="authError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    // --- On ré-applique toutes vos logiques existantes ---

    if (Object.keys(signupFormData).length > 0) {
        document.getElementById('firstName').value = signupFormData.firstName || '';
        document.getElementById('lastName').value = signupFormData.lastName || '';
        if (isStudent) {
            document.getElementById('schoolNameStudent').value = signupFormData.schoolName || '';
        } else {
            document.getElementById('schoolNameTeacher').value = signupFormData.schoolName || '';
        }
        document.getElementById('gender').value = signupFormData.gender || '';
        document.getElementById('email').value = signupFormData.email || '';
        signupFormData = {}; 
    }

    if (isStudent) {
        const schoolCodeField = document.getElementById('school-code-field');
        const schoolNameField = document.getElementById('school-name-field');
        document.getElementsByName('school_method').forEach(radio => {
            radio.addEventListener('change', (e) => {
                schoolCodeField.classList.toggle('hidden', e.target.value !== 'code');
                schoolNameField.classList.toggle('hidden', e.target.value !== 'name');
            });
        });
    }

    document.getElementById('back-to-choice-btn').addEventListener('click', showSignupView);
    
    const showPrivacyPolicyButton = document.getElementById('showPrivacyPolicyFromSignup');
    showPrivacyPolicyButton.addEventListener('click', () => {
        const schoolName = !isStudent 
            ? document.getElementById('schoolNameTeacher')?.value 
            : document.getElementById('schoolNameStudent')?.value;

        signupFormData = {
            firstName: document.getElementById('firstName')?.value || '',
            lastName: document.getElementById('lastName')?.value || '',
            schoolName: schoolName || '',
            gender: document.getElementById('gender')?.value || '',
            email: document.getElementById('email')?.value || ''
        };
        cameFromAuth = true;
        authReturnView = 'signup';
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        showView('privacy');
    });

    const signupForm = document.getElementById('signupForm');
    const authError = document.getElementById('authError');
   // REMPLACEZ VOTRE addEventListener EXISTANT PAR CE BLOC COMPLET
// REMPLACEZ VOTRE addEventListener EXISTANT PAR CE BLOC COMPLET
signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    isNewUserFlow = true; // Lève le drapeau pour pauser l'écouteur onAuthStateChanged

    const authError = document.getElementById('authError');
    authError.textContent = '';
    
    const role = e.target.dataset.role;
    const isTeacher = role === 'enseignant';
    
    const email = document.getElementById('email').value;

    if (isTeacher) {
        const domain = email.split('@')[1];
        if (!approvedTeacherDomains.includes(domain)) {
            authError.textContent = "Inscription enseignant : veuillez utiliser une adresse e-mail académique valide.";
            isNewUserFlow = false; // Baisse le drapeau en cas d'erreur
            return;
        }
    }

    const firstName = capitalizeWords(document.getElementById('firstName').value);
    const lastName = capitalizeWords(document.getElementById('lastName').value);
    const gender = document.getElementById('gender').value;
    const password = document.getElementById('password').value;
    const userRole = role;
    
    let schoolId, schoolName, classId = null;
    let className = '';

    try {
        if (isTeacher) {
            schoolName = capitalizeWords(document.getElementById('schoolNameTeacher').value.trim());
            const schoolCity = capitalizeWords(document.getElementById('schoolCityTeacher').value.trim());
            className = document.getElementById('className').value.trim();
            if (!schoolName || !className || !schoolCity) {
                throw new Error("Le nom de l'établissement, la classe et la ville sont requis.");
            }
         const normalizedSchool = schoolName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\s]/g, "").replace(/\s+/g, '-');
         const normalizedCity = schoolCity.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\s]/g, "").replace(/\s+/g, '-');
            schoolId = `${normalizedSchool}-${normalizedCity}`;

            const normalizedClass = className.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
            const tempIdPart = Math.random().toString(36).substring(2, 6);
            classId = `${schoolId}-${normalizedClass}-${tempIdPart}`;
            
        } else { // Cas d'un élève
            const schoolMethod = document.querySelector('input[name="school_method"]:checked').value;
            if (schoolMethod === 'code') {
                const schoolCode = document.getElementById('schoolCode').value;
                if (!schoolCode) throw new Error("Le code d'établissement est requis.");
                const getSchool = httpsCallable(functions, 'getSchoolFromCode');
                const schoolResult = await getSchool({ code: schoolCode });
                schoolId = schoolResult.data.schoolId;
                schoolName = schoolResult.data.schoolName;
                classId = schoolResult.data.classId;
            } else { // Inscription manuelle d'un élève
                const schoolNameInput = document.getElementById('schoolNameStudent').value;
                const schoolCityInput = document.getElementById('schoolCityStudent').value;
                if (!schoolNameInput || !schoolCityInput) throw new Error("Le nom ET la ville du lycée sont requis.");
                schoolName = capitalizeWords(schoolNameInput.trim());
                const schoolCity = capitalizeWords(schoolCityInput.trim());
                const normalizedSchoolName = schoolName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\s]/g, "").replace(/\s+/g, '-');
                const normalizedCity = schoolCity.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9\s]/g, "").replace(/\s+/g, '-');
                schoolId = `${normalizedSchoolName}-${normalizedCity}`;
                const schoolDocRef = doc(db, "schools", schoolId);
                const schoolDoc = await getDoc(schoolDocRef);
                if (!schoolDoc.exists()) {
                    await setDoc(schoolDocRef, { name: schoolName, city: schoolCity, createdAt: new Date() });
                }
            }
        }

        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // ========== LA CORRECTION EST ICI ==========
        // On définit manuellement l'ID de l'utilisateur courant
        // pour que `loadData` puisse fonctionner immédiatement.
        currentUserId = user.uid;
        // ===========================================

        const userDocData = { firstName, lastName, schoolId, schoolName, gender, email, role: userRole, createdAt: new Date(), lastActivity: new Date() };
        
        if (classId) {
            userDocData.classId = classId;
        }

        await setDoc(doc(db, "users", user.uid), userDocData);

        if (isTeacher) {
            const setupClass = httpsCallable(functions, 'setupTeacherClass');
            const schoolCityForTeacher = document.getElementById('schoolCityTeacher').value.trim();
            await setupClass({ schoolName: schoolName, className: className, schoolCity: schoolCityForTeacher });
        }

        const templateIdToSend = isTeacher ? 2 : 1;
        const functionUrl = 'https://europe-west3-monapp0rientation.cloudfunctions.net/sendTransactionalEmail';
        await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { templateId: templateIdToSend, toEmail: user.email, params: { firstName: firstName } } }),
        });
        
        // Cet appel peut maintenant fonctionner car `currentUserId` est défini
        await loadData(); 

        // Redirection manuelle une fois que tout est terminé
        if (isTeacher) {
            showView('teacherDashboard');
        } else {
            showGradeSelectionView();
        }

    } catch (error) {
        console.error("Erreur lors de la création du compte :", error);
        authError.textContent = error.message || "Une erreur est survenue lors de la création du compte.";
    } finally {
        // On baisse le drapeau pour que onAuthStateChanged reprenne son fonctionnement normal
        isNewUserFlow = false;
    }
});
}

// Nouvelle fonction principale qui affiche l'écran de choix
function showSignupView() {
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    if (floatingBackBtn) {
        floatingBackBtn.style.display = 'none';
    }

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-auto w-auto">
            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mt-4 mb-2">Créer un compte</h2>
            <p class="text-center text-slate-500 mb-8">Qui êtes-vous ?</p>
            
            <div class="space-y-4">
                <button id="signup-as-student-btn" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                    <span>Je suis un élève</span>
                </button>
                <button id="signup-as-teacher-btn" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition flex items-center justify-center gap-3">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>
                    <span>Je suis un enseignant</span>
                </button>
            </div>
            
            <p class="text-center text-sm text-slate-500 mt-8">Déjà un compte ? 
                <button id="showLoginButton" class="font-semibold text-primary-action hover:underline">Connectez-vous</button>
            </p>
        </div>
    `;

    // On attache les événements aux boutons de choix du profil
    document.getElementById('signup-as-student-btn').addEventListener('click', () => renderSignupForm('eleve'));
    document.getElementById('signup-as-teacher-btn').addEventListener('click', () => renderSignupForm('enseignant'));
    document.getElementById('showLoginButton').addEventListener('click', showLoginView);
}

// ==================== FIN DU BLOC COMPLET À REMPLACER ====================

// 🔹 Rendre la fonction showView accessible globalement
window.showView = showView;
window.deleteUserAccount = deleteUserAccount; 

           function getCurrentSchoolYear() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth(); // 0 pour Janvier, 11 pour Décembre

    // On considère que la nouvelle année scolaire commence en août (mois 7)
    // Si nous sommes en juillet 2025 (mois 6), l'année scolaire est 2024.
    // Si nous sommes en août 2025 (mois 7), l'année scolaire est 2025.
    return (month >= 7) ? year : year - 1;
}


async function saveData(context = {}) { // Le contexte est conservé pour skipOnboarding
    if (!currentUserId) return;
    const userDocRef = doc(db, "users", currentUserId);

    // On ne sauvegarde que ce qui est susceptible de changer durant une session
    const dataToSave = {
        gradeLevel: userGradeLevel,
        journal: journalData,
        lastActivity: new Date() // <-- LA CORRECTION CLÉ : on met à jour la date ici aussi
    };
    
    try {
        // Le { merge: true } garantit qu'on ne touche pas aux autres champs (prénom, nom, etc.)
        await setDoc(userDocRef, dataToSave, { merge: true });
    } catch (error) {
        console.error("Error saving document: ", error);
    }
}

        async function triggerSurpriseMoment() {

            const isStep0Done = isStepComplete('step0');
            const isStep10Done = isStepComplete('step10');

    // Si l'une des deux étapes de base n'est pas terminée, on ne lance JAMAIS de surprise.
    if (!isStep0Done || !isStep10Done) {
        return; // Sortie anticipée de la fonction
    }
            // Règle 1: Ne pas afficher de surprise si la dernière date de moins de 2 heures
            const now = new Date().getTime();
            const lastSurprise = journalData.last_surprise_timestamp || 0;
            const hoursSinceLastSurprise = (now - lastSurprise) / (1000 * 60 * 60);
            if (hoursSinceLastSurprise < 1) { // 1 heure de délai
                return;
            }

            // Règle 2: Réduire la probabilité d'apparition (15% de chance au lieu de 25%)
            if (Math.random() > 0.15) {
                return;
            }
            
            // Pour éviter les conflits, ne pas lancer si un autre modal est déjà ouvert
            if (document.querySelector('.simulation-modal, .portfolio-modal, #simple-info-modal, #surprise-modal')) return;


            const currentLevel = journalData.level || 1;
            const currentXp = journalData.xp || 0;
            const xpForCurrentLevel = levelConfig[currentLevel];
            const xpForNextLevel = levelConfig[currentLevel + 1];
            const xpInCurrentLevel = currentXp - xpForCurrentLevel;
            // On gère le cas où l'élève est au niveau maximum
            const xpNeededForLevel = xpForNextLevel ? xpForNextLevel - xpForCurrentLevel : Infinity; 

            let surprisesPossibles = [];

            // --- 1. SURPRISES LIÉES AU PROFIL (ÉTAPE 0) ---

            // Si l'élève a des traits 'Artistes' mais un portfolio vide
            const aDesTraitsArtistes = journalData.step0 && (journalData.step0.q16 === 'artistique' || journalData.step0.q19 === 'artistique' || journalData.step0.q20 === 'artistique');
            const portfolioVide = !journalData.step10.experiences || journalData.step10.experiences.length === 0;
            if (aDesTraitsArtistes && portfolioVide) {
                surprisesPossibles.push({
                    title: "Piste de réflexion...",
                    content: "J'ai remarqué que tu as des centres d'intérêt artistiques. N'oublie pas que tu peux valoriser tes projets créatifs (dessin, musique, écriture...) dans ton <strong>Portfolio de Compétences</strong> ! Ça peut faire toute la différence."
                });
            }
            
            // Si l'élève a des traits 'Entreprenants' mais n'a pas exploré de métiers de management
            const aDesTraitsEntreprenants = journalData.step0 && (journalData.step0.q17 === 'entreprenant' || journalData.step0.q18 === 'entreprenant');
            const aExploreManagement = (journalData.step1.metier1.includes('manage') || journalData.step1.metier2.includes('manage') || journalData.step1.metier3.includes('manage'));
            if (aDesTraitsEntreprenants && !aExploreManagement) {
                surprisesPossibles.push({
                    title: "Ton profil de leader...",
                    content: "Ton profil montre que tu aimes diriger et convaincre. As-tu déjà exploré des métiers liés au <strong>management de projet</strong> ou à la <strong>création d'entreprise</strong> ? Le Radar à Opportunités pourrait te surprendre !"
                });
            }

            // Si l'élève est plutôt 'Introverti' et explore des métiers de contact
            const estIntroverti = journalData.step0 && journalData.step0.q10 === 'introversion';
            const aExploreMetierSocial = (journalData.step1.metier1.toLowerCase().includes('social') || journalData.step1.metier1.toLowerCase().includes('enseignant') || journalData.step1.metier1.toLowerCase().includes('infirmier'));
            if (estIntroverti && aExploreMetierSocial) {
                surprisesPossibles.push({
                    title: "Une question pour toi...",
                    content: "C'est super de t'intéresser aux métiers du contact ! Ton profil suggère que tu recharges tes batteries en étant seul(e). Pense à utiliser le simulateur de <strong>'Journée Type'</strong> pour voir si le rythme te conviendrait."
                });
            }

            // Si l'élève est 'Curieux' et n'a pas fait de quiz
            const estCurieux = journalData.step0 && journalData.step0.q14 === 'curieux';
            const aFaitQuiz = journalData.step7.scores && Object.keys(journalData.step7.scores).length > 0;
            if (estCurieux && !aFaitQuiz) {
                surprisesPossibles.push({
                    title: "Pour les esprits curieux...",
                    content: "Ton profil montre une grande curiosité ! Pour la nourrir, pourquoi ne pas te lancer un défi avec l'étape <strong>'Fact Checking'</strong> ? C'est un excellent moyen de déconstruire les idées reçues."
                });
            }
            
            // --- 2. SURPRISES LIÉES À L'EXPLORATION (ÉTAPES 1 à 5) ---

            // Si l'élève a exploré au moins 2 métiers mais n'a pas utilisé le comparateur
            const metiersExplores = [journalData.step1.metier1, journalData.step1.metier2, journalData.step1.metier3].filter(m => m && m.trim() !== '').length;
            const comparateurNonUtilise = !journalData.step1.comparison || journalData.step1.comparison.trim() === '';
            if (metiersExplores >= 2 && comparateurNonUtilise) {
                surprisesPossibles.push({
                    title: "Astuce d'expert !",
                    content: "Super, tu as exploré plusieurs métiers ! Pour t'aider à y voir plus clair, pense à utiliser le <strong>Comparateur de Métiers</strong> en bas de l'étape 'Les Fondations'. Il te créera un tableau de synthèse personnalisé."
                });
            }
            
            // Si l'élève a mis des formations dans le catalogue mais pas de métier correspondant
            const aExploreFormations = journalData.step3 && journalData.step3.formation1.trim() !== '';
            if (aExploreFormations && metiersExplores === 0) {
                surprisesPossibles.push({
                    title: "Connecte les points !",
                    content: "Tu as commencé à explorer des formations, c'est génial ! Pour bien comprendre où elles mènent, n'oublie pas de remplir l'étape <strong>'Les Fondations'</strong> pour découvrir les métiers concrets auxquels elles préparent."
                });
            }

            // Si l'élève est en Terminale et que la date approche de Parcoursup (Janvier)
            const isTerminale = userGradeLevel === 'terminale';
            const isParcoursupTime = new Date().getMonth() >= 0 && new Date().getMonth() <= 2; // Janvier à Mars
            const candidatureVide = !journalData.step6.formation || journalData.step6.formation.trim() === '';
            if (isTerminale && isParcoursupTime && candidatureVide) {
                surprisesPossibles.push({
                    title: "Parcoursup approche !",
                    content: "La période de formulation des vœux est ouverte ! Pense à utiliser l'étape <strong>'Préparer sa candidature'</strong> pour commencer à rédiger tes projets de formation motivés. Chaque minute passée dessus est un bon investissement !",
                    levels: ['terminale']
                });
            }
            
            // Si l'élève a fait un quiz et a eu un mauvais score
            const aFaitUnQuiz = journalData.step7.domaine && journalData.step7.scores[journalData.step7.domaine];
            if(aFaitUnQuiz) {
                const lastQuiz = journalData.step7.scores[journalData.step7.domaine].slice(-1)[0];
                if(lastQuiz && (lastQuiz.score / lastQuiz.total) < 0.5) {
                    surprisesPossibles.push({
                        title: "L'erreur est une étape !",
                        content: `Ne t'inquiète pas pour ton dernier score au quiz sur "${journalData.step7.domaine}". Le plus important est ce que tu as appris ! Relis tes notes et n'hésite pas à explorer ce domaine dans l'étape <strong>'L'Actu'</strong> pour approfondir.`
                    });
                }
            }
            
            // --- 3. SURPRISES LIÉES À L'ACTION (ÉTAPES 8 à 12) ---

            // Si l'élève n'a ajouté aucun contact
            const aAucunContact = !journalData.step8.contacts || journalData.step8.contacts.length === 0;
            if(metiersExplores > 0 && aAucunContact) {
                 surprisesPossibles.push({
                    title: "Passe à la vitesse supérieure !",
                    content: "La recherche en ligne, c'est bien. Le contact humain, c'est mieux ! Utilise l'étape <strong>'Passer à l'action'</strong> pour trouver des professionnels à qui poser tes questions."
                });
            }
            
            // Si le rétroplanning a été généré mais aucune tâche n'est cochée après un certain temps
            // (Cette logique nécessiterait de stocker la date de génération, donc on simplifie)
            
            // Si l'élève est en Terminale et n'a pas encore réfléchi à un plan B
            const planBVide = !journalData.step9.planb_chat_history || journalData.step9.planb_chat_history.length === 0;
            if(isTerminale && aExploreFormations && planBVide) {
                 surprisesPossibles.push({
                    title: "Et si... ?",
                    content: "C'est super d'avoir des objectifs clairs ! Mais les meilleurs stratèges ont toujours un plan B. Prends 5 minutes pour lancer la simulation de <strong>'Plan B'</strong> dans l'étape 'Anticiper la suite'. Mieux vaut prévenir que guérir !",
                    levels: ['terminale']
                });
            }

            // Si le simulateur de vie étudiante n'a pas été utilisé
            const aUtiliseSimulateurVieEtu = journalData.step12 && journalData.step12.city;
            if(aExploreFormations && !aUtiliseSimulateurVieEtu) {
                surprisesPossibles.push({
                    title: "Un détail qui compte...",
                    content: "Tu as trouvé des formations qui t'intéressent, bravo ! As-tu pensé au coût de la vie sur place ? Utilise le <strong>'Simulateur Vie Étudiante'</strong> pour te faire une idée concrète.",
                    levels: ['terminale']
                });
            }
            
            // --- 4. SURPRISES LIÉES À LA GAMIFICATION (XP, BADGES) ---
            
            // Si l'élève est proche de passer un niveau
            const xpToNextLevel = xpNeededForLevel - xpInCurrentLevel;
            if(xpToNextLevel > 0 && xpToNextLevel < 50) {
                 surprisesPossibles.push({
                    title: "Presque ! 💪",
                    content: `Il ne te manque que <strong>${xpToNextLevel} XP</strong> pour atteindre le niveau suivant ! Une petite action comme utiliser le Radar ou faire un quiz pourrait te faire passer au rang de <strong>${rankNames[currentLevel + 1]['autre']}</strong> !`
                });
            }
            
            // Si l'élève n'a aucun badge
            if(journalData.earned_badges.length === 0 && metiersExplores > 0) {
                 surprisesPossibles.push({
                    title: "Collectionne-les tous !",
                    content: "Savais-tu que tu pouvais débloquer des badges en complétant certaines étapes ? Par exemple, le <strong>Badge de l'Explorateur</strong> récompense ceux qui terminent les premières étapes clés. Consulte le guide pour en savoir plus !"
                });
            }
            
            // --- 5. SURPRISES GÉNÉRALES ---
            
            // Rappel de mettre à jour le Fil Rouge
            if(journalData.xp > 500 && (!journalData.fil_rouge || journalData.fil_rouge.length < 20)) {
                 surprisesPossibles.push({
                    title: "Fais le point !",
                    content: "Tu as déjà beaucoup exploré ! C'est peut-être le bon moment pour mettre à jour ton <strong>'Fil Rouge'</strong> dans le Journal de Bord. OrIA peut t'aider à synthétiser ton parcours."
                });
            }
            
            // Encouragement à partager
            const aPartage = journalData.share_token;
            if(journalData.xp > 300 && !aPartage) {
                 surprisesPossibles.push({
                    title: "Et si on en parlait ?",
                    content: "Parler de son orientation, c'est essentiel. Pense à utiliser la fonction de <strong>partage</strong> de ton Journal de Bord pour échanger avec tes parents ou ton professeur principal."
                });
            }

            // --- Sélection et affichage d'une surprise aléatoire parmi les possibles ---
            if (surprisesPossibles.length > 0) {
                const surpriseFinale = surprisesPossibles[Math.floor(Math.random() * surprisesPossibles.length)];
                showSurpriseModal(surpriseFinale.title, surpriseFinale.content);
            }
        }
     
        const defaultData = {
                step0: { 
                q1: '', q2: '', q3: '', q4: '', q5: '', q6: '', q7: '', q8: '', q9: '', q10: '', 
                q11: '', q12: '', q13: '', q14: '', q15: '', q16: '', q17: '', q18: '', q19: '', q20: '', q21: '', 
                situation: '', // <--- AJOUTEZ CETTE LIGNE
                analysis: '', 
                archetype: null, 
                test_interets: '',
                test_motivation: '',
                test_personnalite: '',
                analyse_tests_croisee: '' },    
                step1: { explored_metiers: [], comparison: '' },
                step2: { combo1: '', notes1: '', skills1: '', combo2: '', notes2: '', skills2: '', combo3: '', notes3: '', skills3: '' },
                step3: { formation1: '', attendus1: '', mots_cles1: '', analyse_mots_cles1: '', formation2: '', attendus2: '', mots_cles2: '', analyse_mots_cles2: '', suggestions: '' },
                step4: { theme1: '', question1: '', suggestions1: '', theme2: '', question2: '', suggestions2: '' },
                step5: {
                article1: '', apprentissage1: '',
                article2: '', apprentissage2: '',
                article3: '', apprentissage3: '',
                analyse_actu: ''
            },
                step6: { formation: '', motivations: '', structure: '' },
                step7: { 
                domaine: '', 
                reflexions: '',
                scores: {}
            },
                step8: { pro_reseau_personnel: '', pro_metier: '', pro_departement: '', pro_contacts: '', pro_strategie: '', pro_media_query: '', pro_media_content: '', jpo_ecole: '', jpo_questions: '' },
                step9: { 
                formation_reve: '', 
                planb_chat_history: [],
                reussite_type: '', 
                reussite_conseils: '' 
            },
                step10: { experience1: '', analyse1: '', experience2: '', analyse2: '' },
                step11: { 
                location: '', 
                evenements: [], 
                structures: [],
                jpo_ecole: '',
                jpo_questions: '',
                salon_nom: '',
                salon_preparation: ''
            },
                retroplanning: '',
                retroplanning_saves: [], 
                fil_rouge: '',
                discussion_points: '',
                radar_history: [],
                earned_badges: [],
                xp: 0,
                level: 1,
                chatbot_last_interaction: null,
                chatbot_saves: [],
                tutorial_mission_1_shown: false,
                tutorial_mission_2_shown: false,
    // ▼▼▼ AJOUTEZ CETTE LIGNE ▼▼▼
                tutorial_mission_3_shown: false, 
                tutorial_completed: false,
                tutorial_next_step: '',


            };
            
            async function loadData() {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            const docSnap = await getDoc(userDocRef);
            let data = docSnap.exists() ? docSnap.data() : {};
            
            userGradeLevel = data.gradeLevel || null;
            currentUserInfo = {
                firstName: data.firstName || '',
                lastName: data.lastName || '',
                schoolName: data.schoolName || '',
                gender: data.gender || 'autre',// <-- AJOUTEZ CETTE LIGNE (avec une valeur par défaut)
                role: data.role || 'eleve' // ✅ AJOUT : On charge le rôle (par défaut "eleve")


            };

        
            const loadedJournal = data.journal || {};
            
            journalData = {};
            for (const key in defaultData) {
        // On ajoute une condition spéciale pour les tableaux (Array)
        if (Array.isArray(defaultData[key])) {
            journalData[key] = loadedJournal[key] || defaultData[key];
        }
        // La logique existante pour les objets
        else if (loadedJournal[key] && typeof defaultData[key] === 'object' && defaultData[key] !== null) {
            journalData[key] = { ...defaultData[key], ...loadedJournal[key] };
        } 
        // La logique par défaut pour le reste
        else {
             journalData[key] = loadedJournal[key] || defaultData[key];
        }
    }
    
    // Cette vérification supplémentaire est une bonne pratique
    if (!Array.isArray(journalData.radar_history)) {
        journalData.radar_history = [];
    }
    if (!Array.isArray(journalData.earned_badges)) {
        journalData.earned_badges = [];
    }
    
    checkBadges();

}


    function getProfileSummary() {
    let summary = "Voici un résumé du profil de l'élève :\n";
    if (journalData.step0?.archetype?.titre) {
        summary += `- Son archétype de personnalité : ${journalData.step0.archetype.titre}\n`;
    }
    if (journalData.step0?.analysis) {
        summary += `- Analyse de son profil : "${journalData.step0.analysis}"\n`;
    }
    // MODIFICATION ICI : On lit le tableau de métiers
    if (journalData.step1?.metiers && journalData.step1.metiers.length > 0) {
        const metiers = journalData.step1.metiers.map(m => m.nom).join(', ');
        summary += `- Métiers déjà explorés : ${metiers}\n`;
    }
// NOUVELLE LIGNE
const formations = (journalData.step3?.formations || []).map(f => f.nom).filter(nom => nom && nom.trim());    if (formations.length > 0) {
        summary += `- Formations déjà explorées : ${formations.join(', ')}\n`;
    }
    if (journalData.step10?.soft_skills_profile) {
        summary += `- Résumé de ses compétences : "${journalData.step10.soft_skills_profile}"\n`;
    }
    if (summary === "Voici un résumé du profil de l'élève :\n") {
        return "L'élève n'a pas encore rempli suffisamment son profil. Base-toi sur le bon sens et l'idée qu'il propose.";
    }
    return summary;
}

function formatDateAgo(date) {
    if (!date) return "Jamais";
    const now = new Date();
    // On s'assure que 'date' est bien un objet Date
    const activityDate = (typeof date.toDate === 'function') ? date.toDate() : new Date(date);
    const seconds = Math.floor((now - activityDate) / 1000);
    
    let interval = seconds / 86400; // secondes en jours
    if (interval > 7) return activityDate.toLocaleDateString('fr-FR');
    if (interval > 1.5) return `il y a ${Math.floor(interval)} jours`;
    if (interval > 0.8) return "hier";
    
    interval = seconds / 3600; // secondes en heures
    if (interval > 1) return `il y a ${Math.floor(interval)} heures`;
    
    interval = seconds / 60; // secondes en minutes
    if (interval > 1) return `il y a ${Math.floor(interval)} minutes`;
    
    return "à l'instant";
}
        function getCompletionSummary() {
    let completed = [];
    let inProgress = [];

    allSteps.forEach(step => {
        if (['journal', 'retroplanning', 'guide'].includes(step.id)) return;

        if (isStepComplete(step.id)) {
            completed.push(`'${step.title}'`);
        } else {
            const stepData = journalData[step.id];
            if (stepData && typeof stepData === 'object') { // On vérifie que stepData est un objet
                const values = Object.values(stepData);
                const filledCount = values.filter(v => {
                    if (Array.isArray(v)) return v.length > 0;
                    return v && v.toString().trim() !== '';
                }).length;
                if (filledCount > 0) {
                    inProgress.push(`'${step.title}'`);
                }
            }
        }
    });

    let summary = "Voici un résumé de sa progression dans l'application :\n";
    if (completed.length > 0) {
        summary += `- Étapes déjà terminées : ${completed.join(', ')}.\n`;
    }
    if (inProgress.length > 0) {
        summary += `- Étapes actuellement en cours : ${inProgress.join(', ')}.\n`;
    }
    if (completed.length === 0 && inProgress.length === 0) {
        summary += "- L'élève n'a pas encore commencé à explorer les étapes.\n";
    }
    return summary;
}

function getAppFeaturesSummary() {
    let summary = "Voici la liste des fonctionnalités de l'application OrIAntation :\n";
    for (const stepKey in stepsConfig) {
        const config = stepsConfig[stepKey];
        let actionDescription = '';
        if (typeof config.action === 'string') {
            actionDescription = config.action.replace(/<b>Ta mission :<\/b>/i, '').trim();
        } else if (typeof config.action === 'object') {
            actionDescription = (config.action[userGradeLevel] || config.action.default || '').replace(/<b>.*?<\/b>/i, '').replace(/<ol>.*?<\/ol>/is, '').replace(/<[^>]*>/g, ' ').trim();
        }
        summary += `- Étape '${config.title}': ${actionDescription}\n`;
    }
    return summary;
}

    async function grantXp(points) {
            if (!journalData) return;

            journalData.xp = (journalData.xp || 0) + points;
            let currentLevel = journalData.level || 1;
            let leveledUp = false; // On utilise un indicateur pour savoir si un niveau a été gagné

            // On vérifie si l'utilisateur passe un ou plusieurs niveaux
            while (levelConfig[currentLevel + 1] && journalData.xp >= levelConfig[currentLevel + 1]) {
                currentLevel++;
                journalData.level = currentLevel;
                leveledUp = true;
            }
            
            // On sauvegarde les nouvelles données (XP et niveau)
            await saveData();

            // Si un niveau a été gagné, on affiche la nouvelle fenêtre personnalisée
            if (leveledUp) {
                // CORRECTION DU BUG [object Object] : On sélectionne le bon titre
                const userGender = currentUserInfo.gender || 'autre';
                const rankTitle = rankNames[journalData.level][userGender] || rankNames[journalData.level]['autre'];

                const title = `🎉 Montée de Niveau !`;
                const contentHTML = `
                    <p class="text-slate-600">Bravo, tu as atteint le</p>
                    <p class="text-2xl font-bold text-cyan-700 my-2">Niveau ${journalData.level} : ${rankTitle}</p>
                    <p class="text-slate-600">Continue sur cette lancée pour découvrir tout ton potentiel !</p>
                `;
                
                // On réutilise la fonction d'affichage des surprises pour un design cohérent
                showSurpriseModal(title, contentHTML);
            }

            // On met à jour l'affichage du menu s'il est actuellement visible
            const menuView = document.querySelector('.fade-in');
            if (menuView && menuView.querySelector('#xp-chart')) {
                showView('menu');
            }
    
        }

        

function isStepStarted(stepKey) {
    const stepData = journalData[stepKey];
    if (!stepData) return false;

    // On vérifie si au moins une des valeurs dans les données de l'étape n'est pas "vide"
    return Object.values(stepData).some(value => {
        // IMPORTANT : On vérifie d'abord si la valeur est null ou undefined
        if (value === null || value === undefined) {
            return false;
        }
        // ENSUITE, on vérifie si c'est un objet (qui n'est pas null)
        if (typeof value === 'object') {
            return Object.keys(value).length > 0; // Un objet est "commencé" seulement s'il a des clés
        }
        // Enfin, pour les chaînes de caractères et autres
        return value.toString().trim() !== '';
    });
}

       // Remplacez votre fonction showMenuAndWelcomeCheck par celle-ci

function showMenuAndWelcomeCheck() {
    showView('menu'); // Affiche le menu principal

    const nextStepId = journalData.tutorial_next_step;
    const isTutorialDone = journalData.tutorial_completed;

    // --- CAS N°1 : L'élève est un TOUT NOUVEL utilisateur ---
    // Grâce à la correction de isStepStarted, cette condition fonctionnera à nouveau.
    if (!isStepStarted('step0')) {
        setTimeout(() => {
            showWelcomeModal();
        }, 1500);
        return; 
    }

    // --- CAS N°2 : L'élève revient en cours de tutoriel ---
    if (nextStepId && !isTutorialDone) {
        const nextStepDetails = allSteps.find(step => step.id === nextStepId);
        
        if (nextStepDetails) {
            setTimeout(() => {
                showSurpriseModal(
                    "Mission en cours... 🎯",
                    `<p>Ravi de te revoir ! N'oublie pas, ta prochaine mission est de compléter l'étape :</p>
                     <p class="mt-4 text-xl font-bold text-cyan-700">${nextStepDetails.title}</p>
                     <p class="text-sm text-slate-500 mt-2">Elle est mise en surbrillance sur le menu pour t'aider !</p>`
                );
            }, 1000);
        }
    }
}

function showWelcomeModal() {
    const title = `Bienvenue sur OrIAntation, ${currentUserInfo.firstName} ! 👋`;
    const contentHTML = `
        <p class="text-slate-600"> Je suis là pour t'aider sur les débuts de ton aventure.</p>
        <p class="mt-4 font-semibold text-azimut-darkblue">Pour bien commencer, ta première mission est de nous permettre de faire connaissance. Clique sur l'étape "Mieux se connaître", réponds au questionaire pour générer ton analyse de profil et clique enfin sur le bouton terminer pour passer à la suite!</p>
    `;
    showSurpriseModal(title, contentHTML);
}
        
      // ✅ NOUVELLE VERSION DE LA FONCTION

// REMPLACEZ votre fonction showGradeSelectionView par celle-ci
function showGradeSelectionView() {
    mainApp.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in text-center">
            <h1 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Bienvenue !</h1>
            <p class="text-slate-600 mb-6">Pour commencer et personnaliser ton parcours, sélectionne ta classe :</p>
            <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                <button data-grade="seconde" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Seconde</button>
                <button data-grade="premiere" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Première</button>
                <button data-grade="terminale" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Terminale</button>
            </div>
        </div>
    `;

    mainApp.querySelectorAll('.grade-btn').forEach(button => {
    button.addEventListener('click', async (e) => {
        userGradeLevel = e.target.dataset.grade; 
        await saveData(); 
        await loadData();
        showMenuAndWelcomeCheck(); // <-- APPEL CORRIGÉ
    });
});
}


async function callOpenAI_API({ promptText, model = 'gpt-4o', isJson = false, withPersona = false, promptId = null, loaderElement = null, isExpertCall = false, customLoaderHTML = null }) {
    let finalPrompt = promptText;
    if (withPersona) { finalPrompt = `${PERSONA_IA}\n\n# Ta Mission Spécifique\n${promptText}`; }
    finalPrompt = addGenderContextToPrompt(finalPrompt);
    if (isJson) { finalPrompt += "\n\n# Format de Sortie OBLIGATOIRE\nTa réponse doit être uniquement un objet JSON valide..."; }

    const functionUrl = "https://europe-west3-monapp0rientation.cloudfunctions.net/generateContent";
    
    // ✅ CORRECTION : Le message ne s'affiche que si 'isExpertCall' est vrai
    if (loaderElement) {
    if (customLoaderHTML) {
        // Si un texte personnalisé est fourni, on l'utilise
        loaderElement.innerHTML = customLoaderHTML;
    } else if (isExpertCall) {
        // Sinon, on utilise le texte par défaut pour les appels "Expert"
        loaderElement.innerHTML = `
            <div class="loader"></div>
            <p class="text-slate-500 font-semibold mt-2">Te voilà au cœur du réacteur...</p>
            <p class="text-sm text-slate-400 mt-1">Analyse fondamentale en cours, cela peut prendre un instant...</p>
        `;
    }
}
    
    let bodyPayload;
    if (promptId) {
        bodyPayload = { promptId: promptId, variables: { mission: finalPrompt } };
    } else {
        bodyPayload = { prompt: finalPrompt, model: model };
    }

    try {
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyPayload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Erreur du serveur: ${errorData.error || response.statusText}`);
        }

        const data = await response.json();
        return data.result;

    } catch (error) {
        console.error("Error calling Cloud Function:", error);
        // ✅ LA CORRECTION EST ICI : On retourne une chaîne de caractères en cas d'erreur
        return `Impossible de contacter le service d'IA. (${error.message})`;
    }
}

function addGenderContextToPrompt(prompt) {
    // On récupère le genre de l'utilisateur, sauvegardé à l'inscription
    const gender = currentUserInfo.gender || 'autre'; 
    let genderInstruction = '';

    if (gender === 'femme') {
        genderInstruction = "Règle de ton absolue : L'élève que tu aides est une fille. Tu dois impérativement accorder toute ta réponse au féminin (adjectifs, noms de métiers, etc.). Par exemple, écris 'tu es créative et organisée', 'une exploratrice', 'une experte'.";
    } else if (gender === 'homme') {
        genderInstruction = "Règle de ton absolue : L'élève que tu aides est un garçon. Tu dois impérativement accorder toute ta réponse au masculin. Par exemple, écris 'tu es créatif et organisé', 'un explorateur', 'un expert'.";
    } else {
        genderInstruction = "Règle de ton absolue : Le genre de l'élève n'est pas spécifié ou est 'autre'. Utilise une écriture inclusive ou neutre (ex: 'créatif/créative', 'un(e) expert(e)') pour t'adresser à la personne.";
    }

    // On ajoute cette instruction au début du prompt original
    return `${genderInstruction}\n\n---\n\n${prompt}`;
}
       
async function showView(viewName, data = null) { // MODIFICATION ICI
    currentViewName = viewName; // <-- AJOUTEZ CETTE LIGNE
    authContainer.style.display = 'none';
    mainApp.style.display = 'block';
    mainApp.innerHTML = '';
    
    if (viewName === 'menu') {
        triggerSurpriseMoment();
    }
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const floatingBackBtn = document.getElementById('floatingBackBtn');

    // Note: 'privacyPolicy' est ajouté ici pour cacher le bouton de retour sur cette vue
    const showChatbotOn = ['menu', 'home', 'step0', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9', 'step10', 'step11', 'step12', 'retroplanning', 'journal'];
const showBackButtonOn = ['step0', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9', 'step10', 'step11', 'step12', 'retroplanning', 'journal', 'guide', 'privacy'];

    if (chatbotToggle) {
        if (showChatbotOn.includes(viewName)) {
            chatbotToggle.style.display = 'flex';
        } else {
            chatbotToggle.style.display = 'none';
        }
    }
    
    if (floatingBackBtn) {
    // Logique simplifiée : Le bouton est affiché si la page est dans la liste.
    // Le code qui gère le clic décidera de la bonne action de retour.
    if (showBackButtonOn.includes(viewName)) {
        floatingBackBtn.style.display = 'flex';
    } else {
        floatingBackBtn.style.display = 'none';
    }
}

    let newView;
    switch(viewName) {
        case 'home': newView = createHomeView(); break;
        case 'menu': newView = createMenuView(); break;
        case 'step0': newView = createStep0View(); break;
        case 'step1': newView = createStep1View(); break;
        case 'step2': newView = createStep2View(); break;
        case 'step3': newView = createStep3View(); break;
        case 'step4': newView = createStep4View(); break;
        case 'step5': newView = createStep5View(); break;
        case 'step6': newView = createStep6View(); break;
        case 'step7': newView = createStep7View(); break;
        case 'step8': newView = createStep8View(); break;
        case 'step9': newView = createStep9View(); break;
        case 'step10': newView = createStep10View(); break;
        case 'step11': newView = createStep11View(); break;
        case 'step12': newView = createStep12View(); break;
        case 'guide': newView = createGuideView(); break;
        case 'retroplanning': newView = createRetroplanningView(); break;
        case 'journal': newView = await createJournalView(); break;
        case 'teacherDashboard': newView = createTeacherDashboardView(); break; // ⬅️ NOUVEAU
        case 'teacherStudentJournal': newView = createTeacherStudentJournalView(data); break;
        case 'privacy': newView = createPrivacyPolicyView(); break;
        default: newView = createHomeView();
    }
    if (newView) mainApp.appendChild(newView);
    window.scrollTo(0, 0);
}
        
function createMenuView() {
    const div = document.createElement('div');
    div.className = 'fade-in';

    // --- 1. Logique pour le haut du menu (Données utilisateur, XP, Badges) ---
    const currentLevel = journalData.level || 1;
    const currentXp = journalData.xp || 0;
    const xpForCurrentLevel = levelConfig[currentLevel];
    const xpForNextLevel = levelConfig[currentLevel + 1] || Infinity;
    const xpInCurrentLevel = currentXp - xpForCurrentLevel;
    const xpNeededForLevel = xpForNextLevel - xpForCurrentLevel;
    const userGender = currentUserInfo.gender || 'autre';
    const rankTitle = rankNames[currentLevel] ? (rankNames[currentLevel][userGender] || rankNames[currentLevel]['autre']) : 'Débutant';
    
    let badgesHTML = '';
    const earnedBadges = journalData.earned_badges || [];

    if (earnedBadges.length > 0) {
        const lastBadgeKey = earnedBadges[earnedBadges.length - 1];
        const lastBadge = badgesConfig[lastBadgeKey];
        if (lastBadge) {
            badgesHTML = `<div class="flex flex-col items-center justify-center h-full w-full text-center p-2"><span class="text-5xl">${lastBadge.icon}</span><p class="font-bold text-OrIAntation-darkblue text-xs mt-2 leading-tight">${lastBadge.title}</p></div>`;
        }
    } else {
        badgesHTML = `<div class="w-full h-full bg-cover bg-center bg-no-repeat rounded-full" style="background-image: url('logo_badges.png');"></div>`;
    }

let teacherButtonHTML = '';
if (currentUserInfo.role === 'enseignant') {
    teacherButtonHTML = `
        <div class="text-center mb-4">
            <button onclick="showView('teacherDashboard')" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-600 transition">
                Accéder à mon Tableau de Bord Enseignant
            </button>
        </div>
    `;
}

    const levelDisplayHTML = `
    <div class="mb-10 bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
        <div class="flex flex-wrap justify-center items-center gap-6 md:flex-nowrap md:justify-between">
            <div class="relative w-32 h-32 cursor-pointer flex-shrink-0 js-xp-gauge order-2 md:order-1">
                <canvas id="xp-chart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                    <span class="font-bold text-2xl text-OrIAntation-darkblue">${xpInCurrentLevel}</span>
                    <span class="text-xs text-slate-500">/${xpNeededForLevel} XP</span>
                </div>
            </div>
            <div class="text-center w-full md:w-auto order-1 md:order-2">
                <h1 class="text-3xl font-bold text-OrIAntation-darkblue">Choisis ton cap, ${capitalizeWords(currentUserInfo.firstName)} !</h1>
                <p class="text-slate-500 mt-2 text-sm">en classe de <span class="font-semibold text-cyan-700">${userGradeLevel ? userGradeLevel.charAt(0).toUpperCase() + userGradeLevel.slice(1) : ''}</span> à <span class="font-semibold text-cyan-700">${capitalizeWords(currentUserInfo.schoolName)}</span></p>
                <h2 class="text-xl font-bold text-cyan-700 mt-4">Niveau d'Exploration ${currentLevel} : ${rankTitle}</h2>
                <div class="flex justify-center items-center gap-2 mt-3 text-sm whitespace-nowrap">
                    <button class="text-cyan-700 hover:underline js-change-grade">Modifier ma classe</button>
                    <span class="text-slate-400">|</span>
                    <button class="text-sm text-cyan-700 hover:underline js-logout">Se déconnecter</button>
                </div>
            </div>
            <div class="w-32 h-32 bg-background-light rounded-full border flex flex-col items-center justify-center p-0 cursor-pointer flex-shrink-0 js-badges-container order-3 md:order-3">
                ${badgesHTML}
            </div>
        </div>
    </div>`;
    
    // --- 2. Nouvelle logique d'affichage du menu par catégories ---
    const allStepsForLevel = allSteps.filter(step => step.levels.includes(userGradeLevel));

    const dashboardSteps = allStepsForLevel.filter(step => step.category === 'dashboard');
    const exploreSteps = allStepsForLevel.filter(step => step.category === 'explore');
    const connectSteps = allStepsForLevel.filter(step => step.category === 'connect');
    const buildSteps = allStepsForLevel.filter(step => step.category === 'build');

    const createStepCardHTML = (step) => {
        let statusSymbol = '';
        if (!['journal', 'retroplanning', 'step12', 'guide'].includes(step.id) && journalData[step.id]) {
             if (isStepComplete(step.id)) {
                statusSymbol = `<span class="ml-2 text-green-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg></span>`;
            } else if (isStepStarted(step.id)) {
                statusSymbol = `<span class="ml-2 text-orange-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" /></svg></span>`;
            }
        }
        const nextStepId = journalData.tutorial_next_step || '';
        const isNextMission = step.id === nextStepId && !journalData.tutorial_completed && !isStepComplete(nextStepId);
        const highlightClass = isNextMission ? 'next-mission-highlight' : '';
        
        return `
         <div onclick="window.showView('${step.id}')" class="step-card bg-white p-6 rounded-xl shadow-md border border-border-subtle cursor-pointer flex flex-col items-center space-y-4 text-center w-full sm:w-[calc(50%-1rem)] lg:w-[calc(33.333%-1rem)] ${highlightClass}">
            <div>${step.icon}</div>
            <div>
                <div class="flex justify-center items-center">
                     <h2 class="text-lg font-semibold text-OrIAntation-darkblue">${step.title}</h2>
                     ${statusSymbol}
                </div>
                <p class="text-slate-500">${step.site}</p>
            </div>
         </div>`;
    };

    const dashboardHTML = dashboardSteps.map(createStepCardHTML).join('');
    const exploreHTML = exploreSteps.map(createStepCardHTML).join('');
    const connectHTML = connectSteps.map(createStepCardHTML).join('');
    const buildHTML = buildSteps.map(createStepCardHTML).join('');

    const menuGridHTML = `
        <div class="mt-8 space-y-12">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-6 text-center flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /></svg>
                    Tableau de Bord
                </h2>
                <div class="flex flex-wrap justify-center gap-4 w-full">${dashboardHTML}</div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-8 text-center flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.25c-.748-.374-1.628.17-1.628 1.006v8.69c0 .426.24.815.622 1.006l4.875 2.437a1.875 1.875 0 0 0 1.006 0Z" /></svg>
                    Le Parcours d'Orientation
                </h2>
                <div class="space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold text-cyan-700 mb-4 flex items-center gap-3">
                            <span class="bg-cyan-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">1</span>
                            Explorer les Possibilités
                        </h3>
                        <div class="flex flex-wrap justify-center gap-4 w-full">${exploreHTML}</div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-cyan-700 mb-4 flex items-center gap-3">
                            <span class="bg-cyan-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">2</span>
                            Se Connecter au Monde Réel
                        </h3>
                        <div class="flex flex-wrap justify-center gap-4 w-full">${connectHTML}</div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-cyan-700 mb-4 flex items-center gap-3">
                            <span class="bg-cyan-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">3</span>
                            Construire son Projet
                        </h3>
                        <div class="flex flex-wrap justify-center gap-4 w-full">${buildHTML}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const progressBarHTML = createProgressBarHTML();
    const guideCardHTML = `
    <div onclick="window.showView('guide')" class="step-card bg-white p-6 rounded-xl shadow-md border border-border-subtle cursor-pointer flex flex-col items-center space-y-2 mb-6 max-w-md mx-auto">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>
        <div class="text-center">
            <h2 class="text-lg font-semibold text-OrIAntation-darkblue">Guide d'Utilisation</h2>
            <p class="text-sm text-slate-500">Besoin d'aide pour commencer ?</p>
        </div>
    </div>`;
    const radarHTML = `
        <div class="mt-12 text-center fade-in">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="m15.75 15.75-2.489-2.489m0 0a3.375 3.375 0 1 0-4.773-4.773 3.375 3.375 0 0 0 4.774 4.774ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                <span>Le Radar à Opportunités</span>
            </h2>
            <p class="text-slate-600 max-w-2xl mx-auto mb-6">Teste ici tes propres idées de métiers ou laisse OrIA t'en proposer une à laquelle tu n'aurais jamais pensé !</p>
            <div class="bg-white p-6 rounded-2xl shadow-md border border-border-subtle">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="text" id="radarInput" class="w-full md:flex-1 p-3 border border-slate-300 rounded-lg" placeholder="Propose un métier ou un domaine...">
                    <button id="radarAnalyzeBtn" class="w-full md:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Analyser mon idée</button>
                </div>
                <div class="my-4 text-slate-500 font-semibold">OU</div>
                <button id="radarSurpriseBtn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Me surprendre !</button>
            </div>
            <div id="radarLoader" class="hidden"><div class="loader"></div></div>
            <div id="radarResult" class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-slate-700 text-left hidden prose prose-sm max-w-none"></div>
        </div>
    `;
    
    div.innerHTML = teacherButtonHTML + levelDisplayHTML + `<div class="max-w-xl mx-auto my-8">${progressBarHTML}</div>` + guideCardHTML + menuGridHTML + radarHTML;
    
    setTimeout(() => {
        const canvas = div.querySelector('#xp-chart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            const xpRemaining = Math.max(0, xpNeededForLevel - xpInCurrentLevel);
            new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [xpInCurrentLevel, xpRemaining], backgroundColor: ['#f59e0b', '#e2e8f0'], borderColor: ['#ffffff', '#ffffff'], borderWidth: 2 }] }, options: { responsive: true, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
        }
    }, 0);

    const loader = div.querySelector('#radarLoader');
    const resultDiv = div.querySelector('#radarResult');
    const radarInput = div.querySelector('#radarInput');

    const displayRadarResult = (type, subject, response) => {
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = '';
        const textElement = document.createElement('div');
        textElement.innerHTML = marked.parse(linkify(response));
        resultDiv.appendChild(textElement);
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'flex gap-4 mt-4 pt-4 border-t';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'flex-1 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition';
        saveBtn.textContent = 'Enregistrer dans le journal';
        saveBtn.addEventListener('click', async () => {
            if (!Array.isArray(journalData.radar_history)) { journalData.radar_history = []; }
            journalData.radar_history.push({ type: type, sujet: subject, reponse: response });
            await saveData();
            await grantXp(15);
            saveBtn.textContent = 'Enregistré ! ✔';
            saveBtn.disabled = true;
        });
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'flex-1 bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition';
        cancelBtn.textContent = 'Je vais réfléchir à autre chose';
        cancelBtn.addEventListener('click', () => { resultDiv.classList.add('hidden'); });
        buttonsContainer.appendChild(saveBtn);
        buttonsContainer.appendChild(cancelBtn);
        resultDiv.appendChild(buttonsContainer);
    };

    div.querySelector('#radarAnalyzeBtn').addEventListener('click', async () => {
    const userInput = radarInput.value.trim();
    if (!userInput) return;
    loader.style.display = 'block';
    resultDiv.classList.add('hidden');
    
    const profileSummary = getProfileSummary();
    
    // ON RÉCUPÈRE LE MODE D'EMPLOI DE L'APP
    const appFeaturesSummary = getAppFeaturesSummary();

    // ✅ PROMPT FINAL, STRICT ET CONTEXTUALISÉ
    const prompt = `
            Agis comme un conseiller d'orientation expert, bienveillant et réaliste.
            
            # Contexte de l'Application
            Voici la liste des seules fonctionnalités que tu peux suggérer. N'en invente aucune autre.
            ${appFeaturesSummary}

            # Données sur l'élève
            - Idée de métier proposée : "${userInput}"
            - Résumé de son profil : ${profileSummary}

            # Ta Mission
            Rédige une analyse riche et structurée de l'idée de l'élève. Utilise tes capacités de recherche web pour les données chiffrées.

            # Format de Sortie OBLIGATOIRE
            Ta réponse doit être fluide et naturelle. Il est **impératif** de ne JAMAIS utiliser les caractères '#' ou '*' ou '-' pour faire des listes.
            Utilise uniquement du texte en gras (avec **) pour les titres, et rédige chaque section comme un paragraphe entièrement rédigé.
            
            Structure ta réponse avec les titres suivants :

            **En quoi consiste ce métier ?**
            (Rédige une description vivante et concrète, en intégrant les missions principales dans le texte.)

            **Points de Connexion avec ton Profil**
            (Sois très spécifique. Fais le lien entre ce métier et les forces de l'élève en rédigeant un paragraphe argumenté.)

            **Parcours & Perspectives**
            (Intègre les informations sur le niveau d'études, le salaire et les perspectives d'avenir dans un paragraphe cohérent.)

            **Ta Première Mission d'Exploration**
            (Propose UNE SEULE action concrète, claire et motivante, réalisable en utilisant une fonctionnalité de l'application.)
        `;

    
const result = await callOpenAI_API({
    promptText: prompt,    // Le prompt brut, SANS addGenderContextToPrompt
    withPersona: true,     // Mettez 'true' si c'est un conseil de coach, 'false' sinon
    isJson: false,         // Mettez 'true' si vous attendez une réponse au format JSON
    model: 'gpt-4o'        // 'gpt-4o' par défaut, ou 'gpt-5' pour les tâches expertes
});    
        const cleanedResult = result.replace(/###? /g, '').replace(/[\*-] /g, '');


loader.style.display = 'none';
    displayRadarResult('Analyse', userInput, result);
});

    div.querySelector('#radarSurpriseBtn').addEventListener('click', async () => {
    loader.style.display = 'block';
    resultDiv.classList.add('hidden');
    
    let previousSuggestions = "Aucune suggestion précédente.";
    if (journalData.radar_history && journalData.radar_history.length > 0) {
        const suggestionNames = journalData.radar_history.map(item => item.sujet);
        previousSuggestions = `Pistes déjà explorées : ${suggestionNames.join(', ')}.`;
    }
    const profileSummary = getProfileSummary();
    const randomAngle = creativeAngles[Math.floor(Math.random() * creativeAngles.length)];
    
    // ON RÉCUPÈRE LE MODE D'EMPLOI DE L'APP
    const appFeaturesSummary = getAppFeaturesSummary();

    // ✅ PROMPT FINAL, STRICT ET CONTEXTUALISÉ
    const prompt = `
    Agis comme un coach d'orientation créatif et expert du marché du travail.
    
    # Contexte de l'Application
    Voici la liste des seules fonctionnalités que tu peux suggérer. N'en invente aucune autre.
    ${appFeaturesSummary}

    # Données sur l'élève
    - Profil : ${profileSummary}
    - ${previousSuggestions}
    - Angle créatif du jour : "${randomAngle}"

    # Ta Mission
    Propose UNE seule idée de métier inattendue mais pertinente. Utilise tes capacités de recherche web pour les données chiffrées.

    # Format de Sortie OBLIGATOIRE
    Ta réponse doit être fluide et naturelle. Il est **impératif** de ne JAMAIS utiliser les caractères '#' ou '*' ou '-' pour faire des listes.
    Utilise uniquement du texte en gras (avec **) pour les titres, et rédige chaque section comme un paragraphe entièrement rédigé.

    Structure ta réponse avec les titres suivants :

    **[SUR LA PREMIÈRE LIGNE, INVENTE ET ÉCRIS UNIQUEMENT UN TITRE CRÉATIF ET INSPIRANT, SANS AUCUN LABEL COMME "Titre :"]**

    **Piste Suggérée : [Nom du métier]**
    (Rédige une accroche en une phrase pour susciter la curiosité.)

    **Pourquoi cette idée pour toi ?**
    (Explique en 2-3 phrases le lien surprenant mais logique avec le profil de l'élève.)

    **À quoi ça ressemble ?**
    (Décris les missions principales de ce métier dans un paragraphe, sans utiliser de liste à puces.)

    **La Réalité du Terrain**
    (Rédige un paragraphe qui intègre le niveau d'études, le salaire débutant et les perspectives d'avenir.)

    **Ta Première Mission d'Exploration**
    (Propose UNE SEULE action concrète et simple que l'élève peut réaliser en utilisant une seule des fonctionnalités de l'application.)
`;


const result = await callOpenAI_API({
    promptText: prompt,    // Le prompt brut, SANS addGenderContextToPrompt
    withPersona: true,     // Mettez 'true' si c'est un conseil de coach, 'false' sinon
    isJson: false,         // Mettez 'true' si vous attendez une réponse au format JSON
    model: 'gpt-4o'        // 'gpt-4o' par défaut, ou 'gpt-5' pour les tâches expertes
});    

        const cleanedResult = result.replace(/###? /g, '').replace(/[\*-] /g, '');
        const finalResult = cleanedResult.replace(/\*\*Titre Créatif de la Piste\s?:\s?\*\*\n?/, '');



const sujet = result.split('\n')[0].replace(/\*\*/g, '').replace('La Piste Suggérée :', '').trim();
        loader.style.display = 'none';
        displayRadarResult('Surprise', sujet, result);
    });

    div.querySelectorAll('.js-logout').forEach(button => {
        button.addEventListener('click', async () => { await signOut(auth); });
    });
    
    div.querySelectorAll('.js-change-grade').forEach(button => {
        button.addEventListener('click', () => { showGradeSelectionView(); });
    });

    div.querySelectorAll('.js-xp-gauge').forEach(container => {
        container.addEventListener('click', () => {
            const title = "⭐ Qu'est-ce que le système d'XP ?";
            const contentHTML = `<div class="space-y-4 text-slate-600"><p>Le système de Points d'Expérience (XP) transforme ton parcours d'orientation en une aventure ! Chaque action importante te rapporte des points pour matérialiser ta progression.</p><div class="p-4 bg-background-light rounded-lg border"><h4 class="font-semibold text-OrIAntation-darkblue mb-2">Comment ça marche ?</h4><p>Tes XP remplissent la jauge circulaire. Une fois pleine, tu passes au niveau supérieur et gagnes un nouveau rang, montrant que tu avances dans ta quête !</p></div><div class="p-4 bg-background-light rounded-lg border"><h4 class="font-semibold text-OrIAntation-darkblue mb-2">Comment gagner des XP ?</h4><ul class="list-disc list-inside text-sm"><li>En analysant ton profil ("Mieux se connaître").</li><li>En générant ton Rétroplanning.</li><li>En valorisant une expérience dans ton Portfolio.</li><li>En obtenant un bon score à un quiz "Fact Checking".</li><li>En utilisant le Radar à Opportunités.</li></ul></div></div>`;
            createSimpleModal(title, contentHTML);
        });
    });

    div.querySelectorAll('.js-badges-container').forEach(container => {
        container.addEventListener('click', () => {
            const title = "🏆 Qu'est-ce que le système de Badges ?";
            let contentHTML = `<div class="space-y-4 text-slate-600"><p>Les badges sont des récompenses spéciales que tu débloques en accomplissant des ensembles d'étapes clés. Ils symbolisent tes grandes réussites dans ton parcours d'orientation !</p><div class="space-y-3">`;
            for (const key in badgesConfig) {
                const badge = badgesConfig[key];
                const earned = earnedBadges.includes(key);
                contentHTML += `<div class="flex items-start gap-4 p-3 rounded-lg ${earned ? 'bg-amber-50 border border-amber-200' : 'bg-background-light border border-border-subtle'}"><span class="text-4xl ${earned ? '' : 'opacity-40'}">${badge.icon}</span><div><h4 class="font-bold ${earned ? 'text-amber-800' : 'text-OrIAntation-darkblue'}">${badge.title} ${earned ? '(Obtenu !)' : '(À débloquer)'}</h4><p class="text-sm">${badge.description}</p></div></div>`;
            }
            contentHTML += `</div></div>`;
            createSimpleModal(title, contentHTML);
        });
    });

    div.querySelector('#progress-help-btn').addEventListener('click', () => {
        const title = "À quoi correspondent les coches ?";
        const contentHTML = `
            <div class="space-y-4 text-slate-600 text-left">
                <p>Les coches à côté des étapes vous permettent de suivre votre progression en un coup d'œil.</p>
                <div>
                    <h4 class="font-semibold text-OrIAntation-darkblue"><span class="text-orange-400 font-bold">✔</span> Coche Orange</h4>
                    <p class="text-sm pl-6">Signifie que vous avez <strong>commencé</strong> à explorer une étape, mais que vous ne l'avez pas encore terminée.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-OrIAntation-darkblue"><span class="text-green-500 font-bold">✔</span> Coche Verte</h4>
                    <p class="text-sm pl-6">Signifie que vous avez <strong>terminé</strong> l'étape en remplissant toutes les informations principales demandées.</p>
                </div>
                <p class="pt-4 border-t mt-4">Votre objectif est de faire passer un maximum d'étapes au vert pour construire le projet d'orientation le plus complet et le plus solide possible !</p>
            </div>
        `;
        createSimpleModal(title, contentHTML);
    });

    return div;
}

function createTeacherDashboardView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';
    
    // On utilise currentUserInfo.firstName pour personnaliser le titre
    div.innerHTML = `
        <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-60 w-auto mb-4">
        <h1 class="text-2xl font-bold text-OrIAntation-darkblue mb-1 text-center">Tableau de Bord de ${currentUserInfo.firstName} ${currentUserInfo.lastName}</h1>
<p class="text-center text-slate-500 mb-4">${currentUserInfo.gender === 'femme' ? 'Enseignante' : 'Enseignant'} au ${capitalizeWords(currentUserInfo.schoolName)}</p>        
<div class="text-center mb-6">
    <button onclick="signOut(auth)" class="text-sm text-slate-500 hover:text-red-600 hover:underline transition">Se déconnecter</button>
</div>
        
        <div id="stats-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
            <div class="bg-sky-50 p-4 rounded-lg text-center border border-sky-200">
                <p class="text-sm text-sky-700 font-semibold">Élèves dans la classe</p>
                <p id="stats-total-students" class="text-2xl font-bold text-sky-900">-</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center border border-green-200">
                <p class="text-sm text-green-700 font-semibold">Progression moyenne</p>
                <p id="stats-avg-progress" class="text-2xl font-bold text-green-900">- %</p>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg text-center border border-orange-200">
                <p class="text-sm text-orange-700 font-semibold">Élèves à suivre</p>
                <p id="stats-at-risk" class="text-2xl font-bold text-orange-900">-</p>
            </div>
        </div>

        <div id="invite-code-container" class="mb-8"></div>

        <div class="text-center mb-6">
            <button id="show-analytics-btn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">
                📊 Voir les statistiques détaillées de la classe
            </button>
        </div>
        <div id="analytics-container" class="hidden my-8 p-6 bg-gray-50 rounded-lg border"></div>
        
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <input type="text" id="teacher-search-input" placeholder="Rechercher un élève..." class="w-full sm:flex-1 p-2 border rounded-lg">
            <select id="teacher-sort-filter" class="w-full sm:w-auto p-2 border rounded-lg bg-white">
                <option value="name_asc">Trier par nom (A-Z)</option>
                <option value="progress_desc">Trier par progression (décroissant)</option>
                <option value="progress_asc">Trier par progression (croissant)</option>
                <option value="activity_desc">Trier par dernière activité</option>
            </select>
        </div>
    
        <div id="dashboard-content">
            <div class="loader"></div>
            <p class="text-center text-slate-500 mt-2">Chargement des données de la classe...</p>
        </div>
    `;

    // Le reste de la logique JavaScript de la fonction reste inchangé
    
    const formatDate = (isoString) => {
        if (!isoString) return 'Jamais';
        const date = new Date(isoString);
        const now = new Date();
        const diffDays = Math.round((now - date) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return "Aujourd'hui";
        if (diffDays === 1) return 'Hier';
        if (diffDays <= 7) return `Il y a ${diffDays} jours`;
        return `Le ${date.toLocaleDateString('fr-FR')}`;
    };

    let allStudents = [];

    const renderTable = (studentsToRender) => {
        const contentDiv = div.querySelector('#dashboard-content');
        if (studentsToRender.length === 0 && allStudents.length > 0) {
            contentDiv.innerHTML = '<p class="text-center text-slate-500 p-4">Aucun élève ne correspond à votre recherche.</p>';
            return;
        }

        const statusIndicators = {
            at_risk: { color: 'bg-orange-500', title: 'Élève à suivre (inactif ou bloqué)' },
            active: { color: 'bg-green-500', title: 'Élève actif' },
            excellent: { color: 'bg-blue-500', title: 'Progression excellente' }
        };

        let tableHTML = `
    <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Élève</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dernière activité</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progression</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
${studentsToRender.map(student => {
                    const statusIndicators = {
                        at_risk: { color: 'bg-orange-500', title: 'Élève à suivre (inactif ou bloqué)' },
                        active: { color: 'bg-green-500', title: 'Élève actif' },
                        excellent: { color: 'bg-blue-500', title: 'Progression excellente' }
                    };
                    const indicator = statusIndicators[student.status] || { color: 'bg-gray-300', title: 'Statut inconnu' };
                    
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <span class="w-3 h-3 rounded-full ${indicator.color}" title="${indicator.title}"></span>
                                    <span class="ml-3 font-medium text-gray-900">${student.firstName} ${student.lastName}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${formatDateAgo(student.lastActivity)}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${student.progress}%"></div>
                                    </div>
                                    <span class="ml-3 text-sm font-medium text-gray-700">${student.progress}%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-student-id="${student.id}" class="view-journal-btn text-cyan-600 hover:text-cyan-900">Voir le journal</button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    </div>
`;
        contentDiv.innerHTML = tableHTML;
    };

    const getSchoolData = httpsCallable(functions, 'getSchoolDashboardData');
    getSchoolData().then(result => {
        allStudents = result.data.students;
        const inviteCode = result.data.inviteCode;
        
        if (allStudents.length === 0) {
            div.querySelector('#dashboard-content').innerHTML = '<p class="text-center text-slate-500">Aucun élève n\'est encore rattaché à votre classe.</p>';
            div.querySelector('#stats-container').style.display = 'none';
        } else {
            const totalStudents = allStudents.length;
            const atRiskStudents = allStudents.filter(s => s.status === 'at_risk').length;
            const totalProgress = allStudents.reduce((sum, s) => sum + s.progress, 0);
            const avgProgress = totalStudents > 0 ? Math.round(totalProgress / totalStudents) : 0;

            div.querySelector('#stats-total-students').textContent = totalStudents;
            div.querySelector('#stats-avg-progress').textContent = `${avgProgress} %`;
            div.querySelector('#stats-at-risk').textContent = atRiskStudents;
            
            allStudents.sort((a, b) => a.lastName.localeCompare(b.lastName));
            renderTable(allStudents);
        }

        if (inviteCode) {
            div.querySelector('#invite-code-container').innerHTML = `
                <div class="p-4 bg-teal-50 border-l-4 border-teal-500 rounded-r-lg">
                    <h3 class="font-bold text-teal-800">Code d'invitation de la classe</h3>
                    <p class="text-sm text-slate-700 mt-1">Partagez ce code avec vos élèves pour qu'ils rejoignent cette classe :</p>
                    <div class="mt-2 p-2 rounded border border-dashed bg-white text-center">
                        <p class="text-2xl font-bold text-teal-700 tracking-widest">${inviteCode}</p>
                    </div>
                </div>`;
        }

    }).catch(error => {
        console.error("Erreur du tableau de bord:", error);
        div.querySelector('#dashboard-content').innerHTML = `<p class="text-center text-red-500">Une erreur est survenue lors du chargement des données.</p>`;
    });

    const applyFilters = () => {
        const searchTerm = div.querySelector('#teacher-search-input').value.toLowerCase();
        const sortOption = div.querySelector('#teacher-sort-filter').value;
        
        let filteredStudents = allStudents.filter(student => 
            `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm)
        );

        switch (sortOption) {
            case 'progress_desc':
                filteredStudents.sort((a, b) => b.progress - a.progress);
                break;
            case 'progress_asc':
                filteredStudents.sort((a, b) => a.progress - b.progress);
                break;
            case 'activity_desc':
                filteredStudents.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
                break;
            default:
                filteredStudents.sort((a, b) => a.lastName.localeCompare(b.lastName));
                break;
        }
        renderTable(filteredStudents);
    };

    div.addEventListener('input', (e) => {
        if (e.target.id === 'teacher-search-input') {
            applyFilters();
        }
    });

    div.addEventListener('change', (e) => {
        if (e.target.id === 'teacher-sort-filter') {
            applyFilters();
        }
    });
    
    const showAnalyticsBtn = div.querySelector('#show-analytics-btn');
    const analyticsContainer = div.querySelector('#analytics-container');
    let charts = {};

showAnalyticsBtn.addEventListener('click', async () => {
        // 1. On affiche ou on cache le conteneur, tout simplement.
        analyticsContainer.classList.toggle('hidden');

        // 2. On vérifie l'état ACTUEL du conteneur APRES le clic.
        const isNowVisible = !analyticsContainer.classList.contains('hidden');
        const isEmpty = analyticsContainer.innerHTML.trim() === '';

        // 3. Si le conteneur est maintenant visible ET qu'il est vide, ALORS on charge les données.
        if (isNowVisible && isEmpty) {
            analyticsContainer.innerHTML = '<div class="loader"></div>';

            try {
                const getAnalytics = httpsCallable(functions, 'getSchoolAnalytics');
                // ... (le reste de votre logique de chargement reste EXACTEMENT le même)
                const result = await getAnalytics();
                const analytics = result.data.analytics;

                if (Object.keys(analytics).length === 0) {
                    analyticsContainer.innerHTML = '<p class="text-center text-slate-500">Pas assez de données pour générer des statistiques.</p>';
                    return;
                }

                analyticsContainer.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">📊 Répartition de la Progression</h3>
                            <div class="max-w-xs mx-auto"><canvas id="progress-chart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">🧭 Secteurs les Plus Populaires</h3>
                            <canvas id="sector-chart"></canvas>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">🎯 Métiers les Plus Explorés</h3>
                            <ul id="top-metiers-list" class="space-y-2"></ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">🎓 Niveaux de Formation Visés</h3>
                            <div class="max-w-xs mx-auto"><canvas id="formation-level-chart"></canvas></div>
                        </div>
                    </div>
                `;

                if (analytics.progressDistribution) {
                    const progressCtx = document.getElementById('progress-chart').getContext('2d');
                    charts.progress = new Chart(progressCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(analytics.progressDistribution),
                            datasets: [{
                                data: Object.values(analytics.progressDistribution),
                                backgroundColor: ['#FBBF24', '#34D399', '#3B82F6'],
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: true }
                    });
                }

                if (analytics.sectorCounts && Object.keys(analytics.sectorCounts).length > 0) {
                    const sectorCtx = document.getElementById('sector-chart').getContext('2d');
                    charts.sector = new Chart(sectorCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(analytics.sectorCounts),
                            datasets: [{
                                label: 'Nombre d\'explorations',
                                data: Object.values(analytics.sectorCounts),
                                backgroundColor: 'rgba(8, 145, 178, 0.6)',
                                borderColor: 'rgba(8, 145, 178, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                }

                if (analytics.topMetiers && analytics.topMetiers.length > 0) {
                    const metiersList = document.getElementById('top-metiers-list');
                    metiersList.innerHTML = analytics.topMetiers.map(metier => 
                        `<li class="flex justify-between items-center bg-gray-100 p-2 rounded">
                            <span class="text-sm font-medium text-gray-800">${metier.nom}</span>
                            <span class="text-sm font-bold bg-cyan-200 text-cyan-800 px-2 py-0.5 rounded-full">${metier.count}</span>
                        </li>`
                    ).join('');
                } else {
                    document.getElementById('top-metiers-list').innerHTML = '<p class="text-center text-sm text-slate-500">Aucun métier exploré pour le moment.</p>';
                }

                if (analytics.formationLevelCounts) {
                    const formationCtx = document.getElementById('formation-level-chart').getContext('2d');
                    charts.formation = new Chart(formationCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(analytics.formationLevelCounts),
                            datasets: [{
                                data: Object.values(analytics.formationLevelCounts),
                                backgroundColor: ['#06b6d4', '#f97316', '#10b981', '#6366f1'],
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: true }
                    });
                }

            } catch (error) {
                console.error("Erreur lors de la récupération des statistiques:", error);
                analyticsContainer.innerHTML = `<p class="text-center text-red-500">Impossible de charger les statistiques.</p>`;
            }
        }
    });

    // ... dans createTeacherDashboardView
    div.addEventListener('click', async (e) => {
        const viewJournalButton = e.target.closest('.view-journal-btn');
        if (viewJournalButton) {
            const studentId = viewJournalButton.dataset.studentId;
            mainApp.innerHTML = '<div class="loader"></div>';
            
            try {
                const getStudentJournal = httpsCallable(functions, 'getStudentJournal');
                const studentResult = await getStudentJournal({ studentId: studentId });
                const studentData = studentResult.data;

                const userInfo = {
                    firstName: studentData.firstName,
                    lastName: '', // Le nom de famille n'est pas nécessaire pour la vue prof
                    schoolName: studentData.schoolName,
                    gradeLevel: studentData.gradeLevel
                };

                currentViewName = 'teacherStudentJournal'; // ✅ AJOUTEZ CETTE LIGNE ICI

                // On appelle la nouvelle fonction unifiée avec le contexte "teacher"
                const pageElement = await createUnifiedJournalView(userInfo, studentData.journal, 'teacher');
                
                mainApp.innerHTML = '';
                mainApp.appendChild(pageElement);
                document.getElementById('floatingBackBtn').style.display = 'flex';

            } catch (error) {
                console.error("Erreur lors de la récupération du journal:", error);
                createSimpleModal("Erreur", "<p>Impossible de charger le journal de cet élève.</p>");
                showView('teacherDashboard');
            }
        }
    });
// ...
    
    return div;
}

// Dans index.html, AJOUTEZ CETTE NOUVELLE FONCTION

function createTeacherStudentJournalView(studentData) {
    if (!studentData) {
        const div = document.createElement('div');
        div.innerHTML = `<p class="text-red-500">Erreur : Les données de l'élève n'ont pas pu être chargées.</p>`;
        return div;
    }

    const pageContainer = document.createElement('div');
    pageContainer.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // === ASTUCE IMPORTANTE ===
    // Pour réutiliser les fonctions comme createProgressBarHTML, on doit temporairement
    // remplacer les variables globales par celles de l'élève.
    const originalJournalData = journalData;
    const originalGradeLevel = userGradeLevel;

    journalData = studentData.journal;
    userGradeLevel = studentData.journal.gradeLevel || 'N/A';
    // =========================

    let finalHTML = `
        <h1 class="text-2xl font-bold text-cyan-700 mb-2 text-center">Journal de Bord de ${studentData.firstName}</h1>
        <p class="text-slate-500 mb-8 text-center">Élève en ${userGradeLevel}.</p>
        ${createProgressBarHTML()}
    `;

    if (journalData.earned_badges && journalData.earned_badges.length > 0) {
        finalHTML += createBadgesDisplay('journal_public');
    }

    finalHTML += createOrientationMapView(journalData, 'public');

    if (journalData.fil_rouge) {
        finalHTML += `<div class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
                        <h2 class="text-xl font-bold text-cyan-800 mb-4">✨ Son Fil Rouge</h2>
                        <div class="prose prose-sm max-w-none">${marked.parse(journalData.fil_rouge)}</div>
                      </div>`;
    }

    pageContainer.innerHTML = finalHTML;

    // === On restaure les variables globales originales ===
    journalData = originalJournalData;
    userGradeLevel = originalGradeLevel;


    
    return pageContainer;
}

// REMPLACEZ VOTRE FONCTION 'renderJournalPageView' PAR CETTE VERSION COMPLÈTE

function renderJournalPageView(userInfo, journalDataToDisplay) {
    const pageContainer = document.createElement('div');
    pageContainer.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // === On utilise temporairement les données de l'élève pour les fonctions globales ===
    const originalJournalData = journalData;
    const originalGradeLevel = userGradeLevel;
    journalData = journalDataToDisplay;
    userGradeLevel = userInfo.gradeLevel;
    // =================================================================================

    let finalHTML = `
        <h1 class="text-2xl font-bold text-cyan-700 mb-2 text-center">Journal de Bord de ${userInfo.firstName}</h1>
        <p class="text-slate-500 mb-8 text-center">Élève en ${userGradeLevel} à ${userInfo.schoolName}.</p>
        ${createProgressBarHTML()}
    `;

    if (journalData.earned_badges && journalData.earned_badges.length > 0) {
        finalHTML += createBadgesDisplay('journal_public');
    }
    finalHTML += createOrientationMapView(journalData, 'public');
    if (journalData.fil_rouge) {
        finalHTML += `<div class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg"><h2 class="text-xl font-bold text-cyan-800 mb-4">✨ Son Fil Rouge</h2><div class="prose prose-sm max-w-none">${marked.parse(journalData.fil_rouge)}</div></div>`;
    }
    pageContainer.innerHTML = finalHTML;

    // --- Conteneur pour les sections détaillées ---
    const journalContentDiv = document.createElement('div');
    journalContentDiv.className = 'mt-8 space-y-4';

    if (journalData.step0 && journalData.step0.analysis) {
        journalContentDiv.appendChild(createProfileInfographic(journalData.step0, 'public'));
    }

    const stepTitles = {
        retroplanning_saves: 'Ses Conseils de Rétroplanning Sauvegardés',
        step10: 'Son Portfolio de Compétences',
        step1: 'Ses Fondations (Métiers)',
        step2: 'Ses simulations de spécialités',
        step3: 'Son Catalogue (Formations)',
        step4: 'Sa préparation d\'entretiens',
        step5: 'Son Actu',
        step6: 'Ses préparations de candidatures',
        step7: 'Ses Scores (Fact Checking)',
        step8: 'Ses passages à l\'action',
        step9: 'Son anticipation de la suite',
        step11: 'Ses rencontres sur le territoire',
        step12: 'Ses simulations de vie étudiante',
        radar_history: 'Son Radar à Opportunités',
        chatbot_saves: 'Ses Discussions avec le Coach',
    };
    
    // Helper pour convertir un tableau Markdown en HTML
    const markdownTableToHtml = (markdown) => {
        if (!markdown) return '';
        const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
        if (lines.length < 2) return '';
        let html = '<div class="comparison-table-wrapper"><table>';
        const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th>${cell.trim()}</th>`).join('');
        html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
        lines.slice(2).forEach(line => {
            const rowCells = line.split('|').slice(1, -1).map(cell => `<td>${linkify(cell.trim())}</td>`).join('');
            html += `<tr>${rowCells}</tr>`;
        });
        html += `</tbody></table></div>`;
        return html;
    };

    for (const stepKey in stepTitles) {
        const stepData = journalDataToDisplay[stepKey];
        let sectionContentHTML = '';
        let hasContentInSection = false;

        // On vérifie si la section contient des données à afficher
        if (stepData && ( (Array.isArray(stepData) && stepData.length > 0) || (typeof stepData === 'object' && Object.keys(stepData).length > 0 && (!Array.isArray(stepData) || stepData.length > 0) ) )) {
            hasContentInSection = true;
            
            // Logique de rendu spécifique à chaque section
            if (stepKey === 'step1' && Array.isArray(stepData.metiers) && stepData.metiers.length > 0) {
                 sectionContentHTML = '<div class="space-y-3">' + stepData.metiers.map(metier => {
                    let analysesHTML = '';
                    if (metier.analyses) {
                        analysesHTML = Object.entries(metier.analyses).map(([key, value]) => {
                           if (!value) return '';
                           return `<div class="mt-2"><h5 class="font-medium text-sm text-OrIAntation-darkblue">${capitalizeWords(key)}</h5><div class="prose prose-sm max-w-none">${marked.parse(linkify(value))}</div></div>`;
                        }).join('');
                    }
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold">${metier.nom}</summary><div class="p-3 border-t"><p><b>Notes:</b> ${metier.notes || 'Aucune'}</p>${analysesHTML}</div></details>`;
                }).join('') + '</div>';
            } else if (stepKey === 'step3' && stepData.formations?.length > 0) {
                 sectionContentHTML = '<div class="space-y-3">' + stepData.formations.map(f => {
                    let content = `<p><b>Attendus:</b> ${f.attendus || 'N/A'}</p><p><b>Mots-clés:</b> ${f.mots_cles || 'N/A'}</p>`;
                    if (f.analyses?.compatibilite) content += `<div class="mt-2"><h5 class="font-medium text-sm">Rapport de compatibilité</h5><div class="prose prose-sm max-w-none">${marked.parse(f.analyses.compatibilite)}</div></div>`;
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold">${f.nom}</summary><div class="p-3 border-t">${content}</div></details>`;
                }).join('') + '</div>';
            } else if (stepKey === 'step10') {
                 let content = '';
                 if (stepData.experiences?.length > 0) content += `<h4>Expériences</h4>` + stepData.experiences.map(e => `<div class="p-2 my-1 bg-white border rounded">${e.analysis}</div>`).join('');
                 if (stepData.soft_skills_profile) content += `<h4 class="mt-4">Profil de compétences</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.soft_skills_profile)}</div>`;
                 if (stepData.skills_synthesis) content += `<h4 class="mt-4">Synthèse</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.skills_synthesis)}</div>`;
                 sectionContentHTML = content;
            } else if (Array.isArray(stepData)) {
                // Rendu générique pour les autres sections qui sont des listes
                sectionContentHTML = '<div class="space-y-3">' + stepData.map(item => {
                    const title = item.sujet || item.question || item.theme || `Entrée du ${new Date(item.date).toLocaleDateString('fr-FR')}`;
                    const content = item.reponse || item.conseils || item.suggestions || '';
                    let formattedContent = '';
                    if (typeof content === 'object') { // Pour les conseils du rétroplanning
                        formattedContent = Object.entries(content).map(([key, value]) => `<p><b>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</b> ${value}</p>`).join('');
                    } else {
                        formattedContent = `<div class="prose prose-sm max-w-none">${marked.parse(linkify(content))}</div>`;
                    }
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold">${title}</summary><div class="p-3 border-t">${formattedContent}</div></details>`;
                }).join('') + '</div>';
            }
        }
        
        if (hasContentInSection) {
            const sectionContainer = document.createElement('div');
            sectionContainer.className = 'border border-border-subtle rounded-lg overflow-hidden';
            sectionContainer.innerHTML = `
                <div class="journal-section-header flex justify-between items-center bg-background-light p-4 cursor-pointer hover:bg-slate-100 transition">
                    <h3 class="text-lg font-bold text-cyan-700">${stepTitles[stepKey]}</h3>
                    <span class="transform transition-transform duration-200 text-cyan-700">▼</span>
                </div>
                <div class="journal-section-content p-4 border-t border-border-subtle hidden">${sectionContentHTML}</div>`;
            journalContentDiv.appendChild(sectionContainer);
        }
    }
    
    pageContainer.appendChild(journalContentDiv);
    
    // On ajoute le bouton "Préparer une discussion"
    const discussionSection = document.createElement('div');
    discussionSection.innerHTML = `
        <div class="mt-8 border-t pt-6 text-center">
            <button id="publicShareBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">🤝 Préparer une discussion</button>
        </div>
        <div id="publicOpenAIShareLoader" class="hidden"></div>
        <div id="publicOpenAIShareResult" class="mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg text-slate-700"></div>`;
    pageContainer.appendChild(discussionSection);

    // Ajout de toute la logique des clics
    pageContainer.addEventListener('click', async (e) => {
        const header = e.target.closest('.journal-section-header');
        const shareBtn = e.target.closest('#publicShareBtn');

        if (header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('span');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        } else if (shareBtn) {
            shareBtn.disabled = true;
            const loader = pageContainer.querySelector('#publicOpenAIShareLoader');
            const resultDiv = pageContainer.querySelector('#publicOpenAIShareResult');
            const profileSummary = getProfileSummary();
    const completionSummary = getCompletionSummary();
    
    // On restaure les données originales après usage
    journalData = originalJournalData;

    try {
        // NOUVEAU PROMPT AMÉLIORÉ
        const prompt = `
            Agis comme un conseiller pédagogique et un coach d'orientation qui prépare un entretien.
            Tu analyses le parcours d'un élève pour fournir des points de discussion constructifs à un parent ou un enseignant.

            # Données sur l'élève
            - Résumé de son profil de personnalité : ${profileSummary}
            - Résumé de sa progression dans l'application : ${completionSummary}

            # Ta Mission
            En te basant STRICTEMENT sur les données fournies, génère 4 points de discussion clés. Chaque point doit aider à lancer une conversation bienveillante et constructive.

            # Format de Sortie OBLIGATOIRE
            Ta réponse doit utiliser des titres en gras (**Titre**), mais ne doit contenir AUCUNE liste à puces (* ou -). Chaque point doit être un paragraphe fluide.

            **Point de discussion 1 : Mettre en lumière une force clé**
            (Identifie une force évidente dans son profil et formule une question ouverte pour l'inviter à en parler. Ex: "J'ai remarqué que...")

            **Point de discussion 2 : Explorer une zone de blocage ou d'hésitation**
            (Repère une étape peu remplie ou une contradiction dans son parcours et formule une question pour l'aider à verbaliser ses difficultés. Ex: "J'ai vu que tu avais beaucoup exploré les métiers, mais moins les formations. Qu'est-ce qui te semble le plus difficile dans cette étape ?")

            **Point de discussion 3 : Suggérer une prochaine étape concrète**
            (Propose une action simple et logique à entreprendre dans l'application pour faire avancer son projet. Ex: "Pour aller plus loin, que dirais-tu d'utiliser le comparateur de métiers pour y voir plus clair ?")
        `;

        // NOUVEL APPEL API UTILISANT LA VOIE EXPERT
        const result = await callOpenAI_API({
            promptText: prompt,
            promptId: "pmpt_68dc33a589bc8197a0229d72a4e3df100510635f4c084c2c", // ID du prompt Expert
            isExpertCall: true,
            loaderElement: loader,
            customLoaderHTML: `<div class="loader"></div><p class="text-slate-500 font-semibold mt-2">Analyse du parcours en cours...</p>`
        });
        
        resultDiv.innerHTML = marked.parse(result);

    } catch (error) {
        resultDiv.innerHTML = '<p class="text-red-500">Une erreur est survenue.</p>';
        console.error("Erreur lors de la génération des points de discussion :", error);
    } finally {
        shareBtn.disabled = false;
    }
}
    });

    return pageContainer;
}
        
function createHomeView() {
    return createMenuView();
}
        function createStepView(config) {
            const div = document.createElement('div');
            div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';
            
            let formFields = '';
            if (config.fields) {
                formFields = config.fields.map(field => {
                    const value = (journalData[config.stepKey] && journalData[config.stepKey][field.id]) || '';
                    const isReadonly = field.isReadonly ? 'readonly' : '';
                    const bgColor = isReadonly ? 'bg-background-light' : 'bg-white';
                    return `
                    <div class="mb-6">
                        <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                        ${field.type === 'textarea' ? `<textarea id="${field.id}" name="${field.id}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" ${isReadonly}>${value}</textarea>` : `<input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" value="${value}" ${isReadonly}>`}
                    </div>
                `}).join('');
            }

            let description = config.description;
            if(typeof description === 'object') {
                description = description[userGradeLevel] || description['default'] || '';
            }

            let action = config.action;
            if(typeof action === 'object') {
                action = action[userGradeLevel] || action['default'] || '';
            }

            let linksHTML = '';
    if (config.urls) {
        linksHTML = config.urls.map(link => 
            `<a href="${link.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition mr-2 mb-2">Visiter ${link.site} ↗</a>`
        ).join('');
    } else if (config.url) {
        linksHTML = `<a href="${config.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter ${config.site} ↗</a>`;
    }

    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>      
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${action}</div></div>
        <div class="mb-8">${linksHTML}</div>
        <form id="stepForm">
            ${formFields}
            <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">✔️ Terminer et sauvegarder</button>
        </form>
    `;
            
            div.querySelector('#stepForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const stepKey = config.stepKey;
                if (!journalData[stepKey]) journalData[stepKey] = {};

                for (const [key, newValue] of formData.entries()) {
                     journalData[stepKey][key] = newValue; 
                }
                
                checkBadges();
                await saveData();
                showView('menu');
            });

            return div;
        }
        

function createProfileInfographic(step0Data, context = 'user') {
    if (!step0Data || !step0Data.analysis) {
        return document.createElement('div');
    }

    const container = document.createElement('div');
    container.className = 'mb-8';
    const titleText = context === 'user' ? 'Synthèse visuelle de mon profil' : 'Synthèse visuelle de son profil';

    container.innerHTML = `
        <h2 class="text-xl font-bold border-b pb-2 mb-4 text-cyan-700">${titleText}</h2>
        <div class="bg-background-light p-4 md:p-6 rounded-xl border border-border-subtle mt-4">
            
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="profileBarChart"></canvas>
            </div>
        </div>

        <div id="riasec-legend" class="mt-6 text-sm text-slate-600 space-y-4 text-left">
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'🛠️'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">L'Artisan(e) Stellaire (Réaliste) :</strong> Aime le travail concret, physique, avec des outils ou en plein air.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'🔬'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">L'Architecte de la Connaissance (Investigateur) :</strong> Aime analyser, comprendre, résoudre des problèmes complexes.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'🎨'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le/La Visionnaire (Artistique) :</strong> Aime créer, imaginer, s'exprimer de manière non conventionnelle.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'🤝'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le/La Tisserand(e) de Liens (Social) :</strong> Aime aider, former, soigner, être en contact avec les autres.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'🚀'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le/La Capitaine d'Expédition (Entreprenant) :</strong> Aime diriger, convaincre, mener des projets, prendre des décisions.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'🏛️'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le/La Gardien(ne) des Structures (Conventionnel) :</strong> Aime organiser, gérer, respecter les règles, travailler avec des données.</div>
            </div>
        </div>
    `;

    setTimeout(() => {
        const ctx = document.getElementById('profileBarChart')?.getContext('2d');
        if (!ctx) return;
        
        const riasecScores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
        const riasecMapping = { q1:{sens:'S',securite:'C',creativite:'A',autonomie:'E'}, q2:{defi:'I',maitrise:'I',collaboration:'S'}, q3:{diriger:'E',creer:'A',comprendre:'I'}, q4:{variete:'E',stabilite:'C'}, q5:{influence:'E',expertise:'I'}, q6:{passion:'A',ambition:'E'}, q7:{transmettre:'S',organiser:'C',inventer:'A'}, q8:{ouverture:'A',tradition:'C'}, q9:{consciencieux:'C',flexible:'E'}, q11:{agreable:'S',assertif:'E'}, q13:{detail:'C',synthese:'I'}, q14:{curieux:'I',pratique:'R'}, q15:{realiste:'R',investigatif:'I'}, q16:{artistique:'A',social:'S'}, q17:{entreprenant:'E',conventionnel:'C'}, q18:{social:'S',entreprenant:'E'}, q19:{artistique:'A',conventionnel:'C'}, q20:{realiste:'R',artistique:'A'}, q21:{social:'S',investigatif:'I',realiste:'R'}, q22:{realiste:'R',social:'S'}, q23:{investigatif:'I',entreprenant:'E'}, q24:{artistique:'A',conventionnel:'C'}, q25:{social:'S',investigatif:'I'}, q26:{entreprenant:'E',realiste:'R'}, q27:{conventionnel:'C',artistique:'A'}, q28:{investigatif:'I',realiste:'R'}, q29:{social:'S',entreprenant:'E'}, q30:{artistique:'A',conventionnel:'C',realiste:'R'} };

        for (const [questionId, mapping] of Object.entries(riasecMapping)) {
             const answer = step0Data[questionId];
            if (answer && mapping[answer]) {
                const type = mapping[answer];
                riasecScores[type]++;
            }
        }
        
        const archetypeLabels = { R:"L'Artisan(e) Stellaire (Réaliste)", I:"L'Architecte de la Connaissance (Investigateur)", A:"Le/La Visionnaire (Artistique)", S:"Le/La Tisserand(e) de Liens (Social)", E:"Le/La Capitaine d'Expédition (Entreprenant)", C:"Le/La Gardien(ne) des Structures (Conventionnel)" };
        const labels = ['🛠️', '🔬', '🎨', '🤝', '🚀', '🏛️'];
        const dataKeys = ['R', 'I', 'A', 'S', 'E', 'C'];
        const dataPoints = dataKeys.map(key => riasecScores[key]);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Score d\'intérêt',
                    data: dataPoints,
                    backgroundColor: [ 'rgba(239, 68, 68, 0.6)','rgba(59, 130, 246, 0.6)','rgba(251, 191, 36, 0.6)','rgba(34, 197, 94, 0.6)','rgba(249, 115, 22, 0.6)','rgba(148, 163, 184, 0.6)' ],
                    borderColor: [ 'rgb(239, 68, 68)','rgb(59, 130, 246)','rgb(251, 191, 36)','rgb(34, 197, 94)','rgb(249, 115, 22)','rgb(148, 163, 184)' ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { ticks: { font: { size: 20 } } },
                    x: { beginAtZero: true, ticks: { stepSize: 1 } } 
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataKey = dataKeys[context.dataIndex];
                                const label = archetypeLabels[dataKey] || '';
                                const value = context.raw || 0;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
    }, 0);

    return container;
}
        function createQuestionHTML(id, label, options, selectedValue) {
            let optionsHTML = '<option value="">Choisir...</option>';
            for (const [value, data] of Object.entries(options)) {
                optionsHTML += `<option value="${value}" ${selectedValue === value ? 'selected' : ''} title="${data.description}">${data.text}</option>`;
            }
            return `
                <div class="mb-4">
                    <label class="block text-md font-medium text-slate-700 mb-2">${id}. ${label}</label>
                    <select name="q${id}" class="w-full p-3 border border-slate-300 rounded-lg">
                        ${optionsHTML}
                    </select>
                </div>
            `;
        }

function createStep0View() {
    const config = stepsConfig.step0;
    const div = createStepView({ ...config, fields: [] });
    const form = div.querySelector('#stepForm');

    const questions = [
        { id: 1, part: "Mes Moteurs", label: "Pour un exposé en groupe, le plus important pour toi, c'est...", options: { sens: { text: "Que le sujet soit utile et aide les autres à comprendre." }, securite: { text: "D'avoir une super note garantie." }, creativite: { text: "De pouvoir présenter le sujet d'une manière originale." }, autonomie: { text: "D'avoir la liberté de faire ma partie comme je l'entends." } } },
        { id: 2, part: "Mes Moteurs", label: "Ce qui te stimule le plus dans un projet, c'est...", options: { defi: { text: "Te creuser la tête sur un problème complexe." }, maitrise: { text: "Maîtriser une technique à la perfection." }, collaboration: { text: "Partager des idées et construire ensemble." } } },
        { id: 3, part: "Mes Moteurs", label: "À la fin d'un projet, tu serais le/la plus fier(e) de...", options: { diriger: { text: "Bien avoir organisé le groupe." }, creer: { text: "Avoir imaginé quelque chose de nouveau." }, comprendre: { text: "Avoir compris une théorie complexe." } } },
        { id: 4, part: "Mes Moteurs", label: "Tu préfères quand tes semaines de cours...", options: { variete: { text: "Sont pleines d'imprévus et de nouveaux sujets." }, stabilite: { text: "Suivent un planning clair et prévisible." } } },
        { id: 5, part: "Mes Moteurs", label: "Dans un projet de groupe, tu aimes être celui/celle qui...", options: { influence: { text: "Participe aux grandes décisions." }, expertise: { text: "S'occupe de la partie technique." } } },
        { id: 6, part: "Mes Moteurs", label: "Tu préférerais un petit job...", options: { passion: { text: "Qui te passionne, même moins bien payé." }, ambition: { text: "Avec un bon salaire, même un peu répétitif." } } },
        { id: 7, part: "Mes Moteurs", label: "Dans un club au lycée, tu aimerais le plus...", options: { transmettre: { text: "Expliquer et former les nouveaux." }, organiser: { text: "Planifier les événements et gérer le budget." }, inventer: { text: "Proposer des idées de nouveaux projets." } } },
        { id: 8, part: "Ma Façon d'Agir", label: "Face à une méthode de travail nouvelle, ta réaction est...", options: { ouverture: { text: "Cool, j'ai envie d'essayer !" }, tradition: { text: "Je préfère garder mes habitudes qui marchent." } } },
        { id: 9, part: "Ma Façon d'Agir", label: "Pour un gros devoir à rendre dans un mois, tu as tendance à...", options: { consciencieux: { text: "Faire un planning précis dès le début." }, flexible: { text: "Commencer à la fin, je gère mieux sous pression." } } },
        { id: 10, part: "Ma Façon d'Agir", label: "Après une semaine intense, tu recharges tes batteries en...", options: { extraversion: { text: "Passant du temps avec des amis." }, introversion: { text: "Passant du temps seul(e) (livre, film, jeu...)." } } },
        { id: 11, part: "Ma Façon d'Agir", label: "Quand tes amis n'arrivent pas à décider du film à aller voir...", options: { agreable: { text: "Tu cherches un compromis pour éviter les disputes." }, assertif: { text: "Tu défends le film que tu penses être le meilleur choix." } } },
        { id: 12, part: "Ma Façon d'Agir", label: "Juste avant un oral important, tu te sens généralement...", options: { stable: { text: "Assez calme et concentré(e)." }, reactif: { text: "Stressé(e), tu imagines le pire." } } },
        { id: 13, part: "Ma Façon d'Agir", label: "Quand tu prépares ton sac pour le lendemain...", options: { detail: { text: "Tu vérifies 3 fois que tu n'as rien oublié." }, synthese: { text: "Tu prends l'essentiel, au pire tu t'arrangeras." } } },
        { id: 14, part: "Ma Façon d'Agir", label: "Quand tu entends parler d'un sujet que tu ne connais pas...", options: { curieux: { text: "Ton réflexe est de chercher sur internet pour en savoir plus." }, pratique: { text: "Ça t'intéresse seulement si ça peut te servir." } } },
        { id: 15, part: "Mes Terrains de Jeu", label: "Spontanément, tu es plus attiré(e) par...", options: { realiste: { text: "Une activité manuelle (bricoler, cuisiner...)." }, investigatif: { text: "Un jeu de logique (échecs, énigme...)." } } },
        { id: 16, part: "Mes Terrains de Jeu", label: "Si tu devais créer un club au lycée, ce serait...", options: { artistique: { text: "Un club de théâtre, de musique ou d'arts." }, social: { text: "Une association d'aide aux devoirs." } } },
        { id: 17, part: "Mes Terrains de Jeu", label: "Pour organiser la fête de fin d'année, ton rôle idéal serait...", options: { entreprenant: { text: "De convaincre et de trouver des sponsors." }, conventionnel: { text: "De gérer la liste des invités et le planning." } } },
        { id: 18, part: "Mes Terrains de Jeu", label: "En groupe, tu es plus à l'aise pour...", options: { social: { text: "Animer la discussion et faire participer." }, entreprenant: { text: "Présenter le projet final pour convaincre." } } },
        { id: 19, part: "Mes Terrains de Jeu", label: "Tu passes plus de temps à...", options: { artistique: { text: "Personnaliser ton fond d'écran." }, conventionnel: { text: "Organiser parfaitement tes fichiers." } } },
        { id: 20, part: "Mes Terrains de Jeu", label: "Si tu avais un après-midi de libre, tu préférerais...", options: { realiste: { text: "Faire du sport ou réparer ton vélo." }, artistique: { text: "Dessiner, composer ou écrire une histoire." } } },
        { id: 21, part: "Mes Terrains de Jeu", label: "Si tu devais choisir une seule option pour le Grand Oral :", options: { social: { text: "Un sujet sur l'engagement citoyen." }, investigatif: { text: "Un sujet scientifique complexe." }, realiste: { text: "Un sujet sur la mécanique des voitures électriques." } } },
        { id: 22, part: "Mes Terrains de Jeu", label: "Pour un projet concret, tu préfères...", options: { realiste: { text: "Construire physiquement une maquette." }, social: { text: "Interviewer des personnes pour comprendre leurs besoins." } } },
    { id: 23, part: "Mes Terrains de Jeu", label: "Face à un problème dans un projet de groupe, tu es celui/celle qui...", options: { investigatif: { text: "Analyse toutes les données pour trouver la source exacte du problème." }, entreprenant: { text: "Propose une solution rapide et motive le groupe pour la tester." } } },
    { id: 24, part: "Mes Terrains de Jeu", label: "Pour rendre un devoir écrit, tu portes le plus d'attention à...", options: { artistique: { text: "L'originalité de la présentation (couleurs, mise en page créative)." }, conventionnel: { text: "La parfaite conformité aux consignes (police, marges, bibliographie)." } } },
    { id: 25, part: "Mes Terrains de Jeu", label: "Le type de documentaire que tu regardes le plus volontiers est...", options: { social: { text: "Un reportage sur une cause sociale ou humanitaire." }, investigatif: { text: "Une émission scientifique qui décortique un phénomène complexe." } } },
    { id: 26, part: "Mes Terrains de Jeu", label: "Si tu devais monter un petit business au lycée, ce serait pour...", options: { entreprenant: { text: "Vendre des produits que tu as négociés et achetés en gros." }, realiste: { text: "Proposer un service de réparation (vélos, ordinateurs...)." } } },
    { id: 27, part: "Mes Terrains de Jeu", label: "Dans un jeu vidéo, ce que tu aimes le plus, c'est...", options: { conventionnel: { text: "Optimiser ton inventaire et gérer tes ressources à la perfection." }, artistique: { text: "Passer des heures à personnaliser l'apparence de ton personnage." } } },
    { id: 28, part: "Ma Façon d'Agir", label: "Tu es généralement plus à l'aise avec...", options: { investigatif: { text: "Des concepts abstraits et des théories." }, realiste: { text: "Des objets concrets que tu peux voir et manipuler." } } },
    { id: 29, part: "Ma Façon d'Agir", label: "Pour un projet oral, tu préfères être...", options: { social: { text: "Le/la porte-parole qui présente le travail à la classe." }, entreprenant: { text: "Le/la chef(fe) de projet qui a distribué les tâches en amont." } } },
    { id: 30, part: "Mes Terrains de Jeu", label: "Pour un projet libre en arts, tu choisirais de...", options: { artistique: { text: "Créer une œuvre 100% originale sortie de ton imagination." }, conventionnel: { text: "Reproduire une œuvre existante avec une technique parfaite." }, realiste: { text: "Construire un objet d'art qui a aussi une utilité (lampe, meuble...)." } } }

    ];

    form.innerHTML = `
        <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-4">Ton Point de Départ</h2>
    <p class="text-slate-600 mb-6">Pour commencer, décris en quelques phrases où tu en es dans ta réflexion. As-tu déjà des idées, des pistes ? Ou es-tu dans le flou total ? Sois honnête, cela aidera OrIA à mieux te guider.</p>
    <div class="mb-8">
        <label for="situation" class="block text-md font-medium text-slate-700 mb-2">Ma situation actuelle :</label>
        <textarea id="situation" name="situation" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Je suis en Seconde et je commence à peine à y penser, les métiers de la santé m'attirent mais je ne sais pas si j'ai le bon profil...">${journalData.step0.situation || ''}</textarea>
    </div>
    <hr class="my-8 border-slate-300">
    <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-4">Questionnaire de Personnalité</h2>
    <div id="quiz-wrapper" class="w-full max-w-lg mx-auto">
        <div class="mb-2 flex justify-between items-center"><span id="quiz-progress-text" class="text-sm font-semibold text-cyan-700"></span><span id="quiz-part-text" class="text-sm text-slate-500"></span></div>
        <div class="w-full bg-slate-200 rounded-full h-2.5"><div id="quiz-progress-bar" class="bg-cyan-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div></div>
        <div id="quiz-question-container" class="mt-6 text-center"></div>
    </div>
    <div id="analysis-section" class="hidden text-center mt-6">
        <h2 class="text-xl font-bold text-OrIAntation-darkblue">Questionnaire terminé !</h2>
        <p class="text-slate-600 my-4">Bravo, tu as fait le tour. Clique maintenant sur le bouton pour obtenir ton profil personnalisé.</p>
        <button type="button" id="analyzeProfileBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">✨ Analyser mon profil</button>
    </div>
    <div id="openaiLoader_step0" class="hidden mt-4"><div class="loader"></div></div>
    <div id="results-wrapper" class="mt-8 space-y-8">
        <div id="archetype-container"></div>
        <div id="analysis-container"></div>
        <div id="infographic-container"></div>
        <div id="submit-container" class="text-center pt-4 hidden">
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="button" id="retake-quiz-btn" class="w-full sm:w-1/2 bg-slate-200 text-OrIAntation-darkblue font-semibold py-3 px-6 rounded-lg hover:bg-slate-300 transition">🔄 Recommencer le test</button>
                <button type="submit" class="w-full sm:w-1/2 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">✔️ Terminer et sauvegarder</button>
            </div>
        </div>
    </div>
    <hr class="my-12 border-slate-300">

        <div id="pour-aller-plus-loin" class="hidden">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Pour aller plus loin : Croise les regards</h2>
            
            <p class="text-slate-600 mb-6">
                Pour une analyse encore plus riche, tu peux passer des tests complémentaires sur des sites spécialisés et copier-coller les résultats ici. OrIA les croisera avec ton profil OrIAntation pour une synthèse encore plus fine.
                <br>
                <a href="https://test-orientation.studyrama.com/profil/lyceen" target="_blank" class="font-semibold text-primary-action hover:underline">Trouver des tests sur Studyrama.com ↗</a>
            </p>

            <div class="mb-6">
                <label for="test_interets" class="block text-md font-medium text-slate-700 mb-2">1. Résultats du Test d'Intérêts Professionnels</label>
                <textarea id="test_interets" name="test_interets" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes résultats...">${journalData.step0.test_interets || ''}</textarea>
            </div>
            <div class="mb-6">
                <label for="test_motivation" class="block text-md font-medium text-slate-700 mb-2">2. Résultats du Test de Motivation</label>
                <textarea id="test_motivation" name="test_motivation" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes résultats...">${journalData.step0.test_motivation || ''}</textarea>
            </div>
            <div class="mb-6">
                <label for="test_personnalite" class="block text-md font-medium text-slate-700 mb-2">3. Résultats du Test de Personnalité</label>
                <textarea id="test_personnalite" name="test_personnalite" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes résultats...">${journalData.step0.test_personnalite || ''}</textarea>
            </div>
            <div class="text-center mb-4">
                <button type="button" id="openaiBtn_test_croise" class="bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">💡 Lancer l'analyse croisée</button>
            </div>
            <div id="openaiLoader_test_croise" class="hidden"><div class="loader"></div></div>
            <div class="mb-6">
                <label for="analyse_tests_croisee" class="block text-md font-medium text-slate-700 mb-2">Analyse croisée par OrIA</label>
                <textarea id="analyse_tests_croisee" name="analyse_tests_croisee" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${journalData.step0.analyse_tests_croisee || ''}</textarea>
            </div>
        </div>
    `;

    // --- Logique et fonctions ---
    let currentQuestionIndex = 0;
    if (!journalData.step0) journalData.step0 = {};

    const renderArchetype = (archetype) => {
        if (!archetype || !archetype.titre) return;
        const container = div.querySelector('#archetype-container');
        container.innerHTML = `<div class="bg-cyan-50 border-2 border-dashed border-cyan-300 p-6 rounded-2xl text-center"><span class="text-5xl">${archetype.icone}</span><h3 class="text-2xl font-bold text-cyan-800 mt-2">${archetype.titre}</h3><p class="text-slate-600 mt-2">${archetype.description}</p></div>`;
    };
    const renderAnalysis = (analysis) => {
        const container = div.querySelector('#analysis-container');
        container.innerHTML = `<div><label class="block text-md font-medium text-slate-700 mb-2">Analyse détaillée :</label><textarea name="analysis" rows="15" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${analysis}</textarea></div>`;
    };
    const renderInfographic = (step0Data) => {
        const container = div.querySelector('#infographic-container');
        container.innerHTML = '';
        container.appendChild(createProfileInfographic(step0Data));
    };

    const renderQuestion = (index) => {
    if (index >= questions.length) {
        form.querySelector('#quiz-wrapper').classList.add('hidden');
        form.querySelector('#analysis-section').classList.remove('hidden');
        return;
    }
    const question = questions[index];
    const progressPercent = ((index + 1) / questions.length) * 100;
    form.querySelector('#quiz-progress-bar').style.width = `${progressPercent}%`;
    form.querySelector('#quiz-progress-text').textContent = `Question ${index + 1} / ${questions.length}`;
    form.querySelector('#quiz-part-text').textContent = question.part;
    const answersHTML = Object.entries(question.options).map(([value, data]) => 
        `<button type="button" data-value="${value}" class="answer-btn w-full text-left p-4 my-2 bg-white border border-slate-300 rounded-lg hover:bg-cyan-100 hover:border-cyan-400 transition">${data.text}</button>`
    ).join('');
    const questionContainer = form.querySelector('#quiz-question-container');
    questionContainer.innerHTML = `<div class="fade-in"><p class="text-lg font-semibold text-OrIAntation-darkblue mb-6">${question.label}</p><div class="flex flex-col">${answersHTML}</div></div>`;
    
    questionContainer.querySelectorAll('.answer-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const qId = `q${question.id}`;
            journalData.step0[qId] = e.target.dataset.value;
            currentQuestionIndex++;
            
            // ✅ LA CORRECTION EST ICI
            // On ajoute un minuscule délai pour éviter le bug d'affichage aléatoire
            setTimeout(() => {
                renderQuestion(currentQuestionIndex);
            }, 10); // 10 millisecondes suffisent
        });
    });
};
    
    form.querySelector('#analyzeProfileBtn').addEventListener('click', async () => {
        const loader = div.querySelector('#openaiLoader_step0');
        const submitContainer = div.querySelector('#submit-container');
        const answersText = questions.map(q => {
            const answerValue = journalData.step0[`q${q.id}`];
            if (!answerValue) return null;
            const answerText = q.options[answerValue]?.text || 'Non répondu';
            return `- ${q.label} -> ${answerText}`;
        }).filter(line => line !== null).join('\n');

        if (Object.keys(journalData.step0).filter(k => k.startsWith('q')).length < questions.length) {
             showInfoModal("Attention", "Veuillez répondre à toutes les questions pour obtenir une analyse.");
             return;
        }

        loader.style.display = 'block';
        form.querySelector('#analysis-section').classList.add('hidden');

        let profileAnalysis = '';
        let rawArchetypeResponse = '';
        const appFeaturesSummary = getAppFeaturesSummary();
        const situationParagraphe = div.querySelector('#situation').value;



const analysisPrompt = `
        Agis en tant que psychologue expérimenté(e) et coach pour l'application OrIAntation.
            Tu viens de recevoir les réponses d'un(e) lycéen(ne) à un questionnaire de personnalité.

            # Contexte de l'Application (Mode d'emploi)
            Voici la liste des seules fonctionnalités que tu peux suggérer. N'en invente aucune autre.
            ${appFeaturesSummary}

            # Données sur l'élève (TRÈS IMPORTANT)
            Voici d'abord son auto-évaluation de sa situation actuelle :
            "${situationParagraphe}"

            Voici ensuite ses réponses au questionnaire de personnalité :
            ${answersText}

            # Ta Mission
            Rédige une analyse complète, bienveillante et structurée. Tu dois **impérativement prendre en compte son auto-évaluation** pour personnaliser ton introduction et tes conclusions. Si l'élève a mentionné des pistes, commente-les à la lumière de son profil. S'il est perdu, rassure-le et montre-lui comment son profil peut être un point de départ solide.

            # Format de Sortie
            La réponse doit être structurée exactement comme suit :
            1.  **Synthèse de ton profil :** Un paragraphe de résumé global et positif.
            2.  **Tes atouts et Pistes de Réflexion :** Analyse son mode de fonctionnement et ses forces. Suggère une piste de développement.
            3.  **Les Environnements Faits pour toi :** Décris le type d'environnement et suggère 2-3 grands domaines/secteurs.
            4.  **Actions concrètes dans l'app OrIAntation :** Une liste de 2 suggestions d'actions basées sur le mode d'emploi.
        `;
    
        profileAnalysis = await callOpenAI_API({
        promptText: analysisPrompt, // La mission est passée ici
        promptId: "pmpt_68dc33a589bc8197a0229d72a4e3df100510635f4c084c2c", // L'ID du prompt Expert
        isExpertCall: true,
        loaderElement: loader // ✅ On passe le loader à la fonction

    });
        journalData.step0.analysis = profileAnalysis;

        const riasecScores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
        const riasecMapping = { q1: { sens: 'S', securite: 'C', creativite: 'A', autonomie: 'E' }, q2: { defi: 'I', maitrise: 'I', collaboration: 'S' }, q3: { diriger: 'E', creer: 'A', comprendre: 'I' }, q4: { variete: 'E', stabilite: 'C' }, q5: { influence: 'E', expertise: 'I' }, q6: { passion: 'A', ambition: 'E' }, q7: { transmettre: 'S', organiser: 'C', inventer: 'A' }, q8: { ouverture: 'A', tradition: 'C' }, q9: { consciencieux: 'C', flexible: 'E' }, q11: { agreable: 'S', assertif: 'E' }, q13: { detail: 'C', synthese: 'I' }, q14: { curieux: 'I', pratique: 'R' }, q15: { realiste: 'R', investigatif: 'I' }, q16: { artistique: 'A', social: 'S' }, q17: { entreprenant: 'E', conventionnel: 'C' }, q18: { social: 'S', entreprenant: 'E' }, q19: { artistique: 'A', conventionnel: 'C' }, q20: { realiste: 'R', artistique: 'A' }, q21: { social: 'S', investigatif: 'I', realiste: 'R' }, q22: { realiste: 'R', social: 'S' }, q23: { investigatif: 'I', entreprenant: 'E' }, q24: { artistique: 'A', conventionnel: 'C' }, q25: { social: 'S', investigatif: 'I' }, q26: { entreprenant: 'E', realiste: 'R' }, q27: { conventionnel: 'C', artistique: 'A' }, q28: { investigatif: 'I', realiste: 'R' }, q29: { social: 'S', entreprenant: 'E' }, q30: { artistique: 'A', conventionnel: 'C', realiste: 'R' } };
        for (const [questionId, mapping] of Object.entries(riasecMapping)) {
            const answer = journalData.step0[questionId];
            if (answer && mapping[answer]) riasecScores[mapping[answer]]++;
        }
        journalData.step0.riasecScores = riasecScores; // On sauvegarde le score correct

        const riasecNames = { R: 'Réaliste', I: 'Investigateur', A: 'Artistique', S: 'Social', E: 'Entreprenant', C: 'Conventionnel' };
        const top3Names = Object.entries(riasecScores).sort(([,a],[,b]) => b-a).slice(0, 3).map(([letter]) => riasecNames[letter]);
        const userGender = currentUserInfo.gender || 'autre';

        const archetypePrompt = `
    # Ton Rôle
    Tu es un psychologue expert en orientation, maître dans l'art de créer des profils synthétiques et inspirants.

    # Contexte Fourni
    - Genre de l'élève : ${userGender}
    - Profil RIASEC :
        - Majeur : ${top3Names[0]}
        - Secondaire : ${top3Names[1]}
        - Tertiaire : ${top3Names[2]}
    - Analyse de personnalité brute : ${profileAnalysis}

    # Ta Mission en 2 étapes
    1.  **Identifier l'Archétype Principal :** En te basant sur le profil RIASEC Majeur, choisis l'archétype correspondant dans cette liste :
        - Réaliste (R) : L'Artisan Stellaire / L'Artisane Stellaire (Icône : 🛠️)
        - Investigateur (I) : L'Architecte de la Connaissance (Icône : 🔬)
        - Artistique (A) : Le Visionnaire / La Visionnaire (Icône : 🎨)
        - Social (S) : Le Tisserand de Liens / La Tisserande de Liens (Icône : 🤝)
        - Entreprenant (E) : Le Capitaine d'Expédition (Icône : 🚀)
        - Conventionnel (C) : Le Gardien des Structures / La Gardienne des Structures (Icône : 🏛️)
    
    2.  **Créer la Variante Personnalisée :** Invente un nom de variante unique et épique en fusionnant les traits des profils RIASEC Majeur, Secondaire et Tertiaire. Rédige ensuite une description qui combine ces trois traits, en t'inspirant de l'analyse de personnalité brute.

    # Format de Sortie OBLIGATOIRE
    La réponse DOIT être un unique objet JSON valide, sans aucun texte avant ou après.
    {
      "icone": "L'icône de l'archétype principal.",
      "titre": "Le nom de la variante personnalisée, accordé au genre de l'élève.",
      "description": "La description personnalisée en 2 ou 3 phrases qui fusionne les trois traits RIASEC."
    }
`;
        rawArchetypeResponse = await callOpenAI_API({
        promptText: archetypePrompt,
        isJson: true 
        // Pas de promptId, donc on utilise gpt-4o, plus rapide.
    });
        const archetypeResult = extractJsonFromString(rawArchetypeResponse);
        if (archetypeResult) journalData.step0.archetype = archetypeResult;

if (!journalData.step0.analysis_timestamp) { // On n'enregistre que la 1ère fois
    journalData.step0.analysis_timestamp = new Date().getTime();
}

        renderAnalysis(profileAnalysis);
        if(archetypeResult) renderArchetype(archetypeResult);
        renderInfographic(journalData.step0);
        
        loader.style.display = 'none';
        submitContainer.classList.remove('hidden');
        form.querySelector('#pour-aller-plus-loin').classList.remove('hidden');
        await grantXp(100);
    });

    form.querySelector('#openaiBtn_test_croise').addEventListener('click', async () => {
        const loader = div.querySelector('#openaiLoader_test_croise');
        const resultatsInterets = div.querySelector('#test_interets').value;
        const resultatsMotivation = div.querySelector('#test_motivation').value;
        const resultatsPersonnalite = div.querySelector('#test_personnalite').value;
        const analysisTextarea = div.querySelector('#analyse_tests_croisee');
        if (!journalData.step0.analysis) {
            showInfoModal("Veuillez d'abord générer l'analyse de votre profil pour obtenir une analyse croisée.");
            return;
        }
        if (!resultatsInterets.trim() && !resultatsMotivation.trim() && !resultatsPersonnalite.trim()) {
            showInfoModal("Veuillez renseigner les résultats d'au moins un test.");
            return;
        }
        loader.style.display = 'block';
        analysisTextarea.value = '';
        const prompt = `Agis en tant que psychologue-conseiller d'orientation. Un élève a déjà complété un questionnaire de personnalité dont l'analyse est la suivante : "${journalData.step0.analysis}".\nPour affiner sa réflexion, il a passé 3 tests complémentaires sur Studyrama. Voici ses résultats :\n1.  **Test d'Intérêts Professionnels :** "${resultatsInterets}"\n2.  **Test de Motivation :** "${resultatsMotivation}"\n3.  **Test de Personnalité :** "${resultatsPersonnalite}"\n\nTa mission est de rédiger une **analyse croisée bienveillante et constructive**. Ne te contente pas de résumer chaque test. Mets en lumière les **convergences** et les **confirmations**.\nStructure ta réponse en 2 points :\n1.  **Ce que ces tests confirment :** Identifie les 2 ou 3 points clés de son profil initial (ses forces, ses moteurs...) qui sont clairement renforcés par les résultats de ces trois tests. Sois précis en citant des exemples.\n2.  **Une nouvelle piste à explorer :** En te basant sur un élément nouveau ou surprenant apparu dans les tests, propose une nouvelle piste de réflexion ou un domaine à explorer auquel il n'avait peut-être pas pensé.\n\nLe ton doit être très encourageant et valoriser la cohérence de sa démarche. Adresse-toi directement à l'élève.`;
const aiResponse = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});
        loader.style.display = 'none';
        analysisTextarea.value = result;
    });
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
            if (value) journalData.step0[key] = value;
        }
        await saveData();
        const tutorialShown = await handleOnboarding({ from: 'step0_analysis' });
        if (!tutorialShown) showView('menu');
    });
    
    if (journalData.step0 && journalData.step0.analysis) {
        renderAnalysis(journalData.step0.analysis);
        renderInfographic(journalData.step0);
        if (journalData.step0.archetype) {
            renderArchetype(journalData.step0.archetype);
        }
        form.querySelector('#quiz-wrapper').classList.add('hidden');
        form.querySelector('#analysis-section').classList.add('hidden');
        form.querySelector('#submit-container').classList.remove('hidden');
        form.querySelector('#pour-aller-plus-loin').classList.remove('hidden');
    }
    
    renderQuestion(0);
    

    div.querySelector('#retake-quiz-btn').addEventListener('click', async () => {
    const lastTimestamp = journalData.step0.analysis_timestamp || 0;
    const now = new Date().getTime();
    const daysSinceLastTest = (now - lastTimestamp) / (1000 * 60 * 60 * 24);
    const cooldownDays = 90; // Délai de 3 mois (environ 90 jours)

    // Si le délai n'est pas écoulé, on affiche la fenêtre modale éducative
    if (daysSinceLastTest < cooldownDays) {
        const daysRemaining = Math.ceil(cooldownDays - daysSinceLastTest);
        const title = "Une nouvelle photographie de toi-même 📸";
        const contentHTML = `
            <div class="space-y-3 text-slate-600 text-left">
                <p>Ton profil est comme une photographie de tes intérêts à un moment précis. C'est un excellent point de départ !</p>
                <p class="font-semibold">À ton âge, on se construit et on évolue très vite. C'est pourquoi il est intéressant de refaire ce test de temps en temps pour voir comment ta réflexion a mûri.</p>
                <p class="p-3 bg-cyan-50 border border-cyan-200 rounded-lg text-center">
                    Tu pourras refaire le test dans <strong>${daysRemaining} jour(s)</strong>.
                </p>
                <p>D'ici là, continue d'explorer les autres étapes pour affiner ta connaissance de toi-même !</p>
            </div>
        `;
        createSimpleModal(title, contentHTML); // On utilise la modale simple pour un meilleur affichage
        return;
    }

    // Si le délai est écoulé, on affiche le message de confirmation
    const confirmed = await showConfirmationModal(
        "C'est le bon moment pour prendre une nouvelle 'photographie' de ton profil et voir comment tu as évolué. Tes résultats actuels seront remplacés par les nouveaux. Veux-tu continuer ?"
    );
    
    if (confirmed) {
    // On réinitialise les données du quiz et des résultats
    journalData.step0 = {
        ...stepsConfig.step0.fields.reduce((acc, field) => ({ ...acc, [field.id]: '' }), {}),
        analysis: '',
        archetype: null,
        riasecScores: {},
        // On remet le timestamp à zéro pour que le prochain test enregistre une nouvelle date
        analysis_timestamp: 0 
    };
    await saveData();
    
    // On rafraîchit la vue pour réafficher le questionnaire
    showView('step0');
}
});
    return div;
}
        
        function createStep1Field(field) {
            const value = (journalData.step1 && journalData.step1[field.id]) || '';
            return `
                <div class="mb-4">
                    <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${field.placeholder}" value="${value}">
                        <button type="button" id="openaiBtn_${field.id}" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition" title="Explorer les débouchés avec OrIA">✨</button>
                        <button type="button" id="daySimBtn_${field.id}" class="bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition" title="Simuler une journée type">📅</button>
                    </div>
                    <div id="openaiLoader_${field.id}" class="hidden mt-4"><div class="loader"></div></div>
                    <div id="openaiResult_${field.id}" class="mt-4 p-4 bg-cyan-50 border border-cyan-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
                </div>
            `;
        }
        
// REMPLACEZ VOTRE FONCTION createStep1View EXISTANTE PAR CE CODE COMPLET :
// REMPLACEZ INTÉGRALEMENT votre fonction createStep1View par celle-ci

function createStep1View() {
    const config = stepsConfig.step1;
    const div = createStepView(config); // On garde la base (titre, description...)
    const form = div.querySelector('#stepForm');
    
    // --- État local pour l'exploration en cours ---
    let currentExploration = {
        nom: '',
        notes: '',
        analyses: {}
    };

    // --- Fonctions de rendu ---

    // Affiche la liste des métiers déjà sauvegardés
    const renderSavedMetiers = () => {
        const container = div.querySelector('#saved-metiers-container');
        if (!container) return;

        const metiers = journalData.step1.metiers || [];
        if (metiers.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de métier enregistré.</p>`;
            checkComparisonState();
            return;
        }

        container.innerHTML = metiers.map((metier, index) => {
            let analysesHTML = '';
            if (metier.analyses) {
                if(metier.analyses.debouches) analysesHTML += `<li><strong>Débouchés :</strong> Analysés.</li>`;
                if(metier.analyses.journee) analysesHTML += `<li><strong>Journée type :</strong> Simulée.</li>`;
                if(metier.analyses.temoignages) analysesHTML += `<li><strong>Témoignages :</strong> Trouvés.</li>`;
            }

            return `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${metier.nom}</span>
                        <button type="button" data-index="${index}" class="delete-metier-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer ce métier">🗑️</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle">
                        <p class="font-semibold">Notes :</p>
                        <p class="whitespace-pre-wrap text-sm mb-2">${metier.notes || 'Aucune note.'}</p>
                        <p class="font-semibold">Analyses :</p>
                        <ul class="list-disc list-inside text-sm">${analysesHTML || 'Aucune analyse effectuée.'}</ul>
                    </div>
                </details>
            `;
        }).join('');
        checkComparisonState();
    };

    // --- Structure HTML de la nouvelle page ---
    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">🔬 Atelier d'exploration en cours</h2>
            <div class="mb-4">
                <input type="text" id="current-metier" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Cherche un métier à explorer...">
                <div id="search-results" class="relative"></div>
            </div>
            <div id="fiche-metier-container" class="mt-4"></div>
            <div class="mb-4 mt-4">
                <label for="current-notes" class="block text-md font-medium text-slate-700 mb-2">Prends tes notes ici</label>
                <textarea id="current-notes" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ce qui retient ton attention..."></textarea>
            </div>
            <div class="flex flex-wrap gap-2 justify-center mb-4">
                <button type="button" data-action="debouches" class="ai-btn flex-grow bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">✨ Débouchés</button>
                <button type="button" data-action="journee" class="ai-btn flex-grow bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 transition">📅 Journée type</button>
                <button type="button" data-action="temoignages" class="ai-btn flex-grow bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">🎬 Témoignages</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border border-border-subtle rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
<button type="button" id="save-metier-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">💾 Enregistrer ce métier dans mon journal</button>        
</div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">📚 Mes Métiers Enregistrés</h2>
        <div id="saved-metiers-container" class="space-y-3 mb-8"></div>
        
        <div id="comparison-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0 0 12 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52v1.664M5.25 4.97v1.664m-3.75 0V9.67c0 .723.231 1.423.65 1.996l3.428 4.571a.75.75 0 0 1 .16.529V20.25m8.25-15.28V9.67c0 .723.231 1.423.65 1.996l3.428 4.571a.75.75 0 0 1 .16.529V20.25" /></svg>
                <span>Comparateur de Métiers</span>
            </h2>
            <p class="text-slate-600 mb-4">Maintenant que tu as exploré plusieurs pistes, utilise OrIA pour générer un tableau comparatif et t'aider à y voir plus clair.</p>
            <div class="text-center">
                <button type="button" id="compare-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Comparer mes métiers enregistrés</button>
            </div>
            <div id="loader-comparison" class="hidden"><div class="loader"></div></div>
            <div id="comparison-result" class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-slate-700 text-left"></div>
            <input type="hidden" name="comparison" id="comparison" value="${journalData.step1.comparison || ''}">
        </div>
    `;

    // --- Logique des événements ---

    const resetWorkspace = () => {
        currentExploration = { nom: '', notes: '', analyses: {} };
        div.querySelector('#current-metier').value = '';
        div.querySelector('#current-notes').value = '';
        div.querySelector('#result').innerHTML = '';
        div.querySelector('#fiche-metier-container').innerHTML = '';
    };

    div.querySelector('#save-metier-btn').addEventListener('click', async () => {
        currentExploration.nom = div.querySelector('#current-metier').value.trim();
        currentExploration.notes = div.querySelector('#current-notes').value.trim();

        if (!currentExploration.nom) {
            showInfoModal("Veuillez renseigner un nom de métier avant d'enregistrer.");
            return;
        }

        if (!journalData.step1.metiers) {
            journalData.step1.metiers = [];
        }
        journalData.step1.metiers.push(currentExploration);
        
        await saveData();
        await grantXp(30);
        
        // ▼▼▼ AJOUTEZ CETTE LIGNE CI-DESSOUS ▼▼▼
        const tutorialShown = await handleOnboarding({ from: 'step1_save' });

        renderSavedMetiers();
        resetWorkspace();
        
        // On n'affiche la fenêtre de confirmation que si le tutoriel n'a pas affiché sa propre fenêtre
        if (!tutorialShown) {
            showSurpriseModal("Métier sauvegardé !", "<p>Super ! Cette piste est maintenant dans ton journal. Prêt(e) à en explorer une nouvelle ?</p>", 3000);
        }
    });

    
    div.querySelectorAll('.ai-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const metier = div.querySelector('#current-metier').value.trim();
            const loader = div.querySelector('#loader');
            const resultDiv = div.querySelector('#result');
            
            if (!metier) {
                showInfoModal("Veuillez d'abord entrer un nom de métier.");
                return;
            }

            resultDiv.innerHTML = '';
            loader.style.display = 'block';

            const profileSummary = getProfileSummary(); // <-- ✅ CORRECTION ICI

            
            let prompt = '';
            let isJson = false;

            switch (action) {
    case 'debouches':
        prompt = `
            Agis comme un expert du marché du travail qui s'adresse à un lycéen.
            Le métier est : "${metier}".
            Le profil du lycéen est : ${profileSummary}.

            # Ta Mission
            Rédige une analyse CONCISE des débouchés de ce métier.

            # Format de Sortie OBLIGATOIRE
            Structure ta réponse en 3 points clairs avec les titres suivants en gras. Sois bref et factuel (2-3 phrases par point).
            
            1.  **Les Débuts :** Décris le poste typique pour un débutant.
            2.  **L'Évolution :** Cite 2 évolutions de carrière possibles.
            3.  **Le Conseil du Coach (pour toi) :** En te basant sur le profil de l'élève, explique EN QUOI ce métier est une piste particulièrement intéressante pour lui/elle. Mets en avant UN SEUL point de connexion fort.
        `;
        break;

    case 'journee':
        prompt = `
            Tu es un(e) ${metier} passionné(e) et un excellent conteur d'histoires. Tu écris le récit détaillé d'une de tes journées de travail pour un lycéen.
            Le profil du lycéen est : ${profileSummary}.

            # Ta Mission
            Rédige un récit immersif, détaillé et inspirant à la première personne ("Je"). 
            Pour rendre ton récit vivant, construis-le en 4 temps :
            1.  **L'Ambiance du Matin :** Décris ton état d'esprit, le premier défi ou la mission principale de la journée.
            2.  **Le Cœur de la Mission :** Raconte en détail la tâche la plus complexe et intéressante que tu as accomplie. Mentionne les outils, les compétences et la réflexion nécessaires.
            3.  **Un Moment Clé :** Décris une interaction importante avec un collègue/client, ou un problème inattendu que tu as dû résoudre.
            4.  **Le Bilan du Soir :** Termine sur la satisfaction du travail accompli ou la leçon apprise durant la journée.
            
            # Règle d'Or de Personnalisation
            Insiste sur les aspects de la journée (créativité, analyse, contact humain...) qui sont les plus pertinents pour le profil du lycéen.

            # Format de Sortie OBLIGATOIRE
            - Ta réponse doit être un texte fluide et unifié d'environ 400 à 450 mots.
            - NE PAS utiliser de listes numérotées, de tirets, ou de titres en gras. Le texte doit se lire comme une histoire cohérente.
        `;
        break;

    case 'temoignages':
        prompt = `
            Agis comme un coach d'orientation qui compile des ressources pour un élève s'intéressant au métier de "${metier}".
            Ta mission est de générer 3 exemples de témoignages (vidéo, article, podcast) qui pourraient exister.
            
            Pour chaque témoignage :
            1. Invente un titre accrocheur et un court résumé.
            2. Pour la clé "lien", ne cherche PAS une URL réelle. Construis SYSTÉMATIQUEMENT une URL de recherche Google pertinente pour trouver ce type de contenu.
               Exemple de lien : "https://www.google.com/search?q=témoignage+vidéo+métier+${encodeURIComponent(metier)}".

            # Format de Sortie OBLIGATOIRE
            Ta réponse doit être **uniquement un objet JSON valide** contenant un tableau de 3 objets.
            Chaque objet doit avoir les clés "titre", "resume", et "lien".
        `;
        isJson = true;
        break;
}

            const result = await callOpenAI_API({ promptText: prompt, withPersona: true, isJson: isJson });
            loader.style.display = 'none';

            currentExploration.analyses[action] = result;
            
            if (action === 'temoignages') {
    try {
        const testimonials = extractJsonFromString(result);
        let htmlResult = '<div class="space-y-4">';
        (testimonials || []).forEach(item => {
            htmlResult += `<div class="p-3 bg-white rounded-md"><a href="${item.lien}" target="_blank" class="font-semibold text-primary-action hover:underline">${item.titre}</a><p class="text-xs">${item.resume}</p></div>`;
        });
        htmlResult += '</div>';
        resultDiv.innerHTML = htmlResult;
    } catch(e) { resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage.</p><pre>${result}</pre>`;
}
            } else {
                resultDiv.innerHTML = linkify(result);
            }
        });
    });

    const checkComparisonState = () => {
        const comparisonSection = form.querySelector('#comparison-section');
        const metiers = journalData.step1.metiers || [];
        if (comparisonSection) {
            comparisonSection.classList.toggle('hidden', metiers.length < 2);
        }
    };

    div.querySelector('#compare-btn').addEventListener('click', async () => {
        const loader = div.querySelector('#loader-comparison');
        const resultDiv = div.querySelector('#comparison-result');
        const metiersAComparer = journalData.step1.metiers;
        if (metiersAComparer.length < 2) return;
        
        loader.style.display = 'block';
        resultDiv.innerHTML = '';

        const prompt = `Crée un tableau comparatif au format Markdown et une remarque de synthèse pour les métiers suivants : ${JSON.stringify(metiersAComparer)}. Ta réponse doit être un JSON avec les clés "tableau" et "remarques".`;
        const result = await callOpenAI_API({ promptText: prompt, model: 'gpt-4o', isJson: true });
        
        loader.style.display = 'none';
        try {
            const data = extractJsonFromString(result);
            const markdownTableToHtml = (markdown) => {
                const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
                let html = `<div class="comparison-table-wrapper"><table class="w-full text-left border-collapse">`;
                const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th class="p-3 border-b-2 font-bold bg-slate-100">${cell.trim()}</th>`).join('');
                html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
                lines.slice(2).forEach(line => {
                    const rowCells = line.split('|').slice(1, -1).map(cell => `<td class="p-3 border-b align-top text-sm">${linkify(cell.trim())}</td>`).join('');
                    html += `<tr>${rowCells}</tr>`;
                });
                html += `</tbody></table></div>`;
                return html;
            };
            resultDiv.innerHTML = markdownTableToHtml(data.tableau) + `<p class="mt-4 text-sm italic">${data.remarques}</p>`;
            journalData.step1.comparison = JSON.stringify(data);
        } catch(e) { resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage.</p><pre>${result}</pre>`; }
    });
    
    if (journalData.step1.comparison) {
        // Logique pour afficher la comparaison sauvegardée
    }

    div.querySelector('#saved-metiers-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-metier-btn')) {
            const index = e.target.closest('.delete-metier-btn').dataset.index;
            const confirmed = await showConfirmationModal("Es-tu sûr de vouloir supprimer ce métier de ton journal ?");
            if (confirmed) {
                journalData.step1.metiers.splice(index, 1);
                await saveData();
                renderSavedMetiers();
            }
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        showView('menu');
    });

    // --- Logique de recherche et d'affichage de la fiche (réutilisée de votre code) ---
    const addSearchFunctionality = () => {
        const metierInput = form.querySelector('#current-metier');
        const searchResultsContainer = form.querySelector('#search-results');
        const resultsWrapper = document.createElement('div');
        resultsWrapper.className = 'absolute z-10 w-full bg-white border border-slate-200 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg';
        searchResultsContainer.appendChild(resultsWrapper);

        // REMPLACEZ la fonction "displayMetierFiche" existante par celle-ci

const displayMetierFiche = (metier) => {
    const ficheContainer = form.querySelector(`#fiche-metier-container`);
    let ficheHTML = `
        <div class="p-6 bg-white border-2 border-cyan-100 rounded-2xl space-y-6 text-slate-700 text-left relative transition-all duration-300 ease-in-out shadow-lg">
            <button type="button" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600 font-bold text-2xl p-1 leading-none" title="Fermer la fiche">×</button>
            <div class="text-center border-b pb-4">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue">${metier.libelle || metier.nom_metier}</h2>
                ${metier.accroche_metier ? `<p class="text-slate-500 mt-2 italic">"${metier.accroche_metier}"</p>` : ''}
            </div>
    `;

    if (metier.centres_interet && metier.centres_interet.centre_interet) {
        const items = Array.isArray(metier.centres_interet.centre_interet) ? metier.centres_interet.centre_interet : [metier.centres_interet.centre_interet];
        const tagsHTML = items.map(item => `<span class="bg-cyan-100 text-cyan-800 text-sm font-semibold mr-2 mb-2 px-3 py-1 rounded-full">${item.libelle}</span>`).join('');
        ficheHTML += `
            <div>
                <h3 class="font-bold text-OrIAntation-darkblue mb-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75 2.25 12l4.179 2.25m0-4.5 5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-5.571 3-5.571-3Z" /></svg>
                    Centres d'intérêt associés
                </h3>
                <div class="flex flex-wrap">${tagsHTML}</div>
            </div>
        `;
    }
    
    let column1HTML = '';
    let column2HTML = '';
    
    const champsInteressants = [
        { key: 'nature_travail', titre: 'Nature du travail', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21v-4.5m0 4.5h4.5m-4.5 0L9 15M21 3.75v4.5m0-4.5h-4.5m4.5 0L15 9" /></svg>` },
        { key: 'competences', titre: 'Compétences requises', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" /></svg>` },
        { key: 'condition_travail', titre: 'Conditions de travail', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>` },
        { key: 'vie_professionnelle', titre: 'Vie professionnelle', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>` },
        { key: 'acces_metier', titre: 'Accès au métier', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>` },
        { key: 'niveau_acces_min._', titre: 'Niveau d\'accès minimal', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg>` }
    ];

    const getValue = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj);

    champsInteressants.forEach((champ, i) => {
        const valeur = getValue(metier, champ.key);
        if (valeur && typeof valeur === 'string') {
            const sectionHTML = `
                <div class="mb-6">
                    <h3 class="font-bold text-OrIAntation-darkblue mb-2 flex items-center gap-2">${champ.icon} ${champ.titre}</h3>
                    <div class="text-sm prose prose-sm max-w-none fiche-content">${valeur}</div>
                </div>
            `;
            if (i % 2 === 0) {
                column1HTML += sectionHTML;
            } else {
                column2HTML += sectionHTML;
            }
        }
    });

    ficheHTML += `
         <div class="grid md:grid-cols-2 gap-x-8 pt-4 border-t">
            <div class="fiche-colonne-contenu">${column1HTML}</div>
            <div class="fiche-colonne-contenu">${column2HTML}</div>
        </div>
    `;

    if (metier.vie_professionnelle) {
        const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(metier.libelle + " salaire débutant")}`;
        ficheHTML += `
            <div class="border-t pt-4 mt-4">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">Pour aller plus loin</h3>
                <a href="${googleSearchUrl}" target="_blank" class="inline-block text-sm bg-sky-100 text-sky-800 font-semibold py-1 px-3 rounded-lg hover:bg-sky-200 transition">🔎 Rechercher des estimations de salaire ↗</a>
            </div>`;
    }
    ficheHTML += `</div>`;
    
    ficheContainer.innerHTML = ficheHTML;
    ficheContainer.querySelector('button').addEventListener('click', () => { ficheContainer.innerHTML = ''; });
};

        metierInput.addEventListener('input', async () => {
            const searchTerm = metierInput.value.trim().toLowerCase();
            resultsWrapper.innerHTML = ''; 
            if (searchTerm.length < 3) return;

            try {
                const metiersRef = collection(db, "onisep_metiers_xml"); 
                const q = query(metiersRef, where("nom_metier", ">=", searchTerm), where("nom_metier", "<=", searchTerm + '\uf8ff'), limit(10));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    resultsWrapper.innerHTML = `<div class="p-2 text-slate-500">Aucun résultat direct.</div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const metier = doc.data();
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item p-2 cursor-pointer hover:bg-cyan-100';
                        resultDiv.textContent = metier.libelle || metier.nom_metier;
                        resultDiv.dataset.metier = JSON.stringify(metier);
                        resultDiv.dataset.libelle = metier.libelle || metier.nom_metier;
                        resultsWrapper.appendChild(resultDiv);
                    });
                }
            } catch (error) {
                console.error("Erreur de recherche Firestore : ", error);
            }
        });
    
        resultsWrapper.addEventListener('click', (e) => {
            const target = e.target.closest('.result-item');
            if (target) {
                metierInput.value = target.dataset.libelle;
                resultsWrapper.innerHTML = '';
                displayMetierFiche(JSON.parse(target.dataset.metier));
            }
        });

        document.addEventListener('click', (e) => {
            if (!searchResultsContainer.contains(e.target)) {
                resultsWrapper.innerHTML = '';
            }
        });
    };

    renderSavedMetiers();
    addSearchFunctionality(); // On active la recherche
    return div;
}

// ▼▼▼ REMPLACEZ TOUTE VOTRE FONCTION createStep2View PAR CE BLOC ▼▼▼

function createStep2View() {
    const config = stepsConfig.step2;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    if (!journalData.step2.combinations || !Array.isArray(journalData.step2.combinations)) {
        journalData.step2.combinations = [];
    }

    let currentExploration = {
        name: '',
        domains: [ { name: '', diplomas: '', jobs: '' }, { name: '', diplomas: '', jobs: '' } ],
        analysis: '',
        testimonial: ''
    };

    const renderSavedCombos = () => {
        const container = div.querySelector('#saved-combos-container');
        if (!container) return;
        const combinations = journalData.step2.combinations || [];
        if (combinations.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de combinaison enregistrée.</p>`;
        } else {
            container.innerHTML = combinations.map((combo, index) => `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${combo.name}</span>
                        <button type="button" data-index="${index}" class="delete-combo-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer">🗑️</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle">${renderStep2InJournal({ combinations: [combo] })}</div>
                </details>
            `).join('');
        }
        checkComparisonState();
    };

    const createDomainBlock = (index) => `
        <div class="p-4 bg-background-light rounded-lg border border-border-subtle mb-4">
            <h4 class="font-bold text-slate-700 mb-2">Domaine d'activité #${index}</h4>
            <div class="mb-2"><label class="text-sm font-medium">Nom du domaine</label><input type="text" id="domain_name_${index}" class="w-full mt-1 p-2 border rounded-lg" placeholder="Ex: Sciences de la santé"></div>
            <div class="mb-2"><label class="text-sm font-medium">Diplômes possibles</label><textarea rows="2" id="domain_diplomas_${index}" class="w-full mt-1 p-2 border rounded-lg" placeholder="Ex: PASS, Licence..."></textarea></div>
            <div><label class="text-sm font-medium">Métiers possibles</label><textarea rows="2" id="domain_jobs_${index}" class="w-full mt-1 p-2 border rounded-lg" placeholder="Ex: Médecin, Pharmacien..."></textarea></div>
        </div>
    `;

    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Atelier d'exploration de Combinaison</h2>
            <div class="mb-4">
                <label for="current-combo" class="block text-md font-medium text-slate-700 mb-2">Nomme ta combinaison</label>
                <input type="text" id="current-combo" class="w-full p-3 border rounded-lg" placeholder="Ex: Maths, Physique-Chimie, SVT">
            </div>
            <h3 class="text-lg font-semibold text-slate-800 my-4">Mes trouvailles sur Horizons21</h3>
            ${createDomainBlock(1)}
            ${createDomainBlock(2)}
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                <button type="button" data-action="analyse" class="ai-btn w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">✨ Analyser et lier au profil</button>
                <button type="button" data-action="testimonial" class="ai-btn w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">🗣️ Voir un témoignage</button>
            </div>
            <div id="loader" class="hidden my-4"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            <button type="button" id="save-combo-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">💾 Enregistrer cette combinaison</button>
        </div>
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes Combinaisons Enregistrées</h2>
        <div id="saved-combos-container" class="space-y-3 mb-8"></div>
        <div id="comparison-section" class="hidden mt-8">
    <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Comparateur de Combinaisons</h2>
    <p class="text-slate-600 mb-4">Maintenant que tu as exploré plusieurs pistes, génère un tableau comparatif pour t'aider à décider.</p>
    <div class="text-center">
        <button type="button" id="compare-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Comparer mes combinaisons</button>
    </div>
    <div id="loader-comparison" class="hidden"><div class="loader"></div></div>
    <div id="comparison-result" class="mt-6"></div>
</div>
        `;

    const resetWorkspace = () => {
        currentExploration = { name: '', domains: [{}, {}], analysis: '', testimonial: '' };
        div.querySelector('#current-combo').value = '';
        for (let i = 1; i <= 2; i++) {
            div.querySelector(`#domain_name_${i}`).value = '';
            div.querySelector(`#domain_diplomas_${i}`).value = '';
            div.querySelector(`#domain_jobs_${i}`).value = '';
        }
        div.querySelector('#result').innerHTML = '';
    };

    div.querySelector('#save-combo-btn').addEventListener('click', async () => {
        currentExploration.name = div.querySelector('#current-combo').value.trim();
        if (!currentExploration.name) {
            showInfoModal("Veuillez nommer la combinaison avant de l'enregistrer.");
            return;
        }
        for (let i = 0; i < 2; i++) {
            currentExploration.domains[i] = {
                name: div.querySelector(`#domain_name_${i+1}`).value.trim(),
                diplomas: div.querySelector(`#domain_diplomas_${i+1}`).value.trim(),
                jobs: div.querySelector(`#domain_jobs_${i+1}`).value.trim()
            };
        }
        journalData.step2.combinations.push(JSON.parse(JSON.stringify(currentExploration))); // Deep copy
        await saveData();
        await grantXp(30);
        renderSavedCombos();
        resetWorkspace();
        showSurpriseModal("Combinaison sauvegardée !", "Cette piste est maintenant dans ton journal.", 3000);
    });

    div.querySelectorAll('.ai-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const combo = div.querySelector('#current-combo').value.trim();
            if (!combo) { showInfoModal("Veuillez d'abord nommer la combinaison."); return; }
            
            const loader = div.querySelector('#loader');
            const resultDiv = div.querySelector('#result');
            loader.style.display = 'block';
            resultDiv.innerHTML = '';
            
            let prompt = '';
                        let isJson = false; // <-- ✅ CORRECTION : Déclarez la variable ici avec une valeur par défaut.

            if (action === 'analyse') {
                if (!journalData.step0.analysis) { showInfoModal("Veuillez d'abord compléter l'étape 'Mieux se connaître'."); loader.style.display = 'none'; return; }
                prompt = `Agis comme un conseiller d'orientation. Le profil d'un élève est : "${journalData.step0.analysis}". Il envisage la combinaison de spécialités : "${combo}". Fournis une analyse concise en 3 points : 1. Forces de la combinaison, 2. Lien avec son profil, 3. Piste d'exploration dans l'app.`;
 } else if (action === 'testimonial') {
                isJson = true;

                // NOUVEAU : Ajout d'une règle de pertinence stricte selon la classe de l'élève
                let strictnessInstruction = '';
                if (userGradeLevel === 'seconde') {
                    strictnessInstruction = `
                        # Règle Stricte de Pertinence
                        L'élève est en Seconde et explore une combinaison de 3 spécialités. Les résumés de tes 3 témoignages doivent **impérativement mentionner ou faire allusion aux TROIS spécialités** contenues dans : "${combo}". La pertinence est cruciale.
                    `;
                } else if (userGradeLevel === 'premiere') {
                    strictnessInstruction = `
                        # Règle Stricte de Pertinence
                        L'élève est en Première et explore une combinaison de 2 spécialités. Les résumés de tes 3 témoignages doivent **impérativement mentionner ou faire allusion aux DEUX spécialités** contenues dans : "${combo}". La pertinence est cruciale.
                    `;
                }
                prompt = `
                    Agis comme un coach d'orientation qui compile des ressources pour un élève s'intéressant à la combinaison de spécialités : "${combo}".
                    Ta mission est de générer 3 exemples de témoignages (vidéo, article, podcast) qui pourraient exister.

                    Pour chaque témoignage :
                    1. Invente un titre accrocheur et un court résumé.
                    2. Pour la clé "lien", ne cherche PAS une URL réelle. Construis SYSTÉMATIQUEMENT une URL de recherche pertinente pour trouver ce type de contenu.
                    3. **Règle impérative :** Au moins un des témoignages DOIT être une vidéo, et son lien doit pointer vers une recherche sur YouTube.
                       Exemple de lien YouTube : "https://www.youtube.com/results?search_query=témoignage+spécialités+${encodeURIComponent(combo)}".

                    # Format de Sortie OBLIGATOIRE
                    Ta réponse doit être **uniquement un objet JSON valide** contenant un tableau de 3 objets.
                    Chaque objet doit avoir les clés "titre", "resume", et "lien".
                `;}

            const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
            loader.style.display = 'none';
            resultDiv.innerHTML = linkify(result);
            currentExploration[action] = result;
        });
    });

const checkComparisonState = () => {
    const comparisonSection = div.querySelector('#comparison-section');
    const combinations = journalData.step2.combinations || [];
    if (comparisonSection) {
        comparisonSection.classList.toggle('hidden', combinations.length < 2);
    }
};

// ▼▼▼ AJOUTEZ CE BLOC D'ÉVÉNEMENT ▼▼▼

div.querySelector('#compare-btn').addEventListener('click', async () => {
    const loader = div.querySelector('#loader-comparison');
    const resultDiv = div.querySelector('#comparison-result');
    const combosAComparer = journalData.step2.combinations;
    if (combosAComparer.length < 2) return;
    
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const prompt = `Agis comme un conseiller d'orientation expert. Compare les combinaisons de spécialités suivantes pour un lycéen : ${JSON.stringify(combosAComparer.map(c => c.name))}.
    Crée un tableau comparatif au format Markdown qui analyse les forces, les faiblesses, et les principaux débouchés de chaque combinaison.
    Termine par une remarque de synthèse pour aider l'élève à choisir en fonction de son profil : ${getProfileSummary()}.
    Ta réponse doit être un JSON avec les clés "tableau" et "remarques".`;

    const result = await callOpenAI_API({ promptText: prompt, model: 'gpt-4o', isJson: true });
    
    loader.style.display = 'none';
    try {
        const data = extractJsonFromString(result);
        const markdownTableToHtml = (markdown) => {
            // ... (assurez-vous que la fonction markdownTableToHtml est accessible ou copiez-la depuis createStep1View)
            const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
            let html = '<div class="comparison-table-wrapper"><table>';
            const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th>${cell.trim()}</th>`).join('');
            html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
            lines.slice(2).forEach(line => {
                const rowCells = line.split('|').slice(1, -1).map(cell => `<td>${linkify(cell.trim())}</td>`).join('');
                html += `<tr>${rowCells}</tr>`;
            });
            html += `</tbody></table></div>`;
            return html;
        };
        resultDiv.innerHTML = markdownTableToHtml(data.tableau) + `<p class="mt-4 text-sm italic">${data.remarques}</p>`;
        journalData.step2.comparison = JSON.stringify(data);
        await saveData();
    } catch(e) { 
        resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage de la comparaison.</p>`;
    }
});

    div.querySelector('#saved-combos-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-combo-btn')) {
            const index = e.target.closest('.delete-combo-btn').dataset.index;
            if (await showConfirmationModal("Sûr de vouloir supprimer cette combinaison ?")) {
                journalData.step2.combinations.splice(index, 1);
                await saveData();
                renderSavedCombos();
            }
        }
    });

    renderSavedCombos();
    return div;
}

// Nouvelle fonction pour un rendu lisible dans le journal de bord
// ▼▼▼ REMPLACEZ L'INTÉGRALITÉ DE VOTRE FONCTION renderStep2InJournal PAR CELLE-CI ▼▼▼

function renderStep2InJournal(data) {
    if (!data || !data.combinations || data.combinations.length === 0) return '';

    // La fonction est maintenant conçue pour afficher les détails d'une seule combinaison
    const combo = data.combinations[0];
    let contentHTML = '';

    // Ajoute l'analyse de OrIA si elle existe
    if (combo.analysis) {
        contentHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">Analyse du profil :</p><div class="prose prose-sm max-w-none">${marked.parse(combo.analysis)}</div></div>`;
    }

    // Ajoute le témoignage de OrIA s'il existe
    if (combo.testimonial) {
        contentHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">Témoignage d'étudiant :</p><div class="prose prose-sm max-w-none">${marked.parse(combo.testimonial)}</div></div>`;
    }

    // Ajoute les trouvailles sur Horizons21 (les domaines)
    let domainesHTML = '';
    if (combo.domains && combo.domains.length > 0) {
         domainesHTML = combo.domains.map(domaine => {
            if (domaine.name || domaine.diplomas || domaine.jobs) {
                return `<li class="mb-2">
                            <p class="font-medium text-slate-700">Domaine : <span class="font-normal text-slate-600">${domaine.name || '...'}</span></p>
                            <p class="text-sm ml-4">Diplômes : <span class="font-normal text-slate-600">${domaine.diplomas || '...'}</span></p>
                            <p class="text-sm ml-4">Métiers : <span class="font-normal text-slate-600">${domaine.jobs || '...'}</span></p>
                        </li>`;
            }
            return '';
        }).join('');
    }
    if (domainesHTML) {
        contentHTML += `<div class="mt-4"><p class="font-semibold text-slate-700 mb-2">Trouvailles sur Horizons21 :</p><ul class="list-none space-y-2">${domainesHTML}</ul></div>`;
    }
    
    return contentHTML || '<p class="text-slate-500 italic">Aucun détail enregistré pour cette combinaison.</p>';
}


function createStep3View() {
    const config = stepsConfig.step3;
    const div = createStepView(config); // On garde la base (titre, description...)
    const form = div.querySelector('#stepForm');
    
    // On s'assure que la structure de données est un tableau
    if (!journalData.step3.formations || !Array.isArray(journalData.step3.formations)) {
        journalData.step3.formations = [];
    }
    
    // --- État local pour l'exploration en cours ---
    let currentExploration = {
        nom: '',
        attendus: '',
        mots_cles: '',
        analyses: {}
    };

    // --- Fonctions de rendu ---
    const renderSavedFormations = () => {
        const container = div.querySelector('#saved-formations-container');
        if (!container) return;

        const formations = journalData.step3.formations || [];
        if (formations.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de formation enregistrée.</p>`;
            checkComparisonState();
            return;
        }

        container.innerHTML = formations.map((formation, index) => `
            <details class="bg-background-light rounded-lg border border-border-subtle">
                <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                    <span>${formation.nom}</span>
                    <button type="button" data-index="${index}" class="delete-formation-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer cette formation">🗑️</button>
                </summary>
                <div class="p-3 border-t border-border-subtle">
                    <div class="mb-2"><p class="font-semibold">Attendus :</p><p class="whitespace-pre-wrap text-sm">${formation.attendus || 'Non renseignés.'}</p></div>
                    <div class="mb-2"><p class="font-semibold">Mots-clés :</p><p class="whitespace-pre-wrap text-sm">${formation.mots_cles || 'Non renseignés.'}</p></div>
                    ${formation.analyses.compatibilite ? `<div class="mb-2"><p class="font-semibold">Rapport de compatibilité :</p><p class="whitespace-pre-wrap text-sm">${formation.analyses.compatibilite}</p></div>` : ''}
                    ${formation.analyses.analyse_mots_cles ? `<div class="mb-2"><p class="font-semibold">Analyse des mots-clés :</p><p class="whitespace-pre-wrap text-sm">${formation.analyses.analyse_mots_cles}</p></div>` : ''}
                </div>
            </details>
        `).join('');
        checkComparisonState();
    };

    // --- Structure HTML de la nouvelle page ---
    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center"> Atelier d'exploration de Formation</h2>
            <div class="mb-4">
                <label for="current-formation" class="block text-md font-medium text-slate-700 mb-2">Rechercher une formation</label>
                <input type="text" id="current-formation" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Cherche une formation (Ex: BUT Informatique)...">
                <div id="search-results" class="relative"></div>
            </div>
             <div class="mb-4">
                <label for="current-attendus" class="block text-md font-medium text-slate-700 mb-2">Attendus (copier-coller depuis Parcoursup)</label>
                <textarea id="current-attendus" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici les attendus de la formation..."></textarea>
            </div>
            <div class="mb-4">
                <label for="current-motscles" class="block text-md font-medium text-slate-700 mb-2">Tes 3 mots-clés pour cette formation</label>
                <input type="text" id="current-motscles" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Logique, programmation, travail d'équipe">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 justify-center mb-4">
                <button type="button" data-action="compatibilite" class="ai-btn bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">🔎 Mon profil correspond-il ?</button>
                <button type="button" data-action="analyse_mots_cles" class="ai-btn bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">✨ Analyser mes mots-clés</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border border-border-subtle rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            <button type="button" id="save-formation-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">💾 Enregistrer cette formation dans mon journal</button>
        </div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">📚 Mes Formations Enregistrées</h2>
        <div id="saved-formations-container" class="space-y-3 mb-8"></div>
        
        <div id="comparison-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Comparateur de Formations</h2>
            <p class="text-slate-600 mb-4">Génère un tableau comparatif pour t'aider à choisir entre tes pistes.</p>
            <div class="text-center">
                <button type="button" id="compare-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Comparer mes formations</button>
            </div>
            <div id="loader-comparison" class="hidden"><div class="loader"></div></div>
            <div id="comparison-result" class="mt-6"></div>
        </div>
    `;

    // --- Logique des événements ---
    const resetWorkspace = () => {
        currentExploration = { nom: '', attendus: '', mots_cles: '', analyses: {} };
        div.querySelector('#current-formation').value = '';
        div.querySelector('#current-attendus').value = '';
        div.querySelector('#current-motscles').value = '';
        div.querySelector('#result').innerHTML = '';
    };

   div.querySelector('#save-formation-btn').addEventListener('click', async () => {
        currentExploration.nom = div.querySelector('#current-formation').value.trim();
        currentExploration.attendus = div.querySelector('#current-attendus').value.trim();
        currentExploration.mots_cles = div.querySelector('#current-motscles').value.trim();
        if (!currentExploration.nom) { showInfoModal("Veuillez renseigner un nom de formation."); return; }
        journalData.step3.formations.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(30);
        renderSavedFormations();
        resetWorkspace();
        showSurpriseModal("Formation sauvegardée !", "Cette piste est maintenant dans ton journal.", 3000);
    });
    
    // COLLEZ CE NOUVEAU BLOC À LA PLACE
div.querySelectorAll('.ai-btn').forEach(button => {
    button.addEventListener('click', async (e) => {
        const action = e.target.dataset.action;
        const nomFormation = div.querySelector('#current-formation').value.trim();
        const loader = div.querySelector('#loader');
        const resultDiv = div.querySelector('#result');
        
        if (!nomFormation) {
            showInfoModal("Veuillez d'abord renseigner le nom de la formation.");
            return;
        }

        resultDiv.innerHTML = '';
        loader.style.display = 'block';
        
        let prompt = '';
        let result = '';

        if (action === 'compatibilite') {
            const attendus = div.querySelector('#current-attendus').value.trim();
            if (!journalData.step0.analysis) { showInfoModal("Veuillez d'abord compléter l'étape 'Mieux se connaître'."); loader.style.display = 'none'; return; }
            if (!attendus) { showInfoModal("Veuillez copier-coller les attendus de la formation."); loader.style.display = 'none'; return; }
            
            const appFeaturesSummary = getAppFeaturesSummary();
            prompt = `Agis comme un conseiller d'orientation expert de Parcoursup, à la fois bienveillant et stratégique. Le dossier de l'élève est : "${getProfileSummary()}". Il s'intéresse à la formation "${nomFormation}" dont les attendus sont : "${attendus}".

# Ta Mission
Rédige une analyse de compatibilité détaillée et actionnable, en deux parties distinctes.

# Format de Sortie OBLIGATOIRE
La réponse doit utiliser des titres en gras (**Titre**) mais ne doit contenir AUCUN numéro (1., 2.) ni AUCUNE liste à puces (* ou -). Chaque partie doit être un paragraphe fluide.

**Points forts de ta candidature**
(Analyse ici 2 ou 3 points forts. Pour chaque point, fais un lien direct et explicite entre un élément spécifique du profil de l'élève et un "attendu" de la formation. Par exemple : "Ta compétence en [analyse] visible dans ton profil correspond directement à l'attendu '[citation de l'attendu]'...".)

**Pistes d'amélioration et de réflexion**
(Identifie un point de vigilance ou une compétence qui mériterait d'être mieux démontrée. Donne un conseil concret pour la rédaction de son projet de formation motivé sur Parcoursup. Termine IMPÉRATIVEMENT par une suggestion d'action précise et pertinente à réaliser dans l'un des outils de l'application OrIAntation pour travailler ce point.)`;
            
const apiResult = await callOpenAI_API({ promptText: prompt, withPersona: true });
            result = apiResult.replace(/(\d\.\s?\*\*|\*\*)/g, '').replace(/[\*-] /g, '');

        } else if (action === 'analyse_mots_cles') {
            const motsCles = div.querySelector('#current-motscles').value.trim();
            if (!motsCles) { showInfoModal("Veuillez renseigner vos 3 mots-clés."); loader.style.display = 'none'; return; }
            
            prompt = `Agis comme un examinateur bienveillant. Un lycéen s'intéresse à la formation : "${nomFormation}". Il pense que les 3 mots-clés qui la décrivent le mieux sont : "${motsCles}". Évalue sa réponse en te basant sur les "attendus" officiels de cette formation. Dis-lui si ses mots sont pertinents et propose des alternatives plus précises.`;
            
            result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        }

        loader.style.display = 'none';
        currentExploration.analyses[action] = result;
        resultDiv.innerHTML = linkify(result);
    });
});

    const checkComparisonState = () => {
        const comparisonSection = form.querySelector('#comparison-section');
        const formations = journalData.step3.formations || [];
        if (comparisonSection) {
            comparisonSection.classList.toggle('hidden', formations.length < 2);
        }
    };

    // ▼▼▼ AJOUTEZ CE BLOC COMPLET DANS createStep3View ▼▼▼

div.querySelector('#compare-btn').addEventListener('click', async () => {
    const loader = div.querySelector('#loader-comparison');
    const resultDiv = div.querySelector('#comparison-result');
    const formationsAComparer = journalData.step3.formations;
    if (formationsAComparer.length < 2) return;
    
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const prompt = `Agis comme un conseiller d'orientation expert. Compare les formations suivantes pour un lycéen : ${JSON.stringify(formationsAComparer.map(f => f.nom))}.
    Crée un tableau comparatif au format Markdown qui analyse les points clés : type de diplôme, durée, attendus principaux, et débouchés typiques.
    Termine par une remarque de synthèse pour aider l'élève à choisir en fonction de son profil : ${getProfileSummary()}.
    Ta réponse doit être un JSON avec les clés "tableau" et "remarques".`;

    const result = await callOpenAI_API({ promptText: prompt, model: 'gpt-4o', isJson: true });
    
    loader.style.display = 'none';
    try {
        const data = extractJsonFromString(result);
        const markdownTableToHtml = (markdown) => {
            if (!markdown) return '<p>Aucun tableau à afficher.</p>';
            const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
            if (lines.length < 2) return '<p>Le format du tableau est invalide.</p>';
            
            let html = '<div class="comparison-table-wrapper"><table class="w-full text-left border-collapse">';
            const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th class="p-3 border-b-2 font-bold bg-slate-100">${cell.trim()}</th>`).join('');
            html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
            lines.slice(2).forEach(line => {
                const rowCells = line.split('|').slice(1, -1).map(cell => `<td class="p-3 border-b align-top text-sm">${linkify(cell.trim())}</td>`).join('');
                html += `<tr>${rowCells}</tr>`;
            });
            html += `</tbody></table></div>`;
            return html;
        };
        resultDiv.innerHTML = markdownTableToHtml(data.tableau) + `<p class="mt-4 text-sm italic">${data.remarques}</p>`;
        journalData.step3.comparison = JSON.stringify(data);
        await saveData();
    } catch(e) { 
        console.error("Erreur lors de la création du tableau de comparaison:", e);
        resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage de la comparaison. Voici la réponse brute de l'IA :</p><pre class="whitespace-pre-wrap text-xs bg-slate-100 p-2 rounded mt-2">${result}</pre>`;
    }
});
    
    div.querySelector('#saved-formations-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-formation-btn')) {
            const index = e.target.closest('.delete-formation-btn').dataset.index;
            const confirmed = await showConfirmationModal("Es-tu sûr de vouloir supprimer cette formation de ton journal ?");
            if (confirmed) {
                journalData.step3.formations.splice(index, 1);
                await saveData();
                renderSavedFormations();
            }
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveData(); // Sauvegarde finale au cas où
        showView('menu');
    });

    // --- Logique de recherche de formation ---
    const addSearchFunctionality = () => {
        const formationInput = form.querySelector('#current-formation');
        const searchResultsContainer = form.querySelector('#search-results');
        const resultsWrapper = document.createElement('div');
        resultsWrapper.className = 'absolute z-10 w-full bg-white border border-slate-200 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg';
        searchResultsContainer.appendChild(resultsWrapper);

        formationInput.addEventListener('input', async () => {
            const searchTerm = formationInput.value.trim().toLowerCase();
            resultsWrapper.innerHTML = '';
            if (searchTerm.length < 4) return;

            try {
                // NOTE: Assumes a Firestore collection named 'parcoursup_formations' exists
                const formationsRef = collection(db, "parcoursup_formations");
                const q = query(formationsRef, where("search_terms", "array-contains", searchTerm), limit(10));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    resultsWrapper.innerHTML = `<div class="p-2 text-slate-500">Aucun résultat.</div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const formation = doc.data();
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item p-2 cursor-pointer hover:bg-cyan-100';
                        resultDiv.textContent = formation.formation_name; // Adjust field name as needed
                        resultDiv.addEventListener('click', () => {
                            formationInput.value = formation.formation_name;
                            resultsWrapper.innerHTML = '';
                        });
                        resultsWrapper.appendChild(resultDiv);
                    });
                }
            } catch (error) {
                console.error("Erreur de recherche Firestore : ", error);
            }
        });
        document.addEventListener('click', (e) => {
            if (!searchResultsContainer.contains(e.target)) {
                resultsWrapper.innerHTML = '';
            }
        });
    };
    
    // Initialisation
    renderSavedFormations();
    addSearchFunctionality();
    return div;
}

function createStep12View() {
    const config = stepsConfig.step12;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    form.innerHTML = `
        <div class="mb-8">
            <label for="city-input" class="block text-md font-medium text-slate-700 mb-2">Dans quelle ville imagines-tu tes futures études ?</label>
            <input type="text" id="city-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Lyon, Rennes, Bordeaux...">
        </div>
        <div class="bg-background-light border border-border-subtle p-3 rounded-lg text-sm text-slate-600 mb-4">
            <p><strong class="font-semibold text-OrIAntation-darkblue">Comment ça marche ?</strong> L'application demande à OrIA d'effectuer une recherche en temps réel pour trouver les coûts et les aides les plus récents pour la ville choisie, puis met en forme sa réponse.</p>
        </div>
        <div class="text-center mb-6">
            <button type="button" id="budget-btn" class="w-full sm:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">📊 Estimer le Budget Mensuel Étudiant</button>
        </div>
        <div id="loader-budget" class="hidden"><div class="loader"></div></div>
        <div id="budget-result" class="mb-10"></div>
        <hr class="my-10">
        <h3 class="text-xl font-bold text-center text-OrIAntation-darkblue mb-4">Recherche des Aides Financières</h3>
        <p class="text-center text-slate-600 mb-6">Découvrez les principaux dispositifs pour financer votre vie étudiante.</p>
        <div class="text-center mb-6">
            <button type="button" id="aides-btn" class="w-full sm:w-auto bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">💰 Chercher les Aides Disponibles</button>
        </div>
        <div id="loader-aides" class="hidden"><div class="loader"></div></div>
        <div id="aides-result" class="mb-10"></div>
    `;
    
    const cityInput = div.querySelector('#city-input');

    div.querySelector('#budget-btn').addEventListener('click', async () => {
    const city = cityInput.value.trim();
    if (!city) {
        showInfoModal("Veuillez renseigner une ville.");
        return;
    }
    const loader = div.querySelector('#loader-budget');
    const resultDiv = div.querySelector('#budget-result');
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const fuelPriceSP95 = 1.70;
    const maintenanceCostPerKm = 0.07;
    const avgConsumptionLPer100Km = 6.5;

    const prompt = `
Agis comme un conseiller financier expert pour étudiants. Pour la ville de "${city}", estime le budget mensuel moyen.
Ta réponse doit être **uniquement un objet JSON valide** avec deux clés : "budget" et "commentaires".

1.  **"budget"**: Un objet JSON avec les estimations chiffrées pour :
    * "loyer_crous"
    * "loyer_prive_studio"
    * "alimentation_min"
    * "alimentation_max"
    * "transport_collectif" (prix de l'abonnement mensuel jeune/étudiant)
    * "loisirs_min"
    * "loisirs_max"

2.  **"commentaires"**: Un tableau d'objets JSON. Tu dois obligatoirement inclure des commentaires pour les catégories "Loyer", "Transport", "Alimentation", et **"Loisirs"**.
    * Chaque objet doit contenir les clés : "categorie", "texte", "source_nom", et "source_url".
    * La valeur de "source_url" doit impérativement être une URL valide commençant par "https://". Si aucun site officiel n'existe, fournis un lien de recherche Google pertinent.
    * **Pour la catégorie "Transport" :** Dans la clé "texte", explique la différence de coût entre l'abonnement en commun et un véhicule personnel. Mentionne que le calcul pour un véhicule personnel dans notre simulateur est une estimation basée sur les moyennes suivantes : un prix du carburant de ${fuelPriceSP95}€/L, une consommation de ${avgConsumptionLPer100Km}L/100km, et un coût de maintenance (assurance, usure) de ${maintenanceCostPerKm}€ par kilomètre.
    * **Pour la catégorie "Loisirs" :** Dans la clé "texte", donne des conseils et des exemples sur la manière de gérer son budget loisirs (sorties, sport, culture) en tant qu'étudiant, en mentionnant les bons plans, les passes culturels (si existants dans la ville de "${city}") et les tarifs réduits.

Exemple de source_url attendue pour Lorient :
- Transport : "https://www.izilo.bzh"
- Loisirs à Lorient : "https://www.google.com/search?q=bons+plans+étudiants+Lorient"
`;

const result = await callOpenAI_API({
        promptText: prompt,
        model: 'gpt-4o', // Plus rapide et économique pour cette tâche
        isJson: true, // S'assure que la contrainte JSON est bien ajoutée    
        });

        loader.style.display = 'none';

    try {
        const data = extractJsonFromString(result);
        if (!data || !data.budget) {
            throw new Error("Réponse JSON invalide ou budget manquant.");
        }
        
        const budget = data.budget;
        const transportPublicCost = parseInt(budget.transport_collectif) || 0;
        const loyer_avg = Math.round(((parseInt(budget.loyer_crous) || 150) + (parseInt(budget.loyer_prive_studio) || 450)) / 2);
        const alim_avg = Math.round(((parseInt(budget.alimentation_min) || 150) + (parseInt(budget.alimentation_max) || 300)) / 2);
        const loisirs_avg = Math.round(((parseInt(budget.loisirs_min) || 30) + (parseInt(budget.loisirs_max) || 100)) / 2);

        let commentsHTML = '';
        if (data.commentaires && data.commentaires.length > 0) {
            commentsHTML += '<div class="border-t pt-6 mt-6"><h4 class="text-lg font-bold text-azimut-darkblue mb-3">💡 Détails et Sources :</h4><div class="space-y-3">';
            data.commentaires.forEach(comment => {
                const linkedText = linkify(comment.texte);
                commentsHTML += `
                    <div class="text-sm p-3 bg-background-light rounded-lg border border-border-subtle">
                        <p class="font-semibold text-slate-700">${comment.categorie}</p>
                        <div class="text-slate-600">${linkedText}</div>
                        ${comment.source_url ? `<a href="${comment.source_url}" target="_blank" class="text-primary-action hover:underline font-medium">Source : ${comment.source_nom} ↗</a>` : ''}
                    </div>
                `;
            });
            commentsHTML += '</div></div>';
        }

        // ÉTAPE 1 : On crée et affiche le HTML
        resultDiv.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <h3 class="text-xl font-bold text-azimut-darkblue mb-2">Construis ton Budget Personnalisé à ${city}</h3>
                <p class="text-sm text-slate-500 mb-6">Ajuste les curseurs pour voir comment ton budget total évolue.</p>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between items-center"><label for="loyer-slider" class="font-semibold text-slate-700 text-md">🏠 Loyer</label><span id="loyer-value" class="font-bold text-primary-action text-lg">${loyer_avg}€</span></div>
                        <input id="loyer-slider" type="range" min="${budget.loyer_crous || 150}" max="${budget.loyer_prive_studio || 450}" value="${loyer_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <div class="flex justify-between items-center"><label for="alim-slider" class="font-semibold text-slate-700 text-md">🛒 Alimentation & Vie courante</label><span id="alim-value" class="font-bold text-primary-action text-lg">${alim_avg}€</span></div>
                        <input id="alim-slider" type="range" min="${budget.alimentation_min || 150}" max="${budget.alimentation_max || 300}" value="${alim_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <div class="flex justify-between items-center"><label for="loisirs-slider" class="font-semibold text-slate-700 text-md">🎉 Loisirs & Sorties</label><span id="loisirs-value" class="font-bold text-primary-action text-lg">${loisirs_avg}€</span></div>
                        <input id="loisirs-slider" type="range" min="${budget.loisirs_min || 30}" max="${budget.loisirs_max || 100}" value="${loisirs_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t">
                    <h4 class="font-semibold text-slate-700 text-md mb-3">🚌 Budget Transport Mensuel</h4>
                    <p class="text-xs text-slate-500 mb-4">Ajuste la distance de tes trajets quotidiens (aller-retour) pour estimer le coût avec un véhicule personnel.</p>
                    <div>
                        <div class="flex justify-between items-center"><label for="km-slider" class="font-semibold text-slate-700 text-sm">Distance quotidienne (A/R)</label><span id="km-value" class="font-bold text-primary-action text-lg">20 km</span></div>
                        <input id="km-slider" type="range" min="0" max="100" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="mt-4 p-3 bg-background-light rounded-lg border space-y-2">
                        <div class="flex justify-between items-center text-sm"><span>Transport en commun (abonnement) :</span><strong id="transport-public-value" class="text-primary-action">${transportPublicCost}€</strong></div>
                        <div class="flex justify-between items-center text-sm"><span>Véhicule personnel (estim.) :</span><strong id="transport-private-value" class="text-primary-action">--€</strong></div>
                    </div>
                </div>
                <div class="mt-8 pt-4 border-t-4 border-cyan-500 text-center">
                    <p class="text-slate-600">Ton budget mensuel total estimé</p>
                    <p id="total-budget" class="text-4xl font-bold text-cyan-700 mt-1"></p>
                </div>
                ${commentsHTML}
            </div>
        `;
        
        // ÉTAPE 2 : SEULEMENT MAINTENANT, on sélectionne les éléments et on ajoute les écouteurs
        const loyerSlider = div.querySelector('#loyer-slider');
        const alimSlider = div.querySelector('#alim-slider');
        const loisirsSlider = div.querySelector('#loisirs-slider');
        const kmSlider = div.querySelector('#km-slider');
        
        const loyerValue = div.querySelector('#loyer-value');
        const alimValue = div.querySelector('#alim-value');
        const loisirsValue = div.querySelector('#loisirs-value');
        const kmValue = div.querySelector('#km-value');
        const transportPrivateValue = div.querySelector('#transport-private-value');
        const totalBudget = div.querySelector('#total-budget');

        const updateBudgetTotal = () => {
            const loyer = parseInt(loyerSlider.value);
            const alim = parseInt(alimSlider.value);
            const loisirs = parseInt(loisirsSlider.value);
            const dailyKm = parseInt(kmSlider.value);

            const monthlyKm = dailyKm * 22;
            const fuelCost = (monthlyKm / 100) * avgConsumptionLPer100Km * fuelPriceSP95;
            const maintenanceCost = monthlyKm * maintenanceCostPerKm;
            const transportPrivateCost = Math.round(fuelCost + maintenanceCost);
            
            const transportFinalCost = Math.min(transportPublicCost, transportPrivateCost);
            
            loyerValue.textContent = `${loyer}€`;
            alimValue.textContent = `${alim}€`;
            loisirsValue.textContent = `${loisirs}€`;
            kmValue.textContent = `${dailyKm} km`;
            transportPrivateValue.textContent = `${transportPrivateCost}€`;
            
            totalBudget.textContent = `${loyer + alim + loisirs + transportFinalCost}€`;
        };

        [loyerSlider, alimSlider, loisirsSlider, kmSlider].forEach(slider => {
            if (slider) { // Sécurité supplémentaire
                slider.addEventListener('input', updateBudgetTotal);
            }
        });
        updateBudgetTotal();

    } catch (e) {
        console.error("Erreur lors du traitement du budget:", e);
        resultDiv.innerHTML = `<p class="text-red-500 text-center">OrIA n'a pas pu générer une estimation structurée. Veuillez réessayer.</p><textarea class="w-full h-40 bg-slate-100 p-2 rounded mt-2" readonly>${result}</textarea>`;
    }
});

    div.querySelector('#aides-btn').addEventListener('click', async () => {
    const city = cityInput.value.trim();
    if (!city) {
        showInfoModal("Veuillez d'abord renseigner une ville.");
        return;
    }
    const loader = div.querySelector('#loader-aides');
    const resultDiv = div.querySelector('#aides-result');
    loader.style.display = 'block';
    resultDiv.innerHTML = '';



        const prompt = `
Agis comme un conseiller expert et un chercheur web méticuleux, spécialisé dans les aides financières pour les étudiants et les jeunes en France.

# Mission Principale :
Fournir une liste DIVERSIFIÉE et DÉTAILLÉE d'aides financières pour un étudiant habitant dans la ville de "${city}".

# Instructions Strictes et Séquentielles :

**ÉTAPE 1 : Utilisation des Données Nationales Fiables (Ne pas chercher, utiliser directement)**
Pour les aides nationales les plus importantes, tu DOIS utiliser les informations exactes ci-dessous.

* **Bourse sur Critères Sociaux (BCS) :**
    * **description**: "C'est l'aide principale versée par le CROUS aux étudiants dont les familles ont des revenus modestes. Son montant varie selon les revenus des parents, la composition de la famille et l'éloignement du lieu d'études. La demande se fait obligatoirement en constituant un Dossier Social Étudiant (DSE), généralement entre mars et mai pour la rentrée universitaire suivante."
    * **lien**: "https://www.messervices.etudiant.gouv.fr/envole/"
* **Aide au logement (APL/ALS) :**
    * **description**: "Versée par la Caisse d'Allocations Familiales (CAF), cette aide permet de réduire le montant du loyer. Elle est accessible à la plupart des étudiants, qu'ils soient boursiers ou non. La demande se fait en ligne sur le site de la CAF une fois le bail de location signé."
    * **lien**: "https://www.caf.fr/allocataires/aides-et-demarches/droits-et-prestations/logement/les-aides-personnelles-au-logement"

**ÉTAPE 2 : Recherche Complémentaire d'Aides (Locales et Thématiques)**
Maintenant, effectue une recherche web pour trouver **2 à 3 AUTRES aides pertinentes**, en te concentrant sur les catégories suivantes pour la ville de "${city}" :
- **Transport** (abonnements réduits, aides régionales...)
- **Loisirs & Culture** (Pass Culture, offres locales...)
- **Vie Quotidienne & Santé** (aides alimentaires, aide à l'achat d'équipement...)

**Règle :** Ne repropose PAS la BCS ou l'APL. Trouve des aides différentes et si possible spécifiques à "${city}" ou sa région.

**ÉTAPE 3 : Format de Sortie**
Ta réponse finale doit être UNIQUEMENT un objet JSON strictement valide. 
AUCUN texte ou commentaire en dehors du JSON.

Structure obligatoire :
{
  "aides": [
    {
      "nom": "Nom complet et officiel de l'aide",
      "description": "Description détaillée et précise en 3-4 phrases",
      "lien": "URL directe et officielle"
    }
  ]
}

⚠️ Rappels :
- Inclure les 2 aides nationales (BCS et APL) + 2 à 3 aides trouvées à l'étape 2.
- Respecter exactement la structure JSON donnée ci-dessus.
- Ne rien ajouter d'autre que l'objet JSON.
`;


const result = await callOpenAI_API({
        promptText: prompt,
        model: 'gpt-4o', // Plus rapide et économique pour cette tâche
        isJson: true, // S'assure que la contrainte JSON est bien ajoutée    
        });
                loader.style.display = 'none';

        try {
        // ✅ LA CORRECTION EST ICI :
        // On utilise notre fonction intelligente au lieu de JSON.parse directement.
        const data = extractJsonFromString(result);

        if (data && data.aides && data.aides.length > 0) {
            let htmlResult = '<div class="space-y-4">';
            data.aides.forEach(aide => {
                htmlResult += `
                    <div class="bg-white p-4 rounded-lg shadow border border-border-subtle">
                        <h4 class="font-bold text-cyan-700">${aide.nom}</h4>
                        <p class="text-slate-600 text-sm my-2">${aide.description}</p>
                        <a href="${aide.lien}" target="_blank" class="text-primary-action font-semibold hover:underline text-sm">En savoir plus ↗</a>
                    </div>
                `;
            });
            htmlResult += '</div>';
            resultDiv.innerHTML = htmlResult;
        } else {
            // Si data est null ou ne contient pas d'aides
            throw new Error("La structure des aides est invalide ou manquante.");
        }
    } catch (e) {
        resultDiv.innerHTML = `<p class="text-red-500 text-center">OrIA n'a pas pu formater les aides correctement. Voici sa réponse brute :</p><pre class="whitespace-pre-wrap text-xs bg-slate-100 p-2 rounded mt-2">${result}</pre>`;
    }
});

    return div;
}


function createGuideView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // --- 1. Définition de tous les blocs de contenu (version nettoyée) ---

    const styleHTML = `
        <style>
            .guide-container { line-height: 1.7; }
            .guide-container h2 { border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; color: #1A3263; margin-top: 60px; font-size: 1.75em; font-weight: 700; text-align: center; }
            .guide-container h3 { color: #1A3263; font-size: 1.3em; margin-top: 40px; font-weight: 600; text-align: center; }
            .guide-container .centered-subtitle { text-align: center; margin-bottom: 30px; }
            .guide-container h4 { margin-top: 0; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 0.75rem; justify-content: center; text-align: center; }
            .guide-container .logo { display: block; margin: 0 auto 10px auto; width: 250px; }
            .guide-container .info-box { padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid; }
            .guide-container .info-box-parents { background-color: #f7fee7; border-color: #84cc16; }
            .guide-container .info-box-parents h4 { color: #4d7c0f; display: block; }
            .guide-container .info-box-parents ul { padding-left: 20px; margin-bottom: 0; color: #65a30d; }
            .guide-container .info-box-teachers { background-color: #fff7ed; border-color: #f97316; }
            .guide-container .info-box-teachers h4 { color: #9a3412; display: block; }
            .guide-container .info-box-teachers ul { padding-left: 20px; margin-bottom: 0; color: #c2410c; }
            .guide-container .conseil-prof { background-color: #ecfeff; border-left: 4px solid #0891b2; padding: 15px; margin-top: 15px; border-radius: 8px; font-style: italic; color: #155e75; }
            .guide-container .conseil-prof h4 { color: #164e63; }
            .guide-container .etape { margin-bottom: 30px; padding-left: 10px; border-left: 2px solid #e2e8f0; }
            .guide-container ul { padding-left: 25px; margin-top: 10px; }
            .guide-container li { margin-bottom: 8px; }
        </style>
    `;

    const introHTML = `
    <img src="logo.png" alt="Logo OrIAntation" class="logo">
    <h2>OrIA comme Boussole 2.0 !!</h2>
    <p>Quand les autres outils d'orientation ne se contentent souvent que d'être de simples catalogues : de longues listes de métiers et de formations, OrIA fait la différence. Plus qu'une base de données, c'est une véritable expérience qui est offerte : une <strong>boussole 2.0, boostée à l'IA</strong>, conçue pour donner un avantage stratégique à celui qui l'utilise.</p>
    <div class="info-box conseil-prof" style="font-style: normal;">
        <h4 style="font-weight: bold; color: #3730A3; display:block;">Le rôle d'OrIA</h4>
        <p style="margin-top: 10px; font-style: normal;">Dans un système complexe, l'information brute ne suffit pas. OrIA n'est pas là pour donner les mêmes réponses à tout le monde. Son travail est de <strong>scanner le terrain, d'analyser les profils uniques et de détecter les "chemins de traverse"</strong> : ces parcours malins et ces opportunités cachées que la plupart des gens ne voient pas.</p>
        <p style="margin-top: 15px; font-style: normal;"><strong>L'utilisateur reste le Stratège </strong> quand OrIA est un copilote surpuissant qui sait fournir des données et des options non-conventionnelles. La mission : ne jamais se contenter d'un chemin, tracer les siens !! </p>
    </div>
`;



    const installationHTML = `
        <h2>Installer l'application sur votre téléphone</h2>
        <p>Pour un accès plus rapide, vous pouvez ajouter "OrIAntation" à l'écran d'accueil de votre téléphone. L'application se comportera comme une véritable application native.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
            <div class="bg-background-light p-4 rounded-lg border">
                <h4 class="text-OrIAntation-darkblue">📱 Sur iPhone (iOS)</h4>
                <ol class="list-decimal list-inside text-sm text-slate-700 mt-2 space-y-2">
                    <li>Ouvrez l'application dans le navigateur <strong>Safari</strong>.</li>
                    <li>Appuyez sur l'icône de partage (un carré avec une flèche vers le haut).</li>
                    <li>Faites défiler vers le bas et sélectionnez <strong>"Sur l'écran d'accueil"</strong>.</li>
                    <li>Confirmez en appuyant sur "Ajouter".</li>
                </ol>
            </div>
            <div class="bg-background-light p-4 rounded-lg border">
                <h4 class="text-OrIAntation-darkblue">📱 Sur Android</h4>
                <ol class="list-decimal list-inside text-sm text-slate-700 mt-2 space-y-2">
                    <li>Ouvrez l'application dans le navigateur <strong>Chrome</strong>.</li>
                    <li>Appuyez sur le menu (les trois points verticaux en haut à droite).</li>
                    <li>Sélectionnez <strong>"Installer l'application"</strong> ou "Ajouter à l'écran d'accueil".</li>
                    <li>Suivez les instructions pour confirmer.</li>
                </ol>
            </div>
        </div>
    `;


    const partie1ElevesHTML = `
        <h2>Partie 1 : Pour les Élèves</h2>
    <p>L'orientation peut ressembler à un océan de données : des centaines de métiers, des milliers de formations. Il est facile de s'y perdre. OrIAntation est ton <strong>tableau de bord personnel</strong>. Il ne te donne pas plus d'informations, il t'aide à trouver <strong>la bonne information pour toi</strong>.</p>
    <div class="info-box conseil-prof" style="font-style: normal;">
        <h4 style="font-weight: bold; color: #3730A3; display:block;">Ta méthode en 4 Étapes :</h4>
        <ul>
            <li><strong>Collecter tes données :</strong> Identifier avec précision tes forces, tes talents et tes motivations profondes.</li>
            <li><strong>Analyser les possibilités :</strong> Explorer les métiers et les formations comme un analyste, en te basant sur des informations fiables.</li>
            <li><strong>Centraliser ta réflexion :</strong> Transformer le Journal de Bord en une base de connaissances claire sur ton projet.</li>
            <li><strong>Prendre des décisions éclairées :</strong> Utiliser tes analyses pour préparer tes candidatures et planifier ton avenir.</li>
        </ul>
    </div>
`;


    const partie2ParentsHTML = `
        <h2>Partie 1 : Pour les Parents</h2>
    <p>Le rôle d'un parent n'est pas de donner les réponses, mais d'aider à poser les bonnes questions. OrIAntation est conçu comme un support pour vous aider à accompagner votre enfant dans sa propre analyse, en facilitant un dialogue constructif basé sur les données qu'il collecte.</p>
    <div class="info-box info-box-parents">
        <h4>Comment l'accompagner dans sa stratégie ?</h4>
        <ul>
            <li><strong>Adoptez une posture de "Consultant" :</strong> L'application est son espace d'analyse. Votre rôle est de l'aider à interpréter ses propres données, pas de les valider. Discutez de ses découvertes et des points qui le surprennent.</li>
            <li><strong>Utilisez le "Journal de Bord" partagé :</strong> Quand il partage son journal, c'est une invitation à analyser sa démarche. Le bouton "Préparer une discussion" vous donnera des angles d'approche basés sur ses propres écrits.</li>
            <li><strong>Conseil clé :</strong> Valorisez la méthode plus que la destination. L'objectif est qu'il apprenne à analyser un problème complexe (son orientation) pour prendre une décision éclairée, une compétence essentielle pour son avenir.</li>
        </ul>
    </div>
`;

    const partie3EnseignantsHTML = `
        <h2>Partie 1 : Pour les Enseignants</h2>
    <p>Au-delà d'un simple outil d'exploration, OrIAntation est une plateforme qui permet d'enseigner une compétence clé du <strong>Parcours Avenir</strong> : la capacité à prendre des décisions éclairées en analysant des informations complexes.</p>
    <div class="info-box info-box-teachers">
        <h4>Pistes d'utilisation pédagogique</h4>
        <ul>
            <li><strong>Suivi individualisé basé sur la donnée :</strong> Le "Journal de Bord" partagé n'est pas un simple cahier, c'est un véritable tableau de bord de la réflexion de l'élève. Il permet de préparer des entretiens de suivi basés sur des données concrètes.</li>
            <li><strong>Ateliers de "Data Literacy" :</strong> Les étapes d'OrIAntation peuvent servir de support pour des séances où les élèves apprennent à collecter de l'information (sur eux-mêmes et les formations), à l'analyser et à la synthétiser pour en tirer des conclusions.</li>
            <li><strong>Développer la pensée critique :</strong> La confrontation entre le profil de l'élève et les "attendus" des formations est un excellent exercice pour développer une argumentation structurée, essentielle pour le Grand Oral.</li>
        </ul>
    </div>
`;
    
    const seancesEnseignantsHTML = `
        <h2>Partie 3 : 10 Idées de Séances Clés en Main (1h)</h2>
    
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Séance 1 : Scanner son Profil - Devenir l'Expert de soi-même</h4><p><strong>Classe Cible :</strong> Seconde (début d'année), Première.<br><strong>Objectif Pédagogique :</strong> Amener l'élève à identifier ses propres "données" (forces, motivations) et à acquérir un vocabulaire précis pour se décrire.<br><strong>Étape Utilisée :</strong> Mieux se connaître.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Introduction : "Votre orientation est un problème à résoudre. La première étape est de collecter les bonnes données sur vous-même." (10min). 2. Les élèves complètent le questionnaire pour générer leur profil de base (25min). 3. Discussion collective sur la signification des <strong>Archétypes</strong> et du <strong>graphique RIASEC</strong> comme outils d'analyse (15min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Séance 2 : Le Simulateur Stratégique de Spécialités</h4><p><strong>Classe Cible :</strong> Seconde (2ème trimestre).<br><strong>Objectif Pédagogique :</strong> Utiliser la simulation pour prendre des décisions éclairées sur les spécialités.<br><strong>Étape Utilisée :</strong> Le simulateur de spécialités.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Rappel des enjeux (5min). 2. En binômes, les élèves testent 2 combinaisons, utilisent OrIA pour obtenir un <strong>témoignage d'étudiant</strong> et analysent le lien avec leur profil (30min). 3. Mise en commun : chaque binôme partage la combinaison la plus "inattendue" qu'il a trouvée (15min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Séance 3 : Le Portfolio - Transformer l'Expérience en Compétence</h4><p><strong>Classe Cible :</strong> Première (fin d'année), Terminale.<br><strong>Objectif Pédagogique :</strong> Apprendre à l'élève à "extraire" et formuler des compétences à partir de son vécu (méthode STAR).<br><strong>Étape Utilisée :</strong> Mon Portfolio de Compétences.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Introduction : "Vos expériences sont des mines de compétences. Apprenons à les extraire." (10min). 2. Chaque élève choisit une expérience (stage, passion, projet...) et utilise l'<strong>Assistant de Portfolio</strong> pour la transformer en texte valorisé (30min). 3. Partage volontaire de 2-3 exemples pour montrer la transformation (10min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Séance 4 : Débunker l'Orientation - Chasse aux Mythes</h4><p><strong>Classe Cible :</strong> Tous niveaux.<br><strong>Objectif Pédagogique :</strong> Développer l'esprit critique et la littératie informationnelle en déconstruisant les idées reçues.<br><strong>Étape Utilisée :</strong> Fact Checking.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Constitution d'équipes (5min). 2. Lancement d'un défi : chaque équipe choisit un domaine et doit obtenir le meilleur score au quiz "Chasse aux Mythes" (30min). 3. Chaque équipe présente à la classe le mythe le plus surprenant qu'elle a déconstruit (15min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Séance 5 : Ancrer son Projet dans la Réalité</h4><p><strong>Classe Cible :</strong> Première (fin d'année), Terminale.<br><strong>Objectif Pédagogique :</strong> Intégrer les contraintes matérielles (budget, logement) comme une donnée clé du projet.<br><strong>Étape Utilisée :</strong> Simulateur Vie Étudiante.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Introduction : "Un projet viable est un projet financé." (5min). 2. Les élèves utilisent le <strong>simulateur de budget</strong> pour une ville qui les intéresse et explorent les <strong>aides financières</strong> (30min). 3. Discussion collective sur les écarts de coût de la vie et les aides méconnues (15min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> Séance 6 : Se Préparer au Contact - L'Enquête Métier</h4><p><strong>Classe Cible :</strong> Première, Terminale.<br><strong>Objectif Pédagogique :</strong> Développer l'aisance orale et la capacité à mener une discussion structurée.<br><strong>Étape Utilisée :</strong> L'Expérience.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Introduction sur la valeur d'un retour "terrain" (10min). 2. OrIA génère des questions personnalisées pour chaque élève, puis ils s'entraînent avec le <strong>simulateur d'entretien</strong> (30min). 3. Débriefing sur les difficultés et les bonnes pratiques (10min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> Séance 7 : Atelier d'Écriture - Le Projet de Formation Motivé</h4><p><strong>Classe Cible :</strong> Terminale.<br><strong>Objectif Pédagogique :</strong> Apprendre à argumenter et à structurer un écrit de candidature.<br><strong>Étape Utilisée :</strong> Préparer sa candidature.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Analyse collective d'un PFM anonymisé (10min). 2. Les élèves utilisent l'<strong>Atelier d'écriture</strong> : ils génèrent une structure, rédigent un paragraphe, puis utilisent OrIA pour obtenir des pistes d'amélioration (35min). 3. Partage d'un "avant/après" pour illustrer la valeur ajoutée (5min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m15.75 15.75-2.489-2.489m0 0a3.375 3.375 0 1 0-4.773-4.773 3.375 3.375 0 0 0 4.774 4.774ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Séance 8 : Débloquer sa Réflexion - Le Radar</h4><p><strong>Classe Cible :</strong> Tous niveaux (particulièrement les élèves "perdus" ou "bloqués").<br><strong>Objectif Pédagogique :</strong> Utiliser la créativité de OrIA pour ouvrir de nouvelles pistes et relancer une dynamique de recherche.<br><strong>Étape Utilisée :</strong> Le Radar à Opportunités.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Discussion sur le droit d'être indécis (5min). 2. Chaque élève utilise le bouton "Me surprendre !" et note la suggestion de OrIA (20min). 3. En petits groupes, ils discutent de la pertinence (ou non) de la suggestion et de ce qu'elle révèle sur leur profil (25min).</div></div>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> Séance 9 : Planifier son Année - Le Rétroplanning</h4><p><strong>Classe Cible :</strong> Tous niveaux (en début d'année).<br><strong>Objectif Pédagogique :</strong> Visualiser l'année à venir, dédramatiser les échéances et développer des compétences de planification.<br><strong>Étape Utilisée :</strong> Mon Rétroplanning.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Présentation des grandes échéances de l'année (10min). 2. Les élèves génèrent leur <strong>rétroplanning personnalisé</strong> et cochent les tâches déjà entamées (25min). 3. Discussion sur la tâche du mois qui leur semble la plus importante (15min).</div></div>
    
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> Séance 10 : Stratégie "Plan B" - Gérer l'Incertitude</h4><p><strong>Classe Cible :</strong> Terminale.<br><strong>Objectif Pédagogique :</strong> Développer la résilience et la capacité à envisager des alternatives de manière constructive.<br><strong>Étape Utilisée :</strong> Anticiper la suite.</p><div class="conseil-prof"><strong>Déroulement :</strong> 1. Discussion sur la gestion du stress et des réponses de Parcoursup (10min). 2. Les élèves utilisent la <strong>simulation de conversation "Plan B"</strong> pour réfléchir à des alternatives à leur vœu n°1 (35min). 3. Réflexion individuelle sur les pistes qui ont émergé (5min).</div></div>
`;

    const partie4FonctionnalitesHTML_base = `
    <h2>Partie 2 : Exploration Détaillée des Fonctionnalités</h2>
    <p class="text-slate-600 mb-6 text-center">Ton menu est organisé en deux grandes sections pour t'aider à naviguer plus facilement : ton Tableau de Bord personnel et ton Parcours d'Orientation étape par étape.</p>

    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">🚀 Le Tableau de Bord</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont tes outils centraux, ceux que tu utiliseras tout au long de ton parcours pour suivre tes progrès, synthétiser tes idées et planifier tes actions.</p>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg> Mon Journal de Bord</h4><p><strong>Objectif :</strong> Centraliser et synthétiser toutes tes réflexions au même endroit.</p><p><strong>Fonctionnement :</strong> Retrouve les synthèses de ton travail (organisées en sections dépliables), ta <strong>Carte d'Orientation</strong> et ton profil visuel. OrIA peut générer un <strong>"Fil Rouge"</strong> pour résumer ton projet. Une fonction de partage est disponible pour échanger avec tes proches.</p><div class="conseil-prof"><strong>Conseil :</strong> Ce journal est la base de discussion la plus concrète et la plus riche que tu puisses avoir avec tes parents ou ton professeur principal.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg> Mon Rétroplanning</h4><p><strong>Objectif :</strong> Planifier son année sans stress en visualisant les grandes échéances.</p><p><strong>Fonctionnement :</strong> OrIA génère un calendrier d'actions mois par mois adapté à ta classe (Seconde, Première, Terminale). Tu peux cocher les tâches accomplies.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est l'outil parfait pour ne jamais être pris de court. Une année bien planifiée est une année plus sereine.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Mieux se connaître</h4><p><strong>Objectif :</strong> Dresser un portrait précis de ta personnalité, de tes intérêts et de ce qui te motive.</p><p><strong>Fonctionnement :</strong> Tu réponds à un questionnaire de 30 questions. OrIA analyse tes réponses pour révéler ton <strong>Archétype de personnalité</strong> (ex: "L'Architecte Logique"), génère une analyse détaillée et crée une <strong>synthèse visuelle (graphique RIASEC)</strong> de tes pôles d'intérêts. Tu peux aussi croiser ces résultats avec ceux de tests externes pour une analyse encore plus fine.</p><div class="conseil-prof"><strong>Conseil :</strong> Réponds honnêtement ! Il n'y a pas de bonnes ou de mauvaises réponses. Le but est de créer une base solide pour la suite.</div></div>

    <hr style="margin: 60px 0;">

    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">🧭 Le Parcours d'Orientation</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les étapes guidées pour construire ton projet. Elles sont organisées en trois grandes phases logiques.</p>
    
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">1. Explorer les Possibilités</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Le simulateur de spécialités (avec Horizons21)</h4><p><strong>Objectif :</strong> Faire le lien entre les matières choisies au lycée et les filières d'études supérieures.</p><p><strong>Fonctionnement :</strong> Teste des combinaisons de spécialités et analyse les "horizons" qu'elles t'ouvrent. OrIA peut aussi te donner un témoignage d'étudiant pour t'aider à te projeter.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est l'outil essentiel pour faire tes choix en fin de Seconde et de Première de manière éclairée.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg> Les Fondations (avec Onisep)</h4><p><strong>Objectif :</strong> Découvrir des métiers sur la base d'informations fiables et officielles.</p><p><strong>Fonctionnement :</strong> Explore des fiches métiers sur Onisep.fr. Pour chaque métier, OrIA peut <strong>simuler une "journée type"</strong>, trouver des <strong>témoignages</strong> ou générer un <strong>tableau comparatif</strong> pour t'aider à choisir entre plusieurs pistes.</p><div class="conseil-prof"><strong>Conseil :</strong> L'Onisep est la source la plus neutre et la plus complète. C'est le point de départ incontournable.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg> Le Catalogue (avec Parcoursup)</h4><p><strong>Objectif :</strong> Apprendre à utiliser le moteur de recherche des formations post-bac comme un expert.</p><p><strong>Fonctionnement :</strong> Copie-colle les "attendus" d'une formation qui t'intéresse, et OrIA génère un <strong>rapport de compatibilité personnalisé</strong> en analysant l'ensemble de ton journal de bord pour voir si ton profil correspond.</p><div class="conseil-prof"><strong>Conseil :</strong> Utilise Parcoursup dès la Seconde pour explorer, sans la pression des vœux. C'est le meilleur catalogue de formations qui existe.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg> L'Actu</h4><p><strong>Objectif :</strong> Rester informé(e) sur le monde des études et des métiers en consultant des articles ou des classements.</p><p><strong>Fonctionnement :</strong> Explore des sites comme L'Étudiant.fr ou Studyrama. Pour chaque info que tu trouves, OrIA peut l'analyser pour te dire en quoi elle est pertinente par rapport à ton propre profil.</p><div class="conseil-prof"><strong>Conseil :</strong> Croiser les sources d'information est essentiel. L'analyse de OrIA t'aidera à prendre du recul sur ce que tu lis.</div></div>
    
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">2. Se Connecter au Monde Réel</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> L'Expérience (avec Inspire)</h4><p><strong>Objectif :</strong> Obtenir un retour authentique de la part d'étudiants.</p><p><strong>Fonctionnement :</strong> L'outil t'aide à préparer des questions pertinentes, puis te propose un <strong>simulateur d'entretien</strong> pour t'entraîner à discuter avec un "étudiant éclaireur" virtuel.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est le meilleur moyen de connaître la "vraie vie" d'une formation, au-delà des brochures officielles.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> Passer à l'action</h4><p><strong>Objectif :</strong> Préparer des rencontres avec des professionnels et des visites d'établissements.</p><p><strong>Fonctionnement :</strong> Utilise le <strong>gestionnaire de contacts</strong> pour ajouter ton réseau personnel et trouver des professionnels via OrIA. Tu peux suivre le statut de tes prises de contact et obtenir de l'aide pour rédiger tes mails.</p><div class="conseil-prof"><strong>Conseil :</strong> La recherche en ligne est une chose, la réalité du terrain en est une autre. Une rencontre peut tout changer !</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg> Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> Trouver des événements (salons, JPO) et des structures d'aide près de chez toi.</p><p><strong>Fonctionnement :</strong> Indique ta ville, et OrIA recherche les événements pertinents. Tu peux même ajouter un salon ou une JPO directement à ton Rétroplanning en un clic.</p><div class="conseil-prof"><strong>Conseil :</strong> L'orientation se fait aussi sur le terrain. Une visite ou une rencontre peut parfois tout changer.</div></div>

    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">3. Construire son Projet</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Portfolio de Compétences</h4><p><strong>Objectif :</strong> Créer un portfolio unique de tes atouts, basé sur ce que tu fais et ce que tu es, pour valoriser tes candidatures (Parcoursup, Grand Oral...).</p><p><strong>Fonctionnement :</strong> Cette étape propose deux ateliers puissants : 1. L'<strong>Analyseur d'expériences</strong> transforme tes récits (stage, passion, projet...) en paragraphes rédigés et percutants. 2. Le <strong>Détecteur de compétences</strong> révèle tes forces transversales (Rigueur, Créativité, Leadership...) via un quiz rapide.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est une étape cruciale. Savoir parler de soi et de ses compétences est un atout majeur pour Parcoursup et au-delà.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> Préparer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> Rédiger un "projet de formation motivé" clair et percutant pour Parcoursup.</p><p><strong>Fonctionnement :</strong> OrIA te propose une structure pour ta lettre. Ensuite, l'<strong>Atelier d'écriture</strong> te permet de soumettre un brouillon de paragraphe et d'obtenir des conseils ciblés pour l'améliorer, sans jamais l'écrire à ta place.</p><div class="conseil-prof"><strong>Conseil :</strong> Une lettre bien structurée a plus d'impact qu'un long texte confus. Cet outil t'apprend à être clair et convaincant.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Fact Checking</h4><p><strong>Objectif :</strong> Tester tes connaissances et déconstruire les idées reçues sur certains métiers ou filières.</p><p><strong>Fonctionnement :</strong> L'outil te propose deux ateliers : la "Chasse aux Mythes" (quiz générique) et le "Défi Personnalisé" (un quiz sur-mesure qui te questionne par rapport à ton propre profil).</p><div class="conseil-prof"><strong>Conseil :</strong> C'est une façon ludique de vérifier tes informations et d'ouvrir tes horizons en combattant les préjugés.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Simulateur Vie Étudiante</h4><p><strong>Objectif :</strong> Se projeter concrètement dans sa future vie d'étudiant.</p><p><strong>Fonctionnement :</strong> Estime le coût de la vie dans ta future ville d'études et découvre les principales aides financières, avec des liens directs et fiables vers les sites officiels.</p><div class="conseil-prof"><strong>Conseil :</strong> L'aspect financier est une partie importante du projet. L'anticiper permet de faire des choix plus sereins.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> Préparer l'après-Parcoursup, y compris les refus.</p><p><strong>Fonctionnement :</strong> Utilise la <strong>simulation de conversation "Plan B"</strong> pour dialoguer avec OrIA et explorer des alternatives de manière constructive si ton vœu n°1 est refusé.</p><div class="conseil-prof"><strong>Conseil :</strong> Une bonne orientation, c'est aussi être bien préparé pour la suite. Ces étapes te donnent les clés pour une transition réussie.</div></div>
`;
    // Ajoutez ces blocs de code après partie4FonctionnalitesHTML_base
// ▼▼▼ REMPLACE TA VARIABLE "partie4FonctionnalitesHTML_parents" PAR CELLE-CI ▼▼▼

const partie4FonctionnalitesHTML_parents = `
    <h2>Partie 2 : Exploration Détaillée des Fonctionnalités</h2>
    <p class="text-slate-600 mb-6 text-center">Le menu de votre enfant est organisé en deux grandes sections pour l'aider à naviguer : son Tableau de Bord personnel et son Parcours d'Orientation étape par étape.</p>

    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">🚀 Le Tableau de Bord</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont ses outils centraux, qu'il/elle utilisera tout au long de son parcours pour suivre ses progrès, synthétiser ses idées et planifier ses actions.</p>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg> Mon Journal de Bord</h4><p><strong>Objectif :</strong> Lui permettre de centraliser et de synthétiser toutes ses réflexions au même endroit.</p><p><strong>Fonctionnement :</strong> Il/elle y retrouve les synthèses de son travail (dans des sections dépliables), sa <strong>Carte d'Orientation</strong> et son profil visuel. Une fonction de <strong>partage</strong> est disponible pour vous permettre d'échanger avec lui/elle.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Ce journal est la base de discussion la plus concrète et la plus riche que vous puissiez avoir avec votre enfant. Utilisez le bouton "Préparer une discussion" sur la page partagée.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg> Mon Rétroplanning</h4><p><strong>Objectif :</strong> L'aider à planifier son année sans stress en visualisant les grandes échéances.</p><p><strong>Fonctionnement :</strong> OrIA génère un calendrier d'actions mois par mois adapté à sa classe. Il/elle peut cocher les tâches accomplies.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est l'outil parfait pour ne jamais être pris de court. Une année bien planifiée est une année plus sereine.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Mieux se connaître</h4><p><strong>Objectif :</strong> Aider votre enfant à dresser un portrait de sa personnalité et de ses préférences.</p><p><strong>Fonctionnement :</strong> Il/elle répond à un questionnaire. OrIA analyse ses réponses pour révéler son <strong>Archétype de personnalité</strong> et créer un <strong>graphique de ses pôles d'intérêts (RIASEC)</strong>.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Invitez-le/la à répondre honnêtement. L'objectif est de l'aider à mieux se connaître, pas de l'évaluer. C'est un excellent point de départ pour une discussion.</div></div>

    <hr style="margin: 60px 0;">

    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">🧭 Le Parcours d'Orientation</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les étapes guidées pour construire son projet. Elles sont organisées en trois grandes phases logiques.</p>
    
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">1. Explorer les Possibilités</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Le simulateur de spécialités (avec Horizons21)</h4><p><strong>Objectif :</strong> L'aider à faire le lien entre les matières choisies au lycée et les filières d'études supérieures.</p><p><strong>Fonctionnement :</strong> Il/elle teste des combinaisons de spécialités et analyse les "horizons" (domaines d'études) qu'elles lui ouvrent.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est l'outil essentiel pour l'aider à faire des choix éclairés en fin de Seconde et de Première.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg> Les Fondations (avec Onisep)</h4><p><strong>Objectif :</strong> L'aider à découvrir des métiers sur la base d'informations fiables et officielles.</p><p><strong>Fonctionnement :</strong> Il/elle peut explorer des fiches métiers, mais aussi utiliser OrIA pour <strong>simuler une "journée type"</strong> d'un professionnel ou générer un <strong>tableau comparatif</strong> entre plusieurs métiers qui l'intéressent.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'Onisep est la source la plus neutre et la plus complète. C'est le point de départ incontournable pour ses recherches.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg> Le Catalogue (avec Parcoursup)</h4><p><strong>Objectif :</strong> L'aider à utiliser le moteur de recherche des formations post-bac comme un expert.</p><p><strong>Fonctionnement :</strong> L'outil va au-delà de la simple recherche. Il peut générer un <strong>rapport de compatibilité personnalisé</strong> entre le profil complet de votre enfant et les "attendus" d'une formation.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Utiliser Parcoursup dès la Seconde pour explorer, sans la pression des vœux, est une excellente stratégie. C'est le meilleur catalogue de formations qui existe.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg> L'Actu</h4><p><strong>Objectif :</strong> L'aider à s'informer sur les classements et l'actualité du monde des études.</p><p><strong>Fonctionnement :</strong> Quand il/elle trouve une information intéressante, OrIA peut l'analyser en la croisant avec son profil personnel pour voir en quoi elle est pertinente pour lui/elle.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Discuter de l'actualité de l'orientation est un bon moyen de rester connecté(e) à sa réflexion.</div></div>
    
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">2. Se Connecter au Monde Réel</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> L'Expérience (avec Inspire)</h4><p><strong>Objectif :</strong> L'encourager à obtenir un retour authentique de la part d'étudiants.</p><p><strong>Fonctionnement :</strong> L'outil l'aide à préparer des questions pertinentes et propose un <strong>simulateur d'entretien</strong> pour qu'il/elle s'entraîne à discuter avec un étudiant virtuel et gagne en confiance.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est le meilleur moyen de connaître la "vraie vie" d'une formation, au-delà des brochures officielles.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> Passer à l'action</h4><p><strong>Objectif :</strong> L'aider à préparer des rencontres avec des professionnels et des visites d'établissements.</p><p><strong>Fonctionnement :</strong> L'application propose un <strong>gestionnaire de contacts</strong> où il/elle peut lister des personnes à interroger, suivre l'avancement de ses démarches et obtenir de l'aide pour rédiger un mail de contact.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Une rencontre sur le terrain peut tout changer. Vous pouvez aussi l'aider en mobilisant votre propre réseau.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg> Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> L'aider à trouver des événements et des structures d'aide près de chez lui/elle.</p><p><strong>Fonctionnement :</strong> Il/elle indique sa ville, et OrIA recherche les événements pertinents. Il/elle peut ajouter une JPO ou un salon directement à son <strong>Rétroplanning</strong>.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'orientation se fait aussi sur le terrain. Accompagner votre enfant à un salon peut être un moment d'échange privilégié.</div></div>

    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">3. Construire son Projet</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Portfolio de Compétences</h4><p><strong>Objectif :</strong> L'aider à créer un portfolio unique de ses atouts, basé sur ce qu'il/elle fait et ce qu'il/elle est.</p><p><strong>Fonctionnement :</strong> Cette étape propose deux ateliers. L'un l'aide à transformer ses expériences (stage, projet, passion...) en paragraphes valorisables pour ses candidatures. L'autre est un 'détecteur' rapide pour révéler ses compétences transversales (rigueur, créativité...).</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est une étape cruciale pour son dossier Parcoursup et son Grand Oral. Encouragez-le/la à la compléter en détail.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> Préparer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> L'aider à rédiger un "projet de formation motivé" clair et percutant pour Parcoursup.</p><p><strong>Fonctionnement :</strong> En plus de lui proposer une structure, l'outil dispose d'un <strong>Atelier d'écriture</strong> où il/elle peut soumettre un brouillon de paragraphe et recevoir des conseils pour l'améliorer.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Une lettre bien structurée a plus d'impact qu'un long texte confus. Cet outil lui apprend à être clair et convaincant.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Fact Checking</h4><p><strong>Objectif :</strong> Tester ses connaissances et déconstruire les idées reçues sur certains métiers ou filières.</p><p><strong>Fonctionnement :</strong> Il/elle peut lancer un quiz générique ("Chasse aux Mythes") ou un "Défi Personnalisé" qui le questionne par rapport à son propre profil.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est une façon ludique de vérifier ses informations et d'ouvrir ses horizons en combattant les préjugés.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Simulateur Vie Étudiante</h4><p><strong>Objectif :</strong> L'aider à se projeter concrètement dans sa future vie d'étudiant.</p><p><strong>Fonctionnement :</strong> Il/elle peut estimer le coût de la vie dans sa future ville d'études et découvrir les principales aides financières. C'est un excellent support pour une discussion en famille.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'aspect financier est une partie importante du projet. L'anticiper ensemble permet de faire des choix plus sereins.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> L'aider à préparer l'après-Parcoursup et à gérer le stress des réponses.</p><p><strong>Fonctionnement :</strong> OrIA propose une <strong>simulation de conversation "Plan B"</strong> pour l'aider à réfléchir à des alternatives de manière positive en cas de refus de son vœu n°1.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Une bonne orientation, c'est aussi être bien préparé pour la suite. Cet outil peut l'aider à relativiser et à envisager d'autres chemins.</div></div>
`;

const partie4FonctionnalitesHTML_enseignants = `
    <h2>Partie 2 : Exploration Détaillée des Fonctionnalités</h2>
    <p class="text-slate-600 mb-6 text-center">Le menu de l'élève est organisé en deux grandes sections pour l'aider à naviguer : son Tableau de Bord personnel et son Parcours d'Orientation étape par étape.</p>

    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">🚀 Le Tableau de Bord</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les outils centraux de l'élève, conçus pour le suivi, la synthèse et la planification de sa démarche d'orientation.</p>

    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg> Mon Journal de Bord</h4><p><strong>Objectif :</strong> Centraliser la réflexion de l'élève pour faciliter le suivi.</p><p><strong>Fonctionnement :</strong> Le journal synthétise tout le travail de l'élève. La fonction de <strong>partage</strong> est essentielle : elle vous donne accès à une vue d'ensemble de sa démarche avant un entretien.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Ce journal est la base de discussion la plus concrète et la plus riche que vous puissiez avoir avec un élève lors d'un entretien de suivi. Utilisez le bouton "Préparer une discussion" sur la page partagée.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg> Mon Rétroplanning</h4><p><strong>Objectif :</strong> Aider l'élève à planifier son année et à visualiser les échéances.</p><p><strong>Fonctionnement :</strong> OrIA génère un calendrier d'actions mois par mois adapté à chaque niveau de classe.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Un excellent support visuel à présenter en début d'année pour fixer le cap du Parcours Avenir.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Mieux se connaître</h4><p><strong>Objectif :</strong> Permettre à l'élève de dresser un portrait de sa personnalité, de ses intérêts et de ses motivations.</p><p><strong>Fonctionnement :</strong> L'élève répond à un questionnaire de 30 questions. OrIA analyse ses réponses pour révéler un <strong>Archétype de personnalité</strong>, génère une analyse détaillée et un <strong>graphique de ses pôles d'intérêts (RIASEC)</strong>.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est une excellente base pour un entretien individuel. L'Archétype et le graphique RIASEC fournissent un vocabulaire et un support visuel pour aider l'élève à parler de lui.</div></div>

    <hr style="margin: 60px 0;">

    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">🧭 Le Parcours d'Orientation</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les étapes guidées pour construire son projet. Elles sont organisées en trois grandes phases logiques, chacune offrant des opportunités pédagogiques.</p>
    
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">1. Explorer les Possibilités</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Le simulateur de spécialités (avec Horizons21)</h4><p><strong>Objectif :</strong> Aider l'élève à faire des choix de spécialités éclairés.</p><p><strong>Fonctionnement :</strong> L'élève teste des combinaisons de spécialités et analyse les "horizons" qu'elles lui ouvrent.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est l'outil essentiel à mobiliser lors des séances d'accompagnement au choix en Seconde et en Première.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg> Les Fondations (avec Onisep)</h4><p><strong>Objectif :</strong> Ancrer la recherche de l'élève dans des sources fiables et l'aider à se projeter.</p><p><strong>Fonctionnement :</strong> L'élève peut explorer des métiers et utiliser OrIA pour <strong>simuler une "journée type"</strong> ou générer un <strong>tableau comparatif</strong> entre plusieurs pistes.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Ces outils interactifs favorisent une exploration plus active et approfondie que la simple lecture de fiches.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg> Le Catalogue (avec Parcoursup)</h4><p><strong>Objectif :</strong> Apprendre à l'élève à décrypter une fiche formation et à s'auto-évaluer.</p><p><strong>Fonctionnement :</strong> La fonction de <strong>rapport de compatibilité personnalisé</strong> croise l'ensemble des données du journal de l'élève avec les "attendus" d'une formation.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Encouragez les élèves à utiliser cet outil pour objectiver leurs choix et préparer leurs arguments pour le projet de formation motivé.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg> L'Actu</h4><p><strong>Objectif :</strong> Développer l'esprit critique de l'élève face à l'information sur l'orientation.</p><p><strong>Fonctionnement :</strong> L'élève peut soumettre une information ou un classement trouvé en ligne, et OrIA l'analyse en la mettant en perspective avec son propre profil.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Peut servir de support pour des séances d'EMI (Éducation aux Médias et à l'Information) appliquées à l'orientation.</div></div>
    
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">2. Se Connecter au Monde Réel</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> L'Expérience (avec Inspire)</h4><p><strong>Objectif :</strong> Préparer l'élève à des interactions réelles et développer son aisance orale.</p><p><strong>Fonctionnement :</strong> L'outil propose un <strong>simulateur d'entretien</strong> où l'élève peut s'entraîner à dialoguer avec un étudiant virtuel.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Très utile pour les élèves les plus timides afin de préparer des JPO ou des entretiens de stage.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> Passer à l'action</h4><p><strong>Objectif :</strong> Aider l'élève à structurer sa démarche de prise de contact.</p><p><strong>Fonctionnement :</strong> Le <strong>gestionnaire de contacts</strong> permet de suivre l'avancement des démarches (contacté, réponse reçue...). OrIA peut aider à la rédaction de mails.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Peut servir de support à un projet où les élèves doivent interviewer des professionnels.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg> Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> Connecter le projet de l'élève aux ressources et événements locaux.</p><p><strong>Fonctionnement :</strong> OrIA recherche les JPO, salons et structures d'aide locales. Les événements peuvent être ajoutés en un clic au <strong>Rétroplanning</strong> de l'élève.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Utile pour communiquer les dates importantes de l'orientation sur le territoire de l'établissement.</div></div>

    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">3. Construire son Projet</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Portfolio de Compétences</h4><p><strong>Objectif :</strong> Aider l'élève à identifier et valoriser ses compétences, y compris celles acquises dans des contextes non-formels.</p><p><strong>Fonctionnement :</strong> Cette étape propose deux ateliers : un <strong>analyseur d'expériences</strong> pour transformer un récit en paragraphe de candidature (méthode STAR), et un <strong>détecteur de compétences</strong> transversales via un quiz.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Outil très pertinent pour la préparation au Grand Oral et pour l'enseignement de la compétence "Savoir parler de soi".</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> Préparer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> Aider l'élève à améliorer la qualité rédactionnelle de son projet de formation motivé.</p><p><strong>Fonctionnement :</strong> L'<strong>Atelier d'écriture</strong> permet à l'élève de soumettre un brouillon de paragraphe et de recevoir des conseils d'amélioration ciblés.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Cet outil ne fait pas le travail à la place de l'élève mais lui apprend à affiner son argumentation, une compétence clé.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Fact Checking</h4><p><strong>Objectif :</strong> Déconstruire les stéréotypes sur les filières et les métiers de manière ludique.</p><p><strong>Fonctionnement :</strong> L'élève peut lancer un quiz générique ou un "Défi Personnalisé" qui le questionne par rapport à son propre profil.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Idéal pour une séance collective dynamique, en équipes, pour lancer des débats et ouvrir les horizons.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Simulateur Vie Étudiante</h4><p><strong>Objectif :</strong> Ancrer le projet d'études dans la réalité matérielle et financière.</p><p><strong>Fonctionnement :</strong> L'élève peut estimer le coût de la vie dans une ville et découvrir les aides financières.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Parfait pour une séance sur l'autonomie et la préparation à la vie étudiante.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> Développer la résilience et la capacité de l'élève à envisager des plans alternatifs.</p><p><strong>Fonctionnement :</strong> La <strong>simulation de conversation "Plan B"</strong> est un dialogue coaché avec OrIA pour aider l'élève à gérer la déception d'un refus et à rebondir.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Un outil intéressant pour travailler les compétences psycho-sociales liées à l'orientation.</div></div>
`;


    const partie5TechHTML_base = `
        <h2>Partie 3 : Technologie et Données Personnelles</h2>
        <div class="etape">
            <h4>Le Modèle d'IA Utilisé</h4>
<p>L'intelligence artificielle intégrée à cette application est propulsée par <strong>GPT-4o</strong>, un modèle de langage avancé développé par <strong>OpenAI</strong>.</p>        </div>
        <div class="etape">
            <h4>Vos Données Personnelles</h4>
            <div class="conseil-prof" style="font-style: normal;">
                La protection de vos données est une priorité absolue. Voici en toute transparence comment elles sont gérées :
                <ul>
                    <li><strong>Quelles données sont collectées ?</strong> L'application collecte uniquement les informations que vous fournissez : votre nom, prénom, email, nom de votre lycée, ainsi que toutes les notes que vous inscrivez dans votre journal de bord.</li>
                    <li><strong>Qui les collecte et où sont-elles hébergées ?</strong> Vos données sont collectées par les concepteurs de l'application, et sont stockées de manière sécurisée sur <strong>Firebase</strong>, une plateforme de Google. L'hébergement se fait sur des serveurs sécurisés en Europe.</li>
                    <li><strong>Comment sont-elles utilisées ?</strong> Vos données ne sont utilisées <strong>que pour le fonctionnement de l'application</strong>. Votre journal de bord est envoyé à OrIA GPT 4o pour générer les réponses contextuelles, mais il n'est pas utilisé pour entraîner le modèle global d'OpenAI. Vos données ne sont jamais partagées avec des tiers ni utilisées à des fins commerciales.</li>
                    <li><strong>Qui peut y accéder ?</strong> Vous seul(e) pouvez accéder à vos données via votre compte. Si vous utilisez la fonction de partage, la personne détentrice du lien pourra voir une version "lecture seule" de votre journal.</li>
                </ul>
            </div>
        </div>
    `;

    // --- 2. Assemblage dynamique du guide final ---
     let finalGuideHTML = '';

    switch (guideUserRole) {
        case 'parent':
            finalGuideHTML = introHTML +
                             partie2ParentsHTML +
                             partie4FonctionnalitesHTML_parents +
                             installationHTML +
                             partie5TechHTML_base;
            break;
        case 'enseignant':
            finalGuideHTML = introHTML +
                             partie3EnseignantsHTML +
                             partie4FonctionnalitesHTML_enseignants +
                             seancesEnseignantsHTML +
                             installationHTML +
                             partie5TechHTML_base;
            break;
        case 'eleve':
        default:
            finalGuideHTML = introHTML +
                             partie1ElevesHTML +
                             partie4FonctionnalitesHTML_base +
                             installationHTML +
                             partie5TechHTML_base;
            break;
    }


    // 3. Injection dans le DOM et gestion du bouton retour
    div.innerHTML = `
        <div class="guide-container">
            ${styleHTML}
            ${finalGuideHTML}
        </div>
    `;


    return div;
}


function createStep4View() {
    const config = stepsConfig.step4;
    const div = document.createElement('div');
    div.className = 'fade-in';

    // Initialisation de la structure de données
    if (!journalData.step4.themes || !Array.isArray(journalData.step4.themes)) {
        journalData.step4.themes = [];
    }

    // Variables locales pour la simulation et l'atelier
    let currentSimTheme = '';
    let conversationHistory = [];
    let currentExploration = { theme: '', question: '', suggestions: '' };

    // --- STRUCTURE HTML COMPLÈTE (AVEC LA MODALE RÉINTÉGRÉE) ---
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${config.action}</div></div>
        <div class="mb-8"><a href="${config.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter ${config.site} ↗</a></div>

        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Atelier de Préparation d'Échange</h2>
            <div class="mb-4"><label for="current-theme" class="block text-md font-medium">Thème ou formation</label><input type="text" id="current-theme" class="w-full mt-1 p-3 border rounded-lg" placeholder="Ex: Écoles d'ingénieurs"></div>
            <div class="mb-4"><label for="current-question" class="block text-md font-medium">Ma question principale</label><textarea id="current-question" rows="2" class="w-full mt-1 p-3 border rounded-lg" placeholder="Quelle est la plus grande différence avec le lycée ?"></textarea></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <button type="button" id="generate-questions-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">✨ Obtenir des questions</button>
                <button type="button" id="launch-sim-btn" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600">🚀 Lancer la simulation</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] prose prose-sm max-w-none"></div>
            <button type="button" id="save-theme-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700">💾 Enregistrer cette préparation</button>
        </div>
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes Préparations Enregistrées</h2>
        <div id="saved-themes-container" class="space-y-3 mb-8"></div>

        <div id="simulation-modal" class="simulation-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col h-[80vh]">
                <div class="flex items-center justify-between p-4 border-b bg-background-light rounded-t-2xl">
                    <h3 class="font-bold text-OrIAntation-darkblue">🤖 Simulation d'entretien</h3>
                    <button id="simulation-close" class="text-slate-500 hover:text-OrIAntation-darkblue text-2xl">&times;</button>
                </div>
                <div id="simulation-messages" class="flex-1 p-4 overflow-y-auto simulation-message-container"></div>
                <form id="simulation-form" class="p-4 border-t flex items-center gap-2">
                    <input type="text" id="simulation-input" placeholder="Écris ta réponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
                </form>
            </div>
        </div>
    `;
    
    // --- SÉLECTION DES ÉLÉMENTS ---
    const generateBtn = div.querySelector('#generate-questions-btn');
    const launchSimBtn = div.querySelector('#launch-sim-btn');
    const saveBtn = div.querySelector('#save-theme-btn');
    const savedContainer = div.querySelector('#saved-themes-container');
    const simulationModal = div.querySelector('#simulation-modal');
    const simulationForm = div.querySelector('#simulation-form');
    const simulationInput = div.querySelector('#simulation-input');
    const simulationMessages = div.querySelector('#simulation-messages');
    const simulationCloseBtn = div.querySelector('#simulation-close');
    
    // --- FONCTIONS HELPERS COMPLÈTES ---
    const renderSavedThemes = () => {
        if (!savedContainer) return;
        const themes = journalData.step4.themes || [];
        if (themes.length === 0) {
            savedContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de préparation enregistrée.</p>`;
        } else {
            savedContainer.innerHTML = themes.map((item, index) => `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${item.theme}</span>
                        <button type="button" data-index="${index}" class="delete-theme-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer">🗑️</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle prose prose-sm max-w-none">
                        <p><strong>Ma question :</strong> ${item.question}</p>
                        <p><strong>Suggestions de l'IA :</strong></p>
                        ${marked.parse(item.suggestions || '')}
                    </div>
                </details>
            `).join('');
        }
    };
    
    const resetWorkspace = () => {
        currentExploration = { theme: '', question: '', suggestions: '' };
        div.querySelector('#current-theme').value = '';
        div.querySelector('#current-question').value = '';
        div.querySelector('#result').innerHTML = '';
    };

    const addSimMessage = (text, sender) => {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = 'flex mb-4';
        let messageContent = '';
        if (sender === 'user') { messageWrapper.classList.add('justify-end'); messageContent = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs"><p>${text}</p></div>`; } 
        else if (sender === 'ai') { messageContent = `<div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs"><p>${text}</p></div>`; } 
        else { messageContent = `<div class="bg-cyan-100 p-3 rounded-lg"><div class="chatbot-loader"></div></div>`; }
        messageWrapper.innerHTML = messageContent;
        simulationMessages.appendChild(messageWrapper);
        simulationMessages.scrollTop = simulationMessages.scrollHeight;
        return messageWrapper;
    };

    // --- LOGIQUE DES ÉVÉNEMENTS COMPLÈTE ---
    
    generateBtn.addEventListener('click', async () => {
        const theme = div.querySelector('#current-theme').value.trim();
        const questionBase = div.querySelector('#current-question').value.trim();
        if (!theme || !questionBase || !journalData.step0.analysis) {
            showInfoModal("Veuillez renseigner le thème, votre question et avoir complété l'étape 'Mieux se connaître'."); return;
        }
        const loader = div.querySelector('#loader');
        const resultDiv = div.querySelector('#result');
        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        const prompt = `Agis comme un coach d'orientation. Le profil d'un lycéen est : "${journalData.step0.analysis}". Il s'intéresse à : "${theme}" et sa question est : "${questionBase}". Suggère 10 questions personnalisées à poser à un étudiant. Donne uniquement les 10 questions, chacune sur une nouvelle ligne.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.innerHTML = marked.parse(result);
        currentExploration.suggestions = result;
    });
    
    launchSimBtn.addEventListener('click', async () => {
        const theme = div.querySelector('#current-theme').value.trim();
        if (!theme) { showInfoModal("Veuillez d'abord renseigner un thème."); return; }
        
        currentSimTheme = theme;
        conversationHistory = [];
        simulationMessages.innerHTML = '';
        simulationModal.classList.remove('hidden');
        simulationModal.classList.add('flex');
        
        const loaderMsg = addSimMessage('', 'loader');
        const startPrompt = `Tu es un étudiant "éclaireur" sympathique qui étudie en : "${currentSimTheme}". Un lycéen démarre la conversation. Envoie-lui un message de bienvenue pour l'inviter à poser sa première question.`;
        const firstMessage = await callOpenAI_API({ promptText: startPrompt });
        
        loaderMsg.remove();
        addSimMessage(firstMessage, 'ai');
        conversationHistory.push({ role: 'model', parts: [{ text: firstMessage }] });
    });

    saveBtn.addEventListener('click', async () => {
        currentExploration.theme = div.querySelector('#current-theme').value.trim();
        currentExploration.question = div.querySelector('#current-question').value.trim();
        if (!currentExploration.theme) { showInfoModal("Veuillez renseigner un thème."); return; }
        journalData.step4.themes.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(20);
        renderSavedThemes();
        resetWorkspace();
        showSurpriseModal("Préparation sauvegardée !", "Elle est maintenant dans ton journal.", 3000);
    });
    
    savedContainer.addEventListener('click', async (e) => {
        if (e.target.closest('.delete-theme-btn')) {
            const index = e.target.closest('.delete-theme-btn').dataset.index;
            if (await showConfirmationModal("Sûr de vouloir supprimer cette préparation ?")) {
                journalData.step4.themes.splice(index, 1);
                await saveData();
                renderSavedThemes();
            }
        }
    });

    simulationCloseBtn.addEventListener('click', () => {
        simulationModal.classList.add('hidden');
        simulationModal.classList.remove('flex');
    });

    simulationForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInput = simulationInput.value.trim();
        if (!userInput) return;

        addSimMessage(userInput, 'user');
        simulationInput.value = '';
        conversationHistory.push({ role: 'user', parts: [{ text: userInput }] });

        const loaderMsg = addSimMessage('', 'loader');
        const conversationPrompt = `Tu es un étudiant éclaireur qui étudie en "${currentSimTheme}". Continue la conversation en te basant sur l'historique : ${JSON.stringify(conversationHistory)}. Réponds à la dernière question.`;
        const aiResponse = await callOpenAI_API({ promptText: conversationPrompt });
        
        loaderMsg.remove();
        addSimMessage(aiResponse, 'ai');
        conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
    });

    renderSavedThemes();
    return div;
}

// ▼▼▼ REMPLACEZ TOUTE VOTRE FONCTION createStep5View PAR CE BLOC ▼▼▼

function createStep5View() {
    const config = stepsConfig.step5;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    if (!journalData.step5.articles || !Array.isArray(journalData.step5.articles)) {
        journalData.step5.articles = [];
    }

    let currentExploration = { title: '', notes: '', analysis: '' };

    const renderSavedArticles = () => {
        const container = div.querySelector('#saved-articles-container');
        if (!container) return;
        const articles = journalData.step5.articles || [];
        if (articles.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore d'article enregistré.</p>`;
        } else {
            container.innerHTML = articles.map((article, index) => `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${article.title}</span>
                        <button type="button" data-index="${index}" class="delete-article-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer">🗑️</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle">
                        <div class="mb-2"><p class="font-semibold">Ce que j'ai appris :</p><p class="whitespace-pre-wrap text-sm">${article.notes || 'Non renseigné.'}</p></div>
                        ${article.analysis ? `<div class="mb-2"><p class="font-semibold">Analyse de OrIA :</p><p class="whitespace-pre-wrap text-sm">${article.analysis}</p></div>` : ''}
                    </div>
                </details>
            `).join('');
        }
    };

    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Atelier d'exploration d'Actualité</h2>
            <div class="mb-4">
                <label for="current-article-title" class="block text-md font-medium text-slate-700 mb-2">Info, article ou classement trouvé</label>
                <input type="text" id="current-article-title" class="w-full p-3 border rounded-lg" placeholder="Ex: Le classement des écoles de commerce 2025">
            </div>
             <div class="mb-4">
                <label for="current-article-notes" class="block text-md font-medium text-slate-700 mb-2">Ce que j'ai appris de cette info</label>
                <textarea id="current-article-notes" rows="4" class="w-full p-3 border rounded-lg" placeholder="Certaines écoles sont spécialisées dans le luxe..."></textarea>
            </div>
            <div class="text-center mb-4">
                <button type="button" id="analyse-btn" class="ai-btn w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">✨ Analyser mon actualité</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            <button type="button" id="save-article-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">💾 Enregistrer cette trouvaille</button>
        </div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">📰 Mes Actualités Enregistrées</h2>
        <div id="saved-articles-container" class="space-y-3 mb-8"></div>
    `;
    
    const resetWorkspace = () => {
        currentExploration = { title: '', notes: '', analysis: '' };
        div.querySelector('#current-article-title').value = '';
        div.querySelector('#current-article-notes').value = '';
        div.querySelector('#result').innerHTML = '';
    };

    div.querySelector('#save-article-btn').addEventListener('click', async () => {
        currentExploration.title = div.querySelector('#current-article-title').value.trim();
        currentExploration.notes = div.querySelector('#current-article-notes').value.trim();
        if (!currentExploration.title) {
            showInfoModal("Veuillez renseigner le titre de l'info trouvée.");
            return;
        }
        journalData.step5.articles.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(20);
        renderSavedArticles();
        resetWorkspace();
        showSurpriseModal("Actualité sauvegardée !", "Cette information est maintenant dans ton journal.", 3000);
    });

    div.querySelector('#analyse-btn').addEventListener('click', async () => {
        const articleTitle = div.querySelector('#current-article-title').value.trim();
        const articleNotes = div.querySelector('#current-article-notes').value.trim();
        const loader = div.querySelector('#loader');
        const resultDiv = div.querySelector('#result');
        
        if (!journalData.step0.analysis) { showInfoModal("Veuillez d'abord compléter l'étape 'Mieux se connaître'."); return; }
        if (!articleTitle || !articleNotes) { showInfoModal("Veuillez renseigner l'info trouvée et ce que vous en avez appris."); return; }

        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        
        const prompt = `Agis comme un conseiller d'orientation expert. Le profil d'un lycéen est : "${journalData.step0.analysis}".\nIl a fait une veille d'information sur : "${articleTitle}" et en a retenu : "${articleNotes}".\n\nTa mission est de mettre en relation cette actualité avec son profil personnel et de suggérer, en te basant sur une recherche web, 1 autre piste de recherche (article, classement...) précise et pertinente qui pourrait l'intéresser. Explique brièvement pourquoi.`;
        
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.innerHTML = linkify(result);
        currentExploration.analysis = result;
    });

    div.querySelector('#saved-articles-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-article-btn')) {
            const index = e.target.closest('.delete-article-btn').dataset.index;
            if (await showConfirmationModal("Sûr de vouloir supprimer cette actualité ?")) {
                journalData.step5.articles.splice(index, 1);
                await saveData();
                renderSavedArticles();
            }
        }
    });

    renderSavedArticles();
    return div;
}
        
        // REMPLACEZ VOTRE FONCTION createStep6View EXISTANTE PAR CELLE-CI :
// ==================== REMPLACEZ TOUTE LA FONCTION createStep6View ====================
function createStep6View() {
    const config = stepsConfig.step6;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // 1. Initialisation de la structure de données en tableau
    if (!journalData.step6.projets || !Array.isArray(journalData.step6.projets)) {
        journalData.step6.projets = [];
    }
    
    // Objet temporaire pour l'atelier en cours
    let currentExploration = { formation: '', motivations: '', structure: '', optimisation: '' };

    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${config.action}</div></div>

        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">✍️ Atelier de rédaction</h2>
            <div class="mb-4">
                <label for="current-formation" class="block text-md font-medium text-slate-700 mb-2">Formation visée</label>
                <input type="text" id="current-formation" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: BUT Informatique - IUT de Villetaneuse">
            </div>
             <div class="mb-4">
                <label for="current-motivations" class="block text-md font-medium text-slate-700 mb-2">Mes motivations, compétences, expériences (en vrac)</label>
                <textarea id="current-motivations" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: J'aime résoudre des problèmes logiques..."></textarea>
            </div>
            <div class="text-center mb-4">
                <button type="button" id="generate-structure-btn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">✨ Générer une structure de lettre</button>
            </div>
            <div id="loader-structure" class="hidden"><div class="loader"></div></div>
             <div class="mb-4">
                <label for="current-structure" class="block text-md font-medium text-slate-700 mb-2">Proposition de structure</label>
                <textarea id="current-structure" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light" readonly></textarea>
            </div>

            <div class="mt-8 border-t pt-6">
                <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">💡 Optimiseur de Paragraphe</h3>
                <div class="mb-4">
                     <label for="current-brouillon" class="block text-md font-medium text-slate-700 mb-2">Mon brouillon</label>
                    <textarea id="current-brouillon" rows="6" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Écris ici le paragraphe que tu souhaites améliorer..."></textarea>
                </div>
                <div class="text-center">
                    <button type="button" id="optimize-paragraph-btn" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Améliorer mon paragraphe</button>
                </div>
                <div id="loader-optimize" class="hidden"><div class="loader"></div></div>
                <div id="optimization-result" class="mt-4 p-4 bg-teal-50 border border-teal-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
            </div>
            <button type="button" id="save-projet-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">💾 Enregistrer ce projet de candidature</button>
        </div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes Projets Enregistrés</h2>
        <div id="saved-projets-container" class="space-y-3"></div>
    `;

    // 4. Les fonctions JavaScript pour gérer la dynamique
    const renderSavedProjets = () => {
        const container = div.querySelector('#saved-projets-container');
        const projets = journalData.step6.projets || [];
        if (projets.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de projet de candidature enregistré.</p>`;
            return;
        }
        container.innerHTML = projets.map((projet, index) => {
            let contentHTML = `
                <div class="mb-2"><p class="font-semibold">Motivations :</p><p class="whitespace-pre-wrap text-sm">${projet.motivations || ''}</p></div>
                <div class="mb-2"><p class="font-semibold">Structure proposée :</p><p class="whitespace-pre-wrap text-sm">${projet.structure || ''}</p></div>
                ${projet.optimisation ? `<div class="mb-2"><p class="font-semibold">Conseils d'optimisation :</p><p class="whitespace-pre-wrap text-sm">${projet.optimisation}</p></div>` : ''}
            `;
            return `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${projet.formation}</span>
                        <button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step6" data-entry-index="${index}">🗑️</button>
                    </summary>
                    <div class="p-3 border-t">${contentHTML}</div>
                </details>`;
        }).join('');
    };

    const resetWorkspace = () => {
        currentExploration = { formation: '', motivations: '', structure: '', optimisation: '' };
        div.querySelector('#current-formation').value = '';
        div.querySelector('#current-motivations').value = '';
        div.querySelector('#current-structure').value = '';
        div.querySelector('#current-brouillon').value = '';
        div.querySelector('#optimization-result').innerHTML = '';
    };

    // 5. Les écouteurs d'événements pour les boutons de l'atelier
    div.querySelector('#generate-structure-btn').addEventListener('click', async () => {
        const formation = div.querySelector('#current-formation').value;
        const motivations = div.querySelector('#current-motivations').value;
        const loader = div.querySelector('#loader-structure');
        const resultDiv = div.querySelector('#current-structure');
        if (!formation.trim() || !motivations.trim()) { resultDiv.value = "Veuillez renseigner la formation et vos motivations."; return; }
        loader.style.display = 'block'; resultDiv.value = '';
        const prompt = `Agis comme un coach expert de Parcoursup. Formation visée: "${formation}". Motivations brutes: "${motivations}". Dossier de l'élève: "${getProfileSummary()}". Propose un plan détaillé en 3 paragraphes pour son projet de formation motivé. Pour chaque paragraphe, donne une phrase d'accroche et 2-3 points clés à développer.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.value = result;
        currentExploration.structure = result;
    });

    div.querySelector('#optimize-paragraph-btn').addEventListener('click', async () => {
        const brouillon = div.querySelector('#current-brouillon').value;
        const loader = div.querySelector('#loader-optimize');
        const resultDiv = div.querySelector('#optimization-result');
        if (!brouillon.trim()) { resultDiv.innerHTML = "<p>Veuillez écrire un brouillon.</p>"; return; }
        loader.style.display = 'block'; resultDiv.innerHTML = '';
        const prompt = `Agis comme un coach en écriture pour un lycéen. Son brouillon de paragraphe est : "${brouillon}". Donne 3 à 4 conseils ciblés pour qu'il l'améliore lui-même, sans le réécrire à sa place. Le ton doit être bienveillant. Fournis une liste à puces.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.innerHTML = marked.parse(result);
        currentExploration.optimisation = result;
    });

    div.querySelector('#save-projet-btn').addEventListener('click', async () => {
        currentExploration.formation = div.querySelector('#current-formation').value.trim();
        currentExploration.motivations = div.querySelector('#current-motivations').value.trim();
        if (!currentExploration.formation) { showInfoModal("Veuillez renseigner un nom de formation."); return; }
        journalData.step6.projets.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(40);
        renderSavedProjets();
        resetWorkspace();
        showSurpriseModal("Projet sauvegardé !", "Cette préparation est maintenant dans ton journal.", 3000);
    });

    // 6. Affichage initial et retour au menu
    renderSavedProjets();
    

    return div;
}

function createStep7View() {
    const config = stepsConfig.step7;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    let quizData = [];
    let currentQuestionIndex = 0;
    let score = 0;

    if (!journalData.step7.scores) {
        journalData.step7.scores = {};
    }

    // --- AFFICHE L'ÉCRAN DE CHOIX DES 3 ATELIERS ---
    const renderChoiceView = () => {
        let choiceHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="start-generic-quiz" class="p-6 bg-white rounded-lg border border-border-subtle cursor-pointer hover:shadow-lg transition text-center flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-OrIAntation-darkblue">Atelier 1 : Vrai ou Faux ?</h3>
                    <p class="text-sm text-slate-600 mt-2">Teste tes connaissances sur un domaine et déconstruis les mythes.</p>
                </div>
                <div id="start-personalized-quiz" class="p-6 bg-white rounded-lg border border-border-subtle cursor-pointer hover:shadow-lg transition text-center flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-OrIAntation-darkblue">Atelier 2 : Le Défi Personnalisé</h3>
                    <p class="text-sm text-slate-600 mt-2">Confronte ton profil aux idées reçues sur un métier ou une filière.</p>
                </div>
                <div id="start-intruder-quiz" class="p-6 bg-white rounded-lg border border-border-subtle cursor-pointer hover:shadow-lg transition text-center flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-OrIAntation-darkblue">Atelier 3 : Trouvez l'Intrus</h3>
                    <p class="text-sm text-slate-600 mt-2">Parmi 4 affirmations, démasque la seule qui est fausse (quiz de 5 questions).</p>
                </div>
            </div>
        `;
        let historyHTML = '';
        const scores = journalData.step7.scores;
        if (scores && Object.keys(scores).length > 0 && Object.values(scores).some(h => h.length > 0)) {
            historyHTML += `<div class="mt-8 border-t pt-6"><h2 class="text-xl font-bold text-OrIAntation-darkblue text-center mb-4">Mon Historique de Scores</h2><div class="space-y-4">`;
            for (const [domain, scoreHistory] of Object.entries(scores)) {
                if (scoreHistory && scoreHistory.length > 0) {
                    historyHTML += `<div class="bg-background-light p-4 rounded-lg border border-border-subtle"><h3 class="font-semibold text-cyan-700">${domain}</h3><ul class="text-sm text-slate-600 mt-2 space-y-3">`;
                    scoreHistory.forEach(entry => {
                        historyHTML += `<li><div class="flex justify-between items-center"><span>Le ${entry.date}</span><strong class="text-base">${entry.score}/${entry.total}</strong></div>`;
                        if (entry.notes && entry.notes.trim() !== '') { historyHTML += `<p class="text-xs text-slate-500 italic border-l-2 border-border-subtle pl-2 mt-1">${entry.notes}</p>`; }
                        historyHTML += `</li>`;
                    });
                    historyHTML += `</ul></div>`;
                }
            }
            historyHTML += `</div></div>`;
        }
        form.innerHTML = choiceHTML + historyHTML;
        div.querySelector('#start-generic-quiz').addEventListener('click', () => startQuiz('generic'));
        div.querySelector('#start-personalized-quiz').addEventListener('click', () => startQuiz('personalized'));
        div.querySelector('#start-intruder-quiz').addEventListener('click', () => startIntruderQuiz());
    };

    // --- LANCE UN QUIZ DE TYPE VRAI/FAUX ---
    const startQuiz = (type) => {
        if (type === 'personalized' && (!journalData.step0 || !journalData.step0.analysis)) {
            showInfoModal("Action requise", "Pour lancer le Défi Personnalisé, veuillez d'abord compléter l'étape 'Mieux se connaître'.");
            return;
        }
        form.innerHTML = `<div class="mb-6"><label for="domaine" class="block text-md font-medium text-slate-700 mb-2">Sur quel domaine ou métier souhaites-tu lancer le quiz ?</label><input type="text" id="domaine" name="domaine" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Les études de droit..." value="${journalData.step7.domaine || ''}"></div><div class="text-center"><button type="button" id="generateQuizBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Lancer le Quiz Vrai/Faux</button></div><div id="quizContainer" class="mt-6"></div><div id="quizLoader" class="hidden"><div class="loader"></div></div>`;
        form.querySelector('#generateQuizBtn').addEventListener('click', () => generateQuiz(type));
    };
    
    // --- GÉNÈRE LE QUIZ VRAI/FAUX VIA L'IA ---
    const generateQuiz = async (type) => {
        const domain = form.querySelector('#domaine').value.trim();
        if (!domain) { showInfoModal("Action requise", "Veuillez entrer un domaine."); return; }
        journalData.step7.domaine = domain;
        if (!journalData.step7.scores[domain]) journalData.step7.scores[domain] = [];
        const loader = form.querySelector('#quizLoader');
        const quizContainer = form.querySelector('#quizContainer');
        loader.style.display = 'block';
        quizContainer.innerHTML = '';
        let prompt = '';
        if (type === 'personalized') {
            prompt = `Agis comme un coach perspicace qui crée un "Défi Personnalisé" pour un élève. Ton but n'est pas de tester ses connaissances sur un domaine, mais de le faire réfléchir sur son propre profil en le confrontant à des idées reçues. Voici son profil : "${journalData.step0.analysis}". Et le domaine qui l'intéresse : "${domain}". Ta mission est de générer 5 affirmations qui créent une tension productive entre son profil et les stéréotypes du domaine. Chaque affirmation doit être une question directe pour l'élève. Exemple : Si l'élève est "introverti" et le domaine est "commerce", une affirmation pourrait être : "En tant que personne qui se ressource seule, le contact permanent avec les clients dans le commerce serait épuisant pour toi.". <Format de Sortie (JSON Strict)>Retourne UNIQUEMENT un tableau JSON valide avec 5 objets, chacun avec les clés : "affirmation", "reponse" (true/false), "explication", "le_savais_tu", "etape_suggeree".</Format>`;
        } else {
            prompt = `Génère un quiz de 5 affirmations "vrai ou faux" sur les mythes du domaine : "${domain}". <Format de Sortie (JSON Strict)>Retourne UNIQUEMENT un tableau JSON valide avec exactement 5 objets. Chaque objet DOIT contenir les clés : "affirmation", "reponse" (true/false), "explication", "le_savais_tu", "etape_suggeree".</Format>`;
        }
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true // Très important ici, car on attend un quiz au format JSON
});
        try {
            const parsedResult = extractJsonFromString(result);
            if (!parsedResult || !Array.isArray(parsedResult) || parsedResult.length !== 5) { throw new Error("La structure du quiz est invalide."); }
            quizData = parsedResult;
            currentQuestionIndex = 0;
            score = 0;
            renderQuestion(currentQuestionIndex, type);
        } catch (error) {
            console.error("Erreur du quiz Vrai/Faux:", error);
            quizContainer.innerHTML = `<p class="text-red-500 text-center">Désolé, une erreur est survenue. Veuillez réessayer.</p>`;
        } finally {
            loader.style.display = 'none';
        }
    };
    
    // --- AFFICHE UNE QUESTION VRAI/FAUX ---
    const renderQuestion = (index, type) => {
        const quizContainer = form.querySelector('#quizContainer');
        const question = quizData[index];
        const domain = journalData.step7.domaine;
        const scoreHistory = journalData.step7.scores[domain] || [];
        let bestScoreHTML = '';
        if (scoreHistory.length > 0) {
            const bestScore = Math.max(...scoreHistory.map(s => s.score));
            bestScoreHTML = `<p class="text-sm text-center text-slate-500 mb-4">Ton record pour ce thème : <span class="font-bold">${bestScore}/${quizData.length}</span></p>`;
        }
        quizContainer.innerHTML = `
            <div class="bg-background-light p-6 rounded-lg border border-border-subtle">
                ${bestScoreHTML}
                <p class="text-center font-semibold text-OrIAntation-darkblue text-lg mb-4">Question ${index + 1} / ${quizData.length}</p>
                <p class="text-center text-slate-600 mb-6">"${question.affirmation}"</p>
                <div class="flex justify-center gap-4">
                    <button type="button" data-answer="true" class="answer-btn bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Oui</button>
                    <button type="button" data-answer="false" class="answer-btn bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">Non</button>
                </div>
                <div id="explanationContainer" class="mt-6"></div>
            </div>`;
        quizContainer.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', (e) => checkAnswer(e.target.dataset.answer === 'true', index, type));
        });
    };

    // --- VÉRIFIE LA RÉPONSE VRAI/FAUX ET AFFICHE LES INFOS ENRICHIES ---
    const checkAnswer = (userAnswer, index, type) => {
        const question = quizData[index];
        const isCorrect = userAnswer === question.reponse;
        if (isCorrect) score++;
        const explanationContainer = form.querySelector('#explanationContainer');
        const feedbackColor = isCorrect ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
        let feedbackText = '';
        if (type === 'personalized') {
            feedbackText = isCorrect ? "Exactement !" : "Tu te sous-estimes !";
        } else {
            feedbackText = isCorrect ? 'Bonne réponse !' : 'C\'est un mythe !';
        }
        let funFactHTML = '';
        if (question.le_savais_tu) { funFactHTML = `<div class="mt-4 p-3 bg-sky-50 border-t border-b border-sky-200"><p class="font-bold text-sky-700 text-sm">💡 Le Savais-tu ?</p><p class="text-slate-600 text-sm mt-1">${question.le_savais_tu}</p></div>`; }
        let gatewayHTML = '';
        if (question.etape_suggeree) {
            const targetStep = allSteps.find(step => step.title.includes(question.etape_suggeree));
            if (targetStep) { gatewayHTML = `<div class="mt-4 text-center"><button type="button" onclick="window.showView('${targetStep.id}')" class="text-sm bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Explorer l'étape "${targetStep.title}" 🚀</button></div>`; }
        }
        explanationContainer.innerHTML = `<div class="p-4 rounded-lg border-l-4 ${feedbackColor}"><h4 class="font-bold text-OrIAntation-darkblue">${feedbackText}</h4><p class="text-slate-700 mt-2">${question.explication}</p></div>${funFactHTML}${gatewayHTML}<div class="text-center mt-4"><button type="button" id="nextQuestionBtn" class="bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-cyan-700 transition">${(index + 1 === quizData.length) ? 'Voir mon score' : 'Question suivante'}</button></div>`;
        explanationContainer.querySelector('#nextQuestionBtn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) { renderQuestion(currentQuestionIndex, type); } else { renderFinalScore(); }
        });
        form.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
    };

    // --- FONCTIONS POUR LE NOUVEAU MODE "TROUVEZ L'INTRUS" ---
    const startIntruderQuiz = () => {
        form.innerHTML = `<div class="mb-6"><label for="domaine" class="block text-md font-medium text-slate-700 mb-2">Sur quel domaine ou métier souhaites-tu lancer le quiz ?</label><input type="text" id="domaine" name="domaine" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Les métiers de l'ingénierie..." value="${journalData.step7.domaine || ''}"></div><div class="text-center"><button type="button" id="generateIntruderBtn" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 transition">Lancer le Quiz "Trouvez l'Intrus"</button></div><div id="quizContainer" class="mt-6"></div><div id="quizLoader" class="hidden"><div class="loader"></div></div>`;
        form.querySelector('#generateIntruderBtn').addEventListener('click', generateIntruderQuiz);
    };
    const generateIntruderQuiz = async () => {
        const domain = form.querySelector('#domaine').value.trim();
        if (!domain) { showInfoModal("Action requise", "Veuillez entrer un domaine."); return; }
        journalData.step7.domaine = `${domain} (Intrus)`;
        if (!journalData.step7.scores[journalData.step7.domaine]) journalData.step7.scores[journalData.step7.domaine] = [];
        const loader = form.querySelector('#quizLoader');
        const quizContainer = form.querySelector('#quizContainer');
        loader.style.display = 'block';
        quizContainer.innerHTML = '';
        const prompt = `Agis comme un concepteur de quiz. Pour le domaine : "${domain}", crée une série de 5 questions "Trouvez l'Intrus". <Format de Sortie (JSON Strict)>Ta réponse DOIT être un unique tableau JSON de 5 objets. Chaque objet doit contenir les clés "affirmations" (un tableau de 4 objets {texte: "...", estVrai: true/false}) et "explication" (un string).</Format>`;
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true // Très important ici, car on attend un quiz au format JSON
});     
   try {
            const parsedResult = extractJsonFromString(result);
            if (!parsedResult || !Array.isArray(parsedResult) || parsedResult.length !== 5) { throw new Error("La structure du quiz est invalide."); }
            quizData = parsedResult;
            currentQuestionIndex = 0;
            score = 0;
            renderIntruderQuestion(currentQuestionIndex);
        } catch (error) {
            console.error("Erreur du quiz Intrus:", error);
            quizContainer.innerHTML = `<p class="text-red-500 text-center">Désolé, une erreur est survenue. Veuillez réessayer.</p>`;
        } finally {
            loader.style.display = 'none';
        }
    };
    const renderIntruderQuestion = (index) => {
        const quizContainer = form.querySelector('#quizContainer');
        const question = quizData[index];
        const answersHTML = question.affirmations.map((affirmation, i) => `<button type="button" data-index="${i}" class="intruder-answer-btn text-left p-4 my-2 bg-white border border-slate-300 rounded-lg hover:bg-cyan-100 hover:border-cyan-400 transition">${affirmation.texte}</button>`).join('');
        quizContainer.innerHTML = `<div class="bg-background-light p-6 rounded-lg border border-border-subtle"><p class="text-center font-semibold text-OrIAntation-darkblue text-lg mb-4">Trouvez l'intrus ! (Question ${index + 1} / 5)</p><p class="text-center text-slate-600 mb-6">Parmi ces quatre affirmations, une seule est fausse. Laquelle ?</p><div class="flex flex-col">${answersHTML}</div><div id="explanationContainer" class="mt-6"></div></div>`;
        quizContainer.querySelectorAll('.intruder-answer-btn').forEach(btn => btn.addEventListener('click', (e) => checkIntruderAnswer(parseInt(e.target.dataset.index), index)));
    };
    const checkIntruderAnswer = (selectedIndex, questionIndex) => {
        const question = quizData[questionIndex];
        const isCorrect = !question.affirmations[selectedIndex].estVrai;
        if (isCorrect) score++;
        const explanationContainer = form.querySelector('#explanationContainer');
        const feedbackColor = isCorrect ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
        const feedbackText = isCorrect ? 'Bien vu, c\'était bien l\'intrus !' : 'Dommage, ce n\'était pas celui-là !';
        explanationContainer.innerHTML = `<div class="p-4 rounded-lg border-l-4 ${feedbackColor}"><h4 class="font-bold text-OrIAntation-darkblue">${feedbackText}</h4><p class="text-slate-700 mt-2">${question.explication}</p></div><div class="text-center mt-4"><button type="button" id="nextQuestionBtn" class="bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-cyan-700 transition">${(questionIndex + 1 === quizData.length) ? 'Voir mon score' : 'Question suivante'}</button></div>`;
        explanationContainer.querySelector('#nextQuestionBtn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) { renderIntruderQuestion(currentQuestionIndex); } else { renderFinalScore(); }
        });
        form.querySelectorAll('.intruder-answer-btn').forEach((btn, index) => {
            btn.disabled = true;
            if (!question.affirmations[index].estVrai) {
                btn.classList.add('bg-red-200', 'border-red-400'); // L'intrus
            } else if (index === selectedIndex) {
                btn.classList.add('bg-slate-200'); // La mauvaise réponse de l'utilisateur
            } else {
                btn.classList.add('bg-green-100'); // Les bonnes réponses restantes
            }
        });
    };
    
    // --- FONCTION DE FIN DE QUIZ, COMMUNE AUX DEUX MODES ---
    const renderFinalScore = () => {
        const quizContainer = form.querySelector('#quizContainer');
        const domain = journalData.step7.domaine;
        const scoreHistory = journalData.step7.scores[domain] || [];
        const oldBestScore = scoreHistory.length > 0 ? Math.max(...scoreHistory.map(s => s.score)) : -1;
        const newScoreEntry = { score: score, total: quizData.length, date: new Date().toISOString().split('T')[0], notes: '' };
        let recordMessage = score > oldBestScore ? `<p class="text-green-600 font-semibold mt-2">🎉 Nouveau record !</p>` : '';
        quizContainer.innerHTML = `<div class="text-center bg-background-light p-6 rounded-lg border border-border-subtle"><h3 class="text-xl font-bold text-OrIAntation-darkblue">Quiz terminé !</h3><p class="text-slate-600 mt-4">Ton score :</p><p class="text-3xl font-bold text-cyan-700 my-1">${score} / ${quizData.length}</p>${recordMessage}<hr class="my-6"><p class="text-slate-600 mb-2">Note ici ce que tu as appris d'important :</p><textarea id="reflexions" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ce qui m'a surpris, ce que je retiens..."></textarea></div><button type="button" id="save-quiz-results-btn" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">✔️ Enregistrer et revenir aux ateliers</button>`;
        quizContainer.querySelector('#save-quiz-results-btn').addEventListener('click', async () => {
            const notes = quizContainer.querySelector('#reflexions').value.trim();
            newScoreEntry.notes = notes;
            journalData.step7.scores[domain].push(newScoreEntry);
            await saveData();
            const xpGained = score * 5;
            if (xpGained > 0) await grantXp(xpGained);
            renderChoiceView();
        });
    };

    // --- AFFICHE LA PREMIÈRE VUE AU CHARGEMENT ---
    renderChoiceView();
    return div;
}

function createStep8View() {
    const config = stepsConfig.step8;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // On choisit la bonne description en fonction de la classe
    const description = (typeof config.description === 'string') ? config.description : (config.description[userGradeLevel] || config.description.default);
    const action = (typeof config.action === 'string') ? config.action : (config.action[userGradeLevel] || config.action.default);

    let contentHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-azimut-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>        
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${action}</div>
        </div>
    `;

    if (userGradeLevel === 'seconde') {
        // --- NOUVELLE INTERFACE POUR LES SECONDES ---
        contentHTML += `
            <div class="bg-background-light p-4 rounded-lg border mb-8">
                <h3 class="font-bold text-azimut-darkblue mb-2">Trouver mon stage de Seconde</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="stage-secteur" class="block text-md font-medium text-slate-700 mb-1">Secteur d'activité</label>
                        <input type="text" id="stage-secteur" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: Informatique, Santé, Commerce...">
                    </div>
                    <div>
                        <label for="stage-ville" class="block text-md font-medium text-slate-700 mb-1">Ville ou département</label>
                        <input type="text" id="stage-ville" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: Vannes, Morbihan...">
                    </div>
                </div>
                <button type="button" id="find-stage-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-cyan-700">🔎 Trouver des idées de lieux de stage</button>
            </div>
            <div id="loader-stage" class="hidden"><div class="loader"></div></div>
            <div id="stage-results" class="space-y-4 mb-8"></div>
            <hr class="my-8 border-slate-300">
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-azimut-darkblue mb-2">Préparer mon e-mail de candidature</h3>
                <button type="button" id="prepare-email-btn" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">✉️ M'aider à rédiger un modèle</button>
                <div id="loader-email" class="hidden"><div class="loader"></div></div>
                <textarea id="email-result" rows="10" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly placeholder="Le modèle d'e-mail apparaîtra ici..."></textarea>
            </div>
        `;
        div.innerHTML = contentHTML;

        // Logique pour la recherche de stage
        div.querySelector('#find-stage-btn').addEventListener('click', async () => {
            const secteur = div.querySelector('#stage-secteur').value.trim();
            const ville = div.querySelector('#stage-ville').value.trim();
            if (!secteur || !ville) { showInfoModal("Veuillez renseigner un secteur et une ville."); return; }

            const loader = div.querySelector('#loader-stage');
            const resultsDiv = div.querySelector('#stage-results');
            loader.style.display = 'block';
            resultsDiv.innerHTML = '';

const prompt = `Agis comme un conseiller d'orientation. Trouve 8 types de lieux (entreprises, associations, services publics...) où un élève de Seconde pourrait faire un stage d'observation dans le secteur "${secteur}" à "${ville}".
Ta réponse doit être **uniquement un objet JSON valide** contenant un tableau nommé "stages".
Chaque objet du tableau doit contenir les clés suivantes :
- "nom": Le nom du type de lieu (ex: "Cabinet d'architecte", "Mairie").
- "type": Le type de structure (ex: "Entreprise privée", "Service public").
- "description": Une brève description de ce que l'élève pourrait y observer.
- "lien_recherche": Une **URL de recherche Google complète et valide** pour trouver des exemples concrets de ce type de lieu dans la ville spécifiée. Exemple : "https://www.google.com/search?q=cabinets+d'architecte+à+Vannes".
`;
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true // Très important ici, car on attend un quiz au format JSON
});
            loader.style.display = 'none';
            try {
                const data = extractJsonFromString(result);
                let html = '';
                (data.stages || []).forEach(stage => {
                    html += `<div class="p-4 bg-white border rounded-lg shadow-sm">
                        <h4 class="font-bold text-cyan-700">${stage.nom} (${stage.type})</h4>
                        <p class="text-sm text-slate-600 mt-1">${stage.description}</p>
                        <a href="${stage.lien_recherche}" target="_blank" class="text-sm text-primary-action font-semibold hover:underline mt-2 inline-block">Rechercher sur Google ↗</a>
                    </div>`;
                });
                resultsDiv.innerHTML = html;
            } catch (e) {
                resultsDiv.innerHTML = `<p class="text-red-500">OrIA n'a pas pu formater la réponse. Réessayez.</p>`;
            }
        });

        // Logique pour l'aide à la rédaction d'e-mail
        div.querySelector('#prepare-email-btn').addEventListener('click', async () => {
            const loader = div.querySelector('#loader-email');
            const resultTextarea = div.querySelector('#email-result');
            loader.style.display = 'block';
            resultTextarea.value = '';

            const prompt = `Rédige un modèle d'e-mail court, poli et efficace pour un élève de Seconde, ${currentUserInfo.firstName}, qui postule pour son stage d'observation. L'e-mail doit être facilement adaptable avec des [champs à remplir].`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});         
   loader.style.display = 'none';
            resultTextarea.value = result;
        });

   // Remplacez votre bloc "else" actuel par celui-ci

} else {
    // --- INTERFACE POUR LES PREMIÈRES ET TERMINALES (CODE RESTAURÉ) ---
    div.innerHTML = contentHTML + `
        <div class="bg-background-light p-4 rounded-lg border mb-8">
            <h3 class="font-bold text-azimut-darkblue mb-2">Ajouter et trouver des contacts</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-md font-medium text-slate-700 mb-2">Contact personnel</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="new-contact-name" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Nom, lien de parenté...">
                        <button type="button" id="add-contact-btn" class="bg-cyan-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-cyan-700">+</button>
                    </div>
                </div>
                <div>
                    <label for="pro_departement" class="block text-md font-medium text-slate-700 mb-2">Département de recherche</label>
                    <input type="text" id="pro_departement" class="w-full p-2 border border-slate-300 rounded-lg mt-1" placeholder="Ex: 75, Morbihan...">
                </div>
            </div>
            <div class="space-y-2 mb-4">
                <label class="block text-md font-medium text-slate-700 mb-2">Métiers recherchés (jusqu'à 3)</label>
                <input type="text" id="pro_metier1" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Métier #1 (Ex: Architecte)">
                <input type="text" id="pro_metier2" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Métier #2 (optionnel)">
                <input type="text" id="pro_metier3" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Métier #3 (optionnel)">
            </div>
            <button type="button" id="openaiBtn_find_pro" class="w-full bg-cyan-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-cyan-700">🔎 Lancer la recherche</button>
            <div id="loader-find-pro" class="hidden"><div class="loader"></div></div>
            <div id="find-pro-error"></div>
        </div>
        <h2 class="text-2xl font-bold text-azimut-darkblue mb-4">Ma Liste de Suivi</h2>
        <div id="contact-list-container" class="space-y-3 mb-8"></div>
        <hr class="my-8 border-slate-300">
        <h2 class="text-2xl font-bold text-azimut-darkblue mb-4">Préparer ma prise de contact</h2>
        <div class="max-w-xl mx-auto">
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-azimut-darkblue mb-2">Stratégie de Contact</h3>
                <p class="text-sm text-slate-600 mb-2">Besoin d'aide pour rédiger un mail ou préparer tes questions ?</p>
                <input type="text" id="pro_metier_aide" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Rappelle le métier concerné">
                <button type="button" id="openaiBtn_contact_pro" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">✉️ Générer une stratégie</button>
                <div id="openaiLoader_pro_contact" class="hidden"><div class="loader"></div></div>
                <textarea id="pro_strategie" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly></textarea>
            </div>
        </div>
    `;
    
    // On initialise les données et les fonctions
    if (!journalData.step8) {
        journalData.step8 = { contacts: [], departement: '', metier1: '', metier2: '', metier3: '', pro_strategie: '' };
    }
    div.querySelector('#pro_departement').value = journalData.step8.departement || '';
    div.querySelector('#pro_metier1').value = journalData.step8.metier1 || '';
    div.querySelector('#pro_metier2').value = journalData.step8.metier2 || '';
    div.querySelector('#pro_metier3').value = journalData.step8.metier3 || '';
    div.querySelector('#pro_strategie').value = journalData.step8.pro_strategie || '';

    const contactListContainer = div.querySelector('#contact-list-container');
    const statusOptions = { a_contacter: "À contacter", contacte: "Contacté", reponse_recue: "Réponse reçue", entretien_prevu: "Entretien prévu" };
    const statusColors = { a_contacter: "bg-slate-100 border-slate-300", contacte: "bg-blue-100 border-blue-300", reponse_recue: "bg-yellow-100 border-yellow-300", entretien_prevu: "bg-green-100 border-green-300" };

    const renderContactList = () => {
        contactListContainer.innerHTML = '';
        if (!journalData.step8.contacts || journalData.step8.contacts.length === 0) {
            contactListContainer.innerHTML = `<p class="text-center text-slate-500 p-4">Ta liste de contacts est vide.</p>`;
            return;
        }
        journalData.step8.contacts.forEach((contact, index) => {
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg border flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 ${statusColors[contact.statut || 'a_contacter']}`;
            let optionsHTML = '';
            for (const [value, text] of Object.entries(statusOptions)) {
                optionsHTML += `<option value="${value}" ${contact.statut === value ? 'selected' : ''}>${text}</option>`;
            }
            card.innerHTML = `
                <div class="flex-1">
                    <p class="font-semibold text-azimut-darkblue">${contact.nom}</p>
                    ${contact.search_link ? `<a href="${contact.search_link}" target="_blank" class="text-sm text-primary-action hover:underline">Rechercher ce contact ↗</a>` : `<p class="text-sm text-slate-600 mt-1">${contact.details || ''}</p>`}
                </div>
                <div class="flex items-center gap-2 w-full sm:w-auto self-end sm:self-center">
                    <select data-index="${index}" class="status-select w-full sm:w-auto p-2 border border-slate-300 rounded-lg">
                        ${optionsHTML}
                    </select>
                    <button data-index="${index}" class="delete-btn bg-red-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-red-600">×</button>
                </div>
            `;
            contactListContainer.appendChild(card);
        });
        checkBadges();
    };

    div.addEventListener('click', (e) => {
        if (e.target.closest('#add-contact-btn')) {
            const input = div.querySelector('#new-contact-name');
            const name = input.value.trim();
            if (name) {
                if (!Array.isArray(journalData.step8.contacts)) journalData.step8.contacts = [];
                const searchLink = `https://www.google.com/search?q=${encodeURIComponent(name)}`;
                journalData.step8.contacts.push({ nom: name, search_link: searchLink, type: 'personnel', statut: 'a_contacter' });
                input.value = '';
                renderContactList();
                saveData();
            }
        }
        if (e.target.closest('.delete-btn')) {
            const index = e.target.closest('.delete-btn').dataset.index;
            showConfirmationModal("Es-tu sûr de vouloir supprimer ce contact ?").then(confirmed => {
                if (confirmed) {
                    journalData.step8.contacts.splice(index, 1);
                    renderContactList();
                    saveData();
                }
            });
        }
    });

    div.addEventListener('change', (e) => {
        if (e.target.matches('.status-select')) {
            const index = e.target.dataset.index;
            const newStatus = e.target.value;
            journalData.step8.contacts[index].statut = newStatus;
            renderContactList();
            saveData();
        }
    });
    
    // --- DÉBUT DE LA LOGIQUE RESTAURÉE ---
    div.querySelector('#openaiBtn_find_pro').addEventListener('click', async () => {
        const departement = div.querySelector('#pro_departement').value.trim();
        const metier1 = div.querySelector('#pro_metier1').value.trim();
        const metier2 = div.querySelector('#pro_metier2').value.trim();
        const metier3 = div.querySelector('#pro_metier3').value.trim();
        const loader = div.querySelector('#loader-find-pro');
        const errorDiv = div.querySelector('#find-pro-error');
        const metiersList = [metier1, metier2, metier3].filter(m => m.trim() !== '');

        if (!departement || metiersList.length === 0) {
            showInfoModal("Veuillez renseigner un département ET au moins un métier.");
            return;
        }
        
        journalData.step8.departement = departement;
        journalData.step8.metier1 = metier1;
        journalData.step8.metier2 = metier2;
        journalData.step8.metier3 = metier3;

        if (!Array.isArray(journalData.step8.contacts)) journalData.step8.contacts = [];
        journalData.step8.contacts = journalData.step8.contacts.filter(c => c.type === 'personnel');

        loader.style.display = 'block';
        errorDiv.innerHTML = '';
        
        const prompt = `Agis comme un conseiller d'orientation cherchant des contacts professionnels, pas des centres d'information généraux. Pour un lycéen dans le département "${departement}", trouve au moins 5 contacts de **professionnels, d'entreprises, de cabinets ou d'associations professionnelles** pertinents pour les métiers suivants : "${metiersList.join(', ')}". **Évite les CIO et les structures d'information généralistes**, sauf si aucune autre option n'est disponible. Diversifie les résultats entre les différents métiers si possible. Ta réponse doit être **uniquement un objet JSON valide** contenant un tableau d'objets. Chaque objet doit avoir deux clés : "nom" (le nom de la structure) et "search_link" (une URL de recherche Google complète et valide pour trouver cette structure, ex: "https://www.google.com/search?q=Ordre+des+Architectes+de+Vannes").`;
        
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true // Très important ici, car on attend un quiz au format JSON
});
        loader.style.display = 'none';
        
        try {
    const parsedJson = extractJsonFromString(result);
    if (!parsedJson) {
        throw new Error("La réponse de OrIA n'est pas un JSON valide.");
    }
    
    // On gère les deux cas : soit un tableau direct, soit un objet contenant un tableau
    const contactsList = Array.isArray(parsedJson) ? parsedJson : parsedJson.contacts;

    if (!Array.isArray(contactsList)) {
        throw new Error("La réponse de OrIA ne contient pas une liste de contacts valide.");
    }

    contactsList.forEach(contact => {
        journalData.step8.contacts.push({ nom: contact.nom, search_link: contact.search_link, type: 'externe', statut: 'a_contacter' });
    });
    renderContactList();
    await saveData();

} catch (e) {
    errorDiv.innerHTML = `
        <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-800 mt-4 rounded-r-lg">
            <p class="font-bold">OrIA n'a pas renvoyé une liste de contacts valide.</p>
            <p class="text-sm mt-1">Voici sa réponse brute :</p>
            <pre class="whitespace-pre-wrap bg-red-50 p-2 mt-2 rounded text-xs font-mono">${result}</pre>
        </div>
    `;
}
    });

    div.querySelector('#openaiBtn_contact_pro').addEventListener('click', async () => {
        const metier = div.querySelector('#pro_metier_aide').value.trim();
        const loader = div.querySelector('#openaiLoader_pro_contact');
        const resultDiv = div.querySelector('#pro_strategie');
        if (!metier) { resultDiv.value = "Veuillez indiquer un métier pour générer une stratégie."; return; }
        loader.style.display = 'block'; resultDiv.value = '';
const prompt = `
    Agis comme un coach d'orientation qui aide un(e) lycéen(ne) à préparer un contact professionnel. L'élève s'intéresse au métier de "${metier}".

    Ta mission est de rédiger une réponse complète et directement utilisable, structurée en deux parties claires, mais sans utiliser de listes.

    Pour la première partie, propose un modèle de mail sous le titre en gras **Modèle de mail à adapter :**. Ce mail doit être court, poli et efficace, et avoir pour but de demander un bref échange de 15 minutes.

    Pour la seconde partie, propose 3 questions pertinentes à poser, sous le titre en gras **Quelques questions pour briser la glace :**. Intègre ces questions dans un petit paragraphe d'introduction pour les présenter naturellement.

    ## Formatage Impératif

    - **Ton :** Bienveillant, encourageant et professionnel.
    - **Structure :** Utilise uniquement les titres en gras comme demandé.
    - **Interdits :** La réponse ne doit contenir AUCUN hashtag (#), AUCUNE liste à puces (*), AUCUNE ligne de séparation (---), et AUCUNE liste numérotée (1., 2.). Tout doit être rédigé sous forme de paragraphes fluides.
`;

const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});
        loader.style.display = 'none'; 
        resultDiv.value = result;
        journalData.step8.pro_strategie = result;
        await saveData();
    });
    // --- FIN DE LA LOGIQUE RESTAURÉE ---

    renderContactList();
}
    
    return div;
}


function createStep9View() {
    const config = stepsConfig.step9;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    const defaults = {
        formation_reve: '',
        planb_chat_history: [],
        reussite_type: '',
        reussite_conseils: ''
    };
    journalData.step9 = { ...defaults, ...journalData.step9 };
    if (!Array.isArray(journalData.step9.planb_chat_history)) {
        journalData.step9.planb_chat_history = [];
    }
    
    div.innerHTML = `
        
<h1 class="text-2xl font-bold text-center col-span-1 flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>       
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${config.action}</div>
        </div>
        <form id="stepForm">
            <h2 class="text-xl font-semibold mb-4 text-OrIAntation-darkblue">1. Simulation : Mon Plan B</h2>
            <div class="mb-6">
                <label for="formation_reve" class="block text-md font-medium text-slate-700 mb-2">Ma formation "rêvée" (Vœu n°1)</label>
                <div class="flex gap-2">
                    <input type="text" id="formation_reve" name="formation_reve" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Classe prépa MPSI" value="${journalData.step9.formation_reve || ''}">
                    <button type="button" id="startPlanBSimBtn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Lancer</button>
                </div>
            </div>
            <div id="planb-chat-container" class="bg-white p-4 rounded-lg border border-border-subtle min-h-[300px] flex flex-col">
                <div id="planb-chat-messages" class="flex flex-col flex-1 overflow-y-auto space-y-4 p-2"></div>
                <div id="planb-loader" class="hidden"><div class="loader"></div></div>
                <div id="planb-chat-controls" class="mt-4 flex items-center gap-2">
                    <input type="text" id="planb-input" placeholder="Ta réponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <button type="button" id="planb-send-btn" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
                </div>
            </div>
            <hr class="my-8">
            <h2 class="text-xl font-semibold mb-4 text-OrIAntation-darkblue">2. Mon Coach de Réussite</h2>
            <div class="mb-6">
                <label for="reussite_type" class="block text-md font-medium text-slate-700 mb-2">Type de formation pour lequel tu veux des conseils</label>
                <input type="text" id="reussite_type" name="reussite_type" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Licence de Droit, BUT..." value="${journalData.step9.reussite_type || ''}">
            </div>
            <div class="text-center mb-4">
                <button type="button" id="openaiBtn_reussite" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">✨ Me coacher pour la 1ère année</button>
            </div>
            <div id="openaiLoader_reussite" class="hidden"><div class="loader"></div></div>
            <div class="mb-6">
                <label for="reussite_conseils" class="block text-md font-medium text-slate-700 mb-2">Conseils de réussite par OrIA</label>
                <textarea id="reussite_conseils" name="reussite_conseils" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${journalData.step9.reussite_conseils || ''}</textarea>
            </div>
        </form>
    `;

    const form = div.querySelector('#stepForm');
    const chatMessages = div.querySelector('#planb-chat-messages');
    const chatInput = div.querySelector('#planb-input');
    const chatSendBtn = div.querySelector('#planb-send-btn');
    const chatControls = div.querySelector('#planb-chat-controls');
    const loader = div.querySelector('#planb-loader');

    const addChatMessage = (sender, text) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `p-3 rounded-lg max-w-lg text-left ${sender === 'user' ? 'bg-blue-500 text-white self-end' : 'bg-slate-200 text-OrIAntation-darkblue self-start'}`;
        messageDiv.innerHTML = linkify(text);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const renderChatHistory = () => {
        chatMessages.innerHTML = '';
        if (journalData.step9.planb_chat_history) {
            journalData.step9.planb_chat_history.forEach(msg => addChatMessage(msg.role, msg.text));
        }
    };
    
    renderChatHistory();

    div.querySelector('#startPlanBSimBtn').addEventListener('click', async () => {
    const formation = div.querySelector('#formation_reve').value.trim();
    if (!formation) { showInfoModal("Veuillez d'abord renseigner votre formation 'rêvée'."); return; }
    journalData.step9.formation_reve = formation;
    journalData.step9.planb_chat_history = [];
    renderChatHistory();
    loader.style.display = 'block';
    chatControls.style.display = 'none';

    // ▼▼▼ LE NOUVEAU PROMPT EST ICI ▼▼▼
    const prompt = `
    Agis comme un coach d'orientation qui lance une simulation de "Plan B". L'objectif est d'aider un élève à anticiper une réponse négative pour son vœu n°1, qui est : "${formation}".

##Règles Impératives

    1.  **Pas de Salutations :** Ne salue PAS l'élève à nouveau. La conversation est déjà en cours. Plonge directement dans le vif du sujet en rebondissant sur sa dernière réponse.
    2.  **Cadre de la Simulation :** Parle toujours au conditionnel. Le refus est une HYPOTHÈSE, pas un fait.

    NE DIS PAS : "Tu n'as pas été accepté."
    DIS : "Imaginons que la réponse ne soit pas favorable, quelles autres pistes..."

    Rédige ton premier message pour lancer la simulation. Explique brièvement l'intérêt de réfléchir à un plan B, puis pose une question ouverte pour l'amener à réfléchir aux alternatives ou à ce qui lui plaît vraiment dans son vœu n°1.

    Voici l'historique de votre conversation : ${JSON.stringify(journalData.step9.planb_chat_history)}.

    Continue la conversation de manière naturelle en te basant sur sa dernière réponse. S'il est bloqué (ex: "je sais pas"), aide-le à débloquer sa réflexion. Pose une question ouverte pour l'aider à identifier ce qui l'attire vraiment dans son vœu n°1 (les matières, le type d'études, les débouchés...).
`;

const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});   
 loader.style.display = 'none';
    chatControls.style.display = 'flex';
    journalData.step9.planb_chat_history.push({ role: 'ai', text: result });
    addChatMessage('ai', result);
    await saveData();
});

    const handleChatSubmit = async () => {
        const userInput = chatInput.value.trim();
        if (!userInput) return;
        journalData.step9.planb_chat_history.push({ role: 'user', text: userInput });
        addChatMessage('user', userInput);
        chatInput.value = '';
        loader.style.display = 'block';
        chatControls.style.display = 'none';
        const formation = journalData.step9.formation_reve;
        const prompt = `Agis comme un coach d'orientation bienveillant. Continue cette conversation avec un élève qui réagit au refus de son vœu n°1 ("${formation}"). Voici l'historique : ${JSON.stringify(journalData.step9.planb_chat_history)}. En te basant sur sa dernière réponse, continue de dialoguer. Si tu sens qu'il est prêt, commence à introduire en douceur des pistes de Plan B (formations similaires moins sélectives, parcours connexes, etc.). Le but est de l'aider à accepter la situation et à voir les alternatives de manière positive.`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});      
  loader.style.display = 'none';
        chatControls.style.display = 'flex';
        journalData.step9.planb_chat_history.push({ role: 'ai', text: result });
        addChatMessage('ai', result);
        await saveData();
    };

    chatSendBtn.addEventListener('click', handleChatSubmit);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleChatSubmit();
        }
    });

div.querySelector('#openaiBtn_reussite').addEventListener('click', async () => {
    // 1. Récupérer les éléments et la valeur saisie par l'utilisateur
    const reussiteTypeInput = div.querySelector('#reussite_type');
    const formationType = reussiteTypeInput.value.trim();
    const loader = div.querySelector('#openaiLoader_reussite');
    const resultTextarea = div.querySelector('#reussite_conseils');

    // 2. Vérifier si l'utilisateur a bien entré une formation
    if (!formationType) {
        showInfoModal("Action requise", "Veuillez d'abord renseigner le type de formation pour lequel vous souhaitez des conseils.");
        return; // Arrêter la fonction ici
    }

    // 3. Afficher le loader et vider le champ de résultat
    loader.style.display = 'block';
    resultTextarea.value = '';

    // 4. Créer le prompt (la mission) pour l'IA
    const prompt = `
    Agis comme le parrain ou la marraine de promo qui écrit un message bienveillant et plein de bons conseils à un lycéen sur le point d'entrer en première année de "${formationType}".

    Ta mission est de rédiger un message fluide, encourageant et facile à lire qui l'aide à anticiper les défis et à mettre en place les bonnes stratégies dès le début.

    Ton message doit s'articuler autour des thèmes suivants, traités dans des paragraphes distincts :

    1.  **La méthode de travail :** Explique la transition clé entre le lycée et le supérieur. Insiste sur l'importance de l'autonomie, du travail régulier (même quand il n'y a pas d'évaluation immédiate) et de la curiosité (aller au-delà du cours).
    
    2.  **L'équilibre et la vie sociale :** Donne un conseil sur l'importance de ne pas s'isoler. Suggère des moyens concrets de s'intégrer (associations étudiantes, travaux de groupe, événements du campus) et de trouver un bon équilibre entre les études et la vie personnelle.

    3.  **Le piège n°1 à éviter :** Décris le piège classique de la première année : la procrastination et le fait de se laisser déborder par la quantité de travail. Explique pourquoi c'est un piège et donne une astuce simple pour y remédier (ex: la règle des "15 minutes par jour et par matière").

    4.  **Préparer l'avenir dès maintenant :** Termine par un conseil pour l'encourager à voir plus loin que la première année. Suggère-lui de se renseigner tôt sur les stages, les projets personnels ou les opportunités qui pourraient enrichir son parcours.

    ## Formatage et Ton (Règles Impératives)

    - **Ton :** Le message doit être rédigé sur un ton naturel, comme si tu parlais à un ami que tu souhaites voir réussir. Utilise des phrases encourageantes.
    - **Structure :** Utilise des titres en gras (avec **) pour introduire chaque nouvelle idée. Par exemple : "**Ta nouvelle routine de travail**".
    - **Interdits :** N'utilise JAMAIS de listes à puces (*), de listes numérotées (1., 2.), ou de titres avec des hashtags (#). La réponse doit être un texte unifié et fluide.
`;

    // 5. Appeler l'IA avec le prompt
    const result = await callOpenAI_API({
        promptText: prompt,
        withPersona: true
    });

    // 6. Cacher le loader et afficher le résultat
    loader.style.display = 'none';
    resultTextarea.value = result;

    // 7. Sauvegarder le résultat dans le journal de bord
    journalData.step9.reussite_conseils = result;
    await saveData();
});
            
    return div;
}

function createStep10View() {
    const config = stepsConfig.step10;
    
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    div.innerHTML = `
        
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" />
        </svg>
        <span>${config.title}</span>
    </h1>
    <div class="text-slate-600 mb-4 whitespace-pre-wrap text-center">${config.description}</div>
    <form id="stepForm"></form> 
`;
    
    const form = div.querySelector('#stepForm');
    
    const description = config.description;
    const action = config.action;
    
    if (!journalData.step10 || typeof journalData.step10 !== 'object') {
        journalData.step10 = { experiences: [], soft_skills_profile: '', skills_synthesis: '' };
    }
    if (!Array.isArray(journalData.step10.experiences)) {
        journalData.step10.experiences = [];
    }

    let currentExperience = null;
    
    form.innerHTML = `
        <div class="bg-cyan-50 p-4 rounded-r-lg border-l-4 border-cyan-400 my-6">
            <h3 class="font-bold text-cyan-800">🤔 Profil vs. Compétences : quelle est la différence ?</h3>
            <p class="text-sm text-slate-700 mt-2">
                À l'étape "Mieux se connaître", tu as fait un autoportrait de ta personnalité (introverti ou extraverti, créatif ou logique...). Ici, tu vas construire un portfolio qui montre concrètement ce que tu as appris à faire.
            </p>
            <p class="text-sm text-slate-700 mt-2">
                Ton profil répond à la question **"Qui es-tu ?"**. Ton portfolio répond à la question **"Que sais-tu faire ?"**. Les deux sont essentiels pour un projet d'orientation solide et crédible !
            </p>
        </div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${action}</div>
        </div>
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Atelier 1 : Mes Expériences Significatives</h2>
            <div id="experience-list-container" class="space-y-4 mb-6"></div>
            <button type="button" id="add-experience-btn" class="w-full bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">
                + Ajouter une expérience
            </button>
        </div>
        <hr class="my-12 border-slate-300">
        <div>
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Atelier 2 : Mon Profil de Compétences</h2>
            <div id="detector-container" class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <p class="text-slate-600 mb-4">Réponds à quelques questions rapides pour révéler tes compétences transversales dominantes.</p>
                <button type="button" id="start-detector-btn" class="w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">
                    🧠 Lancer le détecteur
                </button>
                <div id="quiz-container" class="hidden mt-4"></div>
                <div id="detector-results-container" class="hidden mt-4"></div>
            </div>
        </div>
        
        <div id="connector-section" class="hidden mt-12 border-t-4 border-cyan-500 pt-6">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">🔗 Le Connecteur de Compétences</h2>
            <p class="text-slate-600 mb-4">Bravo ! Maintenant que tu as analysé tes expériences ET ton profil, clique sur le bouton pour que OrIA rédige une synthèse qui connecte tes savoir-faire (issus de tes expériences) et tes savoir-être (issus du quiz).</p>
            <div class="text-center">
<button type="button" id="connect-skills-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Connecter mes compétences</button>
            </div>
            <div id="loader-connector" class="hidden"><div class="loader"></div></div>
            <textarea id="skills-synthesis" name="skills_synthesis" rows="8" class="w-full mt-4 p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${journalData.step10.skills_synthesis || ''}</textarea>
        </div>
        <button type="submit" class="w-full mt-8 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">✔️ Terminer et sauvegarder le portfolio</button>
        <div id="portfolio-modal" class="portfolio-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-xl font-bold text-OrIAntation-darkblue">Assistant de Portfolio</h2>
                    <button type="button" id="portfolio-modal-close" class="text-slate-500 hover:text-OrIAntation-darkblue text-2xl">×</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div id="wizard-step-1">
                        <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">Étape 1 : Décris ton expérience</h3><p class="text-slate-600 mb-4">Raconte un projet, un job, un engagement, une passion...</p><textarea id="experience-input" rows="6" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: J'ai organisé un tournoi de jeux vidéo..."></textarea><button type="button" id="wizard-next-1" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valider et identifier les compétences ✨</button>
                    </div>
                    <div id="wizard-step-2" class="hidden">
                         <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">Étape 2 : Valide tes compétences</h3><p class="text-slate-600 mb-4">Clique sur les compétences qui te semblent les plus justes.</p><div id="skill-tags-container" class="flex flex-wrap gap-3 p-4 bg-background-light rounded-lg border min-h-[100px]"></div><div id="loader-2" class="hidden"><div class="loader"></div></div><button type="button" id="wizard-next-2" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valoriser ces compétences 🚀</button>
                    </div>
                    <div id="wizard-step-3" class="hidden">
                        <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">Étape 3 : Voici ton texte valorisé !</h3><p class="text-slate-600 mb-4">Utilise ce paragraphe dans tes lettres de motivation ou sur ton CV.</p><div id="loader-3" class="hidden"><div class="loader"></div></div><div id="portfolio-result" class="p-4 bg-background-light rounded-lg border whitespace-pre-wrap min-h-[150px]"></div><div class="flex gap-4"><button type="button" id="save-experience-btn" class="w-full mt-4 bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Enregistrer l'expérience</button></div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const detectorContainer = div.querySelector('#detector-container');
    const startDetectorBtn = div.querySelector('#start-detector-btn');
    const quizContainer = div.querySelector('#quiz-container');
    const resultsContainer = div.querySelector('#detector-results-container');
    let userSoftSkills = [];
    let currentQuestionIndex = 0;

    const quizQuestions = [
        { question: "Face à un projet complexe, ta première réaction est de :", answers: [ { text: "Faire un plan détaillé avec des étapes claires.", skill: "Planification" }, { text: "Commencer tout de suite pour voir ce qui marche.", skill: "Initiative" }, { text: "Imaginer plusieurs solutions originales.", skill: "Créativité" } ] },
        { question: "Dans un travail de groupe, tu as tendance à :", answers: [ { text: "T'assurer que tout le monde s'entend bien.", skill: "Collaboration" }, { text: "Prendre les devants pour organiser les tâches.", skill: "Leadership" }, { text: "Te concentrer sur la partie qui demande le plus de recherche.", skill: "Analyse" } ] },
        { question: "Quand tu ne comprends pas quelque chose, tu :", answers: [ { text: "Cherches la réponse par toi-même jusqu'à la trouver.", skill: "Autonomie" }, { text: "Demandes de l'aide à quelqu'un qui sait.", skill: "Communication" }, { text: "Essaies de voir le problème sous un autre angle.", skill: "Adaptabilité" } ] },
        { question: "Un imprévu survient dans un projet. Que fais-tu ?", answers: [ { text: "Tu proposes rapidement un plan B.", skill: "Adaptabilité" }, { text: "Tu analyses la source du problème pour qu'il ne se répète pas.", skill: "Analyse" }, { text: "Tu rassures l'équipe et maintiens une bonne ambiance.", skill: "Intelligence Émotionnelle" } ] },
        { question: "Laquelle de ces phrases te décrit le mieux ?", answers: [ { text: "J'aime quand les choses sont bien organisées.", skill: "Rigueur" }, { text: "J'aime convaincre les autres de mes idées.", skill: "Persuasion" }, { text: "J'aime apprendre de nouvelles choses constamment.", skill: "Curiosité" } ] },
        { question: "Face à un grand changement (déménagement, nouveau projet...), tu es plutôt :", answers: [ { text: "Enthousiaste, tu y vois une opportunité.", skill: "Adaptabilité" }, { text: "Prudent, tu as besoin de temps pour t'adapter.", skill: "Réflexion" } ] },
        { question: "Quand tu as beaucoup de choses à faire, tu as tendance à :", answers: [ { text: "Créer une to-do list et t'y tenir.", skill: "Organisation" }, { text: "Travailler sur la tâche qui t'inspire le plus.", skill: "Motivation" } ] },
        { question: "Tu préfères un projet où :", answers: [ { text: "Le résultat est garanti.", skill: "Prudence" }, { text: "Il y a une part de risque et de découverte.", skill: "Audace" } ] },
        { question: "Face à une difficulté, ton premier réflexe est de :", answers: [ { text: "Chercher à comprendre pourquoi ça n'a pas marché.", skill: "Analyse critique" }, { text: "Te relever et réessayer.", skill: "Résilience" } ] },
        { question: "Quand tu ne connais personne à une soirée, tu as tendance à :", answers: [ { text: "Attendre que quelqu'un vienne te parler.", skill: "Observation" }, { text: "Faire le premier pas et aller vers les autres.", skill: "Proactivité" } ] }
    ];

    const displayQuestion = (index) => {
        if (index >= quizQuestions.length) {
            displayDetectorResults();
            return;
        }
        const q = quizQuestions[index];
        quizContainer.innerHTML = `
            <p class="font-semibold text-slate-700 mb-4">${q.question}</p>
            <div class="flex flex-col space-y-2">
                ${q.answers.map((ans, i) => `<button type="button" data-skill="${ans.skill}" class="answer-btn text-left p-3 bg-background-light hover:bg-cyan-100 border rounded-lg">${ans.text}</button>`).join('')}
            </div>
        `;
        quizContainer.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                userSoftSkills.push(btn.dataset.skill);
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            });
        });
    };
    
    const displayDetectorResults = async () => {
        quizContainer.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `<div class="loader"></div>`;
        const skillCounts = userSoftSkills.reduce((acc, skill) => { acc[skill] = (acc[skill] || 0) + 1; return acc; }, {});
        const topSkills = Object.entries(skillCounts).sort((a, b) => b[1] - a[1]).map(el => el[0]);
        const prompt = `Un lycéen a passé un quiz de compétences transversales. Ses compétences les plus marquées sont : ${topSkills.join(', ')}. Rédige une analyse courte et positive (8-10 phrases) de son profil de compétences, en expliquant ce que cela signifie pour son orientation. Tu dois t'adresser directement à l'élève, en utilisant "tu"`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});    
    journalData.step10.soft_skills_profile = result;
        await saveData();
        resultsContainer.innerHTML = `<h4 class="font-bold text-OrIAntation-darkblue mb-2">Analyse de ton profil :</h4><div class="p-4 bg-background-light rounded-lg border whitespace-pre-wrap">${result}</div>`;
        checkConnectorState();
    };

    startDetectorBtn.addEventListener('click', () => {
        quizContainer.classList.remove('hidden');
        userSoftSkills = [];
        currentQuestionIndex = 0;
        displayQuestion(currentQuestionIndex);
    });

    if (journalData.step10.soft_skills_profile) {
        startDetectorBtn.classList.remove('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `<h4 class="font-bold text-OrIAntation-darkblue mb-2">Analyse de ton profil :</h4><div class="p-4 bg-background-light rounded-lg border whitespace-pre-wrap">${journalData.step10.soft_skills_profile}</div>`;
    }

    const modal = div.querySelector('#portfolio-modal');
    const experienceListContainer = div.querySelector('#experience-list-container');

    const renderExperienceCards = () => {
        experienceListContainer.innerHTML = '';
        if (journalData.step10.experiences.length === 0) {
            experienceListContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Ton portfolio est vide. Clique sur "Ajouter une expérience" pour commencer.</p>`;
        } else {
            journalData.step10.experiences.forEach((exp, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-border-subtle';
                card.innerHTML = `<h4 class="font-bold text-cyan-700">Expérience #${index + 1}</h4><p class="text-slate-700 whitespace-pre-wrap mt-2">${exp.analysis}</p><div class="text-right mt-2"><button type="button" data-index="${index}" class="delete-exp-btn text-red-500 hover:text-red-700 text-sm font-semibold">Supprimer</button></div>`;
                experienceListContainer.appendChild(card);
            });
        }
        div.querySelectorAll('.delete-exp-btn').forEach(btn => {
    // On rend la fonction du clic "async" pour pouvoir utiliser "await"
    btn.addEventListener('click', async (e) => {
        const index = parseInt(e.target.dataset.index, 10);
        // On remplace confirm() par notre fenêtre modale personnalisée
        const confirmed = await showConfirmationModal("Es-tu sûr de vouloir supprimer cette expérience ?");
        if (confirmed) {
            journalData.step10.experiences.splice(index, 1);
            await saveData();
            renderExperienceCards();
        }
    });
});
        checkConnectorState();
    };
    
    div.querySelector('#add-experience-btn').addEventListener('click', () => {
        currentExperience = { description: '', analysis: '' };
        div.querySelector('#experience-input').value = '';
        showStep(1);
        modal.classList.remove('hidden');
    });
    div.querySelector('#portfolio-modal-close').addEventListener('click', () => modal.classList.add('hidden'));

    const wizardSteps = [div.querySelector('#wizard-step-1'), div.querySelector('#wizard-step-2'), div.querySelector('#wizard-step-3')];
    const showStep = (stepNumber) => {
        wizardSteps.forEach((step, index) => step.classList.toggle('hidden', index + 1 !== stepNumber));
    };

    div.querySelector('#wizard-next-1').addEventListener('click', async () => {
        const description = div.querySelector('#experience-input').value;
        if (description.trim().length < 20) {
            showInfoModal("Veuillez décrire votre expérience de manière un peu plus détaillée.");
            return;
        }
        currentExperience.description = description;
        showStep(2);
        div.querySelector('#loader-2').classList.remove('hidden');
        div.querySelector('#skill-tags-container').innerHTML = '';
        const prompt = `Analyse la description de l'expérience suivante fournie par un lycéen. Identifie les 5 à 7 compétences clés (savoir-être ou savoir-faire) les plus importantes qui en ressortent. Ta réponse doit être **uniquement un objet JSON valide** contenant un unique tableau de chaînes de caractères. Exemple : ["Gestion de projet", "Communication"]. Voici l'expérience : "${description}"`;
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true
});
        div.querySelector('#loader-2').classList.add('hidden');
        const skillTagsContainer = div.querySelector('#skill-tags-container');
        try {
    // On utilise notre extracteur intelligent au lieu de JSON.parse directement
    const skills = extractJsonFromString(result);

    // On ajoute une vérification pour s'assurer que l'extraction a bien renvoyé un tableau
    if (!Array.isArray(skills)) {
        throw new Error("La réponse de OrIA n'est pas un tableau de compétences valide.");
    }

    skills.forEach(skill => {
        const tag = document.createElement('button');
        tag.type = 'button';
        tag.className = 'bg-white border-cyan-500 border-2 text-cyan-700 font-semibold py-1 px-3 rounded-full cursor-pointer transition hover:bg-cyan-100';
        tag.textContent = skill;
        tag.addEventListener('click', () => {
            tag.classList.toggle('bg-cyan-500');
            tag.classList.toggle('text-white');
        });
        skillTagsContainer.appendChild(tag);
    });
} catch (e) {
    console.error("Erreur d'extraction des compétences:", e, "Réponse brute:", result);
    skillTagsContainer.textContent = "OrIA n'a pas pu extraire de compétences. Veuillez réessayer.";
}
    });

    div.querySelector('#wizard-next-2').addEventListener('click', async () => {
        const selectedSkills = Array.from(div.querySelectorAll('#skill-tags-container .bg-cyan-500')).map(tag => tag.textContent);
        if (selectedSkills.length === 0) {
            showInfoModal("Veuillez sélectionner au moins une compétence.");
            return;
        }
        showStep(3);
        div.querySelector('#loader-3').classList.remove('hidden');
        div.querySelector('#portfolio-result').textContent = '';
        const prompt = `Agis en tant que coach carrière expert. Rédige un paragraphe percutant (4-5 phrases) basé sur la méthode STAR (Situation, Tâche, Action, Résultat) pour valoriser une expérience. **Description de l'expérience :** "${currentExperience.description}" **Compétences clés à valoriser :** ${JSON.stringify(selectedSkills)}`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});    
    div.querySelector('#loader-3').classList.add('hidden');
        div.querySelector('#portfolio-result').textContent = result;
        currentExperience.analysis = result;
    });

    div.querySelector('#save-experience-btn').addEventListener('click', async () => {
        if (currentExperience && currentExperience.analysis) {
            journalData.step10.experiences.push(currentExperience);
            await saveData();
            await grantXp(50);
            renderExperienceCards();
            modal.classList.add('hidden');
        }
    });
    
    const checkConnectorState = () => {
        const connectorSection = div.querySelector('#connector-section');
        const experiencesDone = journalData.step10.experiences && journalData.step10.experiences.length > 0;
        const detectorDone = journalData.step10.soft_skills_profile && journalData.step10.soft_skills_profile.trim() !== '';
        if (experiencesDone && detectorDone) {
            connectorSection.classList.remove('hidden');
        } else {
            connectorSection.classList.add('hidden');
        }
    };

    div.querySelector('#connect-skills-btn').addEventListener('click', async () => {
        const loader = div.querySelector('#loader-connector');
        const resultTextarea = div.querySelector('#skills-synthesis');
        loader.style.display = 'block';
        resultTextarea.value = '';
        const experienceSummaries = journalData.step10.experiences.map(exp => exp.analysis).join('\n- ');
        const profileAnalysis = journalData.step10.soft_skills_profile;
        const prompt = `Agis comme un coach carrière expert. Voici le profil et les expériences d'un élève :
        **Profil de savoir-être :** ${profileAnalysis}
        **Expériences concrètes :** - ${experienceSummaries}
        Ta mission est de rédiger une synthèse (2-3 paragraphes) qui connecte ces deux aspects. Montre comment ses savoir-être se manifestent dans ses savoir-faire. Utilise des phrases comme "Ta compétence en [savoir-être] se voit clairement lorsque tu as..." pour créer des ponts. Le but est de l'aider à formuler un discours cohérent sur ses atouts. Adresse-toi directement à lui.`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});
        loader.style.display = 'none';
        resultTextarea.value = result;
        journalData.step10.skills_synthesis = result;
        await saveData();
        await grantXp(75);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        checkBadges();
        await saveData();
        showView('menu');
    });

    renderExperienceCards();
    checkConnectorState();

    return div;
}


function createOrientationMapView(data, context = 'user') {
    const profileTitle = context === 'user' ? 'Mon Profil' : 'Son Profil';
    let mapHTML = '<div class="mb-8"><h2 class="text-xl font-bold text-OrIAntation-darkblue text-center mb-4">🗺️ Carte d\'Orientation Personnelle</h2>';
    mapHTML += '<div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">';

    const archetype = data.step0 ? data.step0.archetype : null;
    const clickableClasses = 'map-card-clickable cursor-pointer hover:shadow-lg transition-shadow duration-200';

    // --- Bloc "Mon Profil" ---
    if (archetype && archetype.titre) {
        let oneSentenceDescription = archetype.description; // On prend la description par défaut

        // On vérifie si la description contient un point
        if (archetype.description.includes('.')) {
            // On coupe la chaîne au premier point et on garde la première partie, puis on rajoute un point.
            oneSentenceDescription = archetype.description.split('.')[0] + '.';
        }

        mapHTML += `
            <div class="lg:col-span-1 bg-cyan-50 p-4 rounded-lg border border-cyan-200 text-center">
                <h3 class="font-bold text-cyan-800">👤 ${profileTitle}</h3>
                <div class="mt-2">
                    <span class="text-4xl">${archetype.icone}</span>
                    <p class="font-semibold text-OrIAntation-darkblue mt-1">${archetype.titre}</p>
                    
                    <p class="text-sm text-slate-600 mt-2">${oneSentenceDescription}</p>
                </div>
            </div>`;
    } else {
        mapHTML += `
            <div class="lg:col-span-1 bg-background-light p-4 rounded-lg border text-center">
                <h3 class="font-bold text-slate-500">👤 ${profileTitle}</h3>
                <p class="text-sm text-slate-500 mt-2">Complète l'étape "Mieux se connaître" pour révéler ton profil.</p>
            </div>`;
    }

    // --- Autres blocs de la carte (restent cliquables) ---
    mapHTML += '<div class="lg:col-span-2 space-y-4">';
    
    const metiers = [data.step1?.metier1, data.step1?.metier2, data.step1?.metier3].filter(m => m && m.trim() !== '');
    if (metiers.length > 0) {
        mapHTML += `<div data-target="journal-section-step1" class="${clickableClasses} bg-sky-50 p-3 rounded-lg border border-sky-200">
                        <h4 class="font-semibold text-sky-800">📚 Métiers explorés</h4>
                        <p class="text-sm text-slate-600">${metiers.join(', ')}</p>
                    </div>`;
    }

    const formations = [data.step3?.formation1, data.step3?.formation2].filter(f => f && f.trim() !== '');
    if (formations.length > 0) {
        mapHTML += `<div data-target="journal-section-step3" class="${clickableClasses} bg-lime-50 p-3 rounded-lg border border-lime-200">
                        <h4 class="font-semibold text-lime-800">🎓 Formations envisagées</h4>
                        <p class="text-sm text-slate-600">${formations.join(', ')}</p>
                    </div>`;
    }

    if (data.step10 && data.step10.experiences && data.step10.experiences.length > 0) {
        mapHTML += `<div data-target="journal-section-step10" class="${clickableClasses} bg-amber-50 p-3 rounded-lg border border-amber-200">
                        <h4 class="font-semibold text-amber-800">💼 Compétences identifiées</h4>
                        <p class="text-sm text-slate-600">À travers ${data.step10.experiences.length} expérience(s) valorisée(s).</p>
                    </div>`;
    }
    
    mapHTML += '</div>';
    mapHTML += '</div></div>';
    
    return mapHTML;
}

function createStep11View() {
    const config = stepsConfig.step11;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    form.querySelector('button[type="submit"]').remove();

    form.innerHTML += `
        <div class="text-center mb-4">
            <button type="button" id="openaiBtn_local" class="w-full sm:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">🌍 Lancer la recherche locale</button>
        </div>
        <div id="openaiLoader_local" class="hidden"><div class="loader"></div></div>
        <div id="results-container" class="mt-8"></div>
        <hr class="my-12 border-slate-300">
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Préparer mes visites</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">Préparer une JPO</h3>
                <input type="text" id="jpo_ecole" name="jpo_ecole" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Nom de l'école ou formation" value="${journalData.step11.jpo_ecole || ''}">
                <button type="button" id="openaiBtn_jpo" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">💡 Générer des questions</button>
                <div id="openaiLoader_jpo" class="hidden"><div class="loader"></div></div>
                <textarea id="jpo_questions" name="jpo_questions" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly>${journalData.step11.jpo_questions || ''}</textarea>
            </div>
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">Préparer une visite de Salon</h3>
                <input type="text" id="salon_nom" name="salon_nom" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Nom du salon (ex: Salon de l'Étudiant)" value="${journalData.step11.salon_nom || ''}">
                <button type="button" id="openaiBtn_salon" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">🎯 Préparer ma visite</button>
                <div id="openaiLoader_salon" class="hidden"><div class="loader"></div></div>
                <textarea id="salon_preparation" name="salon_preparation" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly>${journalData.step11.salon_preparation || ''}</textarea>
            </div>
        </div>
    `;

    const locationInput = div.querySelector('#location');
    const searchBtn = div.querySelector('#openaiBtn_local');
    const jpoBtn = div.querySelector('#openaiBtn_jpo');
    const salonBtn = div.querySelector('#openaiBtn_salon');
    const resultsContainer = div.querySelector('#results-container');

    const renderResults = (data) => {
        let html = '';
        const allTasks = (journalData.retroplanning?.tasks || []).flatMap(month => month.tasks.map(task => task.text));

        if (data.evenements && Array.isArray(data.evenements) && data.evenements.length > 0) {
            html += '<h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">🗓️ Événements à ne pas manquer</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            data.evenements.forEach((event, index) => {
                const dateInputId = `event-date-${index}`;
                const isAlreadyInRetroplanning = allTasks.some(taskText => taskText.includes(event.nom));
            const buttonText = isAlreadyInRetroplanning ? 'Déjà au planning ✔' : '+ Rétroplanning';
            const buttonClasses = isAlreadyInRetroplanning ? 'bg-green-100 text-green-800 cursor-not-allowed' : 'bg-orange-100 text-orange-800 font-semibold hover:bg-orange-200 transition';
            const buttonDisabled = isAlreadyInRetroplanning ? 'disabled' : '';

            const retroBtn = `<button type="button" class="add-to-retro-btn text-xs py-1 px-2 rounded-lg whitespace-nowrap ${buttonClasses}" data-nom="${event.nom}" data-input-id="${dateInputId}" ${buttonDisabled}>${buttonText}</button>`;
                            const searchQuery = `${event.nom} ${event.lieu || ''}`;
                const eventUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
                html += `
                    <div class="bg-white p-4 rounded-lg shadow border border-border-subtle flex flex-col h-full">
                        <h3 class="font-bold text-cyan-700">${event.nom}</h3>
                        <label for="${dateInputId}" class="text-slate-600 text-sm font-medium mt-2">Date (modifiable) :</label>
                        <input type="date" id="${dateInputId}" value="${event.date || ''}" class="w-full border-slate-300 border rounded-md p-1 mt-1 text-sm">
                        <p class="text-slate-500 text-sm mt-2">${event.lieu}</p>
                        <div class="mt-auto pt-2 flex flex-col items-center gap-2">
                            <a href="${eventUrl}" target="_blank" class="text-primary-action hover:underline text-sm font-semibold">Vérifier la date ↗</a>
                            ${retroBtn}
                        </div>
                    </div>`;
            });
            html += '</div>';
        }
        if (data.structures && Array.isArray(data.structures) && data.structures.length > 0) {
            html += '<h2 class="text-2xl font-bold text-OrIAntation-darkblue mt-8 mb-4">🏢 Structures pour t\'accompagner</h2>';
            html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            data.structures.forEach(struct => {
                const searchQuery = `${struct.nom}, ${struct.adresse}`;
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(searchQuery)}`;
                const mapsLink = `<a href="${mapsUrl}" target="_blank" class="text-primary-action hover:underline text-sm font-semibold mt-2 inline-block">Voir sur la carte ↗</a>`;
                html += `<div class="bg-white p-4 rounded-lg shadow border border-border-subtle"><h3 class="font-bold text-cyan-700">${struct.nom}</h3><p class="text-slate-600 text-sm">${struct.adresse}</p><p class="text-slate-500 text-sm">${struct.telephone || ''}</p>${mapsLink}</div>`;
            });
            html += '</div>';
        }
        resultsContainer.innerHTML = html;
    };
    
    if (journalData.step11 && (journalData.step11.evenements || journalData.step11.structures)) {
        renderResults(journalData.step11);
    }

    searchBtn.addEventListener('click', async () => {
    const location = locationInput.value.trim();
    if (!location) {
        showInfoModal("Veuillez indiquer une ville ou un département.");
        return;
    }
    const loader = div.querySelector('#openaiLoader_local');
    loader.style.display = 'block';
    resultsContainer.innerHTML = '';
    const today = new Date();
    const academicYear = today.getMonth() >= 7 ? `${today.getFullYear()}-${today.getFullYear() + 1}` : `${today.getFullYear() - 1}-${today.getFullYear()}`;

    // NOUVEAU : On récupère les événements déjà planifiés pour les exclure
    const existingEvents = (journalData.retroplanning?.tasks || [])
        .flatMap(month => month.tasks.map(task => task.text))
        .filter(text => text.includes('Participer à :'))
        .join(', ');

    const prompt = `Agis comme un documentaliste expert en orientation pour un lycéen à "${location}".
    Ta mission est de trouver des informations locales pertinentes pour l'année scolaire ${academicYear}.

    **Règle d'exclusion TRÈS IMPORTANTE :** L'élève a déjà les événements suivants dans son planning. Tu ne dois PAS les proposer à nouveau dans ta réponse.
    Liste des événements à exclure : "${existingEvents || 'Aucun'}".

    **Ta réponse doit être UNIQUEMENT un objet JSON valide.**
    Le JSON doit contenir 6 "evenements" et 6 "structures".
    Pour "evenements": trouve des salons et JPO dans un rayon de 80km, pour les 4 prochains mois. Fournis "nom", "lieu", et "date" (AAAA-MM-JJ).
    Pour "structures": trouve les CIO/Missions Locales les plus proches. Fournis "nom", "adresse", "telephone".
    `;

    const result = await callOpenAI_API({ promptText: prompt, isJson: true });
        loader.style.display = 'none';

        try {
            const data = extractJsonFromString(result);
            if (!data) {
                 throw new Error("La réponse de OrIA est vide ou invalide.");
            }
            // === ON SAUVEGARDE À NOUVEAU LES DEUX TYPES DE DONNÉES ===
            journalData.step11.evenements = data.evenements || [];
            journalData.step11.structures = data.structures || []; 
            await saveData();
            renderResults(data);
        } catch (error) {
            console.error("Erreur d'analyse ou de traitement de la réponse IA:", error);
            resultsContainer.innerHTML = `<p class="text-red-500 text-center">Désolé, une erreur est survenue. OrIA n'a pas renvoyé de format exploitable.</p><textarea class="w-full h-40 bg-slate-100 p-2 rounded mt-2" readonly>${result}</textarea>`;
        }
    });
    
jpoBtn.addEventListener('click', async () => {
    const ecoleInput = div.querySelector('#jpo_ecole');
    const ecole = ecoleInput.value.trim();
    if (!ecole) {
        showInfoModal("Veuillez indiquer le nom de l'école ou de la formation.");
        return;
    }
    const loader = div.querySelector('#openaiLoader_jpo');
    const resultDiv = div.querySelector('#jpo_questions');
    loader.style.display = 'block';
    resultDiv.value = '';

    const prompt = `Agis comme un coach d'orientation. Un élève prépare sa visite aux journées portes ouvertes pour la formation/l'école : "${ecole}". 
    Son profil est : ${getProfileSummary()}.
    Génère une liste de 5 à 6 questions pertinentes et stratégiques à poser aux étudiants et enseignants sur place. Personnalise une ou deux questions pour qu'elles soient spécifiquement liées au profil de l'élève. Le résultat doit être une liste directement utilisable.`;

    const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
    
    loader.style.display = 'none';
    resultDiv.value = result;
    journalData.step11.jpo_ecole = ecole;
    journalData.step11.jpo_questions = result;
    await saveData();
    
});   

// ▼▼▼ AJOUTEZ CE BLOC POUR LE BOUTON SALON ▼▼▼

salonBtn.addEventListener('click', async () => {
    const salonInput = div.querySelector('#salon_nom');
    const salon = salonInput.value.trim();
    if (!salon) {
        showInfoModal("Veuillez indiquer le nom du salon.");
        return;
    }
    const loader = div.querySelector('#openaiLoader_salon');
    const resultDiv = div.querySelector('#salon_preparation');
    loader.style.display = 'block';
    resultDiv.value = '';

    const prompt = `Agis comme un coach d'orientation. Un élève prépare sa visite pour le salon suivant : "${salon}".
    Son profil est : ${getProfileSummary()}.
    Génère un mini "plan d'action" en 3 points pour l'aider à optimiser sa visite :
    1.  **Objectif principal :** Un conseil pour définir un objectif clair en lien avec son profil.
    2.  **Stands à ne pas manquer :** Suggère 3 types de stands ou de conférences à visiter en priorité.
    3.  **La question qui fait la différence :** Propose une question ouverte et intelligente à poser aux intervenants pour obtenir des informations précieuses.`;

    const result = await callOpenAI_API({ promptText: prompt, withPersona: true });

    loader.style.display = 'none';
    resultDiv.value = result;
    journalData.step11.salon_nom = salon;
    journalData.step11.salon_preparation = result;
    await saveData();
});    
    // ▼▼▼ REMPLACEZ L'ÉVÉNEMENT DU CLIC DANS createStep11View PAR CE BLOC ▼▼▼

div.addEventListener('click', async (e) => {
    if (e.target.matches('.add-to-retro-btn')) {
        const button = e.target;
        const eventName = button.dataset.nom;
        const inputId = button.dataset.inputId;
        const dateInput = document.getElementById(inputId);
        const eventDate = dateInput.value;

        if (!eventDate) {
            showInfoModal("Veuillez entrer une date valide avant d'ajouter l'événement au rétroplanning.");
            return;
        }
        if (!journalData.retroplanning || !Array.isArray(journalData.retroplanning.tasks)) {
            showInfoModal("Veuillez d'abord générer un Rétroplanning.");
            return;
        }

        // --- DÉBUT DE LA LOGIQUE DE FORMATAGE CORRIGÉE ---
        const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
        const dateObj = new Date(eventDate);
        const adjustedDate = new Date(dateObj.getTime() + Math.abs(dateObj.getTimezoneOffset() * 60000));
        
        const monthIndex = adjustedDate.getMonth();
        const monthName = monthNames[monthIndex];
        const formattedDate = ` (${String(adjustedDate.getDate()).padStart(2, '0')}/${String(monthIndex + 1).padStart(2, '0')})`;
        // --- FIN DE LA LOGIQUE DE FORMATAGE ---
        
        let monthObject = journalData.retroplanning.tasks.find(m => m.month === monthName);
        if (!monthObject) {
            monthObject = { month: monthName, tasks: [] };
            journalData.retroplanning.tasks.push(monthObject);
            journalData.retroplanning.tasks.sort((a, b) => monthNames.indexOf(a.month.toLowerCase()) - monthNames.indexOf(b.month.toLowerCase()));
        }

        const newTaskText = `Participer à : ${eventName}${formattedDate}`; // On ajoute la date formatée ici
        
        if (!monthObject.tasks.some(task => task.text === newTaskText)) {
            monthObject.tasks.push({ text: newTaskText, completed: false });
            await saveData();
            button.textContent = 'Ajouté ✔';
            button.disabled = true;
            button.classList.remove('bg-orange-100', 'hover:bg-orange-200');
            button.classList.add('bg-green-100', 'text-green-800');
        } else {
            showInfoModal("Cet événement est déjà dans votre Rétroplanning !");
            button.textContent = 'Déjà ajouté';
            button.disabled = true;
        }
    }
});

    return div;
}

  function createRetroplanningView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

        const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];

    // --- ÉTAPE 1 : La "Source de Vérité" - Les plannings par niveau sont inscrits en dur dans le code ---
    const retroplanningData = {
        seconde: [
            // ... (pas de changement pour la Seconde)
            { month: "Septembre", tasks: ["Prendre ses marques au lycée, identifier ses points forts et ses difficultés.", "Utiliser l'étape 'Mieux se connaître' pour faire un premier point sur son profil."] },
            { month: "Octobre", tasks: ["Participer aux semaines de l'orientation si organisées par le lycée.", "Explorer 2 ou 3 secteurs d'activité via l'étape 'Les Fondations'."] },
            { month: "Novembre", tasks: ["Préparer le premier conseil de classe : faire un bilan de ses résultats.", "Commencer à manipuler 'Le simulateur de spécialités' pour voir les possibilités."] },
            { month: "Décembre", tasks: ["Analyser son premier bulletin et définir des axes d'amélioration.", "Discuter de ses premières explorations avec ses proches et son professeur principal."] },
            { month: "Janvier", tasks: ["Début de la phase de dialogue sur l'orientation : prendre connaissance de la 'fiche dialogue'.", "Utiliser 'Rencontres sur mon Territoire' pour repérer les Journées Portes Ouvertes (JPO) à venir."] },
            { month: "Février", tasks: ["Participer à des JPO ou des salons pour se faire une idée concrète des formations.", "Explorer les formations post-bac liées aux spécialités envisagées avec 'Le Catalogue'."] },
            { month: "Mars", tasks: ["Remplir la fiche de dialogue avec ses vœux provisoires de spécialités.", "Utiliser 'L'Expérience' pour préparer des questions à poser à des étudiants ou des professionnels."] },
            { month: "Avril", tasks: ["Confirmer ses choix et préparer les arguments pour le conseil de classe du 3ème trimestre.", "Commencer activement la recherche d'un lieu pour le stage d'observation."] },
            { month: "Mai", tasks: ["Le conseil de classe formule un avis sur les vœux de spécialités.", "Finaliser l'organisation de son stage avec l'étape 'Passer à l'action'."] },
            { month: "Juin", tasks: ["Effectuer son stage d'observation obligatoire de deux semaines.", "Commencer la rédaction du rapport de stage et le valoriser dans 'Mon Portfolio de Compétences'."] },
            { month: "Juillet", tasks: ["Faire le bilan de son année, de son stage et des choix validés.", "Se reposer !"] }
        ],
        premiere: [
            // ... (pas de changement pour la Première)
            { month: "Septembre", tasks: ["Consolider les méthodes de travail dans ses 3 spécialités.", "Approfondir sa connaissance de 2 métiers précis avec l'étape 'Les Fondations'."] },
            { month: "Octobre", tasks: ["Préparer les premières évaluations comptant pour le baccalauréat.", "Utiliser 'Le Catalogue' pour lier ses spécialités à des formations post-bac précises."] },
            { month: "Novembre", tasks: ["Travailler la méthodologie des épreuves anticipées de Français (dissertation, commentaire).", "Utiliser 'Fact Checking' pour déconstruire les idées reçues sur les filières visées."] },
            { month: "Décembre", tasks: ["Faire le bilan du premier trimestre et identifier la spécialité la moins investie.", "Commencer à valoriser ses projets et expériences dans 'Mon Portfolio de Compétences'."] },
            { month: "Janvier", tasks: ["Participer aux JPO et salons avec des questions ciblées.", "Remplir la fiche de dialogue pour le choix de la spécialité de Terminale."] },
            { month: "Février", tasks: ["Décider de la spécialité qui sera abandonnée en Terminale.", "Simuler l'impact de ce choix avec 'Le simulateur de spécialités' pour confirmer."] },
            { month: "Mars", tasks: ["Débuter les révisions intensives pour les épreuves anticipées de Français.", "Utiliser 'Passer à l'action' pour planifier des rencontres avec des professionnels."] },
            { month: "Avril", tasks: ["S'entraîner pour l'oral de français (préparation des textes).", "Utiliser le 'Simulateur Vie Étudiante' pour se projeter financièrement dans différentes villes."] },
            { month: "Mai", tasks: ["Finaliser les révisions du bac de Français.", "Faire le point sur l'avancement de son projet d'orientation avant la Terminale."] },
            { month: "Juin", tasks: ["Passer les épreuves anticipées de Français (écrit et oral).", "Réfléchir aux thèmes possibles pour le Grand Oral de Terminale."] },
            { month: "Juillet", tasks: ["Faire le bilan de l'année et préparer sa rentrée en Terminale.", "Se reposer !"] }
        ],
        terminale: [
            // --- VERSION CORRIGÉE POUR LA TERMINALE ---
            { month: "Septembre", tasks: ["Se familiariser avec le calendrier Parcoursup de l'année.", "Finaliser sa liste de formations cibles avec 'Le Catalogue'."] },
            { month: "Octobre", tasks: ["Participer aux salons d'orientation pour confirmer ses choix.", "Utiliser 'Mon Portfolio de Compétences' pour rassembler tous les éléments à valoriser."] },
            { month: "Novembre", tasks: ["Commencer la rédaction des brouillons pour la rubrique 'Activités et centres d'intérêt' de Parcoursup.", "Utiliser 'Préparer sa candidature' pour structurer ses premiers projets de formation motivés."] },
            { month: "Décembre", tasks: ["Profiter des vacances pour avancer sur la rédaction des projets motivés.", "Faire le bilan du premier trimestre et valider ses choix de spécialités pour le bac."] },
            { month: "Janvier", tasks: ["Ouverture de la plateforme Parcoursup : s'inscrire et commencer à formuler ses vœux.", "Choisir ses deux questions pour le Grand Oral et commencer les recherches."] },
            { month: "Février", tasks: ["Poursuivre la saisie des vœux et la rédaction des projets motivés.", "Se préparer pour les dernières évaluations comptant pour le contrôle continu."] },
            // MODIFIÉ
            { month: "Mars", tasks: ["Date limite pour formuler ses vœux sur Parcoursup (mi-mars).", "Commencer à organiser ses fiches de révision pour les épreuves finales."] },
            { month: "Avril", tasks: ["Date limite pour finaliser son dossier et confirmer chaque vœu sur Parcoursup (début avril).", "Utiliser l'étape 'Anticiper la suite' pour préparer un plan B en cas de réponses négatives."] },
            // MODIFIÉ
            { month: "Mai", tasks: ["Intensifier les révisions finales : Philosophie, Grand Oral ET les deux épreuves de spécialité.", "Début de la phase d'admission principale de Parcoursup (fin mai) : réception des réponses."] },
            // MODIFIÉ
            { month: "Juin", tasks: ["Passer les épreuves finales : Philosophie, Grand Oral et les deux épreuves de spécialité.", "Gérer les réponses de Parcoursup et la phase d'admission complémentaire si besoin."] },
            { month: "Juillet", tasks: ["Répondre définitivement à la dernière proposition d'admission et s'inscrire administrativement.", "Fêter l'obtention du baccalauréat !"] }
        ]
    };

    // --- ÉTAPE 2 : Le HTML de la page, simple et structuré ---
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 text-OrIAntation-darkblue mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg>
            <span>Mon Rétroplanning</span>
        </h1>
        <div class="text-slate-600 mb-4 space-y-2">
            <p>Pour ton orientation, un bon planning est essentiel ! Cet outil part des grandes échéances de ton année et te propose un plan d'action mois par mois pour y arriver sans stress.</p>
        </div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><p class="font-semibold text-cyan-900"><b>Ta mission :</b> Clique sur le bouton pour obtenir ton planning et tes conseils personnalisés. Coche ensuite les cases au fur et à mesure de ton avancée !</p></div>
        <div class="text-center mb-6">
            <button type="button" id="openaiBtn_retro" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">📅 Générer / Mettre à jour mon Rétroplanning</button>
        </div>
        <div class="my-8 p-4 bg-background-light border border-border-subtle rounded-lg">
             <h3 class="font-bold text-OrIAntation-darkblue mb-3">Ajouter un événement personnalisé</h3>
             <div class="flex flex-col sm:flex-row gap-2">
                 <input type="text" id="custom-event-text" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Description (ex: JPO du Lycée X)">
                 <input type="date" id="custom-event-date" class="p-2 border border-slate-300 rounded-lg">
                 <button type="button" id="add-custom-event-btn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition whitespace-nowrap">Ajouter</button>
             </div>
        </div>
        <div id="openaiLoader_retro" class="hidden"><div class="loader"></div></div>
        <div id="retroplanning-content"></div>
    `;

    const retroplanningContent = div.querySelector('#retroplanning-content');
    const retroForm = div.querySelector('#retroForm');
    
    const renderTimeline = () => {
        if (!journalData.retroplanning || !journalData.retroplanning.tasks || journalData.retroplanning.tasks.length === 0) {
            retroplanningContent.innerHTML = `<p ...>Cliquez sur "Générer"...</p>`;
            return;
        }
        let isAlreadySaved = false;
    const currentConseils = journalData.retroplanning.rawText;
    if (currentConseils && (journalData.retroplanning_saves?.length ?? 0) > 0) {
        const currentConseilsString = JSON.stringify(currentConseils);
        isAlreadySaved = journalData.retroplanning_saves.some(savedItem => 
            JSON.stringify(savedItem.conseils) === currentConseilsString
        );
    }

        let timelineHTML = journalData.retroplanning.tasks.map((monthData, monthIndex) => {
        const tasksHTML = monthData.tasks.map((task, taskIndex) => `
            <li class="flex items-start mb-2">
                <input type="checkbox" id="task-${monthIndex}-${taskIndex}" class="mt-1 h-4 w-4 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500" ${task.completed ? 'checked' : ''}>
                <label for="task-${monthIndex}-${taskIndex}" class="ml-3 text-slate-700 ${task.completed ? 'line-through text-slate-400' : ''}">${task.text}</label>
            </li>
        `).join('');
        return `<div class="mb-6"><h3 class="font-bold text-cyan-700 text-lg mb-2">${monthData.month}</h3><ul class="list-none pl-0">${tasksHTML}</ul></div>`;
    }).join('');

        let conseilHTML = '';
    const conseils = journalData.retroplanning.rawText;
    if (conseils && typeof conseils === 'object') {
        for (const key in conseils) {
            if (Object.prototype.hasOwnProperty.call(conseils, key)) {
                const value = conseils[key];
                const title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                conseilHTML += `<h4 class="font-bold text-OrIAntation-darkblue mt-4 mb-2">${title}</h4><p class="whitespace-pre-wrap text-slate-600 text-sm">${value}</p>`;
            }
        }
    }
    
    // ✅ NOUVELLE LOGIQUE D'AFFICHAGE AVEC LE BOUTON D'ENREGISTREMENT
    retroplanningContent.innerHTML = `
        <div>
            <h2 class="text-2xl font-bold text-center mb-6 text-OrIAntation-darkblue">Ta Feuille de Route</h2>
            ${timelineHTML}
            <div class="mt-8 bg-background-light p-6 rounded-lg border border-border-subtle">
                <h3 class="text-xl font-bold text-center text-OrIAntation-darkblue mb-2">Les conseils détaillés d'OrIA :</h3>
                <div id="conseils-content">${conseilHTML}</div>
                <div class="text-center mt-6">
                    <button type="button" id="save-conseils-btn" class="text-white font-semibold py-2 px-4 rounded-lg transition ${isAlreadySaved ? 'bg-gray-400 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700'}" ${isAlreadySaved ? 'disabled' : ''}>
                        ${isAlreadySaved ? 'Enregistré ✔' : 'Enregistrer ces conseils dans le journal'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // On ajoute l'écouteur pour le nouveau bouton
    const saveConseilsBtn = retroplanningContent.querySelector('#save-conseils-btn');
    if (saveConseilsBtn) {
        saveConseilsBtn.addEventListener('click', async () => {
            if (!journalData.retroplanning_saves) {
                journalData.retroplanning_saves = [];
            }
            journalData.retroplanning_saves.push({
                date: new Date().toISOString().split('T')[0],
                conseils: journalData.retroplanning.rawText
            });
            await saveData();
            saveConseilsBtn.textContent = 'Enregistré ! ✔';
            saveConseilsBtn.disabled = true;

            const tutorialShown = await handleOnboarding({ from: 'retroplanning_save' });
                // Si le tutoriel est terminé, on propose de retourner au menu
                if (!tutorialShown) {
                    const goBackBtn = document.createElement('button');
                    goBackBtn.className = 'w-full mt-4 bg-slate-200 text-OrIAntation-darkblue font-semibold py-3 px-6 rounded-lg hover:bg-slate-300 transition';
                    goBackBtn.textContent = 'Retourner au menu';
                    goBackBtn.onclick = () => showView('menu');
                    retroplanningContent.appendChild(goBackBtn);
                }
            });
        }
    

    // Le reste de la logique (checkboxes et formulaire) ne change pas
    retroplanningContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            // ...
        });
    });
};

    // ▼▼▼ REMPLACEZ L'ÉVÉNEMENT DU BOUTON '#add-custom-event-btn' PAR CE BLOC ▼▼▼

div.querySelector('#add-custom-event-btn').addEventListener('click', async () => {
    const textInput = div.querySelector('#custom-event-text');
    const dateInput = div.querySelector('#custom-event-date');
    const eventText = textInput.value.trim();
    const eventDate = dateInput.value;

    if (!eventText || !eventDate) {
        showInfoModal("Veuillez renseigner une description ET une date.");
        return;
    }
    if (!journalData.retroplanning || !Array.isArray(journalData.retroplanning.tasks)) {
        showInfoModal("Veuillez d'abord générer un Rétroplanning.");
        return;
    }

    const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
    
    // Correction pour éviter les problèmes de fuseau horaire qui peuvent changer le jour
    const dateObj = new Date(eventDate);
    const adjustedDate = new Date(dateObj.getTime() + Math.abs(dateObj.getTimezoneOffset()*60000));
    
    const monthIndex = adjustedDate.getMonth();
    const monthName = monthNames[monthIndex];
    
    // On formate la date pour l'afficher à côté du texte (ex: " (02/10)")
    const formattedDate = ` (${String(adjustedDate.getDate()).padStart(2, '0')}/${String(monthIndex + 1).padStart(2, '0')})`;
    
    let monthObject = journalData.retroplanning.tasks.find(m => m.month === monthName);
    if (!monthObject) {
        monthObject = { month: monthName, tasks: [] };
        journalData.retroplanning.tasks.push(monthObject);
        // On s'assure que les mois restent dans le bon ordre
        journalData.retroplanning.tasks.sort((a, b) => monthNames.indexOf(a.month) - monthNames.indexOf(b.month));
    }
    
    // On ajoute la tâche AVEC sa date formatée
    monthObject.tasks.push({ text: eventText + formattedDate, completed: false });
    
    textInput.value = '';
    dateInput.value = '';
    
    // On sauvegarde les modifications
    await saveData();
    
    // On rafraîchit l'affichage
    renderTimeline();
});

    div.querySelector('#openaiBtn_retro').addEventListener('click', async () => {
    if (!userGradeLevel) {
        showInfoModal("Les données de votre profil sont en cours de chargement.");
        return;
    }
    
    // Message d'attente (inchangé)
    retroplanningContent.innerHTML = `
        <div class="text-center p-4">
            <div class="loader"></div>
            <p class="text-slate-500 font-semibold mt-2">OrIA est en train de construire ta feuille de route personnalisée...</p>
            <p class="text-sm text-slate-400 mt-1">Cette opération peut prendre jusqu'à une minute.</p>
        </div>
    `;
    
    const masterTasks = retroplanningData[userGradeLevel];
    const profileSummary = getProfileSummary();
    const appFeaturesSummary = getAppFeaturesSummary();

    // ✅ ÉTAPE 1 : On définit les "micro-missions" à accomplir selon la classe
    let missions = {};
    switch(userGradeLevel) {
        case 'seconde':
            missions = {
                conseilGeneral: "- Pour 'conseilGeneral': donne un conseil sur l'organisation et la méthode de travail.",
                conseilSpecialites: "- Pour 'conseilSpecialites': donne un conseil sur l'exploration des futures spécialités."
            };
            break;
        case 'premiere':
            missions = {
                conseilGeneralOrientation: "- Pour 'conseilGeneralOrientation': donne un conseil stratégique pour l'année de Première.",
                conseilAbandonSpecialite: "- Pour 'conseilAbandonSpecialite': donne une méthode pour aider à décider quelle spécialité abandonner.",
                conseilReussiteEpreuves: "- Pour 'conseilReussiteEpreuves': donne des conseils pour le bac de Français et la nouvele épreuve de mathématiques."
            };
            break;
        case 'terminale':
            missions = {
                conseilParcoursup: "- Pour 'conseilParcoursup': donne une stratégie pour les vœux et le projet motivé.",
                conseilSpecialites: "- Pour 'conseilSpecialites': donne une méthode de révision pour les épreuves finales du bac.",
                conseilPhilosophie: "- Pour 'conseilPhilosophie': insiste sur la structure de l'argumentation.",
                conseilGrandOral: "- Pour 'conseilGrandOral': insiste sur le choix du sujet et l'entraînement."
            };
            break;
    }

    // ✅ ÉTAPE 2 : On crée une fonction qui génère un prompt ciblé pour UNE SEULE mission
    const createMicroPrompt = (instruction) => {
        return `
            Agis comme un coach d'orientation stratégique et concis.
            Le profil de l'élève est : "${profileSummary}".
            # Contexte de l'Application
            Tes suggestions doivent utiliser les fonctionnalités décrites ci-dessous. N'en invente aucune.
            ${appFeaturesSummary}
            # Ta Mission
            Ta seule mission est de répondre à cette instruction :
            ${instruction}
            # Format de Sortie
            Ta réponse doit être un unique paragraphe de texte clair et actionnable. Ne retourne PAS de JSON, juste le texte du conseil.
        `;
    };

    try {
        // ✅ ÉTAPE 3 : On crée un tableau de promesses (une pour chaque mission)
        const promises = Object.entries(missions).map(([key, instruction]) => {
            const microPrompt = createMicroPrompt(instruction);
            // On retourne la promesse de l'appel API
return callOpenAI_API({
        promptText: microPrompt,
        model: 'gpt-4o',      //
        withPersona: true    // On n'oublie pas d'activer le persona
    }).then(result => ({ key, result }));
});
        // ✅ ÉTAPE 4 : On lance toutes les missions en parallèle !
        const resultsArray = await Promise.all(promises);

        // ✅ ÉTAPE 5 : On rassemble les résultats dans un seul objet JSON
        const conseilsResult = resultsArray.reduce((acc, { key, result }) => {
            acc[key] = result;
            return acc;
        }, {});

        if (!conseilsResult) throw new Error("OrIA n'a pas pu générer les conseils détaillés.");

        // Le reste de la logique est inchangé
        journalData.retroplanning = {
            tasks: masterTasks.map(month => ({ ...month, tasks: month.tasks.map(taskText => ({ text: taskText, completed: false })) })),
            rawText: conseilsResult
        };
        
        await saveData({ skipOnboarding: true });
        renderTimeline();
        await grantXp(50);

    } catch (e) {
        console.error("Erreur lors de la génération des conseils:", e);
        retroplanningContent.innerHTML = `<p class="text-center text-red-500">Désolé, une erreur est survenue lors de la génération des conseils. Veuillez réessayer.</p>`;
    }
});

    renderTimeline();
    
    return div;
}

async function createJournalView() {
    // Cette fonction appelle simplement la nouvelle fonction unifiée avec les données de l'élève connecté
    return createUnifiedJournalView(currentUserInfo, journalData, 'student');
}


// =================================================================================
// FONCTION UNIFIÉE FINALE ET COMPLÈTE POUR L'AFFICHAGE DU JOURNAL
// =================================================================================
async function createUnifiedJournalView(userInfo, journalDataToDisplay, context) {
    // 1. Création du conteneur principal de la page
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // ---- On utilise temporairement les données passées en paramètres ----
    const originalJournalData = journalData;
    const originalUserGradeLevel = userGradeLevel;
    journalData = journalDataToDisplay;
    userGradeLevel = userInfo.gradeLevel;

    // ---- Construction de l'HTML ----
    const progressBarHTML = createProgressBarHTML();
    const headerEl = document.createElement('div');
    headerEl.innerHTML = `
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg>
                <span>Journal de Bord</span>
            </h1>
            <p class="text-slate-500">Pour ${userInfo.firstName} ${context === 'student' ? (userInfo.lastName || '') : ''}, élève de ${userInfo.gradeLevel}.</p>
        </div>
    `;
    div.appendChild(headerEl);
    div.innerHTML += progressBarHTML;

    if (context === 'student') {
        const shareToken = journalDataToDisplay.share_token || null;
        const shareLink = shareToken ? `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${shareToken}` : '';
        const sharePanelEl = document.createElement('div');
        sharePanelEl.innerHTML = `
            <div class="bg-background-light p-4 rounded-lg border border-border-subtle my-8">
                <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-2 flex items-center justify-center gap-2">🤝 Espace Partage</h2>
                <p class="text-slate-600 text-sm mb-4">Partage une version "lecture seule" de ton journal avec tes parents ou ton professeur principal pour faciliter la discussion.</p>
                <div id="share-link-container" class="${shareToken ? '' : 'hidden'}">
                    <label class="font-semibold text-slate-700">Ton lien de partage unique :</label>
                    <div class="flex items-center gap-2 mt-1 bg-slate-100 border rounded-lg p-2 pl-4"><span class="text-sm truncate flex-1">${shareLink}</span><button id="copy-share-link" class="bg-cyan-600 text-white font-semibold py-1 px-3 rounded-md text-sm">Copier</button></div>
                </div>
                <div class="mt-4 text-center"><button id="toggle-share-btn" class="text-sm font-semibold ${shareToken ? 'text-red-600' : 'text-green-600'}">${shareToken ? '❌ Désactiver le partage' : '✅ Activer le partage'}</button></div>
            </div>`;
        div.appendChild(sharePanelEl);
    }
    
    const earnedBadges = journalDataToDisplay.earned_badges || [];
    if (earnedBadges.length > 0) {
        div.innerHTML += createBadgesDisplay(context === 'student' ? 'journal' : 'journal_public');
    }
div.innerHTML += `<div class="mt-8">${createOrientationMapView(journalDataToDisplay, context === 'student' ? 'user' : 'public')}</div>`;

    const filRougeEl = document.createElement('div');
    filRougeEl.innerHTML = `
        <div id="filRougeContainer" class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-cyan-800">✨ ${context === 'student' ? 'Mon' : 'Son'} Fil Rouge</h2>
                ${context === 'student' ? '<button id="updateFilRougeBtn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition text-sm">Mettre à jour</button>' : ''}
            </div>
            <div id="filRougeLoader" class="hidden"><div class="loader"></div></div>
            <div id="filRougeContent" class="text-slate-700 whitespace-pre-wrap prose prose-sm max-w-none">${journalDataToDisplay.fil_rouge ? marked.parse(journalDataToDisplay.fil_rouge) : (context === 'student' ? "Cliquez sur 'Mettre à jour'..." : "Le Fil Rouge n'a pas encore été généré.")}</div>
        </div>
    `;
    div.appendChild(filRougeEl);

    const journalContentDiv = document.createElement('div');
    journalContentDiv.id = 'journalContent';
    journalContentDiv.className = 'mt-8 space-y-4';
    
    let hasAnyContent = false;

    if (journalDataToDisplay.step0 && journalDataToDisplay.step0.analysis) {
        const infographicElement = createProfileInfographic(journalDataToDisplay.step0);
        journalContentDiv.appendChild(infographicElement);
        hasAnyContent = true;
    }

    const stepTitles = { retroplanning_saves: 'Mes Conseils de Rétroplanning Sauvegardés', step10: 'Mon Portfolio de Compétences', step2: 'Mes simulations de spécialités', step1: 'Mes Fondations', step3: 'Mon Catalogue', step8: 'Mes passages à l\'action', radar_history: 'Mon Radar à Opportunités', chatbot_saves: 'Mes Discussions avec le Coach', step4: 'L\'expérience', step11: 'Mes rencontres sur le territoire', step6: 'Mes préparations de candidatures', step9: 'Mon anticipation de la suite', step12: 'Mes simulations de vie étudiante', step5: 'Mon Actu', step7: 'Mes Scores (Fact Checking)' };
    
    for (const stepKey in stepTitles) {
        const stepData = journalDataToDisplay[stepKey];
        if (!isStepStarted(stepKey)) continue;

        let sectionContentHTML = '';
        let hasSubEntries = false;
        let hasContentInSection = false;

        if (stepKey === 'retroplanning_saves' && Array.isArray(stepData) && stepData.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + [...stepData].reverse().map((item, index) => {
                const originalIndex = stepData.length - 1 - index;
                const conseilsContent = '<div class="prose prose-sm max-w-none">' + Object.entries(item.conseils).map(([key, value]) => `<h4 class="font-bold text-OrIAntation-darkblue mt-3 mb-1">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</h4><p class="text-slate-600 whitespace-pre-wrap">${value}</p>`).join('') + '</div>';
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="retroplanning_saves" data-entry-index="${originalIndex}">🗑️</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>Conseils générés le ${new Date(item.date).toLocaleDateString('fr-FR')}</span>${deleteButtonHTML}</summary><div class="p-3 border-t border-border-subtle">${conseilsContent}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'chatbot_saves' && Array.isArray(stepData) && stepData.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.map((item, index) => {
                 const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="chatbot_saves" data-entry-index="${index}">🗑️</button>` : '';
                 return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>Question : "${item.question}"</span>${deleteButtonHTML}</summary><div class="p-3 border-t border-border-subtle"><p class="whitespace-pre-wrap text-slate-600">${linkify(item.reponse)}</p></div></details>`}).join('') + '</div>';
        }
        else if (stepKey === 'radar_history' && Array.isArray(stepData) && stepData.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.map((item, index) => {
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="radar_history" data-entry-index="${index}">🗑️</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${item.type} : ${item.sujet}</span>${deleteButtonHTML}</summary><div class="p-3 border-t prose prose-sm max-w-none">${marked.parse(linkify(item.reponse))}</div></details>`}).join('') + '</div>';
        }
        else if (stepKey === 'step1' && Array.isArray(stepData?.metiers) && stepData.metiers.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.metiers.map((metier, index) => {
                let contentHTML = `<div class="mb-2"><p class="font-semibold text-slate-700">Notes :</p><p class="whitespace-pre-wrap text-slate-600">${metier.notes || "Aucune note."}</p></div>`;
                let analysesHTML = '';
                if (metier.analyses && Object.keys(metier.analyses).length > 0) {
                    analysesHTML = Object.entries(metier.analyses).map(([key, value]) => {
                        if (!value) return '';
                        if (key === 'temoignages') {
                            try {
                                const testimonials = JSON.parse(value);
                                if (!Array.isArray(testimonials)) return '';
                                const temoignagesContent = testimonials.map(item => `<div class="p-2 bg-white rounded border mt-1"><a href="${item.lien}" target="_blank" class="font-semibold text-primary-action hover:underline text-sm">${item.titre}</a><p class="text-xs mt-1">${item.resume}</p></div>`).join('');
                                return `<div class="mb-3"><h5 class="font-medium text-OrIAntation-darkblue">Témoignages</h5><div class="space-y-2">${temoignagesContent}</div></div>`;
                            } catch (e) { return ''; }
                        }
                        return `<div class="mb-3"><h5 class="font-medium text-OrIAntation-darkblue">${capitalizeWords(key)}</h5><div class="prose prose-sm max-w-none">${marked.parse(linkify(value))}</div></div>`;
                    }).join('');
                    if (analysesHTML.trim()) {
                        contentHTML += `<details class="mt-3 bg-white rounded-md border"><summary class="p-2 text-sm font-medium cursor-pointer text-cyan-700 hover:bg-slate-50">Voir les analyses de OrIA</summary><div class="p-3 border-t">${analysesHTML}</div></details>`;
                    }
                }
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step1" data-entry-index="${index}">🗑️</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${metier.nom}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step2' && Array.isArray(stepData?.combinations) && stepData.combinations.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.combinations.map((combo, index) => {
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step2" data-entry-index="${index}">🗑️</button>` : '';
                return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${combo.name}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${renderStep2InJournal({combinations: [combo]})}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step3' && (Array.isArray(stepData?.formations) && stepData.formations.length > 0 || stepData?.comparison)) {
            hasContentInSection = true;
            if (Array.isArray(stepData.formations) && stepData.formations.length > 0) {
                hasSubEntries = true;
                sectionContentHTML += '<div class="space-y-3">' + stepData.formations.map((formation, index) => {
                    let contentHTML = '';
                    if (formation.attendus) contentHTML += `<div class="mb-2"><p class="font-semibold">Attendus :</p><p class="whitespace-pre-wrap text-sm">${formation.attendus}</p></div>`;
                    if (formation.mots_cles) contentHTML += `<div class="mb-2"><p class="font-semibold">Mots-clés :</p><p class="whitespace-pre-wrap text-sm">${formation.mots_cles}</p></div>`;
                    if (formation.analyses) {
                        if(formation.analyses.compatibilite) contentHTML += `<div class="mb-2"><p class="font-semibold">Rapport de compatibilité :</p><div class="prose prose-sm max-w-none">${marked.parse(formation.analyses.compatibilite)}</div></div>`;
                        if(formation.analyses.analyse_mots_cles) contentHTML += `<div class="mb-2"><p class="font-semibold">Analyse des mots-clés :</p><div class="prose prose-sm max-w-none">${marked.parse(formation.analyses.analyse_mots_cles)}</div></div>`;
                    }
                    const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step3" data-entry-index="${index}">🗑️</button>` : '';
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${formation.nom}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
                }).join('') + '</div>';
            }
            if (stepData.comparison) {
                try {
                    const data = JSON.parse(stepData.comparison);
                    sectionContentHTML += `<h4 class="font-bold text-OrIAntation-darkblue mt-4 mb-2">Tableau Comparatif</h4><div class="comparison-table-wrapper">${markdownTableToHtml(data.tableau)}</div><p class="text-sm italic mt-2">${data.remarques}</p>`;
                } catch(e) { /* ignore error */ }
            }
        }
        else if (stepKey === 'step4' && Array.isArray(stepData?.themes) && stepData.themes.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.themes.map((item, index) => {
                let contentHTML = `<div class="mb-3"><p class="font-semibold text-slate-800">Ma question :</p><p class="text-sm whitespace-pre-wrap">${item.question}</p></div><div><p class="font-semibold text-slate-800">Suggestions de l'IA :</p><div class="text-sm whitespace-pre-wrap prose prose-sm max-w-none">${marked.parse(item.suggestions || '')}</div></div>`;
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step4" data-entry-index="${index}">🗑️</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${item.theme}</span>${deleteButtonHTML}</summary><div class="p-3 border-t border-border-subtle">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step5' && Array.isArray(stepData?.articles) && stepData.articles.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.articles.map((article, index) => {
                let contentHTML = `<div class="mb-2"><p class="font-semibold">Ce que j'ai appris :</p><p class="whitespace-pre-wrap text-sm">${article.notes || 'Non renseigné.'}</p></div>`;
                if (article.analysis) contentHTML += `<div class="mb-2"><p class="font-semibold">Analyse de OrIA :</p><div class="prose prose-sm max-w-none">${marked.parse(article.analysis)}</div></div>`;
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step5" data-entry-index="${index}">🗑️</button>` : '';
                return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${article.title}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step6' && Array.isArray(stepData?.projets) && stepData.projets.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.projets.map((projet, index) => {
                let contentHTML = `<div class="mb-2"><p class="font-semibold">Motivations :</p><p class="whitespace-pre-wrap text-sm">${projet.motivations || ''}</p></div><div class="mb-2"><p class="font-semibold">Structure proposée :</p><p class="whitespace-pre-wrap text-sm">${projet.structure || ''}</p></div>${projet.optimisation ? `<div class="mb-2"><p class="font-semibold">Conseils d'optimisation :</p><div class="prose prose-sm max-w-none">${marked.parse(projet.optimisation)}</div></div>` : ''}`;
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step6" data-entry-index="${index}">🗑️</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${projet.formation}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        } else {
            const staticContent = [];
            if (stepKey === 'step10') {
                if (Array.isArray(stepData.experiences) && stepData.experiences.length > 0) {
                    const experiencesContent = stepData.experiences.map((exp, index) => `<div class="p-3 bg-white rounded-lg border mt-2"><p class="font-medium text-OrIAntation-darkblue">Expérience #${index + 1}</p><div class="prose prose-sm max-w-none text-slate-600">${marked.parse(exp.analysis)}</div></div>`).join('');
                    staticContent.push(`<h4>Mes Expériences Significatives</h4><div class="space-y-2">${experiencesContent}</div>`);
                }
                if (stepData.soft_skills_profile) staticContent.push(`<h4>Profil de compétences</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.soft_skills_profile)}</div>`);
                if (stepData.skills_synthesis) staticContent.push(`<h4>Synthèse du Connecteur</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.skills_synthesis)}</div>`);
            } else if (stepKey === 'step8') {
                if(stepData.contacts?.length > 0) staticContent.push(`<h4>Liste de contacts</h4><ul>${stepData.contacts.map(c => `<li>${c.nom}</li>`).join('')}</ul>`);
                if(stepData.pro_strategie) staticContent.push(`<h4>Stratégie de contact</h4><p>${stepData.pro_strategie}</p>`);
            } else if (stepKey === 'step7' && stepData.scores) {
                staticContent.push(Object.entries(stepData.scores).map(([domain, history]) => `<h4>${domain}</h4><ul>${history.map(e => `<li>${e.date}: ${e.score}/${e.total}</li>`).join('')}</ul>`).join(''));
            } else if (stepKey === 'step9' || stepKey === 'step11' || stepKey === 'step12') {
                 const config = Object.values(stepsConfig).find(c => c.stepKey === stepKey);
                 if (config && config.fields) {
                    config.fields.forEach(field => {
                        const value = stepData[field.id];
                        if (value) staticContent.push(`<p><strong>${field.label}:</strong><br>${value}</p>`);
                    });
                 }
            }
            if (staticContent.length > 0) {
                hasContentInSection = true;
                sectionContentHTML = `<div class="prose prose-sm max-w-none text-slate-600 space-y-4">${staticContent.join('')}</div>`;
            }
        }

        if (hasContentInSection) {
            hasAnyContent = true;
            const sectionContainer = document.createElement('div');
            sectionContainer.id = `journal-section-${stepKey}`;
            sectionContainer.className = 'border border-border-subtle rounded-lg overflow-hidden';
            const deleteButtonHTML = !hasSubEntries && context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Vider la section" data-step-key="${stepKey}" data-action="clear-section">🗑️</button>` : '';
            sectionContainer.innerHTML = `
                <div class="journal-section-header flex justify-between items-center bg-background-light p-4 cursor-pointer hover:bg-slate-100 transition">
                    <h3 class="text-lg font-bold text-cyan-700">${stepTitles[stepKey]}</h3>
                    <div class="flex items-center gap-2">${deleteButtonHTML}<span class="transform transition-transform duration-200 text-cyan-700">▼</span></div>
                </div>
                <div class="journal-section-content p-4 border-t border-border-subtle hidden">${sectionContentHTML}</div>`;
            journalContentDiv.appendChild(sectionContainer);
        }
    }

    if (!hasAnyContent) {
        journalContentDiv.innerHTML = '<p class="text-center text-slate-500">Le journal est encore vide. Explorez les étapes pour le remplir !</p>';
    }
    
    div.appendChild(journalContentDiv);

    if (context === 'teacher') {
        const discussionSection = document.createElement('div');
        discussionSection.innerHTML = `
            <div class="mt-8 border-t pt-6 text-center">
                <button id="publicShareBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">🤝 Préparer une discussion</button>
            </div>
            <div id="publicOpenAIShareLoader" class="hidden"><div class="loader"></div></div>
            <div id="publicOpenAIShareResult" class="mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg"></div>`;
        div.appendChild(discussionSection);
    }
    
    if (context === 'student') {
        const deleteSection = document.createElement('div');
        deleteSection.className = 'text-center mt-12 pt-8 border-t border-border-subtle';
        deleteSection.innerHTML = `<button onclick="deleteUserAccount()" class="text-sm text-slate-500 hover:text-red-600 hover:underline transition-colors">Supprimer mon compte et toutes mes données</button>`;
        div.appendChild(deleteSection);
    }

    // ---- Logique des événements ----
    const allEventListeners = () => {
        if (context === 'student') {
            const toggleShareBtn = div.querySelector('#toggle-share-btn');
            if (toggleShareBtn) {
    toggleShareBtn.addEventListener('click', async () => {
        // Si un token existe, on veut désactiver le partage
        if (journalDataToDisplay.share_token) {
            const userConfirmed = await showConfirmationModal("Es-tu sûr de vouloir désactiver le partage ? Le lien ne fonctionnera plus.");
            if (userConfirmed) {
                // On supprime le token du journal
                journalDataToDisplay.share_token = null;
                // ▼▼▼ LIGNE AJOUTÉE ▼▼▼
                // On supprime le document "drapeau" de la liste publique
                await deleteDoc(doc(db, "publicShares", currentUserId));
                
                await saveData();
                showView('journal');
            }
        } else { // Sinon, on veut activer le partage
            const chosenRole = await promptShareRole();
            if (chosenRole) {
                // On crée le token et on le met dans le journal
                const newShareToken = 'shr_' + Math.random().toString(36).substr(2, 16);
                journalDataToDisplay.share_token = newShareToken;

                // ▼▼▼ LIGNE AJOUTÉE ▼▼▼
                // On crée le document "drapeau" dans la liste publique
                await setDoc(doc(db, "publicShares", currentUserId), { token: newShareToken });

                await saveData();
                
                // Le reste de la logique pour afficher le message est inchangé
                const newShareLink = `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${newShareToken}`;
                showShareMessageModal(newShareLink, userInfo.firstName, chosenRole);
                showView('journal');
            }
        }
    });
}
            const copyShareLinkBtn = div.querySelector('#copy-share-link');
            if (copyShareLinkBtn) {
                copyShareLinkBtn.addEventListener('click', () => {
                    const shareLink = `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${journalDataToDisplay.share_token}`;
                    navigator.clipboard.writeText(shareLink).then(() => showSurpriseModal("C'est fait !", '<p>Le lien a été copié.</p>', 2000));
                });
            }
            const updateFilRougeBtn = div.querySelector('#updateFilRougeBtn');
            if (updateFilRougeBtn) {
                updateFilRougeBtn.addEventListener('click', async () => {
                    if (!isStepStarted('step0')) { showInfoModal("Action requise", "Complète d'abord l'étape 'Mieux se connaître'."); return; }
                    const loader = div.querySelector('#filRougeLoader');
                    const contentP = div.querySelector('#filRougeContent');
                    loader.style.display = 'block'; contentP.style.display = 'none';
                    const profileSummary = getProfileSummary();
                    const completionSummary = getCompletionSummary();
                    const missions = { 
                        titre: "1. Ton Titre de Projet : Trouve un titre global, percutant et positif pour son projet d'orientation.",
                        pouvoirs: "2. Tes Super-Pouvoirs : Identifie ses 2 ou 3 plus grandes forces (compétences, traits de personnalité).",
                        terrain: "3. Ton Terrain de Jeu Idéal : Décris le type d'environnement d'études ou de travail où il pourrait s'épanouir.",
                        aventures: "4. Tes Prochaines Aventures : Suggère 2 ou 3 pistes de métiers ou de secteurs à explorer."
                    };
                    const createFilRougeMicroPrompt = (instruction) => `Agis comme un coach d'orientation expert et concis. # Données sur l'élève - Résumé du profil : ${profileSummary} - Résumé de la progression : ${completionSummary} # Ta Mission UNIQUE Ta seule mission est de répondre à cette instruction : "${instruction}". # Format de Sortie Rédige un unique paragraphe de texte. N'ajoute PAS le titre (comme "Ton Titre de Projet :").`;
                    try {
                        const promises = Object.entries(missions).map(([key, instruction]) => {
                            const microPrompt = createFilRougeMicroPrompt(instruction);
                            return callOpenAI_API({ promptText: microPrompt, promptId: "pmpt_68dc33a589bc8197a0229d72a4e3df100510635f4c084c2c", isExpertCall: true, loaderElement: loader }).then(result => ({ key, result }));
                        });
                        const resultsArray = await Promise.all(promises);
                        const finalResultObject = resultsArray.reduce((acc, { key, result }) => { acc[key] = result; return acc; }, {});
                        const result = `**Ton Titre de Projet** : ${finalResultObject.titre}\n\n**Tes Super-Pouvoirs** : ${finalResultObject.pouvoirs}\n\n**Ton Terrain de Jeu Idéal** : ${finalResultObject.terrain}\n\n**Tes Prochaines Aventures** : ${finalResultObject.aventures}`.trim();
                        journalDataToDisplay.fil_rouge = result;
                        await saveData();
                        await handleOnboarding({ from: 'fil_rouge_generated' });
                        contentP.innerHTML = marked.parse(result);
                    } catch (e) { 
                        console.error("Erreur Fil Rouge:", e);
                        contentP.innerHTML = `<p class="text-red-500">Désolé, une erreur est survenue.</p>`; 
                    } finally { 
                        loader.style.display = 'none'; 
                        contentP.style.display = 'block'; 
                    }
                });
            }
        } else if (context === 'teacher') {
            const publicShareBtn = div.querySelector('#publicShareBtn');
            if (publicShareBtn) {
                publicShareBtn.addEventListener('click', async () => {
                    const loader = div.querySelector('#publicOpenAIShareLoader');
                    const resultDiv = div.querySelector('#publicOpenAIShareResult');
                    publicShareBtn.disabled = true;
                    loader.innerHTML = `<div class="loader"></div><p class="text-slate-500 font-semibold mt-2">Analyse du parcours en cours...</p>`;
                    try {
                        const prompt = `Agis comme un coach... Voici le journal de bord complet : ${JSON.stringify(journalDataToDisplay)}. Analyse ce journal et génère 3 à 4 points de dialogue...`;
                        const result = await callOpenAI_API({ promptText: prompt });
                        resultDiv.innerHTML = marked.parse(result);
                    } catch (error) { resultDiv.innerHTML = '<p class="text-red-500">Une erreur est survenue.</p>'; }
                    finally { publicShareBtn.disabled = false; loader.innerHTML = ''; }
                });
            }
        }
        journalContentDiv.addEventListener('click', async (e) => {
            const header = e.target.closest('.journal-section-header');
            const deleteBtn = e.target.closest('.delete-journal-entry');
            if (header && !deleteBtn) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('span.transform');
                if (content) content.classList.toggle('hidden');
                if (icon) icon.classList.toggle('rotate-180');
                return;
            }
            if (deleteBtn && context === 'student') {
                e.stopPropagation();
                const stepKey = deleteBtn.dataset.stepKey;
                const action = deleteBtn.dataset.action;
                const entryIndex = parseInt(deleteBtn.dataset.entryIndex, 10);
                if (!await showConfirmationModal(action === 'clear-section' ? 'Vider toute cette section ?' : 'Supprimer cette entrée ?')) return;
                if (action === 'clear-section') { journalDataToDisplay[stepKey] = defaultData[stepKey]; }
                else if (!isNaN(entryIndex)) {
                    const arraysMap = { 'retroplanning_saves': journalDataToDisplay.retroplanning_saves, 'step1': journalDataToDisplay.step1?.metiers, 'step2': journalDataToDisplay.step2?.combinations, 'step3': journalDataToDisplay.step3?.formations, 'step4': journalDataToDisplay.step4?.themes, 'step5': journalDataToDisplay.step5?.articles, 'step6': journalDataToDisplay.step6?.projets, 'radar_history': journalDataToDisplay.radar_history, 'chatbot_saves': journalDataToDisplay.chatbot_saves };
                    if (arraysMap[stepKey]?.[entryIndex]) { arraysMap[stepKey].splice(entryIndex, 1); }
                }
                await saveData();
                await showView('journal');
            }
        });
        div.addEventListener('click', (e) => {
            const card = e.target.closest('.map-card-clickable');
            if (card) {
                e.preventDefault();
                const targetId = card.dataset.target;
                const targetElement = div.querySelector(`#${targetId}`);
                if (targetElement) { targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            }
        });
    };
    allEventListeners();
    
    // ---- Restauration des variables globales ----
    journalData = originalJournalData;
    userGradeLevel = originalUserGradeLevel;
    
    return div;
}

// REMPLACEZ la fonction createPublicShareView par cette version simplifiée

async function createPublicShareView(userId, token) {
    const mainApp = document.getElementById('mainApp');
    mainApp.innerHTML = `<div class="loader"></div>`;

    try {
        // ... (la logique de récupération des données ne change pas)
        const userDocRef = doc(db, "users", userId);
        const docSnap = await getDoc(userDocRef);

        if (!docSnap.exists()) throw new Error("Utilisateur non trouvé.");
        
        const data = docSnap.data();
        if (!data.journal || data.journal.share_token !== token) {
            throw new Error("Lien de partage invalide ou désactivé.");
        }

        const userInfo = {
            firstName: data.firstName || 'L\'élève',
            schoolName: data.schoolName || 'son lycée',
            gradeLevel: data.gradeLevel || 'sa classe'
        };
        // --- FIN DE LA LOGIQUE INCHANGÉE ---

        const pageElement = await createUnifiedJournalView(userInfo, data.journal, 'teacher');
        
        // ✅ ON MODIFIE ICI : on insère d'abord le logo, puis le journal
        mainApp.innerHTML = `
            <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-auto w-48 mb-8">
        `;
        mainApp.appendChild(pageElement);

    } catch (error) { // ... (la gestion d'erreur ne change pas)
        mainApp.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md"><h2 class="text-xl font-bold text-red-600">Erreur</h2><p class="text-slate-600 mt-2">${error.message}</p></div>`;
    }
}


function isStepComplete(stepKey) {
    const config = Object.values(stepsConfig).find(s => s.stepKey === stepKey);
    const data = journalData[stepKey];
    if (!config || !data) return false;

    // Règle stricte rétablie : les DEUX parties doivent être faites pour la coche VERTE.
    if (stepKey === 'step0') {
        const hasMainAnalysis = data.analysis && data.analysis.trim() !== '';
        const hasCrossAnalysis = data.analyse_tests_croisee && data.analyse_tests_croisee.trim() !== '';
        return hasMainAnalysis && hasCrossAnalysis;
    }

    // Règle stricte pour "Les Fondations"
    if (stepKey === 'step1') {
        // L'étape est considérée comme "terminée" si au moins 2 métiers ont été enregistrés
        // ET que le comparateur a été utilisé.
        const metiersEnregistres = journalData.step1.metiers && journalData.step1.metiers.length >= 2;
        const comparisonDone = journalData.step1.comparison && journalData.step1.comparison.trim() !== '';
        return metiersEnregistres && comparisonDone;
    }

    if (stepKey === 'step3') {
    const formationsEnregistrees = journalData.step3.formations && journalData.step3.formations.length >= 2;
    const comparisonDone = journalData.step3.comparison && journalData.step3.comparison.trim() !== '';
    return formationsEnregistrees && comparisonDone;
}

    
    // NOUVELLE RÈGLE STRICTE POUR "Mon Rétroplanning"
    if (stepKey === 'retroplanning') {
    // NOUVELLE RÈGLE : L'étape est "complète" si au moins un conseil a été sauvegardé.
    return journalData.retroplanning_saves && Array.isArray(journalData.retroplanning_saves) && journalData.retroplanning_saves.length > 0;
}

    // Règle assouplie : complète dès que 2 combinaisons sont nommées.
    if (stepKey === 'step2') {
    // L'étape est "complète" si au moins 2 combinaisons sont sauvegardées.
    return journalData.step2.combinations && journalData.step2.combinations.length >= 2;
}
    
    // Règle assouplie : complète dès qu'UNE seule info est analysée.
    if (stepKey === 'step5') {
    // L'étape est "complète" si au moins 2 articles sont sauvegardés.
    return journalData.step5.articles && journalData.step5.articles.length >= 2;
}
    
    // Règle assouplie : complète dès qu'UNE seule lettre est préparée.
    if (stepKey === 'step6') {
        const lettre1Done = data.lettre1 && data.lettre1.formation && data.lettre1.formation.trim() !== '';
        return lettre1Done;
    }

    if (stepKey === 'step9') {
        const hasPlanB = data.planb_chat_history && data.planb_chat_history.length >= 4;
        const hasReussite = data.reussite_conseils && data.reussite_conseils.trim() !== '';
        return hasPlanB && hasReussite;
    }
    
    if (stepKey === 'step10') {
        const hasExperience = data.experiences && Array.isArray(data.experiences) && data.experiences.length > 0;
        const hasProfile = data.soft_skills_profile && data.soft_skills_profile.trim() !== '';
        return hasExperience && hasProfile;
    }

    if (stepKey === 'step11') {
        const hasLocation = data.location && data.location.trim() !== '';
        const hasResults = (data.evenements && data.evenements.length > 0) || (data.structures && data.structures.length > 0);
        const hasJpoPrep = data.jpo_questions && data.jpo_questions.trim() !== '';
        const hasSalonPrep = data.salon_preparation && data.salon_preparation.trim() !== '';
        return hasLocation && (hasResults || hasJpoPrep || hasSalonPrep);
    }

    // Logique générale pour les autres étapes (inchangée)
    if (!config.fields || config.fields.length === 0) return false;
    const userFields = config.fields.filter(f => !f.isReadonly);
    if (userFields.length === 0) return true;
    return userFields.every(field => data[field.id] && data[field.id].toString().trim() !== '');
}
        function checkBadges() {
            if (!journalData.earned_badges) {
                journalData.earned_badges = [];
            }
            for (const badgeKey in badgesConfig) {
                if (!journalData.earned_badges.includes(badgeKey)) {
                    if (badgesConfig[badgeKey].criteria(userGradeLevel)) {
                        journalData.earned_badges.push(badgeKey);
                    }
                }
            }
        }

        function createProgressBarHTML() {
    const allStepsForLevel = allSteps.filter(step => step.levels.includes(userGradeLevel));
    
    // On utilise la logique corrigée qui compte les étapes commencées (coches oranges et vertes)
    const completedStepsCount = allStepsForLevel.filter(step => 
        !['journal', 'retroplanning', 'step12'].includes(step.id) && isStepStarted(step.id)
    ).length;

    const totalTrackableSteps = allStepsForLevel.filter(step => !['journal', 'retroplanning', 'step12'].includes(step.id)).length;
    const progressPercentage = totalTrackableSteps > 0 ? (completedStepsCount / totalTrackableSteps) * 100 : 0;

    return `
        <div class="flex justify-between items-center mb-1">
    <span class="text-base font-medium text-cyan-700 flex items-center gap-2">
        Progression des Étapes
        <button id="progress-help-btn" class="text-slate-400 hover:text-cyan-600" title="À quoi correspondent les coches ?">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
            </svg>
        </button>
    </span>
    <span class="text-sm font-medium text-cyan-700">${Math.round(progressPercentage)}%</span>
</div>
            <div class="w-full bg-slate-200 rounded-full h-2.5">
                <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
            </div>
        </div>
    `;
}

      
function createBadgesDisplay(context = 'menu') {
    const earnedBadges = journalData.earned_badges || [];
    
    // NOUVEAU : On choisit le titre en fonction du contexte
    const title = (context === 'public' || context === 'journal_public') ? 'Ses Badges' : 'Mes Badges';

    let badgesHTML = Object.keys(badgesConfig).map(key => {
        const badge = badgesConfig[key];
        const earned = earnedBadges.includes(key);
        return `
            <div class="text-center">
                <div class="badge ${earned ? 'earned' : ''}" title="${badge.description}">
                    <span class="text-3xl">${badge.icon}</span>
                    <p class="text-sm font-semibold mt-1 ${earned ? 'text-OrIAntation-darkblue' : 'text-slate-400'}">${badge.title}</p>
                </div>
            </div>
        `;
    }).join('');
    
    const wrapperClass = (context === 'journal' || context === 'journal_public') ? 'mb-8' : 'mb-8 bg-white p-4 rounded-2xl shadow-md border border-border-subtle';

    return `
        <div id="badgesContainer" class="${wrapperClass}">
            <h2 class="text-lg font-bold text-OrIAntation-darkblue text-center mb-2">${title}</h2>
            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                ${badgesHTML}
            </div>
        </div>
    `;
}


        // --- Chatbot Logic ---
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatMessages = document.getElementById('chat-messages');
        
        let chatbotHistory = []; // On ajoute une mémoire pour la conversation

        // 1. Message d'accueil personnalisé
        const openChatbot = () => {
            chatbotContainer.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
            chatbotToggle.classList.add('chat-open');
        };

        const closeChatbot = () => {
            chatbotContainer.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
            chatbotToggle.classList.remove('chat-open');
        };
        chatbotContainer.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        chatbotToggle.addEventListener('click', () => {
            // On vérifie si le chatbot est actuellement caché (en testant une des classes)
            const isHidden = chatbotContainer.classList.contains('opacity-0');
            
            if (isHidden) {
                openChatbot();
            } else {
                closeChatbot();
            }

            const now = new Date().getTime();
            const lastInteraction = journalData.chatbot_last_interaction || 0;
            const minutesSinceLastInteraction = (now - lastInteraction) / (1000 * 60);

            // Si plus de 30 minutes se sont écoulées, on réinitialise
            if (minutesSinceLastInteraction > 30) {
                chatbotHistory = [];
                chatMessages.innerHTML = ''; // On vide aussi l'affichage
            }

            // On affiche le message d'accueil personnalisé si la conversation est vide
            if (chatbotContainer.classList.contains('hidden') === false && chatbotHistory.length === 0) {
            const welcomeText = `Salut ${currentUserInfo.firstName} ! Je suis OrIA, ton copilote pour l'orientation. 😊 Prêt à explorer ? Pose-moi ta question !`;
                addMessage(welcomeText, 'ai');
            }
        });

            chatbotClose.addEventListener('click', () => {
             closeChatbot(); // On utilise la même fonction que le bouton flottant
        });

        // 2. Logique de conversation (qui gère l'historique)
        const createChatbotPrompt = (userInput, history) => {
            const userInfo = currentUserInfo;
            const userJournal = journalData;
            const appStepsList = allSteps.map(s => `- '${s.icon} ${s.title}'`).join('\n');
            const today = new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const currentSchoolYearStart = getCurrentSchoolYear();
            const schoolYearString = `${currentSchoolYearStart}-${currentSchoolYearStart + 1}`;

            // --- NOUVEAU : On génère le résumé de la progression ---
            const completionSummary = getCompletionSummary();
            const appFeaturesSummary = getAppFeaturesSummary();


            const historyText = history.map(msg => {
                return `${msg.role === 'user' ? '[PRÉNOM]' : 'Toi'}: ${msg.parts[0].text}`;
            }).join('\n');

            return `
# Rôle et Persona (Ta seule identité)
Tu es le "Copilote", l'IA conversationnelle de l'application "OrIAntation". Ton but est d'aider [PRÉNOM] à utiliser l'application pour construire son projet. Pense à toi comme un mentor jeune, dynamique et super sympa.
- Le nom de ton application est **OrIAntation**.

# Ton Style (TA PRIORITÉ ABSOLUE)
- **Ton :** Parle comme un jeune adulte, pas comme un prof. Utilise "tu", sois direct, chaleureux et encourageant. Sois professionnel mais cool.
- **Emojis :** Utilise quelques emojis pour rendre tes messages funs et visuels. 👍🚀💡😉🤔
- **Proactivité :** Propose TOUJOURS une action suivante, de préférence en suggérant une étape pertinente de l'application.
- **Varie tes intros !**

# Contexte Essentiel
Tu dois te baser sur TOUT ce contexte pour chaque réponse.

**1. L'élève que tu aides :**
- Prénom : [PRÉNOM]
- Genre : [GENRE]
- Classe : [CLASSE]
- Année Scolaire en cours ("cette année") : ${schoolYearString}
- Son Journal de Bord (contient ses réponses et son profil) : [JOURNAL_DATA]

**2. L'application que vous utilisez ensemble :**
- Outils disponibles et leur fonction : ${appFeaturesSummary} // MODIFICATION : On utilise le mode d'emploi détaillé
- Résumé de sa progression : ${completionSummary}

**3. L'historique de votre conversation :**
[HISTORIQUE_CONVERSATION]

# Ta Mission et tes Règles d'Or (À SUIVRE IMPÉRATIVEMENT)
- **Règle de base :** N'invente JAMAIS une fonctionnalité qui n'est pas dans la liste des outils. Ton rôle est de guider l'élève à travers l'application EXISTANTE.
- **Ton objectif final :** Amener l'élève à une action concrète dans l'une des étapes de l'application.

RÈGLE N°1 - LA PLUS IMPORTANTE : PAS DE SALUTATIONS.
Tu ne salues l'utilisateur qu'une seule fois...

Ensuite, suis cet ordre de priorité pour répondre à la dernière question de [PRÉNOM] :

1.  **Priorité 1 : Guide dans l'appli.** Si sa question peut être résolue avec un outil de l'app, guide-le vers l'outil le plus pertinent (et non terminé !).
2.  **Priorité 2 : Analyse son profil.** Si sa question est personnelle ("penses-tu que ce métier est fait pour moi ?"), utilise son Journal de Bord pour donner une réponse personnalisée.
3.  **Priorité 3 : Expert Externe avec recherche web.** Pour les questions factuelles sur les formations, les métiers ou les dates (comme Parcoursup), tu DOIS utiliser ta capacité de recherche sur le web pour trouver les informations les plus à jour possibles. C'est une de tes fonctions principales. Cite toujours tes sources (ex: onisep.fr, parcoursup.fr) quand tu donnes une information précise.
---
Dernière question de [PRÉNOM] : "${userInput}"
`
    .replace(/\[PRÉNOM\]/g, userInfo.firstName)
    .replace('[GENRE]', userInfo.gender || 'autre')
    .replace('[CLASSE]', userGradeLevel)
    .replace('[JOURNAL_DATA]', JSON.stringify(userJournal))
    // MODIFICATION : On remplace la variable à remplacer
    // .replace('[LISTE_ETAPES]', appStepsList) 
    .replace('[HISTORIQUE_CONVERSATION]', historyText);
};
        
        chatbotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatbotInput.value.trim();
            if (!userInput) return;

            addMessage(userInput, 'user');
            chatbotInput.value = '';
            
            const loaderDiv = addMessage('', 'loader', false);
            const prompt = createChatbotPrompt(userInput, chatbotHistory);
const aiResponse = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});            loaderDiv.remove();
            
            // On récupère le conteneur du message de OrIA qu'on vient de créer
            const aiMessageWrapper = addMessage(aiResponse, 'ai');
            const saveBtn = aiMessageWrapper.querySelector('.save-chat-btn');

            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    if (!Array.isArray(journalData.chatbot_saves)) {
                        journalData.chatbot_saves = [];
                    }
                    // On sauvegarde la question de l'élève ET la réponse de OrIA
                    journalData.chatbot_saves.push({
                        question: userInput,
                        reponse: aiResponse
                    });
                    await saveData();
                    
                    // Feedback visuel
                    saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                    saveBtn.disabled = true;
                    saveBtn.title = "Enregistré !";
                });
            }
        });

        function addMessage(text, sender, addToHistory = true) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex mb-4 group'; // On ajoute la classe "group" pour le survol
            
            if (addToHistory) {
                chatbotHistory.push({ role: sender === 'user' ? 'user' : 'model', parts: [{ text }] });
                journalData.chatbot_last_interaction = new Date().getTime(); 
            }

            let messageContent;
            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageContent = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs"><p>${text}</p></div>`;
            } else if (sender === 'ai') {
                 // On ajoute un conteneur flex pour le message et le bouton
                 messageWrapper.classList.add('items-end', 'gap-2');
                 messageContent = `
                    <div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs">
                    <div class="prose prose-sm max-w-none text-cyan-800">${marked.parse(text)}</div>
                    </div>
                    <button class="save-chat-btn opacity-0 group-hover:opacity-100 transition text-slate-400 hover:text-primary-action p-1" title="Enregistrer dans le journal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12l-5-3-5 3V4z" /></svg>
                    </button>
                 `;
            } else if (sender === 'loader') {
                 messageContent = `<div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg"><div class="chatbot-loader"></div></div>`;
            }

            messageWrapper.innerHTML = messageContent;
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageWrapper;
        }

        // Le reste de votre code reste inchangé...

        window.showView = showView;

        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('SW registered: ', registration);
            }).catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
        });
    }

    // ========================================================
// AJOUTEZ CE BLOC POUR LA NAVIGATION PAR GESTES
// ========================================================
let touchStartX = 0;
let touchStartY = 0;

mainApp.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

mainApp.addEventListener('touchend', (e) => {
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    if (!floatingBackBtn || floatingBackBtn.style.display === 'none') {
        return; // On ne fait rien si le bouton retour n'est pas visible
    }

    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;

    // On vérifie que le geste est bien un balayage horizontal vers la droite
    // et non un défilement vertical.
    if (deltaX > 75 && Math.abs(deltaY) < 75) {
        // On simule un clic sur le bouton de retour,
        // ce qui déclenche la bonne logique de retour (vers le menu, l'inscription, etc.)
        floatingBackBtn.click();
    }
}, { passive: true });

mainApp.addEventListener('touchend', (e) => {
    // On ne fait rien si le bouton retour n'est pas visible
    // (cela empêche le geste de fonctionner sur le menu principal)
    if (!floatingBackBtn || floatingBackBtn.style.display === 'none') {
        return;
    }

    // On récupère la position de fin
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;

    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;

    // On vérifie si le geste est un balayage vers la droite
    // et pas un simple défilement vertical.
    if (deltaX > 75 && Math.abs(deltaY) < 75) {
        showView('menu');
    }
}, { passive: true });

// ========================================================
// AJOUTEZ CE BLOC POUR LA FENÊTRE DE SÉLECTION DU GUIDE
// ========================================================
let guideUserRole = 'eleve'; // Rôle par défaut

const guideRoleModal = document.getElementById('guideRoleModal');
const closeRoleModalBtn = document.getElementById('closeRoleModalBtn');
const roleEleveBtn = document.getElementById('roleEleveBtn');
const roleParentBtn = document.getElementById('roleParentBtn');
const roleEnseignantBtn = document.getElementById('roleEnseignantBtn');

// Fonction qui ouvre le guide après avoir choisi un rôle
const openGuide = (role) => {
    guideUserRole = role; // On sauvegarde le rôle
    guideRoleModal.style.display = 'none'; // On cache la fenêtre
    window.showGuideFromLogin(); // On affiche le guide
};

// Attache les événements aux boutons
closeRoleModalBtn.addEventListener('click', () => {
    guideRoleModal.style.display = 'none';
});

roleEleveBtn.addEventListener('click', () => openGuide('eleve'));
roleParentBtn.addEventListener('click', () => openGuide('parent'));
roleEnseignantBtn.addEventListener('click', () => openGuide('enseignant'));

// Fonction de la nouvelle politique de confidentialité
    // REMPLACEZ VOTRE FONCTION createPrivacyPolicyView EXISTANTE PAR CE CODE :
function createPrivacyPolicyView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle text-left';
    
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-OrIAntation-darkblue mb-4 text-center">Politique de Confidentialité</h1>
        <p class="mb-8 text-sm text-slate-500 text-center">Dernière mise à jour : 20 septembre 2025</p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">1. Objet et champ d'application</h2>
        <p class="text-slate-600 mb-4">
            La présente politique de confidentialité a pour objet de définir les modalités de traitement des données à caractère personnel des utilisateurs de l'application web "OrIAntation", conformément au Règlement (UE) 2016/679 du Parlement européen et du Conseil du 27 avril 2016, plus connu sous le nom de **Règlement Général sur la Protection des Données (RGPD)**. Ce document est un instrument de transparence destiné à informer les utilisateurs et, le cas échéant, à répondre aux requêtes des autorités de contrôle (telles que la CNIL en France).
        </p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">2. Identité et coordonnées du responsable de traitement</h2>
        <p class="text-slate-600 mb-4">
            Le responsable du traitement des données est Thomas Cavil, créateur et développeur de l'application.
            <ul class="list-disc list-inside text-slate-600 mb-4">
                <li><strong>Nom/Raison sociale :</strong> Thomas Cavil/Enseignant agrégé SVT au lycée Benjamin franklin</li>
                <li><strong>Contact :</strong> <a href="mailto:contact@oriantation.fr" class="font-semibold text-primary-action hover:underline">contact@oriantation.fr</a></li>
            </ul>
        </p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">3. Données collectées, finalités et base légale du traitement</h2>
        <p class="text-slate-600 mb-4">
            Les données à caractère personnel traitées sont limitées au strict nécessaire pour la fourniture du service.
        </p>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catégorie de données</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Finalité du traitement</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base légale du traitement</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 text-slate-600">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">Données d'identification<br>(Prénom, nom, e-mail, lycée)</td>
                        <td class="px-6 py-4">Gestion du compte utilisateur, authentification, communication et personnalisation du profil.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Consentement</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">Données de profil<br>(Classe, réponses aux questionnaires)</td>
                        <td class="px-6 py-4">Création d'un profil d'orientation personnalisé et génération d'analyses.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Consentement</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4">Contenu du journal de bord<br>(Notes, réflexions, listes, etc.)</td>
                        <td class="px-6 py-4">Fourniture des fonctionnalités de l'application (synthèses, suggestions, historique), et de la fonction de partage.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Consentement</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">Logs de connexion<br>(Adresse IP, horodatage)</td>
                        <td class="px-6 py-4">Sécurité du système, détection des fraudes et maintenance technique.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Intérêt légitime</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">4. Destinataires et sous-traitants des données</h2>
<p class="text-slate-600 mb-4">
    Vos données sont traitées en interne par le responsable de traitement. Elles ne sont pas transmises à des tiers, à l'exception des sous-traitants nécessaires au bon fonctionnement de l'application :
</p>
<div class="space-y-6 mt-4">

  <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7l8 4.5 8-4.5M12 12.5V21" /></svg>
      Firebase (Google LLC)
    </h3>
    <p class="text-slate-600 mt-2">
      En tant qu'hébergeur de la base de données et fournisseur du service d'authentification. Les données sont stockées sur des serveurs situés en Europe, garantissant un niveau de protection conforme au RGPD.
    </p>
  </div>

  <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      Modèle de langage GPT-5 et GPT-4o (OpenAI, L.L.C.)
    </h3>
    <p class="text-slate-600 mt-2">
      Le contenu de votre journal de bord est transmis à ce modèle d'intelligence artificielle pour générer les réponses personnalisées de l'application.
    </p>
    <div class="mt-3 bg-background-light p-3 rounded-md border border-border-subtle text-sm">
      <p><strong class="font-semibold text-slate-700">Cadre juridique :</strong> Ce traitement est encadré par l'Accord de Traitement des Données (DPA) d'OpenAI, qui inclut des Clauses Contractuelles Types (CCT) pour garantir un niveau de protection des données conforme au RGPD.</p>
      <p class="mt-2"><strong class="font-semibold text-slate-700">Principe de non-utilisation pour l'entraînement :</strong> Conformément à la politique d'OpenAI pour son API, les données que vous envoyez ne sont pas utilisées pour entraîner ou améliorer les modèles d'IA de l'entreprise.</p>
    </div>
  </div>

  <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h1a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.75 4l-2.75 4M16.25 4l2.75 4" /></svg>
      Netlify, Inc.
    </h3>
    <p class="text-slate-600 mt-2">
      En tant qu'hébergeur de l'interface web (frontend) de l'application. Netlify peut traiter des données techniques de connexion, telles que les adresses IP des visiteurs, à des fins de sécurité et de performance.
    </p>
  </div>
  
    <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
      Brevo (anciennement Sendinblue)
    </h3>
    <p class="text-slate-600 mt-2">
      En tant que service d'envoi d'e-mails transactionnels (vérification de compte, réinitialisation de mot de passe).
    </p>
    <div class="mt-3 bg-background-light p-3 rounded-md border border-border-subtle text-sm">
        <p><strong class="font-semibold text-slate-700">Cadre juridique :</strong> Ce traitement est encadré par les conditions d'utilisation et la politique de confidentialité de Brevo, conformes au RGPD, l'entreprise étant européenne.</p>
    </div>
  </div>

</div>
<p class="text-slate-600 mb-4">
    En cas d'activation de la fonction "Partage", un lien sécurisé est généré et vous seul(e) en êtes le(la) destinataire initial(e). La consultation des données par un tiers via ce lien relève de votre responsabilité.
</p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">5. Durée de conservation des données</h2>
        <p class="text-slate-600 mb-4">
            Les données à caractère personnel sont conservées pour la durée de votre utilisation de l'application. En cas de demande de suppression du compte, toutes les données à caractère personnel sont définitivement effacées dans un délai maximal de **30 jours** à compter de la réception de la demande. Ce délai permet de traiter les éventuelles réclamations et d'assurer une bonne fin aux opérations techniques.
        </p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">6. Mesures de sécurité</h2>
        <p class="text-slate-600 mb-4">
            Nous mettons en œuvre des mesures techniques et organisationnelles appropriées pour assurer un niveau de sécurité adapté au risque. Ces mesures comprennent :
        </p>
        <ul class="list-disc list-inside text-slate-600 mb-4">
            <li>L'utilisation de protocoles de communication sécurisés (HTTPS).</li>
            <li>Le chiffrement des données de connexion.</li>
            <li>Un contrôle d'accès strict aux données stockées sur la base de données.</li>
            <li>Des procédures de sauvegarde régulières.</li>
        </ul>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">7. Vos droits en matière de protection des données</h2>
        <p class="text-slate-600 mb-4">
            Conformément au RGPD, vous disposez d'un ensemble de droits que vous pouvez exercer à tout moment en contactant le responsable de traitement à l'adresse indiquée ci-dessus :
        </p>
        <ul class="list-disc list-inside text-slate-600 mb-4">
            <li><strong>Droit d'accès</strong> (Art. 15 du RGPD)</li>
            <li><strong>Droit de rectification</strong> (Art. 16 du RGPD)</li>
            <li><strong>Droit à l'effacement</strong> ("droit à l'oubli", Art. 17 du RGPD)</li>
            <li><strong>Droit à la limitation du traitement</strong> (Art. 18 du RGPD)</li>
            <li><strong>Droit à la portabilité des données</strong> (Art. 20 du RGPD)</li>
            <li><strong>Droit d'opposition</strong> (Art. 21 du RGPD)</li>
            <li><strong>Droit de retirer le consentement</strong> (Art. 7 du RGPD)</li>
        </ul>
        <p class="text-slate-600">
            Vous avez également le droit d'introduire une réclamation auprès de l'autorité de contrôle compétente (la CNIL en France) si vous estimez que vos droits n'ont pas été respectés.
        </p>
    `;
    
    return div;
}

let newWorker;

// 1. On vérifie les mises à jour du Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
        if (reg) {
            reg.addEventListener('updatefound', () => {
                newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    // Si un nouveau SW est prêt et en attente, on prépare la notification
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showUpdateNotification();
                    }
                });
            });
        }
    });
}

// 2. Fonction pour afficher la bannière
function showUpdateNotification() {
    const notification = document.getElementById('update-notification');
    const reloadButton = document.getElementById('reload-button');

    if (notification && reloadButton) {
        notification.classList.remove('hidden');
        reloadButton.addEventListener('click', () => {
            // On envoie un message au SW pour qu'il s'active, puis on recharge la page
            newWorker.postMessage({ action: 'skipWaiting' });
            window.location.reload();
        });
    }
}

// 3. (Optionnel mais recommandé) Recharger la page quand un nouveau SW prend le contrôle
//    Ceci garantit que la page est toujours synchronisée avec le SW actif.
let refreshing;
navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshing) return;
    window.location.reload();
    refreshing = true;
});

window.signOut = signOut;
window.auth = auth;

    </script>
    
</body>

<div id="update-notification" class="hidden fixed bottom-4 right-4 bg-OrIAntation-darkblue text-white p-4 rounded-lg shadow-lg flex items-center gap-4 z-50">
    <span>Une nouvelle version est disponible !</span>
    <button id="reload-button" class="bg-OrIAntation-orange font-bold py-1 px-3 rounded hover:bg-amber-600">
        Mettre à jour
    </button>
</div>

</html>
