<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrIAntation</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo_180.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    'OrIAntation-darkblue': '#1A3263',
                    'OrIAntation-orange': '#FF8C00',
                    'OrIAntation-lightblue': '#3366CC',
                    'OrIAntation-green': '#66BB6A',
                    'OrIAntation-yellow': '#FFD700',
                    'primary-action': '#2C7A7B', // Votre cyan/turquoise pour les boutons
                    'secondary-accent': '#E05260', // Pour des √©l√©ments secondaires si besoin
                    'text-body': '#333333', // Texte g√©n√©ral
                    'background-light': '#F8FAFC', // Votre blanc cass√©
                    'border-subtle': '#E2E8F0', // Bordures
                },
                fontFamily: {
                    sans: ['Poppins', 'sans-serif'], // D√©finit Poppins comme police par d√©faut
                }
            }
        }
    }
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            text-align: justify;
        }
        .step-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #footer-privacy-link {
            display: none; /* Cach√© par d√©faut */
        }
        body.logged-in #footer-privacy-link {
            display: block; /* Visible si l'utilisateur est connect√© */
        }

        #mainApp { display: none; }

        .fiche-content {
         overflow-wrap: break-word;
         word-wrap: break-word;
         }

         .fiche-colonne-contenu {
    /* Astuce CSS pour corriger les bugs de d√©passement dans une grille */
    min-width: 0; 
         }
        

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0891b2; 
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .chatbot-loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #0891b2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse-glow {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(8, 145, 178, 0.7); /* cyan-600 avec opacit√© */
  }
  50% {
    box-shadow: 0 0 10px 5px rgba(8, 145, 178, 0);
  }
}
.next-mission-highlight {
  animation: pulse-glow 2s infinite;
  border-color: #0891b2; /* cyan-600 */
  border-width: 2px;
}

        /* Chatbot styles */
        #chatbot-toggle {
            transition: transform 0.2s ease-in-out;
      
        }
        #chatbot-toggle.chat-open:hover {
            transform: none; /* D√©sactive le zoom quand le chat est ouvert */
        }
        #chatbot-container {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .chat-message-container {
            scroll-behavior: smooth;
        }
        .badge {
            filter: grayscale(1);
            opacity: 0.5;
        }
        .badge.earned {
            filter: grayscale(0);
            opacity: 1;
        }

        body {
            font-family: 'Inter', sans-serif;
        }
        .simulation-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .simulation-message-container {
            scroll-behavior: smooth;
        }

        .portfolio-modal {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }

        h1, h2, h3, h4 {
            text-align: center;
        }

       #floatingBackBtn {
    position: fixed;
    bottom: 24px;
    left: 24px;
    width: 56px;
    height: 56px;
    background-color: #0891b2; /* cyan-600 -- COULEUR MODIFI√âE ICI */
    color: white;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    cursor: pointer;
    z-index: 30;
    transition: transform 0.2s ease-in-out, opacity 0.3s ease-in-out;
}

#floatingBackBtn:hover {
    transform: scale(1.1);
}

/* AJOUTEZ CE BLOC √Ä L'INT√âRIEUR DE VOTRE BALISE <style> */

/* Conteneur pour le tableau de comparaison pour permettre le d√©filement */
.comparison-table-wrapper {
    overflow-x: auto; /* Permet le d√©filement horizontal si le contenu d√©passe */
    -webkit-overflow-scrolling: touch; /* Am√©liore le d√©filement sur les appareils Apple */
    border: 1px solid #e2e8f0; /* border-border-subtle */
    border-radius: 8px; /* Bords arrondis */
    margin-top: 1rem;
}

/* Styles pour le tableau √† l'int√©rieur du conteneur */
.comparison-table-wrapper table {
    min-width: 600px; /* Force une largeur minimale pour √©viter que le tableau ne s'√©crase */
    width: 100%;
    border-collapse: collapse;
}

.comparison-table-wrapper th,
.comparison-table-wrapper td {
    padding: 12px 15px;
    border-bottom: 1px solid #e2e8f0; /* border-border-subtle */
    text-align: left;
    white-space: normal; /* Permet au texte de revenir √† la ligne */
}

.comparison-table-wrapper th {
    background-color: #f8fafc; /* background-light */
    font-weight: 600;
    color: #1A3263; /* OrIAntation-darkblue */
}

#chatbot-container {
    height: calc(100% - 8rem); /* Calcule une hauteur fixe (toute la hauteur moins les marges) */
    max-height: 600px; /* Emp√™che la fen√™tre d'√™tre trop grande sur ordinateur */
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
}

/* CSS POUR LE BOUTON DE DICT√âE VOCALE (VERSION FINALE ET ROBUSTE) */
.mic-dictation-btn {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    cursor: pointer;
    color: #94a3b8; /* slate-400 */
    transition: color 0.2s;
    z-index: 50; /* Assez √©lev√© pour passer par-dessus le chatbot */
}
.mic-dictation-btn:hover {
    color: #0891b2; /* cyan-600 */
}
.mic-dictation-btn.is-listening {
    color: #ef4444; /* red-500 */
    animation: pulse-mic 1.5s infinite;
}

@keyframes pulse-mic {
  0%, 100% {
    transform: translateY(-50%) scale(1);
  }
  50% {
    transform: translateY(-50%) scale(1.2);
  }
}

    </style>
</head>

<body class="bg-background-light text-OrIAntation-darkblue text-center">

    <div id="authContainer" class="max-w-md mx-auto p-4 md:p-8 mt-10">
        <!-- L'interface d'authentification sera inject√©e ici -->
    </div>

    <div id="mainApp" class="max-w-4xl mx-auto p-4 md:p-8">
    </div>
        
<button id="floatingBackBtn" title="Retour au menu" style="display: none;">‚Üê</button>

<div id="guideRoleModal" style="display: none;" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center fade-in">
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Qui √™tes-vous ?</h2>
        <p class="text-slate-600 mb-8">Nous pouvons adapter la pr√©sentation du guide pour vous.</p>
        <div class="space-y-4">

            <button id="roleEleveBtn" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                </svg>
                <span>Je suis un √©l√®ve</span>
            </button>

            <button id="roleParentBtn" class="w-full bg-sky-600 text-white font-semibold py-3 rounded-lg hover:bg-sky-700 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.962A3.75 3.75 0 0 1 9 10.5V9A4.5 4.5 0 0 1 13.5 4.5v.75m-6 5.25a3.75 3.75 0 0 1-7.5 0v-1.5a3.75 3.75 0 0 1 7.5 0v1.5Zm0 0V9A4.5 4.5 0 0 1 9 4.5v.75m-6 5.25v-1.5a3.75 3.75 0 0 1 7.5 0v1.5m0 0a9.043 9.043 0 0 1-4.125 2.122m-5.38-2.122a9.043 9.043 0 0 0 5.38 2.122m0 0a4.507 4.507 0 0 0 3.232 4.672M9 18.096c-1.07.246-2.193.396-3.375.45" />
                </svg>
                <span>Je suis un parent</span>
            </button>

            <button id="roleEnseignantBtn" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
                </svg>
                <span>Je suis un enseignant</span>
            </button>
        </div>
        <button id="closeRoleModalBtn" class="mt-8 text-sm text-slate-500 hover:underline">Annuler</button>
    </div>
</div>

    <footer class="text-center text-sm text-slate-500 py-6 space-y-2">
    <p>Application cr√©√©e par Thomas Cavil, enseignant au lyc√©e Benjamin Franklin</p>
    <div id="footer-privacy-link">
        <button onclick="showView('privacy')" class="font-semibold text-primary-action hover:underline">Politique de Confidentialit√©</button>
    </div>
</footer>

    <!-- Chatbot Floating Icon -->
<div id="chatbot-toggle" class="fixed bottom-6 right-6 bg-cyan-600 text-white w-16 h-16 rounded-full flex items-center justify-center cursor-pointer shadow-lg z-40">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
        <path fill-rule="evenodd" d="M9.315 7.584C12.195 3.883 16.695 1.5 21.75 1.5a.75.75 0 0 1 .75.75c0 5.056-2.383 9.555-6.084 12.436A6.75 6.75 0 0 1 9.75 22.5a.75.75 0 0 1-.75-.75v-4.131A15.838 15.838 0 0 1 6.382 15H2.25a.75.75 0 0 1-.75-.75 6.75 6.75 0 0 1 7.815-6.666ZM15 6.75a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5Z" clip-rule="evenodd" />
        <path d="M5.26 17.242a.75.75 0 1 0-.897-1.203 5.243 5.243 0 0 0-2.05 5.022.75.75 0 0 0 .625.627 5.243 5.243 0 0 0 5.022-2.051.75.75 0 1 0-1.202-.897 3.744 3.744 0 0 1-3.008 1.51c0-1.23.592-2.323 1.51-3.008Z" />
    </svg>        

    <!-- Chatbot Window -->
<div id="chatbot-container" class="fixed bottom-4 right-4 sm:bottom-24 sm:right-6 w-[calc(100%-2rem)] max-w-sm bg-white rounded-2xl shadow-xl border border-border-subtle z-50 flex flex-col 
    opacity-0 translate-y-4 pointer-events-none 
    transform-gpu transition-opacity transition-transform duration-300 ease-in-out">
    
    <div class="relative flex items-center p-4 border-b bg-background-light rounded-t-2xl">
<h3 class="w-full text-center font-bold text-OrIAntation-darkblue">ü§ñ OrIA, ton copilote</h3>
        <button id="chatbot-close" class="absolute right-4 text-slate-500 hover:text-OrIAntation-darkblue text-2xl">&times;</button>
    </div>

    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto chat-message-container"></div>

    <form id="chatbot-form" class="p-4 border-t flex items-center gap-2">
        <input type="text" id="chatbot-input" placeholder="Quelle est ta question ?" class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none text-slate-800">
        <button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
    </form>
</div>

    <!-- SDKs Firebase -->
    <script type="module">
       import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
       import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, deleteUser, sendEmailVerification, applyActionCode, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, where, getDocs, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";     
       import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";


const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition;
let activeDictationInput = null;
let isConversationModeActive = false;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'fr-FR';
    recognition.continuous = true;  // L'√©coute ne s'arr√™te pas apr√®s une phrase.
    recognition.interimResults = true; // Affiche les r√©sultats au fur et √† mesure.

    recognition.onresult = (event) => {
        let final_transcript = '';
        let interim_transcript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                final_transcript += event.results[i][0].transcript;
            } else {
                interim_transcript += event.results[i][0].transcript;
            }
        }
        
        // Affiche la transcription en temps r√©el dans le champ
        if (activeDictationInput && interim_transcript) {
            activeDictationInput.value = final_transcript + interim_transcript;
        }

        // Une fois que l'utilisateur a fini de parler, on envoie la question
        if (activeDictationInput && final_transcript) {
            activeDictationInput.value = final_transcript.trim();
            // Simule l'envoi du formulaire de chat si c'est bien ce champ qui est actif
            if (activeDictationInput.id === 'simulation-input') {
                const form = activeDictationInput.closest('form');
                if (form) {
                    form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                }
            }
        }
    };

    recognition.onerror = (event) => {
        console.error("Erreur de reconnaissance vocale : ", event.error);
        isConversationModeActive = false; // Stoppe le mode en cas d'erreur
        document.querySelectorAll('.mic-dictation-btn.is-listening').forEach(btn => btn.classList.remove('is-listening'));
    };

    recognition.onend = () => {
    // La relance se fait maintenant UNIQUEMENT via audioPlayer.onended
    console.log("Reconnaissance vocale termin√©e.");
    
    // On s'assure simplement que l'ic√¥ne est bien d√©sactiv√©e si le mode n'est plus actif
    if (!isConversationModeActive) {
         document.querySelectorAll('.mic-dictation-btn.is-listening').forEach(btn => btn.classList.remove('is-listening'));
    }
};
}


// DANS LA BALISE <script type="module"> de index.html

function addVoiceDictationToInputs() {
    if (!SpeechRecognition) return;

    const inputs = document.querySelectorAll('input[type="text"]:not([readonly]), textarea:not([readonly])');

    inputs.forEach(input => {
        if (input.parentElement.classList.contains('voice-input-wrapper')) return;

        const micBtn = document.createElement('button');
        micBtn.type = 'button';
        micBtn.className = 'mic-dictation-btn';
        micBtn.title = "Activer/D√©sactiver le mode conversation";
        micBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>`;

        const wrapper = document.createElement('div');
        wrapper.className = 'relative voice-input-wrapper flex-1';
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);
        wrapper.appendChild(micBtn);

        micBtn.addEventListener('click', () => {
            if (isConversationModeActive) {
                // Si on clique alors que c'est actif, on arr√™te tout.
                isConversationModeActive = false;
                recognition.stop();
                micBtn.classList.remove('is-listening');
            } else {
                // Si on clique alors que c'est inactif, on d√©marre.
                isConversationModeActive = true;
                activeDictationInput = input;
                recognition.start();
                micBtn.classList.add('is-listening');
            }
        });
    });
}



       const firebaseConfig = {
            apiKey: "AIzaSyCT6U-7Az53oYCPZWHo3Dvxs20XiR0y3EU",
            authDomain: "monapp0rientation.firebaseapp.com",
            projectId: "monapp0rientation",
            storageBucket: "monapp0rientation.firebasestorage.app",
            messagingSenderId: "369432089475",
            appId: "1:369432089475:web:689a194b6880001c249cb6"
        };

        const approvedTeacherDomains = [
        'ac-aix-marseille.fr','ac-amiens.fr','ac-besancon.fr','ac-bordeaux.fr','ac-clermont.fr',
        'ac-corse.fr','ac-creteil.fr','ac-dijon.fr','ac-grenoble.fr','ac-lille.fr','ac-limoges.fr',
        'ac-lyon.fr','ac-montpellier.fr','ac-nancy-metz.fr','ac-nantes.fr','ac-nice.fr','ac-normandie.fr',
        'ac-caen.fr','ac-rouen.fr','ac-orleans-tours.fr','ac-paris.fr','ac-poitiers.fr','ac-reims.fr',
        'ac-rennes.fr','ac-strasbourg.fr','ac-toulouse.fr','ac-versailles.fr','ac-guadeloupe.fr',
        'ac-guyane.fr','ac-martinique.fr','ac-mayotte.fr','ac-reunion.fr','education.gouv.fr'
    ];

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);
        const functions = getFunctions(firebaseApp, "europe-west3"); 
        const authContainer = document.getElementById('authContainer');
        const mainApp = document.getElementById('mainApp');

        const IS_DEV_MODE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        let step1DocumentClickListeners = [];
        let isNewUserFlow = false;



        function devLog(...args) {
  if (IS_DEV_MODE) {
    console.log('%c[DEV]', 'color: #7c3aed; font-weight: bold;', ...args);
  }
}


const PERSONA_IA = `
# R√¥le et Identit√©
Tu es "OrIA", le copilote IA de l'application d'orientation "OrIAntation". Tu t'adresses √† des lyc√©ens fran√ßais (15-18 ans) qui cherchent √† construire leur projet d'avenir.

# Philosophie de Coaching (Ta Mission Fondamentale)
- **Tu es un guide, pas un oracle.** Ta mission n'est PAS de donner des r√©ponses toutes faites, mais d'aider l'√©l√®ve √† se poser les bonnes questions et √† prendre des d√©cisions √©clair√©es.
- **De la connaissance de soi √† l'action.** Ton coaching part toujours de l'√©l√®ve pour l'aider √† explorer les possibilit√©s, puis le pousser √† se confronter au r√©el.
- **Tu es un copilote, pas le pilote.** L'√©l√®ve reste toujours ma√Ætre de ses d√©cisions.
- **Tu es bienveillant(e) et r√©aliste.** Tu encourages l'ambition tout en rappelant l'importance de construire un projet solide.

# R√®gle sur l'√âventail des Possibles (TR√àS IMPORTANT)
- **Constat :** Tu as tendance √† te concentrer sur les √©tudes courtes et techniques (BTS, BUT) et les secteurs industriels.
- **Ordre :** Tu dois imp√©rativement √©largir tes suggestions pour couvrir l'ensemble du champ des possibles. Pour chaque suggestion de domaine ou de m√©tier, tu dois syst√©matiquement envisager et proposer un √©quilibre entre :
    1.  Les √©tudes courtes et professionnalisantes (BTS, BUT...).
    2.  Les parcours universitaires (Licence, Master...).
    3.  Les √©coles sp√©cialis√©es (ing√©nieurs, commerce, art, etc.).
    4.  Les classes pr√©paratoires aux grandes √©coles (CPGE).

# Guide de Style et de Ton (R√®gles Imp√©ratives)
- **Ton :** P√©dagogique, encourageant, bienveillant, l√©g√®rement d√©contract√© mais toujours cr√©dible et expert. Le tutoiement est syst√©matique.
- **Vocabulaire INTERDIT :** N'utilise JAMAIS de jargon d'entreprise (livrable, deadline, prototype, etc.).
- **Vocabulaire AUTORIS√â :** Parle de "devoirs", "fiches de r√©vision", "plan de travail", "√©ch√©ances", "brouillon".
- **Contexte :** Ancre tes conseils dans la r√©alit√© du lyc√©e fran√ßais.

# R√®gle de Diversit√© (Contre-Biais)
- Contre activement ton biais naturel vers les m√©tiers de la tech. Pense syst√©matiquement √† inclure des pistes dans des secteurs vari√©s comme l'artisanat, les arts, le service public, la sant√©, l'environnement, le droit et les sciences humaines.
`;

function extractJsonFromString(str) {
    if (!str) return null;

    // NOUVELLE √âTAPE : On nettoie les balises de bloc de code ```json
    let cleanedStr = str.trim();
    if (cleanedStr.startsWith("```json")) {
        cleanedStr = cleanedStr.substring(7); // Enl√®ve "```json"
    }
    if (cleanedStr.endsWith("```")) {
        cleanedStr = cleanedStr.substring(0, cleanedStr.length - 3); // Enl√®ve "```"
    }
    cleanedStr = cleanedStr.trim(); // Re-nettoie les espaces potentiels

    // On cherche le d√©but d'un tableau '[' ou d'un objet '{'
    const jsonStartBracket = cleanedStr.indexOf('[');
    const jsonStartBrace = cleanedStr.indexOf('{');
    
    let jsonStart = -1;
    
    // On d√©termine quel type de JSON on a (tableau ou objet)
    if (jsonStartBracket > -1 && jsonStartBrace > -1) {
        jsonStart = Math.min(jsonStartBracket, jsonStartBrace);
    } else if (jsonStartBracket > -1) {
        jsonStart = jsonStartBracket;
    } else {
        jsonStart = jsonStartBrace;
    }

    // On d√©termine la fin correspondante
    const isArray = jsonStart === jsonStartBracket;
    const jsonEnd = cleanedStr.lastIndexOf(isArray ? ']' : '}') + 1;

    if (jsonStart === -1 || jsonEnd === 0) {
        return null;
    }

    const jsonString = cleanedStr.substring(jsonStart, jsonEnd);
    try {
        return JSON.parse(jsonString);
    } catch (error) {
        console.error("Impossible d'analyser le JSON extrait:", error);
        return null;
    }
}

// NOUVELLE FONCTION : Sauvegarde l'abonnement dans Firestore via une Cloud Function
       async function saveSubscriptionToFirestore(subscription) {
           if (!currentUserId) return;
           try {
               const saveSubscription = httpsCallable(functions, 'savePushSubscription');
           await saveSubscription({ subscription: subscription.toJSON() });
               devLog("Abonnement Push enregistr√© avec succ√®s !");
           } catch (error) {
               console.error("Erreur lors de la sauvegarde de l'abonnement :", error);
           }
       }

       // NOUVELLE FONCTION : Met en place tout le processus d'abonnement
       async function setupPushNotifications() {
           if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
               devLog("Notifications Push non support√©es par ce navigateur.");
               return;
           }
           try {
               const registration = await navigator.serviceWorker.register('/sw.js');
               devLog('Service Worker enregistr√© !', registration);
               const permission = await Notification.requestPermission();
               if (permission !== 'granted') {
                   devLog("Permission de notification refus√©e.");
                   return;
               }
               let subscription = await registration.pushManager.getSubscription();
               if (subscription === null) {
                   devLog("Aucun abonnement trouv√©, on en cr√©e un nouveau.");
                   const vapidPublicKey = 'BNCDYwj7YAiREgh5LbW9vPqA4NXmBpDQDzk9oWk6K-Wkt05ibaELJIKdhB2aRff2QxZ90DiXUJjBUmXdWyimZPM'; // ‚ö†Ô∏è N'OUBLIEZ PAS DE LA REMPLACER !
                   subscription = await registration.pushManager.subscribe({
                       userVisibleOnly: true,
                       applicationServerKey: vapidPublicKey,
                   });
               }
               await saveSubscriptionToFirestore(subscription);
           } catch (error) {
               console.error('√âchec de la mise en place des notifications Push :', error);
           }
       }

(async () => {
    const params = new URLSearchParams(window.location.search);
    const mode = params.get('mode');
    const actionCode = params.get('oobCode');
    const shareId = params.get('share_id');
    const shareToken = params.get('token');

    // Priorit√© 1 : Si c'est un lien de PARTAGE, on l'affiche et on arr√™te tout.
    if (shareId && shareToken) {
        authContainer.style.display = 'none';
        mainApp.style.display = 'block';
        document.querySelector('footer').style.display = 'none';
        document.querySelector('#chatbot-toggle').style.display = 'none';
        createPublicShareView(shareId, shareToken);
        return; 
    }

    // Priorit√© 2 : Si c'est un lien de V√âRIFICATION D'EMAIL
    if (mode === 'verifyEmail' && actionCode) {
        try {
            await applyActionCode(auth, actionCode);
            // Succ√®s ! On affiche un message puis on redirige vers l'application.
            document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; text-align: center; padding: 20px; font-family: sans-serif;"><h1 style="font-size: 1.875rem; font-weight: bold; color: #1A3263;">V√©rification r√©ussie ! ‚úÖ</h1><p style="color: #4A5568; margin-top: 1rem;">Votre compte est maintenant activ√©. Redirection en cours...</p></div>`;
            // On attend 2.5 secondes pour que l'utilisateur lise, puis on recharge la page √† sa racine.
            setTimeout(() => {
                window.location.href = window.location.pathname;
            }, 2500);
        } catch (error) {
            // Erreur ! Le lien est probablement expir√©. On affiche un message et on ferme.
            console.error("Erreur de v√©rification:", error);
            document.body.innerHTML = `<div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; text-align: center; padding: 20px; font-family: sans-serif;"><h1 style="font-size: 1.875rem; font-weight: bold; color: #991B1B;">Erreur</h1><p style="color: #4A5568; margin-top: 1rem;">Ce lien de v√©rification est invalide ou a d√©j√† √©t√© utilis√©. Cet onglet va se fermer.</p></div>`;
            setTimeout(() => { window.close(); }, 4000);
        }
        return; // On arr√™te l'ex√©cution ici pour ne pas lancer le flux normal.
    }

    // Priorit√© 3 : Si c'est un lien de R√âINITIALISATION DE MOT DE PASSE
    if (mode === 'resetPassword' && actionCode) {
        showResetPasswordView(actionCode);
        return; 
    }

    // Si aucune des conditions sp√©ciales n'est remplie, on lance le FLUX NORMAL de l'application.
    initializeNormalAppFlow();

})();



        const levelConfig = {
            1: 0,
            2: 100,
            3: 250,
            4: 500,
            5: 800,
            6: 1200,
            7: 1700,
            8: 2300,
            9: 3000,
            10: 4000
        };

        const rankNames = {
            1: { homme: "Initi√©", femme: "Initi√©e", autre: "Initi√©(e)" },
            2: { homme: "Apprenti", femme: "Apprentie", autre: "Apprenti(e)" },
            3: { homme: "Curieux", femme: "Curieuse", autre: "Curieux/se" },
            4: { homme: "Explorateur", femme: "Exploratrice", autre: "Explorateur/rice" },
            5: { homme: "Strat√®ge", femme: "Strat√®ge", autre: "Strat√®ge" },
            6: { homme: "Analyste", femme: "Analyste", autre: "Analyste" },
            7: { homme: "Sp√©cialiste", femme: "Sp√©cialiste", autre: "Sp√©cialiste" },
            8: { homme: "Expert", femme: "Experte", autre: "Expert(e)" },
            9: { homme: "Mentor", femme: "Mentor", autre: "Mentor" },
            10: { homme: "Ma√Ætre de l'Orientation", femme: "Ma√Ætresse de l'Orientation", autre: "Ma√Ætre de l'Orientation" }
        };

        const creativeAngles = [
            "un m√©tier en lien avec la nature ou l'environnement.",
            "une carri√®re dans le secteur du jeu vid√©o ou du divertissement interactif.",
            "un r√¥le qui implique des voyages ou des relations internationales.",
            "un m√©tier artisanal ou qui demande un savoir-faire manuel de pr√©cision.",
            "une profession dans le domaine social ou humanitaire.",
            "un m√©tier de la communication ou du journalisme.",
            "une carri√®re dans le secteur du luxe ou de la mode.",
            "un r√¥le dans le domaine du sport et du bien-√™tre.",
            "un m√©tier scientifique ou de recherche fondamentale.",
            "une profession li√©e au droit ou √† la justice.",
            "une carri√®re dans le secteur de la finance ou de l'√©conomie.",
            "un m√©tier dans l'√©v√©nementiel ou le tourisme.",
            "un r√¥le dans la tech qui n'est pas purement du code (ex: UX Designer, Chef de Produit).",
            "un m√©tier du secteur public ou de l'administration.",
            "une profession artistique ou culturelle."
        ];

        const statusOptions = {
            a_contacter: "√Ä contacter",
            contacte: "Contact√©",
            reponse_recue: "R√©ponse re√ßue",
            entretien_prevu: "Entretien pr√©vu"
        };


const allSteps = [
    // Cat√©gorie : Le Tableau de Bord (Acc√®s Rapide)
    { 
        id: 'journal', category: 'dashboard',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg>`, 
        title: 'Mon Journal de Bord', 
        site: 'Consulte tes notes', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'retroplanning', category: 'dashboard',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg>`, 
        title: 'Mon R√©troplanning', 
        site: 'Outil', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step0', category: 'dashboard',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>`, 
        title: 'Mieux se conna√Ætre', 
        site: 'Point de d√©part', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    // Cat√©gorie : Explorer les Possibilit√©s
    { 
        id: 'step2', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>`, 
        title: 'Le simulateur de sp√©cialit√©s', 
        site: 'Horizons21', 
        levels: ['seconde', 'premiere'] 
    },
    { 
        id: 'step1', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg>`, 
        title: 'Les Fondations', 
        site: 'Onisep', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step3', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>`, 
        title: 'Le Catalogue', 
        site: 'Parcoursup', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
        id: 'step5', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg>`, 
        title: 'L\'Actu', 
        site: 'L\'√âtudiant & Co', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
      { 
        id: 'step7', category: 'explore',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`, 
        title: 'Fact Checking', 
        site: 'Jeu interactif', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },

    // Cat√©gorie : Se Connecter au Monde R√©el
    { 
        id: 'step4', category: 'connect',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg>`, 
        title: 'L\'Exp√©rience', 
        site: 'Entretien avec des √©tudiants √©claireurs', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },
    { 
    id: 'step8', category: 'connect',
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg>`, 
    title: 'L\'Entretien Professionnel', 
    site: 'Pr√©paration & Simulation', 
    levels: ['seconde', 'premiere', 'terminale'] 
},
    { 
        id: 'step11', category: 'connect',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>`, 
        title: 'Rencontres sur mon Territoire', 
        site: 'Ressources locales', 
        levels: ['seconde', 'premiere', 'terminale'] 
    },

    // Cat√©gorie : Construire sa Candidature
    { 
    id: 'step10', category: 'build',
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg>`, 
    title: 'Mon Portfolio de Comp√©tences', 
    site: 'Valorisation', 
    levels: ['seconde', 'premiere', 'terminale'] 
},
    { 
        id: 'step6', category: 'build',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`, 
        title: 'Pr√©parer sa candidature', 
        site: 'Projet motiv√©', 
        levels: ['terminale'] 
    },
    { 
        id: 'step12', category: 'build',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`, 
        title: 'Simulateur Vie √âtudiante', 
        site: 'Budget & Aides', 
        levels: ['premiere', 'terminale'] 
    },
    { 
        id: 'step9', category: 'build',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg>`, 
        title: 'Anticiper la suite', 
        site: 'Plan B & R√©ussite', 
        levels: ['terminale'] 
    },
    { 
    id: 'step13', category: 'build',
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-cyan-700"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg>`, 
    title: 'Mon Stage de Seconde', 
    site: 'Recherche & Bilan', 
    levels: ['seconde'] 
},

];

        
        const stepsConfig = {
    step0: { 
        stepKey: 'step0', title: 'Mieux se conna√Ætre', 
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>`,
        description: `Toute bonne orientation commence par une bonne connaissance de soi. R√©ponds honn√™tement √† ces quelques questions pour d√©gager tes grandes tendances et obtenir une premi√®re analyse de ton profil.`,
        action: `<b>Ta mission :</b> R√©ponds au questionnaire pour que OrIA dresse ton portrait psychologique et r√©v√®le ton <b>Arch√©type de personnalit√©</b>. Pour une analyse encore plus fine, tu pourras ensuite, si tu le souhaites, utiliser le module "Pour aller plus loin" en bas de page pour croiser ces r√©sultats avec ceux de tests externes.`
    },
    step1: {
    stepKey: 'step1', 
    title: "Les Fondations avec l'Onisep", 
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg>`,
    description: `L'Onisep est le service public de l'√âducation Nationale. C'est LA r√©f√©rence pour une information objective et compl√®te. Cet outil est ton laboratoire pour explorer des pistes de m√©tiers, une par une, et sauvegarder celles qui t'int√©ressent.`,
    action: `<b>Ta mission :</b> Utilise l'atelier "Exploration en cours" pour rechercher un m√©tier. Sers-toi des boutons d'analyse (‚ú®, üìÖ, üé¨) pour approfondir ta connaissance. Si la piste te semble int√©ressante, enregistre-la dans ton journal. Tu pourras ainsi accumuler tes trouvailles au fil du temps et utiliser le comparateur lorsque tu auras sauvegard√© au moins deux m√©tiers !`,
    urls: [ { site: "MonOrientationEnLigne.fr", url: 'https://www.monorientationenligne.fr/' } ],
    // Nous n'avons plus besoin de la cl√© "fields" ici
},
    step2: { 
    stepKey: 'step2', title: "Le simulateur de sp√©cialit√©s Horizons21",
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>`,

    description: `Cet outil a √©t√© cr√©√© pour t'aider √† faire le lien entre les sp√©cialit√©s du lyc√©e et les √©tudes sup√©rieures. <b>Int√©r√™t principal :</b> Comprendre l'impact de tes choix de mati√®res sur ton avenir et pr√©parer tes choix pour l'ann√©e suivante.`,
    
    // NOUVEAU BLOC
action: `<b>Ta mission :</b> Utilise l'atelier pour explorer des combinaisons de sp√©cialit√©s quue tu souhaites tester. Pour chaque combinaison, note les horizons qu'elle ouvre, puis utilise les boutons d'analyse (‚ú®, üó£Ô∏è) pour obtenir des retours personnalis√©s. Enregistre ensuite tes explorations dans ton journal. D√®s que tu auras sauvegard√© au moins deux combinaisons, un comparateur appara√Ætra !`,

    url: 'https://www.horizons21.fr', site: 'Horizons21.fr',
    },
    step3: {
        stepKey: 'step3', title: 'Le Catalogue Parcoursup',
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>`, description: `Bien plus qu'un site d'inscription, c'est le moteur de recherche le plus exhaustif sur les formations post-bac. <b>Ce qu'il faut absolument regarder :</b> les "attendus", la carte interactive, et les chiffres cl√©s (taux d'acc√®s, etc.).`,
// NOUVEAU TEXTE
action: `<b>Ta mission :</b> Utilise l'atelier ci-dessous pour explorer les formations qui t'int√©ressent, une par une. Pour chaque piste, recherche la formation, copie-colle ses "attendus" puis utilise les boutons d'analyse (üîé, ‚ú®) pour obtenir des retours personnalis√©s. Lorsque tu es satisfait, enregistre ta trouvaille dans ton journal pour la conserver. D√®s que tu auras enregistr√© au moins deux formations, un comparateur appara√Ætra pour t'aider √† les mettre en balance !`,        url: 'https://dossier.parcoursup.fr/Candidat/carte', site: 'Parcoursup.fr',
    fields: [
        {id: 'formation1', label: 'Formation #1', placeholder: 'Ex: BUT Informatique - Villetaneuse'},
        {id: 'attendus1', label: 'Attendus et crit√®res importants', placeholder: 'Bon niveau en maths, projet motiv√©...', type: 'textarea'},
        {id: 'compatibilite1', label: 'Rapport de compatibilit√©', type: 'textarea', isReadonly: true},
        {id: 'mots_cles1', label: 'D√©fi : Tes 3 mots-cl√©s pour cette formation', placeholder: 'Ex: Logique, programmation, travail d\'√©quipe'},
        {id: 'analyse_mots_cles1', label: 'Analyse de tes mots-cl√©s par l\'IA', type: 'textarea', isReadonly: true},
        {id: 'formation2', label: 'Formation #2', placeholder: 'Ex: Licence de Droit - Assas'},
        {id: 'attendus2', label: 'Attendus et crit√®res importants', placeholder: 'Qualit√©s r√©dactionnelles, logique...', type: 'textarea'},
        {id: 'compatibilite2', label: 'Rapport de compatibilit√©', type: 'textarea', isReadonly: true},
        {id: 'mots_cles2', label: 'D√©fi : Tes 3 mots-cl√©s pour cette formation', placeholder: 'Ex: Rigueur, r√©daction, argumentation'},
        {id: 'analyse_mots_cles2', label: 'Analyse de tes mots-cl√©s par l\'IA', type: 'textarea', isReadonly: true},
        {id: 'suggestions', label: 'Pistes de r√©flexion sugg√©r√©es par l\'IA', type: 'textarea', isReadonly: true}
    ]
},
    step4: {
    stepKey: 'step4', 
    title: "L'Exp√©rience avec Inspire",     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg>`,
    description: `Cette plateforme te permet de discuter avec des √©tudiants "√©claireurs". <b>Int√©r√™t principal :</b> Obtenir un retour d'exp√©rience authentique et humain, au-del√† des plaquettes officielles (ambiance, charge de travail, vie √©tudiante...).`,
    action: "<b>Ta mission :</b> Utilise l'atelier pour pr√©parer tes √©changes. Pour chaque th√®me, pose une question de base, puis utilise le bouton ‚ú® pour obtenir des suggestions de questions plus pertinentes. Enregistre tes pr√©parations dans ton journal.",
    url: 'https://www.inspire-orientation.org', 
    site: 'Inspire-orientation.org'
},

step5: {
    stepKey: 'step5', title: "L'Actu",     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg>`,
    description: `Des m√©dias comme L'√âtudiant.fr ou Studyrama.com apportent un autre regard sur le monde des √©tudes et des m√©tiers. <b>Ce que tu peux y trouver :</b> des classements, des articles sur des secteurs qui recrutent, et des dossiers sur des fili√®res.`,
    action: `<b>Ta mission :</b> Utilise l'atelier pour sauvegarder les articles, classements ou infos que tu trouves. Pour chaque trouvaille, note ce que tu as appris, puis utilise le bouton ‚ú® pour que OrIA l'analyse par rapport √† ton profil.`,
    urls: [
        { site: "L'√âtudiant.fr", url: 'https://www.letudiant.fr' },
        { site: "Studyrama.com", url: 'https://www.studyrama.com' }
    ]
},

    step6: { 
    stepKey: 'step6', title: 'Pr√©parer sa candidature',     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`,
    description: `La r√©daction du "projet de formation motiv√©" sur Parcoursup est une √©tape cruciale. Cet outil ne va pas √©crire la lettre √† ta place, mais t'aider √† la structurer de mani√®re claire et percutante.`,
    action: `<b>Ta mission :</b> Utilise le nouvel <b>Atelier du R√©viseur de Projet</b>. Pour chaque formation que tu vises, √©cris ou colle un premier brouillon complet de ton texte. Clique ensuite sur le bouton <b>"üîç Lancer la relecture critique"</b>. OrIA ne r√©√©crira pas ton texte, mais te fournira des annotations et des conseils cibl√©s pour que tu puisses l'am√©liorer toi-m√™me. Une fois que tu es satisfait, n'oublie pas de cliquer sur <b>"üíæ Enregistrer ce projet de candidature"</b> pour conserver ton travail dans ton journal.`
    
 },
   step7: {
    stepKey: 'step7', 
    title: 'Fact Checking',     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`,
    
    // Description mise √† jour
    description: `Dans le monde de l'orientation, il est crucial de savoir d√©m√™ler le vrai du faux. Cette √©tape te propose trois ateliers pour aiguiser ton esprit critique.`,
    
    // Mission mise √† jour
    action: `<b>Ta mission :</b> Choisis l'un des trois ateliers ci-dessous. Le "Vrai ou Faux" teste tes connaissances, le "D√©fi Personnalis√©" confronte ton profil aux id√©es re√ßues, et "Trouvez l'Intrus" met au d√©fi ta capacit√© √† d√©celer la fausse information.`,
    
    fields: []
},
    step8: { 
    stepKey: 'step8', 
    title: 'L\'Entretien Professionnel',     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-azimut-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg>`,
    description: `Apr√®s la recherche vient le contact. Des plateformes comme MyJobGlasses te permettent de discuter directement avec des milliers de professionnels. Cette √©tape est ton centre d'entra√Ænement pour pr√©parer ces √©changes cruciaux.`,
    action: `<b>Ta mission :</b> Utilise l'atelier pour pr√©parer tes questions pour un professionnel ou un secteur qui t'int√©resse. Entra√Æne-toi ensuite avec le simulateur pour arriver confiant le jour J. Enregistre tes pr√©parations pour les retrouver dans ton journal.`
},

    step9: { 
        stepKey: 'step9', title: 'Anticiper la suite',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg>`,

        description: `L'orientation ne s'arr√™te pas aux r√©usltats de Parcoursup. Cette √©tape t'aide √† te pr√©parer pour la suite : que faire si tous tes voeux ont √©t√© refus√©s ou si tu as chang√© d'avis ? Ou comment bien d√©marrer ta premi√®re ann√©e dans le sup√©rieur ?`,
        action: "<b>Ta mission :</b> Utilise les deux outils ci-dessous. Le premier t'aide √† construire un plan B solide. Le second te donne des conseils pour r√©ussir ta future premi√®re ann√©e.",
        fields: [
            {id: 'formation_reve', label: 'Ma formation "r√™v√©e" (V≈ìu n¬∞1)', placeholder: 'Ex: Classe pr√©pa MPSI au Lyc√©e Louis-le-Grand'},
            {id: 'plan_b', label: 'Suggestions de "Plan B" par l\'IA', type: 'textarea', isReadonly: true },
            {id: 'reussite_type', label: 'Type de formation pour lequel tu veux des conseils', placeholder: 'Ex: Licence de Droit, BUT, Classe Pr√©pa...'},
            {id: 'reussite_conseils', label: 'Conseils de r√©ussite par l\'IA', type: 'textarea', isReadonly: true }
        ]
    },
   step10: { 
        stepKey: 'step10', title: 'Mon Portfolio de Comp√©tences',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg>`,

        description: `Cette √©tape te propose deux ateliers compl√©mentaires pour cr√©er un portfolio qui te ressemble vraiment. Le premier t'aide √† transformer tes exp√©riences concr√®tes (stage, projet, passion, job...) en comp√©tences valorisables pour tes candidatures. Le second est un 'd√©tecteur' rapide qui te permet de r√©v√©ler tes grandes comp√©tences transversales (ta mani√®re de travailler, de r√©fl√©chir...). L'ensemble te donnera une vision claire et unique de tes atouts.`,
        action: `<b>Ta mission est double :</b><br>
        1. <b>Raconter tes exp√©riences :</b> Clique sur le bouton "+ Ajouter une exp√©rience" et laisse-toi guider. Raconte ce que tu as fait, et OrIA t'aidera √† en extraire les comp√©tences cl√©s pour Parcoursup.<br>
        2. <b>R√©v√©ler ton profil :</b> Lance le "d√©tecteur de comp√©tences" et r√©ponds aux quelques questions. Tu obtiendras une analyse de tes savoir-√™tre dominants (Rigueur, Cr√©ativit√©, Leadership...).`,
        fields: []
    },
    step11: { 
        stepKey: 'step11', title: 'Rencontres sur mon Territoire',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>`,

        description: `L'orientation se nourrit aussi de rencontres r√©elles. Utilise cet outil pour trouver des √©v√©nements et des structures d'aide pr√®s de chez toi.`,
        action: "<b>Ta mission :</b> Indique ta ville ou ton d√©partement, puis lance les recherches pour trouver les prochaines opportunit√©s de rencontres et les lieux d'information locaux.",
        fields: [
            {id: 'location', label: 'Ta ville ou ton d√©partement', placeholder: 'Ex: Land√©vant ou Morbihan'}
        ]
    },
    step12: { 
        stepKey: 'step12', title: 'Simulateur Vie √âtudiante',     
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>`,

        description: `Choisir ses √©tudes, c'est aussi choisir un cadre de vie et un budget. Utilise cet outil pour estimer le co√ªt de la vie dans la ville de ton choix et pour d√©couvrir les principales aides financi√®res auxquelles tu pourrais pr√©tendre.`,
        action: `<b>Ta mission :</b> Renseigne une ville, puis lance les simulateurs pour obtenir une estimation de budget et des pistes pour les bourses.`,
        fields: []
    },

    // ... dans la constante stepsConfig
step13: { 
    stepKey: 'step13', 
    title: 'Mon Stage de Seconde',     
    icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" /></svg>`,
    description: `Le stage d'observation de fin de Seconde est bien plus qu'une simple semaine de d√©couverte : c'est souvent ton tout premier pas dans le monde professionnel. C'est une occasion unique de mener ta propre enqu√™te de terrain pour confirmer une piste, en invalider une autre, ou d√©couvrir un univers auquel tu n'avais jamais pens√©. Chaque observation est une information pr√©cieuse que tu pourras ensuite transformer en un atout majeur pour ton Portfolio de Comp√©tences et tes futures candidatures.`,  
    action: `<b>Ta mission :</b> Utilise le premier atelier pour trouver des pistes et des id√©es. Une fois ton stage termin√©, reviens ici et utilise le second atelier pour r√©diger ton rapport et, surtout, pour transformer cette exp√©rience en comp√©tences concr√®tes pour ton Portfolio.`,
    fields: []
},
};


const badgesConfig = {
    explorateur: {
        icon: 'üõ∞Ô∏è',
        title: "Pionnier Num√©rique",
        description: "D√©cern√© pour avoir lanc√© l'exploration et scann√© les donn√©es fondamentales de ton profil.",
        criteria: (level) => {
            // R√àGLE CORRIG√âE ET ASSOUPLIE : On v√©rifie que les √©tapes sont bien COMMENC√âES.
            const step0Started = journalData.step0 && journalData.step0.analysis && journalData.step0.analysis.trim() !== '';
            const step1Started = isStepStarted('step1');
            const step2or3Started = level === 'seconde' ? isStepStarted('step2') : isStepStarted('step3');
            return step0Started && step1Started && step2or3Started;
        }
    },

     pilote: {
        icon: 'üéì',
        title: "Pilote Certifi√©",
        description: "F√©licitations ! Tu as termin√© le parcours d'initiation et ma√Ætrises les outils de base pour prendre les commandes de ton orientation.",
        criteria: () => {
            // La r√®gle est simple : le badge est obtenu quand le tutoriel est marqu√© comme termin√©.
            return journalData.tutorial_completed === true;
        }
    },
    
    stratege: {
    icon: 'üí†',
    title: "Architecte Strat√©gique",
    description: "D√©cern√© pour avoir trait√© les informations afin de b√¢tir un plan d'avenir et des sc√©narios alternatifs.",
    criteria: () => {
        // On v√©rifie maintenant si le tableau de t√¢ches existe et n'est pas vide.
        const retroplanningComplete = journalData.retroplanning && Array.isArray(journalData.retroplanning.tasks) && journalData.retroplanning.tasks.length > 0;
        const step9Complete = isStepComplete('step9');
        return retroplanningComplete && step9Complete;
    }
},
    connecteur: {
        icon: 'üåê',
        title: "Hub R√©seau",
        description: "D√©cern√© pour avoir √©tabli les premiers n≈ìuds de ton r√©seau professionnel en contactant le monde r√©el.",
        criteria: () => {
            // R√àGLE CORRIG√âE : On v√©rifie la nouvelle liste de contacts.
            return journalData.step8 && journalData.step8.contacts && journalData.step8.contacts.length > 0;
        }
    },
    artisan: {
        icon: 'üß¨',
        title: "D√©veloppeur de Profil",
        description: "D√©cern√© pour avoir d√©cod√© tes exp√©riences et assembl√© l'ADN de tes comp√©tences dans un portfolio.",
        criteria: () => {
            return journalData.step10 && journalData.step10.skills_synthesis && journalData.step10.skills_synthesis.trim() !== '';
        }
    },
    analyste: {
        icon: 'üìà',
        title: "Analyste de Donn√©es",
        description: "D√©cern√© pour avoir crois√© les donn√©es de Parcoursup avec ton profil pour en extraire des tendances.",
        criteria: () => {
            return journalData.step3 && (
                (journalData.step3.compatibilite1 && journalData.step3.compatibilite1.trim() !== '') || 
                (journalData.step3.compatibilite2 && journalData.step3.compatibilite2.trim() !== '')
            );
        }
    },
    verificateur: {
        icon: 'üõ°Ô∏è',
        title: "D√©bugueur de Mythes",
        description: "D√©cern√© pour avoir s√©curis√© ton projet en d√©construisant les id√©es re√ßues avec l'outil Fact Checking.",
        criteria: () => {
            return journalData.step7 && journalData.step7.scores && Object.keys(journalData.step7.scores).length > 0 && Object.values(journalData.step7.scores).some(history => history.length > 0);
        }
    }
};

function promptShareRole() {
    return new Promise((resolve) => {
        const modalId = 'role-choice-modal';
        const existingModal = document.getElementById(modalId);
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';

        modal.innerHTML = `
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">√Ä qui souhaites-tu partager ?</h2>
                <p class="text-slate-600 mb-8">Le ton du message sera adapt√© au destinataire.</p>
                <div class="space-y-4">
                    <button id="share-for-parent" class="w-full bg-sky-600 text-white font-semibold py-3 rounded-lg hover:bg-sky-700 transition">Pour un proche (parent, tuteur...)</button>
                    <button id="share-for-teacher" class="w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 transition">Pour un enseignant</button>
                </div>
                <button id="share-cancel" class="mt-8 text-sm text-slate-500 hover:underline">Annuler</button>
            </div>
        `;
        document.body.appendChild(modal);

        const closeModal = () => modal.remove();

        modal.querySelector('#share-for-parent').addEventListener('click', () => {
            closeModal();
            resolve('parent');
        });
        modal.querySelector('#share-for-teacher').addEventListener('click', () => {
            closeModal();
            resolve('enseignant');
        });
        modal.querySelector('#share-cancel').addEventListener('click', () => {
            closeModal();
            resolve(null); // On r√©sout avec null si l'utilisateur annule
        });
    });
}

function showShareMessageModal(shareLink, studentFirstName, role) {
    const title = "Partage ton Journal de Bord !";
    let messageTemplate = '';

    if (role === 'parent') {
        messageTemplate = `Bonjour [Nom du proche],

Comme on en a parl√©, j'utilise une application qui s'appelle OrIAntation pour construire mon projet d'orientation. J'aimerais beaucoup avoir ton avis.

J'ai activ√© le partage de mon 'Journal de Bord'. √áa te donnera une vue d'ensemble de ma r√©flexion et des pistes que j'explore.

Voici le lien unique et s√©curis√© pour le consulter :
${shareLink}

On pourra en discuter quand tu auras un moment !

√Ä bient√¥t,
${studentFirstName}`;
    } else { // role === 'enseignant'
        messageTemplate = `Bonjour Monsieur/Madame [Nom de l'enseignant],

Dans le cadre de mon travail sur mon projet d'orientation avec l'outil OrIAntation, je vous partage l'acc√®s √† mon Journal de Bord.

Votre avis et vos conseils sur ma d√©marche seraient tr√®s pr√©cieux pour m'aider √† avancer.

Voici le lien s√©curis√© pour le consulter :
${shareLink}

En vous remerciant pour votre aide,
Cordialement,
${studentFirstName}`;
    }

    const contentHTML = `
        <p class="text-slate-600 mb-4">Voici un message pr√©-rempli. N'oublie pas de remplacer le nom du destinataire !</p>
        <textarea id="share-message-textarea" rows="15" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light text-sm">${messageTemplate}</textarea>
        <button id="copy-share-message-btn" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Copier le message</button>
    `;

    createSimpleModal(title, contentHTML);
    
    // La logique du bouton copier ne change pas...
    const copyBtn = document.getElementById('copy-share-message-btn');
    const textarea = document.getElementById('share-message-textarea');
    if (copyBtn && textarea) {
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(textarea.value).then(() => {
                copyBtn.textContent = 'Copi√© ! ‚úî';
                setTimeout(() => { copyBtn.textContent = 'Copier le message'; }, 2000);
            });
        });
    }
}



// AJOUT : Nouvelle fonction pour la page de r√©initialisation de mot de passe
// ‚úÖ VERSION FINALE AVEC LOGO ET BOUTONS CORRIG√âS

function showResetPasswordView(actionCode) {
    authContainer.style.display = 'block';
    mainApp.style.display = 'none';

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo_surprises.PNG" alt="Logo OrIAntation" class="mx-auto h-32 w-32 mb-4">

            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mb-4">R√©initialiser votre mot de passe</h2>
            <p class="text-center text-slate-500 mb-6">Veuillez entrer votre nouveau mot de passe.</p>
            <form id="resetPasswordForm">
                <input id="newPassword" type="password" placeholder="Nouveau mot de passe" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="confirmPassword" type="password" placeholder="Confirmer le nouveau mot de passe" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Enregistrer le nouveau mot de passe</button>
            </form>
            <p id="resetError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const resetError = document.getElementById('resetError');

    resetPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword.length < 6) {
            resetError.textContent = "Le mot de passe doit contenir au moins 6 caract√®res.";
            return;
        }
        if (newPassword !== confirmPassword) {
            resetError.textContent = "Les mots de passe ne correspondent pas.";
            return;
        }

        try {
            await confirmPasswordReset(auth, actionCode, newPassword);
            
            showInfoModal(
                "Mot de passe modifi√© !",
                "Votre mot de passe a √©t√© r√©initialis√© avec succ√®s. Vous pouvez maintenant vous connecter.",
                window.location.pathname,
                3000
            );

        } catch (error) {
            console.error("Erreur de r√©initialisation:", error.code);
            if (error.code === 'auth/invalid-action-code') {
                resetError.textContent = "Le lien a expir√© ou est invalide. Veuillez refaire une demande.";
            } else {
                resetError.textContent = "Une erreur est survenue. Veuillez r√©essayer.";
            }
        }
    });
}


// Remplacez votre fonction showSurpriseModal par cette version

function showSurpriseModal(title, contentHTML, duration = null) {
    // La fonction retourne maintenant une Promise
    return new Promise((resolve) => {
        const modalId = 'surprise-modal';
        const existingModal = document.getElementById(modalId);
        if (existingModal) {
            existingModal.remove();
        }

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';
        
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md text-center p-6">
            <img src="logo_surprises.PNG" alt="Logo OrIAntation" class="mx-auto h-32 w-32 mb-4">
                <h3 class="font-bold text-OrIAntation-darkblue text-lg mt-2 mb-4">${title}</h3>
                <div class="text-slate-600 mb-6">${contentHTML}</div>
                <button id="surprise-close-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 rounded-lg hover:bg-cyan-700 transition">OK</button>
            </div>
        `;
        
        document.body.appendChild(modal);

        const closeModal = () => {
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.remove();
                resolve(); // On "r√©sout" la promesse, ce qui d√©bloque le code
            }, 300);
        };
        
        modal.querySelector('#surprise-close-btn').addEventListener('click', closeModal);

        if (duration) {
            setTimeout(closeModal, duration);
        }
    });
}

function createSimpleModal(title, contentHTML) {
            const modalId = 'simple-info-modal';
            // Supprime un modal existant s'il y en a un
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';
            
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col max-h-[80vh]">
                    <div class="flex items-center justify-between p-4 border-b bg-background-light rounded-t-2xl">
                        <h3 class="font-bold text-OrIAntation-darkblue text-lg">${title}</h3>
                        <button id="simple-modal-close" class="text-slate-500 hover:text-OrIAntation-darkblue text-2xl">√ó</button>
                    </div>
                    <div class="p-6 overflow-y-auto">
                        ${contentHTML}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);

            const closeModal = () => modal.remove();
            
            modal.querySelector('#simple-modal-close').addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        function showConfirmationModal(question) {
            return new Promise((resolve) => {
                const modalId = 'confirmation-modal';
                // Supprime un modal de confirmation existant pour √©viter les doublons
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';

                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm text-center p-6">
                        <h3 class="font-bold text-OrIAntation-darkblue text-lg mb-4">Confirmation requise</h3>
                        <p class="text-slate-600 mb-6">${question}</p>
                        <div class="flex gap-4">
                            <button id="confirm-cancel-btn" class="flex-1 bg-slate-200 text-OrIAntation-darkblue font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Annuler</button>
                            <button id="confirm-ok-btn" class="flex-1 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Confirmer</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const confirmBtn = modal.querySelector('#confirm-ok-btn');
                const cancelBtn = modal.querySelector('#confirm-cancel-btn');

                const closeModal = (result) => {
                    modal.remove();
                    resolve(result); // La promesse est r√©solue avec 'true' ou 'false'
                };

                confirmBtn.addEventListener('click', () => closeModal(true));
                cancelBtn.addEventListener('click', () => closeModal(false));
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(false); // Cliquer en dehors √©quivaut √† annuler
                    }
                });
            });
        }

        // IMPORTANT : Remplacez par la configuration de votre propre projet Firebase
        
        let currentUserId = null;
        let userGradeLevel = null;
        let currentUserInfo = { firstName: '', lastName: '', schoolName: '' };
        let currentViewName = null; // <-- AJOUTEZ CETTE LIGNE
        let verificationTimer = null;



        let cameFromLogin = false;
        let cameFromAuth = false; // üëà AJOUTEZ CETTE LIGNE
        let authReturnView = ''; 
        let signupFormData = {}; // <-- JUSTE ICI



        window.showAuthViewFromPrivacy = function() {
            cameFromAuth = false;
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('authContainer').style.display = 'block';
            document.querySelector('footer').style.display = 'block';
            showLoginView();
        }

        const linkify = (text) => {
    const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
    let newText = text.replace(urlRegex, function(url) {
        let hyperLink = url;
        if (!hyperLink.match('^https?:\/\/')) {
            hyperLink = 'http://' + hyperLink;
        }
        return `<a href="${hyperLink}" target="_blank" class="text-primary-action hover:underline">${url}</a>`;
    });
    // This makes sure line breaks are preserved
    return newText.replace(/\n/g, '<br>');
};
        const { jsPDF } = window.jspdf;
        const floatingBackBtn = document.getElementById('floatingBackBtn'); // AJOUTEZ CETTE LIGNE

floatingBackBtn.addEventListener('click', () => {
    // Si on est sur la page du guide, on applique la logique sp√©ciale
    if (currentViewName === 'guide') {
const backAction = cameFromLogin ? window.showSignupViewFromGuide : () => window.showView('menu');
        backAction();
    } 
    // Cas 2 : On est sur la vue du journal d'un √©l√®ve (en tant qu'enseignant)
    else if (currentViewName === 'teacherStudentJournal') {
        showView('teacherDashboard'); // On retourne au tableau de bord enseignant
    }
    // Cas 3 : On est sur la politique de confidentialit√©
    else if (currentViewName === 'privacy') {
        // On s'assure que les bonnes sections de la page sont visibles
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        
        // Si on vient de la page d'inscription (drapeau `cameFromAuth`)
        if (cameFromAuth) {
            cameFromAuth = false;
            showSignupView();
        } else {
            // NOUVELLE LOGIQUE ICI
            // On v√©rifie le r√¥le de l'utilisateur connect√©
            if (currentUserInfo.role === 'enseignant') {
                showView('teacherDashboard'); // Si c'est un prof, on retourne √† son tableau de bord
            } else {
                showView('menu'); // Sinon (si c'est un √©l√®ve), on retourne au menu
            }
        }
    }
    // Cas par d√©faut : Pour toutes les autres pages, on retourne au menu principal
    else {
        showView('menu');
    }
});

        let journalData = {};
        


function initializeNormalAppFlow() {
    // Cette fonction est maintenant le point d'entr√©e pour un d√©marrage normal.
    // Elle contient toute la logique de connexion/d√©connexion qui √©tait dans l'ancien bloc.
    window.showGuideFromLogin = function() {
        cameFromLogin = true;
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.querySelector('footer').style.display = 'none'; 
        showView('guide');
    }
    window.showLoginViewFromGuide = function() {
        cameFromLogin = false;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        showLoginView();
    }
    window.showSignupViewFromGuide = function() {
        cameFromLogin = false;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('authContainer').style.display = 'block';
        document.querySelector('footer').style.display = 'block';
        showSignupView();
    }

    


// REMPLACEZ VOTRE FONCTION onAuthStateChanged PAR CETTE VERSION FINALE

onAuthStateChanged(auth, user => {

    if (isNewUserFlow) {
        return;
    }
    
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    
    if (user) {
        if (user.emailVerified || IS_DEV_MODE) {
            if (IS_DEV_MODE) { console.log('%c‚ö†Ô∏è MODE D√âVELOPPEUR ACTIF : V√©rification d\'email contourn√©e.', 'color: orange; font-weight: bold;'); }
            
            if (chatbotToggle) chatbotToggle.style.display = 'flex';
            currentUserId = user.uid;
            authContainer.style.display = 'none';
            mainApp.style.display = 'block';
            document.body.classList.add('logged-in');
            
            // On charge les donn√©es de l'utilisateur
            loadData().then(async () => {
                // 'loadData' est termin√©e, on peut maintenant prendre des d√©cisions

            addVoiceDictationToInputs(); // <-- AJOUTEZ CETTE LIGNE ICI


            setupPushNotifications();

                
                if (currentUserInfo.role === 'enseignant') {
                    // CAS 1 : C'est un enseignant
                    showView('teacherDashboard');

                } else { 
                    // CAS 2 : C'est un √©l√®ve
                    const userDocRef = doc(db, "users", currentUserId);
                    const currentSchoolYear = getCurrentSchoolYear();
                    await setDoc(userDocRef, { lastLoginSchoolYear: currentSchoolYear }, { merge: true });

                    if (!userGradeLevel) {
                        // 2a : C'est un NOUVEL √©l√®ve (il n'a pas encore de classe)
                        showGradeSelectionView();
                    } else {
                        // 2b : C'est un √©l√®ve QUI REVIENT
                        showMenuAndWelcomeCheck();
                    }
                }
            });
            
        } else {
            // Logique pour l'e-mail non v√©rifi√©
            if (chatbotToggle) chatbotToggle.style.display = 'none';
            if (floatingBackBtn) floatingBackBtn.style.display = 'none';
            document.body.classList.remove('logged-in');
            showVerificationView(user);
        }
    } else {
        // Logique pour l'utilisateur d√©connect√©
        if (chatbotToggle) chatbotToggle.style.display = 'none';
        if (floatingBackBtn) floatingBackBtn.style.display = 'none';
        currentUserId = null;
        userGradeLevel = null;
        currentUserInfo = { firstName: '', lastName: '', schoolName: '' };
        journalData = {}; 
        authContainer.style.display = 'block';
        mainApp.style.display = 'none';
        document.body.classList.remove('logged-in');
        showLoginView();
    }
});
}

async function handleOnboarding(context = {}) {
    if (!context || !context.from) { return false; }

    // --- MISSION 1 (FIN DE L'√âTAPE 0) ---
    if (context.from === 'step0_analysis' && !journalData.tutorial_mission_1_shown) {
        journalData.tutorial_mission_1_shown = true;
        journalData.tutorial_next_step = 'retroplanning';
        await saveData({ skipOnboarding: true }); // Sauvegarde des indicateurs

        await showSurpriseModal(
            "Premi√®re mission accomplie ! üöÄ",
            `<p>Bravo, tu as d√©couvert ton Arch√©type ! Tu viens de d√©marrer le coeur du r√©acteur !!</p>
             <p class="mt-4 font-semibold">Ta prochaine mission : va sur l'√©tape <strong>"Mon R√©troplanning"</strong> et clique sur le bouton <strong>"üìÖ G√©n√©rer / Mettre √† jour"</strong> pour obtenir ta feuille de route. Clique enfin sur enregistrer dans le journal pour passer √† la suite</p>`
        );
        showView('menu');
        return true;
    }

    // --- MISSION 2 (FIN DE L'√âTAPE R√âTROPLANNING) ---
    const retroplanningDone = journalData.retroplanning?.tasks?.length > 0;
    if (context.from === 'retroplanning_save' && retroplanningDone && !journalData.tutorial_mission_2_shown) {
        journalData.tutorial_mission_2_shown = true;
        journalData.tutorial_next_step = 'step1';
        await saveData({ skipOnboarding: true });

        await showSurpriseModal(
            "Feuille de route g√©n√©r√©e ! üó∫Ô∏è",
            `<p>Parfait ! Tu as une vision claire de ton ann√©e.</p>
             <p class="mt-4 font-semibold">Mission suivante : va sur l'√©tape <strong>"Les Fondations"</strong>, renseigne un m√©tier qui t'int√©resse et lance les analyses d'OrIA avec les boutons ‚ú®, üìÖ, et üé¨. Clique enfin sur terminer et suvegarder pour passer √† la suite</p>`
        );
        showView('menu');
        return true;
    }
    
    // --- MISSION 3 (FIN DE L'√âTAPE 1) ---
    const metiersExplores = [journalData.step1.metier1, journalData.step1.metier2, journalData.step1.metier3].filter(m => m && m.trim() !== '').length;
    if (context.from === 'step1_save' && metiersExplores >= 1 && !journalData.tutorial_mission_3_shown) {
        journalData.tutorial_mission_3_shown = true;
        journalData.tutorial_next_step = 'journal'; // La prochaine √©tape est le journal
        await saveData({ skipOnboarding: true });
        await showSurpriseModal(
            "Troisi√®me mission accomplie ! üß≠",
            `<p>Excellent ! Tu as explor√© ta premi√®re piste de m√©tiers.</p><p class="mt-4 font-semibold">Mission finale : va dans ton "Journal de Bord" et g√©n√®re ton "Fil Rouge" pour obtenir une synth√®se compl√®te de ton parcours.</p>`
        );
        showView('menu');
        return true;
    }

    // --- MISSION 4 (FINALE) : G√âN√âRATION DU FIL ROUGE ---
    if (context.from === 'fil_rouge_generated' && !journalData.tutorial_completed) {
        journalData.tutorial_completed = true;
        journalData.tutorial_next_step = ''; // On vide pour enlever la surbrillance
        await saveData({ skipOnboarding: true });
        await showSurpriseModal(
            "F√©licitations, Tutoriel Termin√© ! üéâ",
            "<p>Tu as maintenant toutes les bases pour chosiir ton cap !! Continue √† remplir les √©tapes √† ton rythme. Bonne exploration !</p>"
        );
        return true;
    }
    
    return false;
}

        async function deleteUserAccount() {
    const user = auth.currentUser;
    if (!user) return;

    // √âtape 1 : Confirmation
    const confirmed = await showConfirmationModal("√ätes-vous certain de vouloir supprimer votre compte ? Toutes vos donn√©es seront d√©finitivement effac√©es. Cette action est irr√©versible.");
    
    if (confirmed) {
        try {
            // √âtape 2 : Suppression des donn√©es
            await deleteDoc(doc(db, "users", user.uid)); // Supprime le document Firestore
            await deleteUser(user); // Supprime l'utilisateur de l'authentification
            
            // √âtape 3 : Confirmation et d√©connexion
showInfoModal("Suppression r√©ussie", "Votre compte et toutes vos donn√©es ont √©t√© supprim√©s avec succ√®s.");
            // onAuthStateChanged se chargera de la redirection
        } catch (error) {
            console.error("Erreur lors de la suppression du compte:", error);
            if (error.code === 'auth/requires-recent-login') {
showInfoModal("Action requise", "Cette op√©ration est sensible et requiert une connexion r√©cente. Veuillez vous d√©connecter, vous reconnecter, puis r√©essayer.");                signOut(auth);
            } else {
showInfoModal("Erreur", "Une erreur est survenue lors de la suppression. Veuillez r√©essayer.");            }
        }
    }
}

            
        // üîπ Fonction utilitaire
function capitalizeWords(str) {
    if (!str) return '';
    return str
        .toLowerCase()
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

function formatPreciseDateTime(date) {
    if (!date) return "Jamais";
    const activityDate = new Date(date); // Les dates de Firebase arrivent comme des cha√Ænes ISO
    if (isNaN(activityDate.getTime())) return "Jamais";
    return activityDate.toLocaleString('fr-FR', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
}

function showLoginView() {
    // On s'assure de toujours cacher le bouton flottant ici
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    if (floatingBackBtn) {
        floatingBackBtn.style.display = 'none';
    }

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-auto w-auto">
            <div class="p-4 bg-white text-OrIAntation-darkblue text-center mb-6">
                <p class="text-sm text-slate-600">
                    Que tu te sentes perdu(e), noy√©(e) dans un oc√©an d'informations ou bien que tu sois certain(e) de ta destination, fais confiance √† notre copilote OrIA pour te montrer les chemins de traverse que peu connaissent. C'est la garantie de ne rater aucune opportunit√© pour ton avenir !!
                </p>
                <p class="font-semibold text-OrIAntation-darkblue mt-2">Choisis ton cap avec notre boussole 2.0 !!</p>
            </div>
            <p class="text-center text-sm text-slate-500 mb-8">
                <button id="showGuideButton" class="font-semibold text-primary-action hover:underline">Consultez le guide d'utilisation.</button>
            </p>
            <form id="loginForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Se connecter</button>
            </form>
            <div class="flex justify-between items-center text-sm text-left">
                <p class="text-slate-500">Pas encore de compte ? 
                    <button id="showSignupButton" class="font-semibold text-primary-action hover:underline">Inscrivez-vous</button>
                </p>
                <button id="forgotPasswordButton" class="text-sm text-slate-500 hover:underline">Mot de passe oubli√© ?</button>
            </div>
            <p id="authError" class="text-red-500 text-center mt-4"></p>
        </div>
    `;

    authContainer.querySelector('#loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, e.target.email.value, e.target.password.value);
        } catch (error) {
            authContainer.querySelector('#authError').textContent = "Erreur de connexion. V√©rifiez vos identifiants.";
        }
    });

    authContainer.querySelector('#showSignupButton').addEventListener('click', showSignupView);
    authContainer.querySelector('#forgotPasswordButton').addEventListener('click', showForgotPasswordView);
    
    // CORRECTION : Le bouton ouvre maintenant la fen√™tre de s√©lection
    authContainer.querySelector('#showGuideButton').addEventListener('click', () => {
        document.getElementById('guideRoleModal').style.display = 'flex';
    });
     addVoiceDictationToInputs();
}

// AJOUT : Nouvelle fonction pour afficher la page de v√©rification
// ‚úÖ VERSION FINALE AVEC LOGO ET BOUTONS CORRIG√âS

// DANS index.html, REMPLACEZ LA FONCTION showVerificationView PAR CELLE-CI :

function showVerificationView(user) {
    authContainer.style.display = 'block';
    mainApp.style.display = 'none';

    if (verificationTimer) clearInterval(verificationTimer);

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in text-center">
            <img src="logo_surprises.PNG" alt="Logo OrIAntation" class="mx-auto h-32 w-32 mb-4">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">V√©rifiez votre adresse e-mail</h2>
            <p class="text-slate-600 mb-6">Un e-mail de v√©rification a √©t√© envoy√© √† <strong>${user.email}</strong>...</p>
            <p id="resendMessage" class="text-sm text-green-600 mb-4"></p>
            <div class="space-y-4">
                <button id="resendVerificationBtn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Renvoyer l'e-mail</button>
                <button id="logoutFromVerificationBtn" class="w-full bg-slate-200 text-OrIAntation-darkblue font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 transition">Se d√©connecter</button>
            </div>
        </div>
    `;

    verificationTimer = setInterval(async () => {
        if (auth.currentUser) {
            await auth.currentUser.reload();
            if (auth.currentUser.emailVerified) {
                clearInterval(verificationTimer);
                window.location.reload(); 
            }
        }
    }, 3000);
    
    authContainer.querySelector('#resendVerificationBtn').addEventListener('click', async () => {
        const resendMessage = authContainer.querySelector('#resendMessage');
        resendMessage.textContent = "Pr√©paration de l'envoi...";

        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            
            // ==================== MODIFICATION ICI ====================
            // Si le profil n'existe pas, on affiche un message clair au lieu de planter.
            if (!userDoc.exists()) {
                resendMessage.classList.remove('text-green-600');
                resendMessage.classList.add('text-red-500');
                resendMessage.textContent = "Votre inscription est incompl√®te. Veuillez vous d√©connecter, puis vous r√©inscrire.";
                return; // On arr√™te l'ex√©cution de la fonction ici.
            }
            // ==========================================================

            const userData = userDoc.data();
            const templateId = userData.role === 'enseignant' ? 2 : 1;

            const sendEmail = httpsCallable(functions, 'sendTransactionalEmail');
            await sendEmail({
                templateId: templateId,
                toEmail: user.email,
                params: { firstName: userData.firstName || ' ' }
            });

            resendMessage.classList.remove('text-red-500');
            resendMessage.classList.add('text-green-600');
            resendMessage.textContent = "Un nouvel e-mail a √©t√© envoy√© !";

        } catch (error) {
            console.error("Erreur lors de la demande de renvoi:", error);
            resendMessage.classList.remove('text-green-600');
            resendMessage.classList.add('text-red-500');
            resendMessage.textContent = "Une erreur est survenue lors de la demande. Veuillez r√©essayer.";
        }
    });
    
    authContainer.querySelector('#logoutFromVerificationBtn').addEventListener('click', () => {
        if (verificationTimer) clearInterval(verificationTimer);
        signOut(auth);
    });
}

// AJOUT : Une fonction pour afficher une jolie modale d'information
function showInfoModal(title, message, redirectUrl = null, duration = 0) {
    const modalId = 'info-modal';
    // Supprime un modal existant pour √©viter les doublons
    const existingModal = document.getElementById(modalId);
    if (existingModal) existingModal.remove();

    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-60 fade-in';

    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm text-center p-6">
            <h3 class="font-bold text-OrIAntation-darkblue text-lg mb-4">${title}</h3>
            <p class="text-slate-600 mb-6">${message}</p>
            <button id="info-modal-ok-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">OK</button>
        </div>
    `;

    document.body.appendChild(modal);

    const okBtn = modal.querySelector('#info-modal-ok-btn');

    const closeModalAndRedirect = () => {
        modal.remove();
        if (redirectUrl) {
            window.location.href = redirectUrl;
        }
    };

    okBtn.addEventListener('click', closeModalAndRedirect);

    // Si une dur√©e est sp√©cifi√©e, on ferme et redirige automatiquement
    if (duration > 0) {
        setTimeout(closeModalAndRedirect, duration);
    }
}
function showForgotPasswordView() {
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-48 w-auto mb-6">
            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mb-2">Mot de passe oubli√© ?</h2>
            <p class="text-center text-slate-500 mb-6">Pas de panique ! Entrez votre e-mail pour recevoir un lien de r√©initialisation.</p>
            <form id="forgotPasswordForm" class="mb-4">
                <input id="email" type="email" placeholder="Adresse e-mail du compte" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition">Envoyer le lien</button>
            </form>
            <p class="text-center text-sm text-slate-500">
                <button id="backToLoginButton" class="font-semibold text-primary-action hover:underline">Retour √† la connexion</button>
            </p>
            <p id="authMessage" class="text-green-600 text-center mt-4"></p>
        </div>
    `;

    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const authMessage = document.getElementById('authMessage');

    forgotPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const submitButton = forgotPasswordForm.querySelector('button[type="submit"]');
        
        // Am√©lioration : on d√©sactive le bouton et on informe l'utilisateur
        submitButton.disabled = true;
        authMessage.textContent = "Envoi en cours...";
        authMessage.classList.remove('text-red-500');
        authMessage.classList.add('text-green-600');

        try {
            // On utilise fetch pour la coh√©rence avec le reste du code
            const functionUrl = 'https://europe-west3-monapp0rientation.cloudfunctions.net/sendTransactionalEmail'; // Assurez-vous que la r√©gion est la bonne
            await fetch(functionUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data: {
                        templateId: 4, 
                        toEmail: email,
                        params: {}
                    }
                }),
            });
            authMessage.textContent = "Si un compte est associ√© √† cette adresse, un e-mail de r√©initialisation vient d'√™tre envoy√©.";
        } catch (error) {
            console.error("Erreur lors de l'appel de la fonction d'envoi :", error);
            authMessage.textContent = "Une erreur est survenue. Veuillez r√©essayer.";
            authMessage.classList.add('text-red-500');
        } finally {
            // On r√©active le bouton √† la fin
            submitButton.disabled = false;
        }
    });

    document.getElementById('backToLoginButton').addEventListener('click', showLoginView);

        addVoiceDictationToInputs(); // <-- AJOUTEZ CETTE LIGNE

}




// DANS VOTRE <script type="module">, REMPLACEZ CE BLOC D'√âCOUTEUR 'submit' EXISTANT PAR CELUI-CI :

authContainer.addEventListener('submit', async (e) => {
    // On v√©rifie que c'est bien le formulaire d'inscription qui a √©t√© soumis
    if (e.target && e.target.id === 'signupForm') {
        e.preventDefault();
        
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const authError = document.getElementById('authError');
        
        if (!submitButton || !authError) return;

        submitButton.disabled = true;
        submitButton.textContent = 'V√©rification...';
        authError.textContent = '';
        
        const role = form.dataset.role;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            let schoolData = {};
            // --- √âTAPE 1 : Validation des donn√©es (AVANT de cr√©er l'utilisateur) ---
            if (role === 'eleve') {
                const radioChoice = form.querySelector('input[name="school_method"]:checked');
                if (!radioChoice) throw new Error("Veuillez choisir une m√©thode pour trouver votre lyc√©e.");
                
                if (radioChoice.value === 'code') {
                    const schoolCode = document.getElementById('schoolCode').value;
                    if (!schoolCode) throw new Error("Le code d'√©tablissement est obligatoire.");
                    const getSchool = httpsCallable(functions, 'getSchoolFromCode');
                    const result = await getSchool({ code: schoolCode });
                    schoolData = result.data;
                } else {
                    schoolData.schoolName = capitalizeWords(document.getElementById('schoolNameStudent').value);
                    schoolData.schoolCity = capitalizeWords(document.getElementById('schoolCityStudent').value);
                    if (!schoolData.schoolName || !schoolData.schoolCity) throw new Error("Le nom et la ville du lyc√©e sont obligatoires.");
                }
            }
            
            submitButton.textContent = 'Cr√©ation du compte...';

            // --- √âTAPE 2 : Cr√©ation de l'utilisateur Auth (SEULEMENT SI la validation a r√©ussi) ---
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // --- √âTAPE 3 : Cr√©ation du profil Firestore ---
            const userProfile = {
                firstName: capitalizeWords(document.getElementById('firstName').value),
                lastName: capitalizeWords(document.getElementById('lastName').value),
                email, role,
                gender: document.getElementById('gender').value,
                createdAt: new Date(), lastActivity: new Date(),
                journal: defaultData, ...schoolData 
            };
            await setDoc(doc(db, "users", user.uid), userProfile);
            
            // Logique sp√©cifique pour l'enseignant apr√®s la cr√©ation du profil
            if (role === 'enseignant') {
                const schoolName = capitalizeWords(document.getElementById('schoolNameTeacher').value);
                const className = document.getElementById('className').value;
                const schoolCity = capitalizeWords(document.getElementById('schoolCityTeacher').value);
                if (!schoolName || !className || !schoolCity) throw new Error("Tous les champs de l'√©tablissement sont obligatoires.");
                
                const setupTeacher = httpsCallable(functions, 'setupTeacherClass');
                await setupTeacher({ schoolName, className, schoolCity });
            }

            // --- √âTAPE 4 : Envoi de l'e-mail ---
            submitButton.textContent = 'Envoi de l\'e-mail...';
            const sendEmail = httpsCallable(functions, 'sendTransactionalEmail');
            await sendEmail({
                templateId: (role === 'enseignant' ? 2 : 1),
                toEmail: user.email,
                params: { firstName: userProfile.firstName || ' ' }
            });
            // Si tout r√©ussit, le onAuthStateChanged prendra le relais pour afficher la page de v√©rification.

        } catch (error) {
            console.error("Erreur d'inscription d√©taill√©e:", error);
            
            let errorMessage = "Une erreur est survenue. Veuillez r√©essayer.";
            if (error.code) { 
                switch (error.code) {
                    case 'auth/email-already-in-use': errorMessage = "Cette adresse e-mail est d√©j√† utilis√©e."; break;
                    case 'auth/weak-password': errorMessage = "Le mot de passe doit contenir au moins 6 caract√®res."; break;
                    case 'functions/not-found': errorMessage = "Le code d'√©tablissement est invalide ou introuvable."; break;
                    default: errorMessage = error.message; break;
                }
            } else if (error.message) { errorMessage = error.message; }
            
            authError.textContent = errorMessage;
            
            // Nettoyage de l'utilisateur orphelin si l'erreur survient apr√®s sa cr√©ation
            const potentialOrphan = auth.currentUser;
            if (potentialOrphan && potentialOrphan.email === email && !potentialOrphan.emailVerified) {
                await deleteUser(potentialOrphan).catch(delErr => console.error("√âchec de la suppression de l'utilisateur orphelin:", delErr));
            }

            submitButton.disabled = false;
            submitButton.textContent = 'Cr√©er mon compte';
        }
    }
});

    // =============================================================
    // MODIFICATION MAJEURE : La fonction renderSignupForm se contente
    // maintenant d'afficher le HTML, sans attacher d'√©couteur.
    // =============================================================
    function renderSignupForm(role, errorMessage = '') {
    const isStudent = role === 'eleve';
    const formTitle = isStudent ? "Inscription √âl√®ve" : "Inscription Enseignant";

    const studentFieldsHTML = `
        <div id="student-school-container" class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-3">
            <label class="block text-md font-medium text-slate-700 mb-2">Comment te rattacher √† ton lyc√©e ?</label>
            <div class="flex gap-4 mb-2">
                <label class="flex items-center"><input type="radio" name="school_method" value="code" class="h-4 w-4 text-cyan-600" checked> <span class="ml-2 text-sm">Avec un code</span></label>
                <label class="flex items-center"><input type="radio" name="school_method" value="name" class="h-4 w-4 text-cyan-600"> <span class="ml-2 text-sm">Avec le nom</span></label>
            </div>
            <div id="school-code-field"><input id="schoolCode" type="text" placeholder="Code fourni par ton professeur" class="w-full p-3 border border-slate-300 rounded-lg"></div>
            <div id="school-name-field" class="hidden"><input id="schoolNameStudent" type="text" placeholder="Nom complet de ton lyc√©e" class="w-full p-3 border border-slate-300 rounded-lg"><input id="schoolCityStudent" type="text" placeholder="Ville de ton lyc√©e (Ex: Orl√©ans)" class="w-full p-3 mt-2 border border-slate-300 rounded-lg"></div>
        </div>`;

    const teacherFieldsHTML = `
        <div id="teacher-school-container" class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-3 space-y-3">
            <div><label class="block text-md font-medium text-slate-700">Votre √©tablissement</label><input id="schoolNameTeacher" type="text" placeholder="Nom complet de votre √©tablissement" class="w-full p-3 mt-1 border border-slate-300 rounded-lg"></div>
            <div><label class="block text-md font-medium text-slate-700">Ville de l'√©tablissement</label><input id="schoolCityTeacher" type="text" placeholder="Ex: Orl√©ans" class="w-full p-3 mt-1 border border-slate-300 rounded-lg"></div>
            <div><label class="block text-md font-medium text-slate-700">Nom de votre classe</label><input id="className" type="text" placeholder="Ex: Premi√®re G√©n√©rale 2" class="w-full p-3 mt-1 border border-slate-300 rounded-lg"></div>
        </div>`;

    // Cette fonction ne fait plus qu'afficher le HTML. Elle n'ajoute plus d'√©couteur "submit".
    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mb-6">${formTitle}</h2>
            <form id="signupForm" data-role="${role}">
                <input id="firstName" type="text" placeholder="Pr√©nom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="lastName" type="text" placeholder="Nom" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                ${isStudent ? studentFieldsHTML : teacherFieldsHTML}
                <select id="gender" class="w-full p-3 mb-3 border border-slate-300 rounded-lg bg-white" required><option value="" disabled selected>Je suis...</option><option value="homme">Un homme</option><option value="femme">Une femme</option><option value="autre">Autre / Pr√©f√®re ne pas pr√©ciser</option></select>
                <input id="email" type="email" placeholder="Adresse e-mail${isStudent ? '' : ' acad√©mique'}" class="w-full p-3 mb-3 border border-slate-300 rounded-lg" required>
                <input id="password" type="password" placeholder="Mot de passe (6 caract√®res min.)" class="w-full p-3 mb-4 border border-slate-300 rounded-lg" required>
                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4"><p class="text-sm text-slate-700 mb-2">En cr√©ant votre compte, vous acceptez la <button type="button" id="showPrivacyPolicyFromSignup" class="font-semibold text-primary-action hover:underline">Politique de Confidentialit√©</button> de l'application OrIAntation.</p><div class="flex items-start"><input type="checkbox" id="consentCheckbox" class="h-4 w-4 text-cyan-600 focus:ring-cyan-500 border-gray-300 rounded mt-1" required><label for="consentCheckbox" class="ml-2 block text-sm text-slate-700">J'ai lu et j'accepte la politique de confidentialit√©.</label></div></div>
                <button type="submit" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700">Cr√©er mon compte</button>
            </form>
            <div class="text-center mt-4"><button id="back-to-choice-btn" class="text-sm font-semibold text-primary-action hover:underline">Retour au choix du profil</button></div>
            <p id="authError" class="text-red-500 text-center mt-4">${errorMessage}</p>
        </div>`;

    if (isStudent) {
        const schoolCodeField = document.getElementById('school-code-field');
        const schoolNameField = document.getElementById('school-name-field');
        document.getElementsByName('school_method').forEach(radio => {
            radio.addEventListener('change', (e) => {
                schoolCodeField.classList.toggle('hidden', e.target.value !== 'code');
                schoolNameField.classList.toggle('hidden', e.target.value !== 'name');
            });
        });
    }

    document.getElementById('back-to-choice-btn').addEventListener('click', showSignupView);
    // document.getElementById('showPrivacyPolicyFromSignup').addEventListener('click', ...);

    // On appelle la fonction pour la dict√©e vocale ici, c'est le bon endroit.
    addVoiceDictationToInputs();
}


// Nouvelle fonction principale qui affiche l'√©cran de choix
function showSignupView() {
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    if (floatingBackBtn) {
        floatingBackBtn.style.display = 'none';
    }

    authContainer.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in">
            <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-auto w-auto">
            <h2 class="text-2xl font-bold text-center text-OrIAntation-darkblue mt-4 mb-2">Cr√©er un compte</h2>
            <p class="text-center text-slate-500 mb-8">Qui √™tes-vous ?</p>
            
            <div class="space-y-4">
                <button id="signup-as-student-btn" class="w-full bg-cyan-600 text-white font-semibold py-3 rounded-lg hover:bg-cyan-700 transition flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg>
                    <span>Je suis un √©l√®ve</span>
                </button>
                <button id="signup-as-teacher-btn" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 transition flex items-center justify-center gap-3">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>
                    <span>Je suis un enseignant</span>
                </button>
            </div>
            
            <p class="text-center text-sm text-slate-500 mt-8">D√©j√† un compte ? 
                <button id="showLoginButton" class="font-semibold text-primary-action hover:underline">Connectez-vous</button>
            </p>
        </div>
    `;

    // On attache les √©v√©nements aux boutons de choix du profil
    document.getElementById('signup-as-student-btn').addEventListener('click', () => renderSignupForm('eleve'));
    document.getElementById('signup-as-teacher-btn').addEventListener('click', () => renderSignupForm('enseignant'));
    document.getElementById('showLoginButton').addEventListener('click', showLoginView);
}

// ==================== FIN DU BLOC COMPLET √Ä REMPLACER ====================

// üîπ Rendre la fonction showView accessible globalement
window.showView = showView;
window.deleteUserAccount = deleteUserAccount; 

           function getCurrentSchoolYear() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth(); // 0 pour Janvier, 11 pour D√©cembre

    // On consid√®re que la nouvelle ann√©e scolaire commence en ao√ªt (mois 7)
    // Si nous sommes en juillet 2025 (mois 6), l'ann√©e scolaire est 2024.
    // Si nous sommes en ao√ªt 2025 (mois 7), l'ann√©e scolaire est 2025.
    return (month >= 7) ? year : year - 1;
}


async function saveData(context = {}) {
    if (!currentUserId) return;
    const userDocRef = doc(db, "users", currentUserId);

    const dataToSave = {
        gradeLevel: userGradeLevel,
        journal: journalData,
        lastActivity: new Date() // <-- VOICI LA LIGNE CRUCIALE AJOUT√âE
    };

    try {
        // Le { merge: true } garantit qu'on ne touche pas aux autres champs (pr√©nom, nom, etc.)
        await setDoc(userDocRef, dataToSave, { merge: true });
    } catch (error) {
        console.error("Error saving document: ", error);
    }
}

        async function triggerSurpriseMoment() {

            const isStep0Done = isStepComplete('step0');
            const isStep10Done = isStepComplete('step10');

    // Si l'une des deux √©tapes de base n'est pas termin√©e, on ne lance JAMAIS de surprise.
    if (!isStep0Done || !isStep10Done) {
        return; // Sortie anticip√©e de la fonction
    }
            // R√®gle 1: Ne pas afficher de surprise si la derni√®re date de moins de 2 heures
            const now = new Date().getTime();
            const lastSurprise = journalData.last_surprise_timestamp || 0;
            const hoursSinceLastSurprise = (now - lastSurprise) / (1000 * 60 * 60);
            if (hoursSinceLastSurprise < 1) { // 1 heure de d√©lai
                return;
            }

            // R√®gle 2: R√©duire la probabilit√© d'apparition (15% de chance au lieu de 25%)
            if (Math.random() > 0.15) {
                return;
            }
            
            // Pour √©viter les conflits, ne pas lancer si un autre modal est d√©j√† ouvert
            if (document.querySelector('.simulation-modal, .portfolio-modal, #simple-info-modal, #surprise-modal')) return;


            const currentLevel = journalData.level || 1;
            const currentXp = journalData.xp || 0;
            const xpForCurrentLevel = levelConfig[currentLevel];
            const xpForNextLevel = levelConfig[currentLevel + 1];
            const xpInCurrentLevel = currentXp - xpForCurrentLevel;
            // On g√®re le cas o√π l'√©l√®ve est au niveau maximum
            const xpNeededForLevel = xpForNextLevel ? xpForNextLevel - xpForCurrentLevel : Infinity; 

            let surprisesPossibles = [];

            // --- 1. SURPRISES LI√âES AU PROFIL (√âTAPE 0) ---

            // Si l'√©l√®ve a des traits 'Artistes' mais un portfolio vide
            const aDesTraitsArtistes = journalData.step0 && (journalData.step0.q16 === 'artistique' || journalData.step0.q19 === 'artistique' || journalData.step0.q20 === 'artistique');
            const portfolioVide = !journalData.step10.experiences || journalData.step10.experiences.length === 0;
            if (aDesTraitsArtistes && portfolioVide) {
                surprisesPossibles.push({
                    title: "Piste de r√©flexion...",
                    content: "J'ai remarqu√© que tu as des centres d'int√©r√™t artistiques. N'oublie pas que tu peux valoriser tes projets cr√©atifs (dessin, musique, √©criture...) dans ton <strong>Portfolio de Comp√©tences</strong> ! √áa peut faire toute la diff√©rence."
                });
            }
            
            // Si l'√©l√®ve a des traits 'Entreprenants' mais n'a pas explor√© de m√©tiers de management
            const aDesTraitsEntreprenants = journalData.step0 && (journalData.step0.q17 === 'entreprenant' || journalData.step0.q18 === 'entreprenant');
            const aExploreManagement = (journalData.step1.metier1.includes('manage') || journalData.step1.metier2.includes('manage') || journalData.step1.metier3.includes('manage'));
            if (aDesTraitsEntreprenants && !aExploreManagement) {
                surprisesPossibles.push({
                    title: "Ton profil de leader...",
                    content: "Ton profil montre que tu aimes diriger et convaincre. As-tu d√©j√† explor√© des m√©tiers li√©s au <strong>management de projet</strong> ou √† la <strong>cr√©ation d'entreprise</strong> ? Le Radar √† Opportunit√©s pourrait te surprendre !"
                });
            }

            // Si l'√©l√®ve est plut√¥t 'Introverti' et explore des m√©tiers de contact
            const estIntroverti = journalData.step0 && journalData.step0.q10 === 'introversion';
            const aExploreMetierSocial = (journalData.step1.metier1.toLowerCase().includes('social') || journalData.step1.metier1.toLowerCase().includes('enseignant') || journalData.step1.metier1.toLowerCase().includes('infirmier'));
            if (estIntroverti && aExploreMetierSocial) {
                surprisesPossibles.push({
                    title: "Une question pour toi...",
                    content: "C'est super de t'int√©resser aux m√©tiers du contact ! Ton profil sugg√®re que tu recharges tes batteries en √©tant seul(e). Pense √† utiliser le simulateur de <strong>'Journ√©e Type'</strong> pour voir si le rythme te conviendrait."
                });
            }

            // Si l'√©l√®ve est 'Curieux' et n'a pas fait de quiz
            const estCurieux = journalData.step0 && journalData.step0.q14 === 'curieux';
            const aFaitQuiz = journalData.step7.scores && Object.keys(journalData.step7.scores).length > 0;
            if (estCurieux && !aFaitQuiz) {
                surprisesPossibles.push({
                    title: "Pour les esprits curieux...",
                    content: "Ton profil montre une grande curiosit√© ! Pour la nourrir, pourquoi ne pas te lancer un d√©fi avec l'√©tape <strong>'Fact Checking'</strong> ? C'est un excellent moyen de d√©construire les id√©es re√ßues."
                });
            }
            
            // --- 2. SURPRISES LI√âES √Ä L'EXPLORATION (√âTAPES 1 √† 5) ---

            // Si l'√©l√®ve a explor√© au moins 2 m√©tiers mais n'a pas utilis√© le comparateur
            const metiersExplores = [journalData.step1.metier1, journalData.step1.metier2, journalData.step1.metier3].filter(m => m && m.trim() !== '').length;
            const comparateurNonUtilise = !journalData.step1.comparison || journalData.step1.comparison.trim() === '';
            if (metiersExplores >= 2 && comparateurNonUtilise) {
                surprisesPossibles.push({
                    title: "Astuce d'expert !",
                    content: "Super, tu as explor√© plusieurs m√©tiers ! Pour t'aider √† y voir plus clair, pense √† utiliser le <strong>Comparateur de M√©tiers</strong> en bas de l'√©tape 'Les Fondations'. Il te cr√©era un tableau de synth√®se personnalis√©."
                });
            }
            
            // Si l'√©l√®ve a mis des formations dans le catalogue mais pas de m√©tier correspondant
            const aExploreFormations = journalData.step3 && journalData.step3.formation1.trim() !== '';
            if (aExploreFormations && metiersExplores === 0) {
                surprisesPossibles.push({
                    title: "Connecte les points !",
                    content: "Tu as commenc√© √† explorer des formations, c'est g√©nial ! Pour bien comprendre o√π elles m√®nent, n'oublie pas de remplir l'√©tape <strong>'Les Fondations'</strong> pour d√©couvrir les m√©tiers concrets auxquels elles pr√©parent."
                });
            }

            // Si l'√©l√®ve est en Terminale et que la date approche de Parcoursup (Janvier)
            const isTerminale = userGradeLevel === 'terminale';
            const isParcoursupTime = new Date().getMonth() >= 0 && new Date().getMonth() <= 2; // Janvier √† Mars
            const candidatureVide = !journalData.step6.formation || journalData.step6.formation.trim() === '';
            if (isTerminale && isParcoursupTime && candidatureVide) {
                surprisesPossibles.push({
                    title: "Parcoursup approche !",
                    content: "La p√©riode de formulation des v≈ìux est ouverte ! Pense √† utiliser l'√©tape <strong>'Pr√©parer sa candidature'</strong> pour commencer √† r√©diger tes projets de formation motiv√©s. Chaque minute pass√©e dessus est un bon investissement !",
                    levels: ['terminale']
                });
            }
            
            // Si l'√©l√®ve a fait un quiz et a eu un mauvais score
            const aFaitUnQuiz = journalData.step7.domaine && journalData.step7.scores[journalData.step7.domaine];
            if(aFaitUnQuiz) {
                const lastQuiz = journalData.step7.scores[journalData.step7.domaine].slice(-1)[0];
                if(lastQuiz && (lastQuiz.score / lastQuiz.total) < 0.5) {
                    surprisesPossibles.push({
                        title: "L'erreur est une √©tape !",
                        content: `Ne t'inqui√®te pas pour ton dernier score au quiz sur "${journalData.step7.domaine}". Le plus important est ce que tu as appris ! Relis tes notes et n'h√©site pas √† explorer ce domaine dans l'√©tape <strong>'L'Actu'</strong> pour approfondir.`
                    });
                }
            }
            
            // --- 3. SURPRISES LI√âES √Ä L'ACTION (√âTAPES 8 √† 12) ---

            // Si l'√©l√®ve n'a ajout√© aucun contact
            const aAucunContact = !journalData.step8.contacts || journalData.step8.contacts.length === 0;
            if(metiersExplores > 0 && aAucunContact) {
                 surprisesPossibles.push({
                    title: "Passe √† la vitesse sup√©rieure !",
                    content: "La recherche en ligne, c'est bien. Le contact humain, c'est mieux ! Utilise l'√©tape <strong>'Passer √† l'action'</strong> pour trouver des professionnels √† qui poser tes questions."
                });
            }
            
            // Si le r√©troplanning a √©t√© g√©n√©r√© mais aucune t√¢che n'est coch√©e apr√®s un certain temps
            // (Cette logique n√©cessiterait de stocker la date de g√©n√©ration, donc on simplifie)
            
            // Si l'√©l√®ve est en Terminale et n'a pas encore r√©fl√©chi √† un plan B
            const planBVide = !journalData.step9.planb_chat_history || journalData.step9.planb_chat_history.length === 0;
            if(isTerminale && aExploreFormations && planBVide) {
                 surprisesPossibles.push({
                    title: "Et si... ?",
                    content: "C'est super d'avoir des objectifs clairs ! Mais les meilleurs strat√®ges ont toujours un plan B. Prends 5 minutes pour lancer la simulation de <strong>'Plan B'</strong> dans l'√©tape 'Anticiper la suite'. Mieux vaut pr√©venir que gu√©rir !",
                    levels: ['terminale']
                });
            }

            // Si le simulateur de vie √©tudiante n'a pas √©t√© utilis√©
            const aUtiliseSimulateurVieEtu = journalData.step12 && journalData.step12.city;
            if(aExploreFormations && !aUtiliseSimulateurVieEtu) {
                surprisesPossibles.push({
                    title: "Un d√©tail qui compte...",
                    content: "Tu as trouv√© des formations qui t'int√©ressent, bravo ! As-tu pens√© au co√ªt de la vie sur place ? Utilise le <strong>'Simulateur Vie √âtudiante'</strong> pour te faire une id√©e concr√®te.",
                    levels: ['terminale']
                });
            }
            
            // --- 4. SURPRISES LI√âES √Ä LA GAMIFICATION (XP, BADGES) ---
            
            // Si l'√©l√®ve est proche de passer un niveau
            const xpToNextLevel = xpNeededForLevel - xpInCurrentLevel;
            if(xpToNextLevel > 0 && xpToNextLevel < 50) {
                 surprisesPossibles.push({
                    title: "Presque ! üí™",
                    content: `Il ne te manque que <strong>${xpToNextLevel} XP</strong> pour atteindre le niveau suivant ! Une petite action comme utiliser le Radar ou faire un quiz pourrait te faire passer au rang de <strong>${rankNames[currentLevel + 1]['autre']}</strong> !`
                });
            }
            
            // Si l'√©l√®ve n'a aucun badge
            if(journalData.earned_badges.length === 0 && metiersExplores > 0) {
                 surprisesPossibles.push({
                    title: "Collectionne-les tous !",
                    content: "Savais-tu que tu pouvais d√©bloquer des badges en compl√©tant certaines √©tapes ? Par exemple, le <strong>Badge de l'Explorateur</strong> r√©compense ceux qui terminent les premi√®res √©tapes cl√©s. Consulte le guide pour en savoir plus !"
                });
            }
            
            // --- 5. SURPRISES G√âN√âRALES ---
            
            // Rappel de mettre √† jour le Fil Rouge
            if(journalData.xp > 500 && (!journalData.fil_rouge || journalData.fil_rouge.length < 20)) {
                 surprisesPossibles.push({
                    title: "Fais le point !",
                    content: "Tu as d√©j√† beaucoup explor√© ! C'est peut-√™tre le bon moment pour mettre √† jour ton <strong>'Fil Rouge'</strong> dans le Journal de Bord. OrIA peut t'aider √† synth√©tiser ton parcours."
                });
            }
            
            // Encouragement √† partager
            const aPartage = journalData.share_token;
            if(journalData.xp > 300 && !aPartage) {
                 surprisesPossibles.push({
                    title: "Et si on en parlait ?",
                    content: "Parler de son orientation, c'est essentiel. Pense √† utiliser la fonction de <strong>partage</strong> de ton Journal de Bord pour √©changer avec tes parents ou ton professeur principal."
                });
            }

            // --- S√©lection et affichage d'une surprise al√©atoire parmi les possibles ---
            if (surprisesPossibles.length > 0) {
                const surpriseFinale = surprisesPossibles[Math.floor(Math.random() * surprisesPossibles.length)];
                showSurpriseModal(surpriseFinale.title, surpriseFinale.content);
            }
        }
     
        const defaultData = {
                step0: { 
                q1: '', q2: '', q3: '', q4: '', q5: '', q6: '', q7: '', q8: '', q9: '', q10: '', 
                q11: '', q12: '', q13: '', q14: '', q15: '', q16: '', q17: '', q18: '', q19: '', q20: '', q21: '', 
                situation: '', // <--- AJOUTEZ CETTE LIGNE
                analysis: '', 
                archetype: null, 
                test_interets: '',
                test_motivation: '',
                test_personnalite: '',
                analyse_tests_croisee: '' },    
                step1: { explored_metiers: [], comparison: '' },
                step2: { combo1: '', notes1: '', skills1: '', combo2: '', notes2: '', skills2: '', combo3: '', notes3: '', skills3: '' },
                step3: { formation1: '', attendus1: '', mots_cles1: '', analyse_mots_cles1: '', formation2: '', attendus2: '', mots_cles2: '', analyse_mots_cles2: '', suggestions: '' },
                step4: { theme1: '', question1: '', suggestions1: '', theme2: '', question2: '', suggestions2: '' },
                step5: {
                article1: '', apprentissage1: '',
                article2: '', apprentissage2: '',
                article3: '', apprentissage3: '',
                analyse_actu: ''
            },
                step6: { formation: '', motivations: '', structure: '' },
                step7: { 
                domaine: '', 
                reflexions: '',
                scores: {}
            },
                step8: { pro_reseau_personnel: '', pro_metier: '', pro_departement: '', pro_contacts: '', pro_strategie: '', pro_media_query: '', pro_media_content: '', jpo_ecole: '', jpo_questions: '' },
                step9: { 
                formation_reve: '', 
                planb_chat_history: [],
                reussite_type: '', 
                reussite_conseils: '' 
            },
                step10: { experience1: '', analyse1: '', experience2: '', analyse2: '' },
                step11: { 
                location: '', 
                evenements: [], 
                structures: [],
                jpo_ecole: '',
                jpo_questions: '',
                salon_nom: '',
                salon_preparation: ''
            },
    
        step13: {
            recherches_sauvegardees: [],
            suggestions_idees: '',
            modele_mail: '',
            bilan_missions: '',
            bilan_apprentissages: '',
            bilan_ressenti: '',
            plan_rapport: '',
            competences_extraites: ''
        },
                retroplanning: '',
                retroplanning_saves: [], 
                fil_rouge: '',
                discussion_points: '',
                radar_history: [],
                earned_badges: [],
                xp: 0,
                level: 1,
                chatbot_last_interaction: null,
                chatbot_saves: [],
                tutorial_mission_1_shown: false,
                tutorial_mission_2_shown: false,
    // ‚ñº‚ñº‚ñº AJOUTEZ CETTE LIGNE ‚ñº‚ñº‚ñº
                tutorial_mission_3_shown: false, 
                tutorial_completed: false,
                tutorial_next_step: '',


            };
            
            async function loadData() {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            const docSnap = await getDoc(userDocRef);
            let data = docSnap.exists() ? docSnap.data() : {};
            
            userGradeLevel = data.gradeLevel || null;
            currentUserInfo = {
                firstName: data.firstName || '',
                lastName: data.lastName || '',
                schoolName: data.schoolName || '',
                gender: data.gender || 'autre',// <-- AJOUTEZ CETTE LIGNE (avec une valeur par d√©faut)
                role: data.role || 'eleve' // ‚úÖ AJOUT : On charge le r√¥le (par d√©faut "eleve")


            };

        
            const loadedJournal = data.journal || {};
            
            journalData = {};
            for (const key in defaultData) {
        // On ajoute une condition sp√©ciale pour les tableaux (Array)
        if (Array.isArray(defaultData[key])) {
            journalData[key] = loadedJournal[key] || defaultData[key];
        }
        // La logique existante pour les objets
        else if (loadedJournal[key] && typeof defaultData[key] === 'object' && defaultData[key] !== null) {
            journalData[key] = { ...defaultData[key], ...loadedJournal[key] };
        } 
        // La logique par d√©faut pour le reste
        else {
             journalData[key] = loadedJournal[key] || defaultData[key];
        }
    }
    
    // Cette v√©rification suppl√©mentaire est une bonne pratique
    if (!Array.isArray(journalData.radar_history)) {
        journalData.radar_history = [];
    }
    if (!Array.isArray(journalData.earned_badges)) {
        journalData.earned_badges = [];
    }
    
    checkBadges();

}


    function getProfileSummary() {
    let summary = "Voici un r√©sum√© du profil de l'√©l√®ve :\n";
    if (journalData.step0?.archetype?.titre) {
        summary += `- Son arch√©type de personnalit√© : ${journalData.step0.archetype.titre}\n`;
    }
    if (journalData.step0?.analysis) {
        summary += `- Analyse de son profil : "${journalData.step0.analysis}"\n`;
    }
    // MODIFICATION ICI : On lit le tableau de m√©tiers
    if (journalData.step1?.metiers && journalData.step1.metiers.length > 0) {
        const metiers = journalData.step1.metiers.map(m => m.nom).join(', ');
        summary += `- M√©tiers d√©j√† explor√©s : ${metiers}\n`;
    }
// NOUVELLE LIGNE
const formations = (journalData.step3?.formations || []).map(f => f.nom).filter(nom => nom && nom.trim());    if (formations.length > 0) {
        summary += `- Formations d√©j√† explor√©es : ${formations.join(', ')}\n`;
    }
    if (journalData.step10?.soft_skills_profile) {
        summary += `- R√©sum√© de ses comp√©tences : "${journalData.step10.soft_skills_profile}"\n`;
    }
    if (summary === "Voici un r√©sum√© du profil de l'√©l√®ve :\n") {
        return "L'√©l√®ve n'a pas encore rempli suffisamment son profil. Base-toi sur le bon sens et l'id√©e qu'il propose.";
    }
    return summary;
}

function formatDateAgo(date) {
    if (!date) return "Jamais";
    const now = new Date();
    // On s'assure que 'date' est bien un objet Date
    const activityDate = (typeof date.toDate === 'function') ? date.toDate() : new Date(date);
    const seconds = Math.floor((now - activityDate) / 1000);
    
    let interval = seconds / 86400; // secondes en jours
    if (interval > 7) return activityDate.toLocaleDateString('fr-FR');
    if (interval > 1.5) return `il y a ${Math.floor(interval)} jours`;
    if (interval > 0.8) return "hier";
    
    interval = seconds / 3600; // secondes en heures
    if (interval > 1) return `il y a ${Math.floor(interval)} heures`;
    
    interval = seconds / 60; // secondes en minutes
    if (interval > 1) return `il y a ${Math.floor(interval)} minutes`;
    
    return "√† l'instant";
}
        function getCompletionSummary() {
    let completed = [];
    let inProgress = [];

    allSteps.forEach(step => {
        if (['journal', 'retroplanning', 'guide'].includes(step.id)) return;

        if (isStepComplete(step.id)) {
            completed.push(`'${step.title}'`);
        } else {
            const stepData = journalData[step.id];
            if (stepData && typeof stepData === 'object') { // On v√©rifie que stepData est un objet
                const values = Object.values(stepData);
                const filledCount = values.filter(v => {
                    if (Array.isArray(v)) return v.length > 0;
                    return v && v.toString().trim() !== '';
                }).length;
                if (filledCount > 0) {
                    inProgress.push(`'${step.title}'`);
                }
            }
        }
    });

    let summary = "Voici un r√©sum√© de sa progression dans l'application :\n";
    if (completed.length > 0) {
        summary += `- √âtapes d√©j√† termin√©es : ${completed.join(', ')}.\n`;
    }
    if (inProgress.length > 0) {
        summary += `- √âtapes actuellement en cours : ${inProgress.join(', ')}.\n`;
    }
    if (completed.length === 0 && inProgress.length === 0) {
        summary += "- L'√©l√®ve n'a pas encore commenc√© √† explorer les √©tapes.\n";
    }
    return summary;
}

function getAppFeaturesSummary() {
    let summary = "Voici la liste des fonctionnalit√©s de l'application OrIAntation :\n";
    for (const stepKey in stepsConfig) {
        const config = stepsConfig[stepKey];
        
        // On s'assure que la propri√©t√© 'action' existe et est une cha√Æne de caract√®res
        if (config.action && typeof config.action === 'string') {
            // Logique simplifi√©e : on retire "Ta mission :" et toutes les balises HTML
            const actionDescription = config.action
                .replace(/<b>Ta mission :<\/b>/i, '') // Retire l'en-t√™te en gras
                .replace(/<[^>]*>/g, ' ')              // Retire toutes les autres balises HTML
                .replace(/\s+/g, ' ')                  // Remplace les espaces multiples par un seul
                .trim();                               // Nettoie les espaces au d√©but et √† la fin

            summary += `- √âtape '${config.title}': ${actionDescription}\n`;
        }
    }
    return summary;
}

    async function grantXp(points) {
            if (!journalData) return;

            journalData.xp = (journalData.xp || 0) + points;
            let currentLevel = journalData.level || 1;
            let leveledUp = false; // On utilise un indicateur pour savoir si un niveau a √©t√© gagn√©

            // On v√©rifie si l'utilisateur passe un ou plusieurs niveaux
            while (levelConfig[currentLevel + 1] && journalData.xp >= levelConfig[currentLevel + 1]) {
                currentLevel++;
                journalData.level = currentLevel;
                leveledUp = true;
            }
            
            // On sauvegarde les nouvelles donn√©es (XP et niveau)
            await saveData();

            // Si un niveau a √©t√© gagn√©, on affiche la nouvelle fen√™tre personnalis√©e
            if (leveledUp) {
                // CORRECTION DU BUG [object Object] : On s√©lectionne le bon titre
                const userGender = currentUserInfo.gender || 'autre';
                const rankTitle = rankNames[journalData.level][userGender] || rankNames[journalData.level]['autre'];

                const title = `üéâ Mont√©e de Niveau !`;
                const contentHTML = `
                    <p class="text-slate-600">Bravo, tu as atteint le</p>
                    <p class="text-2xl font-bold text-cyan-700 my-2">Niveau ${journalData.level} : ${rankTitle}</p>
                    <p class="text-slate-600">Continue sur cette lanc√©e pour d√©couvrir tout ton potentiel !</p>
                `;
                
                // On r√©utilise la fonction d'affichage des surprises pour un design coh√©rent
                showSurpriseModal(title, contentHTML);
            }

            // On met √† jour l'affichage du menu s'il est actuellement visible
            const menuView = document.querySelector('.fade-in');
            if (menuView && menuView.querySelector('#xp-chart')) {
                showView('menu');
            }
    
        }

        

// Trouvez cette fonction dans votre code et remplacez-la enti√®rement par ce qui suit.

function isStepStarted(stepKey) {
    const stepData = journalData[stepKey];
    if (!stepData) return false;

    // On v√©rifie si au moins une des valeurs dans les donn√©es de l'√©tape n'est pas "vide"
    return Object.values(stepData).some(value => {
        // IMPORTANT : On v√©rifie d'abord si la valeur est null ou undefined
        if (value === null || value === undefined) {
            return false;
        }
        // NOUVELLE LOGIQUE : On traite les tableaux (listes) en premier
        if (Array.isArray(value)) {
            return value.length > 0;
        }
        // ENSUITE, on v√©rifie les autres objets
        if (typeof value === 'object') {
            return Object.keys(value).length > 0; // Un objet est "commenc√©" seulement s'il a des cl√©s
        }
        // Enfin, pour les cha√Ænes de caract√®res et autres
        return value.toString().trim() !== '';
    });
}

       // Remplacez votre fonction showMenuAndWelcomeCheck par celle-ci

function showMenuAndWelcomeCheck() {
    showView('menu'); // Affiche le menu principal

    const nextStepId = journalData.tutorial_next_step;
    const isTutorialDone = journalData.tutorial_completed;

    // --- CAS N¬∞1 : L'√©l√®ve est un TOUT NOUVEL utilisateur ---
    // Gr√¢ce √† la correction de isStepStarted, cette condition fonctionnera √† nouveau.
    if (!isStepStarted('step0')) {
        setTimeout(() => {
            showWelcomeModal();
        }, 1500);
        return; 
    }

    // --- CAS N¬∞2 : L'√©l√®ve revient en cours de tutoriel ---
    if (nextStepId && !isTutorialDone) {
        const nextStepDetails = allSteps.find(step => step.id === nextStepId);
        
        if (nextStepDetails) {
            setTimeout(() => {
                showSurpriseModal(
                    "Mission en cours... üéØ",
                    `<p>Ravi de te revoir ! N'oublie pas, ta prochaine mission est de compl√©ter l'√©tape :</p>
                     <p class="mt-4 text-xl font-bold text-cyan-700">${nextStepDetails.title}</p>
                     <p class="text-sm text-slate-500 mt-2">Elle est mise en surbrillance sur le menu pour t'aider !</p>`
                );
            }, 1000);
        }
    }
}

function showWelcomeModal() {
    const title = `Bienvenue sur OrIAntation, ${currentUserInfo.firstName} ! üëã`;
    const contentHTML = `
        <p class="text-slate-600"> Je suis l√† pour t'aider sur les d√©buts de ton aventure.</p>
        <p class="mt-4 font-semibold text-azimut-darkblue">Pour bien commencer, ta premi√®re mission est de nous permettre de faire connaissance. Clique sur l'√©tape "Mieux se conna√Ætre", r√©ponds au questionaire pour g√©n√©rer ton analyse de profil et clique enfin sur le bouton terminer pour passer √† la suite!</p>
    `;
    showSurpriseModal(title, contentHTML);
}
        
      // ‚úÖ NOUVELLE VERSION DE LA FONCTION

// REMPLACEZ votre fonction showGradeSelectionView par celle-ci
function showGradeSelectionView() {
    mainApp.innerHTML = `
        <div class="bg-white p-8 rounded-2xl shadow-lg border border-border-subtle fade-in text-center">
            <h1 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Bienvenue !</h1>
            <p class="text-slate-600 mb-6">Pour commencer et personnaliser ton parcours, s√©lectionne ta classe :</p>
            <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                <button data-grade="seconde" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Seconde</button>
                <button data-grade="premiere" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Premi√®re</button>
                <button data-grade="terminale" class="grade-btn bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Terminale</button>
            </div>
        </div>
    `;

    mainApp.querySelectorAll('.grade-btn').forEach(button => {
    button.addEventListener('click', async (e) => {
        userGradeLevel = e.target.dataset.grade; 
        await saveData(); 
        await loadData();
        showMenuAndWelcomeCheck(); // <-- APPEL CORRIG√â
    });
});
}


async function callOpenAI_API({ promptText, model = 'gpt-4o', isJson = false, withPersona = false, promptId = null, loaderElement = null, isExpertCall = false, customLoaderHTML = null }) {
    let finalPrompt = promptText;
    if (withPersona) { finalPrompt = `${PERSONA_IA}\n\n# Ta Mission Sp√©cifique\n${promptText}`; }
    finalPrompt = addGenderContextToPrompt(finalPrompt);
    if (isJson) { finalPrompt += "\n\n# Format de Sortie OBLIGATOIRE\nTa r√©ponse doit √™tre uniquement un objet JSON valide..."; }

    const functionUrl = "https://europe-west3-monapp0rientation.cloudfunctions.net/generateContent";
    
    // ‚úÖ CORRECTION : Le message ne s'affiche que si 'isExpertCall' est vrai
    if (loaderElement) {
    if (customLoaderHTML) {
        // Si un texte personnalis√© est fourni, on l'utilise
        loaderElement.innerHTML = customLoaderHTML;
    } else if (isExpertCall) {
        // Sinon, on utilise le texte par d√©faut pour les appels "Expert"
        loaderElement.innerHTML = `
            <div class="loader"></div>
            <p class="text-slate-500 font-semibold mt-2">Te voil√† au c≈ìur du r√©acteur...</p>
            <p class="text-sm text-slate-400 mt-1">Analyse fondamentale en cours, cela peut prendre un instant...</p>
        `;
    }
}
    
    let bodyPayload;
    if (promptId) {
        bodyPayload = { promptId: promptId, variables: { mission: finalPrompt } };
    } else {
        bodyPayload = { prompt: finalPrompt, model: model };
    }

    try {
        const response = await fetch(functionUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bodyPayload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Erreur du serveur: ${errorData.error || response.statusText}`);
        }

        const data = await response.json();
        return data.result;

    } catch (error) {
        console.error("Error calling Cloud Function:", error);
        // ‚úÖ LA CORRECTION EST ICI : On retourne une cha√Æne de caract√®res en cas d'erreur
        return `Impossible de contacter le service d'IA. (${error.message})`;
    }
}

function addGenderContextToPrompt(prompt) {
    // On r√©cup√®re le genre de l'utilisateur, sauvegard√© √† l'inscription
    const gender = currentUserInfo.gender || 'autre'; 
    let genderInstruction = '';

    if (gender === 'femme') {
        genderInstruction = "R√®gle de ton absolue : L'√©l√®ve que tu aides est une fille. Tu dois imp√©rativement accorder toute ta r√©ponse au f√©minin (adjectifs, noms de m√©tiers, etc.). Par exemple, √©cris 'tu es cr√©ative et organis√©e', 'une exploratrice', 'une experte'.";
    } else if (gender === 'homme') {
        genderInstruction = "R√®gle de ton absolue : L'√©l√®ve que tu aides est un gar√ßon. Tu dois imp√©rativement accorder toute ta r√©ponse au masculin. Par exemple, √©cris 'tu es cr√©atif et organis√©', 'un explorateur', 'un expert'.";
    } else {
        genderInstruction = "R√®gle de ton absolue : Le genre de l'√©l√®ve n'est pas sp√©cifi√© ou est 'autre'. Utilise une √©criture inclusive ou neutre (ex: 'cr√©atif/cr√©ative', 'un(e) expert(e)') pour t'adresser √† la personne.";
    }

    // On ajoute cette instruction au d√©but du prompt original
    return `${genderInstruction}\n\n---\n\n${prompt}`;
}
       
async function showView(viewName, data = null) { // MODIFICATION ICI
    currentViewName = viewName; // <-- AJOUTEZ CETTE LIGNE
    authContainer.style.display = 'none';
    mainApp.style.display = 'block';
    mainApp.innerHTML = '';
    
    if (viewName === 'menu') {
        triggerSurpriseMoment();
    }
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const floatingBackBtn = document.getElementById('floatingBackBtn');

    // Note: 'privacyPolicy' est ajout√© ici pour cacher le bouton de retour sur cette vue
const showChatbotOn = ['menu', 'home', 'step0', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9', 'step10', 'step11', 'step12', 'step13', 'retroplanning', 'journal'];
const showBackButtonOn = ['step0', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6', 'step7', 'step8', 'step9', 'step10', 'step11', 'step12', 'step13', 'retroplanning', 'journal', 'guide', 'privacy'];
    if (chatbotToggle) {
        if (showChatbotOn.includes(viewName)) {
            chatbotToggle.style.display = 'flex';
        } else {
            chatbotToggle.style.display = 'none';
        }
    }
    
    if (floatingBackBtn) {
    // Logique simplifi√©e : Le bouton est affich√© si la page est dans la liste.
    // Le code qui g√®re le clic d√©cidera de la bonne action de retour.
    if (showBackButtonOn.includes(viewName)) {
        floatingBackBtn.style.display = 'flex';
    } else {
        floatingBackBtn.style.display = 'none';
    }
}

    let newView;
    switch(viewName) {
        case 'home': newView = createHomeView(); break;
        case 'menu': newView = createMenuView(); break;
        case 'step0': newView = createStep0View(); break;
        case 'step1': newView = createStep1View(); break;
        case 'step2': newView = createStep2View(); break;
        case 'step3': newView = createStep3View(); break;
        case 'step4': newView = createStep4View(); break;
        case 'step5': newView = createStep5View(); break;
        case 'step6': newView = createStep6View(); break;
        case 'step7': newView = createStep7View(); break;
        case 'step8': newView = createStep8View(); break;
        case 'step9': newView = createStep9View(); break;
        case 'step10': newView = createStep10View(); break;
        case 'step11': newView = createStep11View(); break;
        case 'step12': newView = createStep12View(); break;
        case 'step13': newView = createStep13View(); break; // <-- AJOUTEZ CETTE LIGNE
        case 'guide': newView = createGuideView(); break;
        case 'retroplanning': newView = createRetroplanningView(); break;
        case 'journal': newView = await createJournalView(); break;
        case 'teacherDashboard': newView = createTeacherDashboardView(); break; // ‚¨ÖÔ∏è NOUVEAU
        case 'teacherStudentJournal': newView = createTeacherStudentJournalView(data); break;
        case 'privacy': newView = createPrivacyPolicyView(); break;
        default: newView = createHomeView();
    }
    if (newView) mainApp.appendChild(newView);
    window.scrollTo(0, 0);

        addVoiceDictationToInputs();

}
        
function createMenuView() {
    const div = document.createElement('div');
    div.className = 'fade-in';

    // --- 1. Logique pour le haut du menu (Donn√©es utilisateur, XP, Badges) ---
    const currentLevel = journalData.level || 1;
    const currentXp = journalData.xp || 0;
    const xpForCurrentLevel = levelConfig[currentLevel];
    const xpForNextLevel = levelConfig[currentLevel + 1] || Infinity;
    const xpInCurrentLevel = currentXp - xpForCurrentLevel;
    const xpNeededForLevel = xpForNextLevel - xpForCurrentLevel;
    const userGender = currentUserInfo.gender || 'autre';
    const rankTitle = rankNames[currentLevel] ? (rankNames[currentLevel][userGender] || rankNames[currentLevel]['autre']) : 'D√©butant';
    
    let badgesHTML = '';
    const earnedBadges = journalData.earned_badges || [];

    if (earnedBadges.length > 0) {
        const lastBadgeKey = earnedBadges[earnedBadges.length - 1];
        const lastBadge = badgesConfig[lastBadgeKey];
        if (lastBadge) {
            badgesHTML = `<div class="flex flex-col items-center justify-center h-full w-full text-center p-2"><span class="text-5xl">${lastBadge.icon}</span><p class="font-bold text-OrIAntation-darkblue text-xs mt-2 leading-tight">${lastBadge.title}</p></div>`;
        }
    } else {
        badgesHTML = `<div class="w-full h-full bg-cover bg-center bg-no-repeat rounded-full" style="background-image: url('logo_badges.png');"></div>`;
    }

let teacherButtonHTML = '';
if (currentUserInfo.role === 'enseignant') {
    teacherButtonHTML = `
        <div class="text-center mb-4">
            <button onclick="showView('teacherDashboard')" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-600 transition">
                Acc√©der √† mon Tableau de Bord Enseignant
            </button>
        </div>
    `;
}

    const levelDisplayHTML = `
    <div class="mb-10 bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
        <div class="flex flex-wrap justify-center items-center gap-6 md:flex-nowrap md:justify-between">
            <div class="relative w-32 h-32 cursor-pointer flex-shrink-0 js-xp-gauge order-2 md:order-1">
                <canvas id="xp-chart"></canvas>
                <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                    <span class="font-bold text-2xl text-OrIAntation-darkblue">${xpInCurrentLevel}</span>
                    <span class="text-xs text-slate-500">/${xpNeededForLevel} XP</span>
                </div>
            </div>
            <div class="text-center w-full md:w-auto order-1 md:order-2">
                <h1 class="text-3xl font-bold text-OrIAntation-darkblue">Choisis ton cap, ${capitalizeWords(currentUserInfo.firstName)} !</h1>
                <p class="text-slate-500 mt-2 text-sm">en classe de <span class="font-semibold text-cyan-700">${userGradeLevel ? userGradeLevel.charAt(0).toUpperCase() + userGradeLevel.slice(1) : ''}</span> √† <span class="font-semibold text-cyan-700">${capitalizeWords(currentUserInfo.schoolName)}</span></p>
                <h2 class="text-xl font-bold text-cyan-700 mt-4">Niveau d'Exploration ${currentLevel} : ${rankTitle}</h2>
                <div class="flex justify-center items-center gap-2 mt-3 text-sm whitespace-nowrap">
                    <button class="text-cyan-700 hover:underline js-change-grade">Modifier ma classe</button>
                    <span class="text-slate-400">|</span>
                    <button class="text-sm text-cyan-700 hover:underline js-logout">Se d√©connecter</button>
                </div>
            </div>
            <div class="w-32 h-32 bg-background-light rounded-full border flex flex-col items-center justify-center p-0 cursor-pointer flex-shrink-0 js-badges-container order-3 md:order-3">
                ${badgesHTML}
            </div>
        </div>
    </div>`;
    
    // --- 2. Nouvelle logique d'affichage du menu par cat√©gories ---
    const allStepsForLevel = allSteps.filter(step => step.levels.includes(userGradeLevel));

    const dashboardSteps = allStepsForLevel.filter(step => step.category === 'dashboard');
    const exploreSteps = allStepsForLevel.filter(step => step.category === 'explore');
    const connectSteps = allStepsForLevel.filter(step => step.category === 'connect');
    const buildSteps = allStepsForLevel.filter(step => step.category === 'build');

    const createStepCardHTML = (step) => {
        let statusSymbol = '';
        if (!['journal', 'retroplanning', 'step12', 'guide'].includes(step.id) && journalData[step.id]) {
             if (isStepComplete(step.id)) {
                statusSymbol = `<span class="ml-2 text-green-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd" /></svg></span>`;
            } else if (isStepStarted(step.id)) {
                statusSymbol = `<span class="ml-2 text-orange-400"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-13a.75.75 0 0 0-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 0 0 0-1.5h-3.25V5Z" clip-rule="evenodd" /></svg></span>`;
            }
        }
        const nextStepId = journalData.tutorial_next_step || '';
        const isNextMission = step.id === nextStepId && !journalData.tutorial_completed && !isStepComplete(nextStepId);
        const highlightClass = isNextMission ? 'next-mission-highlight' : '';
        
        return `
         <div onclick="window.showView('${step.id}')" class="step-card bg-white p-6 rounded-xl shadow-md border border-border-subtle cursor-pointer flex flex-col items-center space-y-4 text-center w-full sm:w-[calc(50%-1rem)] lg:w-[calc(33.333%-1rem)] ${highlightClass}">
            <div>${step.icon}</div>
            <div>
                <div class="flex justify-center items-center">
                     <h2 class="text-lg font-semibold text-OrIAntation-darkblue">${step.title}</h2>
                     ${statusSymbol}
                </div>
                <p class="text-slate-500">${step.site}</p>
            </div>
         </div>`;
    };

    const dashboardHTML = dashboardSteps.map(createStepCardHTML).join('');
    const exploreHTML = exploreSteps.map(createStepCardHTML).join('');
    const connectHTML = connectSteps.map(createStepCardHTML).join('');
    const buildHTML = buildSteps.map(createStepCardHTML).join('');

    const menuGridHTML = `
        <div class="mt-8 space-y-12">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-6 text-center flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0 1 18 16.5h-2.25m-7.5 0h7.5m-7.5 0-1 3m8.5-3 1 3m0 0 .5 1.5m-.5-1.5h-9.5m0 0-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" /></svg>
                    Tableau de Bord
                </h2>
                <div class="flex flex-wrap justify-center gap-4 w-full">${dashboardHTML}</div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-8 text-center flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.25c-.748-.374-1.628.17-1.628 1.006v8.69c0 .426.24.815.622 1.006l4.875 2.437a1.875 1.875 0 0 0 1.006 0Z" /></svg>
                    Le Parcours d'Orientation
                </h2>
                <div class="space-y-8">
                    <div>
                        <h3 class="text-xl font-semibold text-cyan-700 mb-4 flex items-center gap-3">
                            <span class="bg-cyan-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">1</span>
                            Explorer les Possibilit√©s
                        </h3>
                        <div class="flex flex-wrap justify-center gap-4 w-full">${exploreHTML}</div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-cyan-700 mb-4 flex items-center gap-3">
                            <span class="bg-cyan-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">2</span>
                            Se Connecter au Monde R√©el
                        </h3>
                        <div class="flex flex-wrap justify-center gap-4 w-full">${connectHTML}</div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-cyan-700 mb-4 flex items-center gap-3">
                            <span class="bg-cyan-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg">3</span>
                            Construire son Projet
                        </h3>
                        <div class="flex flex-wrap justify-center gap-4 w-full">${buildHTML}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const progressBarHTML = createProgressBarHTML();
    const guideCardHTML = `
    <div onclick="window.showView('guide')" class="step-card bg-white p-6 rounded-xl shadow-md border border-border-subtle cursor-pointer flex flex-col items-center space-y-2 mb-6 max-w-md mx-auto">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-OrIAntation-darkblue"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" /></svg>
        <div class="text-center">
            <h2 class="text-lg font-semibold text-OrIAntation-darkblue">Guide d'Utilisation</h2>
            <p class="text-sm text-slate-500">Besoin d'aide pour commencer ?</p>
        </div>
    </div>`;
    const radarHTML = `
        <div class="mt-12 text-center fade-in">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="m15.75 15.75-2.489-2.489m0 0a3.375 3.375 0 1 0-4.773-4.773 3.375 3.375 0 0 0 4.774 4.774ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                <span>Le Radar √† Opportunit√©s</span>
            </h2>
            <p class="text-slate-600 max-w-2xl mx-auto mb-6">Teste ici tes propres id√©es de m√©tiers ou laisse OrIA t'en proposer une √† laquelle tu n'aurais jamais pens√© !</p>
            <div class="bg-white p-6 rounded-2xl shadow-md border border-border-subtle">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <input type="text" id="radarInput" class="w-full md:flex-1 p-3 border border-slate-300 rounded-lg" placeholder="Propose un m√©tier ou un domaine...">
                    <button id="radarAnalyzeBtn" class="w-full md:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Analyser mon id√©e</button>
                </div>
                <div class="my-4 text-slate-500 font-semibold">OU</div>
                <button id="radarSurpriseBtn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Me surprendre !</button>
            </div>
            <div id="radarLoader" class="hidden"><div class="loader"></div></div>
            <div id="radarResult" class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-slate-700 text-left hidden prose prose-sm max-w-none"></div>
        </div>
    `;
    
    div.innerHTML = teacherButtonHTML + levelDisplayHTML + `<div class="max-w-xl mx-auto my-8">${progressBarHTML}</div>` + guideCardHTML + menuGridHTML + radarHTML;
    
    setTimeout(() => {
        const canvas = div.querySelector('#xp-chart');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            const xpRemaining = Math.max(0, xpNeededForLevel - xpInCurrentLevel);
            new Chart(ctx, { type: 'doughnut', data: { datasets: [{ data: [xpInCurrentLevel, xpRemaining], backgroundColor: ['#f59e0b', '#e2e8f0'], borderColor: ['#ffffff', '#ffffff'], borderWidth: 2 }] }, options: { responsive: true, cutout: '80%', plugins: { legend: { display: false }, tooltip: { enabled: false } } } });
        }
    }, 0);

    const loader = div.querySelector('#radarLoader');
    const resultDiv = div.querySelector('#radarResult');
    const radarInput = div.querySelector('#radarInput');

    const displayRadarResult = (type, subject, response) => {
        resultDiv.classList.remove('hidden');
        resultDiv.innerHTML = '';
        const textElement = document.createElement('div');
        textElement.innerHTML = marked.parse(linkify(response));
        resultDiv.appendChild(textElement);
        const buttonsContainer = document.createElement('div');
        buttonsContainer.className = 'flex gap-4 mt-4 pt-4 border-t';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'flex-1 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition';
        saveBtn.textContent = 'Enregistrer dans le journal';
        saveBtn.addEventListener('click', async () => {
            if (!Array.isArray(journalData.radar_history)) { journalData.radar_history = []; }
            journalData.radar_history.push({ type: type, sujet: subject, reponse: response });
            await saveData();
            await grantXp(15);
            saveBtn.textContent = 'Enregistr√© ! ‚úî';
            saveBtn.disabled = true;
        });
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'flex-1 bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600 transition';
        cancelBtn.textContent = 'Je vais r√©fl√©chir √† autre chose';
        cancelBtn.addEventListener('click', () => { resultDiv.classList.add('hidden'); });
        buttonsContainer.appendChild(saveBtn);
        buttonsContainer.appendChild(cancelBtn);
        resultDiv.appendChild(buttonsContainer);
    };

    div.querySelector('#radarAnalyzeBtn').addEventListener('click', async () => {
    const userInput = radarInput.value.trim();
    if (!userInput) return;
    loader.style.display = 'block';
    resultDiv.classList.add('hidden');
    
    const profileSummary = getProfileSummary();
    
    // ON R√âCUP√àRE LE MODE D'EMPLOI DE L'APP
    const appFeaturesSummary = getAppFeaturesSummary();

    // ‚úÖ PROMPT FINAL, STRICT ET CONTEXTUALIS√â
    const prompt = `
            Agis comme un conseiller d'orientation expert, bienveillant et r√©aliste.
            
            # Contexte de l'Application
            Voici la liste des seules fonctionnalit√©s que tu peux sugg√©rer. N'en invente aucune autre.
            ${appFeaturesSummary}

            # Donn√©es sur l'√©l√®ve
            - Id√©e de m√©tier propos√©e : "${userInput}"
            - R√©sum√© de son profil : ${profileSummary}

            # Ta Mission
            R√©dige une analyse riche et structur√©e de l'id√©e de l'√©l√®ve. Utilise tes capacit√©s de recherche web pour les donn√©es chiffr√©es.

            # Format de Sortie OBLIGATOIRE
            Ta r√©ponse doit √™tre fluide et naturelle. Il est **imp√©ratif** de ne JAMAIS utiliser les caract√®res '#' ou '*' ou '-' pour faire des listes.
            Utilise uniquement du texte en gras (avec **) pour les titres, et r√©dige chaque section comme un paragraphe enti√®rement r√©dig√©.
            
            Structure ta r√©ponse avec les titres suivants :

            **En quoi consiste ce m√©tier ?**
            (R√©dige une description vivante et concr√®te, en int√©grant les missions principales dans le texte.)

            **Points de Connexion avec ton Profil**
            (Sois tr√®s sp√©cifique. Fais le lien entre ce m√©tier et les forces de l'√©l√®ve en r√©digeant un paragraphe argument√©.)

            **Parcours & Perspectives**
            (Int√®gre les informations sur le niveau d'√©tudes, le salaire et les perspectives d'avenir dans un paragraphe coh√©rent.)

            **Ta Premi√®re Mission d'Exploration**
            (Propose UNE SEULE action concr√®te, claire et motivante, r√©alisable en utilisant une fonctionnalit√© de l'application.)
        `;

    
const result = await callOpenAI_API({
    promptText: prompt,    // Le prompt brut, SANS addGenderContextToPrompt
    withPersona: true,     // Mettez 'true' si c'est un conseil de coach, 'false' sinon
    isJson: false,         // Mettez 'true' si vous attendez une r√©ponse au format JSON
    model: 'gpt-4o'        // 'gpt-4o' par d√©faut, ou 'gpt-5' pour les t√¢ches expertes
});    
        const cleanedResult = result.replace(/###? /g, '').replace(/[\*-] /g, '');


loader.style.display = 'none';
    displayRadarResult('Analyse', userInput, result);
});

    div.querySelector('#radarSurpriseBtn').addEventListener('click', async () => {
    loader.style.display = 'block';
    resultDiv.classList.add('hidden');
    
    let previousSuggestions = "Aucune suggestion pr√©c√©dente.";
    if (journalData.radar_history && journalData.radar_history.length > 0) {
        const suggestionNames = journalData.radar_history.map(item => item.sujet);
        previousSuggestions = `Pistes d√©j√† explor√©es : ${suggestionNames.join(', ')}.`;
    }
    const profileSummary = getProfileSummary();
    const randomAngle = creativeAngles[Math.floor(Math.random() * creativeAngles.length)];
    
    // ON R√âCUP√àRE LE MODE D'EMPLOI DE L'APP
    const appFeaturesSummary = getAppFeaturesSummary();

    // ‚úÖ PROMPT FINAL, STRICT ET CONTEXTUALIS√â
    const prompt = `
    Agis comme un coach d'orientation cr√©atif et expert du march√© du travail.
    
    # Contexte de l'Application
    Voici la liste des seules fonctionnalit√©s que tu peux sugg√©rer. N'en invente aucune autre.
    ${appFeaturesSummary}

    # Donn√©es sur l'√©l√®ve
    - Profil : ${profileSummary}
    - ${previousSuggestions}
    - Angle cr√©atif du jour : "${randomAngle}"

    # Ta Mission
    Propose UNE seule id√©e de m√©tier inattendue mais pertinente. Utilise tes capacit√©s de recherche web pour les donn√©es chiffr√©es.

    # Format de Sortie OBLIGATOIRE
    Ta r√©ponse doit √™tre fluide et naturelle. Il est **imp√©ratif** de ne JAMAIS utiliser les caract√®res '#' ou '*' ou '-' pour faire des listes.
    Utilise uniquement du texte en gras (avec **) pour les titres, et r√©dige chaque section comme un paragraphe enti√®rement r√©dig√©.

    Structure ta r√©ponse avec les titres suivants :

    **[SUR LA PREMI√àRE LIGNE, INVENTE ET √âCRIS UNIQUEMENT UN TITRE PRECIS ET INSPIRANT, SANS AUCUN LABEL COMME "Titre :"]**

    **Piste Sugg√©r√©e : [Nom du m√©tier]**
    (R√©dige une accroche en une phrase pour susciter la curiosit√©.)

    **Pourquoi cette id√©e pour toi ?**
    (Explique en 2-3 phrases le lien surprenant mais logique avec le profil de l'√©l√®ve.)

    **√Ä quoi √ßa ressemble ?**
    (D√©cris les missions principales de ce m√©tier dans un paragraphe, sans utiliser de liste √† puces.)

    **La R√©alit√© du Terrain**
    (R√©dige un paragraphe qui int√®gre le niveau d'√©tudes, le salaire d√©butant et les perspectives d'avenir.)

    **Ta Premi√®re Mission d'Exploration**
    (Propose UNE SEULE action concr√®te et simple que l'√©l√®ve peut r√©aliser en utilisant une seule des fonctionnalit√©s de l'application.)
`;


const result = await callOpenAI_API({
    promptText: prompt,    // Le prompt brut, SANS addGenderContextToPrompt
    withPersona: true,     // Mettez 'true' si c'est un conseil de coach, 'false' sinon
    isJson: false,         // Mettez 'true' si vous attendez une r√©ponse au format JSON
    model: 'gpt-4o'        // 'gpt-4o' par d√©faut, ou 'gpt-5' pour les t√¢ches expertes
});    

        const cleanedResult = result.replace(/###? /g, '').replace(/[\*-] /g, '');
        const finalResult = cleanedResult.replace(/\*\*Titre Cr√©atif de la Piste\s?:\s?\*\*\n?/, '');



const sujet = result.split('\n')[0].replace(/\*\*/g, '').replace('La Piste Sugg√©r√©e :', '').trim();
        loader.style.display = 'none';
        displayRadarResult('Surprise', sujet, result);
    });

    div.querySelectorAll('.js-logout').forEach(button => {
        button.addEventListener('click', async () => { await signOut(auth); });
    });
    
    div.querySelectorAll('.js-change-grade').forEach(button => {
        button.addEventListener('click', () => { showGradeSelectionView(); });
    });

    div.querySelectorAll('.js-xp-gauge').forEach(container => {
        container.addEventListener('click', () => {
            const title = "‚≠ê Qu'est-ce que le syst√®me d'XP ?";
            const contentHTML = `<div class="space-y-4 text-slate-600"><p>Le syst√®me de Points d'Exp√©rience (XP) transforme ton parcours d'orientation en une aventure ! Chaque action importante te rapporte des points pour mat√©rialiser ta progression.</p><div class="p-4 bg-background-light rounded-lg border"><h4 class="font-semibold text-OrIAntation-darkblue mb-2">Comment √ßa marche ?</h4><p>Tes XP remplissent la jauge circulaire. Une fois pleine, tu passes au niveau sup√©rieur et gagnes un nouveau rang, montrant que tu avances dans ta qu√™te !</p></div><div class="p-4 bg-background-light rounded-lg border"><h4 class="font-semibold text-OrIAntation-darkblue mb-2">Comment gagner des XP ?</h4><ul class="list-disc list-inside text-sm"><li>En analysant ton profil ("Mieux se conna√Ætre").</li><li>En g√©n√©rant ton R√©troplanning.</li><li>En valorisant une exp√©rience dans ton Portfolio.</li><li>En obtenant un bon score √† un quiz "Fact Checking".</li><li>En utilisant le Radar √† Opportunit√©s.</li></ul></div></div>`;
            createSimpleModal(title, contentHTML);
        });
    });

    div.querySelectorAll('.js-badges-container').forEach(container => {
        container.addEventListener('click', () => {
            const title = "üèÜ Qu'est-ce que le syst√®me de Badges ?";
            let contentHTML = `<div class="space-y-4 text-slate-600"><p>Les badges sont des r√©compenses sp√©ciales que tu d√©bloques en accomplissant des ensembles d'√©tapes cl√©s. Ils symbolisent tes grandes r√©ussites dans ton parcours d'orientation !</p><div class="space-y-3">`;
            for (const key in badgesConfig) {
                const badge = badgesConfig[key];
                const earned = earnedBadges.includes(key);
                contentHTML += `<div class="flex items-start gap-4 p-3 rounded-lg ${earned ? 'bg-amber-50 border border-amber-200' : 'bg-background-light border border-border-subtle'}"><span class="text-4xl ${earned ? '' : 'opacity-40'}">${badge.icon}</span><div><h4 class="font-bold ${earned ? 'text-amber-800' : 'text-OrIAntation-darkblue'}">${badge.title} ${earned ? '(Obtenu !)' : '(√Ä d√©bloquer)'}</h4><p class="text-sm">${badge.description}</p></div></div>`;
            }
            contentHTML += `</div></div>`;
            createSimpleModal(title, contentHTML);
        });
    });

    div.querySelector('#progress-help-btn').addEventListener('click', () => {
        const title = "√Ä quoi correspondent les coches ?";
        const contentHTML = `
            <div class="space-y-4 text-slate-600 text-left">
                <p>Les coches √† c√¥t√© des √©tapes vous permettent de suivre votre progression en un coup d'≈ìil.</p>
                <div>
                    <h4 class="font-semibold text-OrIAntation-darkblue"><span class="text-orange-400 font-bold">‚úî</span> Coche Orange</h4>
                    <p class="text-sm pl-6">Signifie que vous avez <strong>commenc√©</strong> √† explorer une √©tape, mais que vous ne l'avez pas encore termin√©e.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-OrIAntation-darkblue"><span class="text-green-500 font-bold">‚úî</span> Coche Verte</h4>
                    <p class="text-sm pl-6">Signifie que vous avez <strong>termin√©</strong> l'√©tape en remplissant toutes les informations principales demand√©es.</p>
                </div>
                <p class="pt-4 border-t mt-4">Votre objectif est de faire passer un maximum d'√©tapes au vert pour construire le projet d'orientation le plus complet et le plus solide possible !</p>
            </div>
        `;
        createSimpleModal(title, contentHTML);
    });

    return div;
}

function createTeacherDashboardView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';
    
    // On utilise currentUserInfo.firstName pour personnaliser le titre
    div.innerHTML = `
        <img src="logo.png" alt="Logo OrIAntation" class="mx-auto h-60 w-auto mb-4">
        <h1 class="text-2xl font-bold text-OrIAntation-darkblue mb-1 text-center">Tableau de Bord de ${currentUserInfo.firstName} ${currentUserInfo.lastName}</h1>
        <p class="text-center text-slate-500 mb-4">${currentUserInfo.gender === 'femme' ? 'Enseignante' : 'Enseignant'} au ${currentUserInfo.schoolName}</p>        
        
        <div class="text-center mb-6 flex justify-center items-center gap-4">
            <button id="show-guide-from-dashboard" class="text-sm text-cyan-700 hover:underline transition">
                Guide d'utilisation
            </button>
            <span class="text-slate-400">|</span>
            <button onclick="signOut(auth)" class="text-sm text-slate-500 hover:text-red-600 hover:underline transition">
                Se d√©connecter
            </button>
        </div>
        
        <div id="stats-container" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
            <div class="bg-sky-50 p-4 rounded-lg text-center border border-sky-200">
                <p class="text-sm text-sky-700 font-semibold">√âl√®ves dans la classe</p>
                <p id="stats-total-students" class="text-2xl font-bold text-sky-900">-</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center border border-green-200">
                <p class="text-sm text-green-700 font-semibold">Progression moyenne</p>
                <p id="stats-avg-progress" class="text-2xl font-bold text-green-900">- %</p>
            </div>
            <div class="bg-orange-50 p-4 rounded-lg text-center border border-orange-200">
                <p class="text-sm text-orange-700 font-semibold">√âl√®ves √† suivre</p>
                <p id="stats-at-risk" class="text-2xl font-bold text-orange-900">-</p>
            </div>
        </div>
        <div id="invite-code-container" class="mb-8"></div>

        <div class="text-center mb-6">
            <button id="show-analytics-btn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">
                üìä Voir les statistiques d√©taill√©es de la classe
            </button>
        </div>
        <div id="analytics-container" class="hidden my-8 p-6 bg-gray-50 rounded-lg border"></div>
        
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <input type="text" id="teacher-search-input" placeholder="Rechercher un √©l√®ve..." class="w-full sm:flex-1 p-2 border rounded-lg">
            <select id="teacher-sort-filter" class="w-full sm:w-auto p-2 border rounded-lg bg-white">
                <option value="name_asc">Trier par nom (A-Z)</option>
                <option value="progress_desc">Trier par progression (d√©croissant)</option>
                <option value="progress_asc">Trier par progression (croissant)</option>
                <option value="activity_desc">Trier par derni√®re activit√©</option>
            </select>
        </div>
    
        <div id="dashboard-content">
            <div class="loader"></div>
            <p class="text-center text-slate-500 mt-2">Chargement des donn√©es de la classe...</p>
        </div>
    `;

    const showGuideBtn = div.querySelector('#show-guide-from-dashboard');
    if (showGuideBtn) {
        showGuideBtn.addEventListener('click', () => {
            guideUserRole = 'enseignant'; // On s'assure que le bon profil de guide est charg√©
            showView('guide');          // On affiche la vue du guide
        });
    }

    // Le reste de la logique JavaScript de la fonction reste inchang√©
    
    const formatDate = (isoString) => {
        if (!isoString) return 'Jamais';
        const date = new Date(isoString);
        const now = new Date();
        const diffDays = Math.round((now - date) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return "Aujourd'hui";
        if (diffDays === 1) return 'Hier';
        if (diffDays <= 7) return `Il y a ${diffDays} jours`;
        return `Le ${date.toLocaleDateString('fr-FR')}`;
    };

    let allStudents = [];

    const renderTable = (studentsToRender) => {
        const contentDiv = div.querySelector('#dashboard-content');
        if (studentsToRender.length === 0 && allStudents.length > 0) {
            contentDiv.innerHTML = '<p class="text-center text-slate-500 p-4">Aucun √©l√®ve ne correspond √† votre recherche.</p>';
            return;
        }

        const statusIndicators = {
            at_risk: { color: 'bg-orange-500', title: '√âl√®ve √† suivre (inactif ou bloqu√©)' },
            active: { color: 'bg-green-500', title: '√âl√®ve actif' },
            excellent: { color: 'bg-blue-500', title: 'Progression excellente' }
        };

        let tableHTML = `
    <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">√âl√®ve</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Derni√®re activit√©</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progression</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
${studentsToRender.map(student => {
                    const statusIndicators = {
                        at_risk: { color: 'bg-orange-500', title: '√âl√®ve √† suivre (inactif ou bloqu√©)' },
                        active: { color: 'bg-green-500', title: '√âl√®ve actif' },
                        excellent: { color: 'bg-blue-500', title: 'Progression excellente' }
                    };
                    const indicator = statusIndicators[student.status] || { color: 'bg-gray-300', title: 'Statut inconnu' };
                    
                    return `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
<span class="w-3 h-3 rounded-full ${indicator.color} status-indicator cursor-pointer" 
      data-title="${indicator.title}"></span>
                                          <span class="ml-3 font-medium text-gray-900">${student.firstName} ${student.lastName}</span>
                                </div>
                           <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
    ${formatPreciseDateTime(student.lastActivity)}
</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${student.progress}%"></div>
                                    </div>
                                    <span class="ml-3 text-sm font-medium text-gray-700">${student.progress}%</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button data-student-id="${student.id}" class="view-journal-btn text-cyan-600 hover:text-cyan-900">Voir le journal</button>
                            </td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    </div>
`;
        contentDiv.innerHTML = tableHTML;
    };

    const getSchoolData = httpsCallable(functions, 'getSchoolDashboardData');
    getSchoolData().then(result => {
        allStudents = result.data.students;
        const inviteCode = result.data.inviteCode;
        
        if (allStudents.length === 0) {
            div.querySelector('#dashboard-content').innerHTML = '<p class="text-center text-slate-500">Aucun √©l√®ve n\'est encore rattach√© √† votre classe.</p>';
            div.querySelector('#stats-container').style.display = 'none';
        } else {
            const totalStudents = allStudents.length;
            const atRiskStudents = allStudents.filter(s => s.status === 'at_risk').length;
            const totalProgress = allStudents.reduce((sum, s) => sum + s.progress, 0);
            const avgProgress = totalStudents > 0 ? Math.round(totalProgress / totalStudents) : 0;

            div.querySelector('#stats-total-students').textContent = totalStudents;
            div.querySelector('#stats-avg-progress').textContent = `${avgProgress} %`;
            div.querySelector('#stats-at-risk').textContent = atRiskStudents;
            
            allStudents.sort((a, b) => a.lastName.localeCompare(b.lastName));
            renderTable(allStudents);
        }

        if (inviteCode) {
            div.querySelector('#invite-code-container').innerHTML = `
                <div class="p-4 bg-teal-50 border-l-4 border-teal-500 rounded-r-lg">
                    <h3 class="font-bold text-teal-800">Code d'invitation de la classe</h3>
                    <p class="text-sm text-slate-700 mt-1">Partagez ce code avec vos √©l√®ves pour qu'ils rejoignent cette classe :</p>
                    <div class="mt-2 p-2 rounded border border-dashed bg-white text-center">
                        <p class="text-2xl font-bold text-teal-700 tracking-widest">${inviteCode}</p>
                    </div>
                </div>`;
        }

    }).catch(error => {
        console.error("Erreur du tableau de bord:", error);
        div.querySelector('#dashboard-content').innerHTML = `<p class="text-center text-red-500">Une erreur est survenue lors du chargement des donn√©es.</p>`;
    });

    const applyFilters = () => {
        const searchTerm = div.querySelector('#teacher-search-input').value.toLowerCase();
        const sortOption = div.querySelector('#teacher-sort-filter').value;
        
        let filteredStudents = allStudents.filter(student => 
            `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm)
        );

        switch (sortOption) {
            case 'progress_desc':
                filteredStudents.sort((a, b) => b.progress - a.progress);
                break;
            case 'progress_asc':
                filteredStudents.sort((a, b) => a.progress - b.progress);
                break;
            case 'activity_desc':
                filteredStudents.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
                break;
            default:
                filteredStudents.sort((a, b) => a.lastName.localeCompare(b.lastName));
                break;
        }
        renderTable(filteredStudents);
    };

    div.addEventListener('input', (e) => {
        if (e.target.id === 'teacher-search-input') {
            applyFilters();
        }
    });

    div.addEventListener('change', (e) => {
        if (e.target.id === 'teacher-sort-filter') {
            applyFilters();
        }
    });
    
    const showAnalyticsBtn = div.querySelector('#show-analytics-btn');
    const analyticsContainer = div.querySelector('#analytics-container');
    let charts = {};

showAnalyticsBtn.addEventListener('click', async () => {
        // 1. On affiche ou on cache le conteneur, tout simplement.
        analyticsContainer.classList.toggle('hidden');

        // 2. On v√©rifie l'√©tat ACTUEL du conteneur APRES le clic.
        const isNowVisible = !analyticsContainer.classList.contains('hidden');
        const isEmpty = analyticsContainer.innerHTML.trim() === '';

        // 3. Si le conteneur est maintenant visible ET qu'il est vide, ALORS on charge les donn√©es.
        if (isNowVisible && isEmpty) {
            analyticsContainer.innerHTML = '<div class="loader"></div>';

            try {
                const getAnalytics = httpsCallable(functions, 'getSchoolAnalytics');
                // ... (le reste de votre logique de chargement reste EXACTEMENT le m√™me)
                const result = await getAnalytics();
                const analytics = result.data.analytics;

                if (Object.keys(analytics).length === 0) {
                    analyticsContainer.innerHTML = '<p class="text-center text-slate-500">Pas assez de donn√©es pour g√©n√©rer des statistiques.</p>';
                    return;
                }

                analyticsContainer.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">üìä R√©partition de la Progression</h3>
                            <div class="max-w-xs mx-auto"><canvas id="progress-chart"></canvas></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">üß≠ Secteurs les Plus Populaires</h3>
                            <canvas id="sector-chart"></canvas>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">üéØ M√©tiers les Plus Explor√©s</h3>
                            <ul id="top-metiers-list" class="space-y-2"></ul>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-center mb-4">üéì Niveaux de Formation Vis√©s</h3>
                            <div class="max-w-xs mx-auto"><canvas id="formation-level-chart"></canvas></div>
                        </div>
                    </div>
                `;

                if (analytics.progressDistribution) {
                    const progressCtx = document.getElementById('progress-chart').getContext('2d');
                    charts.progress = new Chart(progressCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(analytics.progressDistribution),
                            datasets: [{
                                data: Object.values(analytics.progressDistribution),
                                backgroundColor: ['#FBBF24', '#34D399', '#3B82F6'],
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: true }
                    });
                }

                if (analytics.sectorCounts && Object.keys(analytics.sectorCounts).length > 0) {
                    const sectorCtx = document.getElementById('sector-chart').getContext('2d');
                    charts.sector = new Chart(sectorCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(analytics.sectorCounts),
                            datasets: [{
                                label: 'Nombre d\'explorations',
                                data: Object.values(analytics.sectorCounts),
                                backgroundColor: 'rgba(8, 145, 178, 0.6)',
                                borderColor: 'rgba(8, 145, 178, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                    });
                }

                if (analytics.topMetiers && analytics.topMetiers.length > 0) {
                    const metiersList = document.getElementById('top-metiers-list');
                    metiersList.innerHTML = analytics.topMetiers.map(metier => 
                        `<li class="flex justify-between items-center bg-gray-100 p-2 rounded">
                            <span class="text-sm font-medium text-gray-800">${metier.nom}</span>
                            <span class="text-sm font-bold bg-cyan-200 text-cyan-800 px-2 py-0.5 rounded-full">${metier.count}</span>
                        </li>`
                    ).join('');
                } else {
                    document.getElementById('top-metiers-list').innerHTML = '<p class="text-center text-sm text-slate-500">Aucun m√©tier explor√© pour le moment.</p>';
                }

                if (analytics.formationLevelCounts) {
                    const formationCtx = document.getElementById('formation-level-chart').getContext('2d');
                    charts.formation = new Chart(formationCtx, {
                        type: 'pie',
                        data: {
                            labels: Object.keys(analytics.formationLevelCounts),
                            datasets: [{
                                data: Object.values(analytics.formationLevelCounts),
                                backgroundColor: ['#06b6d4', '#f97316', '#10b981', '#6366f1'],
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: true }
                    });
                }

            } catch (error) {
                console.error("Erreur lors de la r√©cup√©ration des statistiques:", error);
                analyticsContainer.innerHTML = `<p class="text-center text-red-500">Impossible de charger les statistiques.</p>`;
            }
        }
    });

    // ... dans createTeacherDashboardView
    div.addEventListener('click', async (e) => {
        const viewJournalButton = e.target.closest('.view-journal-btn');
        if (viewJournalButton) {
            const studentId = viewJournalButton.dataset.studentId;
            mainApp.innerHTML = '<div class="loader"></div>';
            
            try {
                const getStudentJournal = httpsCallable(functions, 'getStudentJournal');
                const studentResult = await getStudentJournal({ studentId: studentId });
                const studentData = studentResult.data;

                const userInfo = {
                    firstName: studentData.firstName,
                    lastName: '', // Le nom de famille n'est pas n√©cessaire pour la vue prof
                    schoolName: studentData.schoolName,
                    gradeLevel: studentData.gradeLevel
                };

                currentViewName = 'teacherStudentJournal'; // ‚úÖ AJOUTEZ CETTE LIGNE ICI

                // On appelle la nouvelle fonction unifi√©e avec le contexte "teacher"
                const pageElement = await createUnifiedJournalView(userInfo, studentData.journal, 'teacher');
                
                mainApp.innerHTML = '';
                mainApp.appendChild(pageElement);
                document.getElementById('floatingBackBtn').style.display = 'flex';

            } catch (error) {
                console.error("Erreur lors de la r√©cup√©ration du journal:", error);
                createSimpleModal("Erreur", "<p>Impossible de charger le journal de cet √©l√®ve.</p>");
                showView('teacherDashboard');
            }
        }
        
    });
    div.addEventListener('click', (e) => {
    const indicator = e.target.closest('.status-indicator');
    if (indicator) {
        const modalTitle = "L√©gende des statuts d'√©l√®ves";
        const modalContentHTML = `
            <div class="space-y-4 text-left">
                <div>
                    <h4 class="font-semibold text-OrIAntation-darkblue flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-orange-500 flex-shrink-0"></span>
                        √âl√®ve √† suivre (inactif ou bloqu√©)
                    </h4>
                    <p class="text-sm pl-5 text-slate-600">
                        Cet √©l√®ve est consid√©r√© comme "√† suivre" : son activit√© est tr√®s faible (plus de 3 semaines d'inactivit√©) ou sa progression est inf√©rieure √† 25%.
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold text-OrIAntation-darkblue flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-green-500 flex-shrink-0"></span>
                        √âl√®ve actif
                    </h4>
                    <p class="text-sm pl-5 text-slate-600">
                        Cet √©l√®ve est actif et progresse r√©guli√®rement.
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold text-OrIAntation-darkblue flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-blue-500 flex-shrink-0"></span>
                        Progression excellente
                    </h4>
                    <p class="text-sm pl-5 text-slate-600">
                        Cet √©l√®ve a une excellente progression, sup√©rieure √† 75%.
                    </p>
                </div>
            </div>
        `;
        createSimpleModal(modalTitle, modalContentHTML);
    }
});
    
    return div;
}

// Dans index.html, AJOUTEZ CETTE NOUVELLE FONCTION

function createTeacherStudentJournalView(studentData) {
    if (!studentData) {
        const div = document.createElement('div');
        div.innerHTML = `<p class="text-red-500">Erreur : Les donn√©es de l'√©l√®ve n'ont pas pu √™tre charg√©es.</p>`;
        return div;
    }

    const pageContainer = document.createElement('div');
    pageContainer.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // === ASTUCE IMPORTANTE ===
    // Pour r√©utiliser les fonctions comme createProgressBarHTML, on doit temporairement
    // remplacer les variables globales par celles de l'√©l√®ve.
    const originalJournalData = journalData;
    const originalGradeLevel = userGradeLevel;

    journalData = studentData.journal;
    userGradeLevel = studentData.journal.gradeLevel || 'N/A';
    // =========================

    let finalHTML = `
        <h1 class="text-2xl font-bold text-cyan-700 mb-2 text-center">Journal de Bord de ${studentData.firstName}</h1>
        <p class="text-slate-500 mb-8 text-center">√âl√®ve en ${userGradeLevel}.</p>
        ${createProgressBarHTML()}
    `;

    if (journalData.earned_badges && journalData.earned_badges.length > 0) {
        finalHTML += createBadgesDisplay('journal_public');
    }

    finalHTML += createOrientationMapView(journalData, 'public');

    if (journalData.fil_rouge) {
        finalHTML += `<div class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
                        <h2 class="text-xl font-bold text-cyan-800 mb-4">‚ú® Son Fil Rouge</h2>
                        <div class="prose prose-sm max-w-none">${marked.parse(journalData.fil_rouge)}</div>
                      </div>`;
    }

    pageContainer.innerHTML = finalHTML;

    // === On restaure les variables globales originales ===
    journalData = originalJournalData;
    userGradeLevel = originalGradeLevel;


    
    return pageContainer;
}

// REMPLACEZ VOTRE FONCTION 'renderJournalPageView' PAR CETTE VERSION COMPL√àTE

function renderJournalPageView(userInfo, journalDataToDisplay) {
    const pageContainer = document.createElement('div');
    pageContainer.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // === On utilise temporairement les donn√©es de l'√©l√®ve pour les fonctions globales ===
    const originalJournalData = journalData;
    const originalGradeLevel = userGradeLevel;
    journalData = journalDataToDisplay;
    userGradeLevel = userInfo.gradeLevel;
    // =================================================================================

    let finalHTML = `
        <h1 class="text-2xl font-bold text-cyan-700 mb-2 text-center">Journal de Bord de ${userInfo.firstName}</h1>
        <p class="text-slate-500 mb-8 text-center">√âl√®ve en ${userGradeLevel} √† ${userInfo.schoolName}.</p>
        ${createProgressBarHTML()}
    `;

    if (journalData.earned_badges && journalData.earned_badges.length > 0) {
        finalHTML += createBadgesDisplay('journal_public');
    }
    finalHTML += createOrientationMapView(journalData, 'public');
    if (journalData.fil_rouge) {
        finalHTML += `<div class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg"><h2 class="text-xl font-bold text-cyan-800 mb-4">‚ú® Son Fil Rouge</h2><div class="prose prose-sm max-w-none">${marked.parse(journalData.fil_rouge)}</div></div>`;
    }
    pageContainer.innerHTML = finalHTML;

    // --- Conteneur pour les sections d√©taill√©es ---
    const journalContentDiv = document.createElement('div');
    journalContentDiv.className = 'mt-8 space-y-4';

    if (journalData.step0 && journalData.step0.analysis) {
        journalContentDiv.appendChild(createProfileInfographic(journalData.step0, 'public'));
    }

    const stepTitles = {
        retroplanning_saves: 'Ses Conseils de R√©troplanning Sauvegard√©s',
        step10: 'Son Portfolio de Comp√©tences',
        step1: 'Ses Fondations (M√©tiers)',
        step2: 'Ses simulations de sp√©cialit√©s',
        step3: 'Son Catalogue (Formations)',
        step4: 'Sa pr√©paration d\'entretiens',
        step5: 'Son Actu',
        step6: 'Ses pr√©parations de candidatures',
        step7: 'Ses Scores (Fact Checking)',
        step8: 'Mes Entretiens Professionnels',
        step9: 'Son anticipation de la suite',
        step11: 'Ses rencontres sur le territoire',
        step12: 'Ses simulations de vie √©tudiante',
        step13: 'Mon Stage de Seconde', // <-- AJOUTEZ CETTE LIGNE
        radar_history: 'Son Radar √† Opportunit√©s',
        chatbot_saves: 'Ses Discussions avec le Coach',
    };
    
    // Helper pour convertir un tableau Markdown en HTML
    const markdownTableToHtml = (markdown) => {
        if (!markdown) return '';
        const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
        if (lines.length < 2) return '';
        let html = '<div class="comparison-table-wrapper"><table>';
        const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th>${cell.trim()}</th>`).join('');
        html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
        lines.slice(2).forEach(line => {
            const rowCells = line.split('|').slice(1, -1).map(cell => `<td>${linkify(cell.trim())}</td>`).join('');
            html += `<tr>${rowCells}</tr>`;
        });
        html += `</tbody></table></div>`;
        return html;
    };

    for (const stepKey in stepTitles) {
        const stepData = journalDataToDisplay[stepKey];
        let sectionContentHTML = '';
        let hasContentInSection = false;

        // On v√©rifie si la section contient des donn√©es √† afficher
        if (stepData && ( (Array.isArray(stepData) && stepData.length > 0) || (typeof stepData === 'object' && Object.keys(stepData).length > 0 && (!Array.isArray(stepData) || stepData.length > 0) ) )) {
            hasContentInSection = true;
            
            // Logique de rendu sp√©cifique √† chaque section
            if (stepKey === 'step1' && Array.isArray(stepData.metiers) && stepData.metiers.length > 0) {
                 sectionContentHTML = '<div class="space-y-3">' + stepData.metiers.map(metier => {
                    let analysesHTML = '';
                    if (metier.analyses) {
                        analysesHTML = Object.entries(metier.analyses).map(([key, value]) => {
                           if (!value) return '';
                           return `<div class="mt-2"><h5 class="font-medium text-sm text-OrIAntation-darkblue">${capitalizeWords(key)}</h5><div class="prose prose-sm max-w-none">${marked.parse(linkify(value))}</div></div>`;
                        }).join('');
                    }
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold">${metier.nom}</summary><div class="p-3 border-t"><p><b>Notes:</b> ${metier.notes || 'Aucune'}</p>${analysesHTML}</div></details>`;
                }).join('') + '</div>';
            } else if (stepKey === 'step3' && stepData.formations?.length > 0) {
                 sectionContentHTML = '<div class="space-y-3">' + stepData.formations.map(f => {
                    let content = `<p><b>Attendus:</b> ${f.attendus || 'N/A'}</p><p><b>Mots-cl√©s:</b> ${f.mots_cles || 'N/A'}</p>`;
                    if (f.analyses?.compatibilite) content += `<div class="mt-2"><h5 class="font-medium text-sm">Rapport de compatibilit√©</h5><div class="prose prose-sm max-w-none">${marked.parse(f.analyses.compatibilite)}</div></div>`;
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold">${f.nom}</summary><div class="p-3 border-t">${content}</div></details>`;
                }).join('') + '</div>';
            } else if (stepKey === 'step10') {
                 let content = '';
                 if (stepData.experiences?.length > 0) content += `<h4>Exp√©riences</h4>` + stepData.experiences.map(e => `<div class="p-2 my-1 bg-white border rounded">${e.analysis}</div>`).join('');
                 if (stepData.soft_skills_profile) content += `<h4 class="mt-4">Profil de comp√©tences</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.soft_skills_profile)}</div>`;
                 if (stepData.skills_synthesis) content += `<h4 class="mt-4">Synth√®se</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.skills_synthesis)}</div>`;
                 sectionContentHTML = content;
            } else if (Array.isArray(stepData)) {
                // Rendu g√©n√©rique pour les autres sections qui sont des listes
                sectionContentHTML = '<div class="space-y-3">' + stepData.map(item => {
                    const title = item.sujet || item.question || item.theme || `Entr√©e du ${new Date(item.date).toLocaleDateString('fr-FR')}`;
                    const content = item.reponse || item.conseils || item.suggestions || '';
                    let formattedContent = '';
                    if (typeof content === 'object') { // Pour les conseils du r√©troplanning
                        formattedContent = Object.entries(content).map(([key, value]) => `<p><b>${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}:</b> ${value}</p>`).join('');
                    } else {
                        formattedContent = `<div class="prose prose-sm max-w-none">${marked.parse(linkify(content))}</div>`;
                    }
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold">${title}</summary><div class="p-3 border-t">${formattedContent}</div></details>`;
                }).join('') + '</div>';
            }
        }
        
        if (hasContentInSection) {
            const sectionContainer = document.createElement('div');
            sectionContainer.className = 'border border-border-subtle rounded-lg overflow-hidden';
            sectionContainer.innerHTML = `
                <div class="journal-section-header flex justify-between items-center bg-background-light p-4 cursor-pointer hover:bg-slate-100 transition">
                    <h3 class="text-lg font-bold text-cyan-700">${stepTitles[stepKey]}</h3>
                    <span class="transform transition-transform duration-200 text-cyan-700">‚ñº</span>
                </div>
                <div class="journal-section-content p-4 border-t border-border-subtle hidden">${sectionContentHTML}</div>`;
            journalContentDiv.appendChild(sectionContainer);
        }
    }
    
    pageContainer.appendChild(journalContentDiv);
    
    // On ajoute le bouton "Pr√©parer une discussion"
    const discussionSection = document.createElement('div');
    discussionSection.innerHTML = `
        <div class="mt-8 border-t pt-6 text-center">
            <button id="publicShareBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">ü§ù Pr√©parer une discussion</button>
        </div>
        <div id="publicOpenAIShareLoader" class="hidden"></div>
        <div id="publicOpenAIShareResult" class="mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg text-slate-700"></div>`;
    pageContainer.appendChild(discussionSection);

    // Ajout de toute la logique des clics
    pageContainer.addEventListener('click', async (e) => {
        const header = e.target.closest('.journal-section-header');
        const shareBtn = e.target.closest('#publicShareBtn');

        if (header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('span');
            content.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        } else if (shareBtn) {
            shareBtn.disabled = true;
            const loader = pageContainer.querySelector('#publicOpenAIShareLoader');
            const resultDiv = pageContainer.querySelector('#publicOpenAIShareResult');
            const profileSummary = getProfileSummary();
    const completionSummary = getCompletionSummary();
    
    // On restaure les donn√©es originales apr√®s usage
    journalData = originalJournalData;

    try {
        // NOUVEAU PROMPT AM√âLIOR√â
        const prompt = `
            Agis comme un conseiller p√©dagogique et un coach d'orientation qui pr√©pare un entretien.
            Tu analyses le parcours d'un √©l√®ve pour fournir des points de discussion constructifs √† un parent ou un enseignant.

            # Donn√©es sur l'√©l√®ve
            - R√©sum√© de son profil de personnalit√© : ${profileSummary}
            - R√©sum√© de sa progression dans l'application : ${completionSummary}

            # Ta Mission
            En te basant STRICTEMENT sur les donn√©es fournies, g√©n√®re 4 points de discussion cl√©s. Chaque point doit aider √† lancer une conversation bienveillante et constructive.

            # Format de Sortie OBLIGATOIRE
            Ta r√©ponse doit utiliser des titres en gras (**Titre**), mais ne doit contenir AUCUNE liste √† puces (* ou -). Chaque point doit √™tre un paragraphe fluide.

            **Point de discussion 1 : Mettre en lumi√®re une force cl√©**
            (Identifie une force √©vidente dans son profil et formule une question ouverte pour l'inviter √† en parler. Ex: "J'ai remarqu√© que...")

            **Point de discussion 2 : Explorer une zone de blocage ou d'h√©sitation**
            (Rep√®re une √©tape peu remplie ou une contradiction dans son parcours et formule une question pour l'aider √† verbaliser ses difficult√©s. Ex: "J'ai vu que tu avais beaucoup explor√© les m√©tiers, mais moins les formations. Qu'est-ce qui te semble le plus difficile dans cette √©tape ?")

            **Point de discussion 3 : Sugg√©rer une prochaine √©tape concr√®te**
            (Propose une action simple et logique √† entreprendre dans l'application pour faire avancer son projet. Ex: "Pour aller plus loin, que dirais-tu d'utiliser le comparateur de m√©tiers pour y voir plus clair ?")
        `;

        // NOUVEL APPEL API UTILISANT LA VOIE EXPERT
        const result = await callOpenAI_API({
            promptText: prompt,
            promptId: "pmpt_68dc33a589bc8197a0229d72a4e3df100510635f4c084c2c", // ID du prompt Expert
            isExpertCall: true,
            loaderElement: loader,
            customLoaderHTML: `<div class="loader"></div><p class="text-slate-500 font-semibold mt-2">Analyse du parcours en cours...</p>`
        });
        
        resultDiv.innerHTML = marked.parse(result);

    } catch (error) {
        resultDiv.innerHTML = '<p class="text-red-500">Une erreur est survenue.</p>';
        console.error("Erreur lors de la g√©n√©ration des points de discussion :", error);
    } finally {
        shareBtn.disabled = false;
    }
}
    });

    return pageContainer;
}


async function generateProfessionalPDF() {
    // 1. Initialisation du document PDF avec jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'p',
        unit: 'mm',
        format: 'a4'
    });

    // 2. D√©finition des constantes pour la mise en page
    const MARGIN = 15;
    const PAGE_WIDTH = doc.internal.pageSize.getWidth();
    const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
    const CONTENT_WIDTH = PAGE_WIDTH - MARGIN * 2;
    let yPos = MARGIN;

    // 3. Polices et couleurs
    const FONT_TITLE = 'Helvetica';
    const FONT_BODY = 'Times';
    const COLOR_TITLE = '#1A3263';
    const COLOR_SUBTITLE = '#0891b2';
    const COLOR_BODY = '#333333';

    // 4. Fonctions utilitaires
    const checkPageBreak = (heightNeeded) => {
        if (yPos + heightNeeded > PAGE_HEIGHT - MARGIN) {
            doc.addPage();
            yPos = MARGIN;
            addHeaderAndFooter();
        }
    };

    const addHeaderAndFooter = () => {
        const logoImg = new Image();
        logoImg.src = 'logo.png';
        doc.addImage(logoImg, 'PNG', MARGIN, 5, 15, 15);
        
        doc.setFont(FONT_TITLE, 'bold');
        doc.setFontSize(18);
        doc.setTextColor(COLOR_TITLE);
        doc.text("OrIAntation - Journal de Bord", PAGE_WIDTH / 2, 15, { align: 'center' });

        const pageCount = doc.internal.getNumberOfPages();
        const dateStr = `G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`;
        
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFont(FONT_BODY, 'italic');
            doc.setFontSize(8);
            doc.setTextColor(COLOR_BODY);
            doc.text(dateStr, MARGIN, PAGE_HEIGHT - 8);
            doc.text(`Page ${i} / ${pageCount}`, PAGE_WIDTH - MARGIN, PAGE_HEIGHT - 8, { align: 'right' });
        }
    };

    const addSectionTitle = (title) => {
        checkPageBreak(15);
        doc.setFont(FONT_TITLE, 'bold');
        doc.setFontSize(14);
        doc.setTextColor(COLOR_SUBTITLE);
        doc.text(title, MARGIN, yPos);
        yPos += 8;
        doc.setDrawColor(COLOR_SUBTITLE);
        doc.line(MARGIN, yPos, MARGIN + CONTENT_WIDTH, yPos);
        yPos += 8;
    };
    
    const addBodyText = (text, options = {}) => {
        // --- LA CORRECTION EST ICI ---
        // On v√©rifie que le texte n'est pas vide, null ou undefined avant de l'√©crire.
        if (!text || text.trim() === '') {
            return; // On ne fait rien et on passe √† la suite.
        }
        // --- FIN DE LA CORRECTION ---

        doc.setFont(FONT_BODY, options.style || 'normal');
        doc.setFontSize(options.size || 11);
        doc.setTextColor(options.color || COLOR_BODY);

        const lines = doc.splitTextToSize(text, CONTENT_WIDTH);
        checkPageBreak(lines.length * 5);
        doc.text(lines, MARGIN, yPos);
        yPos += lines.length * 5 + 4;
    };
    
    // --- D√âBUT DE LA CONSTRUCTION DU CONTENU DU PDF ---

    // -- Section 1 : Synth√®se du Profil --
    addSectionTitle("Synth√®se du Profil");

    if (journalData.step0 && journalData.step0.archetype) {
        const archetype = journalData.step0.archetype;
        addBodyText(`Arch√©type : ${archetype.titre}`, { style: 'bold', size: 12 });
        addBodyText(archetype.description);

        const chartCanvas = document.getElementById('profileBarChart');
        if (chartCanvas) {
            const chartImgData = await html2canvas(chartCanvas, { scale: 3, backgroundColor: null }).then(canvas => canvas.toDataURL('image/png'));
            checkPageBreak(60);
            doc.addImage(chartImgData, 'PNG', MARGIN, yPos, CONTENT_WIDTH, 60);
            yPos += 65;
        }
    } else {
        addBodyText("Le profil n'a pas encore √©t√© g√©n√©r√©.");
    }
    yPos += 5;

    // -- Section 2 : Fil Rouge --
    if (journalData.fil_rouge) {
        addSectionTitle("Mon Fil Rouge");
        addBodyText(journalData.fil_rouge.replace(/\*\*/g, ''));
    }

    // -- Section 3 : Portfolio de Comp√©tences --
    if (journalData.step10 && (journalData.step10.experiences?.length > 0 || journalData.step10.skills_synthesis)) {
        addSectionTitle("Portfolio de Comp√©tences");
        if(journalData.step10.experiences?.length > 0) {
            addBodyText("Exp√©riences valoris√©es :", { style: 'bold' });
            journalData.step10.experiences.forEach(exp => {
                addBodyText(`- ${exp.analysis}`);
            });
        }
        if (journalData.step10.skills_synthesis) {
            addBodyText("Synth√®se des comp√©tences :", { style: 'bold', size: 12 });
            addBodyText(journalData.step10.skills_synthesis);
        }
    }
    
    // -- Section 4 : Sections du Journal --
    const sectionsToExport = {
        step1: 'Mes Fondations (M√©tiers)',
        step3: 'Mon Catalogue (Formations)',
        step2: 'Mes simulations de sp√©cialit√©s',
    };

    for(const [stepKey, title] of Object.entries(sectionsToExport)) {
        if (isStepStarted(stepKey)) {
            addSectionTitle(title);
            if(stepKey === 'step1' && journalData.step1.metiers) {
                 journalData.step1.metiers.forEach(metier => addBodyText(`- ${metier.nom}`));
            }
            if(stepKey === 'step3' && journalData.step3.formations) {
                 journalData.step3.formations.forEach(f => addBodyText(`- ${f.nom}`));
            }
            if(stepKey === 'step2' && journalData.step2.combinations) {
                 journalData.step2.combinations.forEach(c => addBodyText(`- ${c.name}`));
            }
        }
    }

    // --- FINALISATION ---
    addHeaderAndFooter();
    doc.save(`Journal_OrIAntation_${currentUserInfo.firstName}.pdf`);
}
        
function createHomeView() {
    return createMenuView();
}
        function createStepView(config) {
            const div = document.createElement('div');
            div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';
            
            let formFields = '';
            if (config.fields) {
                formFields = config.fields.map(field => {
                    const value = (journalData[config.stepKey] && journalData[config.stepKey][field.id]) || '';
                    const isReadonly = field.isReadonly ? 'readonly' : '';
                    const bgColor = isReadonly ? 'bg-background-light' : 'bg-white';
                    return `
                    <div class="mb-6">
                        <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                        ${field.type === 'textarea' ? `<textarea id="${field.id}" name="${field.id}" rows="4" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" ${isReadonly}>${value}</textarea>` : `<input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg ${bgColor}" placeholder="${field.placeholder}" value="${value}" ${isReadonly}>`}
                    </div>
                `}).join('');
            }

            let description = config.description;
            if(typeof description === 'object') {
                description = description[userGradeLevel] || description['default'] || '';
            }

            let action = config.action;
            if(typeof action === 'object') {
                action = action[userGradeLevel] || action['default'] || '';
            }

            let linksHTML = '';
    if (config.urls) {
        linksHTML = config.urls.map(link => 
            `<a href="${link.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition mr-2 mb-2">Visiter ${link.site} ‚Üó</a>`
        ).join('');
    } else if (config.url) {
        linksHTML = `<a href="${config.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter ${config.site} ‚Üó</a>`;
    }

    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>      
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${action}</div></div>
        <div class="mb-8">${linksHTML}</div>
        <form id="stepForm">
            ${formFields}
            <button type="submit" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
        </form>
    `;
            
            div.querySelector('#stepForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const stepKey = config.stepKey;
                if (!journalData[stepKey]) journalData[stepKey] = {};

                for (const [key, newValue] of formData.entries()) {
                     journalData[stepKey][key] = newValue; 
                }
                
                checkBadges();
                await saveData();
                showView('menu');
            });

            return div;
        }
        

function createProfileInfographic(step0Data, context = 'user') {
    if (!step0Data || !step0Data.analysis) {
        return document.createElement('div');
    }

    const container = document.createElement('div');
    container.className = 'mb-8';
    const titleText = (context === 'user' || context === 'student') ? 'Synth√®se visuelle de mon profil' : 'Synth√®se visuelle de son profil';
    container.innerHTML = `
        <h2 class="text-xl font-bold border-b pb-2 mb-4 text-cyan-700">${titleText}</h2>
        <div class="bg-background-light p-4 md:p-6 rounded-xl border border-border-subtle mt-4">
            
            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="profileBarChart"></canvas>
            </div>
        </div>

        <div id="riasec-legend" class="mt-6 text-sm text-slate-600 space-y-4 text-left">
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'üõ†Ô∏è'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le Profil B√¢tisseur (R√©aliste) :</strong> Aime le travail concret, physique, avec des outils ou en plein air.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'üî¨'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le Profil Analyste (Investigateur) :</strong> Aime analyser, comprendre, r√©soudre des probl√®mes complexes.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'üé®'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le Profil Cr√©atif (Artistique) :</strong> Aime cr√©er, imaginer, s'exprimer de mani√®re non conventionnelle.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'ü§ù'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le Profil Relationnel (Social) :</strong> Aime aider, former, soigner, √™tre en contact avec les autres.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'üöÄ'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le Profil Initiateur (Entreprenant) :</strong> Aime diriger, convaincre, mener des projets, prendre des d√©cisions.</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-2xl w-8">${'üèõÔ∏è'}</span>
                <div><strong class="font-semibold text-OrIAntation-darkblue">Le Profil Organisateur (Conventionnel) :</strong> Aime organiser, g√©rer, respecter les r√®gles, travailler avec des donn√©es.</div>
            </div>
        </div>
    `;

    setTimeout(() => {
        const ctx = document.getElementById('profileBarChart')?.getContext('2d');
        if (!ctx) return;
        
        const riasecScores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
        const riasecMapping = { q1:{sens:'S',securite:'C',creativite:'A',autonomie:'E'}, q2:{defi:'I',maitrise:'I',collaboration:'S'}, q3:{diriger:'E',creer:'A',comprendre:'I'}, q4:{variete:'E',stabilite:'C'}, q5:{influence:'E',expertise:'I'}, q6:{passion:'A',ambition:'E'}, q7:{transmettre:'S',organiser:'C',inventer:'A'}, q8:{ouverture:'A',tradition:'C'}, q9:{consciencieux:'C',flexible:'E'}, q11:{agreable:'S',assertif:'E'}, q13:{detail:'C',synthese:'I'}, q14:{curieux:'I',pratique:'R'}, q15:{realiste:'R',investigatif:'I'}, q16:{artistique:'A',social:'S'}, q17:{entreprenant:'E',conventionnel:'C'}, q18:{social:'S',entreprenant:'E'}, q19:{artistique:'A',conventionnel:'C'}, q20:{realiste:'R',artistique:'A'}, q21:{social:'S',investigatif:'I',realiste:'R'}, q22:{realiste:'R',social:'S'}, q23:{investigatif:'I',entreprenant:'E'}, q24:{artistique:'A',conventionnel:'C'}, q25:{social:'S',investigatif:'I'}, q26:{entreprenant:'E',realiste:'R'}, q27:{conventionnel:'C',artistique:'A'}, q28:{investigatif:'I',realiste:'R'}, q29:{social:'S',entreprenant:'E'}, q30:{artistique:'A',conventionnel:'C',realiste:'R'} };

        for (const [questionId, mapping] of Object.entries(riasecMapping)) {
             const answer = step0Data[questionId];
            if (answer && mapping[answer]) {
                const type = mapping[answer];
                riasecScores[type]++;
            }
        }
        
        const archetypeLabels = { 
            R: "Le Profil B√¢tisseur (R√©aliste)",
            I: "Le Profil Analyste (Investigateur)",
            A: "Le Profil Cr√©atif (Artistique)",
            S: "Le Profil Relationnel (Social)",
            E: "Le Profil Initiateur (Entreprenant)",
            C: "Le Profil Organisateur (Conventionnel)"
        };
        const labels = ['üõ†Ô∏è', 'üî¨', 'üé®', 'ü§ù', 'üöÄ', 'üèõÔ∏è'];
        const dataKeys = ['R', 'I', 'A', 'S', 'E', 'C'];
        const dataPoints = dataKeys.map(key => riasecScores[key]);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Score d\'int√©r√™t',
                    data: dataPoints,
                    backgroundColor: [ 'rgba(239, 68, 68, 0.6)','rgba(59, 130, 246, 0.6)','rgba(251, 191, 36, 0.6)','rgba(34, 197, 94, 0.6)','rgba(249, 115, 22, 0.6)','rgba(148, 163, 184, 0.6)' ],
                    borderColor: [ 'rgb(239, 68, 68)','rgb(59, 130, 246)','rgb(251, 191, 36)','rgb(34, 197, 94)','rgb(249, 115, 22)','rgb(148, 163, 184)' ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { ticks: { font: { size: 20 } } },
                    x: { beginAtZero: true, ticks: { stepSize: 1 } } 
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const dataKey = dataKeys[context.dataIndex];
                                const label = archetypeLabels[dataKey] || '';
                                const value = context.raw || 0;
                                return `${label}: ${value}`;
                            }
                        }
                    }
                }
            }
        });
    }, 0);

    return container;
}

function createQuestionHTML(id, label, options, selectedValue) {
    let optionsHTML = '<option value="">Choisir...</option>';
    for (const [value, data] of Object.entries(options)) {
        optionsHTML += `<option value="${value}" ${selectedValue === value ? 'selected' : ''} title="${data.description}">${data.text}</option>`;
    }
            return `
                <div class="mb-4">
                    <label class="block text-md font-medium text-slate-700 mb-2">${id}. ${label}</label>
                    <select name="q${id}" class="w-full p-3 border border-slate-300 rounded-lg">
                        ${optionsHTML}
                    </select>
                </div>
            `;
        }

function createStep0View() {
    const config = stepsConfig.step0;
    const div = createStepView({ ...config, fields: [] });
    const form = div.querySelector('#stepForm');

    const questions = [
        { id: 1, part: "Mes Moteurs", label: "Pour un expos√© en groupe, le plus important pour toi, c'est...", options: { sens: { text: "Que le sujet soit utile et aide les autres √† comprendre." }, securite: { text: "D'avoir une super note garantie." }, creativite: { text: "De pouvoir pr√©senter le sujet d'une mani√®re originale." }, autonomie: { text: "D'avoir la libert√© de faire ma partie comme je l'entends." } } },
        { id: 2, part: "Mes Moteurs", label: "Ce qui te stimule le plus dans un projet, c'est...", options: { defi: { text: "Te creuser la t√™te sur un probl√®me complexe." }, maitrise: { text: "Ma√Ætriser une technique √† la perfection." }, collaboration: { text: "Partager des id√©es et construire ensemble." } } },
        { id: 3, part: "Mes Moteurs", label: "√Ä la fin d'un projet, tu serais le/la plus fier(e) de...", options: { diriger: { text: "Bien avoir organis√© le groupe." }, creer: { text: "Avoir imagin√© quelque chose de nouveau." }, comprendre: { text: "Avoir compris une th√©orie complexe." } } },
        { id: 4, part: "Mes Moteurs", label: "Tu pr√©f√®res quand tes semaines de cours...", options: { variete: { text: "Sont pleines d'impr√©vus et de nouveaux sujets." }, stabilite: { text: "Suivent un planning clair et pr√©visible." } } },
        { id: 5, part: "Mes Moteurs", label: "Dans un projet de groupe, tu aimes √™tre celui/celle qui...", options: { influence: { text: "Participe aux grandes d√©cisions." }, expertise: { text: "S'occupe de la partie technique." } } },
        { id: 6, part: "Mes Moteurs", label: "Tu pr√©f√©rerais un petit job...", options: { passion: { text: "Qui te passionne, m√™me moins bien pay√©." }, ambition: { text: "Avec un bon salaire, m√™me un peu r√©p√©titif." } } },
        { id: 7, part: "Mes Moteurs", label: "Dans un club au lyc√©e, tu aimerais le plus...", options: { transmettre: { text: "Expliquer et former les nouveaux." }, organiser: { text: "Planifier les √©v√©nements et g√©rer le budget." }, inventer: { text: "Proposer des id√©es de nouveaux projets." } } },
        { id: 8, part: "Ma Fa√ßon d'Agir", label: "Face √† une m√©thode de travail nouvelle, ta r√©action est...", options: { ouverture: { text: "Cool, j'ai envie d'essayer !" }, tradition: { text: "Je pr√©f√®re garder mes habitudes qui marchent." } } },
        { id: 9, part: "Ma Fa√ßon d'Agir", label: "Pour un gros devoir √† rendre dans un mois, tu as tendance √†...", options: { consciencieux: { text: "Faire un planning pr√©cis d√®s le d√©but." }, flexible: { text: "Commencer √† la fin, je g√®re mieux sous pression." } } },
        { id: 10, part: "Ma Fa√ßon d'Agir", label: "Apr√®s une semaine intense, tu recharges tes batteries en...", options: { extraversion: { text: "Passant du temps avec des amis." }, introversion: { text: "Passant du temps seul(e) (livre, film, jeu...)." } } },
        { id: 11, part: "Ma Fa√ßon d'Agir", label: "Quand tes amis n'arrivent pas √† d√©cider du film √† aller voir...", options: { agreable: { text: "Tu cherches un compromis pour √©viter les disputes." }, assertif: { text: "Tu d√©fends le film que tu penses √™tre le meilleur choix." } } },
        { id: 12, part: "Ma Fa√ßon d'Agir", label: "Juste avant un oral important, tu te sens g√©n√©ralement...", options: { stable: { text: "Assez calme et concentr√©(e)." }, reactif: { text: "Stress√©(e), tu imagines le pire." } } },
        { id: 13, part: "Ma Fa√ßon d'Agir", label: "Quand tu pr√©pares ton sac pour le lendemain...", options: { detail: { text: "Tu v√©rifies 3 fois que tu n'as rien oubli√©." }, synthese: { text: "Tu prends l'essentiel, au pire tu t'arrangeras." } } },
        { id: 14, part: "Ma Fa√ßon d'Agir", label: "Quand tu entends parler d'un sujet que tu ne connais pas...", options: { curieux: { text: "Ton r√©flexe est de chercher sur internet pour en savoir plus." }, pratique: { text: "√áa t'int√©resse seulement si √ßa peut te servir." } } },
        { id: 15, part: "Mes Terrains de Jeu", label: "Spontan√©ment, tu es plus attir√©(e) par...", options: { realiste: { text: "Une activit√© manuelle (bricoler, cuisiner...)." }, investigatif: { text: "Un jeu de logique (√©checs, √©nigme...)." } } },
        { id: 16, part: "Mes Terrains de Jeu", label: "Si tu devais cr√©er un club au lyc√©e, ce serait...", options: { artistique: { text: "Un club de th√©√¢tre, de musique ou d'arts." }, social: { text: "Une association d'aide aux devoirs." } } },
        { id: 17, part: "Mes Terrains de Jeu", label: "Pour organiser la f√™te de fin d'ann√©e, ton r√¥le id√©al serait...", options: { entreprenant: { text: "De convaincre et de trouver des sponsors." }, conventionnel: { text: "De g√©rer la liste des invit√©s et le planning." } } },
        { id: 18, part: "Mes Terrains de Jeu", label: "En groupe, tu es plus √† l'aise pour...", options: { social: { text: "Animer la discussion et faire participer." }, entreprenant: { text: "Pr√©senter le projet final pour convaincre." } } },
        { id: 19, part: "Mes Terrains de Jeu", label: "Tu passes plus de temps √†...", options: { artistique: { text: "Personnaliser ton fond d'√©cran." }, conventionnel: { text: "Organiser parfaitement tes fichiers." } } },
        { id: 20, part: "Mes Terrains de Jeu", label: "Si tu avais un apr√®s-midi de libre, tu pr√©f√©rerais...", options: { realiste: { text: "Faire du sport ou r√©parer ton v√©lo." }, artistique: { text: "Dessiner, composer ou √©crire une histoire." } } },
        { id: 21, part: "Mes Terrains de Jeu", label: "Si tu devais choisir une seule option pour le Grand Oral :", options: { social: { text: "Un sujet sur l'engagement citoyen." }, investigatif: { text: "Un sujet scientifique complexe." }, realiste: { text: "Un sujet sur la m√©canique des voitures √©lectriques." } } },
        { id: 22, part: "Mes Terrains de Jeu", label: "Pour un projet concret, tu pr√©f√®res...", options: { realiste: { text: "Construire physiquement une maquette." }, social: { text: "Interviewer des personnes pour comprendre leurs besoins." } } },
    { id: 23, part: "Mes Terrains de Jeu", label: "Face √† un probl√®me dans un projet de groupe, tu es celui/celle qui...", options: { investigatif: { text: "Analyse toutes les donn√©es pour trouver la source exacte du probl√®me." }, entreprenant: { text: "Propose une solution rapide et motive le groupe pour la tester." } } },
    { id: 24, part: "Mes Terrains de Jeu", label: "Pour rendre un devoir √©crit, tu portes le plus d'attention √†...", options: { artistique: { text: "L'originalit√© de la pr√©sentation (couleurs, mise en page cr√©ative)." }, conventionnel: { text: "La parfaite conformit√© aux consignes (police, marges, bibliographie)." } } },
    { id: 25, part: "Mes Terrains de Jeu", label: "Le type de documentaire que tu regardes le plus volontiers est...", options: { social: { text: "Un reportage sur une cause sociale ou humanitaire." }, investigatif: { text: "Une √©mission scientifique qui d√©cortique un ph√©nom√®ne complexe." } } },
    { id: 26, part: "Mes Terrains de Jeu", label: "Si tu devais monter un petit business au lyc√©e, ce serait pour...", options: { entreprenant: { text: "Vendre des produits que tu as n√©goci√©s et achet√©s en gros." }, realiste: { text: "Proposer un service de r√©paration (v√©los, ordinateurs...)." } } },
    { id: 27, part: "Mes Terrains de Jeu", label: "Dans un jeu vid√©o, ce que tu aimes le plus, c'est...", options: { conventionnel: { text: "Optimiser ton inventaire et g√©rer tes ressources √† la perfection." }, artistique: { text: "Passer des heures √† personnaliser l'apparence de ton personnage." } } },
    { id: 28, part: "Ma Fa√ßon d'Agir", label: "Tu es g√©n√©ralement plus √† l'aise avec...", options: { investigatif: { text: "Des concepts abstraits et des th√©ories." }, realiste: { text: "Des objets concrets que tu peux voir et manipuler." } } },
    { id: 29, part: "Ma Fa√ßon d'Agir", label: "Pour un projet oral, tu pr√©f√®res √™tre...", options: { social: { text: "Le/la porte-parole qui pr√©sente le travail √† la classe." }, entreprenant: { text: "Le/la chef(fe) de projet qui a distribu√© les t√¢ches en amont." } } },
    { id: 30, part: "Mes Terrains de Jeu", label: "Pour un projet libre en arts, tu choisirais de...", options: { artistique: { text: "Cr√©er une ≈ìuvre 100% originale sortie de ton imagination." }, conventionnel: { text: "Reproduire une ≈ìuvre existante avec une technique parfaite." }, realiste: { text: "Construire un objet d'art qui a aussi une utilit√© (lampe, meuble...)." } } }

    ];

    form.innerHTML = `
        <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-4">Ton Point de D√©part</h2>
    <p class="text-slate-600 mb-6">Pour commencer, d√©cris en quelques phrases o√π tu en es dans ta r√©flexion. As-tu d√©j√† des id√©es, des pistes ? Ou es-tu dans le flou total ? Sois honn√™te, cela aidera OrIA √† mieux te guider.</p>
    <div class="mb-8">
        <label for="situation" class="block text-md font-medium text-slate-700 mb-2">Ma situation actuelle :</label>
        <textarea id="situation" name="situation" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Je suis en Seconde et je commence √† peine √† y penser, les m√©tiers de la sant√© m'attirent mais je ne sais pas si j'ai le bon profil...">${journalData.step0.situation || ''}</textarea>
    </div>
    <hr class="my-8 border-slate-300">
    <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-4">Questionnaire de Personnalit√©</h2>
    <div id="quiz-wrapper" class="w-full max-w-lg mx-auto">
        <div class="mb-2 flex justify-between items-center"><span id="quiz-progress-text" class="text-sm font-semibold text-cyan-700"></span><span id="quiz-part-text" class="text-sm text-slate-500"></span></div>
        <div class="w-full bg-slate-200 rounded-full h-2.5"><div id="quiz-progress-bar" class="bg-cyan-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div></div>
        <div id="quiz-question-container" class="mt-6 text-center"></div>
    </div>
    <div id="analysis-section" class="hidden text-center mt-6">
        <h2 class="text-xl font-bold text-OrIAntation-darkblue">Questionnaire termin√© !</h2>
        <p class="text-slate-600 my-4">Bravo, tu as fait le tour. Clique maintenant sur le bouton pour obtenir ton profil personnalis√©.</p>
        <button type="button" id="analyzeProfileBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser mon profil</button>
    </div>
    <div id="openaiLoader_step0" class="hidden mt-4"><div class="loader"></div></div>
    <div id="results-wrapper" class="mt-8 space-y-8">
        <div id="archetype-container"></div>
        <div id="analysis-container"></div>
        <div id="infographic-container"></div>
        <div id="submit-container" class="text-center pt-4 hidden">
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="button" id="retake-quiz-btn" class="w-full sm:w-1/2 bg-slate-200 text-OrIAntation-darkblue font-semibold py-3 px-6 rounded-lg hover:bg-slate-300 transition">üîÑ Recommencer le test</button>
                <button type="submit" class="w-full sm:w-1/2 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder</button>
            </div>
        </div>
    </div>
    <hr class="my-12 border-slate-300">

        <div id="pour-aller-plus-loin" class="hidden">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Pour aller plus loin : Croise les regards</h2>
            
            <p class="text-slate-600 mb-6">
                Pour une analyse encore plus riche, tu peux passer des tests compl√©mentaires sur des sites sp√©cialis√©s et copier-coller les r√©sultats ici. OrIA les croisera avec ton profil OrIAntation pour une synth√®se encore plus fine.
                <br>
                <a href="https://test-orientation.studyrama.com/profil/lyceen" target="_blank" class="font-semibold text-primary-action hover:underline">Trouver des tests sur Studyrama.com ‚Üó</a>
            </p>

            <div class="mb-6">
                <label for="test_interets" class="block text-md font-medium text-slate-700 mb-2">1. R√©sultats du Test d'Int√©r√™ts Professionnels</label>
                <textarea id="test_interets" name="test_interets" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes r√©sultats...">${journalData.step0.test_interets || ''}</textarea>
            </div>
            <div class="mb-6">
                <label for="test_motivation" class="block text-md font-medium text-slate-700 mb-2">2. R√©sultats du Test de Motivation</label>
                <textarea id="test_motivation" name="test_motivation" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes r√©sultats...">${journalData.step0.test_motivation || ''}</textarea>
            </div>
            <div class="mb-6">
                <label for="test_personnalite" class="block text-md font-medium text-slate-700 mb-2">3. R√©sultats du Test de Personnalit√©</label>
                <textarea id="test_personnalite" name="test_personnalite" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici le texte de tes r√©sultats...">${journalData.step0.test_personnalite || ''}</textarea>
            </div>
            <div class="text-center mb-4">
                <button type="button" id="openaiBtn_test_croise" class="bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">üí° Lancer l'analyse crois√©e</button>
            </div>
            <div id="openaiLoader_test_croise" class="hidden"><div class="loader"></div></div>
            <div class="mb-6">
                <label for="analyse_tests_croisee" class="block text-md font-medium text-slate-700 mb-2">Analyse crois√©e par OrIA</label>
                <textarea id="analyse_tests_croisee" name="analyse_tests_croisee" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${journalData.step0.analyse_tests_croisee || ''}</textarea>
            </div>
        </div>
    `;

    // --- Logique et fonctions ---
    let currentQuestionIndex = 0;
    if (!journalData.step0) journalData.step0 = {};

    const renderArchetype = (archetype) => {
        if (!archetype || !archetype.titre) return;
        const container = div.querySelector('#archetype-container');
        container.innerHTML = `<div class="bg-cyan-50 border-2 border-dashed border-cyan-300 p-6 rounded-2xl text-center"><span class="text-5xl">${archetype.icone}</span><h3 class="text-2xl font-bold text-cyan-800 mt-2">${archetype.titre}</h3><p class="text-slate-600 mt-2">${archetype.description}</p></div>`;
    };
    const renderAnalysis = (analysis) => {
        const container = div.querySelector('#analysis-container');
        container.innerHTML = `<div><label class="block text-md font-medium text-slate-700 mb-2">Analyse d√©taill√©e :</label><textarea name="analysis" rows="15" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${analysis}</textarea></div>`;
    };
    const renderInfographic = (step0Data) => {
        const container = div.querySelector('#infographic-container');
        container.innerHTML = '';
        container.appendChild(createProfileInfographic(step0Data));
    };

    const renderQuestion = (index) => {
    if (index >= questions.length) {
        form.querySelector('#quiz-wrapper').classList.add('hidden');
        form.querySelector('#analysis-section').classList.remove('hidden');
        return;
    }
    const question = questions[index];
    const progressPercent = ((index + 1) / questions.length) * 100;
    form.querySelector('#quiz-progress-bar').style.width = `${progressPercent}%`;
    form.querySelector('#quiz-progress-text').textContent = `Question ${index + 1} / ${questions.length}`;
    form.querySelector('#quiz-part-text').textContent = question.part;
    const answersHTML = Object.entries(question.options).map(([value, data]) => 
        `<button type="button" data-value="${value}" class="answer-btn w-full text-left p-4 my-2 bg-white border border-slate-300 rounded-lg hover:bg-cyan-100 hover:border-cyan-400 transition">${data.text}</button>`
    ).join('');
    const questionContainer = form.querySelector('#quiz-question-container');
    questionContainer.innerHTML = `<div class="fade-in"><p class="text-lg font-semibold text-OrIAntation-darkblue mb-6">${question.label}</p><div class="flex flex-col">${answersHTML}</div></div>`;
    
    questionContainer.querySelectorAll('.answer-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const qId = `q${question.id}`;
            journalData.step0[qId] = e.target.dataset.value;
            currentQuestionIndex++;
            
            // ‚úÖ LA CORRECTION EST ICI
            // On ajoute un minuscule d√©lai pour √©viter le bug d'affichage al√©atoire
            setTimeout(() => {
                renderQuestion(currentQuestionIndex);
            }, 10); // 10 millisecondes suffisent
        });
    });
};
    
    form.querySelector('#analyzeProfileBtn').addEventListener('click', async () => {
        const loader = div.querySelector('#openaiLoader_step0');
        const submitContainer = div.querySelector('#submit-container');
        const answersText = questions.map(q => {
            const answerValue = journalData.step0[`q${q.id}`];
            if (!answerValue) return null;
            const answerText = q.options[answerValue]?.text || 'Non r√©pondu';
            return `- ${q.label} -> ${answerText}`;
        }).filter(line => line !== null).join('\n');

        if (Object.keys(journalData.step0).filter(k => k.startsWith('q')).length < questions.length) {
             showInfoModal("Attention", "Veuillez r√©pondre √† toutes les questions pour obtenir une analyse.");
             return;
        }

        loader.style.display = 'block';
        form.querySelector('#analysis-section').classList.add('hidden');

        let profileAnalysis = '';
        let rawArchetypeResponse = '';
        const appFeaturesSummary = getAppFeaturesSummary();
        const situationParagraphe = div.querySelector('#situation').value;



const analysisPrompt = `
        Agis en tant que psychologue exp√©riment√©(e) et coach pour l'application OrIAntation.
            Tu viens de recevoir les r√©ponses d'un(e) lyc√©en(ne) √† un questionnaire de personnalit√©.

            # Contexte de l'Application (Mode d'emploi)
            Voici la liste des seules fonctionnalit√©s que tu peux sugg√©rer. N'en invente aucune autre.
            ${appFeaturesSummary}

            # Donn√©es sur l'√©l√®ve (TR√àS IMPORTANT)
            Voici d'abord son auto-√©valuation de sa situation actuelle :
            "${situationParagraphe}"

            Voici ensuite ses r√©ponses au questionnaire de personnalit√© :
            ${answersText}

            # Ta Mission
            R√©dige une analyse compl√®te, bienveillante et structur√©e. Tu dois **imp√©rativement prendre en compte son auto-√©valuation** pour personnaliser ton introduction et tes conclusions. Si l'√©l√®ve a mentionn√© des pistes, commente-les √† la lumi√®re de son profil. S'il est perdu, rassure-le et montre-lui comment son profil peut √™tre un point de d√©part solide.

            # Format de Sortie (TR√àS IMPORTANT)
            Ta r√©ponse doit √™tre fluide et naturelle. Il est **imp√©ratif** de ne JAMAIS utiliser de listes num√©rot√©es (1., 2.) ou de listes √† puces (*, -).
            Structure ta r√©ponse en utilisant uniquement les titres suivants, en gras (avec **). Chaque section doit √™tre un paragraphe enti√®rement r√©dig√©.

            **Synth√®se de ton profil**
            (R√©dige ici le paragraphe de r√©sum√© global et positif.)

            **Tes atouts et Pistes de R√©flexion**
            (R√©dige ici l'analyse de son mode de fonctionnement et de ses forces.)

            **Les Environnements Faits pour toi**
            (R√©dige ici la description du type d'environnement et les suggestions de domaines.)

            **Actions concr√®tes dans l'app OrIAntation**
            (R√©dige ici les 2 suggestions d'actions, int√©gr√©es dans un paragraphe fluide.)
        `;
    
        profileAnalysis = await callOpenAI_API({
        promptText: analysisPrompt, // La mission est pass√©e ici
        promptId: "pmpt_68dc33a589bc8197a0229d72a4e3df100510635f4c084c2c", // L'ID du prompt Expert
        isExpertCall: true,
        loaderElement: loader // ‚úÖ On passe le loader √† la fonction

    });
        journalData.step0.analysis = profileAnalysis;

        const riasecScores = { R: 0, I: 0, A: 0, S: 0, E: 0, C: 0 };
        const riasecMapping = { q1: { sens: 'S', securite: 'C', creativite: 'A', autonomie: 'E' }, q2: { defi: 'I', maitrise: 'I', collaboration: 'S' }, q3: { diriger: 'E', creer: 'A', comprendre: 'I' }, q4: { variete: 'E', stabilite: 'C' }, q5: { influence: 'E', expertise: 'I' }, q6: { passion: 'A', ambition: 'E' }, q7: { transmettre: 'S', organiser: 'C', inventer: 'A' }, q8: { ouverture: 'A', tradition: 'C' }, q9: { consciencieux: 'C', flexible: 'E' }, q11: { agreable: 'S', assertif: 'E' }, q13: { detail: 'C', synthese: 'I' }, q14: { curieux: 'I', pratique: 'R' }, q15: { realiste: 'R', investigatif: 'I' }, q16: { artistique: 'A', social: 'S' }, q17: { entreprenant: 'E', conventionnel: 'C' }, q18: { social: 'S', entreprenant: 'E' }, q19: { artistique: 'A', conventionnel: 'C' }, q20: { realiste: 'R', artistique: 'A' }, q21: { social: 'S', investigatif: 'I', realiste: 'R' }, q22: { realiste: 'R', social: 'S' }, q23: { investigatif: 'I', entreprenant: 'E' }, q24: { artistique: 'A', conventionnel: 'C' }, q25: { social: 'S', investigatif: 'I' }, q26: { entreprenant: 'E', realiste: 'R' }, q27: { conventionnel: 'C', artistique: 'A' }, q28: { investigatif: 'I', realiste: 'R' }, q29: { social: 'S', entreprenant: 'E' }, q30: { artistique: 'A', conventionnel: 'C', realiste: 'R' } };
        for (const [questionId, mapping] of Object.entries(riasecMapping)) {
            const answer = journalData.step0[questionId];
            if (answer && mapping[answer]) riasecScores[mapping[answer]]++;
        }
        journalData.step0.riasecScores = riasecScores; // On sauvegarde le score correct

        const riasecNames = { R: 'R√©aliste', I: 'Investigateur', A: 'Artistique', S: 'Social', E: 'Entreprenant', C: 'Conventionnel' };
        const top3Names = Object.entries(riasecScores).sort(([,a],[,b]) => b-a).slice(0, 3).map(([letter]) => riasecNames[letter]);
        const userGender = currentUserInfo.gender || 'autre';

        const archetypePrompt = `
    # Ton R√¥le
    Tu es un psychologue expert en orientation, charg√© de cr√©er des profils synth√©tiques et clairs.

    # Contexte Fourni
    - Genre de l'√©l√®ve : ${userGender}
    - Profil RIASEC :
        - Majeur : ${top3Names[0]}
        - Secondaire : ${top3Names[1]}
        - Tertiaire : ${top3Names[2]}
    - Analyse de personnalit√© brute : ${profileAnalysis}

    # Ta Mission en 2 √©tapes
    1.  **Identifier l'Arch√©type Principal :** En te basant sur le profil RIASEC Majeur, choisis l'arch√©type correspondant dans cette liste :
        - R√©aliste (R) : Le Profil B√¢tisseur / La B√¢tisseuse (Ic√¥ne : üõ†Ô∏è)
        - Investigateur (I) : Le Profil Analyste (Ic√¥ne : üî¨)
        - Artistique (A) : Le Profil Cr√©atif / La Cr√©ative (Ic√¥ne : üé®)
        - Social (S) : Le Profil Relationnel (Ic√¥ne : ü§ù)
        - Entreprenant (E) : Le Profil Initiateur / L'Initiatrice (Ic√¥ne : üöÄ)
        - Conventionnel (C) : Le Profil Organisateur / L'Organisatrice (Ic√¥ne : üèõÔ∏è)
    
    2.  **Cr√©er le Titre Descriptif :** Cr√©e un titre descriptif en combinant les noms des profils RIASEC Majeur, Secondaire et Tertiaire.
        Le format doit √™tre : "Profil [Majeur], √† dominante [Secondaire] et [Tertiaire]".
        Par exemple, pour un profil I-A-S, le titre sera "Profil Analyste, √† dominante Cr√©ative et Relationnelle".

    # Format de Sortie OBLIGATOIRE
    La r√©ponse DOIT √™tre un unique objet JSON valide, sans aucun texte avant ou apr√®s.
    {
      "icone": "L'ic√¥ne de l'arch√©type principal.",
      "titre": "Le titre descriptif combin√©, accord√© au genre de l'√©l√®ve.",
      "description": "Une description personnalis√©e en 2 ou 3 phrases qui fusionne les trois traits RIASEC, en s'inspirant de l'analyse de personnalit√© brute."
    }
`;
        rawArchetypeResponse = await callOpenAI_API({
        promptText: archetypePrompt,
        isJson: true 
        // Pas de promptId, donc on utilise gpt-4o, plus rapide.
    });
        const archetypeResult = extractJsonFromString(rawArchetypeResponse);
        if (archetypeResult) journalData.step0.archetype = archetypeResult;

if (!journalData.step0.analysis_timestamp) { // On n'enregistre que la 1√®re fois
    journalData.step0.analysis_timestamp = new Date().getTime();
}

        renderAnalysis(profileAnalysis);
        if(archetypeResult) renderArchetype(archetypeResult);
        renderInfographic(journalData.step0);
        
        loader.style.display = 'none';
        submitContainer.classList.remove('hidden');
        form.querySelector('#pour-aller-plus-loin').classList.remove('hidden');
        await grantXp(100);
    });

    form.querySelector('#openaiBtn_test_croise').addEventListener('click', async () => {
        const loader = div.querySelector('#openaiLoader_test_croise');
        const resultatsInterets = div.querySelector('#test_interets').value;
        const resultatsMotivation = div.querySelector('#test_motivation').value;
        const resultatsPersonnalite = div.querySelector('#test_personnalite').value;
        const analysisTextarea = div.querySelector('#analyse_tests_croisee');
        if (!journalData.step0.analysis) {
            showInfoModal("Veuillez d'abord g√©n√©rer l'analyse de votre profil pour obtenir une analyse crois√©e.");
            return;
        }
        if (!resultatsInterets.trim() && !resultatsMotivation.trim() && !resultatsPersonnalite.trim()) {
            showInfoModal("Veuillez renseigner les r√©sultats d'au moins un test.");
            return;
        }
        loader.style.display = 'block';
        analysisTextarea.value = '';
        const prompt = `Agis en tant que psychologue-conseiller d'orientation. Un √©l√®ve a d√©j√† compl√©t√© un questionnaire de personnalit√© dont l'analyse est la suivante : "${journalData.step0.analysis}".\nPour affiner sa r√©flexion, il a pass√© 3 tests compl√©mentaires sur Studyrama. Voici ses r√©sultats :\n1.  **Test d'Int√©r√™ts Professionnels :** "${resultatsInterets}"\n2.  **Test de Motivation :** "${resultatsMotivation}"\n3.  **Test de Personnalit√© :** "${resultatsPersonnalite}"\n\nTa mission est de r√©diger une **analyse crois√©e bienveillante et constructive**. Ne te contente pas de r√©sumer chaque test. Mets en lumi√®re les **convergences** et les **confirmations**.\nStructure ta r√©ponse en 2 points :\n1.  **Ce que ces tests confirment :** Identifie les 2 ou 3 points cl√©s de son profil initial (ses forces, ses moteurs...) qui sont clairement renforc√©s par les r√©sultats de ces trois tests. Sois pr√©cis en citant des exemples.\n2.  **Une nouvelle piste √† explorer :** En te basant sur un √©l√©ment nouveau ou surprenant apparu dans les tests, propose une nouvelle piste de r√©flexion ou un domaine √† explorer auquel il n'avait peut-√™tre pas pens√©.\n\nLe ton doit √™tre tr√®s encourageant et valoriser la coh√©rence de sa d√©marche. Adresse-toi directement √† l'√©l√®ve.`;
const aiResponse = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});
        loader.style.display = 'none';
        analysisTextarea.value = result;
    });
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
            if (value) journalData.step0[key] = value;
        }
        await saveData();
        const tutorialShown = await handleOnboarding({ from: 'step0_analysis' });
        if (!tutorialShown) showView('menu');
    });
    
    if (journalData.step0 && journalData.step0.analysis) {
        renderAnalysis(journalData.step0.analysis);
        renderInfographic(journalData.step0);
        if (journalData.step0.archetype) {
            renderArchetype(journalData.step0.archetype);
        }
        form.querySelector('#quiz-wrapper').classList.add('hidden');
        form.querySelector('#analysis-section').classList.add('hidden');
        form.querySelector('#submit-container').classList.remove('hidden');
        form.querySelector('#pour-aller-plus-loin').classList.remove('hidden');
    }
    
    renderQuestion(0);
    

    div.querySelector('#retake-quiz-btn').addEventListener('click', async () => {
    const lastTimestamp = journalData.step0.analysis_timestamp || 0;
    const now = new Date().getTime();
    const daysSinceLastTest = (now - lastTimestamp) / (1000 * 60 * 60 * 24);
    const cooldownDays = 90; // D√©lai de 3 mois (environ 90 jours)

    // Si le d√©lai n'est pas √©coul√©, on affiche la fen√™tre modale √©ducative
    if (daysSinceLastTest < cooldownDays) {
        const daysRemaining = Math.ceil(cooldownDays - daysSinceLastTest);
        const title = "Une nouvelle photographie de toi-m√™me üì∏";
        const contentHTML = `
            <div class="space-y-3 text-slate-600 text-left">
                <p>Ton profil est comme une photographie de tes int√©r√™ts √† un moment pr√©cis. C'est un excellent point de d√©part !</p>
                <p class="font-semibold">√Ä ton √¢ge, on se construit et on √©volue tr√®s vite. C'est pourquoi il est int√©ressant de refaire ce test de temps en temps pour voir comment ta r√©flexion a m√ªri.</p>
                <p class="p-3 bg-cyan-50 border border-cyan-200 rounded-lg text-center">
                    Tu pourras refaire le test dans <strong>${daysRemaining} jour(s)</strong>.
                </p>
                <p>D'ici l√†, continue d'explorer les autres √©tapes pour affiner ta connaissance de toi-m√™me !</p>
            </div>
        `;
        createSimpleModal(title, contentHTML); // On utilise la modale simple pour un meilleur affichage
        return;
    }

    // Si le d√©lai est √©coul√©, on affiche le message de confirmation
    const confirmed = await showConfirmationModal(
        "C'est le bon moment pour prendre une nouvelle 'photographie' de ton profil et voir comment tu as √©volu√©. Tes r√©sultats actuels seront remplac√©s par les nouveaux. Veux-tu continuer ?"
    );
    
    if (confirmed) {
    // On r√©initialise les donn√©es du quiz et des r√©sultats
    journalData.step0 = {
        ...stepsConfig.step0.fields.reduce((acc, field) => ({ ...acc, [field.id]: '' }), {}),
        analysis: '',
        archetype: null,
        riasecScores: {},
        // On remet le timestamp √† z√©ro pour que le prochain test enregistre une nouvelle date
        analysis_timestamp: 0 
    };
    await saveData();
    
    // On rafra√Æchit la vue pour r√©afficher le questionnaire
    showView('step0');
}
});
    return div;
}
        
        function createStep1Field(field) {
            const value = (journalData.step1 && journalData.step1[field.id]) || '';
            return `
                <div class="mb-4">
                    <label for="${field.id}" class="block text-md font-medium text-slate-700 mb-2">${field.label}</label>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="${field.id}" name="${field.id}" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="${field.placeholder}" value="${value}">
                        <button type="button" id="openaiBtn_${field.id}" class="bg-cyan-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-cyan-700 transition" title="Explorer les d√©bouch√©s avec OrIA">‚ú®</button>
                        <button type="button" id="daySimBtn_${field.id}" class="bg-sky-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-sky-600 transition" title="Simuler une journ√©e type">üìÖ</button>
                    </div>
                    <div id="openaiLoader_${field.id}" class="hidden mt-4"><div class="loader"></div></div>
                    <div id="openaiResult_${field.id}" class="mt-4 p-4 bg-cyan-50 border border-cyan-200 rounded-lg text-slate-700 whitespace-pre-wrap"></div>
                </div>
            `;
        }
        
// REMPLACEZ VOTRE FONCTION createStep1View EXISTANTE PAR CE CODE COMPLET :
// REMPLACEZ INT√âGRALEMENT votre fonction createStep1View par celle-ci

function createStep1View() {
    const config = stepsConfig.step1;
    const div = createStepView(config); // On garde la base (titre, description...)
    const form = div.querySelector('#stepForm');
    
    // --- √âtat local pour l'exploration en cours ---
    let currentExploration = {
        nom: '',
        notes: '',
        analyses: {}
    };

    // --- Fonctions de rendu ---

    // Affiche la liste des m√©tiers d√©j√† sauvegard√©s
    const renderSavedMetiers = () => {
        const container = div.querySelector('#saved-metiers-container');
        if (!container) return;

        const metiers = journalData.step1.metiers || [];
        if (metiers.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de m√©tier enregistr√©.</p>`;
            checkComparisonState();
            return;
        }

        container.innerHTML = metiers.map((metier, index) => {
            let analysesHTML = '';
            if (metier.analyses) {
                if(metier.analyses.debouches) analysesHTML += `<li><strong>D√©bouch√©s :</strong> Analys√©s.</li>`;
                if(metier.analyses.journee) analysesHTML += `<li><strong>Journ√©e type :</strong> Simul√©e.</li>`;
                if(metier.analyses.temoignages) analysesHTML += `<li><strong>T√©moignages :</strong> Trouv√©s.</li>`;
            }

            return `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${metier.nom}</span>
                        <button type="button" data-index="${index}" class="delete-metier-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer ce m√©tier">üóëÔ∏è</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle">
                        <p class="font-semibold">Notes :</p>
                        <p class="whitespace-pre-wrap text-sm mb-2">${metier.notes || 'Aucune note.'}</p>
                        <p class="font-semibold">Analyses :</p>
                        <ul class="list-disc list-inside text-sm">${analysesHTML || 'Aucune analyse effectu√©e.'}</ul>
                    </div>
                </details>
            `;
        }).join('');
        checkComparisonState();
    };

    // --- Structure HTML de la nouvelle page ---
    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">üî¨ Atelier d'exploration en cours</h2>
            <div class="mb-4">
                <input type="text" id="current-metier" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Cherche un m√©tier √† explorer...">
                <div id="search-results" class="relative"></div>
            </div>
            <div id="fiche-metier-container" class="mt-4"></div>
            <div class="mb-4 mt-4">
                <label for="current-notes" class="block text-md font-medium text-slate-700 mb-2">Prends tes notes ici</label>
                <textarea id="current-notes" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ce qui retient ton attention..."></textarea>
            </div>
            <div class="flex flex-wrap gap-2 justify-center mb-4">
                <button type="button" data-action="debouches" class="ai-btn flex-grow bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® D√©bouch√©s</button>
                <button type="button" data-action="journee" class="ai-btn flex-grow bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 transition">üìÖ Journ√©e type</button>
                <button type="button" data-action="temoignages" class="ai-btn flex-grow bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">üé¨ T√©moignages</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border border-border-subtle rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
<button type="button" id="save-metier-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">üíæ Enregistrer ce m√©tier dans mon journal</button>        
</div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">üìö Mes M√©tiers Enregistr√©s</h2>
        <div id="saved-metiers-container" class="space-y-3 mb-8"></div>
        
        <div id="comparison-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0 0 12 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52v1.664M5.25 4.97v1.664m-3.75 0V9.67c0 .723.231 1.423.65 1.996l3.428 4.571a.75.75 0 0 1 .16.529V20.25m8.25-15.28V9.67c0 .723.231 1.423.65 1.996l3.428 4.571a.75.75 0 0 1 .16.529V20.25" /></svg>
                <span>Comparateur de M√©tiers</span>
            </h2>
            <p class="text-slate-600 mb-4">Maintenant que tu as explor√© plusieurs pistes, utilise OrIA pour g√©n√©rer un tableau comparatif et t'aider √† y voir plus clair.</p>
            <div class="text-center">
                <button type="button" id="compare-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Comparer mes m√©tiers enregistr√©s</button>
            </div>
            <div id="loader-comparison" class="hidden"><div class="loader"></div></div>
            <div id="comparison-result" class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg text-slate-700 text-left"></div>
            <input type="hidden" name="comparison" id="comparison" value="${journalData.step1.comparison || ''}">
        </div>
    `;

    // --- Logique des √©v√©nements ---

    const resetWorkspace = () => {
        currentExploration = { nom: '', notes: '', analyses: {} };
        div.querySelector('#current-metier').value = '';
        div.querySelector('#current-notes').value = '';
        div.querySelector('#result').innerHTML = '';
        div.querySelector('#fiche-metier-container').innerHTML = '';
    };

    div.querySelector('#save-metier-btn').addEventListener('click', async () => {
        currentExploration.nom = div.querySelector('#current-metier').value.trim();
        currentExploration.notes = div.querySelector('#current-notes').value.trim();

        if (!currentExploration.nom) {
            showInfoModal("Veuillez renseigner un nom de m√©tier avant d'enregistrer.");
            return;
        }

        if (!journalData.step1.metiers) {
            journalData.step1.metiers = [];
        }
        journalData.step1.metiers.push(currentExploration);
        
        await saveData();
        await grantXp(30);
        
        // ‚ñº‚ñº‚ñº AJOUTEZ CETTE LIGNE CI-DESSOUS ‚ñº‚ñº‚ñº
        const tutorialShown = await handleOnboarding({ from: 'step1_save' });

        renderSavedMetiers();
        resetWorkspace();
        
        // On n'affiche la fen√™tre de confirmation que si le tutoriel n'a pas affich√© sa propre fen√™tre
        if (!tutorialShown) {
            showSurpriseModal("M√©tier sauvegard√© !", "<p>Super ! Cette piste est maintenant dans ton journal. Pr√™t(e) √† en explorer une nouvelle ?</p>", 3000);
        }
    });

    
    div.querySelectorAll('.ai-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const metier = div.querySelector('#current-metier').value.trim();
            const loader = div.querySelector('#loader');
            const resultDiv = div.querySelector('#result');
            
            if (!metier) {
                showInfoModal("Veuillez d'abord entrer un nom de m√©tier.");
                return;
            }

            resultDiv.innerHTML = '';
            loader.style.display = 'block';

            const profileSummary = getProfileSummary(); // <-- ‚úÖ CORRECTION ICI

            
            let prompt = '';
            let isJson = false;

            switch (action) {
    case 'debouches':
        prompt = `
            Agis comme un expert du march√© du travail qui s'adresse √† un lyc√©en.
            Le m√©tier est : "${metier}".
            Le profil du lyc√©en est : ${profileSummary}.

            # Ta Mission
            R√©dige une analyse CONCISE des d√©bouch√©s de ce m√©tier.

            # Format de Sortie OBLIGATOIRE
            Structure ta r√©ponse en 3 points clairs avec les titres suivants en gras. Sois bref et factuel (2-3 phrases par point).
            
            1.  **Les D√©buts :** D√©cris le poste typique pour un d√©butant.
            2.  **L'√âvolution :** Cite 2 √©volutions de carri√®re possibles.
            3.  **Le Conseil du Coach (pour toi) :** En te basant sur le profil de l'√©l√®ve, explique EN QUOI ce m√©tier est une piste particuli√®rement int√©ressante pour lui/elle. Mets en avant UN SEUL point de connexion fort.
        `;
        break;

    case 'journee':
        prompt = `
            Tu es un(e) ${metier} passionn√©(e) et un excellent conteur d'histoires. Tu √©cris le r√©cit d√©taill√© d'une de tes journ√©es de travail pour un lyc√©en.
            Le profil du lyc√©en est : ${profileSummary}.

            # Ta Mission
            R√©dige un r√©cit immersif, d√©taill√© et inspirant √† la premi√®re personne ("Je"). 
            Pour rendre ton r√©cit vivant, construis-le en 4 temps :
            1.  **L'Ambiance du Matin :** D√©cris ton √©tat d'esprit, le premier d√©fi ou la mission principale de la journ√©e.
            2.  **Le C≈ìur de la Mission :** Raconte en d√©tail la t√¢che la plus complexe et int√©ressante que tu as accomplie. Mentionne les outils, les comp√©tences et la r√©flexion n√©cessaires.
            3.  **Un Moment Cl√© :** D√©cris une interaction importante avec un coll√®gue/client, ou un probl√®me inattendu que tu as d√ª r√©soudre.
            4.  **Le Bilan du Soir :** Termine sur la satisfaction du travail accompli ou la le√ßon apprise durant la journ√©e.
            
            # R√®gle d'Or de Personnalisation
            Insiste sur les aspects de la journ√©e (cr√©ativit√©, analyse, contact humain...) qui sont les plus pertinents pour le profil du lyc√©en.

            # Format de Sortie OBLIGATOIRE
            - Ta r√©ponse doit √™tre un texte fluide et unifi√© d'environ 400 √† 450 mots.
            - NE PAS utiliser de listes num√©rot√©es, de tirets, ou de titres en gras. Le texte doit se lire comme une histoire coh√©rente.
        `;
        break;

    case 'temoignages':
        prompt = `
            Agis comme un coach d'orientation qui compile des ressources pour un √©l√®ve s'int√©ressant au m√©tier de "${metier}".
            Ta mission est de g√©n√©rer 3 exemples de t√©moignages (vid√©o, article, podcast) qui pourraient exister.
            
            Pour chaque t√©moignage :
            1. Invente un titre accrocheur et un court r√©sum√©.
            2. Pour la cl√© "lien", ne cherche PAS une URL r√©elle. Construis SYST√âMATIQUEMENT une URL de recherche Google pertinente pour trouver ce type de contenu.
               Exemple de lien : "https://www.google.com/search?q=t√©moignage+vid√©o+m√©tier+${encodeURIComponent(metier)}".

            # Format de Sortie OBLIGATOIRE
            Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau de 3 objets.
            Chaque objet doit avoir les cl√©s "titre", "resume", et "lien".
        `;
        isJson = true;
        break;
}

            const result = await callOpenAI_API({ promptText: prompt, withPersona: true, isJson: isJson });
            loader.style.display = 'none';

            currentExploration.analyses[action] = result;
            
            if (action === 'temoignages') {
    try {
        const testimonials = extractJsonFromString(result);
        let htmlResult = '<div class="space-y-4">';
        (testimonials || []).forEach(item => {
            htmlResult += `<div class="p-3 bg-white rounded-md"><a href="${item.lien}" target="_blank" class="font-semibold text-primary-action hover:underline">${item.titre}</a><p class="text-xs">${item.resume}</p></div>`;
        });
        htmlResult += '</div>';
        resultDiv.innerHTML = htmlResult;
    } catch(e) { resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage.</p><pre>${result}</pre>`;
}
            } else {
                resultDiv.innerHTML = linkify(result);
            }
        });
    });

    const checkComparisonState = () => {
        const comparisonSection = form.querySelector('#comparison-section');
        const metiers = journalData.step1.metiers || [];
        if (comparisonSection) {
            comparisonSection.classList.toggle('hidden', metiers.length < 2);
        }
    };

    div.querySelector('#compare-btn').addEventListener('click', async () => {
        const loader = div.querySelector('#loader-comparison');
        const resultDiv = div.querySelector('#comparison-result');
        const metiersAComparer = journalData.step1.metiers;
        if (metiersAComparer.length < 2) return;
        
        loader.style.display = 'block';
        resultDiv.innerHTML = '';

        const prompt = `Cr√©e un tableau comparatif au format Markdown et une remarque de synth√®se pour les m√©tiers suivants : ${JSON.stringify(metiersAComparer)}. Ta r√©ponse doit √™tre un JSON avec les cl√©s "tableau" et "remarques".`;
        const result = await callOpenAI_API({ promptText: prompt, model: 'gpt-4o', isJson: true });
        
        loader.style.display = 'none';
        try {
            const data = extractJsonFromString(result);
            const markdownTableToHtml = (markdown) => {
                const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
                let html = `<div class="comparison-table-wrapper"><table class="w-full text-left border-collapse">`;
                const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th class="p-3 border-b-2 font-bold bg-slate-100">${cell.trim()}</th>`).join('');
                html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
                lines.slice(2).forEach(line => {
                    const rowCells = line.split('|').slice(1, -1).map(cell => `<td class="p-3 border-b align-top text-sm">${linkify(cell.trim())}</td>`).join('');
                    html += `<tr>${rowCells}</tr>`;
                });
                html += `</tbody></table></div>`;
                return html;
            };
            resultDiv.innerHTML = markdownTableToHtml(data.tableau) + `<p class="mt-4 text-sm italic">${data.remarques}</p>`;
            journalData.step1.comparison = JSON.stringify(data);
        } catch(e) { resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage.</p><pre>${result}</pre>`; }
    });
    
    if (journalData.step1.comparison) {
        // Logique pour afficher la comparaison sauvegard√©e
    }

    div.querySelector('#saved-metiers-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-metier-btn')) {
            const index = e.target.closest('.delete-metier-btn').dataset.index;
            const confirmed = await showConfirmationModal("Es-tu s√ªr de vouloir supprimer ce m√©tier de ton journal ?");
            if (confirmed) {
                journalData.step1.metiers.splice(index, 1);
                await saveData();
                renderSavedMetiers();
            }
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        showView('menu');
    });

    // --- Logique de recherche et d'affichage de la fiche (r√©utilis√©e de votre code) ---
    const addSearchFunctionality = () => {
        const metierInput = form.querySelector('#current-metier');
        const searchResultsContainer = form.querySelector('#search-results');
        const resultsWrapper = document.createElement('div');
        resultsWrapper.className = 'absolute z-10 w-full bg-white border border-slate-200 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg';
        searchResultsContainer.appendChild(resultsWrapper);

        // REMPLACEZ la fonction "displayMetierFiche" existante par celle-ci

const displayMetierFiche = (metier) => {
    const ficheContainer = form.querySelector(`#fiche-metier-container`);
    let ficheHTML = `
        <div class="p-6 bg-white border-2 border-cyan-100 rounded-2xl space-y-6 text-slate-700 text-left relative transition-all duration-300 ease-in-out shadow-lg">
            <button type="button" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600 font-bold text-2xl p-1 leading-none" title="Fermer la fiche">√ó</button>
            <div class="text-center border-b pb-4">
                <h2 class="text-2xl font-bold text-OrIAntation-darkblue">${metier.libelle || metier.nom_metier}</h2>
                ${metier.accroche_metier ? `<p class="text-slate-500 mt-2 italic">"${metier.accroche_metier}"</p>` : ''}
            </div>
    `;

    if (metier.centres_interet && metier.centres_interet.centre_interet) {
        const items = Array.isArray(metier.centres_interet.centre_interet) ? metier.centres_interet.centre_interet : [metier.centres_interet.centre_interet];
        const tagsHTML = items.map(item => `<span class="bg-cyan-100 text-cyan-800 text-sm font-semibold mr-2 mb-2 px-3 py-1 rounded-full">${item.libelle}</span>`).join('');
        ficheHTML += `
            <div>
                <h3 class="font-bold text-OrIAntation-darkblue mb-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75 2.25 12l4.179 2.25m0-4.5 5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-5.571 3-5.571-3Z" /></svg>
                    Centres d'int√©r√™t associ√©s
                </h3>
                <div class="flex flex-wrap">${tagsHTML}</div>
            </div>
        `;
    }
    
    let column1HTML = '';
    let column2HTML = '';
    
    const champsInteressants = [
        { key: 'nature_travail', titre: 'Nature du travail', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21v-4.5m0 4.5h4.5m-4.5 0L9 15M21 3.75v4.5m0-4.5h-4.5m4.5 0L15 9" /></svg>` },
        { key: 'competences', titre: 'Comp√©tences requises', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" /></svg>` },
        { key: 'condition_travail', titre: 'Conditions de travail', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>` },
        { key: 'vie_professionnelle', titre: 'Vie professionnelle', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" /></svg>` },
        { key: 'acces_metier', titre: 'Acc√®s au m√©tier', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg>` },
        { key: 'niveau_acces_min._', titre: 'Niveau d\'acc√®s minimal', icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg>` }
    ];

    const getValue = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj);

    champsInteressants.forEach((champ, i) => {
        const valeur = getValue(metier, champ.key);
        if (valeur && typeof valeur === 'string') {
            const sectionHTML = `
                <div class="mb-6">
                    <h3 class="font-bold text-OrIAntation-darkblue mb-2 flex items-center gap-2">${champ.icon} ${champ.titre}</h3>
                    <div class="text-sm prose prose-sm max-w-none fiche-content">${valeur}</div>
                </div>
            `;
            if (i % 2 === 0) {
                column1HTML += sectionHTML;
            } else {
                column2HTML += sectionHTML;
            }
        }
    });

    ficheHTML += `
         <div class="grid md:grid-cols-2 gap-x-8 pt-4 border-t">
            <div class="fiche-colonne-contenu">${column1HTML}</div>
            <div class="fiche-colonne-contenu">${column2HTML}</div>
        </div>
    `;

    if (metier.vie_professionnelle) {
        const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(metier.libelle + " salaire d√©butant")}`;
        ficheHTML += `
            <div class="border-t pt-4 mt-4">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">Pour aller plus loin</h3>
                <a href="${googleSearchUrl}" target="_blank" class="inline-block text-sm bg-sky-100 text-sky-800 font-semibold py-1 px-3 rounded-lg hover:bg-sky-200 transition">üîé Rechercher des estimations de salaire ‚Üó</a>
            </div>`;
    }
    ficheHTML += `</div>`;
    
    ficheContainer.innerHTML = ficheHTML;
    ficheContainer.querySelector('button').addEventListener('click', () => { ficheContainer.innerHTML = ''; });
};

        metierInput.addEventListener('input', async () => {
            const searchTerm = metierInput.value.trim().toLowerCase();
            resultsWrapper.innerHTML = ''; 
            if (searchTerm.length < 3) return;

            try {
                const metiersRef = collection(db, "onisep_metiers_xml"); 
                const q = query(metiersRef, where("nom_metier", ">=", searchTerm), where("nom_metier", "<=", searchTerm + '\uf8ff'), limit(10));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    resultsWrapper.innerHTML = `<div class="p-2 text-slate-500">Aucun r√©sultat direct.</div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const metier = doc.data();
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item p-2 cursor-pointer hover:bg-cyan-100';
                        resultDiv.textContent = metier.libelle || metier.nom_metier;
                        resultDiv.dataset.metier = JSON.stringify(metier);
                        resultDiv.dataset.libelle = metier.libelle || metier.nom_metier;
                        resultsWrapper.appendChild(resultDiv);
                    });
                }
            } catch (error) {
                console.error("Erreur de recherche Firestore : ", error);
            }
        });
    
        resultsWrapper.addEventListener('click', (e) => {
            const target = e.target.closest('.result-item');
            if (target) {
                metierInput.value = target.dataset.libelle;
                resultsWrapper.innerHTML = '';
                displayMetierFiche(JSON.parse(target.dataset.metier));
            }
        });

        document.addEventListener('click', (e) => {
            if (!searchResultsContainer.contains(e.target)) {
                resultsWrapper.innerHTML = '';
            }
        });
    };

    renderSavedMetiers();
    addSearchFunctionality(); // On active la recherche
    return div;
}

// ‚ñº‚ñº‚ñº REMPLACEZ TOUTE VOTRE FONCTION createStep2View PAR CE BLOC ‚ñº‚ñº‚ñº

function createStep2View() {
    const config = stepsConfig.step2;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    if (!journalData.step2.combinations || !Array.isArray(journalData.step2.combinations)) {
        journalData.step2.combinations = [];
    }

    let currentExploration = {
        name: '',
        domains: [ { name: '', diplomas: '', jobs: '' }, { name: '', diplomas: '', jobs: '' } ],
        analysis: '',
        testimonial: ''
    };

    const renderSavedCombos = () => {
        const container = div.querySelector('#saved-combos-container');
        if (!container) return;
        const combinations = journalData.step2.combinations || [];
        if (combinations.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de combinaison enregistr√©e.</p>`;
        } else {
            container.innerHTML = combinations.map((combo, index) => `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${combo.name}</span>
                        <button type="button" data-index="${index}" class="delete-combo-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer">üóëÔ∏è</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle">${renderStep2InJournal({ combinations: [combo] })}</div>
                </details>
            `).join('');
        }
        checkComparisonState();
    };

    const createDomainBlock = (index) => `
        <div class="p-4 bg-background-light rounded-lg border border-border-subtle mb-4">
            <h4 class="font-bold text-slate-700 mb-2">Domaine d'activit√© #${index}</h4>
            <div class="mb-2"><label class="text-sm font-medium">Nom du domaine</label><input type="text" id="domain_name_${index}" class="w-full mt-1 p-2 border rounded-lg" placeholder="Ex: Sciences de la sant√©"></div>
            <div class="mb-2"><label class="text-sm font-medium">Dipl√¥mes possibles</label><textarea rows="2" id="domain_diplomas_${index}" class="w-full mt-1 p-2 border rounded-lg" placeholder="Ex: PASS, Licence..."></textarea></div>
            <div><label class="text-sm font-medium">M√©tiers possibles</label><textarea rows="2" id="domain_jobs_${index}" class="w-full mt-1 p-2 border rounded-lg" placeholder="Ex: M√©decin, Pharmacien..."></textarea></div>
        </div>
    `;

    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Atelier d'exploration de Combinaison</h2>
            <div class="mb-4">
                <label for="current-combo" class="block text-md font-medium text-slate-700 mb-2">Nomme ta combinaison</label>
                <input type="text" id="current-combo" class="w-full p-3 border rounded-lg" placeholder="Ex: Maths, Physique-Chimie, SVT">
            </div>
            <h3 class="text-lg font-semibold text-slate-800 my-4">Mes trouvailles sur Horizons21</h3>
            ${createDomainBlock(1)}
            ${createDomainBlock(2)}
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6">
                <button type="button" data-action="analyse" class="ai-btn w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser et lier au profil</button>
                <button type="button" data-action="testimonial" class="ai-btn w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">üó£Ô∏è Voir un t√©moignage</button>
            </div>
            <div id="loader" class="hidden my-4"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            <button type="button" id="save-combo-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">üíæ Enregistrer cette combinaison</button>
        </div>
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes Combinaisons Enregistr√©es</h2>
        <div id="saved-combos-container" class="space-y-3 mb-8"></div>
        <div id="comparison-section" class="hidden mt-8">
    <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Comparateur de Combinaisons</h2>
    <p class="text-slate-600 mb-4">Maintenant que tu as explor√© plusieurs pistes, g√©n√®re un tableau comparatif pour t'aider √† d√©cider.</p>
    <div class="text-center">
        <button type="button" id="compare-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Comparer mes combinaisons</button>
    </div>
    <div id="loader-comparison" class="hidden"><div class="loader"></div></div>
    <div id="comparison-result" class="mt-6"></div>
</div>
        `;

    const resetWorkspace = () => {
        currentExploration = { name: '', domains: [{}, {}], analysis: '', testimonial: '' };
        div.querySelector('#current-combo').value = '';
        for (let i = 1; i <= 2; i++) {
            div.querySelector(`#domain_name_${i}`).value = '';
            div.querySelector(`#domain_diplomas_${i}`).value = '';
            div.querySelector(`#domain_jobs_${i}`).value = '';
        }
        div.querySelector('#result').innerHTML = '';
    };

    div.querySelector('#save-combo-btn').addEventListener('click', async () => {
        currentExploration.name = div.querySelector('#current-combo').value.trim();
        if (!currentExploration.name) {
            showInfoModal("Veuillez nommer la combinaison avant de l'enregistrer.");
            return;
        }
        for (let i = 0; i < 2; i++) {
            currentExploration.domains[i] = {
                name: div.querySelector(`#domain_name_${i+1}`).value.trim(),
                diplomas: div.querySelector(`#domain_diplomas_${i+1}`).value.trim(),
                jobs: div.querySelector(`#domain_jobs_${i+1}`).value.trim()
            };
        }
        journalData.step2.combinations.push(JSON.parse(JSON.stringify(currentExploration))); // Deep copy
        await saveData();
        await grantXp(30);
        renderSavedCombos();
        resetWorkspace();
        showSurpriseModal("Combinaison sauvegard√©e !", "Cette piste est maintenant dans ton journal.", 3000);
    });

    div.querySelectorAll('.ai-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
            const action = e.target.dataset.action;
            const combo = div.querySelector('#current-combo').value.trim();
            if (!combo) { showInfoModal("Veuillez d'abord nommer la combinaison."); return; }
            
            const loader = div.querySelector('#loader');
            const resultDiv = div.querySelector('#result');
            loader.style.display = 'block';
            resultDiv.innerHTML = '';
            
            let prompt = '';
                        let isJson = false; // <-- ‚úÖ CORRECTION : D√©clarez la variable ici avec une valeur par d√©faut.

            if (action === 'analyse') {
                if (!journalData.step0.analysis) { showInfoModal("Veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'."); loader.style.display = 'none'; return; }
                prompt = `Agis comme un conseiller d'orientation. Le profil d'un √©l√®ve est : "${journalData.step0.analysis}". Il envisage la combinaison de sp√©cialit√©s : "${combo}". Fournis une analyse concise en 3 points : 1. Forces de la combinaison, 2. Lien avec son profil, 3. Piste d'exploration dans l'app.`;
 } else if (action === 'testimonial') {
                isJson = true;

                // NOUVEAU : Ajout d'une r√®gle de pertinence stricte selon la classe de l'√©l√®ve
                let strictnessInstruction = '';
                if (userGradeLevel === 'seconde') {
                    strictnessInstruction = `
                        # R√®gle Stricte de Pertinence
                        L'√©l√®ve est en Seconde et explore une combinaison de 3 sp√©cialit√©s. Les r√©sum√©s de tes 3 t√©moignages doivent **imp√©rativement mentionner ou faire allusion aux TROIS sp√©cialit√©s** contenues dans : "${combo}". La pertinence est cruciale.
                    `;
                } else if (userGradeLevel === 'premiere') {
                    strictnessInstruction = `
                        # R√®gle Stricte de Pertinence
                        L'√©l√®ve est en Premi√®re et explore une combinaison de 2 sp√©cialit√©s. Les r√©sum√©s de tes 3 t√©moignages doivent **imp√©rativement mentionner ou faire allusion aux DEUX sp√©cialit√©s** contenues dans : "${combo}". La pertinence est cruciale.
                    `;
                }
                prompt = `
                    Agis comme un coach d'orientation qui compile des ressources pour un √©l√®ve s'int√©ressant √† la combinaison de sp√©cialit√©s : "${combo}".
                    Ta mission est de g√©n√©rer 3 exemples de t√©moignages (vid√©o, article, podcast) qui pourraient exister.

                    Pour chaque t√©moignage :
                    1. Invente un titre accrocheur et un court r√©sum√©.
                    2. Pour la cl√© "lien", ne cherche PAS une URL r√©elle. Construis SYST√âMATIQUEMENT une URL de recherche pertinente pour trouver ce type de contenu.
                    3. **R√®gle imp√©rative :** Au moins un des t√©moignages DOIT √™tre une vid√©o, et son lien doit pointer vers une recherche sur YouTube.
                       Exemple de lien YouTube : "https://www.youtube.com/results?search_query=t√©moignage+sp√©cialit√©s+${encodeURIComponent(combo)}".

                    # Format de Sortie OBLIGATOIRE
                    Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau de 3 objets.
                    Chaque objet doit avoir les cl√©s "titre", "resume", et "lien".
                `;}

            const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
            loader.style.display = 'none';
            resultDiv.innerHTML = linkify(result);
            currentExploration[action] = result;
        });
    });

const checkComparisonState = () => {
    const comparisonSection = div.querySelector('#comparison-section');
    const combinations = journalData.step2.combinations || [];
    if (comparisonSection) {
        comparisonSection.classList.toggle('hidden', combinations.length < 2);
    }
};

// ‚ñº‚ñº‚ñº AJOUTEZ CE BLOC D'√âV√âNEMENT ‚ñº‚ñº‚ñº

div.querySelector('#compare-btn').addEventListener('click', async () => {
    const loader = div.querySelector('#loader-comparison');
    const resultDiv = div.querySelector('#comparison-result');
    const combosAComparer = journalData.step2.combinations;
    if (combosAComparer.length < 2) return;
    
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const prompt = `Agis comme un conseiller d'orientation expert. Compare les combinaisons de sp√©cialit√©s suivantes pour un lyc√©en : ${JSON.stringify(combosAComparer.map(c => c.name))}.
    Cr√©e un tableau comparatif au format Markdown qui analyse les forces, les faiblesses, et les principaux d√©bouch√©s de chaque combinaison.
    Termine par une remarque de synth√®se pour aider l'√©l√®ve √† choisir en fonction de son profil : ${getProfileSummary()}.
    Ta r√©ponse doit √™tre un JSON avec les cl√©s "tableau" et "remarques".`;

    const result = await callOpenAI_API({ promptText: prompt, model: 'gpt-4o', isJson: true });
    
    loader.style.display = 'none';
    try {
        const data = extractJsonFromString(result);
        const markdownTableToHtml = (markdown) => {
            // ... (assurez-vous que la fonction markdownTableToHtml est accessible ou copiez-la depuis createStep1View)
            const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
            let html = '<div class="comparison-table-wrapper"><table>';
            const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th>${cell.trim()}</th>`).join('');
            html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
            lines.slice(2).forEach(line => {
                const rowCells = line.split('|').slice(1, -1).map(cell => `<td>${linkify(cell.trim())}</td>`).join('');
                html += `<tr>${rowCells}</tr>`;
            });
            html += `</tbody></table></div>`;
            return html;
        };
        resultDiv.innerHTML = markdownTableToHtml(data.tableau) + `<p class="mt-4 text-sm italic">${data.remarques}</p>`;
        journalData.step2.comparison = JSON.stringify(data);
        await saveData();
    } catch(e) { 
        resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage de la comparaison.</p>`;
    }
});

    div.querySelector('#saved-combos-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-combo-btn')) {
            const index = e.target.closest('.delete-combo-btn').dataset.index;
            if (await showConfirmationModal("S√ªr de vouloir supprimer cette combinaison ?")) {
                journalData.step2.combinations.splice(index, 1);
                await saveData();
                renderSavedCombos();
            }
        }
    });

    renderSavedCombos();
    return div;
}

// Nouvelle fonction pour un rendu lisible dans le journal de bord
// ‚ñº‚ñº‚ñº REMPLACEZ L'INT√âGRALIT√â DE VOTRE FONCTION renderStep2InJournal PAR CELLE-CI ‚ñº‚ñº‚ñº

function renderStep2InJournal(data) {
    if (!data || !data.combinations || data.combinations.length === 0) return '';

    // La fonction est maintenant con√ßue pour afficher les d√©tails d'une seule combinaison
    const combo = data.combinations[0];
    let contentHTML = '';

    // Ajoute l'analyse de OrIA si elle existe
    if (combo.analysis) {
        contentHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">Analyse du profil :</p><div class="prose prose-sm max-w-none">${marked.parse(combo.analysis)}</div></div>`;
    }

    // Ajoute le t√©moignage de OrIA s'il existe
    if (combo.testimonial) {
        contentHTML += `<div class="mb-3"><p class="font-semibold text-slate-700">T√©moignage d'√©tudiant :</p><div class="prose prose-sm max-w-none">${marked.parse(combo.testimonial)}</div></div>`;
    }

    // Ajoute les trouvailles sur Horizons21 (les domaines)
    let domainesHTML = '';
    if (combo.domains && combo.domains.length > 0) {
         domainesHTML = combo.domains.map(domaine => {
            if (domaine.name || domaine.diplomas || domaine.jobs) {
                return `<li class="mb-2">
                            <p class="font-medium text-slate-700">Domaine : <span class="font-normal text-slate-600">${domaine.name || '...'}</span></p>
                            <p class="text-sm ml-4">Dipl√¥mes : <span class="font-normal text-slate-600">${domaine.diplomas || '...'}</span></p>
                            <p class="text-sm ml-4">M√©tiers : <span class="font-normal text-slate-600">${domaine.jobs || '...'}</span></p>
                        </li>`;
            }
            return '';
        }).join('');
    }
    if (domainesHTML) {
        contentHTML += `<div class="mt-4"><p class="font-semibold text-slate-700 mb-2">Trouvailles sur Horizons21 :</p><ul class="list-none space-y-2">${domainesHTML}</ul></div>`;
    }
    
    return contentHTML || '<p class="text-slate-500 italic">Aucun d√©tail enregistr√© pour cette combinaison.</p>';
}


function createStep3View() {
    const config = stepsConfig.step3;
    const div = createStepView(config); // On garde la base (titre, description...)
    const form = div.querySelector('#stepForm');
    
    // On s'assure que la structure de donn√©es est un tableau
    if (!journalData.step3.formations || !Array.isArray(journalData.step3.formations)) {
        journalData.step3.formations = [];
    }
    
    // --- √âtat local pour l'exploration en cours ---
    let currentExploration = {
        nom: '',
        attendus: '',
        mots_cles: '',
        analyses: {}
    };

    // --- Fonctions de rendu ---
    const renderSavedFormations = () => {
        const container = div.querySelector('#saved-formations-container');
        if (!container) return;

        const formations = journalData.step3.formations || [];
        if (formations.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de formation enregistr√©e.</p>`;
            checkComparisonState();
            return;
        }

        container.innerHTML = formations.map((formation, index) => `
            <details class="bg-background-light rounded-lg border border-border-subtle">
                <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                    <span>${formation.nom}</span>
                    <button type="button" data-index="${index}" class="delete-formation-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer cette formation">üóëÔ∏è</button>
                </summary>
                <div class="p-3 border-t border-border-subtle">
                    <div class="mb-2"><p class="font-semibold">Attendus :</p><p class="whitespace-pre-wrap text-sm">${formation.attendus || 'Non renseign√©s.'}</p></div>
                    <div class="mb-2"><p class="font-semibold">Mots-cl√©s :</p><p class="whitespace-pre-wrap text-sm">${formation.mots_cles || 'Non renseign√©s.'}</p></div>
                    ${formation.analyses.compatibilite ? `<div class="mb-2"><p class="font-semibold">Rapport de compatibilit√© :</p><p class="whitespace-pre-wrap text-sm">${formation.analyses.compatibilite}</p></div>` : ''}
                    ${formation.analyses.analyse_mots_cles ? `<div class="mb-2"><p class="font-semibold">Analyse des mots-cl√©s :</p><p class="whitespace-pre-wrap text-sm">${formation.analyses.analyse_mots_cles}</p></div>` : ''}
                </div>
            </details>
        `).join('');
        checkComparisonState();
    };

    // --- Structure HTML de la nouvelle page ---
    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center"> Atelier d'exploration de Formation</h2>
            <div class="mb-4">
                <label for="current-formation" class="block text-md font-medium text-slate-700 mb-2">Rechercher une formation</label>
                <input type="text" id="current-formation" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Cherche une formation (Ex: BUT Informatique)...">
                <div id="search-results" class="relative"></div>
            </div>
             <div class="mb-4">
                <label for="current-attendus" class="block text-md font-medium text-slate-700 mb-2">Attendus (copier-coller depuis Parcoursup)</label>
                <textarea id="current-attendus" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Copie-colle ici les attendus de la formation..."></textarea>
            </div>
            <div class="mb-4">
                <label for="current-motscles" class="block text-md font-medium text-slate-700 mb-2">Tes 3 mots-cl√©s pour cette formation</label>
                <input type="text" id="current-motscles" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Logique, programmation, travail d'√©quipe">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 justify-center mb-4">
                <button type="button" data-action="compatibilite" class="ai-btn bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">üîé Mon profil correspond-il ?</button>
                <button type="button" data-action="analyse_mots_cles" class="ai-btn bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser mes mots-cl√©s</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border border-border-subtle rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            <button type="button" id="save-formation-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">üíæ Enregistrer cette formation dans mon journal</button>
        </div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">üìö Mes Formations Enregistr√©es</h2>
        <div id="saved-formations-container" class="space-y-3 mb-8"></div>
        
        <div id="comparison-section" class="hidden mt-8">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Comparateur de Formations</h2>
            <p class="text-slate-600 mb-4">G√©n√®re un tableau comparatif pour t'aider √† choisir entre tes pistes.</p>
            <div class="text-center">
                <button type="button" id="compare-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Comparer mes formations</button>
            </div>
            <div id="loader-comparison" class="hidden"><div class="loader"></div></div>
            <div id="comparison-result" class="mt-6"></div>
        </div>
    `;

    // --- Logique des √©v√©nements ---
    const resetWorkspace = () => {
        currentExploration = { nom: '', attendus: '', mots_cles: '', analyses: {} };
        div.querySelector('#current-formation').value = '';
        div.querySelector('#current-attendus').value = '';
        div.querySelector('#current-motscles').value = '';
        div.querySelector('#result').innerHTML = '';
    };

   div.querySelector('#save-formation-btn').addEventListener('click', async () => {
        currentExploration.nom = div.querySelector('#current-formation').value.trim();
        currentExploration.attendus = div.querySelector('#current-attendus').value.trim();
        currentExploration.mots_cles = div.querySelector('#current-motscles').value.trim();
        if (!currentExploration.nom) { showInfoModal("Veuillez renseigner un nom de formation."); return; }
        journalData.step3.formations.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(30);
        renderSavedFormations();
        resetWorkspace();
        showSurpriseModal("Formation sauvegard√©e !", "Cette piste est maintenant dans ton journal.", 3000);
    });
    
    // COLLEZ CE NOUVEAU BLOC √Ä LA PLACE
div.querySelectorAll('.ai-btn').forEach(button => {
    button.addEventListener('click', async (e) => {
        const action = e.target.dataset.action;
        const nomFormation = div.querySelector('#current-formation').value.trim();
        const loader = div.querySelector('#loader');
        const resultDiv = div.querySelector('#result');
        
        if (!nomFormation) {
            showInfoModal("Veuillez d'abord renseigner le nom de la formation.");
            return;
        }

        resultDiv.innerHTML = '';
        loader.style.display = 'block';
        
        let prompt = '';
        let result = '';

        if (action === 'compatibilite') {
            const attendus = div.querySelector('#current-attendus').value.trim();
            if (!journalData.step0.analysis) { showInfoModal("Veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'."); loader.style.display = 'none'; return; }
            if (!attendus) { showInfoModal("Veuillez copier-coller les attendus de la formation."); loader.style.display = 'none'; return; }
            
            const appFeaturesSummary = getAppFeaturesSummary();
            prompt = `Agis comme un conseiller d'orientation expert de Parcoursup, √† la fois bienveillant et strat√©gique. Le dossier de l'√©l√®ve est : "${getProfileSummary()}". Il s'int√©resse √† la formation "${nomFormation}" dont les attendus sont : "${attendus}".

# Ta Mission
R√©dige une analyse de compatibilit√© d√©taill√©e et actionnable, en deux parties distinctes.

# Format de Sortie OBLIGATOIRE
La r√©ponse doit utiliser des titres en gras (**Titre**) mais ne doit contenir AUCUN num√©ro (1., 2.) ni AUCUNE liste √† puces (* ou -). Chaque partie doit √™tre un paragraphe fluide.

**Points forts de ta candidature**
(Analyse ici 2 ou 3 points forts. Pour chaque point, fais un lien direct et explicite entre un √©l√©ment sp√©cifique du profil de l'√©l√®ve et un "attendu" de la formation. Par exemple : "Ta comp√©tence en [analyse] visible dans ton profil correspond directement √† l'attendu '[citation de l'attendu]'...".)

**Pistes d'am√©lioration et de r√©flexion**
(Identifie un point de vigilance ou une comp√©tence qui m√©riterait d'√™tre mieux d√©montr√©e. Donne un conseil concret pour la r√©daction de son projet de formation motiv√© sur Parcoursup. Termine IMP√âRATIVEMENT par une suggestion d'action pr√©cise et pertinente √† r√©aliser dans l'un des outils de l'application OrIAntation pour travailler ce point.)`;
            
const apiResult = await callOpenAI_API({ promptText: prompt, withPersona: true });
            result = apiResult.replace(/(\d\.\s?\*\*|\*\*)/g, '').replace(/[\*-] /g, '');

        } else if (action === 'analyse_mots_cles') {
            const motsCles = div.querySelector('#current-motscles').value.trim();
            if (!motsCles) { showInfoModal("Veuillez renseigner vos 3 mots-cl√©s."); loader.style.display = 'none'; return; }
            
            prompt = `Agis comme un examinateur bienveillant. Un lyc√©en s'int√©resse √† la formation : "${nomFormation}". Il pense que les 3 mots-cl√©s qui la d√©crivent le mieux sont : "${motsCles}". √âvalue sa r√©ponse en te basant sur les "attendus" officiels de cette formation. Dis-lui si ses mots sont pertinents et propose des alternatives plus pr√©cises.`;
            
            result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        }

        loader.style.display = 'none';
        currentExploration.analyses[action] = result;
        resultDiv.innerHTML = linkify(result);
    });
});

    const checkComparisonState = () => {
        const comparisonSection = form.querySelector('#comparison-section');
        const formations = journalData.step3.formations || [];
        if (comparisonSection) {
            comparisonSection.classList.toggle('hidden', formations.length < 2);
        }
    };

    // ‚ñº‚ñº‚ñº AJOUTEZ CE BLOC COMPLET DANS createStep3View ‚ñº‚ñº‚ñº

div.querySelector('#compare-btn').addEventListener('click', async () => {
    const loader = div.querySelector('#loader-comparison');
    const resultDiv = div.querySelector('#comparison-result');
    const formationsAComparer = journalData.step3.formations;
    if (formationsAComparer.length < 2) return;
    
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const prompt = `Agis comme un conseiller d'orientation expert. Compare les formations suivantes pour un lyc√©en : ${JSON.stringify(formationsAComparer.map(f => f.nom))}.
    Cr√©e un tableau comparatif au format Markdown qui analyse les points cl√©s : type de dipl√¥me, dur√©e, attendus principaux, et d√©bouch√©s typiques.
    Termine par une remarque de synth√®se pour aider l'√©l√®ve √† choisir en fonction de son profil : ${getProfileSummary()}.
    Ta r√©ponse doit √™tre un JSON avec les cl√©s "tableau" et "remarques".`;

    const result = await callOpenAI_API({ promptText: prompt, model: 'gpt-4o', isJson: true });
    
    loader.style.display = 'none';
    try {
        const data = extractJsonFromString(result);
        const markdownTableToHtml = (markdown) => {
            if (!markdown) return '<p>Aucun tableau √† afficher.</p>';
            const lines = markdown.trim().split('\n').filter(line => line.trim().startsWith('|'));
            if (lines.length < 2) return '<p>Le format du tableau est invalide.</p>';
            
            let html = '<div class="comparison-table-wrapper"><table class="w-full text-left border-collapse">';
            const headerCells = lines[0].split('|').slice(1, -1).map(cell => `<th class="p-3 border-b-2 font-bold bg-slate-100">${cell.trim()}</th>`).join('');
            html += `<thead><tr>${headerCells}</tr></thead><tbody>`;
            lines.slice(2).forEach(line => {
                const rowCells = line.split('|').slice(1, -1).map(cell => `<td class="p-3 border-b align-top text-sm">${linkify(cell.trim())}</td>`).join('');
                html += `<tr>${rowCells}</tr>`;
            });
            html += `</tbody></table></div>`;
            return html;
        };
        resultDiv.innerHTML = markdownTableToHtml(data.tableau) + `<p class="mt-4 text-sm italic">${data.remarques}</p>`;
        journalData.step3.comparison = JSON.stringify(data);
        await saveData();
    } catch(e) { 
        console.error("Erreur lors de la cr√©ation du tableau de comparaison:", e);
        resultDiv.innerHTML = `<p class="text-red-500">Erreur de formatage de la comparaison. Voici la r√©ponse brute de l'IA :</p><pre class="whitespace-pre-wrap text-xs bg-slate-100 p-2 rounded mt-2">${result}</pre>`;
    }
});
    
    div.querySelector('#saved-formations-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-formation-btn')) {
            const index = e.target.closest('.delete-formation-btn').dataset.index;
            const confirmed = await showConfirmationModal("Es-tu s√ªr de vouloir supprimer cette formation de ton journal ?");
            if (confirmed) {
                journalData.step3.formations.splice(index, 1);
                await saveData();
                renderSavedFormations();
            }
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveData(); // Sauvegarde finale au cas o√π
        showView('menu');
    });

    // --- Logique de recherche de formation ---
    const addSearchFunctionality = () => {
        const formationInput = form.querySelector('#current-formation');
        const searchResultsContainer = form.querySelector('#search-results');
        const resultsWrapper = document.createElement('div');
        resultsWrapper.className = 'absolute z-10 w-full bg-white border border-slate-200 rounded-md mt-1 max-h-48 overflow-y-auto shadow-lg';
        searchResultsContainer.appendChild(resultsWrapper);

        formationInput.addEventListener('input', async () => {
            const searchTerm = formationInput.value.trim().toLowerCase();
            resultsWrapper.innerHTML = '';
            if (searchTerm.length < 4) return;

            try {
                // NOTE: Assumes a Firestore collection named 'parcoursup_formations' exists
                const formationsRef = collection(db, "parcoursup_formations");
                const q = query(formationsRef, where("search_terms", "array-contains", searchTerm), limit(10));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    resultsWrapper.innerHTML = `<div class="p-2 text-slate-500">Aucun r√©sultat.</div>`;
                } else {
                    querySnapshot.forEach((doc) => {
                        const formation = doc.data();
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'result-item p-2 cursor-pointer hover:bg-cyan-100';
                        resultDiv.textContent = formation.formation_name; // Adjust field name as needed
                        resultDiv.addEventListener('click', () => {
                            formationInput.value = formation.formation_name;
                            resultsWrapper.innerHTML = '';
                        });
                        resultsWrapper.appendChild(resultDiv);
                    });
                }
            } catch (error) {
                console.error("Erreur de recherche Firestore : ", error);
            }
        });
        document.addEventListener('click', (e) => {
            if (!searchResultsContainer.contains(e.target)) {
                resultsWrapper.innerHTML = '';
            }
        });
    };
    
    // Initialisation
    renderSavedFormations();
    addSearchFunctionality();
    return div;
}

function createStep12View() {
    const config = stepsConfig.step12;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    form.innerHTML = `
        <div class="mb-8">
            <label for="city-input" class="block text-md font-medium text-slate-700 mb-2">Dans quelle ville imagines-tu tes futures √©tudes ?</label>
            <input type="text" id="city-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Lyon, Rennes, Bordeaux...">
        </div>
        <div class="bg-background-light border border-border-subtle p-3 rounded-lg text-sm text-slate-600 mb-4">
            <p><strong class="font-semibold text-OrIAntation-darkblue">Comment √ßa marche ?</strong> L'application demande √† OrIA d'effectuer une recherche en temps r√©el pour trouver les co√ªts et les aides les plus r√©cents pour la ville choisie, puis met en forme sa r√©ponse.</p>
        </div>
        <div class="text-center mb-6">
            <button type="button" id="budget-btn" class="w-full sm:w-auto bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üìä Estimer le Budget Mensuel √âtudiant</button>
        </div>
        <div id="loader-budget" class="hidden"><div class="loader"></div></div>
        <div id="budget-result" class="mb-10"></div>
        <hr class="my-10">
        <h3 class="text-xl font-bold text-center text-OrIAntation-darkblue mb-4">Recherche des Aides Financi√®res</h3>
        <p class="text-center text-slate-600 mb-6">D√©couvrez les principaux dispositifs pour financer votre vie √©tudiante.</p>
        <div class="text-center mb-6">
            <button type="button" id="aides-btn" class="w-full sm:w-auto bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">üí∞ Chercher les Aides Disponibles</button>
        </div>
        <div id="loader-aides" class="hidden"><div class="loader"></div></div>
        <div id="aides-result" class="mb-10"></div>
    `;
    
    const cityInput = div.querySelector('#city-input');

    div.querySelector('#budget-btn').addEventListener('click', async () => {
    const city = cityInput.value.trim();
    if (!city) {
        showInfoModal("Veuillez renseigner une ville.");
        return;
    }
    const loader = div.querySelector('#loader-budget');
    const resultDiv = div.querySelector('#budget-result');
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const fuelPriceSP95 = 1.70;
    const maintenanceCostPerKm = 0.07;
    const avgConsumptionLPer100Km = 6.5;

    const prompt = `
Agis comme un conseiller financier expert pour √©tudiants. Pour la ville de "${city}", estime le budget mensuel moyen.
Ta r√©ponse doit √™tre **uniquement un objet JSON valide** avec deux cl√©s : "budget" et "commentaires".

1.  **"budget"**: Un objet JSON avec les estimations chiffr√©es pour :
    * "loyer_crous"
    * "loyer_prive_studio"
    * "alimentation_min"
    * "alimentation_max"
    * "transport_collectif" (prix de l'abonnement mensuel jeune/√©tudiant)
    * "loisirs_min"
    * "loisirs_max"

2.  **"commentaires"**: Un tableau d'objets JSON. Tu dois obligatoirement inclure des commentaires pour les cat√©gories "Loyer", "Transport", "Alimentation", et **"Loisirs"**.
    * Chaque objet doit contenir les cl√©s : "categorie", "texte", "source_nom", et "source_url".
    * La valeur de "source_url" doit imp√©rativement √™tre une URL valide commen√ßant par "https://". Si aucun site officiel n'existe, fournis un lien de recherche Google pertinent.
    * **Pour la cat√©gorie "Transport" :** Dans la cl√© "texte", explique la diff√©rence de co√ªt entre l'abonnement en commun et un v√©hicule personnel. Mentionne que le calcul pour un v√©hicule personnel dans notre simulateur est une estimation bas√©e sur les moyennes suivantes : un prix du carburant de ${fuelPriceSP95}‚Ç¨/L, une consommation de ${avgConsumptionLPer100Km}L/100km, et un co√ªt de maintenance (assurance, usure) de ${maintenanceCostPerKm}‚Ç¨ par kilom√®tre.
    * **Pour la cat√©gorie "Loisirs" :** Dans la cl√© "texte", donne des conseils et des exemples sur la mani√®re de g√©rer son budget loisirs (sorties, sport, culture) en tant qu'√©tudiant, en mentionnant les bons plans, les passes culturels (si existants dans la ville de "${city}") et les tarifs r√©duits.

Exemple de source_url attendue pour Lorient :
- Transport : "https://www.izilo.bzh"
- Loisirs √† Lorient : "https://www.google.com/search?q=bons+plans+√©tudiants+Lorient"
`;

const result = await callOpenAI_API({
        promptText: prompt,
        model: 'gpt-4o', // Plus rapide et √©conomique pour cette t√¢che
        isJson: true, // S'assure que la contrainte JSON est bien ajout√©e    
        });

        loader.style.display = 'none';

    try {
        const data = extractJsonFromString(result);
        if (!data || !data.budget) {
            throw new Error("R√©ponse JSON invalide ou budget manquant.");
        }
        
        const budget = data.budget;
        const transportPublicCost = parseInt(budget.transport_collectif) || 0;
        const loyer_avg = Math.round(((parseInt(budget.loyer_crous) || 150) + (parseInt(budget.loyer_prive_studio) || 450)) / 2);
        const alim_avg = Math.round(((parseInt(budget.alimentation_min) || 150) + (parseInt(budget.alimentation_max) || 300)) / 2);
        const loisirs_avg = Math.round(((parseInt(budget.loisirs_min) || 30) + (parseInt(budget.loisirs_max) || 100)) / 2);

        let commentsHTML = '';
        if (data.commentaires && data.commentaires.length > 0) {
            commentsHTML += '<div class="border-t pt-6 mt-6"><h4 class="text-lg font-bold text-azimut-darkblue mb-3">üí° D√©tails et Sources :</h4><div class="space-y-3">';
            data.commentaires.forEach(comment => {
                const linkedText = linkify(comment.texte);
                commentsHTML += `
                    <div class="text-sm p-3 bg-background-light rounded-lg border border-border-subtle">
                        <p class="font-semibold text-slate-700">${comment.categorie}</p>
                        <div class="text-slate-600">${linkedText}</div>
                        ${comment.source_url ? `<a href="${comment.source_url}" target="_blank" class="text-primary-action hover:underline font-medium">Source : ${comment.source_nom} ‚Üó</a>` : ''}
                    </div>
                `;
            });
            commentsHTML += '</div></div>';
        }

        // √âTAPE 1 : On cr√©e et affiche le HTML
        resultDiv.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <h3 class="text-xl font-bold text-azimut-darkblue mb-2">Construis ton Budget Personnalis√© √† ${city}</h3>
                <p class="text-sm text-slate-500 mb-6">Ajuste les curseurs pour voir comment ton budget total √©volue.</p>
                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between items-center"><label for="loyer-slider" class="font-semibold text-slate-700 text-md">üè† Loyer</label><span id="loyer-value" class="font-bold text-primary-action text-lg">${loyer_avg}‚Ç¨</span></div>
                        <input id="loyer-slider" type="range" min="${budget.loyer_crous || 150}" max="${budget.loyer_prive_studio || 450}" value="${loyer_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <div class="flex justify-between items-center"><label for="alim-slider" class="font-semibold text-slate-700 text-md">üõí Alimentation & Vie courante</label><span id="alim-value" class="font-bold text-primary-action text-lg">${alim_avg}‚Ç¨</span></div>
                        <input id="alim-slider" type="range" min="${budget.alimentation_min || 150}" max="${budget.alimentation_max || 300}" value="${alim_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <div class="flex justify-between items-center"><label for="loisirs-slider" class="font-semibold text-slate-700 text-md">üéâ Loisirs & Sorties</label><span id="loisirs-value" class="font-bold text-primary-action text-lg">${loisirs_avg}‚Ç¨</span></div>
                        <input id="loisirs-slider" type="range" min="${budget.loisirs_min || 30}" max="${budget.loisirs_max || 100}" value="${loisirs_avg}" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t">
                    <h4 class="font-semibold text-slate-700 text-md mb-3">üöå Budget Transport Mensuel</h4>
                    <p class="text-xs text-slate-500 mb-4">Ajuste la distance de tes trajets quotidiens (aller-retour) pour estimer le co√ªt avec un v√©hicule personnel.</p>
                    <div>
                        <div class="flex justify-between items-center"><label for="km-slider" class="font-semibold text-slate-700 text-sm">Distance quotidienne (A/R)</label><span id="km-value" class="font-bold text-primary-action text-lg">20 km</span></div>
                        <input id="km-slider" type="range" min="0" max="100" value="20" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="mt-4 p-3 bg-background-light rounded-lg border space-y-2">
                        <div class="flex justify-between items-center text-sm"><span>Transport en commun (abonnement) :</span><strong id="transport-public-value" class="text-primary-action">${transportPublicCost}‚Ç¨</strong></div>
                        <div class="flex justify-between items-center text-sm"><span>V√©hicule personnel (estim.) :</span><strong id="transport-private-value" class="text-primary-action">--‚Ç¨</strong></div>
                    </div>
                </div>
                <div class="mt-8 pt-4 border-t-4 border-cyan-500 text-center">
                    <p class="text-slate-600">Ton budget mensuel total estim√©</p>
                    <p id="total-budget" class="text-4xl font-bold text-cyan-700 mt-1"></p>
                </div>
                ${commentsHTML}
            </div>
        `;
        
        // √âTAPE 2 : SEULEMENT MAINTENANT, on s√©lectionne les √©l√©ments et on ajoute les √©couteurs
        const loyerSlider = div.querySelector('#loyer-slider');
        const alimSlider = div.querySelector('#alim-slider');
        const loisirsSlider = div.querySelector('#loisirs-slider');
        const kmSlider = div.querySelector('#km-slider');
        
        const loyerValue = div.querySelector('#loyer-value');
        const alimValue = div.querySelector('#alim-value');
        const loisirsValue = div.querySelector('#loisirs-value');
        const kmValue = div.querySelector('#km-value');
        const transportPrivateValue = div.querySelector('#transport-private-value');
        const totalBudget = div.querySelector('#total-budget');

        const updateBudgetTotal = () => {
            const loyer = parseInt(loyerSlider.value);
            const alim = parseInt(alimSlider.value);
            const loisirs = parseInt(loisirsSlider.value);
            const dailyKm = parseInt(kmSlider.value);

            const monthlyKm = dailyKm * 22;
            const fuelCost = (monthlyKm / 100) * avgConsumptionLPer100Km * fuelPriceSP95;
            const maintenanceCost = monthlyKm * maintenanceCostPerKm;
            const transportPrivateCost = Math.round(fuelCost + maintenanceCost);
            
            const transportFinalCost = Math.min(transportPublicCost, transportPrivateCost);
            
            loyerValue.textContent = `${loyer}‚Ç¨`;
            alimValue.textContent = `${alim}‚Ç¨`;
            loisirsValue.textContent = `${loisirs}‚Ç¨`;
            kmValue.textContent = `${dailyKm} km`;
            transportPrivateValue.textContent = `${transportPrivateCost}‚Ç¨`;
            
            totalBudget.textContent = `${loyer + alim + loisirs + transportFinalCost}‚Ç¨`;
        };

        [loyerSlider, alimSlider, loisirsSlider, kmSlider].forEach(slider => {
            if (slider) { // S√©curit√© suppl√©mentaire
                slider.addEventListener('input', updateBudgetTotal);
            }
        });
        updateBudgetTotal();

    } catch (e) {
        console.error("Erreur lors du traitement du budget:", e);
        resultDiv.innerHTML = `<p class="text-red-500 text-center">OrIA n'a pas pu g√©n√©rer une estimation structur√©e. Veuillez r√©essayer.</p><textarea class="w-full h-40 bg-slate-100 p-2 rounded mt-2" readonly>${result}</textarea>`;
    }
});

    div.querySelector('#aides-btn').addEventListener('click', async () => {
    const city = cityInput.value.trim();
    if (!city) {
        showInfoModal("Veuillez d'abord renseigner une ville.");
        return;
    }
    const loader = div.querySelector('#loader-aides');
    const resultDiv = div.querySelector('#aides-result');
    loader.style.display = 'block';
    resultDiv.innerHTML = '';



        const prompt = `
Agis comme un conseiller expert et un chercheur web m√©ticuleux, sp√©cialis√© dans les aides financi√®res pour les √©tudiants et les jeunes en France.

# Mission Principale :
Fournir une liste DIVERSIFI√âE et D√âTAILL√âE d'aides financi√®res pour un √©tudiant habitant dans la ville de "${city}".

# Instructions Strictes et S√©quentielles :

**√âTAPE 1 : Utilisation des Donn√©es Nationales Fiables (Ne pas chercher, utiliser directement)**
Pour les aides nationales les plus importantes, tu DOIS utiliser les informations exactes ci-dessous.

* **Bourse sur Crit√®res Sociaux (BCS) :**
    * **description**: "C'est l'aide principale vers√©e par le CROUS aux √©tudiants dont les familles ont des revenus modestes. Son montant varie selon les revenus des parents, la composition de la famille et l'√©loignement du lieu d'√©tudes. La demande se fait obligatoirement en constituant un Dossier Social √âtudiant (DSE), g√©n√©ralement entre mars et mai pour la rentr√©e universitaire suivante."
    * **lien**: "https://www.messervices.etudiant.gouv.fr/envole/"
* **Aide au logement (APL/ALS) :**
    * **description**: "Vers√©e par la Caisse d'Allocations Familiales (CAF), cette aide permet de r√©duire le montant du loyer. Elle est accessible √† la plupart des √©tudiants, qu'ils soient boursiers ou non. La demande se fait en ligne sur le site de la CAF une fois le bail de location sign√©."
    * **lien**: "https://www.caf.fr/allocataires/aides-et-demarches/droits-et-prestations/logement/les-aides-personnelles-au-logement"

**√âTAPE 2 : Recherche Compl√©mentaire d'Aides (Locales et Th√©matiques)**
Maintenant, effectue une recherche web pour trouver **2 √† 3 AUTRES aides pertinentes**, en te concentrant sur les cat√©gories suivantes pour la ville de "${city}" :
- **Transport** (abonnements r√©duits, aides r√©gionales...)
- **Loisirs & Culture** (Pass Culture, offres locales...)
- **Vie Quotidienne & Sant√©** (aides alimentaires, aide √† l'achat d'√©quipement...)

**R√®gle :** Ne repropose PAS la BCS ou l'APL. Trouve des aides diff√©rentes et si possible sp√©cifiques √† "${city}" ou sa r√©gion.

**√âTAPE 3 : Format de Sortie**
Ta r√©ponse finale doit √™tre UNIQUEMENT un objet JSON strictement valide. 
AUCUN texte ou commentaire en dehors du JSON.

Structure obligatoire :
{
  "aides": [
    {
      "nom": "Nom complet et officiel de l'aide",
      "description": "Description d√©taill√©e et pr√©cise en 3-4 phrases",
      "lien": "URL directe et officielle"
    }
  ]
}

‚ö†Ô∏è Rappels :
- Inclure les 2 aides nationales (BCS et APL) + 2 √† 3 aides trouv√©es √† l'√©tape 2.
- Respecter exactement la structure JSON donn√©e ci-dessus.
- Ne rien ajouter d'autre que l'objet JSON.
`;


const result = await callOpenAI_API({
        promptText: prompt,
        model: 'gpt-4o', // Plus rapide et √©conomique pour cette t√¢che
        isJson: true, // S'assure que la contrainte JSON est bien ajout√©e    
        });
                loader.style.display = 'none';

        try {
        // ‚úÖ LA CORRECTION EST ICI :
        // On utilise notre fonction intelligente au lieu de JSON.parse directement.
        const data = extractJsonFromString(result);

        if (data && data.aides && data.aides.length > 0) {
            let htmlResult = '<div class="space-y-4">';
            data.aides.forEach(aide => {
                htmlResult += `
                    <div class="bg-white p-4 rounded-lg shadow border border-border-subtle">
                        <h4 class="font-bold text-cyan-700">${aide.nom}</h4>
                        <p class="text-slate-600 text-sm my-2">${aide.description}</p>
                        <a href="${aide.lien}" target="_blank" class="text-primary-action font-semibold hover:underline text-sm">En savoir plus ‚Üó</a>
                    </div>
                `;
            });
            htmlResult += '</div>';
            resultDiv.innerHTML = htmlResult;
        } else {
            // Si data est null ou ne contient pas d'aides
            throw new Error("La structure des aides est invalide ou manquante.");
        }
    } catch (e) {
        resultDiv.innerHTML = `<p class="text-red-500 text-center">OrIA n'a pas pu formater les aides correctement. Voici sa r√©ponse brute :</p><pre class="whitespace-pre-wrap text-xs bg-slate-100 p-2 rounded mt-2">${result}</pre>`;
    }
});

    return div;
}


function createGuideView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // --- 1. D√©finition de tous les blocs de contenu ---

    const introHTML = `
    <div class="guide-container">
        <img src="logo.png" alt="Logo OrIAntation" class="logo" style="width: 200px; margin-bottom: 20px;">
        <h2>OrIA comme Boussole 2.0 !</h2>
        <p>Quand les autres outils d'orientation se contentent souvent d'√™tre de simples catalogues (de longues listes de m√©tiers et de formations), OrIA fait la diff√©rence. Plus qu'une base de donn√©es, c'est une v√©ritable exp√©rience qui est offerte : une <strong>boussole 2.0, boost√©e √† l'IA</strong>, con√ßue pour donner un avantage strat√©gique √† celui qui l'utilise.</p>
        <div class="info-box conseil-prof" style="font-style: normal;">
            <h4 style="font-weight: bold; color: #3730A3; display:block;">Le r√¥le d'OrIA</h4>
            <p style="margin-top: 10px; font-style: normal;">Dans un syst√®me complexe, l'information brute ne suffit pas. OrIA n'est pas l√† pour donner les m√™mes r√©ponses √† tout le monde. Son travail est de <strong>scanner le terrain, d'analyser les profils uniques et de d√©tecter les "chemins de traverse"</strong> : ces parcours malins et ces opportunit√©s cach√©es que la plupart des gens ne voient pas.</p>
            <p style="margin-top: 15px; font-style: normal;"><strong>L'utilisateur reste le Strat√®ge</strong> quand OrIA est un copilote surpuissant qui sait fournir des donn√©es et des options non-conventionnelles. La mission : ne jamais se contenter d'un chemin, mais tracer les siens !</p>
        </div>
    </div>
    `;

    const installationHTML = `
        <div class="guide-container">
            <h2>Installer l'application sur votre t√©l√©phone</h2>
            <p>Pour un acc√®s plus rapide, vous pouvez ajouter "OrIAntation" √† l'√©cran d'accueil de votre t√©l√©phone. L'application se comportera comme une v√©ritable application native.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                <div class="bg-background-light p-4 rounded-lg border">
                    <h4 class="text-OrIAntation-darkblue">üì± Sur iPhone (iOS)</h4>
                    <ol class="list-decimal list-inside text-sm text-slate-700 mt-2 space-y-2">
                        <li>Ouvrez l'application dans le navigateur <strong>Safari</strong>.</li>
                        <li>Appuyez sur l'ic√¥ne de partage (un carr√© avec une fl√®che vers le haut).</li>
                        <li>Faites d√©filer vers le bas et s√©lectionnez <strong>"Sur l'√©cran d'accueil"</strong>.</li>
                        <li>Confirmez en appuyant sur "Ajouter".</li>
                    </ol>
                </div>
                <div class="bg-background-light p-4 rounded-lg border">
                    <h4 class="text-OrIAntation-darkblue">üì± Sur Android</h4>
                    <ol class="list-decimal list-inside text-sm text-slate-700 mt-2 space-y-2">
                        <li>Ouvrez l'application dans le navigateur <strong>Chrome</strong>.</li>
                        <li>Appuyez sur le menu (les trois points verticaux en haut √† droite).</li>
                        <li>S√©lectionnez <strong>"Installer l'application"</strong> ou "Ajouter √† l'√©cran d'accueil".</li>
                        <li>Suivez les instructions pour confirmer.</li>
                    </ol>
                </div>
            </div>
        </div>
    `;

    const partie1ElevesHTML = `
        <div class="guide-container">
            <h2>Partie 1 : Pour les √âl√®ves - Ton QG d'Orientation</h2>
            <p>L'orientation peut ressembler √† un oc√©an de donn√©es : des centaines de m√©tiers, des milliers de formations. Il est facile de s'y perdre. OrIAntation est ton <strong>tableau de bord personnel</strong>. Il ne te donne pas plus d'informations, il t'aide √† trouver <strong>la bonne information pour toi</strong>.</p>
            <div class="info-box conseil-prof" style="font-style: normal;">
                <h4 style="font-weight: bold; color: #3730A3; display:block;">Ta m√©thode en 4 √âtapes :</h4>
                <ul>
                    <li><strong>Collecter tes donn√©es :</strong> Identifier avec pr√©cision tes forces, tes talents et tes motivations profondes.</li>
                    <li><strong>Analyser les possibilit√©s :</strong> Explorer les m√©tiers et les formations comme un analyste, en te basant sur des informations fiables.</li>
                    <li><strong>Centraliser ta r√©flexion :</strong> Transformer le Journal de Bord en une base de connaissances claire sur ton projet.</li>
                    <li><strong>Prendre des d√©cisions √©clair√©es :</strong> Utiliser tes analyses pour pr√©parer tes candidatures et planifier ton avenir.</li>
                </ul>
            </div>
        </div>
    `;

    const partie2ParentsHTML = `
        <div class="guide-container">
            <h2>Partie 1 : Pour les Parents - Devenir le "Sparring Partner"</h2>
            <p>Le r√¥le d'un parent n'est pas de donner les r√©ponses, mais d'aider √† poser les bonnes questions. OrIAntation est con√ßu comme un support pour vous aider √† accompagner votre enfant dans sa propre analyse, en facilitant un dialogue constructif bas√© sur les donn√©es qu'il collecte.</p>
            <div class="info-box info-box-parents">
                <h4>Comment l'accompagner dans sa strat√©gie ?</h4>
                <ul>
                    <li><strong>Adoptez une posture de "Consultant" :</strong> L'application est son espace d'analyse. Votre r√¥le est de l'aider √† interpr√©ter ses propres donn√©es, pas de les valider. Discutez de ses d√©couvertes et des points qui le surprennent.</li>
                    <li><strong>Utilisez le "Journal de Bord" partag√© :</strong> Quand il partage son journal, c'est une invitation √† analyser sa d√©marche. Le bouton "Pr√©parer une discussion" vous donnera des angles d'approche bas√©s sur ses propres √©crits.</li>
                    <li><strong>Conseil cl√© :</strong> Valorisez la m√©thode plus que la destination. L'objectif est qu'il apprenne √† analyser un probl√®me complexe (son orientation) pour prendre une d√©cision √©clair√©e, une comp√©tence essentielle pour son avenir.</li>
                </ul>
            </div>
        </div>
    `;

    const partie3EnseignantsHTML = `
        <div class="guide-container">
            <h2>Partie 1 : Pour les Enseignants - Un Outil au Service du Parcours Avenir</h2>
            <p>Au-del√† d'un simple outil d'exploration, OrIAntation est une plateforme p√©dagogique qui permet de suivre la progression des √©l√®ves et de structurer des s√©ances d√©di√©es au <strong>Parcours Avenir</strong>.</p>
            <div class="info-box info-box-teachers">
                <h4>Pistes d'utilisation p√©dagogique</h4>
                <ul>
                    <li><strong>Suivi individualis√© bas√© sur la donn√©e :</strong> Votre Tableau de Bord vous donne une vue d'ensemble de la progression de la classe, identifie les √©l√®ves "√† risque" (inactifs) et vous permet de consulter leur Journal de Bord pour pr√©parer des entretiens de suivi bas√©s sur des donn√©es concr√®tes.</li>
                    <li><strong>Ateliers de "Data Literacy" :</strong> Les √©tapes d'OrIAntation peuvent servir de support pour des s√©ances o√π les √©l√®ves apprennent √† collecter de l'information (sur eux-m√™mes et les formations), √† l'analyser et √† la synth√©tiser pour en tirer des conclusions.</li>
                    <li><strong>D√©velopper la pens√©e critique :</strong> La confrontation entre le profil de l'√©l√®ve et les "attendus" des formations est un excellent exercice pour d√©velopper une argumentation structur√©e, essentielle pour le Grand Oral.</li>
                </ul>
            </div>
        </div>
    `;
    
    const dashboardEnseignantsHTML = `
        <div class="guide-container">
            <h2>Partie 2 : Ma√Ætriser le Tableau de Bord Enseignant</h2>
            <p>Votre tableau de bord est con√ßu pour vous donner une vision claire et rapide de l'activit√© de votre classe et vous permettre d'agir efficacement.</p>
            <div class="etape">
                <h4>Le Code d'Invitation</h4>
                <p>Ce code est unique √† votre classe. Partagez-le avec vos √©l√®ves lors de leur inscription pour qu'ils soient automatiquement rattach√©s √† votre tableau de bord.</p>
            </div>
            <div class="etape">
                <h4>Les Indicateurs Cl√©s</h4>
                <p>En haut de la page, trois statistiques vous donnent un aper√ßu instantan√© : le <strong>nombre d'√©l√®ves</strong>, la <strong>progression moyenne</strong> de la classe, et le nombre d'<strong>√©l√®ves "√† suivre"</strong> (ceux dont l'activit√© est faible ou qui semblent bloqu√©s).</p>
            </div>
            <div class="etape">
                <h4>La Liste des √âl√®ves</h4>
                <p>Ce tableau vous permet de suivre chaque √©l√®ve individuellement. Vous pouvez le trier par nom, progression ou derni√®re activit√© pour identifier rapidement les besoins. En cliquant sur <strong>"Voir le journal"</strong>, vous acc√©dez √† une vue d√©taill√©e de la r√©flexion de l'√©l√®ve, parfaite pour pr√©parer un entretien.</p>
            </div>
            <div class="etape">
                <h4>Les Statistiques D√©taill√©es de la Classe</h4>
                <p>En cliquant sur ce bouton, vous ouvrez un panel d'analyse puissant avec quatre graphiques :</p>
                <ul>
                    <li><strong>R√©partition de la Progression :</strong> Pour voir si votre classe est plut√¥t en phase de "D√©but", d'"Exploration" ou "Avanc√©e".</li>
                    <li><strong>Secteurs Populaires :</strong> Identifie les grands domaines (Sant√©, Informatique, Art...) qui attirent le plus vos √©l√®ves.</li>
                    <li><strong>M√©tiers les Plus Explor√©s :</strong> Le top 5 des m√©tiers sp√©cifiques que vos √©l√®ves ont sauvegard√©s.</li>
                    <li><strong>Niveaux de Formation Vis√©s :</strong> Pour savoir si vos √©l√®ves s'orientent plut√¥t vers des √©tudes courtes, l'universit√© ou les grandes √©coles.</li>
                </ul>
            </div>
        </div>
    `;

const seancesEnseignantsHTML = `
        <h2>Partie 3 : 10 Id√©es de S√©ances Cl√©s en Main (1h)</h2>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> S√©ance 1 : Scanner son Profil - Devenir l'Expert de soi-m√™me</h4><p><strong>Classe Cible :</strong> Seconde (d√©but d'ann√©e), Premi√®re.<br><strong>Objectif P√©dagogique :</strong> Amener l'√©l√®ve √† identifier ses propres "donn√©es" (forces, motivations) et √† acqu√©rir un vocabulaire pr√©cis pour se d√©crire.<br><strong>√âtape Utilis√©e :</strong> Mieux se conna√Ætre.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction : "Votre orientation est un probl√®me √† r√©soudre. La premi√®re √©tape est de collecter les bonnes donn√©es sur vous-m√™me." (10min). 2. Les √©l√®ves compl√®tent le questionnaire pour g√©n√©rer leur profil de base (25min). 3. Discussion collective sur la signification des <strong>Arch√©types</strong> et du <strong>graphique RIASEC</strong> comme outils d'analyse (15min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> S√©ance 2 : Le Simulateur Strat√©gique de Sp√©cialit√©s</h4><p><strong>Classe Cible :</strong> Seconde (2√®me trimestre).<br><strong>Objectif P√©dagogique :</strong> Utiliser la simulation pour prendre des d√©cisions √©clair√©es sur les sp√©cialit√©s.<br><strong>√âtape Utilis√©e :</strong> Le simulateur de sp√©cialit√©s.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Rappel des enjeux (5min). 2. En bin√¥mes, les √©l√®ves testent 2 combinaisons, utilisent OrIA pour obtenir un <strong>t√©moignage d'√©tudiant</strong> et analysent le lien avec leur profil (30min). 3. Mise en commun : chaque bin√¥me partage la combinaison la plus "inattendue" qu'il a trouv√©e (15min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> S√©ance 3 : Le Portfolio - Transformer l'Exp√©rience en Comp√©tence</h4><p><strong>Classe Cible :</strong> Premi√®re (fin d'ann√©e), Terminale.<br><strong>Objectif P√©dagogique :</strong> Apprendre √† l'√©l√®ve √† "extraire" et formuler des comp√©tences √† partir de son v√©cu (m√©thode STAR).<br><strong>√âtape Utilis√©e :</strong> Mon Portfolio de Comp√©tences.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction : "Vos exp√©riences sont des mines de comp√©tences. Apprenons √† les extraire." (10min). 2. Chaque √©l√®ve choisit une exp√©rience (stage, passion, projet...) et utilise l'<strong>Assistant de Portfolio</strong> pour la transformer en texte valoris√© (30min). 3. Partage volontaire de 2-3 exemples pour montrer la transformation (10min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> S√©ance 4 : D√©bunker l'Orientation - Chasse aux Mythes</h4><p><strong>Classe Cible :</strong> Tous niveaux.<br><strong>Objectif P√©dagogique :</strong> D√©velopper l'esprit critique et la litt√©ratie informationnelle en d√©construisant les id√©es re√ßues.<br><strong>√âtape Utilis√©e :</strong> Fact Checking.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Constitution d'√©quipes (5min). 2. Lancement d'un d√©fi : chaque √©quipe choisit un domaine et doit obtenir le meilleur score au quiz "Chasse aux Mythes" (30min). 3. Chaque √©quipe pr√©sente √† la classe le mythe le plus surprenant qu'elle a d√©construit (15min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> S√©ance 5 : Ancrer son Projet dans la R√©alit√©</h4><p><strong>Classe Cible :</strong> Premi√®re (fin d'ann√©e), Terminale.<br><strong>Objectif P√©dagogique :</strong> Int√©grer les contraintes mat√©rielles (budget, logement) comme une donn√©e cl√© du projet.<br><strong>√âtape Utilis√©e :</strong> Simulateur Vie √âtudiante.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction : "Un projet viable est un projet financ√©." (5min). 2. Les √©l√®ves utilisent le <strong>simulateur de budget</strong> pour une ville qui les int√©resse et explorent les <strong>aides financi√®res</strong> (30min). 3. Discussion collective sur les √©carts de co√ªt de la vie et les aides m√©connues (15min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> S√©ance 6 : Se Pr√©parer au Contact - L'Enqu√™te M√©tier</h4><p><strong>Classe Cible :</strong> Premi√®re, Terminale.<br><strong>Objectif P√©dagogique :</strong> D√©velopper l'aisance orale et la capacit√© √† mener une discussion structur√©e.<br><strong>√âtape Utilis√©e :</strong> L'Exp√©rience.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Introduction sur la valeur d'un retour "terrain" (10min). 2. OrIA g√©n√®re des questions personnalis√©es pour chaque √©l√®ve, puis ils s'entra√Ænent avec le <strong>simulateur d'entretien</strong> (30min). 3. D√©briefing sur les difficult√©s et les bonnes pratiques (10min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> S√©ance 7 : Atelier d'√âcriture - Le Projet de Formation Motiv√©</h4><p><strong>Classe Cible :</strong> Terminale.<br><strong>Objectif P√©dagogique :</strong> Apprendre √† argumenter et √† structurer un √©crit de candidature.<br><strong>√âtape Utilis√©e :</strong> Pr√©parer sa candidature.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Analyse collective d'un PFM anonymis√© (10min). 2. Les √©l√®ves utilisent l'<strong>Atelier d'√©criture</strong> : ils g√©n√®rent une structure, r√©digent un paragraphe, puis utilisent OrIA pour obtenir des pistes d'am√©lioration (35min). 3. Partage d'un "avant/apr√®s" pour illustrer la valeur ajout√©e (5min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m15.75 15.75-2.489-2.489m0 0a3.375 3.375 0 1 0-4.773-4.773 3.375 3.375 0 0 0 4.774 4.774ZM21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> S√©ance 8 : D√©bloquer sa R√©flexion - Le Radar</h4><p><strong>Classe Cible :</strong> Tous niveaux (particuli√®rement les √©l√®ves "perdus" ou "bloqu√©s").<br><strong>Objectif P√©dagogique :</strong> Utiliser la cr√©ativit√© de OrIA pour ouvrir de nouvelles pistes et relancer une dynamique de recherche.<br><strong>√âtape Utilis√©e :</strong> Le Radar √† Opportunit√©s.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Discussion sur le droit d'√™tre ind√©cis (5min). 2. Chaque √©l√®ve utilise le bouton "Me surprendre !" et note la suggestion de OrIA (20min). 3. En petits groupes, ils discutent de la pertinence (ou non) de la suggestion et de ce qu'elle r√©v√®le sur leur profil (25min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> S√©ance 9 : Planifier son Ann√©e - Le R√©troplanning</h4><p><strong>Classe Cible :</strong> Tous niveaux (en d√©but d'ann√©e).<br><strong>Objectif P√©dagogique :</strong> Visualiser l'ann√©e √† venir, d√©dramatiser les √©ch√©ances et d√©velopper des comp√©tences de planification.<br><strong>√âtape Utilis√©e :</strong> Mon R√©troplanning.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Pr√©sentation des grandes √©ch√©ances de l'ann√©e (10min). 2. Les √©l√®ves g√©n√®rent leur <strong>r√©troplanning personnalis√©</strong> et cochent les t√¢ches d√©j√† entam√©es (25min). 3. Discussion sur la t√¢che du mois qui leur semble la plus importante (15min).</div></div>
        <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> S√©ance 10 : Strat√©gie "Plan B" - G√©rer l'Incertitude</h4><p><strong>Classe Cible :</strong> Terminale.<br><strong>Objectif P√©dagogique :</strong> D√©velopper la r√©silience et la capacit√© √† envisager des alternatives de mani√®re constructive.<br><strong>√âtape Utilis√©e :</strong> Anticiper la suite.</p><div class="conseil-prof"><strong>D√©roulement :</strong> 1. Discussion sur la gestion du stress et des r√©ponses de Parcoursup (10min). 2. Les √©l√®ves utilisent la <strong>simulation de conversation "Plan B"</strong> pour r√©fl√©chir √† des alternatives √† leur v≈ìu n¬∞1 (35min). 3. R√©flexion individuelle sur les pistes qui ont √©merg√© (5min).</div></div>
    `;
    
const partie4FonctionnalitesHTML_eleves = `
    <h2>Partie 2 : Exploration D√©taill√©e des Fonctionnalit√©s</h2>
    <p class="text-slate-600 mb-6 text-center">Ton menu est organis√© en deux grandes sections pour t'aider √† naviguer plus facilement : ton Tableau de Bord personnel et ton Parcours d'Orientation √©tape par √©tape.</p>
    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">üöÄ Le Tableau de Bord</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont tes outils centraux, ceux que tu utiliseras tout au long de ton parcours pour suivre tes progr√®s, synth√©tiser tes id√©es et planifier tes actions.</p>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg> Mon Journal de Bord</h4><p><strong>Objectif :</strong> Centraliser et synth√©tiser toutes tes r√©flexions au m√™me endroit.</p><p><strong>Fonctionnement :</strong> Retrouve les synth√®ses de ton travail (organis√©es en sections d√©pliables), ta <strong>Carte d'Orientation</strong> et ton profil visuel. OrIA peut g√©n√©rer un <strong>"Fil Rouge"</strong> pour r√©sumer ton projet. Une fonction de partage est disponible pour √©changer avec tes proches.</p><div class="conseil-prof"><strong>Conseil :</strong> Ce journal est la base de discussion la plus concr√®te et la plus riche que tu puisses avoir avec tes parents ou ton professeur principal.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg> Mon R√©troplanning</h4><p><strong>Objectif :</strong> Planifier son ann√©e sans stress en visualisant les grandes √©ch√©ances.</p><p><strong>Fonctionnement :</strong> OrIA g√©n√®re un calendrier d'actions mois par mois adapt√© √† ta classe et te fournit des <strong>conseils personnalis√©s</strong>. Tu peux cocher les t√¢ches accomplies et ajouter tes propres √©v√©nements.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est l'outil parfait pour ne jamais √™tre pris de court. Une ann√©e bien planifi√©e est une ann√©e plus sereine.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Mieux se conna√Ætre</h4><p><strong>Objectif :</strong> Dresser un portrait pr√©cis de ta personnalit√©, de tes int√©r√™ts et de ce qui te motive.</p><p><strong>Fonctionnement :</strong> Apr√®s avoir d√©crit ta situation, tu r√©ponds √† un questionnaire. OrIA analyse tes r√©ponses pour r√©v√©ler ton <strong>Arch√©type de personnalit√©</strong>, g√©n√®re une analyse d√©taill√©e et cr√©e une <strong>synth√®se visuelle (graphique RIASEC)</strong>. Tu peux aussi croiser ces r√©sultats avec ceux de tests externes.</p><div class="conseil-prof"><strong>Conseil :</strong> R√©ponds honn√™tement ! Il n'y a pas de bonnes ou de mauvaises r√©ponses. Le but est de cr√©er une base solide pour la suite.</div></div>
    <hr style="margin: 60px 0;">
    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">üß≠ Le Parcours d'Orientation</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les √©tapes guid√©es pour construire ton projet. Elles sont organis√©es en trois grandes phases logiques.</p>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">1. Explorer les Possibilit√©s</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Le simulateur de sp√©cialit√©s</h4><p><strong>Objectif :</strong> Faire le lien entre tes mati√®res et les fili√®res d'√©tudes sup√©rieures.</p><p><strong>Fonctionnement :</strong> Utilise l'<strong>atelier d'exploration</strong> pour tester une combinaison de sp√©cialit√©s. OrIA peut l'analyser par rapport √† ton profil et te donner un t√©moignage d'√©tudiant. Enregistre tes explorations pour les retrouver dans ton journal. D√®s que tu en auras sauvegard√© au moins deux, un <strong>comparateur</strong> appara√Ætra !</p><div class="conseil-prof"><strong>Conseil :</strong> C'est l'outil essentiel pour faire tes choix en fin de Seconde et de Premi√®re de mani√®re √©clair√©e.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg> Les Fondations</h4><p><strong>Objectif :</strong> D√©couvrir des m√©tiers sur la base d'informations fiables et officielles.</p><p><strong>Fonctionnement :</strong> Dans l'<strong>atelier d'exploration</strong>, recherche un m√©tier qui t'int√©resse. Pour chaque piste, OrIA peut analyser les <strong>d√©bouch√©s</strong>, simuler une <strong>"journ√©e type"</strong> ou trouver des <strong>t√©moignages</strong>. Enregistre tes m√©tiers favoris et, d√®s que tu en as au moins deux, utilise le <strong>comparateur de m√©tiers</strong>.</p><div class="conseil-prof"><strong>Conseil :</strong> L'Onisep est la source la plus neutre et la plus compl√®te. C'est le point de d√©part incontournable.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg> Le Catalogue</h4><p><strong>Objectif :</strong> Apprendre √† utiliser le moteur de recherche des formations post-bac comme un expert.</p><p><strong>Fonctionnement :</strong> L'<strong>atelier d'exploration</strong> te permet d'analyser une formation √† la fois. Copie-colle ses "attendus", d√©finis tes mots-cl√©s, et OrIA g√©n√®re un <strong>rapport de compatibilit√©</strong> avec ton profil. Enregistre tes formations et, d√®s que tu en as au moins deux, un <strong>comparateur de formations</strong> appara√Æt.</p><div class="conseil-prof"><strong>Conseil :</strong> Utilise Parcoursup d√®s la Seconde pour explorer, sans la pression des v≈ìux. C'est le meilleur catalogue de formations qui existe.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg> L'Actu</h4><p><strong>Objectif :</strong> Rester inform√©(e) sur le monde des √©tudes et des m√©tiers en consultant des articles ou des classements.</p><p><strong>Fonctionnement :</strong> L'<strong>atelier</strong> te permet de sauvegarder chaque information que tu trouves. Pour chaque trouvaille, OrIA peut l'analyser pour te dire en quoi elle est pertinente par rapport √† ton propre profil.</p><div class="conseil-prof"><strong>Conseil :</strong> Croiser les sources d'information est essentiel. L'analyse de OrIA t'aidera √† prendre du recul sur ce que tu lis.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Fact Checking</h4><p><strong>Objectif :</strong> Tester tes connaissances et d√©construire les id√©es re√ßues sur certains m√©tiers ou fili√®res.</p><p><strong>Fonctionnement :</strong> L'outil te propose trois ateliers : le "Vrai ou Faux", le "D√©fi Personnalis√©" (un quiz sur-mesure) et "Trouvez l'Intrus" (d√©masquer la fausse information).</p><div class="conseil-prof"><strong>Conseil :</strong> C'est une fa√ßon ludique de v√©rifier tes informations et d'ouvrir tes horizons en combattant les pr√©jug√©s.</div></div>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">2. Se Connecter au Monde R√©el</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> L'Exp√©rience</h4><p><strong>Objectif :</strong> Obtenir un retour authentique de la part d'√©tudiants.</p><p><strong>Fonctionnement :</strong> L'<strong>atelier de pr√©paration</strong> t'aide √† g√©n√©rer des questions pertinentes. Ensuite, tu peux t'entra√Æner avec le <strong>simulateur d'entretien</strong> pour discuter avec un "√©tudiant √©claireur" virtuel.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est le meilleur moyen de conna√Ætre la "vraie vie" d'une formation, au-del√† des brochures officielles.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> L'Entretien Professionnel</h4><p><strong>Objectif :</strong> Pr√©parer des rencontres avec des professionnels du secteur qui t'int√©resse.</p><p><strong>Fonctionnement :</strong> Utilise l'<strong>atelier</strong> pour pr√©parer des questions cibl√©es pour un professionnel. Entra√Æne-toi ensuite avec le <strong>simulateur d'entretien</strong> pour arriver confiant le jour J.</p><div class="conseil-prof"><strong>Conseil :</strong> La recherche en ligne est une chose, la r√©alit√© du terrain en est une autre. Une rencontre peut tout changer !</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg> Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> Trouver des √©v√©nements (salons, JPO) et des professionnels pr√®s de chez toi.</p><p><strong>Fonctionnement :</strong> L'outil est divis√© en trois ateliers (Salons, JPO, Professionnels) pour t'aider √† trouver des opportunit√©s locales et √† pr√©parer tes visites et tes prises de contact. Tu peux ajouter les √©v√©nements √† ton <strong>R√©troplanning</strong>.</p><div class="conseil-prof"><strong>Conseil :</strong> L'orientation se fait aussi sur le terrain. Une visite ou une rencontre peut parfois tout changer.</div></div>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">3. Construire son Projet</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Portfolio de Comp√©tences</h4><p><strong>Objectif :</strong> Cr√©er un portfolio unique de tes atouts, bas√© sur ce que tu fais et ce que tu es, pour valoriser tes candidatures.</p><p><strong>Fonctionnement :</strong> L'<strong>Analyseur d'exp√©riences</strong> transforme tes r√©cits en paragraphes percutants. Le <strong>D√©tecteur de comp√©tences</strong> r√©v√®le tes forces via un quiz. Enfin, le <strong>Connecteur</strong> cr√©e une synth√®se qui lie tes savoir-faire et tes savoir-√™tre.</p><div class="conseil-prof"><strong>Conseil :</strong> C'est une √©tape cruciale. Savoir parler de soi et de ses comp√©tences est un atout majeur pour Parcoursup et au-del√†.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> Pr√©parer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> R√©diger un "projet de formation motiv√©" clair et percutant pour Parcoursup.</p><p><strong>Fonctionnement :</strong> L'<strong>Atelier de r√©daction</strong> te permet de travailler sur chaque projet de candidature un par un. OrIA peut te proposer une structure, et l'<strong>Optimiseur de Paragraphe</strong> t'aide √† am√©liorer tes brouillons.</p><div class="conseil-prof"><strong>Conseil :</strong> Une lettre bien structur√©e a plus d'impact qu'un long texte confus. Cet outil t'apprend √† √™tre clair et convaincant.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Simulateur Vie √âtudiante</h4><p><strong>Objectif :</strong> Se projeter concr√®tement dans sa future vie d'√©tudiant.</p><p><strong>Fonctionnement :</strong> Utilise le simulateur interactif pour estimer ton budget mensuel (loyer, nourriture...) dans la ville de ton choix, et d√©couvre les principales aides financi√®res disponibles.</p><div class="conseil-prof"><strong>Conseil :</strong> L'aspect financier est une partie importante du projet. L'anticiper permet de faire des choix plus sereins.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> Pr√©parer l'apr√®s-Parcoursup, y compris les refus, et bien d√©marrer dans le sup√©rieur.</p><p><strong>Fonctionnement :</strong> L'outil propose deux ateliers : la <strong>simulation de conversation "Plan B"</strong> pour explorer des alternatives, et le <strong>"Coach de R√©ussite"</strong> pour obtenir des conseils pour ta premi√®re ann√©e.</p><div class="conseil-prof"><strong>Conseil :</strong> Une bonne orientation, c'est aussi √™tre bien pr√©par√© pour la suite. Ces √©tapes te donnent les cl√©s pour une transition r√©ussie.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Stage de Seconde</h4><p><strong>Objectif :</strong> T'accompagner dans la recherche et la valorisation de ton stage d'observation.</p><p><strong>Fonctionnement :</strong> L'outil propose deux ateliers : l'un pour <strong>trouver un stage</strong> (sugg√©rer des lieux, pr√©parer le contact) et l'autre pour <strong>faire le bilan</strong> de ton exp√©rience (obtenir un plan de rapport, analyser les comp√©tences acquises).</p><div class="conseil-prof"><strong>Conseil :</strong> Une fois ton bilan r√©alis√©, tu peux l'ajouter directement √† ton Portfolio de Comp√©tences pour ne jamais perdre le fruit de ton travail !</div></div>
`;

const partie4FonctionnalitesHTML_parents = `
    <h2>Partie 2 : Exploration D√©taill√©e des Fonctionnalit√©s</h2>
    <p class="text-slate-600 mb-6 text-center">Le menu de votre enfant est organis√© en deux grandes sections pour l'aider √† naviguer : son Tableau de Bord personnel et son Parcours d'Orientation √©tape par √©tape.</p>
    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">üöÄ Le Tableau de Bord</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont ses outils centraux, qu'il/elle utilisera tout au long de son parcours pour suivre ses progr√®s, synth√©tiser ses id√©es et planifier ses actions.</p>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg> Mon Journal de Bord</h4><p><strong>Objectif :</strong> Lui permettre de centraliser et de synth√©tiser toutes ses r√©flexions au m√™me endroit.</p><p><strong>Fonctionnement :</strong> Il/elle y retrouve les synth√®ses de son travail (dans des sections d√©pliables), sa <strong>Carte d'Orientation</strong> et son profil visuel. Une fonction de <strong>partage</strong> est disponible pour vous permettre d'√©changer avec lui/elle.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Ce journal est la base de discussion la plus concr√®te et la plus riche que vous puissiez avoir avec votre enfant. Utilisez le bouton "Pr√©parer une discussion" sur la page partag√©e.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg> Mon R√©troplanning</h4><p><strong>Objectif :</strong> L'aider √† planifier son ann√©e sans stress en visualisant les grandes √©ch√©ances.</p><p><strong>Fonctionnement :</strong> OrIA g√©n√®re un calendrier d'actions mois par mois adapt√© √† sa classe et lui fournit des <strong>conseils personnalis√©s</strong>. Il/elle peut cocher les t√¢ches accomplies.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est l'outil parfait pour ne jamais √™tre pris de court. Une ann√©e bien planifi√©e est une ann√©e plus sereine.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Mieux se conna√Ætre</h4><p><strong>Objectif :</strong> Aider votre enfant √† dresser un portrait de sa personnalit√© et de ses pr√©f√©rences.</p><p><strong>Fonctionnement :</strong> Apr√®s avoir d√©crit sa situation, il/elle r√©pond √† un questionnaire. OrIA analyse ses r√©ponses pour r√©v√©ler son <strong>Arch√©type de personnalit√©</strong> et cr√©er un <strong>graphique de ses p√¥les d'int√©r√™ts (RIASEC)</strong>.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Invitez-le/la √† r√©pondre honn√™tement. L'objectif est de l'aider √† mieux se conna√Ætre, pas de l'√©valuer. C'est un excellent point de d√©part pour une discussion.</div></div>
    <hr style="margin: 60px 0;">
    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">üß≠ Le Parcours d'Orientation</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les √©tapes guid√©es pour construire son projet. Elles sont organis√©es en trois grandes phases logiques.</p>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">1. Explorer les Possibilit√©s</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Le simulateur de sp√©cialit√©s</h4><p><strong>Objectif :</strong> L'aider √† faire le lien entre les mati√®res choisies au lyc√©e et les fili√®res d'√©tudes sup√©rieures.</p><p><strong>Fonctionnement :</strong> Il/elle utilise un <strong>atelier</strong> pour tester une combinaison de sp√©cialit√©s et l'analyser. Il/elle enregistre ses explorations, et un <strong>comparateur</strong> appara√Æt lorsqu'il/elle en a sauvegard√© plusieurs.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est l'outil essentiel pour l'aider √† faire des choix √©clair√©s en fin de Seconde et de Premi√®re.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg> Les Fondations</h4><p><strong>Objectif :</strong> L'aider √† d√©couvrir des m√©tiers sur la base d'informations fiables.</p><p><strong>Fonctionnement :</strong> Il/elle peut explorer des m√©tiers dans un <strong>atelier</strong>, utiliser OrIA pour <strong>simuler une "journ√©e type"</strong> ou analyser les d√©bouch√©s, et g√©n√©rer un <strong>tableau comparatif</strong> entre plusieurs pistes.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'Onisep est la source la plus neutre et la plus compl√®te. C'est le point de d√©part incontournable pour ses recherches.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg> Le Catalogue</h4><p><strong>Objectif :</strong> L'aider √† utiliser le moteur de recherche des formations post-bac comme un expert.</p><p><strong>Fonctionnement :</strong> L'outil peut g√©n√©rer un <strong>rapport de compatibilit√©</strong> entre le profil de votre enfant et les "attendus" d'une formation. Il peut aussi <strong>comparer plusieurs formations</strong> sauvegard√©es.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Utiliser Parcoursup d√®s la Seconde pour explorer, sans la pression des v≈ìux, est une excellente strat√©gie.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg> L'Actu</h4><p><strong>Objectif :</strong> L'aider √† s'informer sur les classements et l'actualit√© du monde des √©tudes.</p><p><strong>Fonctionnement :</strong> Quand il/elle trouve une information, OrIA peut l'analyser en la croisant avec son profil pour voir en quoi elle est pertinente pour lui/elle.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Discuter de l'actualit√© de l'orientation est un bon moyen de rester connect√©(e) √† sa r√©flexion.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Fact Checking</h4><p><strong>Objectif :</strong> Tester ses connaissances et d√©construire les id√©es re√ßues.</p><p><strong>Fonctionnement :</strong> Il/elle peut lancer des quiz (Vrai/Faux, D√©fi Personnalis√©, Trouvez l'Intrus) pour confronter ses croyances √† la r√©alit√©.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est une fa√ßon ludique de v√©rifier ses informations et d'ouvrir la discussion sur les st√©r√©otypes.</div></div>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">2. Se Connecter au Monde R√©el</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> L'Exp√©rience</h4><p><strong>Objectif :</strong> L'encourager √† obtenir un retour authentique de la part d'√©tudiants.</p><p><strong>Fonctionnement :</strong> L'outil l'aide √† pr√©parer des questions et propose un <strong>simulateur d'entretien</strong> pour qu'il/elle s'entra√Æne √† discuter avec un √©tudiant virtuel et gagne en confiance.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est le meilleur moyen de conna√Ætre la "vraie vie" d'une formation, au-del√† des brochures officielles.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> L'Entretien Professionnel</h4><p><strong>Objectif :</strong> L'aider √† pr√©parer des rencontres avec des professionnels.</p><p><strong>Fonctionnement :</strong> L'application propose un <strong>atelier de pr√©paration</strong> et un <strong>simulateur</strong> pour l'aider √† structurer sa pens√©e et √† s'entra√Æner avant de contacter un professionnel.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Une rencontre sur le terrain peut tout changer. Vous pouvez aussi l'aider en mobilisant votre propre r√©seau.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg> Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> L'aider √† trouver des √©v√©nements et des structures d'aide pr√®s de chez lui/elle.</p><p><strong>Fonctionnement :</strong> Il/elle peut utiliser les ateliers pour trouver des <strong>Salons, JPO ou professionnels</strong> et ajouter les √©v√©nements √† son <strong>R√©troplanning</strong>.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Accompagner votre enfant √† un salon peut √™tre un moment d'√©change privil√©gi√©.</div></div>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">3. Construire son Projet</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Portfolio de Comp√©tences</h4><p><strong>Objectif :</strong> L'aider √† cr√©er un portfolio unique de ses atouts, bas√© sur ce qu'il/elle fait et ce qu'il/elle est.</p><p><strong>Fonctionnement :</strong> L'outil aide √† transformer ses exp√©riences en paragraphes valorisables, √† r√©v√©ler ses comp√©tences transversales, et √† cr√©er une <strong>synth√®se</strong> qui connecte les deux.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est une √©tape cruciale pour son dossier Parcoursup et son Grand Oral. Encouragez-le/la √† la compl√©ter en d√©tail.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> Pr√©parer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> L'aider √† r√©diger un "projet de formation motiv√©" clair et percutant.</p><p><strong>Fonctionnement :</strong> L'<strong>Atelier de r√©daction</strong> lui permet de travailler sur chaque projet, d'obtenir une structure et d'am√©liorer ses brouillons avec l'<strong>Optimiseur de Paragraphe</strong>.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Cet outil lui apprend √† √™tre clair et convaincant, une comp√©tence utile bien au-del√† de Parcoursup.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Simulateur Vie √âtudiante</h4><p><strong>Objectif :</strong> L'aider √† se projeter concr√®tement dans sa future vie d'√©tudiant.</p><p><strong>Fonctionnement :</strong> Il/elle peut estimer le co√ªt de la vie avec un <strong>simulateur interactif</strong> et d√©couvrir les aides financi√®res.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> L'aspect financier est une partie importante du projet. L'anticiper ensemble permet de faire des choix plus sereins.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> L'aider √† pr√©parer l'apr√®s-Parcoursup et √† g√©rer le stress des r√©ponses.</p><p><strong>Fonctionnement :</strong> L'outil propose un atelier <strong>"Plan B"</strong> (simulation de conversation) et un <strong>"Coach de R√©ussite"</strong> pour l'aider √† se projeter positivement.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> Cet outil peut l'aider √† relativiser et √† envisager d'autres chemins, ce qui est une comp√©tence pr√©cieuse.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Stage de Seconde</h4><p><strong>Objectif :</strong> L'accompagner dans la recherche et la valorisation de son stage d'observation.</p><p><strong>Fonctionnement :</strong> L'outil l'aide √† <strong>trouver des pistes</strong> et √† <strong>faire le bilan</strong> de son exp√©rience pour en extraire des comp√©tences.</p><div class="conseil-prof"><strong>Conseil du Parent :</strong> C'est une excellente occasion de l'aider √† transformer une premi√®re exp√©rience concr√®te en un atout pour son futur Portfolio.</div></div>
`;

const partie4FonctionnalitesHTML_enseignants = `
    <h2>Partie 3 : Exploration D√©taill√©e des Fonctionnalit√©s</h2>
    <p class="text-slate-600 mb-6 text-center">Le menu de l'√©l√®ve est organis√© en deux grandes sections : son Tableau de Bord personnel et son Parcours d'Orientation √©tape par √©tape.</p>
    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">üöÄ Le Tableau de Bord</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les outils centraux de l'√©l√®ve, con√ßus pour le suivi, la synth√®se et la planification de sa d√©marche d'orientation.</p>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg> Mon Journal de Bord</h4><p><strong>Objectif :</strong> Centraliser la r√©flexion de l'√©l√®ve pour faciliter le suivi.</p><p><strong>Fonctionnement :</strong> Le journal synth√©tise tout le travail de l'√©l√®ve. La fonction de <strong>partage</strong> est essentielle : elle vous donne acc√®s √† une vue d'ensemble de sa d√©marche avant un entretien.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Ce journal est la base de discussion la plus concr√®te et la plus riche que vous puissiez avoir avec un √©l√®ve lors d'un entretien de suivi. Utilisez le bouton "Pr√©parer une discussion" sur la page partag√©e.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg> Mon R√©troplanning</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† planifier son ann√©e et √† visualiser les √©ch√©ances.</p><p><strong>Fonctionnement :</strong> OrIA g√©n√®re un calendrier d'actions mois par mois adapt√© √† chaque niveau de classe et fournit des <strong>conseils personnalis√©s</strong> que l'√©l√®ve peut sauvegarder.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Un excellent support visuel √† pr√©senter en d√©but d'ann√©e pour fixer le cap du Parcours Avenir.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" /></svg> Mieux se conna√Ætre</h4><p><strong>Objectif :</strong> Permettre √† l'√©l√®ve de dresser un portrait de sa personnalit√©, de ses int√©r√™ts et de ses motivations.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve d√©crit sa situation, r√©pond √† un questionnaire, et OrIA r√©v√®le son <strong>Arch√©type de personnalit√©</strong> ainsi qu'un <strong>graphique de ses p√¥les d'int√©r√™ts (RIASEC)</strong>.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est une excellente base pour un entretien individuel. L'Arch√©type et le graphique RIASEC fournissent un vocabulaire et un support visuel pour aider l'√©l√®ve √† parler de lui.</div></div>
    <hr style="margin: 60px 0;">
    <h3 class="centered-subtitle" style="font-size: 1.5em; color: #1A3263;">üß≠ Le Parcours d'Orientation</h3>
    <p class="text-slate-600 mb-6 text-center">Ce sont les √©tapes guid√©es pour construire son projet, chacune offrant des opportunit√©s p√©dagogiques.</p>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">1. Explorer les Possibilit√©s</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg> Le simulateur de sp√©cialit√©s</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† faire des choix de sp√©cialit√©s √©clair√©s.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve utilise un <strong>atelier</strong> pour analyser des combinaisons de sp√©cialit√©s et les sauvegarder. Un <strong>comparateur</strong> est disponible pour l'aider √† peser le pour et le contre.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est l'outil essentiel √† mobiliser lors des s√©ances d'accompagnement au choix en Seconde et en Premi√®re.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0 0 12 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18" /></svg> Les Fondations</h4><p><strong>Objectif :</strong> Ancrer la recherche de l'√©l√®ve dans des sources fiables et l'aider √† se projeter.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut explorer des m√©tiers dans un <strong>atelier</strong> et utiliser OrIA pour <strong>simuler une "journ√©e type"</strong>, analyser les d√©bouch√©s, ou g√©n√©rer un <strong>tableau comparatif</strong>.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Ces outils interactifs favorisent une exploration plus active et approfondie que la simple lecture de fiches.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.627 48.627 0 0 1 12 20.904a48.627 48.627 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.57 50.57 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" /></svg> Le Catalogue</h4><p><strong>Objectif :</strong> Apprendre √† l'√©l√®ve √† d√©crypter une fiche formation et √† s'auto-√©valuer.</p><p><strong>Fonctionnement :</strong> La fonction de <strong>rapport de compatibilit√©</strong> croise les donn√©es du journal de l'√©l√®ve avec les "attendus" d'une formation. Un <strong>comparateur</strong> est aussi disponible.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Encouragez les √©l√®ves √† utiliser cet outil pour objectiver leurs choix et pr√©parer leurs arguments pour le projet de formation motiv√©.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" /></svg> L'Actu</h4><p><strong>Objectif :</strong> D√©velopper l'esprit critique de l'√©l√®ve face √† l'information sur l'orientation.</p><p><strong>Fonctionnement :</strong> OrIA analyse une information trouv√©e en ligne en la mettant en perspective avec le profil de l'√©l√®ve.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Peut servir de support pour des s√©ances d'EMI appliqu√©es √† l'orientation.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Fact Checking</h4><p><strong>Objectif :</strong> D√©construire les st√©r√©otypes sur les fili√®res et les m√©tiers.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut lancer des quiz ("Vrai ou Faux", "D√©fi Personnalis√©", "Trouvez l'Intrus") pour challenger ses propres id√©es re√ßues.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Id√©al pour une s√©ance collective dynamique pour lancer des d√©bats.</div></div>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">2. Se Connecter au Monde R√©el</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.761 9.761 0 0 1-2.541-.358m-4.002 0A9.754 9.754 0 0 1 3 12c0-4.556 4.03-8.25 9-8.25a9.754 9.754 0 0 1 4.545 1.343" /></svg> L'Exp√©rience</h4><p><strong>Objectif :</strong> Pr√©parer l'√©l√®ve √† des interactions r√©elles et d√©velopper son aisance orale.</p><p><strong>Fonctionnement :</strong> Le <strong>simulateur d'entretien</strong> permet √† l'√©l√®ve de s'entra√Æner √† dialoguer avec un √©tudiant virtuel.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Tr√®s utile pour les √©l√®ves les plus timides afin de pr√©parer des JPO ou des entretiens de stage.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15.59 14.37a6 6 0 0 1-5.84 7.38v-4.82m5.84-2.56a17.96 17.96 0 0 0-5.84-2.56m0 0A17.965 17.965 0 0 1 12 2.25a17.965 17.965 0 0 1 7.41 12.56m-7.41 0v4.82" /></svg> L'Entretien Professionnel</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† structurer sa d√©marche de prise de contact avec des professionnels.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut pr√©parer ses questions et s'entra√Æner avec un <strong>simulateur</strong> avant de contacter un professionnel.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Peut servir de support √† un projet o√π les √©l√®ves doivent interviewer des professionnels.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg> Rencontres sur mon Territoire</h4><p><strong>Objectif :</strong> Connecter le projet de l'√©l√®ve aux ressources et √©v√©nements locaux.</p><p><strong>Fonctionnement :</strong> OrIA recherche les JPO, salons et pistes de professionnels locaux. Les √©v√©nements peuvent √™tre ajout√©s au <strong>R√©troplanning</strong>.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Utile pour communiquer les dates importantes de l'orientation sur le territoire.</div></div>
    <h4 class="centered-subtitle" style="font-size: 1.2em; color: #0891b2; margin-top: 40px;">3. Construire son Projet</h4>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Portfolio de Comp√©tences</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† identifier et valoriser ses comp√©tences.</p><p><strong>Fonctionnement :</strong> L'<strong>Analyseur d'exp√©riences</strong> transforme un r√©cit en paragraphe de candidature, le <strong>D√©tecteur de comp√©tences</strong> r√©v√®le ses forces, et le <strong>Connecteur</strong> fait la synth√®se des deux.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Outil tr√®s pertinent pour la pr√©paration au Grand Oral et pour l'enseignement de la comp√©tence "Savoir parler de soi".</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg> Pr√©parer sa candidature (Terminales)</h4><p><strong>Objectif :</strong> Aider l'√©l√®ve √† am√©liorer la qualit√© r√©dactionnelle de son projet de formation motiv√©.</p><p><strong>Fonctionnement :</strong> L'<strong>Atelier de r√©daction</strong> permet √† l'√©l√®ve de g√©n√©rer une structure et d'am√©liorer ses brouillons avec l'<strong>Optimiseur de Paragraphe</strong>.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Cet outil ne fait pas le travail √† la place de l'√©l√®ve mais lui apprend √† affiner son argumentation.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 1 0 0 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg> Simulateur Vie √âtudiante</h4><p><strong>Objectif :</strong> Ancrer le projet d'√©tudes dans la r√©alit√© mat√©rielle.</p><p><strong>Fonctionnement :</strong> L'√©l√®ve peut estimer le co√ªt de la vie avec un <strong>simulateur interactif</strong> et d√©couvrir les aides financi√®res.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Parfait pour une s√©ance sur l'autonomie et la pr√©paration √† la vie √©tudiante.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456Z" /></svg> Anticiper la suite (Terminales)</h4><p><strong>Objectif :</strong> D√©velopper la r√©silience de l'√©l√®ve face √† l'incertitude.</p><p><strong>Fonctionnement :</strong> La <strong>simulation de conversation "Plan B"</strong> et le <strong>"Coach de R√©ussite"</strong> sont deux ateliers pour aider l'√©l√®ve √† rebondir et √† se projeter.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> Un outil int√©ressant pour travailler les comp√©tences psycho-sociales.</div></div>
    <div class="etape"><h4><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 inline-block mr-2 align-middle"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" /></svg> Mon Stage de Seconde</h4><p><strong>Objectif :</strong> Accompagner l'√©l√®ve dans la recherche et le bilan de son stage.</p><p><strong>Fonctionnement :</strong> L'outil l'aide √† <strong>trouver des pistes</strong> de stage et, une fois celui-ci termin√©, √† en <strong>faire le bilan</strong> pour en extraire des comp√©tences valorisables.</p><div class="conseil-prof"><strong>Conseil du Prof :</strong> C'est un support id√©al pour les s√©ances d√©di√©es au stage d'observation de Seconde, de la pr√©paration au d√©briefing.</div></div>
`;

    const partie5TechHTML = `
        <h2>Partie 3 : Technologie et Donn√©es Personnelles</h2>
        <div class="etape">
            <h4>Le Mod√®le d'IA Utilis√©</h4>
            <p>L'intelligence artificielle int√©gr√©e √† cette application est propuls√©e par <strong>GPT-4o</strong>, un mod√®le de langage avanc√© d√©velopp√© par <strong>OpenAI</strong>.</p>
        </div>
        <div class="etape">
            <h4>Vos Donn√©es Personnelles</h4>
            <div class="conseil-prof" style="font-style: normal;">
                La protection de vos donn√©es est une priorit√© absolue. Voici en toute transparence comment elles sont g√©r√©es :
                <ul>
                    <li><strong>Quelles donn√©es sont collect√©es ?</strong> L'application collecte uniquement les informations que vous fournissez : votre nom, pr√©nom, email, nom de votre lyc√©e, ainsi que toutes les notes que vous inscrivez dans votre journal de bord.</li>
                    <li><strong>Qui les collecte et o√π sont-elles h√©berg√©es ?</strong> Vos donn√©es sont collect√©es par les concepteurs de l'application, et sont stock√©es de mani√®re s√©curis√©e sur <strong>Firebase</strong>, une plateforme de Google. L'h√©bergement se fait sur des serveurs s√©curis√©s en Europe.</li>
                    <li><strong>Comment sont-elles utilis√©es ?</strong> Vos donn√©es ne sont utilis√©es <strong>que pour le fonctionnement de l'application</strong>. Votre journal de bord est envoy√© √† OrIA GPT 4o pour g√©n√©rer les r√©ponses contextuelles, mais il n'est pas utilis√© pour entra√Æner le mod√®le global d'OpenAI. Vos donn√©es ne sont jamais partag√©es avec des tiers ni utilis√©es √† des fins commerciales.</li>
                    <li><strong>Qui peut y acc√©der ?</strong> Vous seul(e) pouvez acc√©der √† vos donn√©es via votre compte. Si vous utilisez la fonction de partage, la personne d√©tentrice du lien pourra voir une version "lecture seule" de votre journal.</li>
                </ul>
            </div>
        </div>
    `;
    // --- 2. Logique de construction de l'accord√©on ---

    let sections = [];
    switch (guideUserRole) {
        case 'parent':
            sections = [
                { title: "üöÄ Introduction : OrIA comme Boussole 2.0", content: introHTML, open: true },
                { title: "üë®üë©üëß Devenir le 'Sparring Partner'de votre enfant", content: partie2ParentsHTML },
                { title: "üß≠ Exploration des Fonctionnalit√©s", content: partie4FonctionnalitesHTML_parents },
                { title: "üì± Installation de l'Application", content: installationHTML },
                { title: "üîí Technologie et Donn√©es Personnelles", content: partie5TechHTML }
            ];
            break;
        case 'enseignant':
            sections = [
                { title: "üöÄ Introduction : OrIA comme Boussole 2.0", content: introHTML, open: true },
                { title: "üßëüè´ Un Outil au Service du Parcours Avenir", content: partie3EnseignantsHTML },
                { title: "üìä Ma√Ætriser le Tableau de Bord Enseignant", content: dashboardEnseignantsHTML },
                { title: "üß≠ Exploration des Fonctionnalit√©s", content: partie4FonctionnalitesHTML_enseignants },
                { title: "üí° 10 Id√©es de S√©ances Cl√©s en Main", content: seancesEnseignantsHTML },
                { title: "üì± Installation de l'Application", content: installationHTML },
                { title: "üîí Technologie et Donn√©es Personnelles", content: partie5TechHTML }
            ];
            break;
        case 'eleve':
        default:
            sections = [
                { title: "üöÄ Introduction : OrIA comme Boussole 2.0", content: introHTML, open: true },
                { title: "üßëüéì Ton QG d'Orientation", content: partie1ElevesHTML },
                { title: "üß≠ Exploration D√©taill√©e des Fonctionnalit√©s", content: partie4FonctionnalitesHTML_eleves },
                { title: "üì± Installation de l'Application", content: installationHTML },
                { title: "üîí Technologie et Donn√©es Personnelles", content: partie5TechHTML }
            ];
            break;
    }

    const accordionHTML = sections.map(section => `
        <details class="guide-accordion-item" ${section.open ? 'open' : ''}>
            <summary class="guide-accordion-title">
                ${section.title}
            </summary>
            <div class="guide-accordion-content">
                ${section.content.replace(/<h2[^>]*>.*?<\/h2>/s, '')}
            </div>
        </details>
    `).join('');

    div.innerHTML = `
        <style>
            /* Styles pour l'accord√©on */
            .guide-accordion-item { border-bottom: 1px solid #e2e8f0; }
            .guide-accordion-title {
                font-size: 1.25rem; font-weight: 600; color: #1A3263;
                padding: 1rem; cursor: pointer; list-style: none;
                display: flex; justify-content: center;
                align-items: center; position: relative;
                transition: background-color 0.2s;
            }
            .guide-accordion-title:hover { background-color: #f8fafc; }
            .guide-accordion-title::-webkit-details-marker { display: none; }
            .guide-accordion-title::after {
                content: '+'; font-size: 1.5rem; font-weight: 300;
                color: #0891b2; transition: transform 0.2s;
                position: absolute; right: 1rem;
            }
            .guide-accordion-item[open] > summary { border-bottom: 1px solid #e2e8f0; }
            .guide-accordion-item[open] > summary::after { transform: rotate(45deg); }
            .guide-accordion-content { padding: 0 1rem 1.5rem 1rem; }

            /* --- MODIFICATIONS CI-DESSOUS --- */

            /* R√®gle g√©n√©rale : tout centrer */
            .guide-container {
                line-height: 1.7;
                text-align: center; /* MODIFI√â */
            }
            /* Tous les titres sont centr√©s */
            .guide-container h2, .guide-container h3, .guide-container h4 {
                color: #1A3263; margin-top: 40px; font-weight: 600; text-align: center;
            }
            .guide-container h2 { font-size: 1.75em; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;}
            .guide-container h3 { font-size: 1.3em; }
            .guide-container h4 { margin-top: 25px; font-size: 1.1em; display: flex; align-items: center; gap: 0.75rem; justify-content: center; }
            
            /* Les bo√Ætes et le contenu des √©tapes h√©ritent du centrage */
            .guide-container .info-box, .guide-container .conseil-prof, .guide-container .etape {
                padding: 20px; margin: 20px auto; border-radius: 8px; border-left-width: 4px;
                max-width: 90%; /* Pour un meilleur rendu visuel du texte centr√© */
            }
            .guide-container .etape { border-left-width: 2px; padding-left: 10px; }
            .guide-container .info-box h4, .guide-container .conseil-prof h4 { justify-content: center; }

            /* Comportement sp√©cial pour les listes pour qu'elles restent lisibles */
            .guide-container ul, .guide-container ol {
                display: inline-block; /* Permet de centrer le bloc de la liste */
                text-align: left; /* Garde le texte dans la liste align√© √† gauche */
                padding-left: 25px; margin-top: 10px;
            }

            /* Styles sp√©cifiques (inchang√©s) */
            .guide-container .logo { display: block; margin: 0 auto 20px auto; width: 200px; }
            .guide-container .info-box-parents { background-color: #f7fee7; border-color: #84cc16; }
            .guide-container .info-box-parents h4 { color: #4d7c0f; } .guide-container .info-box-parents ul { color: #65a30d; }
            .guide-container .info-box-teachers { background-color: #fff7ed; border-color: #f97316; }
            .guide-container .info-box-teachers h4 { color: #9a3412; } .guide-container .info-box-teachers ul { color: #c2410c; }
            .guide-container .conseil-prof { background-color: #ecfeff; border-color: #0891b2; font-style: italic; color: #155e75;}
            .guide-container .conseil-prof h4 { color: #164e63; }
            .guide-container li { margin-bottom: 8px; }
        </style>
        
        <div class="guide-container">
            ${accordionHTML}
        </div>
    `;

    return div;
}



// ==============================================================================
// BLOC FINAL ET COMPLET POUR L'√âTAPE 4 (SANS PLACEHOLDER)
// ==============================================================================

function createStep4View() {
    const config = stepsConfig.step4;
    const div = document.createElement('div');
    div.className = 'fade-in';

    const audioPlayer = document.getElementById('tts-audio-player');
    const silentMp3 = 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjM2LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6urq6urq6urq6urq6urq6urq6urq6urq6v////////////////////////////////8AAAAATGF2YzU2LjQxAAAAAAAAAAAAAAAAJAAAAAAAAAAAASDs90hvAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAAAAAAAA0gAAAAATEFN//MUZAMAAAGkAAAAAAAAA0gAAAAARTMu//MUZAYAAAGkAAAAAAAAA0gAAAAA';

    // La fonction speakText est locale pour √™tre autonome.
    // C'est une copie exacte de la logique fonctionnelle de l'√âtape 8.
    async function speakText(text, voice, messageWrapper) {
        try {
            if (isConversationModeActive) {
                recognition.stop();
            }
            const generateSpeech = httpsCallable(functions, 'generateSpeech');
            const result = await generateSpeech({ text: text, voice: voice });
            
            if (result.data && result.data.audioContent) {
                const audioSrc = `data:audio/mpeg;base64,${result.data.audioContent}`;
                audioPlayer.src = audioSrc;

                audioPlayer.onloadedmetadata = () => {
                    const duration = audioPlayer.duration;
                    const words = text.split(/\s+/);
                    const wordCount = words.length;
                    const delay = (duration * 1000) / (wordCount || 1);

                    const textContainer = document.createElement('p');
                    messageWrapper.innerHTML = '';
                    messageWrapper.className = 'bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs';
                    messageWrapper.appendChild(textContainer);

                    let wordIndex = 0;
                    audioPlayer.play();

                    audioPlayer.onended = () => {
                        if (isConversationModeActive) {
                            recognition.start();
                        }
                        audioPlayer.onended = null;
                    };

                    const interval = setInterval(() => {
                        if (wordIndex < words.length) {
                            textContainer.textContent += words[wordIndex] + ' ';
                            wordIndex++;
                        } else {
                            clearInterval(interval);
                        }
                    }, delay);
                };
                audioPlayer.load();
            } else {
                throw new Error("La r√©ponse de la fonction est vide.");
            }
        } catch (error) {
            messageWrapper.innerHTML = `<div class="bg-red-100 text-red-800 p-3 rounded-lg max-w-xs"><p>Erreur audio. Voici le message : ${text}</p></div>`;
            console.error("Erreur de la voix OpenAI :", error);
        }
    }
    
    // Initialisation de la structure de donn√©es
    if (!journalData.step4.themes || !Array.isArray(journalData.step4.themes)) {
        journalData.step4.themes = [];
    }

    let conversationHistory = [];
    let currentSimTheme = '';
    let currentExploration = { theme: '', question: '', suggestions: '' };

    // --- Structure HTML compl√®te ---
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${config.action}</div></div>
        <div class="mb-8"><a href="${config.url}" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter ${config.site} ‚Üó</a></div>
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Atelier de Pr√©paration d'√âchange</h2>
            <div class="mb-4"><label for="current-theme" class="block text-md font-medium">Th√®me ou formation</label><input type="text" id="current-theme" class="w-full mt-1 p-3 border rounded-lg" placeholder="Ex: √âcoles d'ing√©nieurs"></div>
            <div class="mb-4"><label for="current-question" class="block text-md font-medium">Ma question principale</label><textarea id="current-question" rows="2" class="w-full mt-1 p-3 border rounded-lg" placeholder="Quelle est la plus grande diff√©rence avec le lyc√©e ?"></textarea></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <button type="button" id="generate-questions-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">‚ú® Obtenir des questions</button>
                <button type="button" id="launch-sim-btn" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600">üöÄ Lancer la simulation</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] prose prose-sm max-w-none"></div>
            <button type="button" id="save-theme-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700">üíæ Enregistrer cette pr√©paration</button>
        </div>
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes Pr√©parations Enregistr√©es</h2>
        <div id="saved-themes-container" class="space-y-3 mb-8"></div>
        <div id="simulation-modal" class="simulation-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col h-[80vh]">
                <div class="flex items-center justify-between p-4 border-b bg-background-light rounded-t-2xl"><h3 class="font-bold text-OrIAntation-darkblue">üéì Discussion avec un √©claireur</h3><button id="simulation-close" class="text-slate-500 hover:text-OrIAntation-darkblue text-2xl">&times;</button></div>
                <div id="simulation-messages" class="flex-1 p-4 overflow-y-auto simulation-message-container"></div>
                <form id="simulation-form" class="p-4 border-t flex items-center gap-2"><input type="text" id="simulation-input" placeholder="√âcris ou dis ta r√©ponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none"><button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button></form>
            </div>
        </div>
    `;
    
    const savedContainer = div.querySelector('#saved-themes-container');
    const simulationModal = div.querySelector('#simulation-modal');
    const simulationMessages = div.querySelector('#simulation-messages');

    const addSimMessage = (sender) => {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = 'flex mb-4';
        const messageBubble = document.createElement('div');
        if (sender === 'user') {
            messageWrapper.classList.add('justify-end');
        } else {
            messageBubble.className = 'bg-cyan-100 p-3 rounded-lg';
            messageBubble.innerHTML = `<div class="chatbot-loader"></div>`;
        }
        messageWrapper.appendChild(messageBubble);
        simulationMessages.appendChild(messageWrapper);
        simulationMessages.scrollTop = simulationMessages.scrollHeight;
        return messageBubble;
    };
    
    const renderSavedThemes = () => {
        if (!savedContainer) return;
        const themes = journalData.step4.themes || [];
        if (themes.length === 0) {
            savedContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de pr√©paration enregistr√©e.</p>`;
        } else {
            savedContainer.innerHTML = themes.map((item, index) => `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${item.theme}</span>
                        <button type="button" data-index="${index}" class="delete-theme-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer">üóëÔ∏è</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle prose prose-sm max-w-none">
                        <p><strong>Ma question :</strong> ${item.question}</p>
                        <p><strong>Suggestions de l'IA :</strong></p>
                        ${marked.parse(item.suggestions || '')}
                    </div>
                </details>
            `).join('');
        }
    };
    
    const resetWorkspace = () => {
        currentExploration = { theme: '', question: '', suggestions: '' };
        div.querySelector('#current-theme').value = '';
        div.querySelector('#current-question').value = '';
        div.querySelector('#result').innerHTML = '';
    };

    // --- Logique des √©v√©nements d'origine de l'√©tape 4 ---
    div.querySelector('#generate-questions-btn').addEventListener('click', async () => {
        const theme = div.querySelector('#current-theme').value.trim();
        const questionBase = div.querySelector('#current-question').value.trim();
        if (!theme || !questionBase || !journalData.step0.analysis) {
            showInfoModal("Veuillez renseigner le th√®me, votre question et avoir compl√©t√© l'√©tape 'Mieux se conna√Ætre'."); return;
        }
        const loader = div.querySelector('#loader');
        const resultDiv = div.querySelector('#result');
        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        const prompt = `Agis comme un coach d'orientation. Le profil d'un lyc√©en est : "${journalData.step0.analysis}". Il s'int√©resse √† : "${theme}" et sa question est : "${questionBase}". Sugg√®re 10 questions personnalis√©es √† poser √† un √©tudiant. Donne uniquement les 10 questions, chacune sur une nouvelle ligne.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.innerHTML = marked.parse(result);
        currentExploration.suggestions = result;
    });

    div.querySelector('#save-theme-btn').addEventListener('click', async () => {
        currentExploration.theme = div.querySelector('#current-theme').value.trim();
        currentExploration.question = div.querySelector('#current-question').value.trim();
        if (!currentExploration.theme) { showInfoModal("Veuillez renseigner un th√®me."); return; }
        journalData.step4.themes.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(20);
        renderSavedThemes();
        resetWorkspace();
        showSurpriseModal("Pr√©paration sauvegard√©e !", "Elle est maintenant dans ton journal.", 3000);
    });

    savedContainer.addEventListener('click', async (e) => {
        if (e.target.closest('.delete-theme-btn')) {
            const index = e.target.closest('.delete-theme-btn').dataset.index;
            if (await showConfirmationModal("S√ªr de vouloir supprimer cette pr√©paration ?")) {
                journalData.step4.themes.splice(index, 1);
                await saveData();
                renderSavedThemes();
            }
        }
    });
    
    // --- Logique de la simulation orale (copi√©e de l'√©tape 8 et adapt√©e) ---
    div.querySelector('#launch-sim-btn').addEventListener('click', async () => {
        if (audioPlayer.paused) { audioPlayer.src = silentMp3; audioPlayer.play().catch(() => {}); }
        
        currentSimTheme = div.querySelector('#current-theme').value.trim();
        if (!currentSimTheme) { showInfoModal("Veuillez d'abord renseigner un th√®me."); return; }
        
        conversationHistory = [];
        simulationMessages.innerHTML = '';
        simulationModal.classList.remove('hidden');
        simulationModal.classList.add('flex');
        
        const loaderBubble = addSimMessage('ai');
        
        const startPrompt = `Tu incarnes un '√©tudiant √©claireur' en fin de cursus dans le domaine de "${currentSimTheme}". Tu es un sp√©cialiste passionn√© qui ma√Ætrise parfaitement ta formation. Ta mission est de donner des conseils concrets et des retours d'exp√©rience authentiques √† un lyc√©en. √âvite les g√©n√©ralit√©s. Ton ton est celui d'un grand fr√®re ou d'une grande s≈ìur : accessible, direct, mais tr√®s comp√©tent. Commence par une br√®ve salutation, puis pose une question ouverte et pr√©cise pour lancer la discussion sur les aspects concrets de la formation.`;
        const firstMessage = await callOpenAI_API({ promptText: startPrompt, withPersona: false });
        
        speakText(firstMessage, 'alloy', loaderBubble);
        conversationHistory.push({ role: 'model', parts: [{ text: firstMessage }] });
    });

   div.querySelector('#simulation-close').addEventListener('click', () => {
    simulationModal.classList.add('hidden');
    simulationModal.classList.remove('flex');

    // 1. On coupe le son de l'IA si elle est en train de parler
    if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer.src = '';
        // Tr√®s important : on supprime l'√©v√©nement pour √©viter qu'il ne relance le micro plus tard
        audioPlayer.onended = null; 
    }
    
    // 2. On coupe le micro de l'√©l√®ve s'il est actif
    if (recognition && isConversationModeActive) {
        recognition.stop();
    }

    // 3. On r√©initialise les √©tats pour dire que la conversation est bien termin√©e
    isConversationModeActive = false;
    isAISpeaking = false; 
});
    
    renderSavedThemes(); // Affichage initial
    return div;
}

// ‚ñº‚ñº‚ñº REMPLACEZ TOUTE VOTRE FONCTION createStep5View PAR CE BLOC ‚ñº‚ñº‚ñº

function createStep5View() {
    const config = stepsConfig.step5;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    if (!journalData.step5.articles || !Array.isArray(journalData.step5.articles)) {
        journalData.step5.articles = [];
    }

    let currentExploration = { title: '', notes: '', analysis: '' };

    const renderSavedArticles = () => {
        const container = div.querySelector('#saved-articles-container');
        if (!container) return;
        const articles = journalData.step5.articles || [];
        if (articles.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore d'article enregistr√©.</p>`;
        } else {
            container.innerHTML = articles.map((article, index) => `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${article.title}</span>
                        <button type="button" data-index="${index}" class="delete-article-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer">üóëÔ∏è</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle">
                        <div class="mb-2"><p class="font-semibold">Ce que j'ai appris :</p><p class="whitespace-pre-wrap text-sm">${article.notes || 'Non renseign√©.'}</p></div>
                        ${article.analysis ? `<div class="mb-2"><p class="font-semibold">Analyse de OrIA :</p><p class="whitespace-pre-wrap text-sm">${article.analysis}</p></div>` : ''}
                    </div>
                </details>
            `).join('');
        }
    };

    form.innerHTML = `
        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Atelier d'exploration d'Actualit√©</h2>
            <div class="mb-4">
                <label for="current-article-title" class="block text-md font-medium text-slate-700 mb-2">Info, article ou classement trouv√©</label>
                <input type="text" id="current-article-title" class="w-full p-3 border rounded-lg" placeholder="Ex: Le classement des √©coles de commerce 2025">
            </div>
             <div class="mb-4">
                <label for="current-article-notes" class="block text-md font-medium text-slate-700 mb-2">Ce que j'ai appris de cette info</label>
                <textarea id="current-article-notes" rows="4" class="w-full p-3 border rounded-lg" placeholder="Certaines √©coles sont sp√©cialis√©es dans le luxe..."></textarea>
            </div>
            <div class="text-center mb-4">
                <button type="button" id="analyse-btn" class="ai-btn w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Analyser mon actualit√©</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] whitespace-pre-wrap"></div>
            <button type="button" id="save-article-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">üíæ Enregistrer cette trouvaille</button>
        </div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">üì∞ Mes Actualit√©s Enregistr√©es</h2>
        <div id="saved-articles-container" class="space-y-3 mb-8"></div>
    `;
    
    const resetWorkspace = () => {
        currentExploration = { title: '', notes: '', analysis: '' };
        div.querySelector('#current-article-title').value = '';
        div.querySelector('#current-article-notes').value = '';
        div.querySelector('#result').innerHTML = '';
    };

    div.querySelector('#save-article-btn').addEventListener('click', async () => {
        currentExploration.title = div.querySelector('#current-article-title').value.trim();
        currentExploration.notes = div.querySelector('#current-article-notes').value.trim();
        if (!currentExploration.title) {
            showInfoModal("Veuillez renseigner le titre de l'info trouv√©e.");
            return;
        }
        journalData.step5.articles.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(20);
        renderSavedArticles();
        resetWorkspace();
        showSurpriseModal("Actualit√© sauvegard√©e !", "Cette information est maintenant dans ton journal.", 3000);
    });

    div.querySelector('#analyse-btn').addEventListener('click', async () => {
        const articleTitle = div.querySelector('#current-article-title').value.trim();
        const articleNotes = div.querySelector('#current-article-notes').value.trim();
        const loader = div.querySelector('#loader');
        const resultDiv = div.querySelector('#result');
        
        if (!journalData.step0.analysis) { showInfoModal("Veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'."); return; }
        if (!articleTitle || !articleNotes) { showInfoModal("Veuillez renseigner l'info trouv√©e et ce que vous en avez appris."); return; }

        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        
        const prompt = `Agis comme un conseiller d'orientation expert. Le profil d'un lyc√©en est : "${journalData.step0.analysis}".\nIl a fait une veille d'information sur : "${articleTitle}" et en a retenu : "${articleNotes}".\n\nTa mission est de mettre en relation cette actualit√© avec son profil personnel et de sugg√©rer, en te basant sur une recherche web, 1 autre piste de recherche (article, classement...) pr√©cise et pertinente qui pourrait l'int√©resser. Explique bri√®vement pourquoi.`;
        
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.innerHTML = linkify(result);
        currentExploration.analysis = result;
    });

    div.querySelector('#saved-articles-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-article-btn')) {
            const index = e.target.closest('.delete-article-btn').dataset.index;
            if (await showConfirmationModal("S√ªr de vouloir supprimer cette actualit√© ?")) {
                journalData.step5.articles.splice(index, 1);
                await saveData();
                renderSavedArticles();
            }
        }
    });

    renderSavedArticles();
    return div;
}
        
        // REMPLACEZ VOTRE FONCTION createStep6View EXISTANTE PAR CELLE-CI :
// ==================== REMPLACEZ TOUTE LA FONCTION createStep6View ====================
// ==================== REMPLACEZ VOTRE FONCTION createStep6View PAR CELLE-CI (VERSION CORRIG√âE) ====================
function createStep6View() {
    const config = stepsConfig.step6;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    if (!journalData.step6.projets || !Array.isArray(journalData.step6.projets)) {
        journalData.step6.projets = [];
    }
    
    // Objet temporaire pour l'atelier en cours
    let currentExploration = { formation: '', brouillon: '', analyse: '' };

    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${config.action}</div></div>

        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">‚úçÔ∏è Atelier du R√©viseur de Projet</h2>
            <div class="mb-4">
                <label for="current-formation" class="block text-md font-medium text-slate-700 mb-2">Formation vis√©e (pour donner du contexte √† l'IA)</label>
                <input type="text" id="current-formation" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: BUT Informatique - IUT de Villetaneuse">
            </div>
             <div class="mb-4">
                <label for="current-brouillon" class="block text-md font-medium text-slate-700 mb-2">Colle ici ton brouillon de projet de formation motiv√©</label>
                <textarea id="current-brouillon" rows="12" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="√âcris ou colle ici ton texte complet..."></textarea>
            </div>
            <div class="text-center mb-4">
                <button type="button" id="review-draft-btn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üîç Lancer la relecture critique</button>
            </div>
            <div id="loader-review" class="hidden my-4"><div class="loader"></div></div>
            <div id="review-result-container" class="hidden">
                 <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">Annotations et conseils cibl√©s :</h3>
                 <div id="review-result" class="p-4 bg-background-light border rounded-lg prose prose-sm max-w-none"></div>
            </div>
            <button type="button" id="save-projet-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">üíæ Enregistrer ce projet de candidature</button>
        </div>

        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes Projets Enregistr√©s</h2>
        <div id="saved-projets-container" class="space-y-3"></div>
    `;

    // --- Fonctions de l'atelier ---

    const renderSavedProjets = () => {
        const container = div.querySelector('#saved-projets-container');
        const projets = journalData.step6.projets || [];
        if (projets.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Aucun projet enregistr√©.</p>`;
            return;
        }
        container.innerHTML = projets.map((projet, index) => {
            const deleteButtonHTML = `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step6" data-entry-index="${index}">üóëÔ∏è</button>`;
            return `<details class="bg-background-light rounded-lg border border-border-subtle">
                        <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                            <span>${projet.formation}</span>
                            ${deleteButtonHTML}
                        </summary>
                        <div class="p-3 border-t">
                            <h4 class="font-semibold mb-1">Brouillon :</h4>
                            <p class="whitespace-pre-wrap text-sm mb-3 p-2 bg-white rounded border">${projet.brouillon}</p>
                            <h4 class="font-semibold mb-1">Analyse de l'IA :</h4>
                            <div class="prose prose-sm max-w-none">${marked.parse(projet.analyse || '')}</div>
                        </div>
                    </details>`;
        }).join('');
    };

    const resetWorkspace = () => {
        currentExploration = { formation: '', brouillon: '', analyse: '' };
        div.querySelector('#current-formation').value = '';
        div.querySelector('#current-brouillon').value = '';
        div.querySelector('#review-result-container').classList.add('hidden');
        div.querySelector('#review-result').innerHTML = '';
    };

    // --- √âcouteurs d'√©v√©nements ---

    div.querySelector('#review-draft-btn').addEventListener('click', async () => {
        const formation = div.querySelector('#current-formation').value.trim();
        const brouillon = div.querySelector('#current-brouillon').value.trim();
        const loader = div.querySelector('#loader-review');
        const resultContainer = div.querySelector('#review-result-container');
        const resultDiv = div.querySelector('#review-result');
        
        if (!formation || !brouillon) {
            showInfoModal("Veuillez renseigner la formation vis√©e ET votre brouillon.");
            return;
        }

        loader.style.display = 'block';
        resultContainer.classList.add('hidden');
        
        const prompt = `
            Agis comme un conseiller d'orientation expert et un coach en √©criture bienveillant, charg√© de relire le "projet de formation motiv√©" d'un(e) lyc√©en(ne).

            # Contexte
            - **Profil de l'√©l√®ve :** \${getProfileSummary()}
            - **Comp√©tences identifi√©es :** \${journalData.step10.skills_synthesis || 'Non renseign√©es'}
            - **Formation vis√©e :** "\${formation}"
            - **Brouillon de l'√©l√®ve :** """\${brouillon}"""

            # Ta Mission (R√àGLE ABSOLUE)
            Tu ne dois **JAMAIS r√©√©crire** le texte √† la place de l'√©l√®ve. Ton unique mission est de fournir des **annotations et des conseils cibl√©s** pour l'aider √† am√©liorer LUI-M√äME son texte.

            # Format de Sortie OBLIGATOIRE
            Ta r√©ponse doit √™tre une liste √† puces au format Markdown. Chaque point doit suivre cette structure :
            1.  **Citation Courte :** Cite une phrase ou un passage pr√©cis du brouillon entre guillemets.
            2.  **Analyse Critique :** Fais une remarque constructive sur ce passage (ex: "un peu vague", "excellent point", "ton familier").
            3.  **Suggestion d'Action :** Pose une question ou donne un conseil concret pour que l'√©l√®ve am√©liore ce point pr√©cis. Fais le lien avec son portfolio, les "attendus" de la formation ou son profil quand c'est pertinent.

            # Exemples de retours attendus :
            - > **"J'ai toujours √©t√© passionn√© par l'informatique"** : Cette phrase est un peu vague. Pourrais-tu donner un exemple concret tir√© de ton portfolio qui montre cette passion ? (un projet personnel, un cours que tu as aim√©...).
            - > **"Je suis tr√®s motiv√© pour rejoindre votre formation"** : Excellent point ! Essaie de lier cette motivation directement √† un des 'attendus' de la formation ou √† une sp√©cificit√© du programme qui t'int√©resse particuli√®rement.
            - > **"Franchement, j'ai trop envie d'apprendre √† coder"** : Le ton est un peu trop familier ici. Essaie de reformuler de mani√®re plus formelle, par exemple : "Je suis particuli√®rement d√©sireux d'acqu√©rir de solides comp√©tences en d√©veloppement...".
        `;

        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });

        loader.style.display = 'none';
        resultContainer.classList.remove('hidden');
        resultDiv.innerHTML = marked.parse(result);
        currentExploration.analyse = result;
    });

    div.querySelector('#save-projet-btn').addEventListener('click', async () => {
        currentExploration.formation = div.querySelector('#current-formation').value.trim();
        currentExploration.brouillon = div.querySelector('#current-brouillon').value.trim();
        if (!currentExploration.formation || !currentExploration.brouillon) {
            showInfoModal("Veuillez renseigner la formation et le brouillon avant d'enregistrer.");
            return;
        }
        journalData.step6.projets.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(40);
        renderSavedProjets();
        resetWorkspace();
        showSurpriseModal("Projet sauvegard√© !", "Cette pr√©paration est maintenant dans ton journal.", 3000);
    });

    div.addEventListener('click', async (e) => {
        const deleteBtn = e.target.closest('.delete-journal-entry');
        if (deleteBtn) {
            const index = parseInt(deleteBtn.dataset.entryIndex, 10);
            if (await showConfirmationModal("Es-tu s√ªr de vouloir supprimer ce projet de candidature ?")) {
                journalData.step6.projets.splice(index, 1);
                await saveData();
                renderSavedProjets();
            }
        }
    });

    renderSavedProjets();
    return div;
}


function createStep7View() {
    const config = stepsConfig.step7;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    let quizData = [];
    let currentQuestionIndex = 0;
    let score = 0;

    if (!journalData.step7.scores) {
        journalData.step7.scores = {};
    }

    // --- AFFICHE L'√âCRAN DE CHOIX DES 3 ATELIERS ---
    const renderChoiceView = () => {
        let choiceHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div id="start-generic-quiz" class="p-6 bg-white rounded-lg border border-border-subtle cursor-pointer hover:shadow-lg transition text-center flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-OrIAntation-darkblue">Atelier 1 : Vrai ou Faux ?</h3>
                    <p class="text-sm text-slate-600 mt-2">Teste tes connaissances sur un domaine et d√©construis les mythes.</p>
                </div>
                <div id="start-personalized-quiz" class="p-6 bg-white rounded-lg border border-border-subtle cursor-pointer hover:shadow-lg transition text-center flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-OrIAntation-darkblue">Atelier 2 : Le D√©fi Personnalis√©</h3>
                    <p class="text-sm text-slate-600 mt-2">Confronte ton profil aux id√©es re√ßues sur un m√©tier ou une fili√®re.</p>
                </div>
                <div id="start-intruder-quiz" class="p-6 bg-white rounded-lg border border-border-subtle cursor-pointer hover:shadow-lg transition text-center flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-OrIAntation-darkblue">Atelier 3 : Trouvez l'Intrus</h3>
                    <p class="text-sm text-slate-600 mt-2">Parmi 4 affirmations, d√©masque la seule qui est fausse (quiz de 5 questions).</p>
                </div>
            </div>
        `;
        let historyHTML = '';
        const scores = journalData.step7.scores;
        if (scores && Object.keys(scores).length > 0 && Object.values(scores).some(h => h.length > 0)) {
            historyHTML += `<div class="mt-8 border-t pt-6"><h2 class="text-xl font-bold text-OrIAntation-darkblue text-center mb-4">Mon Historique de Scores</h2><div class="space-y-4">`;
            for (const [domain, scoreHistory] of Object.entries(scores)) {
                if (scoreHistory && scoreHistory.length > 0) {
                    historyHTML += `<div class="bg-background-light p-4 rounded-lg border border-border-subtle"><h3 class="font-semibold text-cyan-700">${domain}</h3><ul class="text-sm text-slate-600 mt-2 space-y-3">`;
                    scoreHistory.forEach(entry => {
                        historyHTML += `<li><div class="flex justify-between items-center"><span>Le ${entry.date}</span><strong class="text-base">${entry.score}/${entry.total}</strong></div>`;
                        if (entry.notes && entry.notes.trim() !== '') { historyHTML += `<p class="text-xs text-slate-500 italic border-l-2 border-border-subtle pl-2 mt-1">${entry.notes}</p>`; }
                        historyHTML += `</li>`;
                    });
                    historyHTML += `</ul></div>`;
                }
            }
            historyHTML += `</div></div>`;
        }
        form.innerHTML = choiceHTML + historyHTML;
        div.querySelector('#start-generic-quiz').addEventListener('click', () => startQuiz('generic'));
        div.querySelector('#start-personalized-quiz').addEventListener('click', () => startQuiz('personalized'));
        div.querySelector('#start-intruder-quiz').addEventListener('click', () => startIntruderQuiz());
    };

    // --- LANCE UN QUIZ DE TYPE VRAI/FAUX ---
    const startQuiz = (type) => {
        if (type === 'personalized' && (!journalData.step0 || !journalData.step0.analysis)) {
            showInfoModal("Action requise", "Pour lancer le D√©fi Personnalis√©, veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'.");
            return;
        }
        form.innerHTML = `<div class="mb-6"><label for="domaine" class="block text-md font-medium text-slate-700 mb-2">Sur quel domaine ou m√©tier souhaites-tu lancer le quiz ?</label><input type="text" id="domaine" name="domaine" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Les √©tudes de droit..." value="${journalData.step7.domaine || ''}"></div><div class="text-center"><button type="button" id="generateQuizBtn" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">Lancer le Quiz Vrai/Faux</button></div><div id="quizContainer" class="mt-6"></div><div id="quizLoader" class="hidden"><div class="loader"></div></div>`;
        form.querySelector('#generateQuizBtn').addEventListener('click', () => generateQuiz(type));
    };
    
    // --- G√âN√àRE LE QUIZ VRAI/FAUX VIA L'IA ---
    const generateQuiz = async (type) => {
        const domain = form.querySelector('#domaine').value.trim();
        if (!domain) { showInfoModal("Action requise", "Veuillez entrer un domaine."); return; }
        journalData.step7.domaine = domain;
        if (!journalData.step7.scores[domain]) journalData.step7.scores[domain] = [];
        const loader = form.querySelector('#quizLoader');
        const quizContainer = form.querySelector('#quizContainer');
        loader.style.display = 'block';
        quizContainer.innerHTML = '';
        let prompt = '';
        if (type === 'personalized') {
            prompt = `Agis comme un coach perspicace qui cr√©e un "D√©fi Personnalis√©" pour un √©l√®ve. Ton but n'est pas de tester ses connaissances sur un domaine, mais de le faire r√©fl√©chir sur son propre profil en le confrontant √† des id√©es re√ßues. Voici son profil : "${journalData.step0.analysis}". Et le domaine qui l'int√©resse : "${domain}". Ta mission est de g√©n√©rer 5 affirmations qui cr√©ent une tension productive entre son profil et les st√©r√©otypes du domaine. Chaque affirmation doit √™tre une question directe pour l'√©l√®ve. Exemple : Si l'√©l√®ve est "introverti" et le domaine est "commerce", une affirmation pourrait √™tre : "En tant que personne qui se ressource seule, le contact permanent avec les clients dans le commerce serait √©puisant pour toi.". <Format de Sortie (JSON Strict)>Retourne UNIQUEMENT un tableau JSON valide avec 5 objets, chacun avec les cl√©s : "affirmation", "reponse" (true/false), "explication", "le_savais_tu", "etape_suggeree".</Format>`;
        } else {
            prompt = `G√©n√®re un quiz de 5 affirmations "vrai ou faux" sur les mythes du domaine : "${domain}". <Format de Sortie (JSON Strict)>Retourne UNIQUEMENT un tableau JSON valide avec exactement 5 objets. Chaque objet DOIT contenir les cl√©s : "affirmation", "reponse" (true/false), "explication", "le_savais_tu", "etape_suggeree".</Format>`;
        }
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true // Tr√®s important ici, car on attend un quiz au format JSON
});
        try {
            const parsedResult = extractJsonFromString(result);
            if (!parsedResult || !Array.isArray(parsedResult) || parsedResult.length !== 5) { throw new Error("La structure du quiz est invalide."); }
            quizData = parsedResult;
            currentQuestionIndex = 0;
            score = 0;
            renderQuestion(currentQuestionIndex, type);
        } catch (error) {
            console.error("Erreur du quiz Vrai/Faux:", error);
            quizContainer.innerHTML = `<p class="text-red-500 text-center">D√©sol√©, une erreur est survenue. Veuillez r√©essayer.</p>`;
        } finally {
            loader.style.display = 'none';
        }
    };
    
    // --- AFFICHE UNE QUESTION VRAI/FAUX ---
    const renderQuestion = (index, type) => {
        const quizContainer = form.querySelector('#quizContainer');
        const question = quizData[index];
        const domain = journalData.step7.domaine;
        const scoreHistory = journalData.step7.scores[domain] || [];
        let bestScoreHTML = '';
        if (scoreHistory.length > 0) {
            const bestScore = Math.max(...scoreHistory.map(s => s.score));
            bestScoreHTML = `<p class="text-sm text-center text-slate-500 mb-4">Ton record pour ce th√®me : <span class="font-bold">${bestScore}/${quizData.length}</span></p>`;
        }
        quizContainer.innerHTML = `
            <div class="bg-background-light p-6 rounded-lg border border-border-subtle">
                ${bestScoreHTML}
                <p class="text-center font-semibold text-OrIAntation-darkblue text-lg mb-4">Question ${index + 1} / ${quizData.length}</p>
                <p class="text-center text-slate-600 mb-6">"${question.affirmation}"</p>
                <div class="flex justify-center gap-4">
                    <button type="button" data-answer="true" class="answer-btn bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600 transition">Oui</button>
                    <button type="button" data-answer="false" class="answer-btn bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">Non</button>
                </div>
                <div id="explanationContainer" class="mt-6"></div>
            </div>`;
        quizContainer.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', (e) => checkAnswer(e.target.dataset.answer === 'true', index, type));
        });
    };

    // --- V√âRIFIE LA R√âPONSE VRAI/FAUX ET AFFICHE LES INFOS ENRICHIES ---
    const checkAnswer = (userAnswer, index, type) => {
        const question = quizData[index];
        const isCorrect = userAnswer === question.reponse;
        if (isCorrect) score++;
        const explanationContainer = form.querySelector('#explanationContainer');
        const feedbackColor = isCorrect ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
        let feedbackText = '';
        if (type === 'personalized') {
            feedbackText = isCorrect ? "Exactement !" : "Tu te sous-estimes !";
        } else {
            feedbackText = isCorrect ? 'Bonne r√©ponse !' : 'C\'est un mythe !';
        }
        let funFactHTML = '';
        if (question.le_savais_tu) { funFactHTML = `<div class="mt-4 p-3 bg-sky-50 border-t border-b border-sky-200"><p class="font-bold text-sky-700 text-sm">üí° Le Savais-tu ?</p><p class="text-slate-600 text-sm mt-1">${question.le_savais_tu}</p></div>`; }
        let gatewayHTML = '';
        if (question.etape_suggeree) {
            const targetStep = allSteps.find(step => step.title.includes(question.etape_suggeree));
            if (targetStep) { gatewayHTML = `<div class="mt-4 text-center"><button type="button" onclick="window.showView('${targetStep.id}')" class="text-sm bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Explorer l'√©tape "${targetStep.title}" üöÄ</button></div>`; }
        }
        explanationContainer.innerHTML = `<div class="p-4 rounded-lg border-l-4 ${feedbackColor}"><h4 class="font-bold text-OrIAntation-darkblue">${feedbackText}</h4><p class="text-slate-700 mt-2">${question.explication}</p></div>${funFactHTML}${gatewayHTML}<div class="text-center mt-4"><button type="button" id="nextQuestionBtn" class="bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-cyan-700 transition">${(index + 1 === quizData.length) ? 'Voir mon score' : 'Question suivante'}</button></div>`;
        explanationContainer.querySelector('#nextQuestionBtn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) { renderQuestion(currentQuestionIndex, type); } else { renderFinalScore(); }
        });
        form.querySelectorAll('.answer-btn').forEach(btn => btn.disabled = true);
    };

    // --- FONCTIONS POUR LE NOUVEAU MODE "TROUVEZ L'INTRUS" ---
    const startIntruderQuiz = () => {
        form.innerHTML = `<div class="mb-6"><label for="domaine" class="block text-md font-medium text-slate-700 mb-2">Sur quel domaine ou m√©tier souhaites-tu lancer le quiz ?</label><input type="text" id="domaine" name="domaine" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Les m√©tiers de l'ing√©nierie..." value="${journalData.step7.domaine || ''}"></div><div class="text-center"><button type="button" id="generateIntruderBtn" class="bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-700 transition">Lancer le Quiz "Trouvez l'Intrus"</button></div><div id="quizContainer" class="mt-6"></div><div id="quizLoader" class="hidden"><div class="loader"></div></div>`;
        form.querySelector('#generateIntruderBtn').addEventListener('click', generateIntruderQuiz);
    };
    const generateIntruderQuiz = async () => {
        const domain = form.querySelector('#domaine').value.trim();
        if (!domain) { showInfoModal("Action requise", "Veuillez entrer un domaine."); return; }
        journalData.step7.domaine = `${domain} (Intrus)`;
        if (!journalData.step7.scores[journalData.step7.domaine]) journalData.step7.scores[journalData.step7.domaine] = [];
        const loader = form.querySelector('#quizLoader');
        const quizContainer = form.querySelector('#quizContainer');
        loader.style.display = 'block';
        quizContainer.innerHTML = '';
        const prompt = `Agis comme un concepteur de quiz. Pour le domaine : "${domain}", cr√©e une s√©rie de 5 questions "Trouvez l'Intrus". <Format de Sortie (JSON Strict)>Ta r√©ponse DOIT √™tre un unique tableau JSON de 5 objets. Chaque objet doit contenir les cl√©s "affirmations" (un tableau de 4 objets {texte: "...", estVrai: true/false}) et "explication" (un string).</Format>`;
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true // Tr√®s important ici, car on attend un quiz au format JSON
});     
   try {
            const parsedResult = extractJsonFromString(result);
            if (!parsedResult || !Array.isArray(parsedResult) || parsedResult.length !== 5) { throw new Error("La structure du quiz est invalide."); }
            quizData = parsedResult;
            currentQuestionIndex = 0;
            score = 0;
            renderIntruderQuestion(currentQuestionIndex);
        } catch (error) {
            console.error("Erreur du quiz Intrus:", error);
            quizContainer.innerHTML = `<p class="text-red-500 text-center">D√©sol√©, une erreur est survenue. Veuillez r√©essayer.</p>`;
        } finally {
            loader.style.display = 'none';
        }
    };
    const renderIntruderQuestion = (index) => {
        const quizContainer = form.querySelector('#quizContainer');
        const question = quizData[index];
        const answersHTML = question.affirmations.map((affirmation, i) => `<button type="button" data-index="${i}" class="intruder-answer-btn text-left p-4 my-2 bg-white border border-slate-300 rounded-lg hover:bg-cyan-100 hover:border-cyan-400 transition">${affirmation.texte}</button>`).join('');
        quizContainer.innerHTML = `<div class="bg-background-light p-6 rounded-lg border border-border-subtle"><p class="text-center font-semibold text-OrIAntation-darkblue text-lg mb-4">Trouvez l'intrus ! (Question ${index + 1} / 5)</p><p class="text-center text-slate-600 mb-6">Parmi ces quatre affirmations, une seule est fausse. Laquelle ?</p><div class="flex flex-col">${answersHTML}</div><div id="explanationContainer" class="mt-6"></div></div>`;
        quizContainer.querySelectorAll('.intruder-answer-btn').forEach(btn => btn.addEventListener('click', (e) => checkIntruderAnswer(parseInt(e.target.dataset.index), index)));
    };
    const checkIntruderAnswer = (selectedIndex, questionIndex) => {
        const question = quizData[questionIndex];
        const isCorrect = !question.affirmations[selectedIndex].estVrai;
        if (isCorrect) score++;
        const explanationContainer = form.querySelector('#explanationContainer');
        const feedbackColor = isCorrect ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
        const feedbackText = isCorrect ? 'Bien vu, c\'√©tait bien l\'intrus !' : 'Dommage, ce n\'√©tait pas celui-l√† !';
        explanationContainer.innerHTML = `<div class="p-4 rounded-lg border-l-4 ${feedbackColor}"><h4 class="font-bold text-OrIAntation-darkblue">${feedbackText}</h4><p class="text-slate-700 mt-2">${question.explication}</p></div><div class="text-center mt-4"><button type="button" id="nextQuestionBtn" class="bg-cyan-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-cyan-700 transition">${(questionIndex + 1 === quizData.length) ? 'Voir mon score' : 'Question suivante'}</button></div>`;
        explanationContainer.querySelector('#nextQuestionBtn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) { renderIntruderQuestion(currentQuestionIndex); } else { renderFinalScore(); }
        });
        form.querySelectorAll('.intruder-answer-btn').forEach((btn, index) => {
            btn.disabled = true;
            if (!question.affirmations[index].estVrai) {
                btn.classList.add('bg-red-200', 'border-red-400'); // L'intrus
            } else if (index === selectedIndex) {
                btn.classList.add('bg-slate-200'); // La mauvaise r√©ponse de l'utilisateur
            } else {
                btn.classList.add('bg-green-100'); // Les bonnes r√©ponses restantes
            }
        });
    };
    
    // --- FONCTION DE FIN DE QUIZ, COMMUNE AUX DEUX MODES ---
    const renderFinalScore = () => {
        const quizContainer = form.querySelector('#quizContainer');
        const domain = journalData.step7.domaine;
        const scoreHistory = journalData.step7.scores[domain] || [];
        const oldBestScore = scoreHistory.length > 0 ? Math.max(...scoreHistory.map(s => s.score)) : -1;
        const newScoreEntry = { score: score, total: quizData.length, date: new Date().toISOString().split('T')[0], notes: '' };
        let recordMessage = score > oldBestScore ? `<p class="text-green-600 font-semibold mt-2">üéâ Nouveau record !</p>` : '';
        quizContainer.innerHTML = `<div class="text-center bg-background-light p-6 rounded-lg border border-border-subtle"><h3 class="text-xl font-bold text-OrIAntation-darkblue">Quiz termin√© !</h3><p class="text-slate-600 mt-4">Ton score :</p><p class="text-3xl font-bold text-cyan-700 my-1">${score} / ${quizData.length}</p>${recordMessage}<hr class="my-6"><p class="text-slate-600 mb-2">Note ici ce que tu as appris d'important :</p><textarea id="reflexions" rows="4" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ce qui m'a surpris, ce que je retiens..."></textarea></div><button type="button" id="save-quiz-results-btn" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Enregistrer et revenir aux ateliers</button>`;
        quizContainer.querySelector('#save-quiz-results-btn').addEventListener('click', async () => {
            const notes = quizContainer.querySelector('#reflexions').value.trim();
            newScoreEntry.notes = notes;
            journalData.step7.scores[domain].push(newScoreEntry);
            await saveData();
            const xpGained = score * 5;
            if (xpGained > 0) await grantXp(xpGained);
            renderChoiceView();
        });
    };

    // --- AFFICHE LA PREMI√àRE VUE AU CHARGEMENT ---
    renderChoiceView();
    return div;
}


// ==============================================================================
// BLOC FINAL (V2) POUR L'√âTAPE 8 : CORRECTION DU PROBL√àME DE LECTURE AUDIO
// ==============================================================================

function createStep8View() {
    const config = stepsConfig.step8;
    const div = document.createElement('div');
    div.className = 'fade-in';

    // R√©f√©rence au lecteur audio global
    const audioPlayer = document.getElementById('tts-audio-player');


async function speakText(text, messageWrapper) {
    try {
        // --- NOUVELLE LOGIQUE DE CONTR√îLE ---
        // 1. On s'assure que le micro est bien coup√© AVANT de faire quoi que ce soit.
        if (isConversationModeActive) {
            recognition.stop(); 
        }

        const generateSpeech = httpsCallable(functions, 'generateSpeech');
        const result = await generateSpeech({ text: text });
        
        if (result.data && result.data.audioContent) {
            const audioSrc = `data:audio/mpeg;base64,${result.data.audioContent}`;
            audioPlayer.src = audioSrc;

            audioPlayer.onloadedmetadata = () => {
                const duration = audioPlayer.duration;
                const words = text.split(/\s+/);
                const wordCount = words.length;
                const delay = (duration * 1000) / wordCount;

                const textContainer = document.createElement('p');
                messageWrapper.innerHTML = '';
                messageWrapper.className = 'bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs';
                messageWrapper.appendChild(textContainer);

                let wordIndex = 0;
                audioPlayer.play();

                // 2. On r√©active le micro SEULEMENT quand l'IA a fini de parler.
                audioPlayer.onended = () => {
                    if (isConversationModeActive) {
                        console.log("IA a fini de parler, r√©activation de l'√©coute...");
                        recognition.start(); // On relance l'√©coute pour le tour de l'√©l√®ve.
                    }
                    audioPlayer.onended = null; // On nettoie l'√©v√©nement.
                };

                const interval = setInterval(() => {
                    if (wordIndex < wordCount) {
                        textContainer.textContent += words[wordIndex] + ' ';
                        wordIndex++;
                    } else {
                        clearInterval(interval);
                    }
                }, delay);
            };
        } else {
            throw new Error("La r√©ponse de la fonction est vide.");
        }
    } catch (error) {
        messageWrapper.innerHTML = `<div class="bg-red-100 text-red-800 p-3 rounded-lg max-w-xs"><p>Erreur audio. Voici le message : ${text}</p></div>`;
        console.error("Erreur de la voix OpenAI :", error);
    }
}

    // Initialisation de la structure de donn√©es
    if (!journalData.step8.preparations || !Array.isArray(journalData.step8.preparations)) {
        journalData.step8.preparations = [];
    }

    // Variables de state pour la simulation
    let conversationHistory = [];
    let currentSimPro = '';
    let currentExploration = { pro: '', question: '', suggestions: '' };

    // --- Structure HTML compl√®te de la page ---
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><div class="font-semibold text-cyan-900">${config.action}</div></div>
        
        <div class="mb-8">
            <a href="https://www.myjobglasses.com/" target="_blank" class="inline-block bg-cyan-100 text-cyan-800 font-semibold py-2 px-4 rounded-lg hover:bg-cyan-200 transition">Visiter MyJobGlasses ‚Üó</a>
        </div>

        <div id="workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
            <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Atelier de Pr√©paration d'Entretien</h2>
            <div class="mb-4"><label for="current-pro" class="block text-md font-medium">Professionnel ou secteur vis√©</label><input type="text" id="current-pro" class="w-full mt-1 p-3 border rounded-lg" placeholder="Ex: Avocat, Ing√©nieur..."></div>
            <div class="mb-4"><label for="current-question" class="block text-md font-medium">Ma question principale</label><textarea id="current-question" rows="2" class="w-full mt-1 p-3 border rounded-lg" placeholder="Quelle est la plus grande difficult√© de votre m√©tier ?"></textarea></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <button type="button" id="generate-questions-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">‚ú® Obtenir des questions</button>
                <button type="button" id="launch-sim-btn" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600">üöÄ Lancer la simulation</button>
            </div>
            <div id="loader" class="hidden"><div class="loader"></div></div>
            <div id="result" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] prose prose-sm max-w-none"></div>
            <button type="button" id="save-preparation-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700">üíæ Enregistrer cette pr√©paration</button>
        </div>
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes Pr√©parations Enregistr√©es</h2>
        <div id="saved-preparations-container" class="space-y-3 mb-8"></div>

        <div id="simulation-modal" class="simulation-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
             <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg flex flex-col h-[80vh]">
                <div class="flex items-center justify-between p-4 border-b bg-background-light rounded-t-2xl"><h3 class="font-bold text-OrIAntation-darkblue">ü§ñ Simulation d'entretien</h3><button id="simulation-close" class="text-slate-500 hover:text-OrIAntation-darkblue text-2xl">&times;</button></div>
                <div id="simulation-messages" class="flex-1 p-4 overflow-y-auto simulation-message-container"></div>
                <form id="simulation-form" class="p-4 border-t flex items-center gap-2"><input type="text" id="simulation-input" placeholder="√âcris ta r√©ponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none"><button type="submit" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button></form>
            </div>
        </div>
    `;
    
    // --- S√©lection des √©l√©ments DOM ---
    const savedContainer = div.querySelector('#saved-preparations-container');
    const simulationModal = div.querySelector('#simulation-modal');
    const simulationMessages = div.querySelector('#simulation-messages');
    
    // --- Fonction d'affichage des messages ---
    const addSimMessage = (sender) => {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = 'flex mb-4';
        const messageBubble = document.createElement('div');

        if (sender === 'user') {
            messageWrapper.classList.add('justify-end');
        } else { // Pour 'ai'
            // Affiche une bulle de chargement en attendant l'audio
            messageBubble.className = 'bg-cyan-100 p-3 rounded-lg';
            messageBubble.innerHTML = `<div class="chatbot-loader"></div>`;
        }
        
        messageWrapper.appendChild(messageBubble);
        simulationMessages.appendChild(messageWrapper);
        simulationMessages.scrollTop = simulationMessages.scrollHeight;
        return messageBubble; // Retourne la bulle pour la remplir plus tard
    };
    
    // --- Fonctions utilitaires ---
    const renderSavedPreparations = () => {
        const preparations = journalData.step8.preparations || [];
        if (preparations.length === 0) {
            savedContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Tu n'as pas encore de pr√©paration enregistr√©e.</p>`;
        } else {
            savedContainer.innerHTML = preparations.map((item, index) => `
                <details class="bg-background-light rounded-lg border border-border-subtle">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${item.pro}</span>
                        <button type="button" data-index="${index}" class="delete-preparation-btn text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer">üóëÔ∏è</button>
                    </summary>
                    <div class="p-3 border-t border-border-subtle prose prose-sm max-w-none">
                        <p><strong>Ma question :</strong> ${item.question}</p>
                        <p><strong>Suggestions de l'IA :</strong></p>
                        ${marked.parse(item.suggestions || '')}
                    </div>
                </details>
            `).join('');
        }
    };
    
    const resetWorkspace = () => {
        currentExploration = { pro: '', question: '', suggestions: '' };
        div.querySelector('#current-pro').value = '';
        div.querySelector('#current-question').value = '';
        div.querySelector('#result').innerHTML = '';
    };

    // --- Logique des √©v√©nements ---
    div.querySelector('#generate-questions-btn').addEventListener('click', async () => {
        const theme = div.querySelector('#current-pro').value.trim();
        const questionBase = div.querySelector('#current-question').value.trim();
        if (!theme || !questionBase || !journalData.step0.analysis) {
            showInfoModal("Veuillez renseigner le th√®me, votre question et avoir compl√©t√© l'√©tape 'Mieux se conna√Ætre'."); return;
        }
        const loader = div.querySelector('#loader');
        const resultDiv = div.querySelector('#result');
        loader.style.display = 'block';
        resultDiv.innerHTML = '';
        const prompt = `Agis comme un coach. Le profil d'un lyc√©en est : "${journalData.step0.analysis}". Il veut interroger un professionnel du secteur : "${theme}" et sa question de base est : "${questionBase}". Sugg√®re 5 questions pertinentes et percutantes √† poser. Formate en liste Markdown.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.innerHTML = marked.parse(result);
        currentExploration.suggestions = result;
    });
    
    div.querySelector('#launch-sim-btn').addEventListener('click', async () => {
        const silentMp3 = 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU2LjM2LjEwMAAAAAAAAAAAAAAA//OEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV6urq6urq6urq6urq6urq6urq6urq6urq6v////////////////////////////////8AAAAATGF2YzU2LjQxAAAAAAAAAAAAAAAAJAAAAAAAAAAAASDs90hvAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAAAAAAAA0gAAAAATEFN//MUZAMAAAGkAAAAAAAAA0gAAAAARTMu//MUZAYAAAGkAAAAAAAAA0gAAAAA';
        if (audioPlayer.paused) { audioPlayer.src = silentMp3; audioPlayer.play().catch(() => {}); }
        
        currentSimPro = div.querySelector('#current-pro').value.trim();
        if (!currentSimPro) { showInfoModal("Veuillez d'abord renseigner un professionnel ou un secteur."); return; }
        
        conversationHistory = [];
        simulationMessages.innerHTML = '';
        simulationModal.classList.remove('hidden');
        simulationModal.classList.add('flex');
        
        const loaderBubble = addSimMessage('ai');

        const startPrompt = `Tu es un recruteur exp√©riment√© du secteur "${currentSimPro}". Un lyc√©en d√©marre une simulation d'entretien avec toi. Ton ton doit √™tre professionnel, direct et encourageant. Sois concis et va droit au but. √âvite les phrases trop longues ou un style trop litt√©raire. Commence par une br√®ve salutation, puis pose imm√©diatement ta premi√®re question d'entretien, qui doit √™tre ouverte et pertinente.`;        
        const firstMessage = await callOpenAI_API({ promptText: startPrompt, withPersona: false });
        
        speakText(firstMessage, loaderBubble);
        conversationHistory.push({ role: 'model', parts: [{ text: firstMessage }] });
    });

    div.querySelector('#save-preparation-btn').addEventListener('click', async () => {
        currentExploration.pro = div.querySelector('#current-pro').value.trim();
        currentExploration.question = div.querySelector('#current-question').value.trim();
        // La suggestion est d√©j√† dans currentExploration via le bouton 'generate-questions'
        if (!currentExploration.pro) { showInfoModal("Veuillez renseigner un professionnel ou un secteur."); return; }
        journalData.step8.preparations.push(JSON.parse(JSON.stringify(currentExploration)));
        await saveData();
        await grantXp(20);
        renderSavedPreparations();
        resetWorkspace();
        showSurpriseModal("Pr√©paration sauvegard√©e !", "Elle est maintenant dans ton journal.", 3000);
    });
    
    div.querySelector('#saved-preparations-container').addEventListener('click', async (e) => {
        if (e.target.closest('.delete-preparation-btn')) {
            const index = e.target.closest('.delete-preparation-btn').dataset.index;
            if (await showConfirmationModal("S√ªr de vouloir supprimer cette pr√©paration ?")) {
                journalData.step8.preparations.splice(index, 1);
                await saveData();
                renderSavedPreparations();
            }
        }
    });

    div.querySelector('#simulation-close').addEventListener('click', () => {
    simulationModal.classList.add('hidden');
    simulationModal.classList.remove('flex');

    // 1. On coupe le son de l'IA si elle est en train de parler
    if (audioPlayer) {
        audioPlayer.pause();
        audioPlayer.src = '';
        // Tr√®s important : on supprime l'√©v√©nement pour √©viter qu'il ne relance le micro plus tard
        audioPlayer.onended = null; 
    }
    
    // 2. On coupe le micro de l'√©l√®ve s'il est actif
    if (recognition && isConversationModeActive) {
        recognition.stop();
    }

    // 3. On r√©initialise les √©tats pour dire que la conversation est bien termin√©e
    isConversationModeActive = false;
    isAISpeaking = false; 
});
    
    renderSavedPreparations();
    return div;
}

function createStep9View() {
    const config = stepsConfig.step9;
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // Initialisation des donn√©es si elles n'existent pas
    const defaults = {
        formation_reve: '',
        planb_chat_history: [],
        reussite_type: '',
        reussite_conseils: ''
    };
    journalData.step9 = { ...defaults, ...journalData.step9 };
    if (!Array.isArray(journalData.step9.planb_chat_history)) {
        journalData.step9.planb_chat_history = [];
    }
    
    // -- STRUCTURE HTML AVEC LES DEUX BOUTONS DE CHOIX --
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">${config.icon} <span>${config.title}</span></h1>       
        <div class="text-slate-600 mb-4 whitespace-pre-wrap">${config.description}</div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${config.action}</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <button type="button" data-workshop="planb" class="workshop-choice-btn bg-white p-6 rounded-lg border-2 border-slate-300 hover:border-cyan-500 hover:bg-cyan-50 transition flex flex-col items-center text-center">
                <span class="text-3xl mb-2">üöÄ</span>
                <span class="font-bold text-OrIAntation-darkblue">Mon Plan B</span>
                <span class="text-sm text-slate-500 mt-1">G√©rer les refus et pr√©parer la phase compl√©mentaire de Parcoursup.</span>
            </button>
            <button type="button" data-workshop="reussite" class="workshop-choice-btn bg-white p-6 rounded-lg border-2 border-slate-300 hover:border-cyan-500 hover:bg-cyan-50 transition flex flex-col items-center text-center">
                <span class="text-3xl mb-2">üéì</span>
                <span class="font-bold text-OrIAntation-darkblue">Mon Coach de R√©ussite</span>
                <span class="text-sm text-slate-500 mt-1">Obtenir des conseils pour bien d√©marrer sa premi√®re ann√©e dans le sup√©rieur.</span>
            </button>
        </div>

        <div id="planb-workshop" class="hidden workshop-container">
            <h2 class="text-xl font-semibold mb-4 text-OrIAntation-darkblue">Simulation : Mon Plan B</h2>
            <div class="mb-6">
                <label for="formation_reve" class="block text-md font-medium text-slate-700 mb-2">Mon v≈ìu principal (ou le domaine qui m'int√©ressait le plus)</label>
                <div class="flex gap-2">
                    <input type="text" id="formation_reve" name="formation_reve" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Classe pr√©pa MPSI" value="${journalData.step9.formation_reve || ''}">
                    <button type="button" id="startPlanBSimBtn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Lancer</button>
                </div>
            </div>
            <div id="planb-chat-container" class="bg-white p-4 rounded-lg border border-border-subtle min-h-[300px] flex flex-col">
                <div id="planb-chat-messages" class="flex flex-col flex-1 overflow-y-auto space-y-4 p-2"></div>
                <div id="planb-loader" class="hidden"><div class="loader"></div></div>
                <div id="planb-chat-controls" class="mt-4 flex items-center gap-2">
                    <input type="text" id="planb-input" placeholder="Ta r√©ponse..." class="flex-1 p-2 border rounded-lg focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                    <button type="button" id="planb-send-btn" class="bg-cyan-600 text-white p-2 rounded-lg font-semibold hover:bg-cyan-700">Envoyer</button>
                </div>
            </div>
        </div>

        <div id="reussite-workshop" class="hidden workshop-container">
            <h2 class="text-xl font-semibold mb-4 text-OrIAntation-darkblue">Mon Coach de R√©ussite</h2>
            <div class="mb-6">
                <label for="reussite_type" class="block text-md font-medium text-slate-700 mb-2">Type de formation pour lequel tu veux des conseils</label>
                <input type="text" id="reussite_type" name="reussite_type" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: Licence de Droit, BUT..." value="${journalData.step9.reussite_type || ''}">
            </div>
            <div class="text-center mb-4">
                <button type="button" id="openaiBtn_reussite" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">‚ú® Me coacher pour la 1√®re ann√©e</button>
            </div>
            <div id="openaiLoader_reussite" class="hidden"><div class="loader"></div></div>
            <div class="mb-6">
                <label for="reussite_conseils" class="block text-md font-medium text-slate-700 mb-2">Conseils de r√©ussite par OrIA</label>
                <textarea id="reussite_conseils" name="reussite_conseils" rows="8" class="w-full p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${journalData.step9.reussite_conseils || ''}</textarea>
            </div>
        </div>
    `;

    // -- LOGIQUE D'AFFICHAGE DES ATELIERS --
    const workshopContainers = div.querySelectorAll('.workshop-container');
    const workshopChoiceBtns = div.querySelectorAll('.workshop-choice-btn');

    workshopChoiceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const workshopType = btn.dataset.workshop;
            workshopChoiceBtns.forEach(b => {
                b.classList.remove('border-cyan-500', 'bg-cyan-50');
                b.classList.add('border-slate-300');
            });
            btn.classList.add('border-cyan-500', 'bg-cyan-50');
            btn.classList.remove('border-slate-300');

            workshopContainers.forEach(container => {
                container.classList.toggle('hidden', container.id !== `${workshopType}-workshop`);
            });
        });
    });
    
    // -- LOGIQUE DE L'ATELIER "PLAN B" --
    const chatMessages = div.querySelector('#planb-chat-messages');
    const chatInput = div.querySelector('#planb-input');
    const chatSendBtn = div.querySelector('#planb-send-btn');
    const chatControls = div.querySelector('#planb-chat-controls');
    const loader = div.querySelector('#planb-loader');

    const addChatMessage = (sender, text) => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `p-3 rounded-lg max-w-lg text-left ${sender === 'user' ? 'bg-blue-500 text-white self-end' : 'bg-slate-200 text-OrIAntation-darkblue self-start'}`;
        messageDiv.innerHTML = linkify(text);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const renderChatHistory = () => {
        chatMessages.innerHTML = '';
        if (journalData.step9.planb_chat_history) {
            journalData.step9.planb_chat_history.forEach(msg => addChatMessage(msg.role, msg.text));
        }
    };
    
    renderChatHistory();

    div.querySelector('#startPlanBSimBtn').addEventListener('click', async () => {
        const formation = div.querySelector('#formation_reve').value.trim();
        if (!formation) { showInfoModal("Veuillez d'abord renseigner votre v≈ìu principal ou le domaine qui vous int√©ressait."); return; }
        journalData.step9.formation_reve = formation;
        journalData.step9.planb_chat_history = [];
        renderChatHistory();
        loader.style.display = 'block';
        chatControls.style.display = 'none';

        const prompt = `
        Agis comme un coach d'orientation expert, empathique et tr√®s pragmatique. Un(e) √©l√®ve vient te voir car tous ses v≈ìux sur Parcoursup ont √©t√© refus√©s, ou il/elle souhaite tout changer pour la phase d'admission compl√©mentaire. Son v≈ìu principal √©tait : "${formation}". Son profil g√©n√©ral est : ${getProfileSummary()}.

        ## Ta Mission
        R√©dige ton premier message pour d√©marrer une conversation de "rebond". L'objectif est de l'aider √† construire une nouvelle strat√©gie pour la phase compl√©mentaire.

        ## Structure de ton message (imp√©ratif)
        1.  **Valide son √©motion :** Commence par une phrase courte et empathique qui reconna√Æt la d√©ception, sans √™tre dramatique. (Ex: "Recevoir ces r√©ponses peut √™tre un coup dur, c'est tout √† fait normal de se sentir d√©√ßu(e).")
        2.  **Pivote vers l'action :** Encha√Æne imm√©diatement en pr√©sentant la phase compl√©mentaire comme une opportunit√© et non comme un √©chec. (Ex: "Mais c'est aussi le moment de rebondir. La phase compl√©mentaire est une seconde chance pour trouver un projet qui te correspond.")
        3.  **Pose une question ouverte pour relancer la machine :** Termine par une question qui l'oblige √† r√©fl√©chir √† l'essentiel. (Ex: "Pour qu'on construise ensemble cette nouvelle strat√©gie, dis-moi : au-del√† de '${formation}', qu'est-ce qui t'attirait le plus dans ce projet ? Les mati√®res ? Le type de cours ? Les d√©bouch√©s ?")

        ## R√®gle Absolue
        Ne parle PAS au conditionnel. La situation est r√©elle. Ne dis PAS "imaginons que...", mais "maintenant que...".
        `;

        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        chatControls.style.display = 'flex';
        journalData.step9.planb_chat_history.push({ role: 'ai', text: result });
        addChatMessage('ai', result);
        await saveData();
    });

    const handleChatSubmit = async () => {
        const userInput = chatInput.value.trim();
        if (!userInput) return;
        journalData.step9.planb_chat_history.push({ role: 'user', text: userInput });
        addChatMessage('user', userInput);
        chatInput.value = '';
        loader.style.display = 'block';
        chatControls.style.display = 'none';
        
        const prompt = `
        Agis comme un coach d'orientation expert de la phase compl√©mentaire de Parcoursup.
        Continue cette conversation avec un(e) √©l√®ve dont les v≈ìux ont √©t√© refus√©s. L'historique de votre discussion est : ${JSON.stringify(journalData.step9.planb_chat_history)}.
        Son profil est : ${getProfileSummary()}.

        ## Ta Mission
        En te basant sur sa derni√®re r√©ponse, continue le dialogue pour l'aider √† construire sa nouvelle strat√©gie. Ton objectif est de l'amener vers des pistes concr√®tes et r√©alistes.

        ## Strat√©gie de Dialogue
        - Si l'√©l√®ve exprime encore sa d√©ception, √©coute-le mais essaie toujours de le ramener vers une question constructive.
        - Utilise les √©l√©ments de son profil et de ses r√©ponses pour sugg√©rer des pistes alternatives (formations similaires, BUT/BTS/Licences connexes, etc.).
        - Pose des questions qui l'aident √† hi√©rarchiser ses priorit√©s pour cette nouvelle phase (privil√©gier une ville ? un type de dipl√¥me ? un secteur ?).
        - Tu peux utiliser tes capacit√©s de recherche web pour v√©rifier si un type de formation est souvent disponible en phase compl√©mentaire.
        `;
        
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        chatControls.style.display = 'flex';
        journalData.step9.planb_chat_history.push({ role: 'ai', text: result });
        addChatMessage('ai', result);
        await saveData();
    };

    chatSendBtn.addEventListener('click', handleChatSubmit);
    chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleChatSubmit(); }});

    // -- LOGIQUE DE L'ATELIER "COACH DE R√âUSSITE" --
    div.querySelector('#openaiBtn_reussite').addEventListener('click', async () => {
        const reussiteTypeInput = div.querySelector('#reussite_type');
        const formationType = reussiteTypeInput.value.trim();
        const loader = div.querySelector('#openaiLoader_reussite');
        const resultTextarea = div.querySelector('#reussite_conseils');
        if (!formationType) { showInfoModal("Veuillez d'abord renseigner le type de formation."); return; }
        loader.style.display = 'block';
        resultTextarea.value = '';

        const prompt = `
        Agis comme le parrain ou la marraine de promo qui √©crit un message bienveillant et plein de bons conseils √† un lyc√©en sur le point d'entrer en premi√®re ann√©e de "${formationType}".

        Ta mission est de r√©diger un message fluide, encourageant et facile √† lire qui l'aide √† anticiper les d√©fis et √† mettre en place les bonnes strat√©gies d√®s le d√©but.

        Ton message doit s'articuler autour des th√®mes suivants, trait√©s dans des paragraphes distincts :

        1.  **La m√©thode de travail :** Explique la transition cl√© entre le lyc√©e et le sup√©rieur. Insiste sur l'importance de l'autonomie, du travail r√©gulier (m√™me quand il n'y a pas d'√©valuation imm√©diate) et de la curiosit√© (aller au-del√† du cours).
        
        2.  **L'√©quilibre et la vie sociale :** Donne un conseil sur l'importance de ne pas s'isoler. Sugg√®re des moyens concrets de s'int√©grer (associations √©tudiantes, travaux de groupe, √©v√©nements du campus) et de trouver un bon √©quilibre entre les √©tudes et la vie personnelle.

        3.  **Le pi√®ge n¬∞1 √† √©viter :** D√©cris le pi√®ge classique de la premi√®re ann√©e : la procrastination et le fait de se laisser d√©border par la quantit√© de travail. Explique pourquoi c'est un pi√®ge et donne une astuce simple pour y rem√©dier (ex: la r√®gle des "15 minutes par jour et par mati√®re").

        4.  **Pr√©parer l'avenir d√®s maintenant :** Termine par un conseil pour l'encourager √† voir plus loin que la premi√®re ann√©e. Sugg√®re-lui de se renseigner t√¥t sur les stages, les projets personnels ou les opportunit√©s qui pourraient enrichir son parcours.

        ## Formatage et Ton (R√®gles Imp√©ratives)

        - **Ton :** Le message doit √™tre r√©dig√© sur un ton naturel, comme si tu parlais √† un ami que tu souhaites voir r√©ussir. Utilise des phrases encourageantes.
        - **Structure :** Utilise des titres en gras (avec **) pour introduire chaque nouvelle id√©e. Par exemple : "**Ta nouvelle routine de travail**".
        - **Interdits :** N'utilise JAMAIS de listes √† puces (*), de listes num√©rot√©es (1., 2.), ou de titres avec des hashtags (#). La r√©ponse doit √™tre un texte unifi√© et fluide.
        `;

        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultTextarea.value = result;
        journalData.step9.reussite_conseils = result;
        await saveData();
    });
            
    return div;
}

function createStep10View() {
    const config = stepsConfig.step10;
    
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    div.innerHTML = `
        
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.07a2.25 2.25 0 0 1-2.25 2.25h-13.5a2.25 2.25 0 0 1-2.25-2.25v-4.07m18-4.32-7.5-5.25a2.25 2.25 0 0 0-2.013.003L2.25 9.83m18 4.32V9.83" />
        </svg>
        <span>${config.title}</span>
    </h1>
    <div class="text-slate-600 mb-4 whitespace-pre-wrap text-center">${config.description}</div>
    <form id="stepForm"></form> 
`;
    
    const form = div.querySelector('#stepForm');
    
    const description = config.description;
    const action = config.action;
    
    if (!journalData.step10 || typeof journalData.step10 !== 'object') {
        journalData.step10 = { experiences: [], soft_skills_profile: '', skills_synthesis: '' };
    }
    if (!Array.isArray(journalData.step10.experiences)) {
        journalData.step10.experiences = [];
    }

    let currentExperience = null;
    
    form.innerHTML = `
        <div class="bg-cyan-50 p-4 rounded-r-lg border-l-4 border-cyan-400 my-6">
            <h3 class="font-bold text-cyan-800">ü§î Profil vs. Comp√©tences : quelle est la diff√©rence ?</h3>
            <p class="text-sm text-slate-700 mt-2">
                √Ä l'√©tape "Mieux se conna√Ætre", tu as fait un autoportrait de ta personnalit√© (introverti ou extraverti, cr√©atif ou logique...). Ici, tu vas construire un portfolio qui montre concr√®tement ce que tu as appris √† faire.
            </p>
            <p class="text-sm text-slate-700 mt-2">
                Ton profil r√©pond √† la question **"Qui es-tu ?"**. Ton portfolio r√©pond √† la question **"Que sais-tu faire ?"**. Les deux sont essentiels pour un projet d'orientation solide et cr√©dible !
            </p>
        </div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6">
            <div class="font-semibold text-cyan-900">${action}</div>
        </div>
        <div class="mb-12">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Atelier 1 : Mes Exp√©riences Significatives</h2>
            <div id="experience-list-container" class="space-y-4 mb-6"></div>
            <button type="button" id="add-experience-btn" class="w-full bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">
                + Ajouter une exp√©rience
            </button>
        </div>
        <hr class="my-12 border-slate-300">
        <div>
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Atelier 2 : Mon Profil de Comp√©tences</h2>
            <div id="detector-container" class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle">
                <p class="text-slate-600 mb-4">R√©ponds √† quelques questions rapides pour r√©v√©ler tes comp√©tences transversales dominantes.</p>
                <button type="button" id="start-detector-btn" class="w-full bg-teal-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-teal-600 transition">
                    üß† Lancer le d√©tecteur
                </button>
                <div id="quiz-container" class="hidden mt-4"></div>
                <div id="detector-results-container" class="hidden mt-4"></div>
            </div>
        </div>
        
        <div id="connector-section" class="hidden mt-12 border-t-4 border-cyan-500 pt-6">
            <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">üîó Le Connecteur de Comp√©tences</h2>
            <p class="text-slate-600 mb-4">Bravo ! Maintenant que tu as analys√© tes exp√©riences ET ton profil, clique sur le bouton pour que OrIA r√©dige une synth√®se qui connecte tes savoir-faire (issus de tes exp√©riences) et tes savoir-√™tre (issus du quiz).</p>
            <div class="text-center">
<button type="button" id="connect-skills-btn" class="w-full bg-orange-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-orange-600 transition">Connecter mes comp√©tences</button>
            </div>
            <div id="loader-connector" class="hidden"><div class="loader"></div></div>
            <textarea id="skills-synthesis" name="skills_synthesis" rows="8" class="w-full mt-4 p-3 border border-slate-300 rounded-lg bg-background-light" readonly>${journalData.step10.skills_synthesis || ''}</textarea>
        </div>
        <button type="submit" class="w-full mt-8 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700 transition">‚úîÔ∏è Terminer et sauvegarder le portfolio</button>
        <div id="portfolio-modal" class="portfolio-modal hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-xl font-bold text-OrIAntation-darkblue">Assistant de Portfolio</h2>
                    <button type="button" id="portfolio-modal-close" class="text-slate-500 hover:text-OrIAntation-darkblue text-2xl">√ó</button>
                </div>
                <div class="p-6 overflow-y-auto">
                    <div id="wizard-step-1">
                        <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">√âtape 1 : D√©cris ton exp√©rience</h3><p class="text-slate-600 mb-4">Raconte un projet, un job, un engagement, une passion...</p><textarea id="experience-input" rows="6" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="Ex: J'ai organis√© un tournoi de jeux vid√©o..."></textarea><button type="button" id="wizard-next-1" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valider et identifier les comp√©tences ‚ú®</button>
                    </div>
                    <div id="wizard-step-2" class="hidden">
                         <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">√âtape 2 : Valide tes comp√©tences</h3><p class="text-slate-600 mb-4">Clique sur les comp√©tences qui te semblent les plus justes.</p><div id="skill-tags-container" class="flex flex-wrap gap-3 p-4 bg-background-light rounded-lg border min-h-[100px]"></div><div id="loader-2" class="hidden"><div class="loader"></div></div><button type="button" id="wizard-next-2" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">Valoriser ces comp√©tences üöÄ</button>
                    </div>
                    <div id="wizard-step-3" class="hidden">
                        <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">√âtape 3 : Voici ton texte valoris√© !</h3><p class="text-slate-600 mb-4">Utilise ce paragraphe dans tes lettres de motivation ou sur ton CV.</p><div id="loader-3" class="hidden"><div class="loader"></div></div><div id="portfolio-result" class="p-4 bg-background-light rounded-lg border whitespace-pre-wrap min-h-[150px]"></div><div class="flex gap-4"><button type="button" id="save-experience-btn" class="w-full mt-4 bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition">Enregistrer l'exp√©rience</button></div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const detectorContainer = div.querySelector('#detector-container');
    const startDetectorBtn = div.querySelector('#start-detector-btn');
    const quizContainer = div.querySelector('#quiz-container');
    const resultsContainer = div.querySelector('#detector-results-container');
    let userSoftSkills = [];
    let currentQuestionIndex = 0;

    const quizQuestions = [
        { question: "Face √† un projet complexe, ta premi√®re r√©action est de :", answers: [ { text: "Faire un plan d√©taill√© avec des √©tapes claires.", skill: "Planification" }, { text: "Commencer tout de suite pour voir ce qui marche.", skill: "Initiative" }, { text: "Imaginer plusieurs solutions originales.", skill: "Cr√©ativit√©" } ] },
        { question: "Dans un travail de groupe, tu as tendance √† :", answers: [ { text: "T'assurer que tout le monde s'entend bien.", skill: "Collaboration" }, { text: "Prendre les devants pour organiser les t√¢ches.", skill: "Leadership" }, { text: "Te concentrer sur la partie qui demande le plus de recherche.", skill: "Analyse" } ] },
        { question: "Quand tu ne comprends pas quelque chose, tu :", answers: [ { text: "Cherches la r√©ponse par toi-m√™me jusqu'√† la trouver.", skill: "Autonomie" }, { text: "Demandes de l'aide √† quelqu'un qui sait.", skill: "Communication" }, { text: "Essaies de voir le probl√®me sous un autre angle.", skill: "Adaptabilit√©" } ] },
        { question: "Un impr√©vu survient dans un projet. Que fais-tu ?", answers: [ { text: "Tu proposes rapidement un plan B.", skill: "Adaptabilit√©" }, { text: "Tu analyses la source du probl√®me pour qu'il ne se r√©p√®te pas.", skill: "Analyse" }, { text: "Tu rassures l'√©quipe et maintiens une bonne ambiance.", skill: "Intelligence √âmotionnelle" } ] },
        { question: "Laquelle de ces phrases te d√©crit le mieux ?", answers: [ { text: "J'aime quand les choses sont bien organis√©es.", skill: "Rigueur" }, { text: "J'aime convaincre les autres de mes id√©es.", skill: "Persuasion" }, { text: "J'aime apprendre de nouvelles choses constamment.", skill: "Curiosit√©" } ] },
        { question: "Face √† un grand changement (d√©m√©nagement, nouveau projet...), tu es plut√¥t :", answers: [ { text: "Enthousiaste, tu y vois une opportunit√©.", skill: "Adaptabilit√©" }, { text: "Prudent, tu as besoin de temps pour t'adapter.", skill: "R√©flexion" } ] },
        { question: "Quand tu as beaucoup de choses √† faire, tu as tendance √† :", answers: [ { text: "Cr√©er une to-do list et t'y tenir.", skill: "Organisation" }, { text: "Travailler sur la t√¢che qui t'inspire le plus.", skill: "Motivation" } ] },
        { question: "Tu pr√©f√®res un projet o√π :", answers: [ { text: "Le r√©sultat est garanti.", skill: "Prudence" }, { text: "Il y a une part de risque et de d√©couverte.", skill: "Audace" } ] },
        { question: "Face √† une difficult√©, ton premier r√©flexe est de :", answers: [ { text: "Chercher √† comprendre pourquoi √ßa n'a pas march√©.", skill: "Analyse critique" }, { text: "Te relever et r√©essayer.", skill: "R√©silience" } ] },
        { question: "Quand tu ne connais personne √† une soir√©e, tu as tendance √† :", answers: [ { text: "Attendre que quelqu'un vienne te parler.", skill: "Observation" }, { text: "Faire le premier pas et aller vers les autres.", skill: "Proactivit√©" } ] }
    ];

    const displayQuestion = (index) => {
        if (index >= quizQuestions.length) {
            displayDetectorResults();
            return;
        }
        const q = quizQuestions[index];
        quizContainer.innerHTML = `
            <p class="font-semibold text-slate-700 mb-4">${q.question}</p>
            <div class="flex flex-col space-y-2">
                ${q.answers.map((ans, i) => `<button type="button" data-skill="${ans.skill}" class="answer-btn text-left p-3 bg-background-light hover:bg-cyan-100 border rounded-lg">${ans.text}</button>`).join('')}
            </div>
        `;
        quizContainer.querySelectorAll('.answer-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                userSoftSkills.push(btn.dataset.skill);
                currentQuestionIndex++;
                displayQuestion(currentQuestionIndex);
            });
        });
    };
    
    const displayDetectorResults = async () => {
        quizContainer.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `<div class="loader"></div>`;
        const skillCounts = userSoftSkills.reduce((acc, skill) => { acc[skill] = (acc[skill] || 0) + 1; return acc; }, {});
        const topSkills = Object.entries(skillCounts).sort((a, b) => b[1] - a[1]).map(el => el[0]);
        const prompt = `Un lyc√©en a pass√© un quiz de comp√©tences transversales. Ses comp√©tences les plus marqu√©es sont : ${topSkills.join(', ')}. R√©dige une analyse courte et positive (8-10 phrases) de son profil de comp√©tences, en expliquant ce que cela signifie pour son orientation. Tu dois t'adresser directement √† l'√©l√®ve, en utilisant "tu"`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});    
    journalData.step10.soft_skills_profile = result;
        await saveData();
        resultsContainer.innerHTML = `<h4 class="font-bold text-OrIAntation-darkblue mb-2">Analyse de ton profil :</h4><div class="p-4 bg-background-light rounded-lg border whitespace-pre-wrap">${result}</div>`;
        checkConnectorState();
    };

    startDetectorBtn.addEventListener('click', () => {
        quizContainer.classList.remove('hidden');
        userSoftSkills = [];
        currentQuestionIndex = 0;
        displayQuestion(currentQuestionIndex);
    });

    if (journalData.step10.soft_skills_profile) {
        startDetectorBtn.classList.remove('hidden');
        resultsContainer.classList.remove('hidden');
        resultsContainer.innerHTML = `<h4 class="font-bold text-OrIAntation-darkblue mb-2">Analyse de ton profil :</h4><div class="p-4 bg-background-light rounded-lg border whitespace-pre-wrap">${journalData.step10.soft_skills_profile}</div>`;
    }

    const modal = div.querySelector('#portfolio-modal');
    const experienceListContainer = div.querySelector('#experience-list-container');

    const renderExperienceCards = () => {
        experienceListContainer.innerHTML = '';
        if (journalData.step10.experiences.length === 0) {
            experienceListContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Ton portfolio est vide. Clique sur "Ajouter une exp√©rience" pour commencer.</p>`;
        } else {
            journalData.step10.experiences.forEach((exp, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow border border-border-subtle';
                card.innerHTML = `<h4 class="font-bold text-cyan-700">Exp√©rience #${index + 1}</h4><p class="text-slate-700 whitespace-pre-wrap mt-2">${exp.analysis}</p><div class="text-right mt-2"><button type="button" data-index="${index}" class="delete-exp-btn text-red-500 hover:text-red-700 text-sm font-semibold">Supprimer</button></div>`;
                experienceListContainer.appendChild(card);
            });
        }
        div.querySelectorAll('.delete-exp-btn').forEach(btn => {
    // On rend la fonction du clic "async" pour pouvoir utiliser "await"
    btn.addEventListener('click', async (e) => {
        const index = parseInt(e.target.dataset.index, 10);
        // On remplace confirm() par notre fen√™tre modale personnalis√©e
        const confirmed = await showConfirmationModal("Es-tu s√ªr de vouloir supprimer cette exp√©rience ?");
        if (confirmed) {
            journalData.step10.experiences.splice(index, 1);
            await saveData();
            renderExperienceCards();
        }
    });
});
        checkConnectorState();
    };
    
    div.querySelector('#add-experience-btn').addEventListener('click', () => {
        currentExperience = { description: '', analysis: '' };
        div.querySelector('#experience-input').value = '';
        showStep(1);
        modal.classList.remove('hidden');
    });
    div.querySelector('#portfolio-modal-close').addEventListener('click', () => modal.classList.add('hidden'));

    const wizardSteps = [div.querySelector('#wizard-step-1'), div.querySelector('#wizard-step-2'), div.querySelector('#wizard-step-3')];
    const showStep = (stepNumber) => {
        wizardSteps.forEach((step, index) => step.classList.toggle('hidden', index + 1 !== stepNumber));
    };

    div.querySelector('#wizard-next-1').addEventListener('click', async () => {
        const description = div.querySelector('#experience-input').value;
        if (description.trim().length < 20) {
            showInfoModal("Veuillez d√©crire votre exp√©rience de mani√®re un peu plus d√©taill√©e.");
            return;
        }
        currentExperience.description = description;
        showStep(2);
        div.querySelector('#loader-2').classList.remove('hidden');
        div.querySelector('#skill-tags-container').innerHTML = '';
        const prompt = `Analyse la description de l'exp√©rience suivante fournie par un lyc√©en. Identifie les 5 √† 7 comp√©tences cl√©s (savoir-√™tre ou savoir-faire) les plus importantes qui en ressortent. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un unique tableau de cha√Ænes de caract√®res. Exemple : ["Gestion de projet", "Communication"]. Voici l'exp√©rience : "${description}"`;
const result = await callOpenAI_API({
    promptText: prompt,
    isJson: true
});
        div.querySelector('#loader-2').classList.add('hidden');
        const skillTagsContainer = div.querySelector('#skill-tags-container');
        try {
    // On utilise notre extracteur intelligent au lieu de JSON.parse directement
    const skills = extractJsonFromString(result);

    // On ajoute une v√©rification pour s'assurer que l'extraction a bien renvoy√© un tableau
    if (!Array.isArray(skills)) {
        throw new Error("La r√©ponse de OrIA n'est pas un tableau de comp√©tences valide.");
    }

    skills.forEach(skill => {
        const tag = document.createElement('button');
        tag.type = 'button';
        tag.className = 'bg-white border-cyan-500 border-2 text-cyan-700 font-semibold py-1 px-3 rounded-full cursor-pointer transition hover:bg-cyan-100';
        tag.textContent = skill;
        tag.addEventListener('click', () => {
            tag.classList.toggle('bg-cyan-500');
            tag.classList.toggle('text-white');
        });
        skillTagsContainer.appendChild(tag);
    });
} catch (e) {
    console.error("Erreur d'extraction des comp√©tences:", e, "R√©ponse brute:", result);
    skillTagsContainer.textContent = "OrIA n'a pas pu extraire de comp√©tences. Veuillez r√©essayer.";
}
    });

    div.querySelector('#wizard-next-2').addEventListener('click', async () => {
        const selectedSkills = Array.from(div.querySelectorAll('#skill-tags-container .bg-cyan-500')).map(tag => tag.textContent);
        if (selectedSkills.length === 0) {
            showInfoModal("Veuillez s√©lectionner au moins une comp√©tence.");
            return;
        }
        showStep(3);
        div.querySelector('#loader-3').classList.remove('hidden');
        div.querySelector('#portfolio-result').textContent = '';
        const prompt = `Agis en tant que coach carri√®re expert. R√©dige un paragraphe percutant (4-5 phrases) bas√© sur la m√©thode STAR (Situation, T√¢che, Action, R√©sultat) pour valoriser une exp√©rience. **Description de l'exp√©rience :** "${currentExperience.description}" **Comp√©tences cl√©s √† valoriser :** ${JSON.stringify(selectedSkills)}`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});    
    div.querySelector('#loader-3').classList.add('hidden');
        div.querySelector('#portfolio-result').textContent = result;
        currentExperience.analysis = result;
    });

    div.querySelector('#save-experience-btn').addEventListener('click', async () => {
        if (currentExperience && currentExperience.analysis) {
            journalData.step10.experiences.push(currentExperience);
            await saveData();
            await grantXp(50);
            renderExperienceCards();
            modal.classList.add('hidden');
        }
    });
    
    const checkConnectorState = () => {
        const connectorSection = div.querySelector('#connector-section');
        const experiencesDone = journalData.step10.experiences && journalData.step10.experiences.length > 0;
        const detectorDone = journalData.step10.soft_skills_profile && journalData.step10.soft_skills_profile.trim() !== '';
        if (experiencesDone && detectorDone) {
            connectorSection.classList.remove('hidden');
        } else {
            connectorSection.classList.add('hidden');
        }
    };

    div.querySelector('#connect-skills-btn').addEventListener('click', async () => {
        const loader = div.querySelector('#loader-connector');
        const resultTextarea = div.querySelector('#skills-synthesis');
        loader.style.display = 'block';
        resultTextarea.value = '';
        const experienceSummaries = journalData.step10.experiences.map(exp => exp.analysis).join('\n- ');
        const profileAnalysis = journalData.step10.soft_skills_profile;
        const prompt = `Agis comme un coach carri√®re expert. Voici le profil et les exp√©riences d'un √©l√®ve :
        **Profil de savoir-√™tre :** ${profileAnalysis}
        **Exp√©riences concr√®tes :** - ${experienceSummaries}
        Ta mission est de r√©diger une synth√®se (2-3 paragraphes) qui connecte ces deux aspects. Montre comment ses savoir-√™tre se manifestent dans ses savoir-faire. Utilise des phrases comme "Ta comp√©tence en [savoir-√™tre] se voit clairement lorsque tu as..." pour cr√©er des ponts. Le but est de l'aider √† formuler un discours coh√©rent sur ses atouts. Adresse-toi directement √† lui.`;
const result = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});
        loader.style.display = 'none';
        resultTextarea.value = result;
        journalData.step10.skills_synthesis = result;
        await saveData();
        await grantXp(75);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        checkBadges();
        await saveData();
        showView('menu');
    });

    renderExperienceCards();
    checkConnectorState();

    return div;
}


function createOrientationMapView(data, context = 'user') {
    const profileTitle = context === 'user' ? 'Mon Profil' : 'Son Profil';
    
    // LA SEULE MODIFICATION EST D'AJOUTER L'ID "orientation-map-container" ICI
    let mapHTML = '<div id="orientation-map-container" class="mb-8"><h2 class="text-xl font-bold text-OrIAntation-darkblue text-center mb-4">üó∫Ô∏è Carte d\'Orientation Personnelle</h2>';
    
    mapHTML += '<div class="bg-white p-6 rounded-2xl shadow-lg border border-border-subtle grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">';

    const archetype = data.step0 ? data.step0.archetype : null;
    const clickableClasses = 'map-card-clickable cursor-pointer hover:shadow-lg transition-shadow duration-200';

    // --- Bloc "Mon Profil" ---
    if (archetype && archetype.titre) {
        let oneSentenceDescription = archetype.description;
        if (archetype.description.includes('.')) {
            oneSentenceDescription = archetype.description.split('.')[0] + '.';
        }
        mapHTML += `
            <div class="lg:col-span-1 bg-cyan-50 p-4 rounded-lg border border-cyan-200 text-center">
                <h3 class="font-bold text-cyan-800">üë§ ${profileTitle}</h3>
                <div class="mt-2">
                    <span class="text-4xl">${archetype.icone}</span>
                    <p class="font-semibold text-OrIAntation-darkblue mt-1">${archetype.titre}</p>
                    <p class="text-sm text-slate-600 mt-2">${oneSentenceDescription}</p>
                </div>
            </div>`;
    } else {
        mapHTML += `
            <div class="lg:col-span-1 bg-background-light p-4 rounded-lg border text-center">
                <h3 class="font-bold text-slate-500">üë§ ${profileTitle}</h3>
                <p class="text-sm text-slate-500 mt-2">Compl√®te l'√©tape "Mieux se conna√Ætre" pour r√©v√©ler ton profil.</p>
            </div>`;
    }

    // --- Autres blocs de la carte (restent cliquables) ---
    mapHTML += '<div class="lg:col-span-2 space-y-4">';
    
    const metiers = [data.step1?.metier1, data.step1?.metier2, data.step1?.metier3].filter(m => m && m.trim() !== '');
    if (metiers.length > 0) {
        mapHTML += `<div data-target="journal-section-step1" class="${clickableClasses} bg-sky-50 p-3 rounded-lg border border-sky-200">
                        <h4 class="font-semibold text-sky-800">üìö M√©tiers explor√©s</h4>
                        <p class="text-sm text-slate-600">${metiers.join(', ')}</p>
                    </div>`;
    }

    const formations = [data.step3?.formation1, data.step3?.formation2].filter(f => f && f.trim() !== '');
    if (formations.length > 0) {
        mapHTML += `<div data-target="journal-section-step3" class="${clickableClasses} bg-lime-50 p-3 rounded-lg border border-lime-200">
                        <h4 class="font-semibold text-lime-800">üéì Formations envisag√©es</h4>
                        <p class="text-sm text-slate-600">${formations.join(', ')}</p>
                    </div>`;
    }

    if (data.step10 && data.step10.experiences && data.step10.experiences.length > 0) {
        mapHTML += `<div data-target="journal-section-step10" class="${clickableClasses} bg-amber-50 p-3 rounded-lg border border-amber-200">
                        <h4 class="font-semibold text-amber-800">üíº Comp√©tences identifi√©es</h4>
                        <p class="text-sm text-slate-600">√Ä travers ${data.step10.experiences.length} exp√©rience(s) valoris√©e(s).</p>
                    </div>`;
    }
    
    mapHTML += '</div>';
    mapHTML += '</div></div>';
    
    return mapHTML;
}

function createStep11View() {
    const config = stepsConfig.step11;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');

    // On supprime le bouton de sauvegarde global qui n'est plus pertinent
    form.querySelector('button[type="submit"]').remove();

    // -- STRUCTURE HTML COMPL√àTE DE LA PAGE --
    form.innerHTML = `
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-2 text-center">Atelier de Recherche et de Pr√©paration</h2>
        <p class="text-slate-600 mb-6 text-center">Choisis un type de rencontre pour trouver des opportunit√©s et pr√©parer tes √©changes.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <button type="button" data-workshop="event" class="workshop-choice-btn bg-white p-6 rounded-lg border-2 border-slate-300 hover:border-cyan-500 hover:bg-cyan-50 transition flex flex-col items-center text-center">
                <span class="text-3xl mb-2">üé™</span>
                <span class="font-bold text-OrIAntation-darkblue">Salons & √âv√©nements</span>
            </button>
            <button type="button" data-workshop="jpo" class="workshop-choice-btn bg-white p-6 rounded-lg border-2 border-slate-300 hover:border-cyan-500 hover:bg-cyan-50 transition flex flex-col items-center text-center">
                <span class="text-3xl mb-2">üè´</span>
                <span class="font-bold text-OrIAntation-darkblue">Journ√©es Portes Ouvertes</span>
            </button>
            <button type="button" data-workshop="pro" class="workshop-choice-btn bg-white p-6 rounded-lg border-2 border-slate-300 hover:border-cyan-500 hover:bg-cyan-50 transition flex flex-col items-center text-center">
                <span class="text-3xl mb-2">üßëüíº</span>
                <span class="font-bold text-OrIAntation-darkblue">Professionnels</span>
            </button>
        </div>

        <div id="event-workshop" class="hidden workshop-container space-y-6">
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">1. Rechercher des salons et √©v√©nements</h3>
                <label for="event-location" class="block text-md font-medium text-slate-700 mb-2">Ville ou d√©partement</label>
                <div class="flex gap-2">
                    <input type="text" id="event-location" class="w-full p-2 border rounded-lg" placeholder="Ex: Rennes, Ille-et-Vilaine...">
                    <button type="button" id="search-event-btn" class="bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">Chercher</button>
                </div>
            </div>
            <div id="event-loader" class="hidden my-4"><div class="loader"></div></div>
            <div id="event-results-container"></div>
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">2. Pr√©parer ma visite de salon</h3>
                <input type="text" id="salon_nom" name="salon_nom" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Nom du salon (ex: Salon de l'√âtudiant)" value="${journalData.step11.salon_nom || ''}">
                <button type="button" id="openaiBtn_salon" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">üéØ Pr√©parer ma visite</button>
                <div id="openaiLoader_salon" class="hidden"><div class="loader"></div></div>
                <textarea id="salon_preparation" name="salon_preparation" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly>${journalData.step11.salon_preparation || ''}</textarea>
            </div>
        </div>

        <div id="jpo-workshop" class="hidden workshop-container space-y-6">
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">1. Rechercher des Journ√©es Portes Ouvertes</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="jpo-domain" class="block text-md font-medium text-slate-700 mb-2">Domaine ou √©cole</label>
                        <input type="text" id="jpo-domain" class="w-full p-2 border rounded-lg" placeholder="Ex: Informatique, Lyc√©e B. Franklin">
                    </div>
                    <div>
                        <label for="jpo-location" class="block text-md font-medium text-slate-700 mb-2">Ville ou d√©partement</label>
                        <input type="text" id="jpo-location" class="w-full p-2 border rounded-lg" placeholder="Ex: Orl√©ans, Loiret...">
                    </div>
                </div>
                <button type="button" id="search-jpo-btn" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">Chercher les JPO</button>
            </div>
            <div id="jpo-loader" class="hidden my-4"><div class="loader"></div></div>
            <div id="jpo-results-container"></div>
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">2. Pr√©parer ma visite de JPO</h3>
                <input type="text" id="jpo_ecole" name="jpo_ecole" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Nom de l'√©cole ou formation" value="${journalData.step11.jpo_ecole || ''}">
                <button type="button" id="openaiBtn_jpo" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">üí° G√©n√©rer des questions</button>
                <div id="openaiLoader_jpo" class="hidden"><div class="loader"></div></div>
                <textarea id="jpo_questions" name="jpo_questions" rows="8" class="w-full mt-2 p-2 border border-slate-300 rounded-lg bg-slate-100" readonly>${journalData.step11.jpo_questions || ''}</textarea>
            </div>
        </div>
        
        <div id="pro-workshop" class="hidden workshop-container space-y-6">
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">1. Rechercher des professionnels</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="pro-domain" class="block text-md font-medium text-slate-700 mb-2">M√©tier</label>
                        <input type="text" id="pro-domain" class="w-full p-2 border rounded-lg" placeholder="Ex: Architecte, D√©veloppeur web...">
                    </div>
                    <div>
                        <label for="pro-location" class="block text-md font-medium text-slate-700 mb-2">D√©partement</label>
                        <input type="text" id="pro-location" class="w-full p-2 border rounded-lg" placeholder="Ex: 75, Morbihan...">
                    </div>
                </div>
                <button type="button" id="search-pro-btn" class="w-full mt-4 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">Chercher des contacts</button>
            </div>
            <div id="pro-loader" class="hidden my-4"><div class="loader"></div></div>
            <div id="pro-results-container"></div>
            <div>
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">2. Ma Liste de Suivi de Contacts</h3>
                <div id="contact-list-container" class="space-y-3"></div>
            </div>
            <div class="bg-background-light p-4 rounded-lg border">
                <h3 class="font-bold text-OrIAntation-darkblue mb-2">3. Pr√©parer ma prise de contact</h3>
                <input type="text" id="pro_metier_aide" class="w-full p-2 border border-slate-300 rounded-lg mb-2" placeholder="Rappelle le m√©tier concern√©">
                <button type="button" id="openaiBtn_contact_pro" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">‚úâÔ∏è G√©n√©rer une strat√©gie</button>
                <div id="openaiLoader_pro_contact" class="hidden"><div class="loader"></div></div>
                <div id="pro_strategie" name="pro_strategie" class="w-full mt-2 p-4 border border-slate-300 rounded-lg bg-slate-100 min-h-[16rem]"></div>
            </div>
        </div>
    `;

    // -- LOGIQUE D'AFFICHAGE DES ATELIERS --
    const workshopContainers = div.querySelectorAll('.workshop-container');
    const workshopChoiceBtns = div.querySelectorAll('.workshop-choice-btn');

    workshopChoiceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const workshopType = btn.dataset.workshop;
            workshopChoiceBtns.forEach(b => {
                b.classList.remove('border-cyan-500', 'bg-cyan-50');
                b.classList.add('border-slate-300');
            });
            btn.classList.add('border-cyan-500', 'bg-cyan-50');
            btn.classList.remove('border-slate-300');

            workshopContainers.forEach(container => {
                container.classList.toggle('hidden', container.id !== `${workshopType}-workshop`);
            });

            if (workshopType === 'pro') {
                renderContactList();
                div.querySelector('#pro_strategie').value = journalData.step8?.pro_strategie || '';
            }
        });
    });

    // -- LOGIQUE DES RECHERCHES --
    
    div.querySelector('#search-event-btn').addEventListener('click', async () => {
        const location = div.querySelector('#event-location').value.trim();
        if (!location) { showInfoModal("Veuillez indiquer une ville ou un d√©partement."); return; }
        const loader = div.querySelector('#event-loader');
        const resultsContainer = div.querySelector('#event-results-container');
        loader.style.display = 'block';
        resultsContainer.innerHTML = '';
        const academicYear = new Date().getMonth() >= 7 ? `${new Date().getFullYear()}-${new Date().getFullYear() + 1}` : `${new Date().getFullYear() - 1}-${new Date().getFullYear()}`;
        const prompt = `Agis comme un documentaliste. Trouve les 6 principaux salons et forums d'orientation pour un lyc√©en √† "${location}" ou dans un rayon de 80km, pour l'ann√©e scolaire ${academicYear}. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau nomm√© "evenements". Chaque objet doit avoir les cl√©s "nom", "lieu", et "date" (AAAA-MM-JJ).`;
        const result = await callOpenAI_API({ promptText: prompt, isJson: true });
        loader.style.display = 'none';
        renderEventResults(extractJsonFromString(result), resultsContainer);
    });

    div.querySelector('#search-jpo-btn').addEventListener('click', async () => {
        const domain = div.querySelector('#jpo-domain').value.trim();
        const location = div.querySelector('#jpo-location').value.trim();
        if (!domain || !location) { showInfoModal("Veuillez indiquer un domaine et une ville/d√©partement."); return; }
        const loader = div.querySelector('#jpo-loader');
        const resultsContainer = div.querySelector('#jpo-results-container');
        loader.style.display = 'block';
        resultsContainer.innerHTML = '';
        const prompt = `Trouve jusqu'√† 6 Journ√©es Portes Ouvertes (JPO) pour le domaine ou l'√©cole "${domain}" √† "${location}" ou dans un rayon de 80 km pour les 4 prochains mois. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau nomm√© "evenements". Chaque objet doit avoir les cl√©s "nom", "lieu", et "date" (AAAA-MM-JJ).`;
        const result = await callOpenAI_API({ promptText: prompt, isJson: true });
        loader.style.display = 'none';
        renderEventResults(extractJsonFromString(result), resultsContainer);
    });

    div.querySelector('#search-pro-btn').addEventListener('click', async () => {
        const metier = div.querySelector('#pro-domain').value.trim();
        const departement = div.querySelector('#pro-location').value.trim();
        if (!metier || !departement) { showInfoModal("Veuillez indiquer un m√©tier et un d√©partement."); return; }
        const loader = div.querySelector('#pro-loader');
        const resultsContainer = div.querySelector('#pro-results-container');
        loader.style.display = 'block';
        resultsContainer.innerHTML = '';
        const prompt = `Agis comme un conseiller d'orientation. Pour un lyc√©en dans le d√©partement "${departement}", trouve 5 types de contacts (entreprises, associations pro, cabinets...) pour le m√©tier de "${metier}". √âvite les CIO. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau nomm√© "professionnels". Chaque objet doit avoir les cl√©s "nom" et "search_link" (une URL de recherche Google valide).`;
        const result = await callOpenAI_API({ promptText: prompt, isJson: true });
        loader.style.display = 'none';
        renderProResults(extractJsonFromString(result), resultsContainer);
    });

    // -- FONCTIONS DE RENDU DES R√âSULTATS --
    
    const renderEventResults = (data, container) => {
        if (!data || !data.evenements || data.evenements.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 my-4">Aucun r√©sultat trouv√©.</p>`;
            return;
        }
        const allTasks = (journalData.retroplanning?.tasks || []).flatMap(month => month.tasks.map(task => task.text));
        let html = '<h3 class="text-xl font-bold text-OrIAntation-darkblue mb-4">R√©sultats de la recherche :</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
        data.evenements.forEach((event, index) => {
            const dateInputId = `event-date-${index}-${container.id}`;
            const isAlreadyInRetroplanning = allTasks.some(taskText => taskText.includes(event.nom));
            const buttonText = isAlreadyInRetroplanning ? 'D√©j√† au planning ‚úî' : '+ R√©troplanning';
            const buttonClasses = isAlreadyInRetroplanning ? 'bg-green-100 text-green-800 cursor-not-allowed' : 'bg-orange-100 text-orange-800 font-semibold hover:bg-orange-200 transition';
            const buttonDisabled = isAlreadyInRetroplanning ? 'disabled' : '';
            const retroBtn = `<button type="button" class="add-to-retro-btn text-xs py-1 px-2 rounded-lg ${buttonClasses}" data-nom="${event.nom}" data-input-id="${dateInputId}" ${buttonDisabled}>${buttonText}</button>`;
            const eventUrl = `https://www.google.com/search?q=${encodeURIComponent(`${event.nom} ${event.lieu || ''}`)}`;
            html += `
                <div class="bg-white p-4 rounded-lg shadow border flex flex-col h-full">
                    <h4 class="font-bold text-cyan-700">${event.nom}</h4>
                    <label for="${dateInputId}" class="text-slate-600 text-sm font-medium mt-2">Date (modifiable) :</label>
                    <input type="date" id="${dateInputId}" value="${event.date || ''}" class="w-full border-slate-300 border rounded-md p-1 mt-1 text-sm">
                    <p class="text-slate-500 text-sm mt-2">${event.lieu || 'Lieu √† v√©rifier'}</p>
                    <div class="mt-auto pt-2 flex flex-col items-center gap-2">
                        <a href="${eventUrl}" target="_blank" class="text-primary-action hover:underline text-sm font-semibold">V√©rifier les infos ‚Üó</a>
                        ${retroBtn}
                    </div>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    };

    const renderProResults = (data, container) => {
        if (!data || !data.professionnels || data.professionnels.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 my-4">Aucun r√©sultat trouv√©.</p>`;
            return;
        }
        let html = '<h3 class="text-xl font-bold text-OrIAntation-darkblue mb-4">Pistes de contacts :</h3><div class="space-y-3">';
        data.professionnels.forEach((pro) => {
            html += `
                <div class="bg-white p-3 rounded-lg shadow border flex justify-between items-center">
                    <div class="flex-1">
                        <p class="font-semibold text-cyan-700">${pro.nom}</p>
                        <a href="${pro.search_link}" target="_blank" class="text-xs text-primary-action hover:underline">Rechercher ce contact ‚Üó</a>
                    </div>
                    <button type="button" class="add-pro-contact-btn bg-teal-500 text-white font-semibold text-sm py-1 px-3 rounded-lg hover:bg-teal-600" data-contact='${JSON.stringify(pro)}'>+ Ajouter au suivi</button>
                </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    };

    // -- LOGIQUE POUR LA LISTE DE SUIVI --
    const contactListContainer = div.querySelector('#contact-list-container');
    const renderContactList = () => {
        if (!journalData.step8) journalData.step8 = { contacts: [] };
        const contacts = journalData.step8.contacts || [];
        if (contacts.length === 0) {
            contactListContainer.innerHTML = `<p class="text-center text-slate-500 p-4 bg-white border rounded-lg">Ta liste de suivi est vide. Utilise la recherche ci-dessus pour trouver des pistes !</p>`;
            return;
        }
        const statusOptions = { a_contacter: "√Ä contacter", contacte: "Contact√©", reponse_recue: "R√©ponse re√ßue", entretien_prevu: "Entretien pr√©vu" };
        const statusColors = { a_contacter: "bg-slate-100 border-slate-300", contacte: "bg-blue-100 border-blue-300", reponse_recue: "bg-yellow-100 border-yellow-300", entretien_prevu: "bg-green-100 border-green-300" };
        
        contactListContainer.innerHTML = contacts.map((contact, index) => {
            const optionsHTML = Object.entries(statusOptions).map(([value, text]) => `<option value="${value}" ${contact.statut === value ? 'selected' : ''}>${text}</option>`).join('');
            return `
                <div class="p-4 rounded-lg border flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 ${statusColors[contact.statut || 'a_contacter']}">
                    <div class="flex-1">
                        <p class="font-semibold text-OrIAntation-darkblue">${contact.nom}</p>
                        ${contact.search_link ? `<a href="${contact.search_link}" target="_blank" class="text-sm text-primary-action hover:underline">Rechercher ‚Üó</a>` : ''}
                    </div>
                    <div class="flex items-center gap-2 w-full sm:w-auto self-end sm:self-center">
                        <select data-index="${index}" class="status-select w-full sm:w-auto p-2 border border-slate-300 rounded-lg bg-white">${optionsHTML}</select>
                        <button data-index="${index}" class="delete-contact-btn bg-red-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-red-600">√ó</button>
                    </div>
                </div>`;
        }).join('');
    };

    // -- GESTION DES CLICS ET INTERACTIONS --
    div.addEventListener('click', async (e) => {
        if (e.target.matches('.add-to-retro-btn')) {
            const button = e.target;
            const eventName = button.dataset.nom;
            const inputId = button.dataset.inputId;
            const dateInput = document.getElementById(inputId);
            const eventDate = dateInput.value;
            if (!eventDate) { showInfoModal("Veuillez entrer une date valide."); return; }
            if (!journalData.retroplanning || !Array.isArray(journalData.retroplanning.tasks)) { showInfoModal("Veuillez d'abord g√©n√©rer un R√©troplanning."); return; }
            const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            const dateObj = new Date(eventDate);
            const adjustedDate = new Date(dateObj.getTime() + Math.abs(dateObj.getTimezoneOffset() * 60000));
            const monthName = monthNames[adjustedDate.getMonth()];
            const formattedDate = ` (${String(adjustedDate.getDate()).padStart(2, '0')}/${String(adjustedDate.getMonth() + 1).padStart(2, '0')})`;
            let monthObject = journalData.retroplanning.tasks.find(m => m.month === monthName);
            if (!monthObject) {
                monthObject = { month: monthName, tasks: [] };
                journalData.retroplanning.tasks.push(monthObject);
                journalData.retroplanning.tasks.sort((a, b) => monthNames.indexOf(a.month) - monthNames.indexOf(b.month));
            }
            const newTaskText = `Participer √† : ${eventName}${formattedDate}`;
            if (!monthObject.tasks.some(task => task.text === newTaskText)) {
                monthObject.tasks.push({ text: newTaskText, completed: false });
                await saveData();
                button.textContent = 'Ajout√© ‚úî';
                button.disabled = true;
                button.classList.remove('bg-orange-100', 'hover:bg-orange-200');
                button.classList.add('bg-green-100', 'text-green-800');
            }
        }
        if (e.target.matches('.add-pro-contact-btn')) {
            const button = e.target;
            const contactData = JSON.parse(button.dataset.contact);
            if (!journalData.step8) journalData.step8 = { contacts: [] };
            if (!Array.isArray(journalData.step8.contacts)) journalData.step8.contacts = [];
            if (journalData.step8.contacts.some(c => c.nom === contactData.nom)) {
                showInfoModal("D√©j√† ajout√©", "Ce contact est d√©j√† dans votre liste de suivi."); return;
            }
            journalData.step8.contacts.push({ nom: contactData.nom, search_link: contactData.search_link, type: 'externe', statut: 'a_contacter' });
            await saveData();
            renderContactList();
            button.textContent = 'Ajout√© ‚úî';
            button.disabled = true;
            button.classList.remove('bg-teal-500');
            button.classList.add('bg-green-500');
        }
        if (e.target.matches('.delete-contact-btn')) {
            const index = e.target.dataset.index;
            if (await showConfirmationModal("Es-tu s√ªr de vouloir supprimer ce contact ?")) {
                journalData.step8.contacts.splice(index, 1);
                await saveData();
                renderContactList();
            }
        }
    });
    
    div.addEventListener('change', async (e) => {
        if (e.target.matches('.status-select')) {
            const index = e.target.dataset.index;
            journalData.step8.contacts[index].statut = e.target.value;
            await saveData();
            renderContactList();
        }
    });

    // -- LOGIQUE COMPL√àTE DE LA SECTION "PR√âPARER" --
    div.querySelector('#openaiBtn_jpo').addEventListener('click', async () => {
        const ecole = div.querySelector('#jpo_ecole').value.trim();
        if (!ecole) { showInfoModal("Veuillez indiquer le nom de l'√©cole."); return; }
        const loader = div.querySelector('#openaiLoader_jpo');
        const resultDiv = div.querySelector('#jpo_questions');
        loader.style.display = 'block'; resultDiv.value = '';
        const prompt = `Agis comme un coach. Un √©l√®ve pr√©pare sa visite aux JPO pour : "${ecole}". Son profil est : ${getProfileSummary()}. G√©n√®re une liste de 5-6 questions pertinentes, en personnalisant une ou deux questions √† son profil.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.value = result;
        journalData.step11.jpo_ecole = ecole;
        journalData.step11.jpo_questions = result;
        await saveData();
    });
    
    div.querySelector('#openaiBtn_salon').addEventListener('click', async () => {
        const salon = div.querySelector('#salon_nom').value.trim();
        if (!salon) { showInfoModal("Veuillez indiquer le nom du salon."); return; }
        const loader = div.querySelector('#openaiLoader_salon');
        const resultDiv = div.querySelector('#salon_preparation');
        loader.style.display = 'block'; resultDiv.value = '';
        const prompt = `Agis comme un coach. Un √©l√®ve pr√©pare sa visite pour le salon : "${salon}". Son profil est : ${getProfileSummary()}. G√©n√®re un "plan d'action" en 3 points : 1. Objectif principal (li√© √† son profil). 2. Stands √† ne pas manquer. 3. La question qui fait la diff√©rence.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.value = result;
        journalData.step11.salon_nom = salon;
        journalData.step11.salon_preparation = result;
        await saveData();
    });

   // REMPLACEZ L'√âV√âNEMENT DU BOUTON EXISTANT PAR CE BLOC COMPLET

div.querySelector('#openaiBtn_contact_pro').addEventListener('click', async () => {
    const metier = div.querySelector('#pro_metier_aide').value.trim();
    const loader = div.querySelector('#openaiLoader_pro_contact');
    const resultDiv = div.querySelector('#pro_strategie');

    if (!metier) {
        showInfoModal("Veuillez indiquer un m√©tier pour g√©n√©rer une strat√©gie de contact.");
        return;
    }

    loader.style.display = 'block';
    resultDiv.value = '';

    const profileSummary = getProfileSummary();

    const prompt = `
Agis comme un coach carri√®re expert qui aide un(e) lyc√©en(ne) √† r√©diger un e-mail de prise de contact avec un professionnel.

# Contexte
- **Profil de l'√©l√®ve :** ${profileSummary}
- **M√©tier ou secteur vis√© :** "${metier}"

# Ta Mission
R√©dige un mod√®le d'e-mail court, poli et qui se d√©marque, montrant une d√©marche s√©rieuse et r√©fl√©chie.

## R√®gle Absolue de Ton
Le ton de l'e-mail doit rester professionnel. **N'utilise JAMAIS les termes issus du jargon de l'application** comme "Arch√©type", "Exploratrice", "Architecte", etc. Tu dois traduire les **traits de caract√®re** du profil (curiosit√©, logique, cr√©ativit√©...) en qualit√©s humaines, sans jamais nommer les profils.

# Structure de l'e-mail (Imp√©ratif)
1.  **Objet :** Propose un objet de mail clair et respectueux (ex: "Demande d'√©change sur le m√©tier de [m√©tier]").
2.  **Introduction :** Une introduction simple (qui il/elle est, sa classe).
3.  **Paragraphe "Pourquoi je vous contacte ?" (Le plus important) :** Un paragraphe expliquant son int√©r√™t pour le m√©tier. **Fais un lien subtil entre les qualit√©s issues du profil de l'√©l√®ve et les comp√©tences requises pour le m√©tier vis√©.**
4.  **La Demande :** Une phrase claire pour demander un court √©change (15-20 minutes).
5.  **Formule de Politesse :** Une formule de politesse professionnelle.
6.  **Placeholders :** Utilise des placeholders clairs comme [Nom du professionnel], [Nom de l'entreprise], etc.

# Conseil final
√Ä la toute fin, apr√®s la signature, ajoute une section distincte intitul√©e "--- Conseil du Coach ---" avec un conseil tr√®s court.
    `;
    
    const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
    
    loader.style.display = 'none';
    
    // On s√©pare le conseil du corps du mail pour un affichage distinct
    const parts = result.split("--- Conseil du Coach ---");
    const emailBody = parts[0];
    const coachTip = parts[1] || '';

    // On vide la div de r√©sultat
    resultDiv.innerHTML = '';

    // On y ins√®re directement le contenu HTML riche et stylis√©
    resultDiv.innerHTML = `
        <div class="whitespace-pre-wrap text-sm p-4 bg-white border rounded-lg">${emailBody.trim()}</div>
        ${coachTip ? `<div class="mt-4 p-3 bg-amber-50 border-l-4 border-amber-400 text-sm text-amber-800 font-semibold">${coachTip.trim()}</div>` : ''}
    `;

    if (!journalData.step8) journalData.step8 = {};
    journalData.step8.pro_strategie = result;
    await saveData();
});
    
    return div;
}

function createStep13View() {
    const config = stepsConfig.step13;
    const div = createStepView(config);
    const form = div.querySelector('#stepForm');
    form.querySelector('button[type="submit"]')?.remove();

    // La structure de donn√©es supporte maintenant des listes pour les deux ateliers
    if (!journalData.step13) {
        journalData.step13 = { hypotheses: [], bilans: [] };
    }
    if (!Array.isArray(journalData.step13.hypotheses)) {
        journalData.step13.hypotheses = [];
    }
    if (!Array.isArray(journalData.step13.bilans)) {
        journalData.step13.bilans = [];
    }
    
    let currentHypothese = { titre: '', ville: '', notes: '', lieux_suggeres: '', modele_contact: '' };
    let currentBilan = { titre: '', missions: '', apprentissages: '', ressenti: '', plan_rapport: '', competences_extraites: '', analyse_rapport: '' };  
    form.innerHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        <button type="button" data-workshop="recherche" class="workshop-choice-btn bg-white p-6 rounded-lg border-2 border-slate-300 hover:border-cyan-500 hover:bg-cyan-50 transition flex flex-col items-center text-center">
            <span class="text-3xl mb-2">üîç</span>
            <span class="font-bold text-OrIAntation-darkblue">Atelier 1 : Trouver un stage</span>
            <span class="text-sm text-slate-500 mt-1">Explorer des pistes et pr√©parer ses candidatures.</span>
        </button>
        <button type="button" data-workshop="bilan" class="workshop-choice-btn bg-white p-6 rounded-lg border-2 border-slate-300 hover:border-cyan-500 hover:bg-cyan-50 transition flex flex-col items-center text-center">
            <span class="text-3xl mb-2">‚úçÔ∏è</span>
            <span class="font-bold text-OrIAntation-darkblue">Atelier 2 : Faire le bilan d'une exp√©rience</span>
            <span class="text-sm text-slate-500 mt-1">Analyser une exp√©rience pour en tirer des comp√©tences.</span>
        </button>
    </div>

    <div id="recherche-workshop" class="hidden workshop-container space-y-6">
        <div id="hypothese-workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8 space-y-8">

            <div>
                <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">1. Besoin d'inspiration ?</h2>
                <p class="text-center text-sm text-slate-600 mb-4">Laisse OrIA te proposer des id√©es de stage personnalis√©es en fonction de ton profil.</p>
                <div class="text-center">
                    <button type="button" id="suggest-ideas-btn" class="ai-btn bg-orange-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-orange-600">üí° Sugg√©rer des id√©es</button>
                </div>
            </div>

            <hr class="border-slate-200">

            <div>
                <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">2. Tu as d√©j√† une id√©e ?</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="hypothese-secteur" class="block text-md font-medium text-slate-700 mb-1">Secteur ou id√©e de stage</label>
                        <input type="text" id="hypothese-secteur" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: v√©t√©rinaire">
                    </div>
                    <div>
                        <label for="hypothese-ville" class="block text-md font-medium text-slate-700 mb-1">Ville ou d√©partement</label>
                        <input type="text" id="hypothese-ville" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Ex: Auray">
                    </div>
                </div>
                <div class="mb-4">
                        <label for="hypothese-notes" class="block text-md font-medium text-slate-700 mb-1">Mes questions / ce qui m'attire</label>
                        <textarea id="hypothese-notes" rows="2" class="w-full p-2 border rounded-lg" placeholder="Ex: le contact avec les animaux"></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button type="button" id="find-places-btn" class="ai-btn w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700">üè¢ Trouver des structures</button>
                    <button type="button" id="prepare-contact-btn" class="ai-btn w-full bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600">‚úâÔ∏è Pr√©parer le contact</button>
                </div>
            </div>
            
            <div id="loader-hypothese" class="hidden my-4"><div class="loader"></div></div>
            <div id="result-hypothese" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] prose prose-sm max-w-none"></div>

            <button type="button" id="save-hypothese-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700">üíæ Enregistrer cette hypoth√®se de stage</button>
        </div>
        <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes hypoth√®ses de stage sauvegard√©es</h2>
        <div id="hypotheses-list-container" class="space-y-3"></div>
    </div>

    <div id="bilan-workshop" class="hidden workshop-container space-y-6">
    <div id="bilan-workspace" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-dashed border-cyan-300 mb-8">
        <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-3 text-center">Nouveau bilan d'exp√©rience</h2>
<div class="mb-4">
    <label for="bilan-titre" class="block text-md font-medium text-slate-700 mb-1">Nom de l'exp√©rience</label>
    <input type="text" id="bilan-titre" class="w-full p-2 border rounded-lg" placeholder="Ex: Mon stage chez le v√©t√©rinaire">
</div>

<h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">Outils d'Analyse (optionnels)</h3>
<p class="text-sm text-slate-600 mb-4">Tu peux utiliser ces outils pour t'aider √† structurer tes id√©es avant ou apr√®s la r√©daction.</p>
<div class="space-y-4 mb-4 bg-background-light p-4 rounded-lg border">
    <div><label class="block text-md font-medium text-slate-700 mb-1">Tes missions et observations</label><textarea id="bilan-missions" rows="3" class="w-full p-2 border rounded-lg"></textarea></div>
    <div><label class="block text-md font-medium text-slate-700 mb-1">Ce que tu as appris</label><textarea id="bilan-apprentissages" rows="2" class="w-full p-2 border rounded-lg"></textarea></div>
    <div><label class="block text-md font-medium text-slate-700 mb-1">Ton ressenti</label><textarea id="bilan-ressenti" rows="2" class="w-full p-2 border rounded-lg"></textarea></div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <button type="button" id="get-plan-btn" class="ai-btn w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700">üìã Obtenir un plan</button>
        <button type="button" id="extract-skills-btn" class="ai-btn w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600">üõ†Ô∏è Analyser les comp√©tences</button>
    </div>
</div>

<hr class="my-8 border-slate-200">

<div>
    <h3 class="text-lg font-bold text-OrIAntation-darkblue mb-2">R√©viseur de Rapport de Stage</h3>
    <div class="mb-4">
         <label for="bilan-brouillon" class="block text-md font-medium text-slate-700 mb-2">Colle ici ton brouillon de rapport de stage</label>
        <textarea id="bilan-brouillon" rows="10" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="√âcris ou colle ici ton texte complet..."></textarea>
    </div>
    <div class="text-center">
        <button type="button" id="review-report-btn" class="w-full bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition">üîç Lancer la relecture du rapport</button>
    </div>
</div>

<div id="loader-bilan" class="hidden my-4"><div class="loader"></div></div>
<div id="result-bilan" class="mt-4 p-4 bg-background-light border rounded-lg min-h-[100px] prose prose-sm max-w-none"></div>
<button type="button" id="save-bilan-btn" class="w-full mt-6 bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-cyan-700">üíæ Enregistrer ce bilan</button>
    <h2 class="text-2xl font-bold text-OrIAntation-darkblue mb-4">Mes bilans d'exp√©rience sauvegard√©s</h2>
    <div id="bilans-list-container" class="space-y-3"></div>
</div>
`;

    // --- LOGIQUE COMMUNE D'AFFICHAGE DES ATELIERS ---
    const workshopContainers = div.querySelectorAll('.workshop-container');
    const workshopChoiceBtns = div.querySelectorAll('.workshop-choice-btn');
    workshopChoiceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const workshopType = btn.dataset.workshop;
            workshopChoiceBtns.forEach(b => b.classList.remove('border-cyan-500', 'bg-cyan-50'));
            btn.classList.add('border-cyan-500', 'bg-cyan-50');
            workshopContainers.forEach(c => c.classList.toggle('hidden', c.id !== `${workshopType}-workshop`));
        });
    });

  

const renderSavedHypotheses = () => {
    const container = div.querySelector('#hypotheses-list-container');
    const hypotheses = journalData.step13.hypotheses || [];
    if (hypotheses.length === 0) {
        container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Aucune hypoth√®se de stage sauvegard√©e.</p>`;
        return;
    }
    container.innerHTML = hypotheses.map((hyp, index) => {
        let content = `<p><strong>Notes:</strong> ${hyp.notes || '...'}</p>`;
        
        if(hyp.lieux_suggeres) {
            try {
                // ‚ñº‚ñº‚ñº LA CORRECTION FINALE EST ICI ‚ñº‚ñº‚ñº
                // On utilise la fonction intelligente qui sait retirer les balises de code
                const data = extractJsonFromString(hyp.lieux_suggeres);
                const lieux = data.lieux;
                // ‚ñ≤‚ñ≤‚ñ≤ FIN DE LA CORRECTION ‚ñ≤‚ñ≤‚ñ≤

                if (Array.isArray(lieux)) {
                    const lieuxHTML = lieux.map(lieu => `
                        <div class="p-2 bg-white rounded border mt-1">
                            <p class="font-semibold text-OrIAntation-darkblue">${lieu.nom}</p>
                            <p class="text-xs mt-1">${lieu.description}</p>
                            <a href="${lieu.lien_recherche}" target="_blank" class="text-xs text-primary-action font-semibold hover:underline mt-1 inline-block">Rechercher ‚Üó</a>
                        </div>`).join('');
                    content += `<div><strong>Lieux sugg√©r√©s:</strong><div class="space-y-2">${lieuxHTML}</div></div>`;
                } else { 
                    throw new Error('Le JSON ne contient pas de tableau "lieux".');
                }
            } catch(e) {
                // Ce bloc s'ex√©cute si le JSON est mal format√©, affichant le texte brut
                content += `<div><strong>Lieux sugg√©r√©s:</strong><div class="whitespace-pre-wrap p-2 bg-red-50 border rounded">${hyp.lieux_suggeres}</div></div>`;
            }
        }

        if(hyp.modele_contact) {
            content += `<div class="mt-2"><strong>Mod√®le de contact:</strong><div class="whitespace-pre-wrap text-sm p-2 bg-white border rounded">${hyp.modele_contact}</div></div>`;
        }

        return `<details class="bg-background-light rounded-lg border">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${hyp.titre} √† ${hyp.ville}</span>
                        <button type="button" data-index="${index}" class="delete-hypothese-btn text-red-500 hover:text-red-700 p-1">üóëÔ∏è</button>
                    </summary>
                    <div class="p-3 border-t space-y-2">${content}</div>
                </details>`;
    }).join('');
};
    const resetHypotheseWorkspace = () => {
        currentHypothese = { titre: '', ville: '', notes: '', lieux_suggeres: '', modele_contact: '' };
        div.querySelector('#hypothese-secteur').value = '';
        div.querySelector('#hypothese-ville').value = '';
        div.querySelector('#hypothese-notes').value = '';
        div.querySelector('#result-hypothese').innerHTML = '';
    };

div.querySelector('#find-places-btn').addEventListener('click', async () => {        const secteur = div.querySelector('#hypothese-secteur').value.trim();
        const ville = div.querySelector('#hypothese-ville').value.trim();
        if (!secteur || !ville) { showInfoModal("Veuillez renseigner un secteur et une ville."); return; }
        const loader = div.querySelector('#loader-hypothese');
        const resultDiv = div.querySelector('#result-hypothese');
        loader.style.display = 'block'; resultDiv.innerHTML = '';
        const prompt = `Agis comme un conseiller d'orientation. Pour un √©l√®ve de Seconde, trouve 5 types de lieux (entreprises, associations...) o√π il pourrait faire un stage d'observation dans le secteur "${secteur}" de "${ville}" √† 30 kilom√®tres. Ta r√©ponse doit √™tre **uniquement un objet JSON valide** contenant un tableau nomm√© "lieux". Chaque objet doit avoir trois cl√©s : "nom", "description", et "lien_recherche" (une URL de recherche Google valide pour trouver ce type de lieu dans la ville sp√©cifi√©e).`;
        const result = await callOpenAI_API({ promptText: prompt, isJson: true });
        loader.style.display = 'none';
        try {
            const data = extractJsonFromString(result);
            if (!data || !data.lieux) throw new Error("Format de r√©ponse invalide.");
            const lieuxHTML = data.lieux.map(lieu => `
                <div class="p-3 bg-white rounded-lg border">
                    <p class="font-semibold text-OrIAntation-darkblue">${lieu.nom}</p>
                    <p class="text-sm mt-1">${lieu.description}</p>
                    <a href="${lieu.lien_recherche}" target="_blank" class="text-sm text-primary-action font-semibold hover:underline mt-2 inline-block">Rechercher ce type de lieu ‚Üó</a>
                </div>`).join('');
            resultDiv.innerHTML = `<div class="space-y-3">${lieuxHTML}</div>`;
            currentHypothese.lieux_suggeres = result; // On sauvegarde le JSON brut
        } catch(e) {
            resultDiv.innerHTML = `<p class="text-red-500">OrIA n'a pas pu formater la r√©ponse. R√©essayez.</p>`;
        }
    });

    // AJOUTEZ CE BLOC DE CODE
div.querySelector('#suggest-ideas-btn').addEventListener('click', async () => {
    const loader = div.querySelector('#loader-hypothese');
    const resultDiv = div.querySelector('#result-hypothese');
    loader.style.display = 'block'; 
    resultDiv.innerHTML = '';
    
    const profileSummary = getProfileSummary();
    if (profileSummary.includes("L'√©l√®ve n'a pas encore rempli")) {
        showInfoModal("Action requise", "Pour obtenir des suggestions, veuillez d'abord compl√©ter l'√©tape 'Mieux se conna√Ætre'.");
        loader.style.display = 'none';
        return;
    }

    const prompt = `Agis comme un conseiller d'orientation cr√©atif. En te basant sur le profil suivant d'un √©l√®ve de Seconde : "${profileSummary}", sugg√®re-lui 6 id√©es originales de secteurs ou de types de stage d'observation. Pour chaque id√©e, explique en une phrase pourquoi elle correspond √† son profil. Formate ta r√©ponse en Markdown.`;

    const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
    
    loader.style.display = 'none';
    resultDiv.innerHTML = marked.parse(result);
});

// REMPLACEZ VOTRE √âV√âNEMENT DE CLIC POUR LE BOUTON "PR√âPARER LE CONTACT" PAR CE BLOC COMPLET :

div.querySelector('#prepare-contact-btn').addEventListener('click', async () => {
    const secteur = div.querySelector('#hypothese-secteur').value.trim();
    const notes = div.querySelector('#hypothese-notes').value.trim(); // <-- CETTE LIGNE EST ESSENTIELLE
    
    if (!secteur) {
        showInfoModal("Veuillez renseigner un secteur ou une id√©e de stage.");
        return;
    }

    const loader = div.querySelector('#loader-hypothese');
    const resultDiv = div.querySelector('#result-hypothese');
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const profileSummary = getProfileSummary();

    const prompt = `
Agis comme un coach carri√®re expert qui aide un(e) lyc√©en(ne) √† r√©diger une candidature percutante pour son stage de Seconde.

# Contexte
- **Profil de l'√©l√®ve :** ${profileSummary}
- **Secteur de stage vis√© :** "${secteur}"
- **Ce qui l'attire (notes personnelles) :** "${notes}"

# Ta Mission
R√©dige un mod√®le d'e-mail de candidature qui soit √† la fois professionnel et personnalis√©, montrant une v√©ritable r√©flexion.

## R√®gle Absolue de Ton
Le ton de l'e-mail doit rester professionnel. **N'utilise JAMAIS les termes issus du jargon de l'application** comme "Arch√©type", "Exploratrice", "Architecte", etc. Tu dois traduire les **traits de caract√®re** du profil (curiosit√©, logique, cr√©ativit√©...) en qualit√©s humaines, sans jamais nommer les profils.

# Structure de l'e-mail (Imp√©ratif)
1.  **Objet :** Propose un objet de mail clair et professionnel.
2.  **Introduction :** Une introduction simple (qui il/elle est, ce qu'il/elle cherche).
3.  **Paragraphe "Pourquoi vous ?" (Le plus important) :** Un paragraphe expliquant son int√©r√™t pour le secteur. **Fais un lien subtil entre les qualit√©s issues du profil de l'√©l√®ve ET/OU ses notes personnelles, et le secteur vis√©.**
4.  **Paragraphe "Ce que j'esp√®re apprendre" :** Un court paragraphe sur ce qu'il/elle esp√®re d√©couvrir durant le stage.
5.  **Logistique et Cl√¥ture :** Les informations pratiques et une formule de politesse.
6.  **Placeholders :** Utilise des placeholders clairs comme [Nom de l'entreprise], [Nom du destinataire], [Date de d√©but], etc.

# Conseil final
√Ä la toute fin, apr√®s la signature, ajoute une section distincte intitul√©e "--- Conseil du Coach ---" avec un conseil tr√®s court.
    `;

    const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
    
    loader.style.display = 'none';
    
    const parts = result.split("--- Conseil du Coach ---");
    const emailBody = parts[0];
    const coachTip = parts[1] || '';

    resultDiv.innerHTML = `
        <div class="whitespace-pre-wrap text-sm p-4 bg-white border rounded-lg">${emailBody.trim()}</div>
        ${coachTip ? `<div class="mt-4 p-3 bg-amber-50 border-l-4 border-amber-400 text-sm text-amber-800 font-semibold">${coachTip.trim()}</div>` : ''}
    `;
    currentHypothese.modele_contact = result;
});
    
    div.querySelector('#save-hypothese-btn').addEventListener('click', async () => {
        currentHypothese.titre = div.querySelector('#hypothese-secteur').value.trim();
        currentHypothese.ville = div.querySelector('#hypothese-ville').value.trim();
        currentHypothese.notes = div.querySelector('#hypothese-notes').value.trim();
        if (!currentHypothese.titre || !currentHypothese.ville) { showInfoModal("Veuillez renseigner au moins le secteur et la ville."); return; }
        journalData.step13.hypotheses.push(JSON.parse(JSON.stringify(currentHypothese)));
        await saveData();
        await grantXp(25);
        renderSavedHypotheses();
        resetHypotheseWorkspace();
        showSurpriseModal("Hypoth√®se sauvegard√©e !", "<p>Cette piste de recherche est maintenant dans ton journal.</p>", 3000);
    });

    // NOUVEAU : √âv√©nement pour le bouton de relecture du rapport
div.querySelector('#review-report-btn').addEventListener('click', async () => {
    const brouillon = div.querySelector('#bilan-brouillon').value.trim();
    const loader = div.querySelector('#loader-bilan');
    const resultDiv = div.querySelector('#result-bilan');
    if (!brouillon) { showInfoModal("Veuillez coller le brouillon de votre rapport."); return; }
    
    loader.style.display = 'block';
    resultDiv.innerHTML = '';

    const prompt = `
        Agis comme un tuteur bienveillant qui relit le rapport de stage d'un √©l√®ve de Seconde.
        Ton r√¥le n'est PAS de r√©√©crire le texte, mais de l'aider √† l'am√©liorer par lui-m√™me.

        # Brouillon de l'√©l√®ve :
        """\${brouillon}"""

        # Ta Mission
        Fournis une liste d'annotations constructives au format Markdown. Pour chaque point :
        1.  **Cite** une phrase ou un passage cl√© entre guillemets.
        2.  **Analyse** ce passage (ex: "C'est une bonne observation", "Essaie d'√™tre plus pr√©cis", "Peux-tu lier √ßa √† une comp√©tence ?").
        3.  **Sugg√®re une action** sous forme de question pour guider l'√©l√®ve.

        # Exemple de retour :
        - > **"J'ai observ√© le v√©t√©rinaire faire une consultation."** : C'est un bon d√©but, mais peux-tu √™tre plus sp√©cifique ? Qu'as-tu observ√© exactement ? (les questions pos√©es, les gestes techniques...).
        - > **"J'ai appris √† √™tre organis√©."** : Excellent ! Peux-tu donner un exemple concret o√π tu as d√ª faire preuve d'organisation pendant le stage ?
    `;

    const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
    loader.style.display = 'none';
    resultDiv.innerHTML = marked.parse(result);
    currentBilan.analyse_rapport = result; // On sauvegarde l'analyse
});


    // --- LOGIQUE SP√âCIFIQUE √Ä L'ATELIER 2 : BILANS D'EXP√âRIENCE ---
    const renderSavedBilans = () => {
    const container = div.querySelector('#bilans-list-container');
    const bilans = journalData.step13.bilans || [];
    if (bilans.length === 0) {
        container.innerHTML = `<p class="text-center text-slate-500 p-4 bg-background-light rounded-lg">Aucun bilan sauvegard√©.</p>`;
        return;
    }
    container.innerHTML = bilans.map((bilan, index) => {
        let content = '';
        
        if (bilan.analyse_rapport) {
            content += `<h4 class="font-semibold mb-1">Brouillon du rapport :</h4><p class="whitespace-pre-wrap text-sm mb-3 p-2 bg-white rounded border">${bilan.brouillon}</p>
                        <h4 class="font-semibold mb-1">Analyse du Rapport :</h4><div class="prose prose-sm max-w-none">${marked.parse(bilan.analyse_rapport)}</div>`;
        } else {
            if (bilan.missions) content += `<p><strong>Missions :</strong> ${bilan.missions}</p>`;
            if (bilan.apprentissages) content += `<p><strong>Apprentissages :</strong> ${bilan.apprentissages}</p>`;
            if (bilan.ressenti) content += `<p><strong>Ressenti :</strong> ${bilan.ressenti}</p>`;
        }

        const deleteButtonHTML = `<button type="button" data-index="${index}" class="delete-bilan-btn text-red-500 hover:text-red-700 p-1">üóëÔ∏è</button>`;
        return `<details class="bg-background-light rounded-lg border">
                    <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                        <span>${bilan.titre}</span>${deleteButtonHTML}
                    </summary>
                    <div class="p-3 border-t space-y-2">${content}</div>
                </details>`;
    }).join('');
};

    const resetBilanWorkspace = () => {
        currentBilan = { titre: '', missions: '', apprentissages: '', ressenti: '', plan_rapport: '', competences_extraites: '' };
        div.querySelector('#bilan-titre').value = '';
        div.querySelector('#bilan-missions').value = '';
        div.querySelector('#bilan-apprentissages').value = '';
        div.querySelector('#bilan-ressenti').value = '';
        div.querySelector('#result-bilan').innerHTML = '';
    };

    const getBilanDescriptionForAI = () => {
        const missions = div.querySelector('#bilan-missions').value.trim();
        const apprentissages = div.querySelector('#bilan-apprentissages').value.trim();
        const ressenti = div.querySelector('#bilan-ressenti').value.trim();
        if (!missions && !apprentissages && !ressenti) { return null; }
        return `Missions et observations : ${missions}\n\nCe que j'ai appris : ${apprentissages}\n\nMon ressenti : ${ressenti}`.trim();
    };

    div.querySelector('#get-plan-btn').addEventListener('click', async () => {
        const description = getBilanDescriptionForAI();
        if (!description) { showInfoModal("Veuillez d√©crire votre exp√©rience dans au moins une des trois cases."); return; }
        const loader = div.querySelector('#loader-bilan');
        const resultDiv = div.querySelector('#result-bilan');
        loader.style.display = 'block'; resultDiv.innerHTML = '';
        const prompt = `Agis comme un tuteur de stage. Un √©l√®ve de Seconde a d√©crit son exp√©rience : "${description}". Propose-lui un plan de rapport de stage simple en 4 parties. Pour chaque partie, donne 2-3 questions pour le guider.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.textContent = result;
        currentBilan.plan_rapport = result;
    });

    div.querySelector('#extract-skills-btn').addEventListener('click', async () => {
        const description = getBilanDescriptionForAI();
        if (!description) { showInfoModal("Veuillez d√©crire votre exp√©rience dans au moins une des trois cases."); return; }
        const loader = div.querySelector('#loader-bilan');
        const resultDiv = div.querySelector('#result-bilan');
        loader.style.display = 'block'; resultDiv.innerHTML = '';
        const prompt = `Agis comme un coach carri√®re. Lis ce r√©cit de stage : "${description}". Identifie 3 √† 5 comp√©tences cl√©s. Pour chaque comp√©tence, explique en une phrase pourquoi elle est importante pour son orientation. Formate en Markdown.`;
        const result = await callOpenAI_API({ promptText: prompt, withPersona: true });
        loader.style.display = 'none';
        resultDiv.innerHTML = marked.parse(result);
        currentBilan.competences_extraites = result;
    });

    div.querySelector('#save-bilan-btn').addEventListener('click', async () => {
    currentBilan.titre = div.querySelector('#bilan-titre').value.trim();
    if (!currentBilan.titre) { showInfoModal("Veuillez donner un nom √† cette exp√©rience."); return; }
    
    // On r√©cup√®re toutes les valeurs, y compris le nouveau brouillon
    currentBilan.brouillon = div.querySelector('#bilan-brouillon').value.trim();
    currentBilan.missions = div.querySelector('#bilan-missions').value.trim();
    currentBilan.apprentissages = div.querySelector('#bilan-apprentissages').value.trim();
    currentBilan.ressenti = div.querySelector('#bilan-ressenti').value.trim();
    
    journalData.step13.bilans.push(JSON.parse(JSON.stringify(currentBilan)));
    await saveData();
    await grantXp(25);
    renderSavedBilans();
    resetBilanWorkspace();
    showSurpriseModal("Bilan sauvegard√© !", "Ce bilan est maintenant dans ton journal.", 3000);
});
    
    // --- GESTION DES SUPPRESSIONS ET INTERACTIONS DANS LES LISTES ---
    div.addEventListener('click', async (e) => {
        const deleteHypotheseBtn = e.target.closest('.delete-hypothese-btn');
        const deleteBilanBtn = e.target.closest('.delete-bilan-btn');
        const saveToPortfolioBtn = e.target.closest('.save-to-portfolio-btn');

        if (deleteHypotheseBtn) {
            const index = deleteHypotheseBtn.dataset.index;
            if (await showConfirmationModal("Supprimer cette hypoth√®se de stage ?")) {
                journalData.step13.hypotheses.splice(index, 1);
                await saveData();
                renderSavedHypotheses();
            }
        }
        if (deleteBilanBtn) {
            const index = deleteBilanBtn.dataset.index;
            if (await showConfirmationModal("Supprimer ce bilan d'exp√©rience ?")) {
                journalData.step13.bilans.splice(index, 1);
                await saveData();
                renderSavedBilans();
            }
        }
        if (saveToPortfolioBtn) {
            const index = saveToPortfolioBtn.dataset.index;
            const bilanToSave = journalData.step13.bilans[index];
            if (bilanToSave && bilanToSave.competences_extraites) {
                if (!journalData.step10) journalData.step10 = { experiences: [] };
                if (!Array.isArray(journalData.step10.experiences)) journalData.step10.experiences = [];
                journalData.step10.experiences.push({ analysis: bilanToSave.competences_extraites });
                await saveData();
                await grantXp(50);
                showSurpriseModal("Bilan ajout√© au Portfolio !", "<p>Cette analyse de comp√©tences est maintenant visible dans ton <strong>Portfolio (√©tape 10)</strong>.</p>");
                saveToPortfolioBtn.textContent = 'Ajout√© ‚úî';
                saveToPortfolioBtn.disabled = true;
            }
        }
    });

    // --- INITIALISATION DE LA VUE ---
    renderSavedHypotheses();
    renderSavedBilans();
    return div;
}
// ==================== FIN DU BLOC DE REMPLACEMENT ====================
// ==================== FIN DU BLOC DE REMPLACEMENT ====================
  function createRetroplanningView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

        const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];

    // --- √âTAPE 1 : La "Source de V√©rit√©" - Les plannings par niveau sont inscrits en dur dans le code ---
    const retroplanningData = {
        seconde: [
            // ... (pas de changement pour la Seconde)
            { month: "Septembre", tasks: ["Prendre ses marques au lyc√©e, identifier ses points forts et ses difficult√©s.", "Utiliser l'√©tape 'Mieux se conna√Ætre' pour faire un premier point sur son profil."] },
            { month: "Octobre", tasks: ["Participer aux semaines de l'orientation si organis√©es par le lyc√©e.", "Explorer 2 ou 3 secteurs d'activit√© via l'√©tape 'Les Fondations'."] },
            { month: "Novembre", tasks: ["Pr√©parer le premier conseil de classe : faire un bilan de ses r√©sultats.", "Commencer √† manipuler 'Le simulateur de sp√©cialit√©s' pour voir les possibilit√©s."] },
            { month: "D√©cembre", tasks: ["Analyser son premier bulletin et d√©finir des axes d'am√©lioration.", "Discuter de ses premi√®res explorations avec ses proches et son professeur principal."] },
            { month: "Janvier", tasks: ["D√©but de la phase de dialogue sur l'orientation : prendre connaissance de la 'fiche dialogue'.", "Utiliser 'Rencontres sur mon Territoire' pour rep√©rer les Journ√©es Portes Ouvertes (JPO) √† venir."] },
            { month: "F√©vrier", tasks: ["Participer √† des JPO ou des salons pour se faire une id√©e concr√®te des formations.", "Explorer les formations post-bac li√©es aux sp√©cialit√©s envisag√©es avec 'Le Catalogue'."] },
            { month: "Mars", tasks: ["Remplir la fiche de dialogue avec ses v≈ìux provisoires de sp√©cialit√©s.", "Utiliser 'L'Exp√©rience' pour pr√©parer des questions √† poser √† des √©tudiants ou des professionnels."] },
            { month: "Avril", tasks: ["Confirmer ses choix et pr√©parer les arguments pour le conseil de classe du 3√®me trimestre.", "Commencer activement la recherche d'un lieu pour le stage d'observation."] },
            { month: "Mai", tasks: ["Le conseil de classe formule un avis sur les v≈ìux de sp√©cialit√©s.", "Finaliser l'organisation de son stage avec l'√©tape 'Passer √† l'action'."] },
            { month: "Juin", tasks: ["Effectuer son stage d'observation obligatoire de deux semaines.", "Commencer la r√©daction du rapport de stage et le valoriser dans 'Mon Portfolio de Comp√©tences'."] },
            { month: "Juillet", tasks: ["Faire le bilan de son ann√©e, de son stage et des choix valid√©s.", "Se reposer !"] }
        ],
        premiere: [
            // ... (pas de changement pour la Premi√®re)
            { month: "Septembre", tasks: ["Consolider les m√©thodes de travail dans ses 3 sp√©cialit√©s.", "Approfondir sa connaissance de 2 m√©tiers pr√©cis avec l'√©tape 'Les Fondations'."] },
            { month: "Octobre", tasks: ["Pr√©parer les premi√®res √©valuations comptant pour le baccalaur√©at.", "Utiliser 'Le Catalogue' pour lier ses sp√©cialit√©s √† des formations post-bac pr√©cises."] },
            { month: "Novembre", tasks: ["Travailler la m√©thodologie des √©preuves anticip√©es de Fran√ßais (dissertation, commentaire).", "Utiliser 'Fact Checking' pour d√©construire les id√©es re√ßues sur les fili√®res vis√©es."] },
            { month: "D√©cembre", tasks: ["Faire le bilan du premier trimestre et identifier la sp√©cialit√© la moins investie.", "Commencer √† valoriser ses projets et exp√©riences dans 'Mon Portfolio de Comp√©tences'."] },
            { month: "Janvier", tasks: ["Participer aux JPO et salons avec des questions cibl√©es.", "Remplir la fiche de dialogue pour le choix de la sp√©cialit√© de Terminale."] },
            { month: "F√©vrier", tasks: ["D√©cider de la sp√©cialit√© qui sera abandonn√©e en Terminale.", "Simuler l'impact de ce choix avec 'Le simulateur de sp√©cialit√©s' pour confirmer."] },
            { month: "Mars", tasks: ["D√©buter les r√©visions intensives pour les √©preuves anticip√©es de Fran√ßais.", "Utiliser 'Passer √† l'action' pour planifier des rencontres avec des professionnels."] },
            { month: "Avril", tasks: ["S'entra√Æner pour l'oral de fran√ßais (pr√©paration des textes).", "Utiliser le 'Simulateur Vie √âtudiante' pour se projeter financi√®rement dans diff√©rentes villes."] },
            { month: "Mai", tasks: ["Finaliser les r√©visions du bac de Fran√ßais.", "Faire le point sur l'avancement de son projet d'orientation avant la Terminale."] },
            { month: "Juin", tasks: ["Passer les √©preuves anticip√©es de Fran√ßais (√©crit et oral).", "R√©fl√©chir aux th√®mes possibles pour le Grand Oral de Terminale."] },
            { month: "Juillet", tasks: ["Faire le bilan de l'ann√©e et pr√©parer sa rentr√©e en Terminale.", "Se reposer !"] }
        ],
        terminale: [
            // --- VERSION CORRIG√âE POUR LA TERMINALE ---
            { month: "Septembre", tasks: ["Se familiariser avec le calendrier Parcoursup de l'ann√©e.", "Finaliser sa liste de formations cibles avec 'Le Catalogue'."] },
            { month: "Octobre", tasks: ["Participer aux salons d'orientation pour confirmer ses choix.", "Utiliser 'Mon Portfolio de Comp√©tences' pour rassembler tous les √©l√©ments √† valoriser."] },
            { month: "Novembre", tasks: ["Commencer la r√©daction des brouillons pour la rubrique 'Activit√©s et centres d'int√©r√™t' de Parcoursup.", "Utiliser 'Pr√©parer sa candidature' pour structurer ses premiers projets de formation motiv√©s."] },
            { month: "D√©cembre", tasks: ["Profiter des vacances pour avancer sur la r√©daction des projets motiv√©s.", "Faire le bilan du premier trimestre et valider ses choix de sp√©cialit√©s pour le bac."] },
            { month: "Janvier", tasks: ["Ouverture de la plateforme Parcoursup : s'inscrire et commencer √† formuler ses v≈ìux.", "Choisir ses deux questions pour le Grand Oral et commencer les recherches."] },
            { month: "F√©vrier", tasks: ["Poursuivre la saisie des v≈ìux et la r√©daction des projets motiv√©s.", "Se pr√©parer pour les derni√®res √©valuations comptant pour le contr√¥le continu."] },
            // MODIFI√â
            { month: "Mars", tasks: ["Date limite pour formuler ses v≈ìux sur Parcoursup (mi-mars).", "Commencer √† organiser ses fiches de r√©vision pour les √©preuves finales."] },
            { month: "Avril", tasks: ["Date limite pour finaliser son dossier et confirmer chaque v≈ìu sur Parcoursup (d√©but avril).", "Utiliser l'√©tape 'Anticiper la suite' pour pr√©parer un plan B en cas de r√©ponses n√©gatives."] },
            // MODIFI√â
            { month: "Mai", tasks: ["Intensifier les r√©visions finales : Philosophie, Grand Oral ET les deux √©preuves de sp√©cialit√©.", "D√©but de la phase d'admission principale de Parcoursup (fin mai) : r√©ception des r√©ponses."] },
            // MODIFI√â
            { month: "Juin", tasks: ["Passer les √©preuves finales : Philosophie, Grand Oral et les deux √©preuves de sp√©cialit√©.", "G√©rer les r√©ponses de Parcoursup et la phase d'admission compl√©mentaire si besoin."] },
            { month: "Juillet", tasks: ["R√©pondre d√©finitivement √† la derni√®re proposition d'admission et s'inscrire administrativement.", "F√™ter l'obtention du baccalaur√©at !"] }
        ]
    };

    // --- √âTAPE 2 : Le HTML de la page, simple et structur√© ---
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-center flex justify-center items-center gap-2 text-OrIAntation-darkblue mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 12.75h.008v.008H12v-.008Z" /></svg>
            <span>Mon R√©troplanning</span>
        </h1>
        <div class="text-slate-600 mb-4 space-y-2">
            <p>Pour ton orientation, un bon planning est essentiel ! Cet outil part des grandes √©ch√©ances de ton ann√©e et te propose un plan d'action mois par mois pour y arriver sans stress.</p>
        </div>
        <div class="bg-cyan-50 border-l-4 border-cyan-400 p-4 rounded-r-lg my-6"><p class="font-semibold text-cyan-900"><b>Ta mission :</b> Clique sur le bouton pour obtenir ton planning et tes conseils personnalis√©s. Coche ensuite les cases au fur et √† mesure de ton avanc√©e !</p></div>
        <div class="text-center mb-6">
            <button type="button" id="openaiBtn_retro" class="bg-cyan-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-cyan-700 transition">üìÖ G√©n√©rer / Mettre √† jour mon R√©troplanning</button>
        </div>
        <div class="my-8 p-4 bg-background-light border border-border-subtle rounded-lg">
             <h3 class="font-bold text-OrIAntation-darkblue mb-3">Ajouter un √©v√©nement personnalis√©</h3>
             <div class="flex flex-col sm:flex-row gap-2">
                 <input type="text" id="custom-event-text" class="w-full p-2 border border-slate-300 rounded-lg" placeholder="Description (ex: JPO du Lyc√©e X)">
                 <input type="date" id="custom-event-date" class="p-2 border border-slate-300 rounded-lg">
                 <button type="button" id="add-custom-event-btn" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 transition whitespace-nowrap">Ajouter</button>
             </div>
        </div>
        <div id="openaiLoader_retro" class="hidden"><div class="loader"></div></div>
        <div id="retroplanning-content"></div>
    `;

    const retroplanningContent = div.querySelector('#retroplanning-content');
    const retroForm = div.querySelector('#retroForm');
    
    const renderTimeline = () => {
        if (!journalData.retroplanning || !journalData.retroplanning.tasks || journalData.retroplanning.tasks.length === 0) {
            retroplanningContent.innerHTML = `<p ...>Cliquez sur "G√©n√©rer"...</p>`;
            return;
        }
        let isAlreadySaved = false;
    const currentConseils = journalData.retroplanning.rawText;
    if (currentConseils && (journalData.retroplanning_saves?.length ?? 0) > 0) {
        const currentConseilsString = JSON.stringify(currentConseils);
        isAlreadySaved = journalData.retroplanning_saves.some(savedItem => 
            JSON.stringify(savedItem.conseils) === currentConseilsString
        );
    }

        let timelineHTML = journalData.retroplanning.tasks.map((monthData, monthIndex) => {
        const tasksHTML = monthData.tasks.map((task, taskIndex) => `
            <li class="flex items-start mb-2">
                <input type="checkbox" id="task-${monthIndex}-${taskIndex}" class="mt-1 h-4 w-4 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500" ${task.completed ? 'checked' : ''}>
                <label for="task-${monthIndex}-${taskIndex}" class="ml-3 text-slate-700 ${task.completed ? 'line-through text-slate-400' : ''}">${task.text}</label>
            </li>
        `).join('');
        return `<div class="mb-6"><h3 class="font-bold text-cyan-700 text-lg mb-2">${monthData.month}</h3><ul class="list-none pl-0">${tasksHTML}</ul></div>`;
    }).join('');

        let conseilHTML = '';
    const conseils = journalData.retroplanning.rawText;
    if (conseils && typeof conseils === 'object') {
        for (const key in conseils) {
            if (Object.prototype.hasOwnProperty.call(conseils, key)) {
                const value = conseils[key];
                const title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                conseilHTML += `<h4 class="font-bold text-OrIAntation-darkblue mt-4 mb-2">${title}</h4><p class="whitespace-pre-wrap text-slate-600 text-sm">${value}</p>`;
            }
        }
    }
    
    // ‚úÖ NOUVELLE LOGIQUE D'AFFICHAGE AVEC LE BOUTON D'ENREGISTREMENT
    retroplanningContent.innerHTML = `
        <div>
            <h2 class="text-2xl font-bold text-center mb-6 text-OrIAntation-darkblue">Ta Feuille de Route</h2>
            ${timelineHTML}
            <div class="mt-8 bg-background-light p-6 rounded-lg border border-border-subtle">
                <h3 class="text-xl font-bold text-center text-OrIAntation-darkblue mb-2">Les conseils d√©taill√©s d'OrIA :</h3>
                <div id="conseils-content">${conseilHTML}</div>
                <div class="text-center mt-6">
                    <button type="button" id="save-conseils-btn" class="text-white font-semibold py-2 px-4 rounded-lg transition ${isAlreadySaved ? 'bg-gray-400 cursor-not-allowed' : 'bg-teal-600 hover:bg-teal-700'}" ${isAlreadySaved ? 'disabled' : ''}>
                        ${isAlreadySaved ? 'Enregistr√© ‚úî' : 'Enregistrer ces conseils dans le journal'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // On ajoute l'√©couteur pour le nouveau bouton
    const saveConseilsBtn = retroplanningContent.querySelector('#save-conseils-btn');
    if (saveConseilsBtn) {
        saveConseilsBtn.addEventListener('click', async () => {
            if (!journalData.retroplanning_saves) {
                journalData.retroplanning_saves = [];
            }
            journalData.retroplanning_saves.push({
                date: new Date().toISOString().split('T')[0],
                conseils: journalData.retroplanning.rawText
            });
            await saveData();
            saveConseilsBtn.textContent = 'Enregistr√© ! ‚úî';
            saveConseilsBtn.disabled = true;

            const tutorialShown = await handleOnboarding({ from: 'retroplanning_save' });
                // Si le tutoriel est termin√©, on propose de retourner au menu
                if (!tutorialShown) {
                    const goBackBtn = document.createElement('button');
                    goBackBtn.className = 'w-full mt-4 bg-slate-200 text-OrIAntation-darkblue font-semibold py-3 px-6 rounded-lg hover:bg-slate-300 transition';
                    goBackBtn.textContent = 'Retourner au menu';
                    goBackBtn.onclick = () => showView('menu');
                    retroplanningContent.appendChild(goBackBtn);
                }
            });
        }
    

    // Le reste de la logique (checkboxes et formulaire) ne change pas
    retroplanningContent.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            // ...
        });
    });
};

    // ‚ñº‚ñº‚ñº REMPLACEZ L'√âV√âNEMENT DU BOUTON '#add-custom-event-btn' PAR CE BLOC ‚ñº‚ñº‚ñº

div.querySelector('#add-custom-event-btn').addEventListener('click', async () => {
    const textInput = div.querySelector('#custom-event-text');
    const dateInput = div.querySelector('#custom-event-date');
    const eventText = textInput.value.trim();
    const eventDate = dateInput.value;

    if (!eventText || !eventDate) {
        showInfoModal("Veuillez renseigner une description ET une date.");
        return;
    }
    if (!journalData.retroplanning || !Array.isArray(journalData.retroplanning.tasks)) {
        showInfoModal("Veuillez d'abord g√©n√©rer un R√©troplanning.");
        return;
    }

    const monthNames = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
    
    // Correction pour √©viter les probl√®mes de fuseau horaire qui peuvent changer le jour
    const dateObj = new Date(eventDate);
    const adjustedDate = new Date(dateObj.getTime() + Math.abs(dateObj.getTimezoneOffset()*60000));
    
    const monthIndex = adjustedDate.getMonth();
    const monthName = monthNames[monthIndex];
    
    // On formate la date pour l'afficher √† c√¥t√© du texte (ex: " (02/10)")
    const formattedDate = ` (${String(adjustedDate.getDate()).padStart(2, '0')}/${String(monthIndex + 1).padStart(2, '0')})`;
    
    let monthObject = journalData.retroplanning.tasks.find(m => m.month === monthName);
    if (!monthObject) {
        monthObject = { month: monthName, tasks: [] };
        journalData.retroplanning.tasks.push(monthObject);
        // On s'assure que les mois restent dans le bon ordre
        journalData.retroplanning.tasks.sort((a, b) => monthNames.indexOf(a.month) - monthNames.indexOf(b.month));
    }
    
    // On ajoute la t√¢che AVEC sa date format√©e
    monthObject.tasks.push({ text: eventText + formattedDate, completed: false });
    
    textInput.value = '';
    dateInput.value = '';
    
    // On sauvegarde les modifications
    await saveData();
    
    // On rafra√Æchit l'affichage
    renderTimeline();
});

    div.querySelector('#openaiBtn_retro').addEventListener('click', async () => {
    if (!userGradeLevel) {
        showInfoModal("Les donn√©es de votre profil sont en cours de chargement.");
        return;
    }
    
    // Message d'attente (inchang√©)
    retroplanningContent.innerHTML = `
        <div class="text-center p-4">
            <div class="loader"></div>
            <p class="text-slate-500 font-semibold mt-2">OrIA est en train de construire ta feuille de route personnalis√©e...</p>
            <p class="text-sm text-slate-400 mt-1">Cette op√©ration peut prendre jusqu'√† une minute.</p>
        </div>
    `;
    
    const masterTasks = retroplanningData[userGradeLevel];
    const profileSummary = getProfileSummary();
    const appFeaturesSummary = getAppFeaturesSummary();

    // ‚úÖ √âTAPE 1 : On d√©finit les "micro-missions" √† accomplir selon la classe
    let missions = {};
    switch(userGradeLevel) {
        case 'seconde':
            missions = {
                conseilConnexionProfilMetiers: "- Pour 'conseilConnexionProfilMetiers': C'est le premier conseil. L'√©l√®ve a son profil. La mission est de l'aider √† le connecter √† des pistes concr√®tes. Sugg√®re-lui d'utiliser 'Les Fondations' pour explorer 2-3 familles de m√©tiers qui correspondent √† son arch√©type (ex: si 'Artisan', explorer les m√©tiers du b√¢timent ou de la nature). Sugg√®re aussi d'utiliser le 'Radar √† Opportunit√©s' pour une piste plus cr√©ative.",
                conseilExplorationStrategique: "- Pour 'conseilExplorationStrategique': C'est le deuxi√®me conseil. Maintenant qu'il a des pistes de m√©tiers, il doit trouver les bonnes sp√©cialit√©s. Propose-lui d'utiliser le 'Simulateur de sp√©cialit√©s' pour tester les combinaisons qui m√®nent aux m√©tiers qu'il a identifi√©s √† l'√©tape pr√©c√©dente.",
                conseilStageDeSeconde: "- Pour 'conseilStageDeSeconde': C'est le troisi√®me conseil, ax√© sur l'action. Rappelle l'importance du stage d'observation et guide-le vers l'√©tape 'Passer √† l'action' pour trouver des id√©es de lieux et pr√©parer son mail de candidature."
            };
            break;
        case 'premiere':
            missions = {
                conseilStrategieAnnee: "- Pour 'conseilStrategieAnnee': Donne un conseil sur la strat√©gie √† adopter en Premi√®re. Insiste sur le fait que c'est l'ann√©e pour approfondir ses sp√©cialit√©s et confirmer ses choix en les liant √† des projets post-bac concrets (BUT, Licence, Pr√©pa...). Sugg√®re d'utiliser 'Le Catalogue' et 'Les Fondations' pour cela.",
                conseilAbandonSpecialite: "- Pour 'conseilAbandonSpecialite': Donne une m√©thode claire en 3 points pour aider √† d√©cider quelle sp√©cialit√© abandonner en fin d'ann√©e. Sugg√®re d'utiliser le 'Simulateur de sp√©cialit√©s' pour √©valuer l'impact de ce choix.",
                conseilDossierParcoursup: "- Pour 'conseilDossierParcoursup': Donne un conseil pour pr√©parer d√®s la Premi√®re son dossier Parcoursup. Explique que les notes et appr√©ciations de cette ann√©e sont cruciales. Sugg√®re de commencer √† utiliser 'Mon Portfolio de Comp√©tences' pour valoriser ses exp√©riences et de jeter un ≈ìil √† l'√©tape 'Pr√©parer sa candidature' pour comprendre ce qui sera demand√© en Terminale."
            };
            break;
        case 'terminale':
            missions = {
                conseilMasterclassParcoursup: "- Pour 'conseilMasterclassParcoursup': Donne une strat√©gie en 3 √©tapes pour un dossier Parcoursup percutant. 1) Utiliser 'Mon Portfolio de Comp√©tences' pour lister toutes ses exp√©riences et comp√©tences. 2) Se servir de cette liste pour remplir la rubrique 'Activit√©s et centres d'int√©r√™t'. 3) Utiliser l'atelier 'Pr√©parer sa candidature' pour r√©diger chaque projet de formation motiv√©.",
                conseilStrategieGrandOral: "- Pour 'conseilStrategieGrandOral': Donne un conseil pour trouver un bon sujet pour le Grand Oral. Sugg√®re de relire les synth√®ses de 'Mieux se conna√Ætre' et 'Mon Portfolio' pour trouver un sujet qui soit √† la fois li√© √† ses sp√©cialit√©s ET √† son projet personnel, ce qui est tr√®s valoris√© par le jury.",
                conseilAnticipationPlanB: "- Pour 'conseilAnticipationPlanB': Donne un conseil pour g√©rer le stress de l'attente des r√©sultats. Explique l'importance de pr√©parer un 'Plan B' et sugg√®re d'utiliser l'√©tape 'Anticiper la suite' pour r√©fl√©chir sereinement √† des alternatives en cas de r√©ponse n√©gative au v≈ìu n¬∞1."
            };
            break;
    }

    // ‚úÖ √âTAPE 2 : On cr√©e une fonction qui g√©n√®re un prompt cibl√© pour UNE SEULE mission
    const createMicroPrompt = (instruction) => {
        return `
            Agis comme un coach d'orientation strat√©gique et concis.
            Le profil de l'√©l√®ve est : "${profileSummary}".
            # Contexte de l'Application
            Tes suggestions doivent utiliser les fonctionnalit√©s d√©crites ci-dessous. N'en invente aucune.
            ${appFeaturesSummary}
            # Ta Mission
            Ta seule mission est de r√©pondre √† cette instruction :
            ${instruction}
            # Format de Sortie
            Ta r√©ponse doit √™tre un unique paragraphe de texte clair et actionnable. Ne retourne PAS de JSON, juste le texte du conseil.
        `;
    };

    try {
        // ‚úÖ √âTAPE 3 : On cr√©e un tableau de promesses (une pour chaque mission)
        const promises = Object.entries(missions).map(([key, instruction]) => {
            const microPrompt = createMicroPrompt(instruction);
            // On retourne la promesse de l'appel API
return callOpenAI_API({
        promptText: microPrompt,
        model: 'gpt-4o',      //
        withPersona: true    // On n'oublie pas d'activer le persona
    }).then(result => ({ key, result }));
});
        // ‚úÖ √âTAPE 4 : On lance toutes les missions en parall√®le !
        const resultsArray = await Promise.all(promises);

        // ‚úÖ √âTAPE 5 : On rassemble les r√©sultats dans un seul objet JSON
        const conseilsResult = resultsArray.reduce((acc, { key, result }) => {
            acc[key] = result;
            return acc;
        }, {});

        if (!conseilsResult) throw new Error("OrIA n'a pas pu g√©n√©rer les conseils d√©taill√©s.");

        // Le reste de la logique est inchang√©
        journalData.retroplanning = {
            tasks: masterTasks.map(month => ({ ...month, tasks: month.tasks.map(taskText => ({ text: taskText, completed: false })) })),
            rawText: conseilsResult
        };
        
        await saveData({ skipOnboarding: true });
        renderTimeline();
        await grantXp(50);

    } catch (e) {
        console.error("Erreur lors de la g√©n√©ration des conseils:", e);
        retroplanningContent.innerHTML = `<p class="text-center text-red-500">D√©sol√©, une erreur est survenue lors de la g√©n√©ration des conseils. Veuillez r√©essayer.</p>`;
    }
});

    renderTimeline();
    
    return div;
}

async function createJournalView() {
    // On construit un objet userInfo complet, en y ajoutant le niveau de classe
    const userInfoForJournal = {
        ...currentUserInfo, // Copie les informations existantes (pr√©nom, nom...)
        gradeLevel: userGradeLevel // Ajoute le niveau de la classe qui manquait
    };
    // On appelle la fonction d'affichage avec l'objet d'information complet
    return createUnifiedJournalView(userInfoForJournal, journalData, 'student');
}


// =================================================================================
// FONCTION UNIFI√âE FINALE ET COMPL√àTE POUR L'AFFICHAGE DU JOURNAL
// =================================================================================
// =================================================================================
// REMPLACEZ VOTRE FONCTION createUnifiedJournalView EXISTANTE PAR CE BLOC COMPLET
// =================================================================================
async function createUnifiedJournalView(userInfo, journalDataToDisplay, context) {
    // 1. Cr√©ation du conteneur principal de la page
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle';

    // ---- On utilise temporairement les donn√©es pass√©es en param√®tres ----
    const originalJournalData = journalData;
    const originalUserGradeLevel = userGradeLevel;
    journalData = journalDataToDisplay;
    userGradeLevel = userInfo.gradeLevel;

    // ---- Construction de l'HTML ----
    const progressBarHTML = createProgressBarHTML();
    const headerEl = document.createElement('div');
    headerEl.innerHTML = `
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold flex justify-center items-center gap-2 md:whitespace-nowrap text-OrIAntation-darkblue">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg>
                <span>Journal de Bord</span>
            </h1>
            <p class="text-slate-500">Pour ${userInfo.firstName} ${context === 'student' ? (userInfo.lastName || '') : ''}, √©l√®ve de ${userInfo.gradeLevel}.</p>
        </div>
    `;
    div.appendChild(headerEl);
    div.innerHTML += progressBarHTML;

    if (context === 'student') {
        const analysisPanel = document.createElement('div');
        analysisPanel.id = 'monthly-analysis-panel';
        analysisPanel.className = 'my-8';
        div.appendChild(analysisPanel);
    }


    if (context === 'student') {
        const shareToken = journalDataToDisplay.share_token || null;
        const shareLink = shareToken ? `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${shareToken}` : '';
        const sharePanelEl = document.createElement('div');
        sharePanelEl.innerHTML = `
            <div class="bg-background-light p-6 rounded-lg border border-border-subtle my-8 text-center">
                <h2 class="text-xl font-bold text-OrIAntation-darkblue mb-2 flex items-center justify-center gap-2">ü§ù Espace Partage</h2>
                <p class="text-slate-600 text-sm mb-6 max-w-lg mx-auto">Partage une version "lecture seule" de ton journal avec tes parents ou ton professeur principal pour faciliter la discussion.</p>
                <div class="max-w-md mx-auto space-y-4">
                    <div id="share-link-container" class="${shareToken ? '' : 'hidden'}">
                        <label class="font-semibold text-slate-700 text-sm">Ton lien de partage unique :</label>
                        <div class="flex items-center gap-2 mt-1 bg-slate-100 border rounded-lg p-2 pl-4"><span class="text-sm truncate flex-1 text-left">${shareLink}</span><button id="copy-share-link" class="bg-slate-500 text-white font-semibold py-1 px-3 rounded-md text-sm hover:bg-slate-600">Copier</button></div>
                    </div>
                    <div class="pt-2">
                        <button id="toggle-share-btn" class="text-sm font-semibold ${shareToken ? 'text-red-600 hover:text-red-700' : 'text-green-600 hover:text-green-700'}">
                            ${shareToken ? '‚ùå D√©sactiver le partage' : '‚úÖ Activer le partage'}
                        </button>
                    </div>
                </div>
            </div>`;
        div.appendChild(sharePanelEl);
    }
    
    const earnedBadges = journalDataToDisplay.earned_badges || [];
    if (earnedBadges.length > 0) {
        div.innerHTML += createBadgesDisplay(context === 'student' ? 'journal' : 'journal_public');
    }
    div.innerHTML += `<div class="mt-8">${createOrientationMapView(journalDataToDisplay, context === 'student' ? 'user' : 'public')}</div>`;

    const filRougeEl = document.createElement('div');
    filRougeEl.innerHTML = `
        <div id="filRougeContainer" class="mb-8 p-6 bg-cyan-50 border-l-4 border-cyan-500 rounded-r-lg">
            <div class="relative mb-4">
                <h2 class="text-xl font-bold text-cyan-800 text-center">‚ú® ${context === 'student' ? 'Mon' : 'Son'} Fil Rouge</h2>
                ${context === 'student' ? '<button id="updateFilRougeBtn" class="absolute top-1/2 -translate-y-1/2 right-0 bg-cyan-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-700 transition text-sm">Mettre √† jour</button>' : ''}
            </div>
            <div id="filRougeLoader" class="hidden"><div class="loader"></div></div>
            <div id="filRougeContent" class="text-slate-700 whitespace-pre-wrap prose prose-sm max-w-none">${journalDataToDisplay.fil_rouge ? marked.parse(journalDataToDisplay.fil_rouge) : (context === 'student' ? "Cliquez sur 'Mettre √† jour'..." : "Le Fil Rouge n'a pas encore √©t√© g√©n√©r√©.")}</div>
        </div>
    `;
    div.appendChild(filRougeEl);

    const journalContentDiv = document.createElement('div');
    journalContentDiv.id = 'journalContent';
    journalContentDiv.className = 'mt-8 space-y-4';
    
    let hasAnyContent = false;

    if (journalDataToDisplay.step0 && journalDataToDisplay.step0.analysis) {
        const infographicElement = createProfileInfographic(journalDataToDisplay.step0, context);
        journalContentDiv.appendChild(infographicElement);
        hasAnyContent = true;
    }

    const stepTitles = { retroplanning_saves: 'Mes Conseils de R√©troplanning Sauvegard√©s', step10: 'Mon Portfolio de Comp√©tences', step13: 'Mon Stage de Seconde', step2: 'Mes simulations de sp√©cialit√©s', step1: 'Mes Fondations', step3: 'Mon Catalogue', step8: 'Mes Pr√©parations d\'Entretiens', step11: 'Mes rencontres sur le territoire', radar_history: 'Mon Radar √† Opportunit√©s', chatbot_saves: 'Mes Discussions avec le Coach', step4: 'L\'exp√©rience', step6: 'Mes pr√©parations de candidatures', step9: 'Mon anticipation de la suite', step12: 'Mes simulations de vie √©tudiante', step5: 'Mon Actu', step7: 'Mes Scores (Fact Checking)' };
    
    for (const stepKey in stepTitles) {
        const stepData = journalDataToDisplay[stepKey];
        if (!isStepStarted(stepKey)) continue;

        let sectionContentHTML = '';
        let hasSubEntries = false;
        let hasContentInSection = false;

        if (stepKey === 'step11' && isStepStarted(stepKey)) {
            hasContentInSection = true;
            let content = [];
            if (stepData.jpo_questions && stepData.jpo_questions.trim()) {
                content.push(`
                    <div class="p-3 bg-white rounded-lg border mt-2">
                        <h4 class="font-semibold text-OrIAntation-darkblue">Pr√©paration JPO : ${stepData.jpo_ecole || ''}</h4>
                        <div class="prose prose-sm max-w-none text-slate-600 mt-1 whitespace-pre-wrap">${stepData.jpo_questions}</div>
                    </div>
                `);
            }
            if (stepData.salon_preparation && stepData.salon_preparation.trim()) {
                content.push(`
                    <div class="p-3 bg-white rounded-lg border mt-2">
                        <h4 class="font-semibold text-OrIAntation-darkblue">Pr√©paration Salon : ${stepData.salon_nom || ''}</h4>
                        <div class="prose prose-sm max-w-none text-slate-600 mt-1 whitespace-pre-wrap">${stepData.salon_preparation}</div>
                    </div>
                `);
            }
            if (content.length > 0) {
                sectionContentHTML = `<div class="space-y-3">${content.join('')}</div>`;
            } else {
                hasContentInSection = false; 
            }
        }
        else if (stepKey === 'retroplanning_saves' && Array.isArray(stepData) && stepData.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + [...stepData].reverse().map((item, index) => {
                const originalIndex = stepData.length - 1 - index;
                const conseilsContent = '<div class="prose prose-sm max-w-none">' + Object.entries(item.conseils).map(([key, value]) => `<h4 class="font-bold text-OrIAntation-darkblue mt-3 mb-1">${key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</h4><p class="text-slate-600 whitespace-pre-wrap">${value}</p>`).join('') + '</div>';
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="retroplanning_saves" data-entry-index="${originalIndex}">üóëÔ∏è</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>Conseils g√©n√©r√©s le ${new Date(item.date).toLocaleDateString('fr-FR')}</span>${deleteButtonHTML}</summary><div class="p-3 border-t border-border-subtle">${conseilsContent}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'chatbot_saves' && Array.isArray(stepData) && stepData.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.map((item, index) => {
                 const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="chatbot_saves" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                 return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>Question : "${item.question}"</span>${deleteButtonHTML}</summary><div class="p-3 border-t border-border-subtle"><p class="whitespace-pre-wrap text-slate-600">${linkify(item.reponse)}</p></div></details>`}).join('') + '</div>';
        }
        else if (stepKey === 'radar_history' && Array.isArray(stepData) && stepData.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.map((item, index) => {
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="radar_history" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${item.type} : ${item.sujet}</span>${deleteButtonHTML}</summary><div class="p-3 border-t prose prose-sm max-w-none">${marked.parse(linkify(item.reponse))}</div></details>`}).join('') + '</div>';
        }
        else if (stepKey === 'step1' && Array.isArray(stepData?.metiers) && stepData.metiers.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.metiers.map((metier, index) => {
                let contentHTML = `<div class="mb-2"><p class="font-semibold text-slate-700">Notes :</p><p class="whitespace-pre-wrap text-slate-600">${metier.notes || "Aucune note."}</p></div>`;
                let analysesHTML = '';
                if (metier.analyses && Object.keys(metier.analyses).length > 0) {
                    analysesHTML = Object.entries(metier.analyses).map(([key, value]) => {
                        if (!value) return '';
                        if (key === 'temoignages') {
                            try {
                                const testimonials = JSON.parse(value);
                                if (!Array.isArray(testimonials)) return '';
                                const temoignagesContent = testimonials.map(item => `<div class="p-2 bg-white rounded border mt-1"><a href="${item.lien}" target="_blank" class="font-semibold text-primary-action hover:underline text-sm">${item.titre}</a><p class="text-xs mt-1">${item.resume}</p></div>`).join('');
                                return `<div class="mb-3"><h5 class="font-medium text-OrIAntation-darkblue">T√©moignages</h5><div class="space-y-2">${temoignagesContent}</div></div>`;
                            } catch (e) { return ''; }
                        }
                        return `<div class="mb-3"><h5 class="font-medium text-OrIAntation-darkblue">${capitalizeWords(key)}</h5><div class="prose prose-sm max-w-none">${marked.parse(linkify(value))}</div></div>`;
                    }).join('');
                    if (analysesHTML.trim()) {
                        contentHTML += `<details class="mt-3 bg-white rounded-md border"><summary class="p-2 text-sm font-medium cursor-pointer text-cyan-700 hover:bg-slate-50">Voir les analyses de OrIA</summary><div class="p-3 border-t">${analysesHTML}</div></details>`;
                    }
                }
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step1" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${metier.nom}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step2' && Array.isArray(stepData?.combinations) && stepData.combinations.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.combinations.map((combo, index) => {
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step2" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${combo.name}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${renderStep2InJournal({combinations: [combo]})}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step3' && (Array.isArray(stepData?.formations) && stepData.formations.length > 0 || stepData?.comparison)) {
            hasContentInSection = true;
            if (Array.isArray(stepData.formations) && stepData.formations.length > 0) {
                hasSubEntries = true;
                sectionContentHTML += '<div class="space-y-3">' + stepData.formations.map((formation, index) => {
                    let contentHTML = '';
                    if (formation.attendus) contentHTML += `<div class="mb-2"><p class="font-semibold">Attendus :</p><p class="whitespace-pre-wrap text-sm">${formation.attendus}</p></div>`;
                    if (formation.mots_cles) contentHTML += `<div class="mb-2"><p class="font-semibold">Mots-cl√©s :</p><p class="whitespace-pre-wrap text-sm">${formation.mots_cles}</p></div>`;
                    if (formation.analyses) {
                        if(formation.analyses.compatibilite) contentHTML += `<div class="mb-2"><p class="font-semibold">Rapport de compatibilit√© :</p><div class="prose prose-sm max-w-none">${marked.parse(formation.analyses.compatibilite)}</div></div>`;
                        if(formation.analyses.analyse_mots_cles) contentHTML += `<div class="mb-2"><p class="font-semibold">Analyse des mots-cl√©s :</p><div class="prose prose-sm max-w-none">${marked.parse(formation.analyses.analyse_mots_cles)}</div></div>`;
                    }
                    const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step3" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                    return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${formation.nom}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
                }).join('') + '</div>';
            }
            if (stepData.comparison) {
                try {
                    const data = JSON.parse(stepData.comparison);
                    sectionContentHTML += `<h4 class="font-bold text-OrIAntation-darkblue mt-4 mb-2">Tableau Comparatif</h4><div class="comparison-table-wrapper">${markdownTableToHtml(data.tableau)}</div><p class="text-sm italic mt-2">${data.remarques}</p>`;
                } catch(e) { /* ignore error */ }
            }
        }
        else if (stepKey === 'step4' && Array.isArray(stepData?.themes) && stepData.themes.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.themes.map((item, index) => {
                let contentHTML = `<div class="mb-3"><p class="font-semibold text-slate-800">Ma question :</p><p class="text-sm whitespace-pre-wrap">${item.question}</p></div><div><p class="font-semibold text-slate-800">Suggestions de l'IA :</p><div class="text-sm whitespace-pre-wrap prose prose-sm max-w-none">${marked.parse(item.suggestions || '')}</div></div>`;
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step4" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${item.theme}</span>${deleteButtonHTML}</summary><div class="p-3 border-t border-border-subtle">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step5' && Array.isArray(stepData?.articles) && stepData.articles.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.articles.map((article, index) => {
                let contentHTML = `<div class="mb-2"><p class="font-semibold">Ce que j'ai appris :</p><p class="whitespace-pre-wrap text-sm">${article.notes || 'Non renseign√©.'}</p></div>`;
                if (article.analysis) contentHTML += `<div class="mb-2"><p class="font-semibold">Analyse de OrIA :</p><div class="prose prose-sm max-w-none">${marked.parse(article.analysis)}</div></div>`;
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step5" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                return `<details class="bg-background-light rounded-lg border"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${article.title}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        }
        else if (stepKey === 'step6' && Array.isArray(stepData?.projets) && stepData.projets.length > 0) {
            hasSubEntries = true; hasContentInSection = true;
            sectionContentHTML = '<div class="space-y-3">' + stepData.projets.map((projet, index) => {
                let contentHTML = `<div class="mb-2"><p class="font-semibold">Motivations :</p><p class="whitespace-pre-wrap text-sm">${projet.motivations || ''}</p></div><div class="mb-2"><p class="font-semibold">Structure propos√©e :</p><p class="whitespace-pre-wrap text-sm">${projet.structure || ''}</p></div>${projet.optimisation ? `<div class="mb-2"><p class="font-semibold">Conseils d'optimisation :</p><div class="prose prose-sm max-w-none">${marked.parse(projet.optimisation)}</div></div>` : ''}`;
                const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step6" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                return `<details class="bg-background-light rounded-lg border border-border-subtle"><summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center"><span>${projet.formation}</span>${deleteButtonHTML}</summary><div class="p-3 border-t">${contentHTML}</div></details>`;
            }).join('') + '</div>';
        }


else if (stepKey === 'step13' && isStepStarted(stepKey)) {
    hasContentInSection = true;
    hasSubEntries = true; 
    let content = [];

    if (Array.isArray(stepData.hypotheses) && stepData.hypotheses.length > 0) {
        const hypothesesHTML = stepData.hypotheses.map((hyp, index) => {
            let hypContent = `<p><strong>Notes:</strong> ${hyp.notes || '...'}</p>`;
            
            if (hyp.lieux_suggeres) {
                try {
                    const data = extractJsonFromString(hyp.lieux_suggeres);
                    const lieux = data.lieux;

                    if (Array.isArray(lieux)) {
                        const lieuxHTML = lieux.map(lieu => `
                            <div class="p-2 bg-white rounded border mt-1">
                                <p class="font-semibold text-OrIAntation-darkblue">${lieu.nom}</p>
                                <p class="text-xs mt-1">${lieu.description}</p>
                                <a href="${lieu.lien_recherche}" target="_blank" class="text-xs text-primary-action font-semibold hover:underline mt-1 inline-block">Rechercher ‚Üó</a>
                            </div>`).join('');
                        hypContent += `<div><strong>Lieux sugg√©r√©s:</strong><div class="space-y-2">${lieuxHTML}</div></div>`;
                    } else { throw new Error('JSON is not an array'); }
                } catch(e) {
                    hypContent += `<div><strong>Lieux sugg√©r√©s:</strong><div class="prose prose-sm max-w-none">${marked.parse(hyp.lieux_suggeres)}</div></div>`;
                }
            }
            if (hyp.modele_contact) {
                hypContent += `<div class="mt-2"><strong>Mod√®le de contact:</strong><div class="whitespace-pre-wrap text-sm p-2 bg-white border rounded">${hyp.modele_contact}</div></div>`;
            }

            const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step13" data-array-key="hypotheses" data-entry-index="${index}">üóëÔ∏è</button>` : '';

            return `<details class="bg-background-light rounded-lg border mt-2">
                        <summary class="p-2 font-semibold text-OrIAntation-darkblue cursor-pointer flex justify-between items-center">
                            <span>${hyp.titre} √† ${hyp.ville}</span>
                            ${deleteButtonHTML}
                        </summary>
                        <div class="p-3 border-t">${hypContent}</div>
                    </details>`;
        }).join('');
        content.push(`<div><h3 class="text-lg font-bold text-cyan-700 mb-2">Atelier 1 : Mes hypoth√®ses de stage</h3><div class="space-y-3">${hypothesesHTML}</div></div>`);
    }

    const bilanFields = [
        { key: 'bilan_missions', label: 'Missions et observations' },
        { key: 'bilan_apprentissages', label: 'Ce que j\'ai appris' },
        { key: 'bilan_ressenti', label: 'Mon ressenti' },
        { key: 'plan_rapport', label: 'Plan de rapport sugg√©r√©' },
        { key: 'competences_extraites', label: 'Comp√©tences analys√©es' }
    ];
    let bilanContent = [];
    bilanFields.forEach(field => {
        if (stepData[field.key] && stepData[field.key].trim() !== '') {
            const formattedContent = (field.key === 'competences_extraites') ? marked.parse(stepData[field.key]) : `<p class="whitespace-pre-wrap">${stepData[field.key]}</p>`;
            bilanContent.push(`<div class="p-3 bg-white rounded-lg border mt-2">
                                <h4 class="font-semibold text-OrIAntation-darkblue">${field.label}</h4>
                                <div class="prose prose-sm max-w-none text-slate-600 mt-1">${formattedContent}</div>
                               </div>`);
        }
    });

    if (bilanContent.length > 0) {
        content.push(`<div><h3 class="text-lg font-bold text-cyan-700 mt-4 mb-2">Atelier 2 : Mon bilan de stage</h3><div class="space-y-3">${bilanContent.join('')}</div></div>`);
    }

    if (content.length > 0) {
        sectionContentHTML = `<div class="space-y-6">${content.join('<hr class="my-4 border-slate-200">')}</div>`;
    } else {
        hasContentInSection = false; 
    }
        
        } else {
            const staticContent = [];
            if (stepKey === 'step10') {
                if (Array.isArray(stepData.experiences) && stepData.experiences.length > 0) {
                    const experiencesContent = stepData.experiences.map((exp, index) => `<div class="p-3 bg-white rounded-lg border mt-2"><p class="font-medium text-OrIAntation-darkblue">Exp√©rience #${index + 1}</p><div class="prose prose-sm max-w-none text-slate-600">${marked.parse(exp.analysis)}</div></div>`).join('');
                    staticContent.push(`<h4>Mes Exp√©riences Significatives</h4><div class="space-y-2">${experiencesContent}</div>`);
                }
                if (stepData.soft_skills_profile) staticContent.push(`<h4>Profil de comp√©tences</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.soft_skills_profile)}</div>`);
                if (stepData.skills_synthesis) staticContent.push(`<h4>Synth√®se du Connecteur</h4><div class="prose prose-sm max-w-none">${marked.parse(stepData.skills_synthesis)}</div>`);
            } else if (stepKey === 'step8' && isStepStarted(stepKey)) {
            hasContentInSection = true;
            let content = [];
            let subEntriesForDeletion = false;

            if (Array.isArray(stepData.preparations) && stepData.preparations.length > 0) {
                subEntriesForDeletion = true; 
                const preparationsHTML = stepData.preparations.map((item, index) => {
                    let itemContent = `
                        <div class="mb-3">
                            <p class="font-semibold text-slate-800">Ma question :</p>
                            <p class="text-sm whitespace-pre-wrap">${item.question}</p>
                        </div>
                        <div>
                            <p class="font-semibold text-slate-800">Suggestions de l'IA :</p>
                            <div class="text-sm whitespace-pre-wrap prose prose-sm max-w-none">${marked.parse(item.suggestions || '')}</div>
                        </div>
                    `;
                    const deleteButtonHTML = context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Supprimer" data-step-key="step8" data-array-key="preparations" data-entry-index="${index}">üóëÔ∏è</button>` : '';
                    return `
                        <details class="bg-background-light rounded-lg border border-border-subtle">
                            <summary class="p-3 font-semibold text-slate-700 cursor-pointer flex justify-between items-center">
                                <span>Pr√©paration pour : ${item.pro}</span>
                                ${deleteButtonHTML}
                            </summary>
                            <div class="p-3 border-t border-border-subtle">${itemContent}</div>
                        </details>
                    `;
                }).join('');
                content.push(`<div class="space-y-3">${preparationsHTML}</div>`);
            }

            if (Array.isArray(stepData.contacts) && stepData.contacts.length > 0) {
                 const contactsHTML = stepData.contacts.map(c => `<li>${c.nom} (Statut: ${statusOptions[c.statut] || '√Ä d√©finir'})</li>`).join('');
                 content.push(`
                    <div class="mt-4">
                        <h4 class="font-semibold text-OrIAntation-darkblue">Liste de Suivi de Contacts</h4>
                        <ul class="list-disc list-inside text-sm text-slate-600 mt-1">${contactsHTML}</ul>
                    </div>
                 `);
            }

            if (content.length > 0) {
                sectionContentHTML = content.join('<hr class="my-4 border-slate-200">');
                hasSubEntries = subEntriesForDeletion;
            } else {
                hasContentInSection = false;
            }
            
        
            } else if (stepKey === 'step7' && stepData.scores) {
                staticContent.push(Object.entries(stepData.scores).map(([domain, history]) => `<h4>${domain}</h4><ul>${history.map(e => `<li>${e.date}: ${e.score}/${e.total}</li>`).join('')}</ul>`).join(''));
            } else if (stepKey === 'step9' || stepKey === 'step12') {
                 const config = Object.values(stepsConfig).find(c => c.stepKey === stepKey);
                 if (config && config.fields) {
                    config.fields.forEach(field => {
                        const value = stepData[field.id];
                        if (value) staticContent.push(`<p><strong>${field.label}:</strong><br>${value}</p>`);
                    });
                 }
            }
            if (staticContent.length > 0) {
                hasContentInSection = true;
                sectionContentHTML = `<div class="prose prose-sm max-w-none text-slate-600 space-y-4">${staticContent.join('')}</div>`;
            }
        }
        
        if (hasContentInSection) {
            hasAnyContent = true;
            const sectionContainer = document.createElement('div');
            sectionContainer.id = `journal-section-${stepKey}`;
            sectionContainer.className = 'border border-border-subtle rounded-lg overflow-hidden';
            const deleteButtonHTML = !hasSubEntries && context === 'student' ? `<button class="delete-journal-entry text-red-500 hover:text-red-700 text-lg p-1" title="Vider la section" data-step-key="${stepKey}" data-action="clear-section">üóëÔ∏è</button>` : '';
            let title = stepTitles[stepKey];
            if (context !== 'student') {
                title = title.replace(/^Mes /, 'Ses ')
                             .replace(/^Mon /, 'Son ')
                             .replace(/^Ma /, 'Sa ');
            }

            sectionContainer.innerHTML = `
                <div class="journal-section-header flex justify-between items-center bg-background-light p-4 cursor-pointer hover:bg-slate-100 transition">
                    <h3 class="text-lg font-bold text-cyan-700">${title}</h3>
                    <div class="flex items-center gap-2">${deleteButtonHTML}<span class="transform transition-transform duration-200 text-cyan-700">‚ñº</span></div>
                </div>
                <div class="journal-section-content p-4 border-t border-border-subtle hidden">${sectionContentHTML}</div>`;
            journalContentDiv.appendChild(sectionContainer);
        }
    }


    if (!hasAnyContent) {
        journalContentDiv.innerHTML = '<p class="text-center text-slate-500">Le journal est encore vide. Explorez les √©tapes pour le remplir !</p>';
    }
    
    div.appendChild(journalContentDiv);
    
    if (context === 'teacher') {
        const discussionSection = document.createElement('div');
        discussionSection.innerHTML = `
            <div class="mt-8 border-t pt-6 text-center">
                <button id="publicShareBtn" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition">ü§ù Pr√©parer une discussion</button>
            </div>
            <div id="publicOpenAIShareLoader" class="hidden"><div class="loader"></div></div>
            <div id="publicOpenAIShareResult" class="mt-6 p-4 bg-sky-50 border border-sky-200 rounded-lg"></div>`;
        div.appendChild(discussionSection);
    }
    
    if (context === 'student') {
        const deleteSection = document.createElement('div');
        deleteSection.className = 'text-center mt-12 pt-8 border-t border-border-subtle';
        deleteSection.innerHTML = `<button onclick="deleteUserAccount()" class="text-sm text-slate-500 hover:text-red-600 hover:underline transition-colors">Supprimer mon compte et toutes mes donn√©es</button>`;
        div.appendChild(deleteSection);
    }

    // ---- Logique des √©v√©nements ----
    const allEventListeners = () => {
          checkForSnapshots();

        if (context === 'student') {
            const toggleShareBtn = div.querySelector('#toggle-share-btn');
            if (toggleShareBtn) {
                toggleShareBtn.addEventListener('click', async () => {
                    if (journalDataToDisplay.share_token) {
                        const userConfirmed = await showConfirmationModal("Es-tu s√ªr de vouloir d√©sactiver le partage ? Le lien ne fonctionnera plus.");
                        if (userConfirmed) {
                            journalDataToDisplay.share_token = null;
                            await deleteDoc(doc(db, "publicShares", currentUserId));
                            await saveData();
                            showView('journal');
                        }
                    } else {
                        const chosenRole = await promptShareRole();
                        if (chosenRole) {
                            const newShareToken = 'shr_' + Math.random().toString(36).substr(2, 16);
                            journalDataToDisplay.share_token = newShareToken;
                            await setDoc(doc(db, "publicShares", currentUserId), { token: newShareToken });
                            await saveData();
                            const newShareLink = `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${newShareToken}`;
                            showShareMessageModal(newShareLink, userInfo.firstName, chosenRole);
                            showView('journal');
                        }
                    }
                });
            }
            
            const copyShareLinkBtn = div.querySelector('#copy-share-link');
            if (copyShareLinkBtn) {
                copyShareLinkBtn.addEventListener('click', () => {
                    const shareLink = `${window.location.origin}${window.location.pathname}?share_id=${currentUserId}&token=${journalDataToDisplay.share_token}`;
                    navigator.clipboard.writeText(shareLink).then(() => showSurpriseModal("C'est fait !", '<p>Le lien a √©t√© copi√©.</p>', 2000));
                });
            }

            const updateFilRougeBtn = div.querySelector('#updateFilRougeBtn');
            if (updateFilRougeBtn) {
                updateFilRougeBtn.addEventListener('click', async () => {
                    if (!isStepStarted('step0')) { showInfoModal("Action requise", "Compl√®te d'abord l'√©tape 'Mieux se conna√Ætre'."); return; }
                    const loader = div.querySelector('#filRougeLoader');
                    const contentP = div.querySelector('#filRougeContent');
                    loader.style.display = 'block'; contentP.style.display = 'none';
                    const profileSummary = getProfileSummary();
                    const completionSummary = getCompletionSummary();
                    const missions = { 
                        titre: "1. Ton Titre de Projet : Trouve un titre global, percutant et positif pour son projet d'orientation.",
                        pouvoirs: "2. Tes Super-Pouvoirs : Identifie ses 2 ou 3 plus grandes forces (comp√©tences, traits de personnalit√©).",
                        terrain: "3. Ton Terrain de Jeu Id√©al : D√©cris le type d'environnement d'√©tudes ou de travail o√π il pourrait s'√©panouir.",
                        aventures: "4. Tes Prochaines Aventures : Sugg√®re 2 ou 3 pistes de m√©tiers ou de secteurs √† explorer."
                    };
                    const createFilRougeMicroPrompt = (instruction) => `Agis comme un coach d'orientation expert et concis. # Donn√©es sur l'√©l√®ve - R√©sum√© du profil : ${profileSummary} - R√©sum√© de la progression : ${completionSummary} # Ta Mission UNIQUE Ta seule mission est de r√©pondre √† cette instruction : "${instruction}". # Format de Sortie R√©dige un unique paragraphe de texte. N'ajoute PAS le titre (comme "Ton Titre de Projet :").`;
                    try {
                        const promises = Object.entries(missions).map(([key, instruction]) => {
                            const microPrompt = createFilRougeMicroPrompt(instruction);
                            return callOpenAI_API({ promptText: microPrompt, promptId: "pmpt_68dc33a589bc8197a0229d72a4e3df100510635f4c084c2c", isExpertCall: true, loaderElement: loader }).then(result => ({ key, result }));
                        });
                        const resultsArray = await Promise.all(promises);
                        const finalResultObject = resultsArray.reduce((acc, { key, result }) => { acc[key] = result; return acc; }, {});
                        const result = `**Ton Titre de Projet** : ${finalResultObject.titre}\n\n**Tes Super-Pouvoirs** : ${finalResultObject.pouvoirs}\n\n**Ton Terrain de Jeu Id√©al** : ${finalResultObject.terrain}\n\n**Tes Prochaines Aventures** : ${finalResultObject.aventures}`.trim();
                        journalDataToDisplay.fil_rouge = result;
                        await saveData();
                        await handleOnboarding({ from: 'fil_rouge_generated' });
                        contentP.innerHTML = marked.parse(result);
                    } catch (e) { 
                        console.error("Erreur Fil Rouge:", e);
                        contentP.innerHTML = `<p class="text-red-500">D√©sol√©, une erreur est survenue.</p>`; 
                    } finally { 
                        loader.style.display = 'none'; 
                        contentP.style.display = 'block'; 
                    }
                });
            }
        } else if (context === 'teacher') {
            const publicShareBtn = div.querySelector('#publicShareBtn');
            if (publicShareBtn) {
                publicShareBtn.addEventListener('click', async () => {
                    const loader = div.querySelector('#publicOpenAIShareLoader');
                    const resultDiv = div.querySelector('#publicOpenAIShareResult');
                    publicShareBtn.disabled = true;
                    loader.innerHTML = `<div class="loader"></div><p class="text-slate-500 font-semibold mt-2">Analyse du parcours en cours...</p>`;
                    try {
                        const prompt = `Agis comme un coach... Voici le journal de bord complet : ${JSON.stringify(journalDataToDisplay)}. Analyse ce journal et g√©n√®re 3 √† 4 points de dialogue...`;
                        const result = await callOpenAI_API({ promptText: prompt });
                        resultDiv.innerHTML = marked.parse(result);
                    } catch (error) { resultDiv.innerHTML = '<p class="text-red-500">Une erreur est survenue.</p>'; }
                    finally { publicShareBtn.disabled = false; loader.innerHTML = ''; }
                });
            }
        }
        journalContentDiv.addEventListener('click', async (e) => {
            const header = e.target.closest('.journal-section-header');
            const deleteBtn = e.target.closest('.delete-journal-entry');
            if (header && !deleteBtn) {
                const content = header.nextElementSibling;
                const icon = header.querySelector('span.transform');
                if (content) content.classList.toggle('hidden');
                if (icon) icon.classList.toggle('rotate-180');
                return;
            }
            if (deleteBtn && context === 'student') {
                e.stopPropagation();
                const stepKey = deleteBtn.dataset.stepKey;
                const action = deleteBtn.dataset.action;
                const entryIndex = parseInt(deleteBtn.dataset.entryIndex, 10);
                const arrayKey = deleteBtn.dataset.arrayKey;

                if (!await showConfirmationModal(action === 'clear-section' ? 'Vider toute cette section ?' : 'Supprimer cette entr√©e ?')) return;

                if (action === 'clear-section') {
                    journalDataToDisplay[stepKey] = defaultData[stepKey];
                } else if (!isNaN(entryIndex)) {
                    if (arrayKey) {
                        if (journalDataToDisplay[stepKey]?.[arrayKey]?.[entryIndex]) {
                            journalDataToDisplay[stepKey][arrayKey].splice(entryIndex, 1);
                        }
                    } else {
                        const arraysMap = { 'retroplanning_saves': journalDataToDisplay.retroplanning_saves, 'step1': journalDataToDisplay.step1?.metiers, 'step2': journalDataToDisplay.step2?.combinations, 'step3': journalDataToDisplay.step3?.formations, 'step4': journalDataToDisplay.step4?.themes, 'step5': journalDataToDisplay.step5?.articles, 'step6': journalDataToDisplay.step6?.projets, 'radar_history': journalDataToDisplay.radar_history, 'chatbot_saves': journalDataToDisplay.chatbot_saves };
                        if (arraysMap[stepKey]?.[entryIndex]) {
                            arraysMap[stepKey].splice(entryIndex, 1);
                        }
                    }
                }
                await saveData();
                await showView('journal');
            }
        });
        div.addEventListener('click', (e) => {
            const card = e.target.closest('.map-card-clickable');
            if (card) {
                e.preventDefault();
                const targetId = card.dataset.target;
                const targetElement = div.querySelector(`#${targetId}`);
                if (targetElement) { targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
            }
        });
        
    };

    const checkForSnapshots = async () => {
        if (context !== 'student') return;

        try {
            const snapshotsRef = collection(db, 'users', currentUserId, 'journal_snapshots');
            const q = query(snapshotsRef, limit(1));
            const snapshot = await getDocs(q);
            
            const panel = div.querySelector('#monthly-analysis-panel');
            if (panel && !snapshot.empty) {
                panel.innerHTML = `
                    <div class="bg-orange-50 p-6 rounded-lg border border-orange-200 text-center">
                        <h2 class="text-xl font-bold text-orange-800 mb-2 flex items-center justify-center gap-2">üé¨ Mon √âvolution Mensuelle</h2>
                        <p class="text-slate-600 text-sm mb-4 max-w-lg mx-auto">Compare ton journal d'aujourd'hui avec celui du mois dernier pour voir le film de ta r√©flexion.</p>
                        <button id="launch-analysis-btn" class="bg-orange-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-orange-600 transition">
                            üöÄ Lancer mon Analyse d'√âvolution
                        </button>
                    </div>
                `;
                
                div.querySelector('#launch-analysis-btn').addEventListener('click', async () => {
                    const title = "Analyse d'√âvolution Mensuelle en cours...";
                    const content = `<div class="text-center"><div class="loader"></div><p class="text-slate-500 mt-2">OrIA compare tes journaux... cette op√©ration peut prendre un instant.</p></div>`;
                    createSimpleModal(title, content);

                    try {
                        const generateAnalysis = httpsCallable(functions, 'generateMonthlyAnalysis');
                        const result = await generateAnalysis();
                        
                        if (result.data.success) {
                            createSimpleModal(
                                "üé¨ Ton Rapport d'√âvolution",
                                `<div class="prose prose-sm max-w-none">${marked.parse(result.data.analysis)}</div>`
                            );
                        } else {
                            throw new Error(result.data.error || "L'analyse a √©chou√©.");
                        }
                    } catch (error) {
                        console.error("Erreur lors de l'appel de generateMonthlyAnalysis:", error);
                        const errorMessage = error.message || "D√©sol√©, une erreur est survenue lors de la g√©n√©ration de ton analyse. R√©essaie plus tard.";
                        createSimpleModal("Erreur", `<p class="text-red-500">${errorMessage}</p>`);
                    }
                });
            }
        } catch (error) {
            console.error("Erreur lors de la v√©rification des snapshots:", error);
        }
    };

    allEventListeners();
    
    // ---- Restauration des variables globales ----
    journalData = originalJournalData;
    userGradeLevel = originalUserGradeLevel;
    
    return div;
}


function isStepComplete(stepKey) {
    const data = journalData[stepKey];
    if (!data) return false;

    // La seule et unique √©tape qui peut √™tre "compl√®te" (coche verte) est l'√©tape 0.
    if (stepKey === 'step0') {
        // Pour √™tre compl√®te, l'analyse de base ET l'analyse crois√©e doivent √™tre faites.
        const hasMainAnalysis = data.analysis && data.analysis.trim() !== '';
        const hasCrossAnalysis = data.analyse_tests_croisee && data.analyse_tests_croisee.trim() !== '';
        return hasMainAnalysis && hasCrossAnalysis;
    }

    // TOUTES les autres √©tapes ne peuvent JAMAIS √™tre consid√©r√©es comme compl√®tes.
    return false;
}
        function checkBadges() {
            if (!journalData.earned_badges) {
                journalData.earned_badges = [];
            }
            for (const badgeKey in badgesConfig) {
                if (!journalData.earned_badges.includes(badgeKey)) {
                    if (badgesConfig[badgeKey].criteria(userGradeLevel)) {
                        journalData.earned_badges.push(badgeKey);
                    }
                }
            }
        }

function createProgressBarHTML() {
    // On exclut les "non-√©tapes" du menu.
    const nonTrackableStepIds = ['journal', 'retroplanning']; 
    
    // On r√©cup√®re toutes les √©tapes pertinentes pour le niveau de l'√©l√®ve.
    const stepsForLevel = allSteps.filter(step => step.levels.includes(userGradeLevel) && !nonTrackableStepIds.includes(step.id));
    
    if (stepsForLevel.length === 0) return '<div></div>'; // Retourne une div vide si pas d'√©tapes

    let score = 0;
    stepsForLevel.forEach(step => {
        const stepKey = step.id;
        
        // Condition sp√©ciale pour l'√©tape 0 : elle doit √™tre "compl√®te" (verte) pour compter 1 point.
        if (stepKey === 'step0') {
            if (isStepComplete(stepKey)) {
                score++;
            }
        } else {
            // Pour toutes les autres √©tapes, on v√©rifie simplement si elles sont "commenc√©es" (orange).
            if (isStepStarted(stepKey)) {
                score++;
            }
        }
    });

    const progressPercentage = (score / stepsForLevel.length) * 100;

    return `
        <div class="flex justify-between items-center mb-1">
            <span class="text-base font-medium text-cyan-700 flex items-center gap-2">
                Progression des √âtapes
                <button id="progress-help-btn" class="text-slate-400 hover:text-cyan-600" title="√Ä quoi correspondent les coches ?">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                    </svg>
                </button>
            </span>
            <span class="text-sm font-medium text-cyan-700">${Math.round(progressPercentage)}%</span>
        </div>
        <div class="w-full bg-slate-200 rounded-full h-2.5">
            <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
        </div>
    `;
}

      
function createBadgesDisplay(context = 'menu') {
    const earnedBadges = journalData.earned_badges || [];
    
    // NOUVEAU : On choisit le titre en fonction du contexte
    const title = (context === 'public' || context === 'journal_public') ? 'Ses Badges' : 'Mes Badges';

    let badgesHTML = Object.keys(badgesConfig).map(key => {
        const badge = badgesConfig[key];
        const earned = earnedBadges.includes(key);
        return `
            <div class="text-center">
                <div class="badge ${earned ? 'earned' : ''}" title="${badge.description}">
                    <span class="text-3xl">${badge.icon}</span>
                    <p class="text-sm font-semibold mt-1 ${earned ? 'text-OrIAntation-darkblue' : 'text-slate-400'}">${badge.title}</p>
                </div>
            </div>
        `;
    }).join('');
    
    const wrapperClass = (context === 'journal' || context === 'journal_public') ? 'mb-8' : 'mb-8 bg-white p-4 rounded-2xl shadow-md border border-border-subtle';

    return `
        <div id="badgesContainer" class="${wrapperClass}">
            <h2 class="text-lg font-bold text-OrIAntation-darkblue text-center mb-2">${title}</h2>
            <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
                ${badgesHTML}
            </div>
        </div>
    `;
}


        // --- Chatbot Logic ---
        const chatbotToggle = document.getElementById('chatbot-toggle');
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotClose = document.getElementById('chatbot-close');
        const chatbotForm = document.getElementById('chatbot-form');
        const chatbotInput = document.getElementById('chatbot-input');
        const chatMessages = document.getElementById('chat-messages');
        
        let chatbotHistory = []; // On ajoute une m√©moire pour la conversation

        // 1. Message d'accueil personnalis√©
        const openChatbot = () => {
            chatbotContainer.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
            chatbotToggle.classList.add('chat-open');
        };

        const closeChatbot = () => {
            chatbotContainer.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
            chatbotToggle.classList.remove('chat-open');
        };
        chatbotContainer.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        chatbotToggle.addEventListener('click', () => {
            // On v√©rifie si le chatbot est actuellement cach√© (en testant une des classes)
            const isHidden = chatbotContainer.classList.contains('opacity-0');
            
            if (isHidden) {
                openChatbot();
            } else {
                closeChatbot();
            }

            const now = new Date().getTime();
            const lastInteraction = journalData.chatbot_last_interaction || 0;
            const minutesSinceLastInteraction = (now - lastInteraction) / (1000 * 60);

            // Si plus de 30 minutes se sont √©coul√©es, on r√©initialise
            if (minutesSinceLastInteraction > 30) {
                chatbotHistory = [];
                chatMessages.innerHTML = ''; // On vide aussi l'affichage
            }

            // On affiche le message d'accueil personnalis√© si la conversation est vide
            if (chatbotContainer.classList.contains('hidden') === false && chatbotHistory.length === 0) {
            const welcomeText = `Salut ${currentUserInfo.firstName} ! Je suis OrIA, ton copilote pour l'orientation. üòä Pr√™t √† explorer ? Pose-moi ta question !`;
                addMessage(welcomeText, 'ai');
            }
        });

            chatbotClose.addEventListener('click', () => {
             closeChatbot(); // On utilise la m√™me fonction que le bouton flottant
        });

        // 2. Logique de conversation (qui g√®re l'historique)
        const createChatbotPrompt = (userInput, history) => {
            const userInfo = currentUserInfo;
            const userJournal = journalData;
            const appStepsList = allSteps.map(s => `- '${s.icon} ${s.title}'`).join('\n');
            const today = new Date().toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const currentSchoolYearStart = getCurrentSchoolYear();
            const schoolYearString = `${currentSchoolYearStart}-${currentSchoolYearStart + 1}`;

            // --- NOUVEAU : On g√©n√®re le r√©sum√© de la progression ---
            const completionSummary = getCompletionSummary();
            const appFeaturesSummary = getAppFeaturesSummary();


            const historyText = history.map(msg => {
                return `${msg.role === 'user' ? '[PR√âNOM]' : 'Toi'}: ${msg.parts[0].text}`;
            }).join('\n');

            return `
# R√¥le et Persona (Ta seule identit√©)
Tu es le "Copilote", l'IA conversationnelle de l'application "OrIAntation". Ton but est d'aider [PR√âNOM] √† utiliser l'application pour construire son projet. Pense √† toi comme un mentor jeune, dynamique et super sympa.
- Le nom de ton application est **OrIAntation**.

# Ton Style (TA PRIORIT√â ABSOLUE)
- **Ton :** Parle comme un jeune adulte, pas comme un prof. Utilise "tu", sois direct, chaleureux et encourageant. Sois professionnel mais cool.
- **Emojis :** Utilise quelques emojis pour rendre tes messages funs et visuels. üëçüöÄüí°üòâü§î
- **Proactivit√© :** Propose TOUJOURS une action suivante, de pr√©f√©rence en sugg√©rant une √©tape pertinente de l'application.
- **Varie tes intros !**

# Contexte Essentiel
Tu dois te baser sur TOUT ce contexte pour chaque r√©ponse.

**1. L'√©l√®ve que tu aides :**
- Pr√©nom : [PR√âNOM]
- Genre : [GENRE]
- Classe : [CLASSE]
- Ann√©e Scolaire en cours ("cette ann√©e") : ${schoolYearString}
- Son Journal de Bord (contient ses r√©ponses et son profil) : [JOURNAL_DATA]

**2. L'application que vous utilisez ensemble :**
- Outils disponibles et leur fonction : ${appFeaturesSummary} // MODIFICATION : On utilise le mode d'emploi d√©taill√©
- R√©sum√© de sa progression : ${completionSummary}

**3. L'historique de votre conversation :**
[HISTORIQUE_CONVERSATION]

# Ta Mission et tes R√®gles d'Or (√Ä SUIVRE IMP√âRATIVEMENT)
- **R√®gle de base :** N'invente JAMAIS une fonctionnalit√© qui n'est pas dans la liste des outils. Ton r√¥le est de guider l'√©l√®ve √† travers l'application EXISTANTE.
- **Ton objectif final :** Amener l'√©l√®ve √† une action concr√®te dans l'une des √©tapes de l'application.

R√àGLE N¬∞1 - LA PLUS IMPORTANTE : PAS DE SALUTATIONS.
Tu ne salues l'utilisateur qu'une seule fois...

Ensuite, suis cet ordre de priorit√© pour r√©pondre √† la derni√®re question de [PR√âNOM] :

1.  **Priorit√© 1 : Guide dans l'appli.** Si sa question peut √™tre r√©solue avec un outil de l'app, guide-le vers l'outil le plus pertinent (et non termin√© !).
2.  **Priorit√© 2 : Analyse son profil.** Si sa question est personnelle ("penses-tu que ce m√©tier est fait pour moi ?"), utilise son Journal de Bord pour donner une r√©ponse personnalis√©e.
3.  **Priorit√© 3 : Expert Externe avec recherche web.** Pour les questions factuelles sur les formations, les m√©tiers ou les dates (comme Parcoursup), tu DOIS utiliser ta capacit√© de recherche sur le web pour trouver les informations les plus √† jour possibles. C'est une de tes fonctions principales. Cite toujours tes sources (ex: onisep.fr, parcoursup.fr) quand tu donnes une information pr√©cise.
---
Derni√®re question de [PR√âNOM] : "${userInput}"
`
    .replace(/\[PR√âNOM\]/g, userInfo.firstName)
    .replace('[GENRE]', userInfo.gender || 'autre')
    .replace('[CLASSE]', userGradeLevel)
    .replace('[JOURNAL_DATA]', JSON.stringify(userJournal))
    // MODIFICATION : On remplace la variable √† remplacer
    // .replace('[LISTE_ETAPES]', appStepsList) 
    .replace('[HISTORIQUE_CONVERSATION]', historyText);
};
        
        chatbotForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userInput = chatbotInput.value.trim();
            if (!userInput) return;

            addMessage(userInput, 'user');
            chatbotInput.value = '';
            
            const loaderDiv = addMessage('', 'loader', false);
            const prompt = createChatbotPrompt(userInput, chatbotHistory);
const aiResponse = await callOpenAI_API({
    promptText: prompt,
    withPersona: true
});            loaderDiv.remove();
            
            // On r√©cup√®re le conteneur du message de OrIA qu'on vient de cr√©er
            const aiMessageWrapper = addMessage(aiResponse, 'ai');
            const saveBtn = aiMessageWrapper.querySelector('.save-chat-btn');

            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    if (!Array.isArray(journalData.chatbot_saves)) {
                        journalData.chatbot_saves = [];
                    }
                    // On sauvegarde la question de l'√©l√®ve ET la r√©ponse de OrIA
                    journalData.chatbot_saves.push({
                        question: userInput,
                        reponse: aiResponse
                    });
                    await saveData();
                    
                    // Feedback visuel
                    saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`;
                    saveBtn.disabled = true;
                    saveBtn.title = "Enregistr√© !";
                });
            }
        });

        function addMessage(text, sender, addToHistory = true) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex mb-4 group'; // On ajoute la classe "group" pour le survol
            
            if (addToHistory) {
                chatbotHistory.push({ role: sender === 'user' ? 'user' : 'model', parts: [{ text }] });
                journalData.chatbot_last_interaction = new Date().getTime(); 
            }

            let messageContent;
            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageContent = `<div class="bg-blue-500 text-white p-3 rounded-lg max-w-xs"><p>${text}</p></div>`;
            } else if (sender === 'ai') {
                 // On ajoute un conteneur flex pour le message et le bouton
                 messageWrapper.classList.add('items-end', 'gap-2');
                 messageContent = `
                    <div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg max-w-xs">
                    <div class="prose prose-sm max-w-none text-cyan-800">${marked.parse(text)}</div>
                    </div>
                    <button class="save-chat-btn opacity-0 group-hover:opacity-100 transition text-slate-400 hover:text-primary-action p-1" title="Enregistrer dans le journal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v12l-5-3-5 3V4z" /></svg>
                    </button>
                 `;
            } else if (sender === 'loader') {
                 messageContent = `<div class="bg-cyan-100 text-cyan-800 p-3 rounded-lg"><div class="chatbot-loader"></div></div>`;
            }

            messageWrapper.innerHTML = messageContent;
            chatMessages.appendChild(messageWrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageWrapper;
        }

        // Le reste de votre code reste inchang√©...

        window.showView = showView;

        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(registration => {
                console.log('SW registered: ', registration);
            }).catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
        });
    }

    // ========================================================
// AJOUTEZ CE BLOC POUR LA NAVIGATION PAR GESTES
// ========================================================
let touchStartX = 0;
let touchStartY = 0;

mainApp.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
}, { passive: true });

mainApp.addEventListener('touchend', (e) => {
    const floatingBackBtn = document.getElementById('floatingBackBtn');
    if (!floatingBackBtn || floatingBackBtn.style.display === 'none') {
        return; // On ne fait rien si le bouton retour n'est pas visible
    }

    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;

    // On v√©rifie que le geste est bien un balayage horizontal vers la droite
    // et non un d√©filement vertical.
    if (deltaX > 75 && Math.abs(deltaY) < 75) {
        // On simule un clic sur le bouton de retour,
        // ce qui d√©clenche la bonne logique de retour (vers le menu, l'inscription, etc.)
        floatingBackBtn.click();
    }
}, { passive: true });

mainApp.addEventListener('touchend', (e) => {
    // On ne fait rien si le bouton retour n'est pas visible
    // (cela emp√™che le geste de fonctionner sur le menu principal)
    if (!floatingBackBtn || floatingBackBtn.style.display === 'none') {
        return;
    }

    // On r√©cup√®re la position de fin
    const touchEndX = e.changedTouches[0].clientX;
    const touchEndY = e.changedTouches[0].clientY;

    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;

    // On v√©rifie si le geste est un balayage vers la droite
    // et pas un simple d√©filement vertical.
    if (deltaX > 75 && Math.abs(deltaY) < 75) {
        showView('menu');
    }
}, { passive: true });

// ========================================================
// AJOUTEZ CE BLOC POUR LA FEN√äTRE DE S√âLECTION DU GUIDE
// ========================================================
let guideUserRole = 'eleve'; // R√¥le par d√©faut

const guideRoleModal = document.getElementById('guideRoleModal');
const closeRoleModalBtn = document.getElementById('closeRoleModalBtn');
const roleEleveBtn = document.getElementById('roleEleveBtn');
const roleParentBtn = document.getElementById('roleParentBtn');
const roleEnseignantBtn = document.getElementById('roleEnseignantBtn');

// Fonction qui ouvre le guide apr√®s avoir choisi un r√¥le
const openGuide = (role) => {
    guideUserRole = role; // On sauvegarde le r√¥le
    guideRoleModal.style.display = 'none'; // On cache la fen√™tre
    window.showGuideFromLogin(); // On affiche le guide
};

// Attache les √©v√©nements aux boutons
closeRoleModalBtn.addEventListener('click', () => {
    guideRoleModal.style.display = 'none';
});

roleEleveBtn.addEventListener('click', () => openGuide('eleve'));
roleParentBtn.addEventListener('click', () => openGuide('parent'));
roleEnseignantBtn.addEventListener('click', () => openGuide('enseignant'));

// Fonction de la nouvelle politique de confidentialit√©
    // REMPLACEZ VOTRE FONCTION createPrivacyPolicyView EXISTANTE PAR CE CODE :
function createPrivacyPolicyView() {
    const div = document.createElement('div');
    div.className = 'fade-in bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-border-subtle text-left';
    
    div.innerHTML = `
        <h1 class="text-2xl font-bold text-OrIAntation-darkblue mb-4 text-center">Politique de Confidentialit√©</h1>
        <p class="mb-8 text-sm text-slate-500 text-center">Derni√®re mise √† jour : 20 septembre 2025</p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">1. Objet et champ d'application</h2>
        <p class="text-slate-600 mb-4">
            La pr√©sente politique de confidentialit√© a pour objet de d√©finir les modalit√©s de traitement des donn√©es √† caract√®re personnel des utilisateurs de l'application web "OrIAntation", conform√©ment au R√®glement (UE) 2016/679 du Parlement europ√©en et du Conseil du 27 avril 2016, plus connu sous le nom de **R√®glement G√©n√©ral sur la Protection des Donn√©es (RGPD)**. Ce document est un instrument de transparence destin√© √† informer les utilisateurs et, le cas √©ch√©ant, √† r√©pondre aux requ√™tes des autorit√©s de contr√¥le (telles que la CNIL en France).
        </p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">2. Identit√© et coordonn√©es du responsable de traitement</h2>
        <p class="text-slate-600 mb-4">
            Le responsable du traitement des donn√©es est Thomas Cavil, cr√©ateur et d√©veloppeur de l'application.
            <ul class="list-disc list-inside text-slate-600 mb-4">
                <li><strong>Nom/Raison sociale :</strong> Thomas Cavil/Enseignant agr√©g√© SVT au lyc√©e Benjamin franklin</li>
                <li><strong>Contact :</strong> <a href="mailto:contact@oriantation.fr" class="font-semibold text-primary-action hover:underline">contact@oriantation.fr</a></li>
            </ul>
        </p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">3. Donn√©es collect√©es, finalit√©s et base l√©gale du traitement</h2>
        <p class="text-slate-600 mb-4">
            Les donn√©es √† caract√®re personnel trait√©es sont limit√©es au strict n√©cessaire pour la fourniture du service.
        </p>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cat√©gorie de donn√©es</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Finalit√© du traitement</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base l√©gale du traitement</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 text-slate-600">
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">Donn√©es d'identification<br>(Pr√©nom, nom, e-mail, lyc√©e)</td>
                        <td class="px-6 py-4">Gestion du compte utilisateur, authentification, communication et personnalisation du profil.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Consentement</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">Donn√©es de profil<br>(Classe, r√©ponses aux questionnaires)</td>
                        <td class="px-6 py-4">Cr√©ation d'un profil d'orientation personnalis√© et g√©n√©ration d'analyses.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Consentement</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4">Contenu du journal de bord<br>(Notes, r√©flexions, listes, etc.)</td>
                        <td class="px-6 py-4">Fourniture des fonctionnalit√©s de l'application (synth√®ses, suggestions, historique), et de la fonction de partage.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Consentement</td>
                    </tr>
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">Logs de connexion<br>(Adresse IP, horodatage)</td>
                        <td class="px-6 py-4">S√©curit√© du syst√®me, d√©tection des fraudes et maintenance technique.</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold">Int√©r√™t l√©gitime</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">4. Destinataires et sous-traitants des donn√©es</h2>
<p class="text-slate-600 mb-4">
    Vos donn√©es sont trait√©es en interne par le responsable de traitement. Elles ne sont pas transmises √† des tiers, √† l'exception des sous-traitants n√©cessaires au bon fonctionnement de l'application :
</p>
<div class="space-y-6 mt-4">

  <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7l8 4.5 8-4.5M12 12.5V21" /></svg>
      Firebase (Google LLC)
    </h3>
    <p class="text-slate-600 mt-2">
      En tant qu'h√©bergeur de la base de donn√©es et fournisseur du service d'authentification. Les donn√©es sont stock√©es sur des serveurs situ√©s en Europe, garantissant un niveau de protection conforme au RGPD.
    </p>
  </div>

  <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      Mod√®le de langage GPT-5 et GPT-4o (OpenAI, L.L.C.)
    </h3>
    <p class="text-slate-600 mt-2">
      Le contenu de votre journal de bord est transmis √† ce mod√®le d'intelligence artificielle pour g√©n√©rer les r√©ponses personnalis√©es de l'application.
    </p>
    <div class="mt-3 bg-background-light p-3 rounded-md border border-border-subtle text-sm">
      <p><strong class="font-semibold text-slate-700">Cadre juridique :</strong> Ce traitement est encadr√© par l'Accord de Traitement des Donn√©es (DPA) d'OpenAI, qui inclut des Clauses Contractuelles Types (CCT) pour garantir un niveau de protection des donn√©es conforme au RGPD.</p>
      <p class="mt-2"><strong class="font-semibold text-slate-700">Principe de non-utilisation pour l'entra√Ænement :</strong> Conform√©ment √† la politique d'OpenAI pour son API, les donn√©es que vous envoyez ne sont pas utilis√©es pour entra√Æner ou am√©liorer les mod√®les d'IA de l'entreprise.</p>
    </div>
  </div>

  <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h1a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.75 4l-2.75 4M16.25 4l2.75 4" /></svg>
      Netlify, Inc.
    </h3>
    <p class="text-slate-600 mt-2">
      En tant qu'h√©bergeur de l'interface web (frontend) de l'application. Netlify peut traiter des donn√©es techniques de connexion, telles que les adresses IP des visiteurs, √† des fins de s√©curit√© et de performance.
    </p>
  </div>
  
    <div class="border border-border-subtle rounded-lg p-4">
    <h3 class="font-bold text-lg text-OrIAntation-darkblue flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
      Brevo (anciennement Sendinblue)
    </h3>
    <p class="text-slate-600 mt-2">
      En tant que service d'envoi d'e-mails transactionnels (v√©rification de compte, r√©initialisation de mot de passe).
    </p>
    <div class="mt-3 bg-background-light p-3 rounded-md border border-border-subtle text-sm">
        <p><strong class="font-semibold text-slate-700">Cadre juridique :</strong> Ce traitement est encadr√© par les conditions d'utilisation et la politique de confidentialit√© de Brevo, conformes au RGPD, l'entreprise √©tant europ√©enne.</p>
    </div>
  </div>

</div>
<p class="text-slate-600 mb-4">
    En cas d'activation de la fonction "Partage", un lien s√©curis√© est g√©n√©r√© et vous seul(e) en √™tes le(la) destinataire initial(e). La consultation des donn√©es par un tiers via ce lien rel√®ve de votre responsabilit√©.
</p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">5. Dur√©e de conservation des donn√©es</h2>
        <p class="text-slate-600 mb-4">
            Les donn√©es √† caract√®re personnel sont conserv√©es pour la dur√©e de votre utilisation de l'application. En cas de demande de suppression du compte, toutes les donn√©es √† caract√®re personnel sont d√©finitivement effac√©es dans un d√©lai maximal de **30 jours** √† compter de la r√©ception de la demande. Ce d√©lai permet de traiter les √©ventuelles r√©clamations et d'assurer une bonne fin aux op√©rations techniques.
        </p>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">6. Mesures de s√©curit√©</h2>
        <p class="text-slate-600 mb-4">
            Nous mettons en ≈ìuvre des mesures techniques et organisationnelles appropri√©es pour assurer un niveau de s√©curit√© adapt√© au risque. Ces mesures comprennent :
        </p>
        <ul class="list-disc list-inside text-slate-600 mb-4">
            <li>L'utilisation de protocoles de communication s√©curis√©s (HTTPS).</li>
            <li>Le chiffrement des donn√©es de connexion.</li>
            <li>Un contr√¥le d'acc√®s strict aux donn√©es stock√©es sur la base de donn√©es.</li>
            <li>Des proc√©dures de sauvegarde r√©guli√®res.</li>
        </ul>

        <h2 class="text-xl font-bold text-OrIAntation-darkblue mt-6 mb-2">7. Vos droits en mati√®re de protection des donn√©es</h2>
        <p class="text-slate-600 mb-4">
            Conform√©ment au RGPD, vous disposez d'un ensemble de droits que vous pouvez exercer √† tout moment en contactant le responsable de traitement √† l'adresse indiqu√©e ci-dessus :
        </p>
        <ul class="list-disc list-inside text-slate-600 mb-4">
            <li><strong>Droit d'acc√®s</strong> (Art. 15 du RGPD)</li>
            <li><strong>Droit de rectification</strong> (Art. 16 du RGPD)</li>
            <li><strong>Droit √† l'effacement</strong> ("droit √† l'oubli", Art. 17 du RGPD)</li>
            <li><strong>Droit √† la limitation du traitement</strong> (Art. 18 du RGPD)</li>
            <li><strong>Droit √† la portabilit√© des donn√©es</strong> (Art. 20 du RGPD)</li>
            <li><strong>Droit d'opposition</strong> (Art. 21 du RGPD)</li>
            <li><strong>Droit de retirer le consentement</strong> (Art. 7 du RGPD)</li>
        </ul>
        <p class="text-slate-600">
            Vous avez √©galement le droit d'introduire une r√©clamation aupr√®s de l'autorit√© de contr√¥le comp√©tente (la CNIL en France) si vous estimez que vos droits n'ont pas √©t√© respect√©s.
        </p>
    `;
    
    return div;
}

let newWorker;

// 1. On v√©rifie les mises √† jour du Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then(reg => {
        if (reg) {
            reg.addEventListener('updatefound', () => {
                newWorker = reg.installing;
                newWorker.addEventListener('statechange', () => {
                    // Si un nouveau SW est pr√™t et en attente, on pr√©pare la notification
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showUpdateNotification();
                    }
                });
            });
        }
    });
}

// 2. Fonction pour afficher la banni√®re
function showUpdateNotification() {
    const notification = document.getElementById('update-notification');
    const reloadButton = document.getElementById('reload-button');

    if (notification && reloadButton) {
        notification.classList.remove('hidden');
        reloadButton.addEventListener('click', () => {
            // On envoie un message au SW pour qu'il s'active, puis on recharge la page
            newWorker.postMessage({ action: 'skipWaiting' });
            window.location.reload();
        });
    }
}

// 3. (Optionnel mais recommand√©) Recharger la page quand un nouveau SW prend le contr√¥le
//    Ceci garantit que la page est toujours synchronis√©e avec le SW actif.
let refreshing;
navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshing) return;
    window.location.reload();
    refreshing = true;
});

window.signOut = signOut;
window.auth = auth;

    </script>

    <audio id="tts-audio-player" style="display: none;"></audio>
    
</body>

<div id="update-notification" class="hidden fixed bottom-4 right-4 bg-OrIAntation-darkblue text-white p-4 rounded-lg shadow-lg flex items-center gap-4 z-50">
    <span>Une nouvelle version est disponible !</span>
    <button id="reload-button" class="bg-OrIAntation-orange font-bold py-1 px-3 rounded hover:bg-amber-600">
        Mettre √† jour
    </button>
</div>

</html>
